define("DS/EffectivityContent/js/EffectivityTabPresenter",["UWA/Core","UWA/Class","DS/TreeModel/TreeDocument","DS/CoreEvents/ModelEvents","DS/Menu/Menu","DS/UIKIT/Mask","DS/WAFData/WAFData","DS/Utilities/Array","DS/WidgetServices/WidgetServices","DS/i3DXCompassPlatformServices/OpenWith","DS/ENOXModelListView/ModelListView/js/ModelListView","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","i18n!DS/EffectivityContent/assets/nls/EffectivityTabContainer"],function(e,t,n,i,a,o,r,s,c,l,d,u,f,h){"use strict";var p="included",_="mentioned";return t.extend({init:function(e){this._initContainer(),this._subscribeEvent(),this._parent(e)},_initTableView:function(){this._treeDocument=new n;var t=this;this._filterOption={search:"",filter:{}};var i={id:"_effectivityTabPresenter",model:this._treeDocument,modelEvents:this._modelEvents,restrictSortFlag:!0,viewOptions:{identifier:"_effectivityTabPresenter",views:["DataGridView"],grid:{columns:[{dataIndex:"tree",text:h.title_label,pinned:"left"},{dataIndex:"instanceTitle",text:h.instance_title_label,icon:"flow-cascade",getCellTooltip:function(e){return-1===e.rowID?{shortHelp:h.instance_title_tooltip}:{}}},{dataIndex:"evolution",text:h.evolution_label,typeRepresentation:"url",getCellValue:function(e){if(e.rowID>=0&&e.nodeModel&&e.nodeModel.getAttributeValue("instance")){if(t._instanceInfo){var n=t._instanceInfo[e.nodeModel.getAttributeValue("instance")];return{label:n?n.content.Evolution.Current:""}}return{icon:"reload wux-ui-3ds-spin"}}return""},compareFunction:function(e,n,i,a){return t._instanceInfo?(e=i.getAttributeValue("instance")&&t._instanceInfo.hasOwnProperty(i.getAttributeValue("instance"))?t._instanceInfo[i.getAttributeValue("instance")].content.Evolution.Current:"",n=a.getAttributeValue("instance")&&t._instanceInfo.hasOwnProperty(a.getAttributeValue("instance"))?t._instanceInfo[a.getAttributeValue("instance")].content.Evolution.Current:"",e.localeCompare(n)):0}},{dataIndex:"owner",text:h.owner_label,groupableFlag:!0},{dataIndex:"type",text:h.type_label,groupableFlag:!0}]},contextualActions:[{id:"OpenWith",title:h.openwith_label,text:h.openwith_label,fonticon:"open-menu-dot",multiselect:!1,handler:function(e){var n=event.target.getBoundingClientRect();t._buildOpenWithMenu(e.instance||e.id).then(e=>{a.show(e,{position:{x:n.left,y:n.top+n.height},submemu:"outside"})})},submenu:async function(){var e=t._treeDocument.getSelectedNodes();if(1===e.length){var n=e[0].getAttributeValue("instance")||e[0].options.id;return await t._buildOpenWithMenu(n)}return[]}}]},toolbarOptions:{withStableActions:!0,useGeneratedToolbar:!0,hideSort:!0,touchMode:!1,filterActions:[{id:"mv-filter",text:h.filter_label,fonticon:"list-filter",multiSelect:!0,selected:!1,actions:[{id:"mentioned",text:e.String.format(h.filter_mentioned,this._modeVersionInfo.title+" "+this._modeVersionInfo.revision),selectable:!0,selected:!1,handler:function(e){t._filterOption.filter[_]=e,t._filterData()}},{id:"included",text:e.String.format(h.filter_included,this._modeVersionInfo.title+" "+this._modeVersionInfo.revision),selectable:!0,selected:!1,handler:function(e){t._filterOption.filter[p]=e,t._filterData()}}]}],hideOnMultiSelection:["OpenWith"],actions:[{id:"OpenWith",text:h.openwith_label,fonticon:"open-menu-dot",showOnSelection:!0,handler:function(e){if(1===e.length){var n=event.target.getBoundingClientRect();t._buildOpenWithMenu(e[0].grid.instance||e[0].id).then(e=>{a.show(e,{position:{x:n.left,y:n.top+n.height},submemu:"outside"})})}}}]}};this._tablePresenter=new d(i)},_initContainer:function(){f.setNotificationManager(u),this._container=e.createElement("div",{class:"effectivity-presenter",styles:{height:"100%"}}),this._tableContent=e.createElement("div",{class:"effectivity-table-content",styles:{position:"relative",height:"100%"}}),this._tableContent.inject(this._container)},_subscribeEvent:function(){var e=this;this._modelEvents=new i,this._modelEvents.subscribe({event:"effectivity-instance-info-updated"},function(){e._refreshEffectivityColumn()}),this._modelEvents.subscribe({event:"enox-collection-toolbar-filter-search-value"},function(t){e._filterOption.search=t.searchValue[0]||"",e._filterData()})},inject:function(e){this._container.inject(e)},updateOptions:function(e){this._tenant=e.tenant||"OnPremise",this._securityContext=e.securityContext||"VPLMProjectLeader.MyCompany.3DS Collab Space",this._id=e.id,this._modeVersionInfo={title:e.title,revision:e.revision},this._initTableView(),this.loadData()},loadData:async function(){var e=this;o.mask(this._container),await this._fetchWhereUsed().then(function(){return e._fetchEffectivityInfo().fin(function(){e._modelEvents.publish({event:"effectivity-instance-info-updated"})}),e._fetchDataInfo()}),this.updateUI(),o.unmask(this._container)},_fetchDataInfo:function(){var t=this;return t._dataList&&0!==t._dataList.length?this._get3DSpaceURL().then(function(){return new e.Promise(function(n,i){var a={label:"x_mdl_app_"+Date.now(),locale:"en",select_predicate:["ds6w:label","ds6w:description","ds6w:identifier","ds6w:type","ds6w:responsible"],physicalid:t._dataList,tenant:t._tenant},o={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityToken:""},tenantId:t._tenant,apiVersion:"R2018x",data:JSON.stringify(a),onComplete:function(i){var a=(i=JSON.parse(i)).results;a&&(t._dataInfo=a.reduce((t,n)=>{var i=e.Json.path(n,'$..attributes[?(@.name=="resourceid" || @.name=="ds6w:label" || @.name=="type_icon_url" || @.name=="preview_url" || @.name=="ds6w:type" || @.name=="ds6w:responsible")]');if(i){var a=i.reduce((e,t)=>(e[t.name]=t.value,e),{});t[a.resourceid]={id:a.resourceid,title:a["ds6w:label"],image:a.preview_url||item.type_icon_url,type:a["ds6w:type"],owner:a["ds6w:responsible"]}}return t},{})),n()},onFailure:function(){i(),t.displayNotification({title:h.ERROR_DATA_FETCH_TITLE,message:h.ERROR_DATA_LOAD_MSG,level:"error",sticky:!0})}},s=t._3DSpaceURL+"/cvservlet/fetch/v2";s+="?"+e.Utils.toQueryString({tenant:t._tenant}),r.authenticatedRequest(s,o)})}).catch(function(){}):(t._dataInfo={},e.Promise.resolve())},_fetchWhereUsed:function(){var t=this;return this._get3DSpaceURL().then(function(){return t._id&&t._3DSpaceURL?new e.Promise(function(e,n){var i={version:"1.0",evolutionsIdentifiers:[t._id],evolutionCriteriaUsage:"Both"},a={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t._securityContext},tenantId:t._tenant,data:JSON.stringify(i),onComplete:function(n){n=JSON.parse(n),t._dataEntries=[];var i=n.hasOwnProperty(t._id)?t._id:"46B8825695760C0065B1FA7F001B2DE8";n.hasOwnProperty(i)&&(n[i].hasOwnProperty("mentionedBy")||n[i].hasOwnProperty("includedBy"))&&(n[i].mentionedBy.forEach(e=>{t._dataEntries[e.instancePID]=e,t._dataEntries[e.instancePID].mentioned=!0,t._dataEntries[e.instancePID].included=!1}),n[i].includedBy.forEach(e=>{t._dataEntries.hasOwnProperty(e.instancePID)||(t._dataEntries[e.instancePID]=e,t._dataEntries[e.instancePID].mentioned=!1),t._dataEntries[e.instancePID].included=!0})),t._dataObjects=Object.values(t._dataEntries),t._dataList=t._dataObjects.reduce((e,t)=>(e.push(t.instancePID),-1===e.indexOf(t.parentReferencePID)&&e.push(t.parentReferencePID),-1===e.indexOf(t.childReferencePID)&&e.push(t.childReferencePID),e),[]),t._instanceIds=t._dataObjects.map(e=>e.instancePID),e()},onFailure:function(){n(),t.displayNotification({title:h.ERROR_DATA_LOAD_TITLE,message:h.ERROR_DATA_LOAD_MSG,level:"error",sticky:!0})}};r.authenticatedRequest(t._3DSpaceURL+"/resources/modeler/configuration/navigationServices/getImpactedInstancesFromEvolutions",a)}):e.Promise.resolve()}).catch(function(){})},_fetchEffectivityInfo:function(){var t=this,n=this._instanceIds;return n&&0!==n.length?this._get3DSpaceURL().then(function(){return n&&t._3DSpaceURL?new e.Promise(function(i,a){var o={version:"1.3",output:{targetFormat:"TXT",withDescription:"YES",view:"Current",domains:"Evolution"},pidList:n},s={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t._securityContext},tenantId:t._tenant,data:JSON.stringify(o),onComplete:function(e){(e=JSON.parse(e)).hasOwnProperty("expressions")&&(t._instanceInfo=e.expressions),i()},onFailure:function(){a(),t.displayNotification({title:h.ERROR_EXP_FETCH_TITLE,message:h.ERROR_DATA_LOAD_MSG,level:"warning"})}},c=t._3DSpaceURL+"/resources/modeler/configuration/navigationServices/getMultipleFilterableObjectInfo";c+="?"+e.Utils.toQueryString({tenant:t._tenant,indexBased:"1"}),r.authenticatedRequest(c,s)}):e.Promise.resolve()}).catch(function(){}):e.Promise.resolve()},_get3DSpaceURL:function(){if(this._3DSpaceURL)return e.Promise.resolve();var t=this;return new e.Promise(function(e,n){c.get3DSpaceUrlAsync({platformId:t._tenant,onComplete:function(n){t._3DSpaceURL=n,e()},onFailure:function(){n()}})})},updateUI:function(){this._tableContent.setContent(),this._tablePresenter.inject(this._tableContent);var e=this._prepareListData();this._treeDocument.removeRoots(),this._treeDocument.loadModel(e)},_prepareListData:function(){var e=[];this._nodeModelMap={};var t={},n=[],i={};this._dataObjects&&this._dataInfo&&this._dataObjects.forEach(e=>{if(e.instancePID&&e.childReferencePID&&e.parentReferencePID){this._nodeModelMap[e.instancePID]=this._getNodeInfo(e.childReferencePID,e),t[e.childReferencePID]?t[e.childReferencePID].push(e.instancePID):t[e.childReferencePID]=[e.instancePID],i[e.parentReferencePID]?-1===i[e.parentReferencePID].indexOf(e.childReferencePID)&&i[e.parentReferencePID].push(e.childReferencePID):i[e.parentReferencePID]=[e.childReferencePID];var a=n.indexOf(e.childReferencePID);a>-1&&n.splice(a),s.pushUnique(n,e.parentReferencePID)}});var a=(e,n)=>{if(n)if(t[n])t[n].forEach(t=>{var o=this._nodeModelMap[t];if(o){if(i[n]){var r=[];i[n].reduce(a,r),r.length>0&&(o.children=r)}e.push(o)}});else{var o=this._getNodeInfo(n);if(o){if(i[n]){var r=[];i[n].reduce(a,r),r.length>0&&(o.children=r)}e.push(o)}}return e};return n.filter(e=>!t[e]).reduce(a,e),e},_getNodeInfo:function(t,n){var i={};if(this._dataInfo.hasOwnProperty(t)){var a=e.clone(this._dataInfo[t]);i={id:a.id,label:a.title,icons:[a.image],grid:a},n&&(i.grid.instance=n.instancePID,i.grid.instanceTitle=this._dataInfo[n.instancePID].title||"",i.grid.included=n.included,i.grid.mentioned=n.mentioned,this._dataInfo[n.parentReferencePID]&&this._dataInfo[n.childReferencePID]&&this._dataInfo[n.instancePID]&&(i.grid.path=[{resourceid:n.parentReferencePID,type:this._dataInfo[n.parentReferencePID].type},{resourceid:n.instancePID,type:this._dataInfo[n.instancePID].type},{resourceid:n.childReferencePID,type:this._dataInfo[n.childReferencePID].type}]))}return i},_buildOpenWithMenu:function(t){var n=this._dataInfo[t],i=[{resourceid:t,type:n.type}];return this._nodeModelMap.hasOwnProperty(t)&&(i=this._nodeModelMap[t].grid.path,n=this._dataInfo[this._nodeModelMap[t].id]),new e.Promise((e,t)=>{var a=[];(new l).set3DXContent({protocol:"3DXContent",version:"1.1",source:"ENXMODL_AP",widget_id:"id",data:{items:[{envId:this._tenant,serviceId:"3DSpace",contextId:"",objectId:n.id,objectType:n.type,displayType:n.type,displayName:n.title,path:i}]}}).retrieveCompatibleApps(function(t){t.length>0&&(t.forEach(function(e){let t={name:e.text,type:"PushItem",title:e.text,icon:e.icon,action:{callback:function(t){e.handler.call(t)}}};e.fonticon?t.fonticon={content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+e.fonticon}:t.icon=e.icon,a.push(t)}),e(a))})})},_refreshEffectivityColumn:function(){if(this._tablePresenter){var e=this._tablePresenter.getDataGridView();e.updateRenderedColumn(e.layout.getColumnIndex("evolution"),{updateCellContent:!0,updateCellLayout:!1,updateCellAttributes:!1})}},_filterData:function(){var t=this,n=function(i){var a=i.getChildren(),o=!0;if(a&&a.length>0){var r=!1;if(a.forEach(e=>{n(e)&&(r=!0)}),r)return r}if(e.is(i.getRoots,"function"))return!0;if(o&&(t._filterOption.filter[p]!==t._filterOption.filter[_]||t._filterOption.search&&t._filterOption.search.length>0)&&(t._filterOption.filter[p]?o=!0===i.getAttributeValue("included"):t._filterOption.filter[_]&&(o=!0===i.getAttributeValue("mentioned")),o&&t._filterOption.search&&t._filterOption.search.length>0)){var s=t._filterOption.search.trim().toLowerCase();!(o=-1!==["title","type","owner","instanceTitle"].findIndex(e=>i.getAttributeValue(e)&&i.getAttributeValue(e).toLowerCase().includes(s)))&&i.getAttributeValue("instance")&&(o=t._instanceInfo[i.getAttributeValue("instance")]&&t._instanceInfo[i.getAttributeValue("instance")].content.Evolution.Current.toLowerCase().includes(s))}if(o){var c=i.getParents();c&&c.reverse().forEach(e=>{e.isHidden()&&e.show()}),i.show()}else i.hide();return o};this._treeDocument.prepareUpdate(),n(this._treeDocument),this._treeDocument.pushUpdate()},displayNotification:function(t){u.addNotif(e.merge(t,{level:"info",sticky:!1}))},destroy:function(){this._container.empty()}})}),define("DS/EffectivityContent/js/EffectivityTabFacet",["UWA/Core","UWA/Class","UWA/Controls/Abstract","DS/EditPropWidget/facets/Common/FacetsBase","DS/EffectivityContent/js/EffectivityTabPresenter","DS/WidgetServices/securityContextServices/SecurityContextServices","css!DS/EffectivityContent/css/EffectivityTabFacet.css"],function(e,t,n,i,a,o){"use strict";return t.extend(n,i,{name:"effectivity-facet-container",init:function(e){this._parent(e),this._initView(),this._initContainer()},_initView:function(){this._effectivityTabPresenter=new a},_initContainer:function(){this.elements.container=e.createElement("div",{class:this.getClassNames()}),this._effectivityTabPresenter.inject(this.elements.container)},updateFacet:function(){this.modelVersionInfo={};var e=this.getModel();e&&(this.tenant=e.getTenant(),this.modelVersionInfo.id=e.get("objectId"),this.modelVersionInfo.title=e.get("label")||"",this.modelVersionInfo.revision=e.get("revision")?e.get("revision").value:"");var t=this;o.getInstance({tenant:this.tanent}).getSecurityContext({context:this.getContext(),onSuccess:function(e){t.securityContext=e.SecurityContext,t.loadData()}})},loadData:function(){this._effectivityTabPresenter.updateOptions({tenant:this.tenant,id:this.modelVersionInfo.id,title:this.modelVersionInfo.title,revision:this.modelVersionInfo.revision,securityContext:this.securityContext})},destroyComponent:function(){this._effectivityTabPresenter.destroy(),e.is(this.destroy,"function")&&this.destroy()},onRefresh:function(){this.updateFacet()}})});