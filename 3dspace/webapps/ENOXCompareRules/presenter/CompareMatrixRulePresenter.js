define("DS/ENOXCompareRules/presenter/CompareMatrixRulePresenter",["DS/PlatformAPI/PlatformAPI","DS/xPortfolioQueryServices/js/xEnterpriseDictionary","UWA/Core","DS/CfgDictionary/CfgDictionaryMapperUtils","DS/CfgRuleMatrixComponent/Model/MatrixRuleModel","DS/CoreEvents/ModelEvents","DS/UIKIT/Spinner","DS/CfgRuleMatrixComponent/Utils/MatruiTablePersistanceUtils","DS/CfgRuleMatrixComponent/Runtime/RunTimePresenter","DS/ENOXCompareRules/presenter/CompareDefaultPresenter"],function(e,t,i,n,r,s,l,o,a,h){"use strict";var u=function(){};return u.prototype.init=function(e){this.options=e.data?e.data:{},this.dictionary={},this.index=0,this.diffCount=0,this.isSameParent=this.checkForSameParent(),this.verticalIndInjected=!1,this.horizontalIndInjected=!1,this.compareDefaultPresenter=new h,this.toolbarCount=!1,this.generateCellIds=!1},u.prototype.checkForSameParent=function(){let e=this.options.leftRuleMVId,t=this.options.rightRuleMVId;e===t?this.fetchDictionary([e]):this.fetchDictionary([e,t])},u.prototype.getPresentDictionary=async function(t){e.subscribe("RETURN_VARIABILITY_DICTIONARY",function(){}),e.publish("GET_PRESENT_VARIABILITY_DICTIONARY",{data:t})},u.prototype.onResize=function(){if(this.cellIds||this.generateCellIdsToNavigate(),this._runTimePresenter&&this._runTimePresenter.hasOwnProperty("_matruiTablePresenter")){var e=this._runTimePresenter._matruiTablePresenter._dataGridView.elements;if(e.poolContainerSync.clientHeight<e.poolContainerSyncRel.clientHeight){if(this.uniqueRowIds){if(!this.verticalIndInjected){this.verticalOverviewContainer=i.createElement("div",{id:"comparerules-overview-container",height:e.poolContainerSync.clientHeight});var t=i.createElement("div",{id:"comparerules-overview-toplevel",html:[{tag:"div",id:"comparerules-overview",html:[{tag:"div",id:"compareV2-canvas-buffer",html:[{tag:"canvas",id:"comparerules-OverviewCanvas"}]}]}]});t.inject(this.verticalOverviewContainer),this.verticalOverviewContainer.inject(this.options.container),this.verticalIndInjected=!0}var n=jQuery("div#comparerules-overview-container")[0],r=e.poolContainerSync.clientHeight-23,s=n.clientWidth,l=1;if(null!==(v=jQuery("#comparerules-OverviewCanvas")[0])&&(v.width=s,v.height=r),this.uniqueRowIds.length>0){var o=(r-2*l)/this.uniqueRowIds.length,a=2,h=5,u=s-2,d=5,c=v.getContext("2d");for(let e=0;e<this.uniqueRowIds.length;e++)c.strokeStyle="#ff8a2e",c.lineWidth=3,c.beginPath(),c.moveTo(a,h),u/=2,c.lineTo(u,d),c.stroke(),a=u,u=s-2,c.lineWidth=3,c.beginPath(),c.strokeStyle="#009ddb",c.moveTo(a,h),c.lineTo(u,d),c.stroke(),h+=o,d+=o,a=2}this.verticalOverviewContainer.show()}}else this.verticalOverviewContainer&&this.verticalOverviewContainer.hide();if(e.poolContainerSync.clientWidth<e.poolContainerSyncRel.clientWidth){if(this.uniqueColumnIds){this.horizontalIndInjected||(this.horizonOverviewContainer=i.createElement("div",{id:"comparerules-hoverview-container"}),(t=i.createElement("div",{id:"comparerules-hoverview-toplevel",html:[{tag:"div",id:"comparerules-hoverview",html:[{tag:"div",id:"compareV2-hcanvas-buffer",html:[{tag:"canvas",id:"comparerules-hOverviewCanvas"}]}]}]})).inject(this.horizonOverviewContainer),this.horizonOverviewContainer.inject(this.options.container),this.horizontalIndInjected=!0),(n=jQuery("div#comparerules-hoverview-container")[0]).setStyle("top",e.poolContainerSync.clientHeight+115),n.setStyle("width",e.poolContainerSync.clientWidth),n.setStyle("height","14px");var v;r=n.clientHeight,s=e.poolContainerSync.clientWidth,l=1;if(null!=(v=jQuery("#comparerules-hOverviewCanvas")[0])&&(v.width=s,v.height=r),this.uniqueColumnIds.length>0){a=(o=(s-2*l)/this.uniqueColumnIds.length)/2,h=2,u=o/2,d=r-2,c=v.getContext("2d");for(let e=0;e<this.uniqueColumnIds.length;e++)c.strokeStyle="#ff8a2e",c.lineWidth=3,c.beginPath(),c.moveTo(a,h),d/=2,c.lineTo(u,d),c.stroke(),h=d,d=r,c.lineWidth=3,c.beginPath(),c.strokeStyle="#009ddb",c.moveTo(a,h),c.lineTo(u,d),c.stroke(),a+=o,u+=o,h=2}this.horizonOverviewContainer.show()}}else this.horizonOverviewContainer&&this.horizonOverviewContainer.hide()}},u.prototype.onNavigate=function(e){var t=this._runTimePresenter._matruiTablePresenter._dataGridView;if(this.generateCellIds||(this.generateCellIdsToNavigate(),this.diffCount=this.cellIds.length,this.generateCellIds=!0),this.cellIds&&this.cellIds.length>0){e=e.hasOwnProperty("event")?e.event:"";var i,n=t.getActiveCellID();let r,s=this.cellIds.includes(n);switch(e){case"navigateNext":if(s)(i=this.cellIds.indexOf(n))+1!==this.cellIds.length&&(t.ensureCellVisible(this.cellIds[i++]),t.selectCell(this.cellIds[i++]));else{let e=this.cellIds;for(r=0;r<e.length;r++)if(e[r]>n){i=r;break}t.ensureCellVisible(this.cellIds[i]),t.selectCell(this.cellIds[i])}break;case"navigatePrevious":if(s)0!==(i=this.cellIds.indexOf(n))&&(t.ensureCellVisible(this.cellIds[i--]),t.selectCell(this.cellIds[i--]));else{let e=this.cellIds;for(r=e.length-1;r>=0;r--)if(e[r]<n){i=r;break}t.ensureCellVisible(this.cellIds[i]),t.selectCell(this.cellIds[i])}break;case"navigateFirst":t.ensureCellVisible(this.cellIds[0]),t.selectCell(this.cellIds[0]);break;case"navigateLast":t.ensureCellVisible(this.cellIds[this.cellIds.length-1]),t.selectCell(this.cellIds[this.cellIds.length-1])}}},u.prototype.destroy=function(){this._runTimePresenter&&this._runTimePresenter.destroy()},u.prototype.fetchDictionary=function(e){var r=this,s=[];for(let i=0;i<e.length;i++){let n={componentId:e[i],content:{attributes:1,customerAttributes:"",parameters:!1,attributeList:["_image"]}};s.push(t.getVariabilityDefinition(n))}i.Promise.allSettled(s).then(function(e){var t,s,l=r;if(1===e.length&&(t=n.dicoMinifiedV3ToMap(e[0].value),s=e[0].value),2===e.length){let r=n.dicoMinifiedV3ToMap(e[0].value),l=n.dicoMinifiedV3ToMap(e[1].value);t=i.merge(r,l),s=e[0].value}l.createContentView(t,s)},function(){i.log("error in getting dictionary")})},u.prototype.createContentView=function(e,t){var i=this.getJsonModel(e);if(i){let n;this._runTimePresenter=new a,this._matrixRuleModel=new r(e,i),this._matrixRuleModel.createAllDrivingCombination(this._matrixRuleModel.__jsonModel.drivingCriteria),this._privateChannel=new s,this.solverEventModel=new s,this._runTimePresenter.init(this._matrixRuleModel,this._privateChannel,{painter:!1,solverKey:"",solverModelEvent:this.solverEventModel,dictionary:t,editable:!1,immersiveFrame:n,filter:"",context:"Compare"}),this._runTimePresenter.inject(this.options.container),this.onResize()}},u.prototype.generateCellIdsToNavigate=function(){if(this.uniqueRowIds=[],this.uniqueColumnIds=[],this._runTimePresenter){let n,r;var e=this._runTimePresenter._matruiTablePresenter._treeDocumentModel.getAllDescendants().length,t=this._runTimePresenter._matruiTablePresenter._dataGridView.layout.columns.length;for(this.cellIds=[],n=0;n<e;n++)for(r=0;r<t;r++){let e;if(e=this._runTimePresenter._matruiTablePresenter._dataGridView.layout.getCellIDFromCoordinates({rowID:n,columnID:r})){let t;t=this._runTimePresenter._matruiTablePresenter._dataGridView.getModelAt(e),i.is(t,"object")&&t.hasOwnProperty("state")&&t.state.length>1&&(this.cellIds.includes(e)||(this.cellIds.push(e),this.uniqueRowIds.includes(n)||this.uniqueRowIds.push(n),this.uniqueColumnIds.includes(r)||this.uniqueColumnIds.push(r)))}}this.toolbarCount||(this.options.toolbar.update({numDifferences:this.cellIds.length}),this.toolbarCount=!0)}},u.prototype.convertVersion=function(e,t){var n=o.convertJsonToV3(e,t),s=new r(e,n);0!==s.checkAndFixDiscrepancy()._rc?s.setJsonModel(s.__jsonModel):s.createAllDrivingCombination(s.__jsonModel.drivingCriteria);var l=i.clone(s.getJsonModel());return l=o.convertJsonToV3(e,l)},u.prototype.getJsonModel=function(e){var t=this.options.leftRuleDef.configurationRule.attributes["Layout Data"],n=this.options.rightRuleDef.configurationRule.attributes["Layout Data"],r={drivingCombinationValues:[],constrainedValues:[],states:[],drivingCriteria:[],constrainedCriteria:[],drivingCombinationsValidity:[],statesValidity:[]},s=[],l=[],o=[],a=[],h={},u={};if(t=""!==t?JSON.parse(t):null,n=""!==n?JSON.parse(n):null,t&&n){{if(t.hasOwnProperty("version")&&"3.0"!==t.version&&(t=this.convertVersion(e,t)),n.hasOwnProperty("version")&&"3.0"!==n.version&&(n=this.convertVersion(e,n)),i.owns(t,"drivingCombinationValues")&&i.owns(n,"drivingCombinationValues")){var d=t.drivingCombinationValues,c=n.drivingCombinationValues;let e,o;for(e=0;e<d.length;e++)for(o=0;o<c.length;o++)if(i.equals(d[e],c[o])){r.drivingCombinationValues.push(d[e]),s.push(e),l.push(o),Object.keys(d[e]).forEach(function(t){h.hasOwnProperty(t)?h[t].includes(d[e][t].variantValue)||h[t].push(d[e][t].variantValue):(h[t]=[],h[t].includes(d[e][t].variantValue)||h[t].push(d[e][t].variantValue))});break}}if(!(r.drivingCombinationValues.length>0))return void this.compareDefaultPresenter.createEmptyView(this.options.container,this.options.toolbar);if(i.owns(t,"constrainedValues")&&i.owns(n,"constrainedValues")){let s,l,h=t.constrainedValues,d=n.constrainedValues;for(s=0;s<h.length;s++)for(l=0;l<d.length;l++)if(i.equals(h[s],d[l])){r.constrainedValues.push(h[s]),o.push(s),a.push(l);let t=e[h[s].id].parent;null!==t?u.hasOwnProperty(t)?u[t].includes(h[s].id)||u[t].push(h[s].id):(u[t]=[],u[t].push(h[s].id)):u.hasOwnProperty(h[s].id)||(u[h[s].id]=[],u[h[s].id].push(h[s].id));break}}if(!(r.drivingCombinationValues.length>0&&r.constrainedValues.length>0))return void this.compareDefaultPresenter.createEmptyView(this.options.container,this.options.toolbar);{let e,i;for(e=0;e<r.drivingCombinationValues.length;e++){let h=[],u=[];for(r.drivingCombinationsValidity.push("V"),i=0;i<r.constrainedValues.length;i++){let r,d;r=t.states[s[e]][o[i]],d=n.states[l[e]][a[i]],void 0===r&&(r="A"),void 0===d&&(d="A"),r===d?(h.push(r),u.push("V")):(h.push(r+d),u.push("V"))}r.states.push(h),r.statesValidity.push(u)}}let w=Object.keys(h);var v,p,g=t.drivingCriteria,f=n.drivingCriteria;if(w.length>0)for(p=0;p<w.length;p++){var m,C=w[p],I=[],y=!1;for(v=0;v<g.length;v++){let e=g[v];if(e.id===C&&e.hasOwnProperty("selectedValues")&&e.selectedValues.length>0){let t;for(t=0;t<e.selectedValues.length;t++){let n=e.selectedValues[t];h[C].includes(n.id)&&(y=!0,m=e,I.push(n),i.Array.erase(h[C],n.id))}}}for(v=0;v<f.length;v++){let e=f[v];if(e.id===C&&e.hasOwnProperty("selectedValues")&&e.selectedValues.length>0){let t;for(t=0;t<e.selectedValues.length;t++){let n=e.selectedValues[t];h[C].includes(n.id)&&(y=!0,m=e,I.push(n),i.Array.erase(h[C],n.id))}}}y&&(m.selectedValues=I,r.drivingCriteria.push(m))}w=Object.keys(u);var V=t.constrainedCriteria;if(w.length>0)for(p=0;p<w.length;p++){for(C=w[p],I=[],y=!1,m={},v=0;v<V.length;v++){let e=V[v];if(e.id===C&&e.hasOwnProperty("selectedValues")&&e.selectedValues.length>0){let t;for(t=0;t<e.selectedValues.length;t++){let n=e.selectedValues[t];u[C].includes(n.id)&&(y=!0,m=e,I.push(n),i.Array.erase(u[C],n.id)),u[C].includes(C)&&(y=!0,m=e,I.push(n),i.Array.erase(u[C],C))}}}y&&(m.selectedValues=I,r.constrainedCriteria.push(m))}r.invalidDrivingValues=t.invalidDrivingValues,r.version=t.version}return r}this.compareDefaultPresenter.createEmptyView(this.options.container,this.options.toolbar)},u});