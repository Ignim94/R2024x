define("DS/ENOFormulatedBOM/view/CreateFormulaIngWithSpecificUnit",["UWA/Core","UWA/Controls/Abstract","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/DataGridView/DataGridView","DS/Windows/ImmersiveFrame","DS/Windows/Panel","DS/Controls/Tab","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/Constants","DS/ENOFormulatedBOM/service/FPBOMServiceProvider","DS/XSRCommonComponents/utils/TypeUtils","DS/XSRCommonComponents/utils/Utils","DS/Controls/LineEditor","DS/Controls/ComboBox","DS/Controls/Label","text!DS/ENOFormulatedBOM/assets/config/AddFormulaIngWithUnitsColumnConfig.json","i18n!DS/ENOFormulatedBOM/assets/nls/FormulaBOM"],function(t,e,n,i,a,o,r,l,s,d,u,g,c,m,p,y,h,Q,f,v){"use strict";return e.extend({target:null,options:null,dialog:null,dataGridView:null,init:function(t){this._parent(t),this.basicModelEvents=t.appCore.basicModelEvents,this.target=t.appCore.specMainContainer,this.createCloseAction=t.createCloseAction,this.parentId=t.parentId,this.parentTitle=t.parentTitle,this.frmService=new c},loadFields:function(t){this.container=widget.body,d.maskLoader(this.container);var e=t;this.initDetailedView(e)},initDetailedView:function(e){var n=this;this.inputData=[];var i=this.options;i.Title=v.label_addFormulatedProd+" | "+this.parentTitle,i.width=1e3,i.height=250,i.renderTo=this.target,i.Content=this.getUIContainer(e),i.OKLabel=v.label_add,i.RemoveApplyButton=!0,d.unmaskLoader(this.getUIContainer(e)),this.dialog=new s(i),this.dialog.destroyPrevDialog(),this.dialog.render(),n.dialog._dialog.buttons.Ok.disabled=!0,d.unmaskLoader(this.container);this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_OK",function(){n.dialog._dialog.buttons.Ok.disabled=!0;let e=function(){let t=n.dataGridView,e=[];return t.getTreeDocument().getChildren().forEach(function(t){let n={};n.id=t.options.grid.id,n.minQuantity=t.options.grid.minQuantity.toString(),n.maxQuantity=t.options.grid.maxQuantity.toString(),n.targetQuantity=t.options.grid.targetQuantity.toString(),n.lossPercent=t.options.grid.lossPercent,n.isQS=t.options.grid.isQS,n.quantityUOM=t.options.grid.unit,n.parentId=t.options.grid.parentId,e.push(n)}),e}(),i=[],a={},s="";for(var d=0;d<e.length;d++){var g={};g.id=e[d].id,g.minQuantity=e[d].minQuantity,g.maxQuantity=e[d].maxQuantity,g.targetQuantity=e[d].targetQuantity,g.lossPercent=e[d].lossPercent?e[d].lossPercent:"",g.quantityUOM=e[d].quantityUOM,g.isQS=e[d].isQS,i.push(g)}s=e[0].parentId,a.children=i,a.isWeightEnabled=!0,n.frmService.createFormulaIng(a,s).then(function(e){n.dialog._dialog.buttons.Ok.disabled=!1,n._closeDialog();let i=[];for(let t=0;t<e.result.length;t++)if(0==e.result[t].isConnected)n.notify("error",e.result[t].instanceDetails.message);else{let n=e.result[t].instanceDetails;i.push(n)}if(n.fetchFiInfo(i),0!==i.length){var a=new t.createElement("div",{class:"xsr-Success-report"}),s=new t.createElement("ul",{});for(d=0;d<i.length;d++){let e=i[d].child.title;t.createElement("li",{text:v.replace(v.get("FRMIngSuccessMSG"),{childItem:e,parentItem:n.parentTitle})}).inject(s)}s.inject(a);var u=new l({displayStyle:"strip"});u.add({label:"Success ("+i.length+")",isSelected:!0,content:a});var g=new t.createElement("div",{id:"container"});g.inject(n.options.renderTo);var c=new t.Element("div",{class:"xsr-dialog-immersiveframe"}).inject(g),m=new o;m.inject(c);new r({immersiveFrame:m,title:v.ReportTitle,content:u,position:{my:"center",at:"center",of:m},width:600})}}).catch(function(t){null==t&&u.displayNotification({eventID:"error",msg:v.replace(v.get(v.Error_AddCQ),{parentItem:n.parentTitle})}),u.displayNotification({eventID:"error",msg:t.result?t.result.message.trim()===v.Continous_Qunat_Template_Error?v.Continous_No_Access:t.result.message:v.Error_AddCQ}),n._closeDialog()})})},_closeDialog:function(){var t=this.dialogContainer?this.dialogContainer:this.target;d.unmaskLoader(t),this.dialog.closeDialog()},fetchFiInfo:function(t){this.createCloseAction&&this.createCloseAction(t)},getUIContainer:function(e){for(var o=this,r=new n,l=[],s=0;s<e.length;s++){var d={Title:e[s].Title,type:e[s].Type,id:e[s].id,parentId:e[s].parentId,"ds6wg:revision":e[s].revision,"ds6w:status":e[s].maturityNLS,minQuantity:void 0,maxQuantity:void 0,targetQuantity:void 0,unitNLS:void 0,unit:void 0,lossPercent:void 0,isQS:!1};l.push(d)}r.prepareUpdate(),l.forEach(function(t){var e=new i({label:t.Text,grid:t});r.addRoot(e)}),r.pushUpdate();var u=t.createElement("div",{class:"xsr-continousQty-container"}),c=t.createElement("div",{class:"xsr-Formula-mandDiv"}).inject(u,"top");t.Element("span",{class:"xsr-mandatory-flag-title",text:"* "}).inject(c),t.createElement("span",{text:v.FormulaIngUnitMand}).inject(c);var p=t.createElement("div",{class:"xsr-contQty-grid"}),M=JSON.parse(f).columns,w=this.getNLSLabels(M);w&&w.forEach(function(e){e.text=e.text,"FormulaQuantityRange"==e.dataIndex&&e.children.forEach(function(e){"lossPercent"===e.dataIndex&&(e.getCellSemantics=function(t){if(t.nodeModel)return{pattern:g.LOSS_PATTERN}}),"targetQuantity"!=e.dataIndex&&"minQuantity"!=e.dataIndex&&"maxQuantity"!=e.dataIndex||(e.getCellValue=function(e){var n,i=this.getColumnOrGroup(e.columnID).dataIndex,a=e.nodeModel,o=t.createElement("div",{class:"uom-container-formula","data-cellInfos":e}),r=[],l=new Map,s=Object.entries(m.getUOMUnits("Mass"));switch(s&&s.forEach(function(t){r.push(t[1]),l.set(t[1],t[0])}),r.sort(function(t,e){return(t=t.toLowerCase())==(e=e.toLowerCase())?0:t>e?1:-1}),i){case"targetQuantity":n=a.options.grid.targetQuantity;break;case"minQuantity":n=a.options.grid.minQuantity;break;case"maxQuantity":n=a.options.grid.maxQuantity}var d=a.options.grid.unitNLS,u=-1;null!=d&&(u=r.indexOf(d));var g,c=t.createElement("div").inject(o),p=new y({placeholder:v.placeholder_QtyField,value:n,pattern:"([0-9]*[.])?[0-9]+"}).inject(c);"targetQuantity"==i?(g=new h({elementsList:r,selectedIndex:u,placeholder:v.placeholder_UOM}).inject(c)).getContent().addClassName("xsr-grid-combobox-formula"):(g=new Q({value:d,emphasize:d}).inject(c)).getContent().addClassName("xsr-grid-label-formula");switch(p.getContent().addClassName("xsr-grid-lineeditor-formula"),i){case"targetQuantity":p.addEventListener("change",function(t){let e=""===t.dsModel.value?"":parseFloat(t.dsModel.value);a.updateOptions({grid:{targetQuantity:e}})});break;case"minQuantity":p.addEventListener("change",function(t){let e=""===t.dsModel.value?"":parseFloat(t.dsModel.value);a.updateOptions({grid:{minQuantity:e}})});break;case"maxQuantity":p.addEventListener("change",function(t){let e=""===t.dsModel.value?"":parseFloat(t.dsModel.value);a.updateOptions({grid:{maxQuantity:e}})})}return g.addEventListener("change",function(t){let e=t.dsModel.value;null!=e&&a.updateOptions({grid:{unit:l.get(e),unitNLS:e}})}),o})})}),o.dataGridView=new a({treeDocument:r,columns:w,showModelChangesFlag:!0,showTreeIconsFlag:!0,showRowBorderFlag:!0,showNodeKPIColorFlag:r.isColorized,cellSelection:"multiple",rowSelection:"none"});var b=[];this.dataGridView.getTreeDocument().onNodeModelUpdate(function(t,e){if(t.data.attributes){var n=t.data.attributes;let e=!1;if(n.hasOwnProperty("targetQuantity")||n.hasOwnProperty("minQuantity")||n.hasOwnProperty("maxQuantity")||n.hasOwnProperty("lossPercent")||n.hasOwnProperty("isQS")||n.hasOwnProperty("unit")){var i={};i.rowID=this._rowID,i.nodeModel=this;var a=function(t,e){t.nodeModel.options.grid.minQuantity=b[t.rowID].min,t.nodeModel.options.grid.maxQuantity=b[t.rowID].max,t.nodeModel.options.grid.targetQuantity=b[t.rowID].target,o.notify("error",e)};switch(n.hasOwnProperty("minQuantity")?"minQuantity":n.hasOwnProperty("maxQuantity")?"maxQuantity":n.hasOwnProperty("targetQuantity")?"targetQuantity":void 0){case"minQuantity":(i.nodeModel.getAttributeValue("targetQuantity")&&parseFloat(i.nodeModel.getAttributeValue("minQuantity"))>parseFloat(i.nodeModel.getAttributeValue("targetQuantity"))||i.nodeModel.getAttributeValue("maxQuantity")&&parseFloat(i.nodeModel.getAttributeValue("minQuantity"))>parseFloat(i.nodeModel.getAttributeValue("maxQuantity")))&&a(i,v.minPer_UpdateErr);break;case"maxQuantity":(i.nodeModel.getAttributeValue("targetQuantity")&&parseFloat(i.nodeModel.getAttributeValue("targetQuantity"))>parseFloat(i.nodeModel.getAttributeValue("maxQuantity"))||i.nodeModel.getAttributeValue("minQuantity")&&parseFloat(i.nodeModel.getAttributeValue("minQuantity"))>parseFloat(i.nodeModel.getAttributeValue("maxQuantity")))&&a(i,v.maxPer_UpdateErr);break;case"targetQuantity":(i.nodeModel.getAttributeValue("minQuantity")&&parseFloat(i.nodeModel.getAttributeValue("minQuantity"))>parseFloat(i.nodeModel.getAttributeValue("targetQuantity"))||i.nodeModel.getAttributeValue("maxQuantity")&&parseFloat(i.nodeModel.getAttributeValue("targetQuantity"))>parseFloat(i.nodeModel.getAttributeValue("maxQuantity")))&&a(i,v.targetPer_UpdateErr)}return i.nodeModel.getAttributeValue("lossPercent")&&(isNaN(parseFloat(i.nodeModel.getAttributeValue("lossPercent")))||0>parseFloat(i.nodeModel.getAttributeValue("lossPercent")))&&(0!=b.length&&null!=b[i.rowID]&&null!=b[i.rowID].loss?i.nodeModel.options.grid.lossPercent=b[i.rowID].loss:i.nodeModel.options.grid.lossPercent=void 0,o.notify("error",v.lossUpdateErr)),null!=i.nodeModel.getAttributeValue("targetQuantity")&&(null==i.nodeModel.getAttributeValue("maxQuantity")&&(i.nodeModel.options.grid.maxQuantity=i.nodeModel.getAttributeValue("targetQuantity")),null==i.nodeModel.getAttributeValue("minQuantity")&&(i.nodeModel.options.grid.minQuantity=i.nodeModel.getAttributeValue("targetQuantity"))),o.dataGridView.getTreeDocument().getChildren().forEach(function(t){if(t.options.grid.id===i.nodeModel.options.grid.id){var n={};n.min=i.nodeModel.options.grid.minQuantity,n.max=i.nodeModel.options.grid.maxQuantity,n.target=i.nodeModel.options.grid.targetQuantity,n.loss=i.nodeModel.options.grid.lossPercent,b[i.rowID]=n,t.options.grid=i.nodeModel.options.grid}null!=t.options.grid.minQuantity&&""!==t.options.grid.minQuantity&&t.options.grid.minQuantity!==1/0&&null!=t.options.grid.maxQuantity&&""!==t.options.grid.maxQuantity&&t.options.grid.maxQuantity!==1/0&&null!=t.options.grid.targetQuantity&&""!==t.options.grid.targetQuantity&&t.options.grid.targetQuantity!==1/0&&t.options.grid.unit||(e=!0)}),void(o.dialog._dialog.buttons.Ok.disabled=!!e)}}});var x=o.dataGridView.getTypeRepresentationFactory();x.registerTypeTemplates(JSON.stringify({UWAObjectTemplate:{path:"DS/SpecGridView/utils/UWAObjectTemplate",options:{}}}));return x.registerTypeRepresentations(JSON.stringify({UWAObject:{stdTemplate:"UWAObjectTemplate"}})),o.dataGridView.inject(p),p.inject(u),u},isOnlyPhysicalProducts:function(t){for(var e=0;e<t.length;e++)if(t[e].DimensionType)return!1;return!0},getNLSLabels:function(t){var e=t;if(e){var n=function(t){for(var e=0;e<t.length;e++)t[e].text=t[e].text&&v[t[e].text]?v[t[e].text]:t[e].text,t[e].children&&n(t[e].children)};n(e)}return e},notify:function(t,e){u.displayNotification({eventID:t,msg:e})}})});