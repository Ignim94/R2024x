define("DS/ENOFormulatedBOM/control/FormulatedViewManager",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/PlatformAPI/PlatformAPI","DS/SpecGridView/SpecGridView","DS/SpecGridView/utils/GridUtil","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/TypeUtils","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/GridCommonActionsManager","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XSRSearch","DS/XSRCommonComponents/utils/ContextManager","DS/ENOFormulatedBOM/service/FPBOMServiceProvider","DS/ENOFormulatedBOM/model/FormulatedProductItemModel","DS/ENOFormulatedBOM/control/AddFormulaIng","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/XSRCommonComponents/service/XSpecsActionsFactory","DS/ENOFormulatedBOM/view/FormulaBOMBatchSizeDialog","DS/XSRCommonComponents/utils/Notification","DS/Controls/ModalContainer","DS/Controls/SpinBox","DS/Controls/Button","DS/Controls/Label","text!DS/ENOFormulatedBOM/assets/config/FormulaBOMUnitSupportColumnConfig.json","text!DS/ENOFormulatedBOM/assets/config/FormulaBOMColumnConfig.json","text!DS/ENOFormulatedBOM/assets/config/FormulaBOMToolBarCmds.json","i18n!DS/ENOFormulatedBOM/assets/nls/FormulaBOM","css!DS/ENOFormulatedBOM/FormulaBOM.css"],function(e,t,a,i,r,n,s,o,d,l,c,u,m,p,h,g,f,M,y,b,v,E,O,N,S,_,C,I,T){"use strict";var B,P,A;return a.extend({init:function(e){this.appCore=e.appCore,this.itemId=Array.isArray(e.itemId)?e.itemId[0]:e.itemId,this.container=e.container,this.modelEvents=this.appCore.specViewerModelEvents,this.basicModelEvents=this.appCore.basicModelEvents,this.specViewContainer=this.appCore.specViewContainer,this.currentTabKey=e.currentTabKey,this.canTriggerCellEvents=!0,this.isReorderTriggered=!1,this.itemTitle=e.specModel.getTitle(),this.itemMaturity=e.specModel.getMaturity(),this.target=e.appCore.specMainContainer,this.specModel=e.specModel,p.setContextItemId(this.specModel.getID()),p.setContextItemTitle(this.itemTitle),this.appCore.specRouteManager.setActiveSpecItem(this.specModel),this._formulaBOMSubscriptionList=[],this.FBOMPlatFormSubscription=[],this._subscribeEvents();var t={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container,parentNodeModel:this.specModel};this.service=new h(t),this.itemservice=new M},render:function(){var t=this;this._formulatedBOMContainer=e.createElement("div",{class:"multigrid-formulatedbom-container"}).inject(this.container),u.maskLoader(t.container,T.Loaderloading),new d({id:"getCustomAttributes"}).getAttributes().then(async function(e){var a=await l.getCustomAttributes(e,t.currentTabKey);u.unmaskLoader(t.container),t.initializeSingleGrid(a)}).catch(function(e){u.unmaskLoader(t.container),console.warn("indexation in-progress,loading.."),t.initializeSingleGrid(void 0)})},initializeSingleGrid:async function(t){var a={itemId:this.itemId,container:this._formulatedBOMContainer,appCore:this.appCore,currentTabKey:this.currentTabKey,enableCrossWidgetFeature:!0,isColorized:!0,parentModel:this.specModel,enableInteractiveRightPanel:!0};this.formulatedBOMGrid=new r(a);var i=JSON.parse(I),n=this.getNLSLabels(i.actions);let s=JSON.parse(C),o=this.getNLSLabels(s.columns);this.removedColumn=o.filter(e=>!(!this.isWeightUnitEnabled()||"FormulaQunatityPercent"!==e.dataIndex)||!this.isWeightUnitEnabled()&&"FormulaQuantityRange"===e.dataIndex),o=o.filter(e=>(!this.isWeightUnitEnabled()||"FormulaQunatityPercent"!==e.dataIndex)&&!(!this.isWeightUnitEnabled()&&"FormulaQuantityRange"===e.dataIndex)),t&&void 0!==t&&(o=o.concat(t)),this.formulatedBOMGrid.setColumns(o),this.formulatedBOMGrid.render(),this.formulatedBOMGrid.setToolBarActions({actions:n}),p.setBOMTabOptions({appCore:this.appCore,maskContainer:this.container,gridView:this.formulatedBOMGrid});let d=document.getElementsByClassName("enox-collection-toolbar-container")[0];this.targetBatchContainer=e.createElement("div",{class:"target-batchsize-container",html:T.label_referenceBatchSize}).inject(d),this.batchsizelabelContainer=e.createElement("span",{class:"batch-label-container"}).inject(this.targetBatchContainer),this.batchsizepencilContainer=e.createElement("span",{class:"batchsize-pencil-container",title:T.label_editMode}).inject(this.targetBatchContainer);var l=new N({name:"pencil",displayStyle:"lite",icon:{iconName:"pencil",fontIconFamily:WUXManagedFontIcons.Font3DS}}).inject(this.batchsizepencilContainer);(B=new S({value:"",emphasize:"primary"}).inject(this.batchsizelabelContainer)).value=parseFloat(this.specModel.getRefQuantity())+" "+this.specModel.getUnitNLSLabel(),this.dialogContainer=new e.Element("div",{class:"batchsize-dialog-container"}).inject(this.target),l.addEventListener("click",this.openDialog.bind(this)),this.isWeightUnitEnabled()?this.targetlabelContainer=e.createElement("span",{class:"target-label-container",text:T.label_totalTargetQty}).inject(this.targetBatchContainer):this.targetlabelContainer=e.createElement("span",{class:"target-label-container",text:T.label_totalTarget}).inject(this.targetBatchContainer),this.targetValueContainer=e.createElement("span",{class:"target-value-container"}).inject(this.targetBatchContainer),P=new S({value:"",emphasize:"warning"}).inject(this.targetValueContainer),this.getFormulaBOM()},getFormulaBOM:async function(e,a){var i=this;u.maskLoader(i.container,T.Loaderloading);let r,n=await i.service.expand([this.itemId],e),{didresourceidAttrMap:s,instIds:o,nodes:d,childIds:l,paths:c}=n.results.reduce((e,t)=>{if(t.hasOwnProperty("attributes")){let a=t.attributes.find(e=>"did"===e.name),r=t.attributes.find(e=>"resourceid"===e.name),n=t.attributes.find(e=>"ds6w:type"===e.name),s=t.attributes.find(e=>"ro.plminstance.V_treeorder"===e.name),o=e.didresourceidAttrMap;if(o||(o=new Map,e.didresourceidAttrMap=o),o[a.value]=r.value,s){let a=e.instIds;a||(a=new Set,e.instIds=a);let i=t.attributes.find(e=>"resourceid"===e.name);i&&a.add(i.value)}let d=e.nodes;d||(d={},e.nodes=d);let l=t.attributes.reduce((e,t)=>(e[t.name]=t.value,e),{});if(l.physicalid=r.value,d[r.value]=l,"VPMInstance"!==n.value){let t=e.childIds;t||(t=new Set,e.childIds=t),r.value!==i.itemId&&t.add(r.value)}}else if(t.hasOwnProperty("path")){let a=e.paths;a||(a=[],e.paths=a),a.push(t.path)}return e},{});c=c.map(e=>e.map(e=>s[e])),l.size>0?(r=(n=await i.service.gateMaturity(Array.from(l))).result.reduce((e,t)=>{let a=d[t.id];return a["ds6w:policy"]=t.policy,a["ds6w:status"]=t.policy+"."+t.status,a.current=t.status,e.add(t.policy),e},new Set))&&r.size>0&&i.itemservice.getStatesNLS({policies:Array.from(r)}).then(t=>{console.log(t);let r=t.policies.reduce((e,t)=>{let{policyName:a,states:i}=t;return i.forEach(t=>{let i=a+"."+t.stateSysName;e[i]=t.stateUserName}),e},{});i.loadTreeStructure(d,c,r,a,e)}):u.unmaskLoader(i.container);let m=[];if(l&&l.size>0){let e={};e.references=Array.from(l),e.with_partials=!0,m.push(i.itemservice.fetchCoreMatDetails(e))}l&&l.size>0&&m.push(i.service.fetchAlternateInfo(Array.from(l))),o&&o.size>0&&m.push(i.service.getFRMContQtyInstances(Array.from(o))),t.allSettled(m).then(e=>{let t={},r={},n={};i.canTriggerCellEvents=!1,e.forEach((e,a)=>{let i=e.value;if(i)if(0===a)for(const[e,t]of i.entries()){let a=t.physicalid,i=t.V_Name?t.V_Name:"",n=t.revision?t.revision:"-",s=r[e];s||(s={},r[e]=s),s.coreMaterial=i+" "+n,s.coreMaterialId=a}else if(1===a)for(const a in e.value.AlternateItemInfo){let e=t[a];e||(e={},t[a]=e),e.Alternate="Yes",e["ds6w:alternate"]=T.label_yes}else if(2===a)for(const e in i.result){let t=i.result[e].instanceId;n[t]=i.result[e]}});let s=!1;i.formulatedBOMGrid.getTreeDocument().getAllDescendants().forEach(e=>{if("function"!=typeof e.getID)return;let a=e.getAttributeValue("physicalId"),o=e.getAttributeValue("instanceId"),d=r[a]||{},l=t[a]||{},c=n[o]||{},u={};u.coreMaterial=d.coreMaterial||"",u.coreMaterialId=d.coreMaterialId||"",u.Alternate=l.Alternate||"",u["ds6w:alternate"]=l.Alternate||"",c.quantityUOM&&""!==c.quantityUOM.dbName?(i.isWeightUnitEnabled()||(s=!0),u.minQuantity=c.minQuantity,u.maxQuantity=c.maxQuantity,u.targetQuantity=c.targetQuantity,u.unit=c.quantityUOM.dbName,u.unitNLS=c.quantityUOM.nlsLabel,u.targetQuantityBaseValue=c.targetQuantityBaseValue,e.isWeightUnitExist=!0):(i.isWeightUnitEnabled()&&(s=!0),u.minPercent=c.minPercent,u.maxPercent=c.maxPercent,u.targetPercent=c.targetPercent,e.isWeightUnitExist=!1),u.lossPercent=c.lossPercent,u.isQS=c.isQS,e.updateOptions({grid:u}),e.acceptChanges(),e.updateSpecDetails_async()}),a&&s&&i.formulatedBOMGrid.addColumn(i.removedColumn[0],4),i.updateTotalTarget(),i.canTriggerCellEvents=!0})},loadTreeStructure(e,t,a,i,r){var n=this;n.formulatedBOMGrid.getTreeDocument().removeRoots(),n.formulatedBOMGrid.getTreeDocument().acceptChanges(),A=[...o.rawMaterialArray],l.formulatedDMSTypes&&(A=A.concat(l.formulatedDMSTypes)),(A=A.reduce((e,t)=>(e[t.valueItem]=t.labelItem,e),{})).Formulated_Product=T.label_FRMProduct;let s={},d=[];t.forEach(t=>{if(t.length<3)return;let r={parentId:"",instanceId:"",occurrencePath:[],occurenceTitle:"",parentPath:"",order:""};for(let o=0;o<t.length;o++){let c=t[o];if(r.occurrencePath.push(e[c].physicalid),n.itemId!==c){if(o%2==1&&null!=e[c]["ds6w:label"]&&(r.occurenceTitle=e[c]["ds6w:label"],r.order=e[c]["ro.plminstance.V_treeorder"],r.isWeightUnitExist=n.isWeightUnitEnabled()),o%2==1&&(r.instanceId=c),o%2==0){let t=Object.assign({},e[c]),o=r.parentId||n.itemId,u=c,m=r.occurrencePath.join("/"),p=r.parentPath,h=(r.occurrencePath.length-1)/2,f=s[m];if(!f){let e={showChildren:!i};t.instanceName=r.occurenceTitle,t.instanceTitle=r.occurenceTitle,t.instanceId=r.instanceId,t.parentId=o,t.relationid=r.instanceId,t.level=h;let c=t["ds6w:type"];t["ds6w:type"]=A[c],t["ds6w:type_value"]=c,t["ds6w:status_value"]=t["ds6w:status"],t["ds6w:status_value"]=t["ds6w:status"],t["ds6w:status"]=a[t["ds6w:status"]],t["ds6wg:PLMReference.V_isLastVersion"]="TRUE"===t["ds6wg:PLMReference.V_isLastVersion"],t.islastrevision="TRUE"===t.islastrevision,t["ds6w:reserved"]="TRUE"===t["ds6w:reserved"],t["ds6w:manufacturable"]="TRUE"===t["ds6w:manufacturable"],t["ds6w:created"]=l.getformatedDate(t["ds6w:created"]),t["ds6w:modified"]=l.getformatedDate(t["ds6w:modified"]),t.coreMaterial="Loading...",t.coreMaterialId="Loading...",t.Alternate="Loading...",t["ds6w:alternate"]="Loading...",(f=new g(e).set(t,!1)).currentTabKey=n.currentTabKey,f.appCore=n.appCore,f.currentPath=m,f.treeOrder=r.order;let u=s[p];u?(u.addChild(f),u.getChildren().sort((e,t)=>parseFloat(e.treeOrder)-parseFloat(t.treeOrder)),f.parentNodeModel=u):(d.push(f),f.parentNodeModel=n.specModel),s[m]=f}f&&(r.parentId=u,r.parentPath=m)}}else r.parentId=c}}),d.sort((e,t)=>parseFloat(e.treeOrder)-parseFloat(t.treeOrder)),n.formulatedBOMGrid.addRootNodes(d),i&&n.formulatedBOMGrid.getTreeDocument().withTransactionUpdate(()=>{n.formulatedBOMGrid.gridTreeDocument.itemModelMapping=[],n.expand_nodes(d,r)}),u.unmaskLoader(n.container)},evt_ExpandNode:async function(e){var a=this;u.maskLoader(a.container,T.Loaderloading);var i=e.data.nodeModel.getChildren();i&&i.length>0&&(a.formulatedBOMGrid.getTreeDocument().setUseChangeTransactionMode(!1),e.data.nodeModel.removeChildren(),a.formulatedBOMGrid.getTreeDocument().setUseChangeTransactionMode(!0));let r=e.data.nodeModel.getAttributeValue("physicalId"),n=await this.service.expand([r],"1");u.unmaskLoader(a.container);let s,{didresourceidAttrMap:o,instIds:d,nodes:l,childIds:c,paths:m}=n.results.reduce((e,t)=>{if(t.hasOwnProperty("attributes")){let i=t.attributes.find(e=>"did"===e.name),r=t.attributes.find(e=>"resourceid"===e.name),n=t.attributes.find(e=>"ds6w:type"===e.name),s=t.attributes.find(e=>"ro.plminstance.V_treeorder"===e.name),o=e.didresourceidAttrMap;if(o||(o=new Map,e.didresourceidAttrMap=o),o[i.value]=r.value,s){let a=e.instIds;a||(a=new Set,e.instIds=a);let i=t.attributes.find(e=>"resourceid"===e.name);i&&a.add(i.value)}let d=e.nodes;d||(d={},e.nodes=d);let l=t.attributes.reduce((e,t)=>(e[t.name]=t.value,e),{});if(l.physicalid=r.value,d[r.value]=l,"VPMInstance"!==n.value){let t=e.childIds;t||(t=new Set,e.childIds=t),r.value!==a.itemId&&t.add(r.value)}}else if(t.hasOwnProperty("path")){let a=e.paths;a||(a=[],e.paths=a),a.push(t.path)}return e},{});m=m.map(e=>e.map(e=>o[e])),c.size>0?(s=(n=await a.service.gateMaturity(Array.from(c))).result.reduce((e,t)=>{let a=l[t.id];return a["ds6w:policy"]=t.policy,a["ds6w:status"]=t.policy+"."+t.status,a.current=t.status,e.add(t.policy),e},new Set))&&s.size>0&&a.itemservice.getStatesNLS({policies:Array.from(s)}).then(t=>{console.log(t);let i=t.policies.reduce((e,t)=>{let{policyName:a,states:i}=t;return i.forEach(t=>{let i=a+"."+t.stateSysName;e[i]=t.stateUserName}),e},{});a.addBOMChildren(l,m,i,e.data.nodeModel)}):u.unmaskLoader(a.container);let p=[];if(c&&c.size>0){let e={};e.references=Array.from(c),e.with_partials=!0,p.push(a.itemservice.fetchCoreMatDetails(e))}c&&c.size>0&&p.push(a.service.fetchAlternateInfo(Array.from(c))),d&&d.size>0&&p.push(a.service.getFRMContQtyInstances(Array.from(d))),t.allSettled(p).then(t=>{let i={},r={},n={};if(a.canTriggerCellEvents=!1,t.forEach((e,t)=>{let a=e.value;if(a)if(0===t)for(const[e,t]of a.entries()){let a=t.physicalid,i=t.V_Name?t.V_Name:"",n=t.revision?t.revision:"-",s=r[e];s||(s={},r[e]=s),s.coreMaterial=i+" "+n,s.coreMaterialId=a}else if(1===t)for(const t in e.value.AlternateItemInfo){let e=i[t];e||(e={},i[t]=e),e.Alternate="Yes",e["ds6w:alternate"]=T.label_yes}else if(2===t)for(const e in a.result){let t=a.result[e].instanceId;n[t]=a.result[e]}}),null==e.data.nodeModel.getChildren())return;let s=!1;e.data.nodeModel.getChildren().forEach(e=>{if("function"!=typeof e.getID)return;let t=e.getAttributeValue("physicalId"),o=e.getAttributeValue("instanceId"),d=r[t]||{},l=i[t]||{},c=n[o]||{},u={};u.coreMaterial=d.coreMaterial||"",u.coreMaterialId=d.coreMaterialId||"",u.Alternate=l.Alternate||"",u["ds6w:alternate"]=l.Alternate||"",c.quantityUOM&&""!==c.quantityUOM.dbName?(a.isWeightUnitEnabled()||(s=!0),u.minQuantity=c.minQuantity,u.maxQuantity=c.maxQuantity,u.targetQuantity=c.targetQuantity,u.unit=c.quantityUOM.dbName,u.unitNLS=c.quantityUOM.nlsLabel,u.targetQuantityBaseValue=c.targetQuantityBaseValue,e.isWeightUnitExist=!0):(a.isWeightUnitEnabled()&&(s=!0),u.minPercent=c.minPercent,u.maxPercent=c.maxPercent,u.targetPercent=c.targetPercent,e.isWeightUnitExist=!1),u.lossPercent=c.lossPercent,u.isQS=c.isQS,e.updateOptions({grid:u}),e.acceptChanges(),e.updateSpecDetails_async()}),s&&a.formulatedBOMGrid.addColumn(a.removedColumn[0],4),a.updateTotalTarget(),a.canTriggerCellEvents=!0})},addBOMChildren:function(e,t,a,i){var r=this;A=[...o.rawMaterialArray],l.formulatedDMSTypes&&(A=A.concat(l.formulatedDMSTypes)),(A=A.reduce((e,t)=>(e[t.valueItem]=t.labelItem,e),{})).Formulated_Product=T.label_FRMProduct;t[1],t[2];let n=i.currentPath,s=[];t.forEach(t=>{if(3!=t.length)return;let i=t[0],o=t[1],d=t[2],c=n.split("/");c.push(o),c.push(d);let u=Object.assign({},e[d]),m=Object.assign({},e[o]),p=c.join("/"),h=(c.length-1)/2;u.instanceName=m["ds6w:label"],u.instanceTitle=m["ds6w:label"],u.instanceId=o,u.parentId=i,u.relationid=o,u.level=h;let f=u["ds6w:type"];u["ds6w:type"]=A[f],u["ds6w:type_value"]=f,u["ds6w:status_value"]=u["ds6w:status"],u["ds6w:status_value"]=u["ds6w:status"],u["ds6w:status"]=a[u["ds6w:status"]],u["ds6wg:PLMReference.V_isLastVersion"]="TRUE"===u["ds6wg:PLMReference.V_isLastVersion"],u.islastrevision="TRUE"===u.islastrevision,u["ds6w:reserved"]="TRUE"===u["ds6w:reserved"],u["ds6w:manufacturable"]="TRUE"===u["ds6w:manufacturable"],u["ds6w:created"]=l.getformatedDate(u["ds6w:created"]),u["ds6w:modified"]=l.getformatedDate(u["ds6w:modified"]),u.coreMaterial="Loading...",u.coreMaterialId="Loading...",u.Alternate="Loading...",u["ds6w:alternate"]="Loading...";let M=new g({showChildren:!0}).set(u,!1);M.currentTabKey=r.currentTabKey,M.appCore=r.appCore,M.currentPath=p,M.treeOrder=m["ro.plminstance.V_treeorder"],s.push(M)}),s.sort((e,t)=>parseFloat(e.treeOrder)-parseFloat(t.treeOrder)),i.addChild(s),r.formulatedBOMGrid.getTreeDocument().acceptChanges(),u.unmaskLoader(r.container)},_subscribeEvents:function(){var t=this;this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:"collapse-"+this.currentTabKey},e=>{console.log("collapsedata",e);let a=!1;t.formulatedBOMGrid.getTreeDocument().processDescendants({onlyVisibleNodes:!0,processNode:function(){(t.isWeightUnitEnabled()&&!this.isWeightUnitExist||!t.isWeightUnitEnabled()&&this.isWeightUnitExist)&&(a=!0)}}),a||t.formulatedBOMGrid.removeColumns([t.removedColumn[0].dataIndex])})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.SPECS_EXPAND_NODES+"-"+this.currentTabKey},e=>t.evt_ExpandNode(e))),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:"xsr-reorder-event-update"},function(e){t.isReorderTriggered&&(t.isReorderTriggered=!1,t.formulatedBOMGrid.model.getUseChangeTransactionMode()||t.formulatedBOMGrid.model.setUseChangeTransactionMode(!0))})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_GRID_TOTAL_SELECTED_NODES},function(e){if(t.selectedGridCount=e.count,t.selectedGridNodes=e.currentModel,t.selectedGridCount>0){let e=[];o.isRawMaterial(t.selectedGridNodes[0].getAttributeValue("ds6w:type_value"))||t.selectedGridCount>1||t.selectedGridNodes[0].getAttributeValue("ds6w:status")===s.WELCOMEPANEL_ID_RELEASED||t.selectedGridNodes[0].getAttributeValue("ds6w:status")===s.WELCOMEPANEL_ID_OBSOLETE?e.push("add"):t.formulatedBOMGrid.toolbar.enableCommands(["add"]),t.formulatedBOMGrid.toolbar.disableCommands(e)}else"function"!=typeof t.specModel.getMaturityActualName||"RELEASED"!==t.specModel.getMaturityActualName()&&"OBSOLETE"!==t.specModel.getMaturityActualName()?t.formulatedBOMGrid.toolbar.enableCommands(["add","reorder"]):t.formulatedBOMGrid.toolbar.disableCommands(["add"])})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_GRID_UPDATE_FETCH_MODE},function(){t.updateFetchMode()})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:"grid-toolbar-commands-update"},function(){t.formulatedBOMGrid.toolbar.disableCommands(["add","removeitem","deleteItem"]);let e=document.getElementsByClassName("batchsize-pencil-container")[0];e.style.opacity="0.5",e.style.pointerEvents="none"})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_GRID_SYNC_NODE_DATA},function(e){e&&Array.isArray(e)?e.forEach(function(e){t.syncNodeBasedOnID(e)}):e&&t.syncNodeBasedOnID(e)})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.GRID_CONTEXT_MENU+"-"+s.FORMULABOM_TAB},function(e){var a=t.formulatedBOMGrid.getTreeDocument().getSelectedNodes();e.gridInstance=t.formulatedBOMGrid;var i=["Information_Widget","Alternates","UPSAuthReplaceByRevision","UPSAuthCut","UPSAuthCopy","UPSAuthPaste"];a&&a.length>1&&(i.push("UPSAuthReorderProduct"),c.getMultiActionMenu(e,i)),a&&1===a.length&&o.isRawMaterial(t.selectedGridNodes[0].getAttributeValue("ds6w:type_value"))&&i.push("UPSAuthReorderProduct"),c.getActionMenu(e,i)})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.UPDATE_MULTI_TOOLBAR_MENU+"-"+s.FORMULABOM_TAB},function(e){e.nodeModel=t.formulatedBOMGrid.getTreeDocument(),e.gridInstance=t.formulatedBOMGrid;var a=t.formulatedBOMGrid.getTreeDocument().getSelectedNodes(),i=[];a&&1===a.length&&(i=["Information_Widget","Alternates","UPSAuthReplaceByRevision","UPSAuthCut","UPSAuthCopy","UPSAuthPaste"],o.isRawMaterial(t.selectedGridNodes[0].getAttributeValue("ds6w:type_value"))&&i.push("UPSAuthReorderProduct")),a&&a.length>1&&(i=["UPSAuthReplaceByRevision","UPSAuthCut","UPSAuthCopy","UPSAuthPaste"]),c.getToolbarActionMenu(e,i)})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_GRID_CELL_VALUE_UPDATE+"-"+s.FORMULABOM_TAB},e=>t.evt_GridCellValueUpdateFormulaBOM(e))),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_GRID_TOOLBAR_ACTION_CLICK+"-"+s.FORMULABOM_TAB},e=>t.evt_GridToolbarActionClickFormulaBOM(e))),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_LAUNCH_PREV_NEXT_COMMAND},e=>t.evt_LanchPrevNextCommand(e))),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_GRID_LIST_REMOVE_NODE_SUCCESSFULL+"-"+s.FORMULABOM_TAB},function(e){t._removeNodes(e),0==t.specModel.getAllDescendants().length&&(l.isFormulaUnitsEnabled()&&!e.options.grid.unit||!l.isFormulaUnitsEnabled()&&e.options.grid.unit)?(t.specModel.setBOMConnection(!1),t._formulatedBOMContainer.remove(),t.render()):t.updateTotalTarget()})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_GRID_LIST_UNPARENT_NODE_SUCCESSFUL+"-"+s.FORMULABOM_TAB},function(e){let a=[];a=t.formulatedBOMGrid.getTreeDocument().getSelectedNodes().filter(t=>e.includes(t.getInstanceId())),t._removeNodes(a),0==t.specModel.getAllDescendants().length&&(l.isFormulaUnitsEnabled()&&!a[0].options.grid.unit||!l.isFormulaUnitsEnabled()&&a[0].options.grid.unit)?(t.specModel.setBOMConnection(!1),t._formulatedBOMContainer.remove(),t.render()):t.updateTotalTarget()})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_ADD_FORMULA_INGREDIENT},function(e){t.evt_AddFINodeBOMSuccess(e)})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:s.EVENT_BOM_GRID_ICON_CLICK},function(e){if("Alternate"===e.column){let a={commandId:s.INFORMATION_CMD,selectedNode:e.cellInfo.nodeModel,appCore:t.appCore,selectFacet:s.FACET_ALTERNATE};c.launch(a)}})),this._formulaBOMSubscriptionList.push(this.modelEvents.subscribe({event:"reorder-close-event-listener-formulatedbom"},e=>{let a=function(e){"click"==e.type?t.formulatedBOMGrid.model.setUseChangeTransactionMode(!1):"close"==e.type&&t.formulatedBOMGrid.model.setUseChangeTransactionMode(!0)};e?(e.reorderDlg._dialog.addEventListener("close",a,!1),e.reorderDlg._dialog.buttons.Ok.addEventListener("click",a,!1)):t.formulatedBOMGrid.model.setUseChangeTransactionMode(!0)})),this.FBOMPlatFormSubscription=i.subscribe(s.EVENT_PART_NUMBER_UPDATE,function(e){if(e&&Array.isArray(e.references)){var a=e.references;t.updateFetchMode();for(var i=0;i<a.length;i++){var r=a[i].physicalid;t.syncNodeBasedOnID(r),t.basicModelEvents.publish({event:s.EVENT_INFORMATION_PANEL_REFRESH})}}}),this.FBOMPlatFormSubscription=i.subscribe(s.EVENT_ALTERNATE_UPDATE,function(e){t.updateFetchMode(),t._updateAlternateItemInfo(e)}),this.FBOMPlatFormSubscription=i.subscribe(s.EVENT_PADUTILS_REFRESH,function(a){a.data.authored&&a.data.authored.modified&&(t.updateFetchMode(),a.data.authored.modified.forEach(function(a){var i;e.is(a,"object")?i=a.physicalid:e.is(a,"string")&&(i=a),t.syncNodeBasedOnID(i),t.basicModelEvents.publish({event:s.EVENT_INFORMATION_PANEL_REFRESH})}))}),this.FBOMPlatFormSubscription=i.subscribe("DS/Information/CommandProxy/AddExtension",function(a){a.authored&&a.authored.modified&&(t.updateFetchMode(),a.authored.modified.forEach(function(a){var i;e.is(a,"object")?i=a.physicalid:e.is(a,"string")&&(i=a),t.syncRemoveCustomDataNode(i),t.syncNodeBasedOnID(i),t.basicModelEvents.publish({event:s.EVENT_INFORMATION_PANEL_REFRESH})}))})},syncRemoveCustomDataNode:function(e){var t=this;t.formulatedBOMGrid.getTreeDocument().getSelectedNodes().forEach(function(a){if("function"==typeof a.getID&&a.getID()===e&&a.options.grid){for(let e in a.options.grid)e.startsWith(t.currentTabKey)&&(a.options.grid[e]=void 0);a.acceptChanges(),t.syncInstanceModels(a)}})},syncNodeBasedOnID:function(e){var t=this;t.formulatedBOMGrid.getTreeDocument().getSelectedNodes().forEach(function(a){if(a.getID()===e){var i=new d({id:"getAttributeDetails"}),r={lIds:[e],relIDs:[],busIDs:[],plmparameters:"false",attributes:"true",navigateToMain:"false",readonly:"true",debug_properties:""};i.getDetails(r).then(function(e){if(null!=e){var i=e.results[0].data;i&&a.options.grid&&(i.forEach(e=>{if(e.value)for(let i in a.options.grid)t.currentTabKey+e.path===i&&(e.type&&"boolean"===e.type?a.options.grid[i]=e.value[0].toString():a.options.grid[i]=e.value);else a.options.grid[t.currentTabKey+e.path]=""}),t.syncInstanceModels(a))}}).catch(function(e){console.log(e)}),t.service.fetchItemInfo([e]).then(function(e){a.set(e)}).catch(function(e){console.log(e)})}})},syncInstanceModels:function(t){let a=this.formulatedBOMGrid.getGridNodes();a&&e.is(a,"array")&&a.forEach(function(e){e.getID()===t.getID()&&(e.syncInstances(t),e.acceptChanges())}),this.formulatedBOMGrid.getTreeDocument().acceptChanges()},_updateAlternateItemInfo:function(e){var t=this;e.forEach(function(e){if(t.formulatedBOMGrid.getGridNodeCount()>0){t.formulatedBOMGrid.getGridNodes().forEach(function(t){if(t.getID()==e.physicalid){let a=e.alternate;"Yes"===a?(t.setDisplayAlternate(T.label_yes),t.setAlternate(a)):(t.setDisplayAlternate(T.label_no),t.setAlternate("")),t.updateOptions(t.options)}})}})},bomExpandTreeInput:function(){var t=this,a=e.createElement("div",{class:"expandLevelInput"});let i=new O({minValue:1,decimals:0,stepValue:1,pageStepValue:1,displayStyle:"lite"});i.inject(a);let r=new N({displayStyle:"lite",label:"proceed",icon:{iconName:"check",fontIconFamily:WUXManagedFontIcons.Font3DS},showLabelFlag:!1});r.inject(a),r.getContent().addEventListener("buttonclick",function(){let e=i.value;E.removeModal(t.container),"index"===widget.getValue("fetchmode")?t.progressiveExpand(e):t.bomExpandTree(e)}),E.createModal(t.container,a)},expand_nodes(e,t){var a=this;e&&e.forEach(e=>{e.getAttributeValue("level")==t?e.addChild(new g({showChildren:!1})):(e.setState({state:"expanded"}),a.expand_nodes(e.getChildren(),t))})},bomCollapseAll:function(){this.formulatedBOMGrid.removeColumns([this.removedColumn[0].dataIndex]),this.formulatedBOMGrid.getTreeDocument().getAllDescendants().forEach(e=>{e.setState({state:"collapsed"})})},bomExpandTree:async function(e){-1!=e&&(e+=1),this.getFormulaBOM(e+"",!0)},progressiveExpand:async function(e){var a=this;let i={pid:this.itemId,isFormulaBOM:!0};e&&(i.level=e+1),u.maskLoader(a.container,T.UpdatingLoader);let r=await a.itemservice.expandV2(i);if(r.hasOwnProperty("errors"))return v.displayNotification({eventID:"info",msg:T.ERROR_IndexModeFetch}),void u.unmaskLoader(a.container);0===r.results.length&&(a.formulatedBOMGrid.getTreeDocument().removeRoots(),a.formulatedBOMGrid.getTreeDocument().acceptChanges(),u.unmaskLoader(a.container));let n,{instIds:s,nodes:o,childIds:d,paths:l}=r.results.reduce((e,t)=>{if(t.hasOwnProperty("Path")){let a=e.paths;a||(a=[],e.paths=a),a.push(t.Path)}else{if("VPMInstance"!==t.type){let i=e.childIds;i||(i=new Set,e.childIds=i),t.resourceid!==a.itemId&&i.add(t.resourceid)}if("VPMInstance"===t.type){let i=e.instIds;i||(i=new Set,e.instIds=i),t.resourceid!==a.itemId&&i.add(t.resourceid)}let i=e.nodes;i||(i={},e.nodes=i),t.physicalid=t.resourceid,i[t.resourceid]=t}return e},{});if(d.size>0){(n=(await a.service.gateMaturity(Array.from(d))).result.reduce((e,t)=>{let a=o[t.id];return a["ds6w:policy"]=t.policy,a["ds6w:status"]=t.policy+"."+t.status,a.current=t.status,e.add(t.policy),e},new Set))&&n.size>0&&a.itemservice.getStatesNLS({policies:Array.from(n)}).then(e=>{console.log(e);let t=e.policies.reduce((e,t)=>{let{policyName:a,states:i}=t;return i.forEach(t=>{let i=a+"."+t.stateSysName;e[i]=t.stateUserName}),e},{});a.loadTreeStructure(o,l,t,!0)})}else u.unmaskLoader(a.container);let c=[];if(d&&d.size>0){let e={};e.references=Array.from(d),e.with_partials=!0,c.push(a.itemservice.fetchCoreMatDetails(e))}d&&d.size>0&&c.push(a.service.fetchAlternateInfo(Array.from(d))),s&&s.size>0&&c.push(a.service.getFRMContQtyInstances(Array.from(s))),t.allSettled(c).then(e=>{let t={},i={},r={};a.canTriggerCellEvents=!1,e.forEach((e,a)=>{let n=e.value;if(n)if(0===a)for(const[e,t]of n.entries()){let a=t.physicalid,r=t.V_Name?t.V_Name:"",n=t.revision?t.revision:"-",s=i[e];s||(s={},i[e]=s),s.coreMaterial=r+" "+n,s.coreMaterialId=a}else if(1===a)for(const a in e.value.AlternateItemInfo){let e=t[a];e||(e={},t[a]=e),e.Alternate="Yes",e["ds6w:alternate"]=T.label_yes}else if(2===a)for(const e in n.result){let t=n.result[e].instanceId;r[t]=n.result[e]}});let n=!1;a.formulatedBOMGrid.getTreeDocument().getAllDescendants().forEach(e=>{if("function"!=typeof e.getID)return;let s=e.getAttributeValue("physicalId"),o=e.getAttributeValue("instanceId"),d=i[s]||{},l=t[s]||{},c=r[o]||{},u={};u.coreMaterial=d.coreMaterial||"",u.coreMaterialId=d.coreMaterialId||"",u.Alternate=l.Alternate||"",u["ds6w:alternate"]=l.Alternate||"",c.quantityUOM&&""!==c.quantityUOM.dbName?(a.isWeightUnitEnabled()||(n=!0),u.minQuantity=c.minQuantity,u.maxQuantity=c.maxQuantity,u.targetQuantity=c.targetQuantity,u.unit=c.quantityUOM.dbName,u.unitNLS=c.quantityUOM.nlsLabel,u.targetQuantityBaseValue=c.targetQuantityBaseValue,e.isWeightUnitExist=!0):(a.isWeightUnitEnabled()&&(n=!0),u.minPercent=c.minPercent,u.maxPercent=c.maxPercent,u.targetPercent=c.targetPercent,e.isWeightUnitExist=!1),u.lossPercent=c.lossPercent,u.isQS=c.isQS,e.updateOptions({grid:u}),e.acceptChanges(),e.updateSpecDetails_async()}),n&&a.formulatedBOMGrid.addColumn(a.removedColumn[0],4),a.updateTotalTarget(),a.canTriggerCellEvents=!0})},reloadSameNodes:function(e){if(!e)return;this.formulatedBOMGrid.getTreeDocument().processDescendants({onlyVisibleNodes:!0,processNode:function(){console.log(this.getState()),e.getAttributeValue("id")===this.getAttributeValue("id")&&e._id!==this._id&&"collapsed"!==this.getState()&&(this.setState({state:"collapsed"}),this.expand())}})},evt_AddFINodeBOMSuccess:function(e){let a=this,i=[],r=[],n=[],s={showChildren:!0};if(a.updateFetchMode(),e){let o=e.nodes,d=o.map(e=>e.child.id),l=a.formulatedBOMGrid.getTreeDocument().getSelectedNodes();if(l.length>0){let e=l[0].getState();if("collapsed"===e)return a.reloadSameNodes(l[0]),void l[0].expand();if("noChildren"===e)return l[0].setState({state:"collapsed"}),l[0].expand(),void a.reloadSameNodes(l[0])}a.reloadSameNodes(l[0]),d.forEach(e=>{i.push(a.service.fetchItemInfo([e]))});let c={};c.references=d,c.with_partials=!0,n.push(a.itemservice.fetchCoreMatDetails(c)),n.push(a.service.fetchAlternateInfo(d)),t.allSettled(i).then(function(e){if(e&&e.length>0){a.mergeDataAndRelData(e,o).forEach(e=>{let t=new g(s).set(e.value);t.isWeightUnitExist=!!t.getAttributeValue("unitNLS"),t.parentNodeModel=a.specModel,t.currentTabKey=a.currentTabKey,t.appCore=a.appCore,t.onContainer=a.container,t.setInstanceTitle(e.value.instanceTitle);let i=l.length>0?l[0].currentPath.split("/"):[a.specModel.getAttributeValue("id")];i.push(e.value.instanceId),i.push(e.value.resourceid),t.currentPath=i.join("/"),l.length>0?(t.parentNodeModel=l[0],l[0].addChild(t),t.acceptChanges()):a.formulatedBOMGrid.addRootNodes(t),r.push(t)}),0==l.length&&a.updateTotalTarget()}}).catch(function(e){console.error(e),v.displayNotification({eventID:"error",msg:T.replace(T.get(T.error_CQFI),{parentItem:a.specModel.getTitle()})})}),t.allSettled(n).then(function(e){let t={},i={};a.canTriggerCellEvents=!1,e.forEach((e,a)=>{let r=e.value;if(r)if(0===a)for(const[e,t]of r.entries()){let a=t.physicalid,r=t.V_Name?t.V_Name:"",n=t.revision?t.revision:"-",s=i[e];s||(s={},i[e]=s),s.coreMaterial=r+" "+n,s.coreMaterialId=a}else if(1===a)for(const a in e.value.AlternateItemInfo){let e=t[a];e||(e={},t[a]=e),e.Alternate="Yes",e["ds6w:alternate"]=T.label_yes}}),r.forEach(e=>{let a=e.getAttributeValue("physicalId"),r=i[a]||{},n=t[a]||{},s={};s.coreMaterial=r.coreMaterial||"",s.coreMaterialId=r.coreMaterialId||"",s.Alternate=n.Alternate||"",s["ds6w:alternate"]=n.Alternate||"",e.updateOptions({grid:s}),e.acceptChanges()}),a.canTriggerCellEvents=!0}).catch(function(e){throw e})}},mergeDataAndRelData:function(e,t){const a=new Map(e.map(e=>[e.value.resourceid,e]));return t.reduce((e,t)=>{const i=a.get(t.child.id);if(i){const{child:e,...a}=t,{instanceType:r,...n}=a;i.value={...i.value,...n,instanceType:r.dbName}}return e},e)},updateSameNodes:function(e,t,a){let i=this,r=e.currentPath.split("/").slice(-3).join("/"),n=e._id;i.formulatedBOMGrid.getTreeDocument().processDescendants({onlyVisibleNodes:!0,processNode:function(){let e=this.currentPath.split("/").slice(-3).join("/");n!==this._id&&r===e&&(i.canTriggerCellEvents=!1,this.updateOptions({grid:t}),a&&this.settargetQuantityBaseValue(a),this.acceptChanges(),i.canTriggerCellEvents=!0)}})},evt_GridCellValueUpdateFormulaBOM:function(e){let t=this;var a=e.nodeModel,i=e.newValue,r=e.oldValue;let n={};const{minPercent:d,maxPercent:c,lossPercent:m,targetPercent:p,minQuantity:h,maxQuantity:g,targetQuantity:f,unitNLS:M,unit:y,isQS:b,isWeightEnabled:E}=a.options.grid;var O=y,N=e.nodeModel.getID();u.maskLoader(t.container,T.UpdatingLoader);var S=function(e,a){"success"===e&&t.modelEvents.publish({event:s.EVENT_XSR_HIDE_TOOLBAR_COMMAND+"-"+s.FORMULABOM_TAB}),v.displayNotification({eventID:e,msg:a}),u.unmaskLoader(t.container)},_=function(i,r,n){t.formulatedBOMGrid.unselectAll(),e.nodeModel.select(),t.service.updateAndSyncAttributes(N,[{attribute:i,value:r}],e.nodeModel,n,!!e.dataIndex.startsWith("formulatedbom")).then(function(){t.syncInstanceModels(a),S("success",T.Notify_Updated),t.updateFetchMode()}).catch(function(e){S("error",T.Failure_Update)})};if(e.dataIndex.startsWith("formulatedbom")){var C=l.getInstanceCustomAttributesData(),I=e.dataIndex.split("formulatedbom")[1],B=e.newValue.toString();C&&C.includes(I)?_(I,B,"rel"):_(I,B,"bus")}else switch(e.dataIndex){case"ds6w:description":_(I=s.ITEM_DESCRIPTION,B=i,"bus");break;case"tree":var P=s.ITEM_V_NAME;i?_(P,i,"bus"):S("error",T.Error_EmptyTitle);break;case"targetPercent":let l=parseFloat(i);if(isNaN(l)||l<0||l>100){t.syncNodePostUpdate(e,r,"targetPercent"),S("error",T.replace(T.get(T.UpdateErr),{columnName:T.Target})),u.unmaskLoader(t.container);break}if(a.options.grid.minPercent&&parseFloat(a.options.grid.minPercent)>l||a.options.grid.maxPercent&&l>parseFloat(a.options.grid.maxPercent)){t.syncNodePostUpdate(e,r,"targetPercent"),S("error",T.targetPer_UpdateErr),u.unmaskLoader(t.container);break}n={minPercent:d,maxPercent:c,lossPercent:m,isQS:b,targetPercent:i},t.service.updateFormulatedProduct(n,a).then(function(){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),t.updateSameNodes(a,n),S("success",T.Notify_Updated),t.updateTotalTarget()}).catch(function(e){S("error",T.Failure_Update)});break;case"minPercent":let M=parseFloat(i);if(isNaN(M)||M<0||M>100){t.syncNodePostUpdate(e,r,"minPercent"),S("error",T.replace(T.get(T.UpdateErr),{columnName:T.Min})),u.unmaskLoader(t.container);break}if(a.options.grid.targetPercent&&M>parseFloat(a.options.grid.targetPercent)||a.options.grid.maxPercent&&M>parseFloat(a.options.grid.maxPercent)){t.syncNodePostUpdate(e,r,"minPercent"),S("error",T.minPer_UpdateErr),u.unmaskLoader(t.container);break}n={targetPercent:p,maxPercent:c,lossPercent:m,isQS:b,minPercent:i},t.service.updateFormulatedProduct(n,a).then(function(){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),t.updateSameNodes(a,n),S("success",T.Notify_Updated)}).catch(function(e){S("error",T.Failure_Update)});break;case"maxPercent":let y=parseFloat(i);if(isNaN(y)||y<0||y>100){t.syncNodePostUpdate(e,r,"maxPercent"),S("error",T.replace(T.get(T.UpdateErr),{columnName:T.Max})),u.unmaskLoader(t.container);break}if(a.options.grid.targetPercent&&parseFloat(a.options.grid.targetPercent)>y||a.options.grid.minPercent&&y<parseFloat(a.options.grid.minPercent)){t.syncNodePostUpdate(e,r,"maxPercent"),S("error",T.maxPer_UpdateErr),u.unmaskLoader(t.container);break}n={targetPercent:p,minPercent:d,lossPercent:m,isQS:b,maxPercent:i},t.service.updateFormulatedProduct(n,a).then(function(){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),t.updateSameNodes(a,n),S("success",T.Notify_Updated)}).catch(function(e){S("error",T.Failure_Update)});break;case"lossPercent":let v=parseFloat(i);if(isNaN(v)||v<0){t.syncNodePostUpdate(e,r,"lossPercent"),S("error",T.lossUpdateErr),u.unmaskLoader(t.container);break}n=a.isWeightUnitExist?{minQuantity:h,maxQuantity:g,targetQuantity:f,isQS:b,quantityUOM:O,lossPercent:i,isWeightEnabled:!0}:{minPercent:d,maxPercent:c,targetPercent:p,isQS:b,lossPercent:i},t.service.updateFormulatedProduct(n,a).then(function(){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),t.updateSameNodes(a,n),S("success",T.Notify_Updated)}).catch(function(e){S("error",T.Failure_Update)});break;case"isQS":n=a.isWeightUnitExist?{minQuantity:h,maxQuantity:g,targetQuantity:f,quantityUOM:O,lossPercent:m,isQS:i,isWeightEnabled:!0}:{minPercent:d,maxPercent:c,targetPercent:p,lossPercent:m,isQS:i},t.service.updateFormulatedProduct(n,a).then(function(){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),t.updateSameNodes(a,n),S("success",T.Notify_Updated)}).catch(function(e){S("error",T.Failure_Update)});break;case"targetQuantity":let E=parseFloat(i);if(isNaN(E)||E<0){t.syncNodePostUpdate(e,r,"targetQuantity"),S("error",T.replace(T.get(T.UpdateErrFU),{columnName:T.Target})),u.unmaskLoader(t.container);break}if(a.options.grid.minQuantity&&parseFloat(a.options.grid.minQuantity)>E||a.options.grid.maxQuantity&&E>parseFloat(a.options.grid.maxQuantity)){t.syncNodePostUpdate(e,r,"targetQuantity"),S("error",T.targetPer_UpdateErr),u.unmaskLoader(t.container);break}n={minQuantity:h,maxQuantity:g,quantityUOM:O,lossPercent:m,isQS:b,targetQuantity:i,isWeightEnabled:!0},t.service.updateFormulatedProduct(n,a).then(function(e){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),S("success",T.Notify_Updated),t.selectedGridNodes[0].settargetQuantityBaseValue(e.result.targetQuantityBaseValue),t.updateSameNodes(a,n,e.result.targetQuantityBaseValue),t.updateTotalTarget()}).catch(function(e){S("error",T.Failure_Update)});break;case"minQuantity":let N=parseFloat(i);if(isNaN(N)||N<0){t.syncNodePostUpdate(e,r,"minQuantity"),S("error",T.replace(T.get(T.UpdateErrFU),{columnName:T.Min})),u.unmaskLoader(t.container);break}if(a.options.grid.targetQuantity&&N>parseFloat(a.options.grid.targetQuantity)||a.options.grid.maxQuantity&&N>parseFloat(a.options.grid.maxQuantity)){t.syncNodePostUpdate(e,r,"minQuantity"),S("error",T.minPer_UpdateErr),u.unmaskLoader(t.container);break}n={maxQuantity:g,targetQuantity:f,quantityUOM:O,lossPercent:m,isQS:b,minQuantity:i,isWeightEnabled:!0},t.service.updateFormulatedProduct(n,a).then(function(){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),t.updateSameNodes(a,n),S("success",T.Notify_Updated)}).catch(function(e){S("error",T.Failure_Update)});break;case"maxQuantity":let C=parseFloat(i);if(isNaN(C)||C<0){t.syncNodePostUpdate(e,r,"maxQuantity"),S("error",T.replace(T.get(T.UpdateErrFU),{columnName:T.Max})),u.unmaskLoader(t.container);break}if(a.options.grid.targetQuantity&&parseFloat(a.options.grid.targetQuantity)>C||a.options.grid.minQuantity&&C<parseFloat(a.options.grid.minQuantity)){t.syncNodePostUpdate(e,r,"maxQuantity"),S("error",T.maxPer_UpdateErr),u.unmaskLoader(t.container);break}n={minQuantity:h,targetQuantity:f,quantityUOM:O,lossPercent:m,isQS:b,maxQuantity:i,isWeightEnabled:!0},t.service.updateFormulatedProduct(n,a).then(function(){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),t.updateSameNodes(a,n),S("success",T.Notify_Updated)}).catch(function(e){S("error",T.Failure_Update)});break;case"unitNLS":if(r){var A=Object.entries(o.getUOMUnits("Mass"));if(A){var U=new Map;A.forEach(function(e){U.set(e[1],e[0])})}n={minQuantity:h,targetQuantity:f,maxQuantity:g,lossPercent:m,isQS:b,quantityUOM:U.get(i),isWeightEnabled:!0},t.service.updateFormulatedProduct(n,a).then(function(e){t.updateFetchMode(),t.formulatedBOMGrid.getTreeDocument().acceptChanges(),S("success",T.Notify_Updated),t.selectedGridNodes[0].settargetQuantityBaseValue(e.result.targetQuantityBaseValue),t.updateSameNodes(a,n,e.result.targetQuantityBaseValue),t.updateTotalTarget()}).catch(function(e){console.error(e),S("error",T.Failure_Update)})}default:u.unmaskLoader(t.container)}},evt_GridToolbarActionClickFormulaBOM:function(e){let t=this;var a=t.formulatedBOMGrid.getTreeDocument().getSelectedNodes();if(a&&0===a.length?t.isRootAdded=!0:t.isRootAdded=!1,e)switch(e){case"add":t.currentCommand=e,t._launchSearch();break;case"removeitem":t._removeOrDeleteNodes("remove");break;case"deleteItem":t._removeOrDeleteNodes("delete");break;case"Export":t._exportGrid();break;case"personalize":t._personalize();break;case"reorder":let i=t.isRootAdded?t.specModel:a;this.currentCommand=e,t.reorderTree(i);break;case"expandall":"index"===widget.getValue("fetchmode")?t.progressiveExpand():t.bomExpandTree(-1);break;case"expandNLevel":t.bomExpandTreeInput();break;case"collapseall":t.bomCollapseAll()}},evt_LanchPrevNextCommand:function(e){var t=e.move,a=e.itemId,i=this.formulatedBOMGrid.getTreeDocument().getSelectedNodes();if(i&&!i||!(i.length<=0||i.length>1)?(i=Array.isArray(i)?i[0]:i)&&i.getID()!==a&&(i=(new n).getModelById(a,this.formulatedBOMGrid)):i=(new n).getModelById(a,this.formulatedBOMGrid),i&&i.getID()===a){var r=l.getValidPreviousorNextNode(i,t);r&&(this.formulatedBOMGrid.unselectAll(),this.gridViewInstance=this.formulatedBOMGrid.getGridViewInstance(),this.gridViewInstance&&this.gridViewInstance.ensureNodeModelVisible(r),r.select())}},_removeOrDeleteNodes:function(e){var t=this.formulatedBOMGrid.getTreeDocument().getSelectedNodes();if(t&&t.length>0)"remove"===e?y.launchUPSUnparent({data:t}):"delete"===e&&y.deleteItem({data:t});else{var a="";"delete"===e?a=T.actionErrMsgDelete:"remove"===e&&(a=T.actionErrMsgRemove),v.displayNotification({eventID:"error",msg:T.NoItemSelected+a})}},_removeNodes:function(e){if(this.updateFetchMode(),!Array.isArray(e)){if(0===this.formulatedBOMGrid.getTreeDocument().getSelectedNodes().filter(t=>t.getID()===e.getID()).length)return}let t=(e=Array.isArray(e)?e:[e]).reduce((e,t)=>(e.add(t.currentPath.split("/").slice(-3).join("/")),e),new Set),a=e.reduce((e,t)=>(e.add(t._id),e),new Set);this.formulatedBOMGrid.getTreeDocument().processDescendants({onlyVisibleNodes:!0,processNode:function(){let i=this.currentPath.split("/").slice(-3).join("/");!a.has(this._id)&&t.has(i)&&e.push(this)}}),this.formulatedBOMGrid.removeRootNodes(e)},_launchSearch:async function(){const e=await m._getSearchCriteria(this.appCore.immersiveFrame,this.appCore.immersiveFrame.elements.container.querySelector("div.multigrid-formulatedbom-container div.enox-collection-toolbar-actions span.fonticon-plus"));var t={};t.appCore=this.appCore,t.currentTabKey=this.currentTabKey,t.container=this.container,t.formulatedBOMGrid=this.formulatedBOMGrid;let a=this.formulatedBOMGrid.getTreeDocument().getSelectedNodes();if(0==a.length)a.push(this.specModel);else{a[0].getState();let e=[];e.push(this.service.expand([a[0].getAttributeValue("id")],"1")),e.push(this.itemservice.getRefBatchSize(a[0].getAttributeValue("id"))),t.promises=e}t.specModel=a[0],t.modelEvents=this.modelEvents;new f(t).launchAddInstance(e)},_exportGrid:function(){var e=this.itemTitle+"_"+this.itemMaturity+"_"+T.tab_formulatedbom;this.formulatedBOMGrid.exportGrid(e)},_personalize:function(){this.formulatedBOMGrid.personalize()},reorderTree:function(e){this.formulatedBOMGrid.model.setUseChangeTransactionMode(!1),this.isReorderTriggered=!0,y.launchUPSAuthReorderProduct({data:e})},openDialog:function(){let e=this;var t={position:{at:"center",my:"center"}};t.Title=e.specModel.getTitle()+" | "+T.label_referenceBatchSize,t.width=350,t.height=90,t.renderTo=e.target,t.RemoveApplyButton=!1,t.OKLabel=T.label_OK,t.CancelLabel=T.label_Cancel,t.refDimension=e.specModel.getRefDimension(),t.refQuantity=parseFloat(e.specModel.getRefQuantity()),t.refUnit=e.specModel.getUnitNLSLabel(),e.FormulaDialog=new b(t),e.FormulaDialog.render(),e.FormulaDialog.listenTo(e.FormulaDialog,"EVENT_CLICK_FORMULADIALOG_CANCEL",()=>{}),e.FormulaDialog.listenTo(e.FormulaDialog,"EVENT_CLICK_FORMULADIALOG_OK",function(t){const{quantity:a,unit:i,dimension:r,displayUnit:n}=t;if(B.value!==t.quantity+" "+t.displayUnit){e.specModel.setRefDimension(r),e.specModel.setRefUnit(i),e.specModel.setRefQuantity(a),e.specModel.setUnitNLSLabel(n);let t={objectID:e.itemId,batchSize:a+" "+i,batchDimension:r};e.service.updateRefBatchSize(t).then(function(){B.value=a+" "+n,v.displayNotification({eventID:"success",msg:T.Notify_Updated}),e.basicModelEvents.publish({event:s.EVENT_INFORMATION_PANEL_REFRESH})}).catch(function(e){v.displayNotification({eventID:"error",msg:T.Failure_Update})})}})},getNLSLabels:function(e){var t=e;if(t){var a=function(e){for(var t=0;t<e.length;t++)e[t].text=e[t].text&&T[e[t].text]?T[e[t].text]:e[t].text,e[t].children?a(e[t].children):e[t].subMenu&&a(e[t].subMenu)};a(t)}return t},syncNodePostUpdate:function(e,t,a){e.nodeModel.options.grid[a]=t,this.formulatedBOMGrid.unselectAll(),e.nodeModel.select(),e.nodeModel.acceptChanges()},updateFetchMode:function(){this.modelEvents.publish({event:"xsr-toolbar-switch-fetch-mode-to-author"})},updateTotalTarget:function(){let e=this;if(this.isWeightUnitEnabled()){let t=e.formulatedBOMGrid.getTreeDocument().getOriginalGridRoots().reduce((e,t)=>(Object.keys(e).length>0?e.sameUnits&&e.units==t.options.grid.unitNLS?(e.targetQuantity.push(t.options.grid.targetQuantity),e.targetQuantityBaseValue.push(t.options.grid.targetQuantityBaseValue),e.units=t.options.grid.unitNLS,e.sameUnits=!0):(e.targetQuantityBaseValue.push(t.options.grid.targetQuantityBaseValue),e.targetQuantity=e.targetQuantityBaseValue,e.units=T.Mass_SI_Unit,e.sameUnits=!1):(e.targetQuantity=[],e.targetQuantity.push(t.options.grid.targetQuantity),e.targetQuantityBaseValue=[],e.targetQuantityBaseValue.push(t.options.grid.targetQuantityBaseValue),e.units=t.options.grid.unitNLS,e.sameUnits=!0),e),{});if(Object.keys(t).length>0){let a={};a.quantities=t.targetQuantity,e.service.getTotalTargetQuantity(a,this.specModel).then(function(e){let a=e.result.totalTargetQuantity;P.value=a+" "+t.units,P.emphasize="primary"}).catch(function(e){console.error(e)})}else P.value=T.Default_Total_TargetQty,P.emphasize="primary"}else{let t=e.formulatedBOMGrid.getTreeDocument().getOriginalGridRoots().reduce((e,t)=>(e.push(t.options.grid.targetPercent),e),[]);if(t.length>0){let a={};a.quantities=t,e.service.getTotalTargetQuantity(a,this.specModel).then(function(e){let t=e.result.totalTargetQuantity;P.value=t,P.emphasize=100===parseFloat(t)?"success":"warning"}).catch(function(e){console.error(e)})}else P.value=0}},isWeightUnitEnabled:function(){if(l.isFormulaUnitsEnabled()){if(!this.specModel.options.childBOMConnection||this.specModel.options.childBOMConnection&&this.specModel.isUnitsPresent())return!0;if(this.specModel.options.childBOMConnection&&!this.specModel.isUnitsPresent())return!1}else{if(!this.specModel.options.childBOMConnection||this.specModel.options.childBOMConnection&&!this.specModel.isUnitsPresent())return!1;if(this.specModel.options.childBOMConnection&&this.specModel.isUnitsPresent())return!0}},destroy:function(){this._formulatedBOMContainer.destroy(),this.formulatedBOMGrid.destroy(),this._formulaBOMSubscriptionList&&this.modelEvents.unsubscribeList(this._formulaBOMSubscriptionList),this.FBOMPlatFormSubscription&&i.unsubscribe(this.FBOMPlatFormSubscription)}})});