define("DS/ENOXTaggerOnIndexComponent/ENOXTaggerOnIndexComponent",["UWA/Core","DS/TagNavigatorProxy/TagNavigatorProxy","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/SearchDictionaryAccess/SearchDictionaryAccessAPI"],function(e,t,n,i,r,o){"use strict";let l={},a={},s={},c={},f={},u="",d={};function g(e){let t=new Date,n="";return e&&("string"==typeof e&&(e=(e=(e=e.replace(/\&#x2f;/g,"/")).replace(/\&#x3a;/g,":")).replace(/\u200E/g,"")),n=(t=new Date(e)).getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()),n}function h(n,o,c,h,p,y){let b="",x="",j=o.idDataIndex?o.idDataIndex:"physicalid";if(o.queryWithResourceId)b=p;else if(p&&Array.isArray(p)&&p.length==c.length)for(let e=0;e<c.length;e++)e>0&&(b+=" OR "),b+=p[e];else{b+=j+":(";for(let e=0;e<c.length;e++)e>0&&(b+=" OR "),b+='"'+c[e]+'"';b+=")"}let O=widget.getUrl()+"-"+r.getUser().login+"-"+Date.now();if("function"===e.typeOf(o.onTagFilterChange)&&(l[n]||(l[n]=t.createProxy({id:n,widgetId:widget.id,filteringMode:"FilteringOnServer",colorize:!!o.colorize&&o.colorize,MyFriends:o.MyFriends,tenant:widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",exclude:!0,simplified:{editTagsRelationships:!0,person_data:!0,data_location:!0,type_categorization:!0}}),UWA.is(o.onSetTagProxy,"function")&&o.onSetTagProxy(),a[n]={}),l[n].addEvent("onFilterChange",function(){a[n].then,a[n].then(()=>{try{const{filterOptions:e,currentFilter:t}=m.getFiltedSubjects(n);o.onTagFilterChange(e)}catch(e){console.error(e)}}).catch(e=>{console.error(e)})}),o.colorize&&!0===o.colorize&&(l[n].addEvent("colorize",o.onTagColor),l[n].addEvent("unColorize",o.onTagUncolor))),f[n]||(f[n]={subjectPrefix:o.subjectPrefix||""}),0==c.length)return void(l[n]&&(s[n]={},m.publishTags(n,[])));x={query:b,order_by:"asc",order_field:"ds6w:modified",label:O,locale:null!=widget&&null!=widget.lang?widget.lang:"en",nresults:c.length,start:0,tenant:widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",with_synthesis:!0,select_predicate:["ds6w:created"]},o.queryWithResourceId&&(o.resourceid_in?x.resourceid_in=c:o.resourceid_not_in&&(x.resourceid_not_in=c)),o.searchOptions&&o.searchOptions.source&&(x.source=o.searchOptions.source);let P=widget.getValue("x3dPlatformId");u=d[P]?d[P]["3DSearch"]+"/search":"",i.authenticatedRequest(u,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",type:"json",proxy:"passport",data:JSON.stringify(x),onComplete:function(e){!function(e,t,n,i){let r=function(e){let t,n={},i=e.results,r="",o={},l=[];return i&&i.forEach(function(e){t=e.attributes,r="",o={},l=[];for(let e=0;e<t.length;e++)if("internal"==t[e].format)"resourceid"==t[e].name&&(r=t[e].value);else if("ds6w_facet"==t[e].format){if("explicit"===t[e].field&&t[e].sixw)continue;o={object:"date"==t[e].type?g(t[e].value):t[e].value,sixw:t[e].name,field:t[e].field,dispValue:"date"==t[e].type?"NONE_NEEDED":t[e].dispValue?t[e].dispValue:t[e].value,type:t[e].type},l.push(o)}n[r]=l}),n}(e);if(l[t]){let e=f[t].subjectPrefix||"",o=Object.keys(r);if(n.length!==o.length){console.log("dataIndexPIDs and serverTagList do not have the same length");let e=n.filter(function(e){return!o.includes(e)});e.forEach(function(e){r[e]={}})}s[t]||(s[t]={});for(let n in r)s[t][e+n]=r[n];if(i)for(let t in r){let n=i[t]||i[e+t];if(n)for(let e=0;e<n.length;e++)r[t].push(n[e])}s[t]||(s[t]={});for(let n in r)s[t][e+n]=r[n]}}(e,n,c,h),UWA.is(y,"function")&&y()},onFailure:function(e){console.log("Tagger service Error : "),console.log(e)}})}function p(e,t){let n=t[e];return n||e}n.getPlatformServices({onComplete:function(e){e.forEach(function(e){d[e.platformId]=e})},onFailure:function(){UWA.log("Error in i3DXCompassPlatformServices.getPlatformServices")}});let y="R2019x";function b(e){let t=function(e){let t={};const n=["3DSpace"];return e&&e.forEach(e=>{if(e.sixw&&"date"!==e.type){let i=e.sixw.lastIndexOf("/"),r=i>0?e.sixw.substring(i+1):e.sixw;e.nlsKey=r;let o=t[r];o||(o=t[r]=[]),Array.isArray(e.object)?e.object.forEach(e=>o.push({value:e,source:n})):o.push({value:e.object,source:n})}}),t}(e);return new Promise(n=>{o.getNlsOfSearchValuesBySource(t,{tenantId:widget?widget.getValue("x3dPlatformId"):"onPremise",lang:widget?widget.lang:"en",apiVersion:y,onComplete:function(t){!function(e,t){const n=Object.assign({},t);e.forEach(e=>{if(e.nlsKey){let i=Object.assign({},t[e.nlsKey]);if(i){Object.keys(i).forEach((e,n,r)=>{const o=i[e],l=r.filter(t=>i[t]===o&&t!==e);if(l.length>0){const n=e.split(".").shift();let r=t["ds6w:type"][n]?t["ds6w:type"][n]:n;i[e]=`${o} (${r})`,l.forEach(e=>{const t=e.split(".").shift();i[e]=`${o} (${t})`})}}),n[e.nlsKey]=i;let r=[];Array.isArray(e.object)?e.object.forEach(e=>{r.push(p(e,i))}):r=p(e.object,i),e.dispValue=r}}}),Object.assign(t,n)}(e,t),n()},onFailure:function(e){console.warn("IP Cannot retrieve NLS"),n()}})})}let m={getFiltedSubjects:function(e){let t=l[e].getCurrentFilter(),n=l[e].getCurrentFilter(),i=t.allfilters&&t.allfilters.condition?t.allfilters.condition:[],r={};n.allfilters.condition.forEach(e=>{Object.entries(e).forEach(([e,t])=>{r[e]=t.condition})}),n.allfilters=r;let o=[],a=[],c=[];t.allfilters.condition.forEach(e=>{for(const t in e){let n={property:t,operator:e[t].operator};c.push(n)}});const f=(t,n,i,r)=>t.filter(t=>{const o=s[e][t];if(!Array.isArray(o)||0===o.length)return!1;const l=o.map(e=>e.object);if(r)return n.every(e=>!l.includes(e));if("OR"===i)return n.some(e=>l.includes(e));if("AND"===i)return n.every(e=>l.includes(e));if("XOR"===i){return 1===n.filter(e=>l.includes(e)).length}return!1});if(0===i.length)s[e]&&(o=Object.keys(s[e]));else{const t=new Set(Object.values(r).flat().map(e=>e.object));o=Object.keys(s[e]).filter(n=>Array.isArray(s[e][n])&&s[e][n].some(e=>t.has(e.object)))}let u=[];if(o.length>0&&c.forEach(({property:t,operator:n})=>{if(r[t]){const i=r[t],l=i.filter(e=>e.hasOwnProperty("excluded")&&e.excluded);if(u=i.filter(e=>!e.hasOwnProperty("excluded")||!e.excluded),l.length>0){const t=l.map(e=>e.object);a=a.concat(f(Object.keys(s[e]),t,n,!1))}if(u.length>0){const e=u.map(e=>e.object);o=f(o,e,n,!1)}}}),o=o.filter(e=>!a.includes(e)),a.length>0&&0===u.length&&s[e]&&"object"==typeof s[e]){const t=Object.keys(s[e]).filter(t=>Array.isArray(s[e][t])&&s[e][t].length>0).filter(e=>!a.includes(e));o=t}let d={id:"taggerFilter",content:{ids:o,idPrefix:"pid://",xIDs:a}},g=n.allfilters?Object.keys(n.allfilters):[],h=n.localfilters?Object.keys(n.localfilters):[];return 0===g.length&&0===h.length&&(d.content.ids=Object.keys(s[e])||[]),{filterOptions:d,currentFilter:n}},setTagProxy:function(e,t,n,i,r){l||(l={});l[e]&&(l[e].unsetTags(),s[e]={}),this._callSetupProxy(e,t,n,i,r)},_callSetupProxy:function(e,t,n,i,r){let o=[];if(n.length>227){let e=Math.floor(n.length/227);for(let t=0;t<e;t++){let e=n.slice(227*t,227*(t+1));o.push(e)}if(n.length%227>0){let t=n.slice(227*e);o.push(t)}}else o.push(n);a[e]=new Promise((n,l)=>{!function l(a){o.length>a?h(e,t,o[a],i,r,function(){l(a+1)}):(m.createSummaryData(e,s[e]),n())}(0)})},getTagProxy:function(e){return l[e]?l[e]:null},publishTags:function(e,t){l[e]&&!0===l[e]._attributes.isAlive&&l[e].setTags(s[e],t)},filterTags:function(e,t,n){let i=l[e],r=[],o=f[e].subjectPrefix||"";if(i&&!0===i._attributes.isAlive&&s[e]){let n={};if(t&&t.length>0)for(let i=0;i<t.length;i++)s[e].hasOwnProperty(o+t[i])&&(n[o+t[i]]=s[e][o+t[i]]);m.createSummaryData(e,n)}n&&setTimeout(function(){r.forEach(e=>{i.addEvent("onFilterChange",e)})},200)},createSummaryData:function(e,t){let n=t?Object.values(t):[],i=n?n.flat():[],r={};i.forEach(e=>{let t=e.object+"|"+e.sixw;r[t]?r[t].count++:r[t]={...e,count:1}});let o=Object.values(r);b(o).then(()=>{c[e]=o,m.publishTags(e,o)})},focusOnSubjects:function(e,t){let n=f[e].subjectPrefix||"";if(l[e]&&!0===l[e]._attributes.isAlive&&s[e]){let i=[],r={};if(t&&t.length>0)for(let o=0;o<t.length;o++)if(s[e].hasOwnProperty(n+t[o])){let e=n+t[o];i.push(e),r[e]="3DSpace"}l[e].focusOnSubjects(i,!0,r)}},removeSubjects:function(e,t){try{t.forEach(t=>{delete s[e][f[e].subjectPrefix+t]})}catch(e){UWA.log(e)}},unfocus:function(e){l[e]&&l[e].unfocus()},setLocalFilter:function(e,t){if(UWA.is(t,"object")&&l[e]&&!0===l[e]._attributes.isAlive){let n=!0;l[e].setLocalFilter(t,n)}},killTagProxy:function(e){l[e]&&(l[e].deactivate(),l[e].unsetTags(),l[e].die(),l[e]=void 0,s[e]=void 0,delete l[e],delete s[e])},killAllTagProxy:function(){let e=this;Object.keys(l).forEach(function(t){e.killTagProxy(t)})},activate:function(e,t){let n=this;if(t&&t.deactivateOthers&&Object.keys(l).forEach(function(t){t&&t!==e&&n.deactivate(t)}),l[e]&&(l[e].activate(),!c[e]||c[e]&&0==c[e].length)){c[e];l[e].setTags([])}},deactivate:function(e){l[e]&&(l[e].deactivate(),l[e].unfocus())},deactivateAll:function(){let e=this;Object.keys(l).forEach(function(t){e.deactivate(t)})},unsetTags:function(e){l[e]&&l[e].unsetTags()}};return m});