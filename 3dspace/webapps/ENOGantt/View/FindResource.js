define("DS/ENOGantt/View/FindResource",["UWA/Class","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Data/ResourceStore","DS/ENOGantt/Data/ResponseUtil","DS/ENOGantt/URLStore","DS/ENOProjectMgmtCommonComponents/utils/ProjectMgmtCloneModel","DS/ENOProjectMgmtModels/Collections/Persons","DS/ENOProjectMgmtModels/Models/Person"],function(e,t,a,o,r,n,s,i){var d;try{d=e.extend({init:function(e){let t=UWA.clone(e||{},!1);that=this,that.viewCollection=t.viewCollection;new a({viewCollection:that.viewCollection});that.resourceStore=Ext.create("DS.ENOGantt.Data.ResourceStore",{storeId:"resourceStore"}),Ext.define("DS.ENOGantt.View.FindResource",{extend:"Ext.form.field.ComboBox",xtype:"dpmfindresourceview",store:that.resourceStore,displayField:"title",emptyText:App.Nls["emxProgramCentral.Gantt.ResourceUtilization.FindResource.PlaceholderText"],typeAhead:!1,minChars:3,hideLabel:!0,hideTrigger:!0,width:"100%",anchor:"100%",displayField:"Name",valueField:"UserName",queryCaching:!1,listeners:{beforequery:function(e){var t=e.query;if(t){return!/([\\\"\#\$\@\%\*\,\/\?\<\>\[\]\|\:\']+(\s[\\\"\#\$\@\%\*\,\?\\\\\<\>\[\]\|\:\']+)?)/.test(t)}return!1},select:function(e,t,a){that.assignResource(t),e.clearValue()}}})},assignResource:function(e){var t=this,a=Ext.ComponentQuery.query("#dpmprojectgantt")[0],d=Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0];d.setLoading(!1),d.setLoading(App.Nls["emxProgramCentral.Gantt.ResourceUtilization.Loading"]);var l=e.get("Id");if(a.resourceStore.getModelById(l))return Ext.Msg.alert(App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Header"],App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Body"].replace("{PERSON_NAME}",e.get("Name")),Ext.emptyFn),void combo.clearValue();var c=d.context,g=c.get("Id"),m=c.get("TaskProjectId"),u=a.taskStore.getModelById(m),p=u.get("StartDate").getTime(),S=u.get("EndDate").getTime();this.data={taskId:g,resourceId:l,taskProjectId:m,projectStart:p,projectEnd:S};let h=App.Infra.contextInfo,f=h.getAllTasks(),D=h.id===g?h:f.get(g),E=D.get("assignees")||new s,x=new i({id:l});E.add(x),D.set("assignees",E),UWA.extend(D._changed,{objectId:D.id});let T=r.getAssignResourceToTaskUrl();var v=function(e){let r,n=t.data.taskProjectId,s=t.data.projectStart,i=t.data.projectEnd,l=(t.data.taskId,t.data.resourceId),c=e.assignees;c&&c.forEach(e=>{e.id===l&&(r=e)});data.length;var g=[],m=[],u=[];if(r){if(r.FirstName=r.firstname,r.LastName=r.lastname,r.Name=r.name,delete r.firstname,delete r.lastname,delete r.name,r.calendar&&r.calendar.length>0){r.hasCalendar=!0;var p=r.calendar[0].id}var S=r.WorkTime;r.WorkTime=S?parseFloat(S)/60:parseFloat("8.0");var h=r.Id;if(""==p||null==p)p="Custom:"+h;r.CalendarId=p,g.push(r);var f=r.Assignments;if(f&&f.length>0)for(var D=f[0],E=(D.contextUser,1);E<f.length;E++){var x=f[E],T=x,v=x.relelements;o.convertToGanttKeyValues(T),o.convertToGanttKeyValues(v);var I=new Date(T.StartDate),k=new Date(T.EndDate),N=o.stdTimezoneOffset(I),y=I.getTimezoneOffset();if(I=I.getTime(),k=k.getTime(),N!==y&&(I+=60*(y-N)*1e3,k+=60*(y-N)*1e3),!(I<s||k>i)){var C={};C.TaskId=T.TaskId;var w=a.taskStore.getModelById(C.TaskId);C.isReadOnly=!1,w&&"TRUE"!=w.data.hasEditAccess&&(C.isReadOnly=!0);var A=x.type;if(D[A]&&(C.icon=D[A]),C.Id=v.Id,C.Units=v.allocation,C.ResourceId=h,T.TaskProjectId==n)C.Type="Internal";else{var R={};C.Type="External",R.Id=T.TaskId,R.Name=T.Name,R.PercentDone=T.PercentDone,R.Duration=T.Duration,T.StartDate&&(T.StartDate=Ext.Date.format(new Date(T.StartDate),"c")),T.EndDate&&(T.EndDate=Ext.Date.format(new Date(T.EndDate),"c")),R.StartDate=T.StartDate,R.EndDate=T.EndDate,R.expanded=!0,u.push(R)}m.push(C)}}}var P=a.taskStore.data.items[0],O=u.length;if(console.log("e3b extLenth : :"+O),console.time("looping through external Task"),O>0){App.Infra.doNotPropagate=!0;for(var M=0;M<O;M++){var j=u[M],U=j.Id;if(null==a.taskStore.getModelById(U)&&"root"!=j.Name){j.visible=!1,j.Id=U,j.Rollup=!1,j.ReadOnly=!0,j.ExternalTask=!0,j.expanded=!0;var G=Ext.create("DS.ENOGantt.Data.TaskModel",j);App.Infra.ExtTaskArray.push(G),P.addTaskBelow(G),P.nextSibling=""}}console.timeEnd("looping through external Task"),a.taskStore.commitChanges(),delete App.Infra.doNotPropagate}m.length;g.length>0&&a.taskStore.resourceStore.add(g),m.length>0&&a.taskStore.assignmentStore.add(m),a.taskStore.resourceStore.commitChanges(),a.taskStore.assignmentStore.commitChanges(),a.taskStore.commitChanges(),a.taskStore.filterBy(function(e){return!e.get("ExternalTask")}),d.setLoading(!1)};if(window.isODTRunning)"GET",dataObj="",Ext.Ajax.request({url:getAssignResourceToTaskUrl,async:!1,success:function(e){e=JSON.parse(e.responseText.trim()),v(e)}});else{let e=a.crudManager.viewCollection,t=new n(D);window.Widget||(donotShowMessage=!0),e.processSaveDataModel(t,{fields:T.fields,include:T.include,isNew:!1,donotShowMessage:donotShowMessage,doNotCache:!0,customParams:T.customParams,onComplete:function(e){v(JSON.parse(JSON.stringify(e)))}})}}})}catch(e){console.log("::::::::error")}return d});