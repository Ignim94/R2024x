define("DS/PLMNewFolderActive/PLMNewFolderActiveController",["DS/ClassificationsFacet/PLMNewCommomCmpUXController","DS/FolderActive/service/FolderActiveWebServices","i18n!DS/FolderActive/assets/nls/FolderActive","DS/WebappsUtils/WebappsUtils","DS/FolderActive/commands/FolderCommands","DS/FolderActive/service/FolderTypeService","DS/WidgetServices/WidgetServices","DS/ClassificationsFacet/service/PLMNewCommonWebService","DS/FolderEditor/service/FolderEditorWebService","UWA/Utils","DS/Controls/TooltipModel","i18n!DS/ClassificationsFacet/assets/nls/PLMNewCommCmpSel","DS/FolderActive/utils/PreferencesUtils","DS/IPClassifyUtil/IPClassifyAlert","DS/PlatformAPI/PlatformAPI","DS/IPClassifyUXUtil/service/IPClassifyUXUtilWebService","DS/IPClassifyUXUtil/IPClassifyConfirmation"],function(e,t,o,n,i,s,r,a,l,c,d,m,u,p,h,f,g){"use strict";n.getWebappsAssetUrl("FolderEditor","icons/I_Bookmark_v2.png");var v={iconName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-bookmark-flash "},C=n.getWebappsAssetUrl("FolderEditor","icons/folder_perso.png"),_={iconName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-bookmark "};let b=!1;return e.extend({name:"FolderActive",_rootNodeFavorite:null,_rootNodeFolders:null,_rootNodeTrash:null,_requestInfo:{},_searchKeys:{},_nodesData:{},_isResetInProgress:!1,_pathInfo:{},_subBookmarkExpand:{},_personalSectionNode:null,_favoriteSection:"FolderSection_favorite",_allSection:"FolderSection_AllFolders",_findInTreeNLS:o,_getActiveBookmarkPromise:null,_currentActiveBookmarkId:null,_classNameMap:new Map,_parentInitMethod:null,_parentOptions:null,init:function(e){let n;this.PLMNewCommonWebService=Object.assign({},a),this.PLMNewCommonWebService.getSetting=l.getWidgetSettings,this.PLMNewCommonWebService._executeRequest=f._executeRequest,this.PLMNewCommonWebService._executeQuery=f._executeQuery,this.PLMNewCommonWebService.getRelatedBookmarks=l.getRelatedBookmarks,this.PLMNewCommonWebService.removecontent=l.removecontent,this.PLMNewCommonWebService.getSetting(e.securityContext).then(function(e){n=e}),e.multiSelectionComponent&&!e.multiSelectionComponent.NLS&&(e.multiSelectionComponent.NLS=o.multiSelectionComponent),this.PLMNewCommonWebService.addcontent=t.addcontent,this.PLMNewCommonWebService.getSearchQuery=function(){return n&&n.personal?'flattenedtaxonomies:("types/Workspace" OR  "types/Workspace Vault" OR  "types/Personal Workspace")':'flattenedtaxonomies:("types/Workspace" OR  "types/Workspace Vault")'},this.PLMNewCommonWebService.getType_filter_bo=function(){return["Workspace","Workspace Vault"]},this._getActiveBookmarkPromise=this.getCurrentPreference(),this._parent(e),this._parentOptions=e,this._parentInitMethod=this._parent,this.plmNewContextProvider=e.securityContext},_getWebServiceRef:function(){return t},onSetActive:function(e){e&&"function"==typeof e&&(this.onSetActive=e)},_getPlmType:function(e){return-1===["Workspace","Workspace Vault","Bookmark","Bookmark Root"].indexOf(e)&&e?"Content":"Folder"},_getIcon:function(e,t){var o="subFolders"!==t&&!1,n=_;return e&&e.type&&s.isPersonalFolder(e.type)?o||!n?C:n:"favorites"===t?e.inherit?v:n:o||e.iconType&&"SHARED"===e.iconType.toUpperCase()?v:n},couldBeValid:function(e){var t=e&&e.getID&&e.getID();return t&&t!==this._favoriteSection&&t!==this._allSection},getInitIcon:function(e){return e.iconType=e.folderClassification,this._getIcon(e)},saveNodes:function(e){this._nodesData[e.id]=e},isResetInProgress:function(e){return this._isResetInProgress},isConfirmModel:function(e){return this._nodesData.accordianData=e,!0},removeContents:function(e){var t=this,o=[];let n=e.classId.length;e.accordianData=t._nodesData.accordianData;var i=t._nodesData;delete i.accordianData;for(let e in i)o.push(i[e]);var s={deleteButtonLabel:m.titleRemove,titleLabel:m.titleRemove,warningMessage:m.replace(m.msg_removeSingleBks,{className:t._nodesData[e.classId[0]].label})};n>1&&(s.warningMessage=m.replace(m.msg_removeMultipleBks,{number:n}),s.titleLabel=m.titleRemove+" - "+n+" "+m.bookmarks),g.confirmDialog(s,function(e){e.classId.forEach(o=>{var n=t._classNameMap.get(o);t.PLMNewCommonWebService.removecontent({pid:o,IDs:e.IDs,isLinkedFolder:!1,onComplete:function(e){"failure"==e.status?(p.displayNotification({title:m.replace(m.errorForRemoveContentFromBks,{number:1,bkname:n}),subtitle:e.error,className:"error"}),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})):(delete t._nodesData[o],p.displayNotification({message:m.replace(m.removeBookmarkedSuccess,{number:1,bkname:n}),className:"success"}))},onFailure:function(e){console.log("================",e),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})}})})},function(e){t._isResetInProgress=!0,t.autoComplete._model.prepareUpdate();var o=t.autoComplete._model.getChildren().length;for(let e=0;e<o;e++)t.autoComplete._model.prepareUpdate(),t.autoComplete._model.nodeModel_reset=!0,t.autoComplete._model.removeRoot(0),t.autoComplete._model.pushUpdate(),t.autoComplete._model.nodeModel_reset=!1;t.autoComplete._model.nodeModel_reset=!0,t.autoComplete.selectedItems=[],t.autoComplete._model.nodeModel_reset=!1,t.previousPresentIds=[],e.forEach(e=>{t.autoComplete._model.prepareUpdate(),t.insertInAutocomplete(t._getAutocomplete(),e),t.autoComplete._model.pushUpdate();var o=t.autoComplete._model.getChildren().length;o>0&&t.autoComplete._model.getNthRoot(o-1).select()}),t._isResetInProgress=!1},e,o)},addContents:function(e){var t=this;e.classId.forEach(o=>{var n=this._classNameMap.get(o);l.addcontent({pid:o,IDs:e.IDs,isLinkedFolder:!1}).then(e=>{"failure"==e.status?(p.displayNotification({title:m.replace(m.errorForAddContentsToBks,{number:1,bkname:n}),subtitle:e.error,className:"error"}),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})):p.displayNotification({message:m.replace(m.bookmarkedSuccess,{number:1,bkname:n}),className:"success"})}).catch(()=>{console.log("error while adding content"),t._isProcessing=!1,t._parentInitMethod({...t._parentOptions,isRefreshContainer:!0})})})},fetchInitNodeProperties(e,t){a.fetch2({ids:e.id,label:"plmNewBk"+Date.now(),onComplete:function(e){if(e){let n={};if(e.results&&e.results.length>0){let i={};e.results[0].attributes.forEach(e=>{i[e.name]=e.value}),i["icon_2ddefaultthb.subtype"]&&"SHARED"===i["icon_2ddefaultthb.subtype"].toUpperCase()&&(n.icons=[{iconName:"bookmark-flash",fontIconFamily:1}]),n.tooltip=new d({title:i.label,shortHelp:i.label,mouseRelativePosition:!0}),n.label=i.label;var o=t.getChildren().length;let s=t.getNthRoot(o-1);s.select(),s.updateOptions(n),s.isSelected()&&(t.removeRoot(s),t.addRoot(s),s.select())}}},onFailure:function(e){console.error(e)}})},getAdditionalNodesAtInit:async function(e,t,o){let n=this;return new Promise((i,s)=>{t?this.addExistingChips(o).then(e=>{if(e.folders){let t=[];e.folders.length>0&&(e.folders.forEach((e,o)=>{t.push(e.id),n._classNameMap.set(e.id,e.label)}),n.PLMNewCommonWebService.getClassPaths({id:t,plmNewContextProvider:n.plmNewContextProvider,onComplete:function(t){const o=n.PLMNewCommonWebService.constructPath(t,"idPathMap");n._classPathMap=o,i(e.folders)},onFailure:function(e){console.log("================",e)}}))}}):null!=this._getActiveBookmarkPromise&&this._getActiveBookmarkPromise.then(t=>{t&&""!=t.id&&(this._currentActiveBookmarkId=t.id,t.icons=this._getIcon(t),t.label=t.label?t.label:m.loading,t.isActiveNode=!0,t.plmType="Folder",i([t]),this.fetchInitNodeProperties(t,e))})}).catch(e=>{console.log(e)})},couldBeSelected:function(e){return!!["Folder","Workspace","Bookmark","Bookmark Root","Workspace Vault","RootFolder"].includes(e)},getFavoriteKey:function(){return"FolderEditorFavoriteFolderList"},_getComponentName:function(){return o.bookmark_defaultTitle},_autoCompleteName:function(){return"Folder"},_getAutocomplete:function(e){return this.autocompleteFolder},getCurrentPreference:function(){return new Promise(function(e,t){var o=u.getCurrentWidgetBookmark(),n=u.getWidgetPreference();o.then(o=>{o&&o.FolderID&&(n={id:o.FolderID,label:o.FolderLabel}),n?e(n):u.getUserPreferences().then(t=>{e(t.startsWith("!")?null:{id:t})}).catch(t)})})},_autocompleteComponent:function(e){return this.autocompleteFolder=this.createAutocompleteComponent(this._getComponentName(),[],e,this.browseAssociations.bind(this,!0,!0)),this.autocompleteFolder},addExistingChips:function(e){let t={};return t.contentId=e,this.PLMNewCommonWebService.getRelatedBookmarks(t)},onClickSelector:function(){var e=this;widget&&widget.addEvent("onLoad",function(e){b=!1}),require(["DS/FolderActive/FolderActive"],function(n){b||(e.folderActiveActionBar=new n({multiSelectionComponent:{withClassify:!0,launchDialog:!0,componentTitle:o.multiSelectionComponent.PLMNewBookmarkWidgetName,OKButtonLabel:o.multiSelectionComponent.button_OK,immersiveFrame:null},popOverDialogProperties:{width:250,height:350,minHeight:250,modalFlag:!0,minWidth:400,icon:"none"},dialogButtons:!0,selectionMode:"DefaultSingle",favoriteButton:!0,handleClassification:!0,OKButtonLabel:o.multiSelectionComponent.button_OK,componentTitle:o.multiSelectionComponent.PLMNewBookmarkWidgetName,isRootSelectable:!0,isClassifyMultiEveDispatch:!0,isonSetActiveEveDispatch:!1,container:widget.body,widgetName:o.multiSelectionComponent.PLMNewBookmarkWidgetName}),e.folderActiveActionBar.nestedMenuInContext.addEvent("onClassifyMultiple",function(o){var n=o.nodeData,i=[];e.autoComplete.selectedItems&&e.autoComplete.selectedItems.length?e.autoComplete.selectedItems.forEach(e=>{i.push(e.id)}):i=[];var s=[];let r=[],a=new Map;n.forEach(e=>{a.set(e.id,e.getLabel())}),t.checkConnectAccess({IDs:[...a.keys()],securityContext:e.plmNewContextProvider}).then(({noAccessData:t,accessData:l})=>{Object.keys(t).length&&(Object.keys(t).forEach(e=>{r.push(a.get(e))}),p.displayNotification({title:m.replace(m.errorForConnectAccessforBks,{number:Object.keys(t).length}),message:r.join(", "),className:"error"})),Object.keys(l).length&&(n.forEach(function(e){!i.includes(e.getID())&&l[e.getID()]&&s.push(e.getID()),e.updateOptions({label:e.options.label,subLabel:m.loading,icon:[e.options.icons]}),b=!1}),s.length&&e.PLMNewCommonWebService.getClassPaths({id:s,plmNewContextProvider:e.plmNewContextProvider,onComplete:function(t){const o=e.PLMNewCommonWebService.constructPath(t,"idPathMap");console.log(o),n.forEach(t=>{if(o.has(t.id)){t.updateOptions({tooltip:new d({title:t.options.label,shortHelp:o.get(t.id),mouseRelativePosition:!0}),value:{subLabel:o.get(t.id)}}),e._classNameMap.set(t.id,t.options.label),e.autoComplete._model.prepareUpdate(),e.insertInAutocomplete(e._getAutocomplete(),t),e.autoComplete._model.pushUpdate();var n=e.autoComplete._model.getChildren().length;e.autoComplete._model.getNthRoot(n-1).select()}})},onFailure:function(e){console.error(e)}})),o.handleUI()}).catch(e=>{p.displayNotification({message:e.serverErr?e.serverErr.error:e.err,className:"error"}),o.handleUI()})}),e.folderActiveActionBar.nestedMenuInContext.addEvent("onSelectorCancel",function(e){b=!1}),b=!0)})},saveRespectiveAssociations:function(e,t,o){let n=this;return new Promise(function(i,s){const r=[];t.forEach(t=>{r.push(new Promise(function(i,s){l.addcontent({pid:t,IDs:[e],plmNewContextProvider:o}).then(o=>{if(o&&"failure"==o.status)i("fail"+t);else{if(n._currentActiveBookmarkId===t){const o={authored:{connected:[[t,e]]}};h.publish("FolderEditor.refresh",o)}i(t)}}).catch(()=>{i("fail"+t)})}))}),Promise.allSettled(r).then(function(e){i(e)})})},setClassNameForSearchData:function(e){e.results.forEach(e=>{const t=e.attributes.find(e=>"physicalid"===e.name),o=e.attributes.find(e=>"ds6w:label"===e.name);o&&this._classNameMap.set(t.value,o.value)})}})});