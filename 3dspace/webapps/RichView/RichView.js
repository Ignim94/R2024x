/*! -- Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/RichView/RichContentEditor",["UWA/Core","UWA/Class","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/CKEditor/CKEditor","DS/Logger/Logger","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/views/TRMFloatingPanel","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/TraceableRequirementsUtils/utils/RequirementErrorManager","DS/RichEditor/RichEditor","DS/PADUtils/PADContext","DS/DocumentManagement/DocumentManagement","i18n!DS/RichView/assets/nls/RichView","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","UWA/Class/Promise","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,s,a,l,c,d,u,h,p,g,m,f,v,b,_,y){"use strict";document.documentMode;var R="../../VENREQPlugins/External/ckeditor",C=new g;String.prototype.isEmpty=function(){return 0===this.length||!this.trim()};var E=t.extend(i,n,o,{defaultOptions:{mediator:null,selector:".rich-object",target:".content-data",container:".content-panel",inlineEditing:!0,saveOnBlur:!0,commandProxy:null,richView:null,events:null},_logger:null,init:function(e){var t=this;return this._logger=s.getLogger(E),this._logger.log("init"),UWA.merge(e||{},this.defaultOptions),this.options=e,this.mediator=e.mediator,this._init(),this.keepEditing=!1,!1===widget.hasEvent("onDragOverFiles")&&".rich-object"===this.options.selector&&widget.addEvent("onDragOverFiles",function(e){t.handleFiles(e)}),this},_init:function(){this._logger.log("_init");for(var e in this._customConfig=R+"/config.js",this._toolbar="Rich",this._plugins={sharedspace:R+"/plugins/sharedspace/",colorbutton:R+"/plugins/colorbutton/",panelbutton:R+"/plugins/panelbutton/",quicktable:R+"/plugins/quicktable/",base64image:R+"/plugins/base64image/",selectall:R+"/plugins/selectall/",tableresize:R+"/plugins/tableresize/",mathjax:R+"/plugins/mathjax/",lineutils:R+"/plugins/lineutils/",widget:R+"/plugins/widget/"},this._extraPlugins="",this._plugins)this._extraPlugins+=e+",";this._extraPlugins=this._extraPlugins.slice(0,-1),".rich-container"!==this.options.selector&&".rich-object-title-editable"!==this.options.target||(this._toolbar="Container",this._extraPlugins="selectall",this._customConfig=R+"/config_rich_container.js"),this.editor=null,this.selector=this.options.selector,CKEDITOR.disableAutoInline=!this.options.inlineEditing,CKEDITOR.plugins.addExternal("rcowidget","../../VENREQPlugins/External/ckeditor/plugins/rcowidget/","plugin.js"),CKEDITOR.plugins.addExternal("footnotes","../../REQFootnotes/1.2.0/footnotes/","plugin.js"),this.updateCKEditorSpellCheckSetting(),this._extraPlugins+=",rcowidget,footnotes",CKEDITOR.dtd.$editable.span=1,CKEDITOR.footnotesNls=v.footnotesNls,this.isEditing=!1,this._padCommandProxy=this.options.commandProxy,this._reqCommandProxy=this.options.reqCommandProxy},_onKeepEditing:function(e){this._floatingComponent._closePanel(),this.keepEditing=!0,e.focus()},_onQuitEdition:function(e){this._floatingComponent._closePanel(),e.setData(this.originalData)},_buildKeepEditionDialog:function(e,t){var i,n,o=this,r=v.RichView_Edition_ModifyAccess_DialogText,s=v.RichView_Edition_NotUpToDate_DialogText,a=v.RichView_Edition_ModifyAccess_DialogTitle,l=v.RichView_Edition_NotUpToDate_DialogTitle;"noModifyAccess"==t?(i=a,n=r):"notUptoDate"==t&&(i=l,n=s),this._floatingComponent=new u({Title:i,innerText:n,button1:{title:v.RichView_Edition_Dialog_keepEditingButton,className:"primary",active:!0},button2:{title:v.RichView_Edition_Dialog_quitEditionButton},renderTo:this.defaultOptions.renderTo}),this._floatingComponent.button1.addEvents({onClick:function(t){o._onKeepEditing(e)}}),this._floatingComponent.button2.addEvents({onClick:function(t){o._onQuitEdition(e)}})},startEditionForAll:function(){this._logger.log("startEditionForAll");var e=this,t=c.getLanguage();"zh"===t&&(t+="-cn");this.defaultEditorOptions={skin:"office2013,"+R+"/skins/office2013/",customConfig:e._customConfig,extraPlugins:e._extraPlugins,toolbar:e._toolbar,language:t,startupFocus:!0,on:{instanceReady:function(e){e.editor&&e.editor.removeMenuItem("paste"),(e.editor.container.hasClass("rich-object-title-editable")||e.editor.container.hasClass("rich-container-title-editable"))&&CKEDITOR.plugins.clipboard.preventDefaultDropOnElement(e.editor.container)},blur:function(t){CKEDITOR.instances[t.editor.element.$.id].element.$.style.backgroundColor="",e.options.saveOnBlur&&t.editor.checkDirty()&&e.checkEditability(e.retrivePhysicalID(t.editor)).then(function(i){"noModifyAccess"!=i&&"notUptoDate"!=i?(UWA.is(e.defaultEditorOptions.data)&&".PropertyTab"===e.defaultEditorOptions.data.Property&&(t.editor.spanTitle=t.sender.element.$.parentElement.parentElement.parentElement.childNodes[0].getElement("div").title),e.clearSemanticFormat(t.editor.getData().trim()),e.save(t.editor),t.editor.resetDirty()):e._buildKeepEditionDialog(t.editor,i)}),e.isEditing=!1,a("#"+t.editor.name).parents(e.options.selector).attr("draggable",!0)},change:function(t){e.clearSemanticFormat(t.editor.getData().trim()),UWA.is(e.defaultEditorOptions.data)&&".PropertyTab"!==e.defaultEditorOptions.data.Property&&e._reqCommandProxy.contentChanged()},doubleclick:function(e){var t=e.data.element.$;if(null!==t&&t.className.contains("svg-math")){var i=t.getAttribute("latex");i="\\("+i+"\\)",e.editor.widgets.registered.mathjax.defaults.math=i;var n=e.editor.toolbar,o=!1;for(var r in n)if(n.hasOwnProperty(r)&&"insert"===n[r].name){var s=n[r].items;for(var a in s)if("mathjax"===s[a].name){s[a].click(e.editor),o=!0;break}if(o)break}e.stop()}},paste:function(e){if(e.data.dataValue.contains("_svgSpan")){var t=Math.floor(1e8*Math.random()+1),i=CKEDITOR.dom.element.createFromHtml(e.data.dataValue).$.children[0].getAttribute("latex");e.data.dataValue="",MathJax.tex2svgPromise(i).then(function(n){setTimeout(function(){(n=n.getElementsByTagName("svg")[0]).setAttribute("xmlns","http://www.w3.org/2000/svg");var o=new Image;o.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(n.outerHTML)));var r=document.createElement("img");r.classList.add("svg-math",t,t+"_svgImage"),r.setAttribute("latex",i),r.src=o.src;var s=document.createElement("span");s.innerHTML=r.outerHTML,s.setAttribute("data-latex","Latex equation"),s.classList.add(t+"_svgSpan");var a=new CKEDITOR.dom.element(s),l=e.editor.getSelection().getStartElement();null!==l&&l.$.className.contains("svgSpan")?a.insertAfter(l):e.editor.insertElement(a)},1e3)})}},dialogShow:function(e){var t,i,n,o=e.data._.name,r=e.data,s=!1;"mathjax"===o&&(r.on("cancel",function(){"mathjax"===o&&(e.editor.widgets.registered.mathjax.defaults.math="\\(x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}\\)")}),r.on("ok",function(r){"mathjax"===o&&(i=e.data.getSelectedElement(),e.editor.widgets.registered.mathjax.defaults.math="\\(x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}\\)",n=CKEDITOR.dialog.getCurrent().getContentElement("info","equation").getValue(),null!==i&&i.hasClass("svg-math")?(s=!0,t=i.$.className.match(/(\d+)/)[0],i=null):(s=!1,t=Math.floor(1e8*Math.random()+1)),MathJax.tex2svgPromise(n).then(function(i){setTimeout(function(){(i=i.getElementsByTagName("svg")[0]).setAttribute("xmlns","http://www.w3.org/2000/svg");var o=new Image;o.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(i.outerHTML)));var r=document.createElement("img");if(r.classList.add("svg-math",t,t+"_svgImage"),r.setAttribute("latex",n),r.src=o.src,s){CKEDITOR.currentInstance.element.$.getElementsByClassName(t+"_svgImage")[0].remove();var a=new CKEDITOR.dom.element(r);e.editor.insertElement(a)}else{var l=document.createElement("span");l.innerHTML=r.outerHTML,l.setAttribute("data-latex","Latex equation"),l.classList.add(t+"_svgSpan");a=new CKEDITOR.dom.element(l);var c=e.editor.getSelection().getStartElement();null!==c&&c.$.className.contains("svgSpan")?a.insertAfter(c):e.editor.insertElement(a)}},1e3)})),r.stop()}))},focus:function(t){a("#"+t.editor.name).parents(e.options.selector).attr("draggable",!1)},key:function(t){13!=t.data.keyCode||".rich-container-title-editable"!==e.options.target&&".rich-object-title-editable"!==e.options.target||(t.cancel(),t.editor.fire("blur",t),a("#"+t.editor.name).parents(e.options.selector).focusout())}}},this.options.inlineEditing||(this.defaultEditorOptions.sharedSpaces={top:"toolbar"}),a(this.options.container).on("focus",this.options.target,function(t){if(e.keepEditing)e.keepEditing=!1;else{a(t.target).parents(e.options.selector)[0].attributes["data-physicalid"].value;var i=t.target;if(CKEDITOR.instances[i.id])e._onFocus(t);else{CKEDITOR.inline(i.id,e.defaultEditorOptions);let n=0,o=setInterval(()=>{n++,CKEDITOR.instances[i.id]&&CKEDITOR.instances[i.id].editable()?(e._onFocus(t),clearInterval(o)):n>=30&&clearInterval(o)},200)}}})},retrivePhysicalID:function(e){return e.element.getAscendant(function(e){return 1==e.hasAttribute("data-physicalid")}).getAttribute("data-physicalid")},_editabilityErrorManagement:function(e){"noModifyAccess"==e?h.notifyAlert(v.RichView_Edition_ModifyAccess_Warning):"notUptoDate"==e&&h.notifyAlert(v.RichView_Edition_NotUpToDate_Warning)},_postProcessCSSStyle:function(e){return e=this._postProcessBoldStyle(e),e=this._postProcessLineThroughStyle(e),e=this._postProcessUnderlineStyle(e),e=this._postProcessItalicStyle(e)},_postProcessBoldStyle:function(e){let t=new RegExp('<span style="([^"]*)font-weight:bold([^"]*)">(.*?)</span>',"g");return e=e.replaceAll(t,'<span style="$1 $2 "><strong>$3</strong></span>')},_postProcessLineThroughStyle:function(e){let t=new RegExp('<span style="([^"]*)text-decoration:([^"]*)line-through([^"]*)">(.*?)</span>',"g");return e=e.replaceAll(t,'<span style="$1 $2 $3"><s>$4</s></span>')},_postProcessUnderlineStyle:function(e){let t=new RegExp('<span style="([^"]*)text-decoration:([^"]*)underline([^"]*)">(.*?)</span>',"g");return e=e.replaceAll(t,'<span style="$1 $2 $3"><u>$4</u></span>')},_postProcessItalicStyle:function(e){let t=new RegExp('<span style="([^"]*)font-style:italic([^"]*)">(.*?)</span>',"g");return e=e.replaceAll(t,'<span style="$1 $2 "><i>$3</i></span>')},_onFocus:function(e){var t=this;e.stopPropagation();var i=e.target,n=this,o=m.get();this.defaultOptions.renderTo=o.richViewEditorContainer[0].parentElement.parentElement.parentElement.parentElement.parentElement,this.originalData=CKEDITOR.instances[i.id].getData();var r=a(e.target).parents(t.options.selector),s=r.attr("id")+"_content";if(m.get().onInnerSelection){var l=m.get().getPADTreeDocument().getNodesByElementID(r.attr("id"))[0];m.get().onInnerSelection(l),t.checkEditability(l._options.physicalID).then(function(e){return console.log("onfocus checkEditability oncomplete"),"noModifyAccess"==e||"notUptoDate"==e?(t._editabilityErrorManagement(e),CKEDITOR.instances[i.id].setReadOnly(!0),CKEDITOR.instances[i.id].element.$.style.backgroundColor="#D3D3D3",void CKEDITOR.instances[i.id].resetDirty()):"editable"==e?(CKEDITOR.instances[i.id].setReadOnly(!1),void(CKEDITOR.instances[i.id].element.$.style.backgroundColor="")):void 0})}if(-1!==a(e.target).attr("id").indexOf("title")&&(s=r.attr("id")+"_title_content"),t.defaultEditorOptions.data={objectId:r.data("physicalid")},!0!==t.isEditing||t.id!==s){var u=(o=m.get()).getRichObject(r.attr("id"));if(!0,UWA.is(u)&&u.convertBeforeEdit)t.options.richView.utilities.loading(),d.htmlConvert({securityContext:c.getSecurityContext(),id:r.data("physicalid"),onComplete:function(e){t.options.richView.utilities.loading(!0);var i=(e=JSON.parse(e)).html;i||(i=""),e.isHTMLEditable||"Word"!=C.getPreferredEditor()?(a(n).html(i),t.isEditing=!0,t.id=s,CKEDITOR.instances[s]||CKEDITOR.inline(s,t.defaultEditorOptions),i=t._postProcessCSSStyle(i),CKEDITOR.instances[s].setData(i),a(".rich-object.active, .rich-container.active").toggleClass("active",!1),r.toggleClass("active",!0)):(n.setAttribute("contenteditable",!1),t.mediator.publish("onNotification",{className:"info",message:C.nls.Msg_NoHTMLEditing}))},onFailure:function(e){var t=p.getParseErrorMessage(e);h.errorAlert(t)},onTimeout:function(e){var t=p.getParseErrorMessage(e);h.errorAlert(t)}});else{if(UWA.is(u)&&"rtf.gz.b64"===u.options.format){let e=t._postProcessCSSStyle(this.originalData);CKEDITOR.instances[s].setData(e),this.originalData=e,CKEDITOR.instances[s].resetDirty()}if("false"===e.target.contentEditable)return;t.isEditing=!0,t.id=s,CKEDITOR.instances[s]||CKEDITOR.inline(s,t.defaultEditorOptions),a(".rich-object.active, .rich-container.active").toggleClass("active",!1),r.toggleClass("active",!0)}}},handleFiles:function(e){var t=this;this._logger.log("Files are dragged over ckeditor editor");e.originalEvent.dataTransfer;if(UWA.is(e.originalEvent.target)){var i=a(e.originalEvent.target).parents(this.options.selector+":first"),n=i.attr("id");if(UWA.is(n)){var o=m.get().getRichObject(i.attr("id")),r=!1;i.hasClass("rich-container")&&(r=!0);var s=i.attr("id")+"_content";CKEDITOR.instances[s]||(r||o.isHTMLReady&&("Word"!=C.getPreferredEditor()||C.isMobile&&C.isMobile()))&&(o.convertBeforeEdit?d.htmlConvert({securityContext:c.getSecurityContext(),id:parentObject.data("objectid"),onComplete:function(e){var n=(e=JSON.parse(e)).html;n||(n=""),(e.isHTMLEditable||"Word"!=C.getPreferredEditor())&&(t.updateHtmlContent({element:i,content:n}),t.id=s,CKEDITOR.inline(s,t.defaultEditorOptions))},onFailure:function(e){var t=p.getParseErrorMessage(e);h.errorAlert(t)},onTimeout:function(e){var t=p.getParseErrorMessage(e);h.errorAlert(t)}}):(t.defaultEditorOptions.data={objectId:i.data("objectid")},t.id=s,CKEDITOR.inline(s,t.defaultEditorOptions)))}}},updateCKEditorSpellCheckSetting:function(){try{!0===widget.getPreference("trm_richview_usespellchecker").value||"true"===widget.getPreference("trm_richview_usespellchecker").value?CKEDITOR.config.disableNativeSpellChecker=!1:CKEDITOR.config.disableNativeSpellChecker=!0}catch(e){CKEDITOR.config.disableNativeSpellChecker=!0}},updateHtmlContent:function(e){this._logger.log("updateHtmlContent");var t,i,n=e.content,o=e.element;if(UWA.is(n)&&UWA.is(o)){var r=o.attr("id");if(UWA.is(CKEDITOR.instances[r]))CKEDITOR.instances[r].skipFootnoteOnChange=!0,CKEDITOR.instances[r].setData(n);else{var s=(new DOMParser).parseFromString(n,"application/xml");!UWA.is(s)||!UWA.is(s.querySelector("body"))||(t=s,"http://www.w3.org/1999/xhtml"===(i=(new DOMParser).parseFromString("<","text/xml").getElementsByTagName("parsererror")[0].namespaceURI)?t.getElementsByTagName("parsererror").length>0:t.getElementsByTagNameNS(i,"parsererror").length>0)||(n=s.querySelector("body").innerHTML),o[0].innerHTML=n,e.hasOwnProperty("editable")&&o[0].setAttribute("contenteditable",e.editable)}}},save:function(e){this._logger.log("save");var t=this,i=m.get(),n=!1;var o,r,s=t.clearSemanticFormatFromCKE(e),l=s.trim().replace(/\n/g,""),u=(o=s.trim(),(r=document.createElement("div")).innerHTML=o,r.textContent||r.innerText),g=UWA.Utils.base64Encode(l),f=(UWA.Utils.base64Encode(u),null),b=null;UWA.is(t.defaultEditorOptions.data)&&".PropertyTab"===t.defaultEditorOptions.data.Property?(f=t.defaultEditorOptions.data.objectId,b=t.defaultEditorOptions.data.csrf):f=a(e.element.$).parents(t.options.selector).data("physicalid");var _=[];if(".rich-container"===t.options.selector?(u.isEmpty()&&(n=!0),_.push({name:"Title",value:u})):".rich-object-title-editable"===t.options.target?(u.isEmpty()&&(n=!0),_.push({name:"Title",value:u})):UWA.is(t.defaultEditorOptions.data)&&".PropertyTab"===t.defaultEditorOptions.data.Property?_.push({name:e.spanTitle,value:g}):_.push({name:"Content Data",value:g},{name:"Content Type",value:"html"}),!0===n){t.mediator.publish("onNotification",{className:"info",message:v.RichView_Notif_EmptyTitle});var y={element:a(e.element.$).parents(t.options.selector),refresh:["title"]};t.mediator.publish("onRefreshElement",y)}else UWA.is(t.defaultEditorOptions.data)&&".PropertyTab"===t.defaultEditorOptions.data.Property?d.editRichText({csrf:b,securityContext:c.getSecurityContext(),pid:f,json:{attributes:_},onComplete:function(e){e=UWA.is(e,"string")?JSON.parse(e):e,console.log(e);var t=e.results,i=(UWA.is(t.type,"object")?t.type.displayName:t.type)+" "+t.name+" "+t.revision,n=v.RichView_Notif_ObjectSaved;n=n.replace("{TNR}",i),h.sucessAlert(n)},onFailure:function(i,n){var o=p.getParseErrorMessage(i,n);h.errorAlert(o);var r={element:a(e.element.$).parents(t.options.selector)};".rich-container"===t.options.selector?r.refresh=["title"]:r.refresh=["content"]},onTimeout:function(e){var t=p.getParseErrorMessage(e);h.errorAlert(t)}}):d.edit({securityContext:c.getSecurityContext(),pid:f,json:{attributes:_},onComplete:function(n){i.author(!0);for(var o=(n=UWA.is(n,"string")?JSON.parse(n):n).results,r=i.getPADTreeDocument().getNodesById(f),s=n.results.cestamp,c=0;c<r.length;c++)r[c].setCEStamp(s);var d=(UWA.is(o.type,"object")?o.type.displayName:o.type)+" "+o.name+" "+o.revision,p=v.RichView_Notif_ObjectSaved;p=p.replace("{TNR}",d),h.sucessAlert(p);var g={element:a(e.element.$).parents(t.options.selector),physicalId:f};".rich-container"===t.options.selector?g.updates={title:u}:".rich-object-title-editable"===t.options.target?g.updates={title:u}:g.updates={content:l},t.mediator.publish("onUpdateElement",g),t._padCommandProxy.refresh({authored:{modified:[o.physicalid]}})},onFailure:function(i,n){var o=p.getParseErrorMessage(i,n);h.errorAlert(o);var r={element:a(e.element.$).parents(t.options.selector)};".rich-container"===t.options.selector?r.refresh=["title"]:r.refresh=["content"],t.mediator.publish("onRefreshElement",r)},onTimeout:function(e){var t=p.getParseErrorMessage(e);h.errorAlert(t)}})},checkEditability:function(e){var t=this;if(UWA.is(t.defaultEditorOptions.data)&&".PropertyTab"===t.defaultEditorOptions.data.Property)return new y(function(e,t){e(!0)});t.context=m.get();var i,n=t.context.getPADTreeDocument().getNodesById(e)[0];return n&&(i=n.getCEStamp()),new y(function(n,o){e||o(),d.getInfo({securityContext:c.getSecurityContext(),pid:e,authored:!0,selectables:"cestamp,current.access[modify],name,attribute[Title]",onComplete:function(o){o=c.parseResponse(o);var r=(o=UWA.is(o,"string")?JSON.parse(o):o).results[0],s="editable";if(null==i){for(var a=t.context.options.model.getNodesById(e),l=0;l<a.length;l++){var d=a[l];d.options.title=""!==r["attribute[Title]"]?r["attribute[Title]"]:r.name,null!=d.options.elementRV&&d.setCEStamp(r.cestamp);var u=d.getRichViewElement();UWA.is(u)&&u.update({title:""!==r["attribute[Title]"]?r["attribute[Title]"]:r.name,cestamp:r.cestamp})}i=r.cestamp}"FALSE"===r["current.access[modify]"]?s="noModifyAccess":"true"==t.context.isConcurrentEngineeringEnabled&&r.cestamp!=i&&(s="notUptoDate"),n(s)},onFailure:function(e,t){var i=p.getParseErrorMessage(e,t);h.errorAlert(i),o()},onTimeout:function(e){var t=p.getParseErrorMessage(e);h.errorAlert(t),o()}})})},cancel:function(e){this._logger.log("cancel"),this.editor.destroy(!0),this.mediator.publish("onCancel",e)},clearSemanticFormat:function(e){for(var t=["find-in-resultgreen","find-in-resultyellow","find-in-resultred"],i=0;i<t.length;++i)a("<p>"+e+"</P>").find("span."+t[i]).contents().unwrap();return console.log("RCE: Data cleared before save!"),e},clearSemanticFormatFromCKE:function(e){for(var t=["find-in-resultgreen","find-in-resultyellow","find-in-resultred"],i=0;i<t.length;++i)a(e.document.$).find("span."+t[i]).contents().unwrap();return e.getData()}});return E}),define("DS/RichView/Utils/UpdateSearchView",["UWA/Class","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","i18n!DS/TraceableRequirementsUtils/assets/nls/TraceableRequirementsUtils.json"],function(e,t,i,n){const o=function(e){let t=this;null!==t._pagerview&&("previous"==e.event&&(t._selectedIdx--,t.reframeOn()),"next"==e.event&&(t._selectedIdx++,t.reframeOn()))},r=function(){let e=this;-1===e._selectedIdx&&(e._selectedIdx=e._matchedNodes.length-1);let t=e._selectedIdx%e._matchedNodes.length,i=(e._matchedNodes.length+e._selectedIdx-1)%e._matchedNodes.length;if(e._pagerview){let i=t+1+"/"+e._matchedNodes.length;e._pagerview.setLabel(i)}let n=e.options.model.getNodesByRelId(e._matchedNodes[t]);n=n.length?n:e.options.model.getNodesById(e._matchedNodes[t]);let o=e.options.model.getNodesByRelId(e._matchedNodes[i]);if(o=o.length?o:e.options.model.getNodesById(e._matchedNodes[i]),n.length){o&&o.length>0&&t!=i&&o.forEach(e=>e.cleanupHighlightHeader()),n.forEach(e=>e.highlightHeader());let r=".rich-object";n[0].getRichViewElement()&&n[0].getRichViewElement().container&&n[0].getRichViewElement().container.hasClass("rich-container")&&(r=".rich-container"),e._selectionMgt(n[0].getRichViewElement().header,r),e.utilities.findAndScrollToObject({id:n[0].getID()})}};return e.singleton({executeViewUpdate:function(e,s,a){let l=this,c=[];e.results&&e.matchedNode&&e.matchedNode.length?(s.forEach(i=>{i&&i.children&&i.children.length&&i.children.forEach(i=>{t.traverseTree(i,e.matchedNode,c)})}),l.focusChange=o,l.reframeOn=r,c&&c.length?(c.length>=a-1&&i.warningAlert(n.SearchInWidget_maxLimitReached),c.length>=a&&c.splice(-1),t.displayTRMSearchNav.call(l,c)):(l._pagerview&&l._pagerview.hide(),i.notifyAlert(n.SearchWithInDashboard_OccurrenceNotFound))):(l._pagerview&&l._pagerview.hide(),i.notifyAlert(n.SearchWithInDashboard_OccurrenceNotFound))}})}),define("DS/RichView/Service/KeyboardShortcuts",["UWA/Class","UWA/Class/Events","DS/Logger/Logger","DS/PADUtils/PADContext","DS/TraceableRequirementsUtils/jQuery","text!DS/TraceableRequirementsUtils/assets/RequirementRelationshipsPatterns.json","i18n!DS/TraceableRequirementsUtils/assets/nls/TraceableRequirementsUtils"],function(e,t,i,n,o,r,s){"use strict";var a=null,l=e.singleton(t,{name:"KeyboardShortcuts",options:{},mediator:null,_logger:null,init:function(e){return a=this,this._logger=i.getLogger(l),this._relPattern=JSON.parse(r),this},addKeyboardEventListener:function(){this._logger.log("_addKeyboardEventListener"),document.addEventListener("keyup",this._objectCreation,!1)},removeKeyboardEventsListener:function(){this._logger.log("_removeKeyboardEventsListener"),document.removeEventListener("keyup",this._objectCreation,!1)},_objectCreation:function(e){var t=null,i=null,r=null,s=null,l=!1,c=n.get();if(e.altKey&&73===e.keyCode)l=!0,s="over",i=c.getDefaultType("Requirement"),r="Requirement",1===(d=c.getSelectedElement()).path.length?t=void 0:(a._relPattern[d.kindof]||a._relPattern[d.type]).Requirement?t=d.element:l=!1;else if(e.altKey&&74===e.keyCode){if(l=!0,s="over",i=c.getDefaultType("Chapter"),r="Chapter",1===(d=c.getSelectedElement()).path.length)t=void 0;else(a._relPattern[d.kindof]||a._relPattern[d.type]).Chapter?t=d.element:l=!1}else if(e.altKey&&71===e.keyCode){if(l=!0,s="after",i=c.getDefaultType("Requirement"),r="Requirement",1===(d=c.getSelectedElement()).path.length)(u=o(".rich-object:not(.placeholder),.rich-container")).size()>0?t=u.eq(u.size()-1):l=!1;else t=d.element}else if(e.altKey&&75===e.keyCode){var d,u;if(l=!0,s="after",i=c.getDefaultType("Chapter"),r="Chapter",1===(d=c.getSelectedElement()).path.length)(u=o(".rich-object:not(.placeholder),.rich-container")).size()>0?t=u.eq(u.size()-1):l=!1;else t=d.element}if(!0===l){var h={};UWA.is(t)&&(h={element:t,id:t.attr("id")});var p={target:h,position:s,operation:"insertNew",type:i,kindof:r,content:"",contentType:"html"};UWA.is(c)&&UWA.is(c.authoring)&&UWA.is(c.authoring.insertWithPromise)&&c.authoring.insertWithPromise(p)}else UWA.is(c)&&UWA.is(c.displayNotification)}});return l}),define("DS/RichView/Service/WebServiceController",["UWA/Class/Promise","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/PADUtils/PADSession","DS/TraceableRequirementsUtils/utils/RequirementErrorManager","i18n!DS/TraceableRequirementsUtils/assets/nls/TraceableRequirementsUtils"],function(e,t,i,n,o,r,s){return{getExpandData:function(e,s){t.expand({json:e,onComplete:function(e){if((e=i.parseResponse(e)).errors&&e.errors.length)o.setAuthoringState(!0,"Disabling index acceleration as at least one requested object hasn't been indexed"),s(e);else try{var t=UWA.is(e,"string")?JSON.parse(e):e;s(t)}catch(e){ENOTRMAlertManager.errorAlert(e)}finally{void 0}},onFailure:function(e,t){var i=r.getParseErrorMessage(t);n.errorAlert(i),s({results:[]})},onTimeout:function(e,t){var i=r.getParseErrorMessage(e);n.errorAlert(i),s({results:[]})}})},getStructureContent:function(o){return new e(function(e,s){t.getStructureWithStreaming({id:o,securityContext:i.getSecurityContext(),onComplete:function(t){t=(t=UWA.is(t,"string")?JSON.parse(t):t).results?t.results:t,e(t)},onFailure:function(e){var t=r.getParseErrorMessage(e);n.errorAlert(t),s()},onTimeout:function(e){var t=r.getParseErrorMessage(e);n.errorAlert(t)}})})},getInfo:function(o){return new e(function(e,s){t.getInfo({pid:o.id,selectables:o.selectables,securityContext:i.getSecurityContext(),onComplete:function(t){t=i.parseResponse(t),t=(t=UWA.is(t,"string")?JSON.parse(t):t).results?t.results:t,e(t)},onFailure:function(e){var t=r.getParseErrorMessage(e);n.errorAlert(t),s()},onTimeout:function(e){var t=r.getParseErrorMessage(e);n.errorAlert(t)}})})},insertExisting:function(o){return new e(function(e,s){t.insertExisting({securityContext:i.getSecurityContext(),json:o,onComplete:function(t){t=(t=UWA.is(t,"string")?JSON.parse(t):t).results?t.results:t,e(t)},onFailure:function(e){var t=r.getParseErrorMessage(e);n.errorAlert(t),s()},onTimeout:function(e){var t=r.getParseErrorMessage(e);n.errorAlert(t)}})})}}}),define("DS/RichView/mixins/_delimiterUtilities",["UWA/Class"],function(e){return e.extend({_DELIMITER:""})}),define("DS/RichView/Utils/RichviewConstant",["UWA/Core"],function(e){"use strict";return Object.freeze({TYPE_REQUIREMENT:"Requirement",TYPE_DERIEVED_REQUIREMENT:"Derived Requirement",TYPE_REQUIREMENT_SPECIFICATION:"Requirement Specification",TYPE_CHAPTER:"Chapter",TYPE_COMMENT:"Comment",Type_Attr:"ds6w:type",OOTB_TYPE:["Requirement","Chapter","Comment","Requirement Specification","Requirement Group"]})}),define("DS/RichView/Service/WidgetPreferences",["UWA/Class","UWA/Class/Events","DS/Logger/Logger","DS/TraceableRequirementsUtils/Services/RequirementSecurityCtxMgt","DS/TraceableRequirementsUtils/Services/RequirementTypeMgt","DS/TraceableRequirementsUtils/Services/RequirementTenantMgt","i18n!DS/RichView/assets/nls/RichView"],function(e,t,i,n,o,r,s){"use strict";return e.extend(t,{name:"richview_widgetpreferences",_logger:null,init:function(){this,this._logger=i.getLogger("DS/RichView/Service/WidgetPreferences")},addPreferencesToWidget:function(e){this._addSubcriptionToPreference(),this._addTenantMgtToPreference(e);var t=this._addSecurityContextPreference(e);return this._initCsrfToken(),t},_initCsrfToken:function(){this._logger.log("add csrf token management to the widget value"),o.initCsrfToken()},_addSecurityContextPreference:function(e){return this._logger.log("add security context management to the widget preferences"),n.addSecurityCtx2Preferences(e)},_addTenantMgtToPreference:function(e){this._logger.log("add tenant management to the widget preferences"),r.addTenant2Preferences(e)},_addSubcriptionToPreference:function(){this._logger.log("add TRA subscription management to the widget preferences"),widget.mergePreferences([{name:"subscribeToTRASelect",type:"boolean",label:s.RichView_SubscribeToTRA,defaultValue:"false"}])}})}),define("DS/RichView/Navigation",["UWA/Core","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/UIKIT/Scroller","DS/TraceableRequirementsUtils/Fancytree","i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css","css!../VENREQPlugins/External/fancytree/latest/media/skin-bootstrap/ui.fancytree.css"],function(e,t,i,n,o,r){"use strict";return function(e){var i=UWA.merge(e||{},{mediator:null,selector:"h1,h2,h3,h4",context:null}),o=function(e){var i=r.RichView_Headers_Navigation;return t('<div class="navigation-categories hidden-xs"><ul class="navigation-categories-list">\t<li class="active nav-headers" data-content="headers">'+i+"</li></div></ul>")},s=function(e){return t('<div class="navigation-content">\t<div class="navigation-headers active"></div></div>')},a=function(e){return t('<div class="navigation-list"></div><div class="top-border"><span class="fonticon fonticon-doc-text "></span>'+e.objects+' <span class="fonticon fonticon-book"></span>'+e.containers+"</div>")},l=function(e){return t('<div class="helpers">\t<p></p></div>')},c=null;return{inject:function(e){return c=this,this.options=i,this.mediator=i.mediator,this.context=i.context,this.container=e,this._navigationCategories(),this._init(),this},_subscribers:{subscribeToScroll:function(){c.mediator.subscribe("onScroll",function(e){e.position,c.update(e.position)})},subscribeToHelpersClick:function(){c.mediator.subscribe("onClick:helpers",function(){t(c.container+" .navigation-categories-list .nav-helpers").click()})},subscribeToHeadersClick:function(){c.mediator.subscribe("onClick:headers",function(){t(c.container+" .navigation-categories-list .nav-headers").click()})},subscribeToRefresh:function(){c.mediator.subscribe("onRefresh",function(e){c.refresh()})}},_init:function(){this._subscribers.subscribeToHelpersClick(),this._subscribers.subscribeToHeadersClick(),this._subscribers.subscribeToScroll(),this._subscribers.subscribeToRefresh(),this.isExpanded="expanded",this.navigation=t(this.container+" .navigation-headers").append(a({objects:t(".rich-object").length,containers:t(".rich-container").length})),this.helpers=t(this.container+" .navigation-helpers").append(l({}));try{t(".navigation-list").fancytree(this.getExplorerSettings())}catch(e){console.warn(error)}if(!this.isExpanded){var e=new Array;t(this.container).on("mouseover",".navigation-entry",function(i){var n=t(i.target);e.push(n),n.hasClass("expanded-temp-object")||n.parent().hasClass("expanded-temp-object")||(n.hasClass("navigation-entry")||(n=n.parent()),n.nextUntil(":not(.collapsed-object)").removeClass("collapsed-object").addClass("expanded-temp-object"))}),t(this.container).on("mouseleave",".navigation-list",function(t){for(var i=0;i<e.length;i++)e[i].nextUntil(":not(.expanded-temp-object)").removeClass("expanded-temp-object").addClass("collapsed-object")})}},_navigationCategories:function(){var e=t(this.container).append(o());t(this.container).append(s()),t(this.container+" .navigation-categories-list").on("click","li",function(i){var n=t(this);if(n.hasClass("active"))return!1;t(c.container+" .navigation-"+t("li.active",e).removeClass("active").addClass("not-active").data("content")).removeClass("active").addClass("not-active"),t(c.container+" .navigation-"+n.removeClass("not-active").addClass("active").data("content")).removeClass("not-active").addClass("active")})},_scrollView:function(e,i){var o=t(".navigation-content").height();t(e).height(o),c.scroller=new n({element:UWA.Element.getElement.call(document,this.container+" "+e)}).inject(UWA.Element.getElement.call(document,this.container+" "+i),"top")},update:function(e){var i,n,o=this.navigation;i=o.find(".fancytree-node").map(function(){var e=t(this),i=t("#"+e.data("id"));return null!==i&&i.is(":visible")?{top:i.position().top,node:e}:null}),n=null,t.each(i,function(e,t){t.node.removeClass("navigation-current"),(null===n||t.top<=0&&t.top>n.top)&&(n=t)}),n&&n.node.addClass("navigation-current")},refresh:function(){t(".navigation-list").fancytree("destroy"),c.scroller&&(c.scroller.destroy(),c.scroller=null),t(".navigation-list").empty(),t(".navigation-list").fancytree(this.getExplorerSettings()),this.resizeList()},resizeList:function(){var e=t(".navigation-content").height()-t(".top-container").height();t(".navigation-list").height(e)},getExplorerSettings:function(){var e=t(this.options.selector);if(0!==e.length){for(var i=[],n=0;n<e.length;n++){var o=e.eq(n);widget.getValue("trm_richview_DisableAutoNumbering")?i[n]={title:o.find(".rich-container-title-editable").text(),key:o.attr("id")}:i[n]={title:o.find(".rich-container-title").text(),key:o.attr("id")}}return{extensions:["dnd","glyph","wide"],checkbox:!1,dnd:{focusOnClick:!0,dragStart:function(e,t){return!0},dragEnter:function(e,t){return!0},dragOver:function(e,i){switch(i.hitMode){case"after":e.span.classList.remove("droppable-child"),(e.li.nextSibling&&!e.li.nextSibling.classList.contains("droppable-below")||!e.li.nextSibling&&e.isLastSibling())&&t(e.li).after('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>');break;case"before":e.span.classList.remove("droppable-child"),(e.li.previousSibling&&!e.li.previousSibling.classList.contains("droppable-below")||!e.li.previousSibling&&e.isFirstSibling())&&t(e.li).before('<div class="droppable-target droppable-below wux-datagrid-row-insertion-mark"></div>');break;case"over":e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.add("droppable-child")}},dragStop:function(e,t){e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.remove("droppable-child")},dragLeave:function(e,t){e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.remove("droppable-child")},dragDrop:function(e,i){e.li.previousSibling&&e.li.previousSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.previousSibling),e.li.nextSibling&&e.li.nextSibling.classList.contains("droppable-below")&&e.li.parentNode.removeChild(e.li.nextSibling),e.span.classList.remove("droppable-child"),c.mediator.publish("onReorder",{source:{element:t("#"+i.otherNode.key),id:i.otherNode.key},target:{element:t("#"+e.key),id:e.key},position:i.hitMode,type:"rich-container"}),"over"===i.hitMode&&(i.hitMode="after"),i.otherNode.moveTo(e,i.hitMode)}},glyph:{map:{doc:"fonticon fonticon-book",docOpen:"glyphicon glyphicon-file",checkbox:"glyphicon glyphicon-unchecked",checkboxSelected:"glyphicon glyphicon-check",checkboxUnknown:"glyphicon glyphicon-share",dragHelper:"ffonticon fonticon-play",dropMarker:"fonticon fonticon-right",error:"glyphicon glyphicon-warning-sign",expanderClosed:"glyphicon glyphicon-plus-sign",expanderLazy:"glyphicon glyphicon-plus-sign",expanderOpen:"glyphicon glyphicon-minus-sign",folder:"glyphicon glyphicon-folder-close",folderOpen:"glyphicon glyphicon-folder-open",loading:"glyphicon glyphicon-refresh"}},selectMode:2,source:i,table:{nodeColumnIdx:1},wide:{iconWidth:"1em",iconSpacing:"0.5em",levelOfs:"1.5em"},activate:function(e,t){},lazyLoad:function(e,t){t.result={url:"ajax-sub2.json",debugDelay:1e3}},click:function(e,t){c.mediator.publish("onNavigationClick",t.node.key)},renderNode:function(e,t){var i=t.node;i.span.setAttribute("data-id",i.key)},init:function(){try{c._scrollView(".navigation-list",".navigation-headers")}catch(e){}}}}}}}}),define("DS/RichView/ActionBar",["DS/Core/Core","DS/ApplicationFrame/FrameWindow","DS/RuntimeView/NLSManager","DS/CoreEvents/ModelEvents","css!DS/RichView/RichView.css"],function(e,t,i,n){"use strict";return function(o){var r=UWA.merge(o||{},{mediator:null}),s="trm-richview";return{inject:function(){e.setFullscreen(),this.options=r,this.mediator=r.mediator,this._modelEvents=new n,i.DEFAULT_LANGUAGE=widget.lang?widget.lang:widget.getValue("lang"),i.loadResource({resourceFile:"RichView/RichView"}),i.onResourceLoaded({resourceFile:"RichView/RichView",language:widget.lang?widget.lang:widget.getValue("lang")},function(){}),widget.frmWindow=new t({workbenchModule:"RichView",workbench:"RichView.xml",viewer:"none",height:"100%"}).inject(widget.body);var o=widget.frmWindow.getViewerFrame();return new UWA.Element("div",{id:s}).inject(o),widget.frmWindow.onActionBarReady(function(){o.style.height=o.parentNode.offsetHeight-70+"px",this._modelEvents.subscribe({event:"ACTIONBAR_OPEN"},function(e){o.style.height=o.parentNode.offsetHeight-70+"px"}),this._modelEvents.subscribe({event:"ACTIONBAR_CLOSE"},function(e){o.style.height=o.parentNode.offsetHeight-20+"px"})}),s}}}}),define("DS/RichView/Command/CtxMenu_StartLinkCmd",["DS/ApplicationFrame/Command"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this.TOPIC_NAME="ENORERE_AP.StartLink"},execute:function(e){sessionStorage.removeItem(this.TOPIC_NAME),sessionStorage.setItem(this.TOPIC_NAME,JSON.stringify(e))}})}),define("DS/RichView/Views/RichViewInfos",["i18n!DS/RichView/assets/nls/RichView","css!DS/RichView/RichView.css","UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","UWA/Drivers/Alone","DS/Logger/Logger","DS/UIKIT/Tooltip","DS/UIKIT/Popover"],function(e,t,i,n,o,r,s,a,l){"use strict";var c=n.extend(o,{name:"richview_infos",_logger:null,_tooltip:null,init:function(e){this._logger=s.getLogger(c),this._logger.log("init"),this._parent(e),this.elements.container=UWA.createElement("span",{class:this.getClassNames()+" fonticon fonticon-info"}),this._tooltip=new a({className:this.getClassNames("_tooltip"),target:this.elements.container,position:"left",body:this.buildInfos()}),this.getOption("renderTo")&&this.inject(this.getOption("renderTo"))},setBody:function(){this._tooltip.setBody(this.buildInfos())},buildInfos:function(){var t=UWA.createElement("div",{class:"richview_infos_msg"}),i=e.RichView_Tooltip_InsertReqAsChild+", "+e.RichView_Tooltip_InsertReqAsSibling+", "+e.RichView_Tooltip_InsertChapAsChild+", "+e.RichView_Tooltip_InsertChapAsSibling;return UWA.createElement("div",{text:i}).inject(t),t}});return c}),define("DS/RichView/Utils/LinkManagementValues",["UWA/Core"],function(e){"use strict";return Object.freeze({TYPE_DERIVED_REQUIREMENT:"Derived Requirement",TYPE_DOWNSTREAM_DERIVED_REQUIREMENT:"Downstream Derived Requirement",TYPE_UPSTREAM_DERIVED_REQUIREMENT:"Upstream Derived Requirement",TYPE_LINK_COVERED:"covered",TYPE_LINK_REFINED:"refined"})}),define("DS/RichView/Models/RichViewModel",["DS/ENXNav/models/xNavNodeModel","DS/PADUtils/PADSettingsMgt","DS/PADServices/utils/AttributesMgt"],function(e,t,i){"use strict";function n(e){e._getFilterInfo||(e._getFilterInfo=o.prototype._getFilterInfo.bind(e),e._getChildrenFilterInfo=o.prototype._getChildrenFilterInfo.bind(e),e._removeChildrenFilterInfo=o.prototype._removeChildrenFilterInfo.bind(e),e.filterInChild=o.prototype.filterInChild.bind(e),e.filterOutChild=o.prototype.filterOutChild.bind(e))}function o(t){this.options={matrixID:null,physicalID:null,elementID:null,elementRV:null,type:"",kindof:"",title:"",name:"",revision:"",content:"",relationtype:"",relationid:null,parentID:"",level:0,editable:!0,isDocx:!1,format:"html"},UWA.is(t.relcount)&&0===t.relcount&&(t.children=null),this.tenant=t.tenant,this.options=UWA.extend(this.options,t),e.call(this,this.options)}return o.prototype=Object.create(e.prototype),o.prototype.setParentID=function(e){this.options.parentID=e},o.prototype.getParentID=function(){return this.options.parentID},o.prototype.getOccurencePathWithType=function(e,t){if(t=t||!1,UWA.is(e,"function")&&e(this),!this.isRoot()&&this.getParent()){var i=this.getParent().getOccurencePathWithType(e,t);return 1==t?(i.push({resourceid:this.options.relationid,type:this.options.relationtype}),i.push({resourceid:this.options.resourceid,type:this.options.type})):(i.push(this.options.relationid),i.push(this.options.resourceid)),i}return 1==t?[{resourceid:this.options.resourceid,type:this.options.type}]:[this.options.resourceid]},o.prototype.setLevel=function(e){this.options.level=e},o.prototype.setCEStamp=function(e){this.options.cestamp=e},o.prototype.getCEStamp=function(){return this.options.cestamp},o.prototype.getLevel=function(){return this.options.level},o.prototype.setRelationOrder=function(e){this.options.relationOrder=e},o.prototype.getRelationOrder=function(){return this.options.relationOrder},o.prototype.getRelationType=function(){return this.options.relationtype},o.prototype.setRelationType=function(e){this.options.relationtype=e},o.prototype.setRichViewElementID=function(e){this.options.elementID=e},o.prototype.getRichViewElementID=function(){return this.options.elementID},o.prototype.setRichViewElement=function(e){this.options.elementRV=e},o.prototype.getRichViewElement=function(){return this.options.elementRV},o.prototype.getDiscription=function(){return""},o.prototype.getTitle=function(){return this.options.title},o.prototype.getType=function(){return this.options.type},o.prototype.getOwner=function(){return this.options.owner},o.prototype.getModifiedDate=function(){return this.options.modified},o.prototype.getRevision=function(){return this.options.grid["ds6wg:revision"]},o.prototype.getStatus=function(){var e=this.options.grid["ds6w:status"];return e&&(e.indexOf("Requirement Specification.")>-1||e.indexOf("Requirement Group.")>-1||e.indexOf("Requirement.")>-1)?e.slice(e.indexOf(".")+1):e},o.prototype.getCreatedDate=function(){return this.options.owner},o.prototype.getselected=function(){return this.options.selected},o.prototype.getTraceabilityScope=function(){return this.options.TraceabilityScope},o.prototype.getThumbnail=function(){return this.options.thumbnail},o.prototype.getNodesByMatrixID=function(e){var t={listOfFoundNodes:[],foundId:void 0};return this._getNodesByMatrixID(e,t),t.listOfFoundNodes},o.prototype._getNodesByMatrixID=function(e,t){var i=this.options.matrixID,n=this.getID();if(i===e)t.listOfFoundNodes.push(this),t.foundId=n;else if(n!==t.foundId){var o=this.getChildren();if(o)for(var r=0;r<o.length;r++)o[r]._getNodesByMatrixID(e,t)}},o.prototype.getNodesByElementID=function(e){var t={listOfFoundNodes:[],foundId:void 0};return this._getNodesByElementID(e,t),t.listOfFoundNodes},o.prototype._getNodesByElementID=function(e,t){var i=this.options.elementID,n=this.getID();if(i===e)t.listOfFoundNodes.push(this),t.foundId=n;else if(n!==t.foundId){var o=this.getChildren();if(o)for(var r=0;r<o.length;r++)o[r]._getNodesByElementID(e,t)}},o.prototype._removeFilterInfo=function(){delete this.options._filterInfo},o.prototype._removeChildrenFilterInfo=function(){delete this.options._childrenFilterInfo},o.prototype._getFilterInfo=function(e){return!this.options._filterInfo&&Boolean(e)&&(this.options._filterInfo={}),this.options._filterInfo},o.prototype._getChildrenFilterInfo=function(e){return!this.options._childrenFilterInfo&&Boolean(e)&&(this.options._childrenFilterInfo={}),this.options._childrenFilterInfo},o.prototype.filterOut=function(){var e=this.isRoot()?this.getTreeDocument():this.getParent();null!==e&&(n(e),e.filterOutChild(this))},o.prototype.filterIn=function(e){var t=this._getFilterInfo();if(t&&t.parentBeforeFiltering){var i=t.parentBeforeFiltering;n(i),i.filterInChild(this)}if(Boolean(e)){var o,r=this._getChildrenFilterInfo();(o=r&&r.childrenBeforeFiltering?r.childrenBeforeFiltering:this.getChildren())&&o.forEach(function(t){t.filterIn(e)})}},o.prototype.filterOutChild=function(e){var t=this.getChildren();if(t.indexOf(e)<0)throw"Not a child";var i=this._getChildrenFilterInfo(!0);if(!i.childrenBeforeFiltering){i.childrenBeforeFiltering=t&&t.length>0?t.slice(0):[];UWA.is(this._expandState)&&(i.expandStateBeforeFiltering={noExpandState:"noChildren",expandingState:"expanding",partiallyExpandedState:"partiallyExpanded",collapseState:"expanded",expandState:"collapsed",noChildren:"noChildren",expanding:"expanding",partiallyExpanded:"partiallyExpanded",expanded:"expanded",collapsed:"collapsed"}[this._expandState])}e._getFilterInfo(!0).parentBeforeFiltering=this,UWA.is(this.removeChild,"function")&&(this.removeChild(e),e.options.elementRV.hide()),UWA.is(this.setState,"function")&&this.setState({state:i.expandStateBeforeFiltering}),i.filteredOutChildren||(i.filteredOutChildren=[]),i.filteredOutChildren.push(e)},o.prototype.filterInChild=function(e){var t=this._getChildrenFilterInfo();if(t){var i=t.childrenBeforeFiltering;if(i){var n=i.indexOf(e);if(n>=0){var o=e._getFilterInfo();if(o&&o.parentBeforeFiltering===this){var r,s=this.getChildren();if(s)for(var a=0;a<s.length;a++){var l=s[a];if(i.indexOf(l)>n){r=l;break}}delete o.parentBeforeFiltering,e.isRoot()||(void 0!==e.options.isRootAttached?!0===e.options.isRootAttached&&(this.insertBefore(e,r),e.options.elementRV.show()):(this.insertBefore(e,r),UWA.is(e.options.elementRV)&&e.options.elementRV.show())),UWA.is(this.setState,"function")&&this.setState({state:t.expandStateBeforeFiltering}),e._removeFilterInfo();var c=t.filteredOutChildren.indexOf(e);t.filteredOutChildren.splice(c,1),0===t.filteredOutChildren.length&&this._removeChildrenFilterInfo()}}}}},o.prototype.highlightHeader=function(){var e=this.options.elementID;if(e){var t=document.getElementById(e+"_header")?document.getElementById(e+"_header"):document.getElementById(e);t&&t.classList.add("Highlight_search-in-current-dashboard")}},o.prototype.cleanupHighlightHeader=function(){var e=this.options.elementID;if(e){var t=document.getElementById(e+"_header")?document.getElementById(e+"_header"):document.getElementById(e);t&&t.classList.remove("Highlight_search-in-current-dashboard")}for(var i=document.getElementsByClassName("highlight_Find");i.length>0;)i[0].outerHTML=i[0].innerText},o}),define("DS/RichView/Utils/RichViewDNDManager",["DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","i18n!DS/RichView/assets/nls/RichView","DS/RichView/Service/WebServiceController","DS/TraceableRequirementsUtils/utils/TRMTypeManagement","DS/TraceableRequirementsUtils/jQuery","text!DS/TraceableRequirementsUtils/assets/RequirementRelationshipsPatterns.json","DS/PADUtils/PADContext","i18n!DS/TraceableRequirementsUtils/assets/nls/TraceableRequirementsUtils"],function(e,t,i,n,o,r,s,a,l){let c=!1,d=JSON.parse(s);const u=function(e){let i=this,n=a.get(),o=UWA.is(e,"string")?JSON.parse(e):e;if(o.Success.length>0)n.refreshOnInsert(o.Success,null,"insertExisting",i._dropPosition);else{let e=o.Failure[0],i=(UWA.is(e.type,"object")?e.type.displayName:e.type)+" "+e.name+" "+e.revision,n=e.errorMsg?l[e.errorMsg]:l.DragNDrop_Failure_msg+" "+l.FailureReasons;n=n.replace("{TNR}",i),e.errorMsg&&"doReconcileFailed"===e.errorMsg?t.warningAlert(n):t.errorAlert(n)}},h=function(e,t,i){let n=this,o=e.authorized_objects[0].objectId,r=null,s=null,a=null,l=null,c="",u="",h=null,p=t[0].id,g=n.model.getNodesByElementID(p)[0],m=null,f=null,v=null;switch(n._dropPosition){case"after":c=(l=g.getNextNode())?l.getRelationID():"",u=(h=g).getRelationID(),v=(f=g.getParent()).getID();break;case"before":c=(l=g).getRelationID(),u=(h=g.getPreviousNode()).getRelationID()?h.getRelationID():"",v=(f=g.getParent()).getID(),h.getID()==v&&(u="");break;case"over":v=(f=g).getID()}r=f.options["type.kindof"],s=d[r];let b=null;return(a=d[r]?s[i]:void 0)&&(m=g,n.context.onInnerSelection(m),b={dataArray:[{id:o,pid:v,nextSibling:{relId:c},previousSibling:{relId:u},relationship:a}]}),b},p=function(e){e.removeClass("droppable-child"),e.removeClass("droppable-before"),e.removeClass("droppable-after")},g=function(e,t){let i=e.authorized_objects[0].path.length,n=e.authorized_objects[0].path[i-2].resourceid,o=this.model.getNodesByRelId(n)[0].options.elementID,s=r("#"+o);this.mediator.publish("onReorder",{source:{element:s,id:o},target:{element:t,id:this.options.id},position:this._dropPosition,type:this.options.containerType})};return{initDNDEvents:function(){let s=this,a={drageEnterCount:0};s.container.on("dragstart",function(t){r(this).addClass("being-dragged");s.model.getNodesByElementID(s.id)[0];let i=void 0;switch(s.options.containerType){case"rich-object":i=r(this).find(".rich-object-header .trm-icon")[0];break;case"rich-container":i=r(".fancytree-icon.fonticon-book")[0]}t.originalEvent.dataTransfer.setDragImage(i,-10,-10),function(t){this._dragging=!0,this._draggingY=t.originalEvent.clientY,t.originalEvent.dataTransfer.dropEffect="move";let i=widget.getUrl(),n=(i=i.substr(0,i.indexOf("/webapps"))).substr(i.lastIndexOf("/")+1),o=this.model.getNodesByElementID(this.id)[0].getOccurencePathWithType(null,!0),r={protocol:"3DXContent",version:"1.1",source:widget.getValue("appId"),widgetId:e.getWidgetId(),data:{items:[{envId:e.getTenant(),serviceId:n,contextId:e.getSecurityContext(),objectId:this.physicalId,objectType:this.type,displayName:this.title,kindof:this.kindof,path:o}]}};t.originalEvent.dataTransfer.setData("Text",JSON.stringify(r))}.call(s,t)}),s.container.on("dragenter",function(e){a.drageEnterCount++,e.stopPropagation(),e.preventDefault()}),s.container.on("dragover",function(e){(function(e){let t=this;if(!t._dragging){let i=!1;-1!==r.inArray("Files",e.originalEvent.dataTransfer.types)&&(widget.dispatchEvent("onDragOverFiles",e),i=!0);let n=r(e.currentTarget),o=n.offset().top,s=n.outerHeight(),a=o+s,l=10,c=o+l,d=o+s-l;i?(n.addClass("droppable-child"),t._dropPosition="over"):e.originalEvent.clientY<c&&e.originalEvent.clientY>o&&!n.hasClass("droppable-before")?(n.addClass("droppable-before"),n.removeClass("droppable-child"),t._dropPosition="before"):e.originalEvent.clientY>c&&e.originalEvent.clientY<d&&!n.hasClass("droppable-child")?(p(n),n.addClass("droppable-child"),t._dropPosition="over"):e.originalEvent.clientY>d&&e.originalEvent.clientY<a&&!n.hasClass("droppable-after")&&(n.addClass("droppable-after"),n.removeClass("droppable-child"),t._dropPosition="after"),e.preventDefault()}}).call(s,e)}),s.container.on("dragleave",function(e){if(a.drageEnterCount--,0==a.drageEnterCount){let t=r(e.currentTarget);p(t)}e.stopPropagation(),e.preventDefault()}),s.container.on("drop",function(e){(function(e,s){let a=this;e.preventDefault();let c=r(e.currentTarget);s.drageEnterCount=0,p(c);let d=null;try{let t=e.originalEvent.dataTransfer.types[0];if("Files"==t)return;d=e.originalEvent.dataTransfer.getData(t),d=UWA.is(d,"string")?JSON.parse(d):d}catch(e){return}a._dropPosition&&o.retrieveAuthorizedObjects({dnd_event:e.originalEvent,callback:function(e){if(e.authorized_objects.length>0)if(e.source_data.widgetId==widget.id)g.call(a,e,c);else{let o={id:e.authorized_objects[0].objectId,selectables:a.context.utilities.getSelectable()};n.getInfo(o).then(function(o){let r=UWA.is(o,"string")?JSON.parse(o):o,s=(r=r[0])["type.kindof"]?r["type.kindof"]:a.context.getDefaultType(r["ds6w:type"]);if("Requirement"==a.options.kindof&&"Requirement"==s&&"over"==a._dropPosition)a.createDerivationLink(d);else{let o=h.call(a,e,c,s);o?n.insertExisting(o).then(function(e){u.call(a,e)}):t.warningAlert(i.RichView_INSERT_FAILED)}})}else if(e.unauthorized_objects.length>0){let e=l.drop_unauthorizeRootType;t.warningAlert(e)}}})}).call(s,e,a),e.stopPropagation(),e.preventDefault()}),s.container.on("mousedown ",function(e){c=r(e.target)}),s.container.on("dragend",function(e){s._dragging=!1,s._draggingY=null,r(this).removeClass("being-dragged"),r(this).removeClass("droppable-child")})},disableDNDEvents:function(){this.container.off("drop"),this.container.off("dragenter"),this.container.off("dragover"),this.container.off("dragleave"),this.container.off("click"),this.container.off("mouseenter"),this.container.off("mouseover"),this.container.off("mouseleave"),this.container.off("mousedown"),this.container.off("dragstart"),this.container.off("dragend")}}}),define("DS/RichView/Utils/RichEditorBase",["UWA/Controls/Abstract","DS/RichView/Utils/RichViewDNDManager"],function(e,t){return e.extend({init:function(e){this.options=e,this.model=this.options.model,this.node=this.options.node,this.id=this.options.id,this.objectId=this.options.objectId,this.parentId=this.options.parentId,this.physicalId=this.options.physicalId,this.connection=this.options.connection,this.connectionId=this.options.connectionId,this.level=this.options.level,this.index=this.options.index,this.title=this.options.title,this.type=this.options.type,this.kindof=this.options.kindof,this.context=this.options.context,this.mediator=this.options.mediator,this.cestamp=this.options.cestamp},_subscribeToStopDnD:function(){let e=this;this.mediator.subscribe("onStopDnd",function(i){e._isDnD=!1,t.disableDNDEvents.call(e)})},_subscribeToStartDnD:function(){let e=this;this.mediator.subscribe("onStartDnd",function(i){e._isDnD=!0,t.initDNDEvents.call(e)})},createObject:function(){this._dragging=!1,this._isDnD=!1,this._dropPosition="",this._draggingY=null,this._subscribeToStopDnD(),this._subscribeToStartDnD(),this._subscribeToOnScroll()},_subscribeToOnScroll:function(){let e=this;this.mediator.subscribe("onScroll",function(t){e._scroll(t)})},_scrollElements:function(e){let i=this;if(i.isVisible(e.position)){if(i._isDnD)return!0;i._isDnD=!0,t.initDNDEvents.call(i)}else i._isDnD=!1,t.disableDNDEvents.call(i)},isVisible:function(){let e=this.context.contentPanel.height(),t=this.container.height(),i=this.container.position().top;return!!(i+t>0&&i<e)},hide:function(){this.container.hide()},show:function(){this.container.show()}})}),define("DS/RichView/Command/CreateLinkAction",["UWA/Class","DS/UIKIT/SuperModal","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/TraceableRequirementsUtils/utils/RequirementErrorManager","DS/TraceableRequirementsUtils/Utils","DS/PlatformAPI/PlatformAPI","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/REQCommandProxy","DS/Logger/Logger","DS/PADUtils/PADContext","i18n!DS/RichView/assets/nls/RichView","DS/TraceableRequirementsUtils/utils/TRMReportPanel","i18n!DS/RichView/assets/nls/CreateLinkAction","DS/RichView/Utils/LinkManagementValues","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,s,a,l,c,d,u,h,p,g){"use strict";var m=function(e){return'<div class="toggle create-link-options"><input type="radio" name="radios" id="radio'+e.index+'" value="'+e.rel+'"><label class="control-label" for "radio1">'+e.label+"</label></div>"},f="ENORERE_AP.StartLink",v=null,b=e.singleton({name:"CreateLinkCommand",context:null,defaultOptions:{renderTo:".content-panel",relationship:void 0},_superDlg:null,_commandProxy:null,_initialized:!1,_scopeId:null,_notifSMV:null,_widgetIdSMV:null,init:function(e){return v=this,this._logger=c.getLogger(b),this._logger.log("init"),UWA.merge(e||{},v.defaultOptions),this._parent(e),this.context=d.get(),this._commandProxy=new l,this.getScopeFromStorage(),this.subscribeToSMVContextModification(),this._initialized=!0,this},setStartLink:function(e){sessionStorage.removeItem(f),sessionStorage.setItem(f,JSON.stringify(e))},getStartLink:function(){var e=sessionStorage.getItem(f);return UWA.is(e,"string")?JSON.parse(e):e},getScopeFromStorage:function(){try{var e=JSON.parse(localStorage.getItem("TRA-current-scope")),t=v._formatMessage(e);v._onSMVContextChanged(t)}catch(e){v._logger.log("Failed to retrieve TRA-current-scope")}},subscribeToSMVContextModification:function(){UWA.is(v._notifSMV)||(v._logger.log("Subscribing to topic: DS/CATSmmUI/3DExperience/Proxy/contextChanged"),v._notifSMV=s.subscribe("DS/CATSmmUI/3DExperience/Proxy/contextChanged",function(e){v._onSMVContextChanged(e)})),!1===widget.hasEvent("onCheckScopeRV")&&widget.addEvent("onCheckScopeRV",function(e){v.getScopeFromStorage()})},_formatMessage:function(e){var t={resources:[],widgetId:e.widgetId};if(UWA.is(e.scope)&&UWA.is(e.scope.id)){var i=e.scope.id,n=e.scope.types,o=e.scope.title;t.resources.push({id:i,types:n,title:o})}return t},_onSMVContextChanged:function(e){var t=JSON.parse(localStorage.getItem("TRA-current-scope")),i=v._formatMessage(t);if(UWA.is(i.resources)&&i.resources.length>0){t=i.resources[0];UWA.is(t.types[0])&&"http://www.3ds.com/vocabularies/syc/type/Scope"===t.types[0]?v._setScope(t.id,i.widgetId,t.title):v._cleanScope()}else v._cleanScope()},_setScope:function(e,t,i){v._scopeId=e,v._widgetIdSMV=t,v.context.updateScopeInformation(i),v.context.setTraceabiltyScope(e,i)},_cleanScope:function(){v._scopeId=null,v._widgetIdSMV=null,v.context.updateScopeInformation(u.RichView_DefaultValue_None),v.context.setTraceabiltyScope(null,null)},execute:function(e){v._initUI(v.defaultOptions.renderTo),v.defaultOptions.to=e.to,v.defaultOptions.from=e.from,UWA.is(v._scopeId)?v._getScopeInformation():v._displayLinksManagementDialog()},_initUI:function(e){v._superDlg=new t({closable:!0,renderTo:UWA.Element.getElement.call(document,e)})},_getScopeInformation:function(){i.getScopeInformation({scopeId:v._scopeId,onComplete:function(e){v._logger.log("RequirementWebServices.getScopeInformation onComplete");var t=UWA.is(e,"string")?JSON.parse(e):e;v._checkScopeContent(t)},onFailure:function(){v._logger.log("RequirementWebServices.getScopeInformation onFailure"),v._displayLinksManagementDialog()},onTimeout:function(){v._logger.log("RequirementWebServices.getScopeInformation onTimeout"),v._displayLinksManagementDialog()}})},_checkScopeContent:function(e){for(var t=e.roots,i=e.links,n=!1,o=Object.keys(t),r=0;r<o.length;r++){var s=t[o[r]];if("http://www.3ds.com/vocabularies/syc/type/Enovia.Requirement%20Specification"===s.type){var a=s.id,l=a.substr(a.lastIndexOf("/")+1),c=v.defaultOptions.from.path[0],d=v.defaultOptions.to[0].path[0];const e=c.resourceid?c.resourceid:void 0,o=d.resourceid?d.resourceid:void 0;if(l===e){var u=s.outLinks;if(!0===(n=v._checkLinks(t,i,u,"to",o,g.TYPE_UPSTREAM_DERIVED_REQUIREMENT)))break;var h=s.inLinks;if(!0===(n=v._checkLinks(t,i,h,"from",o,g.TYPE_DERIVED_REQUIREMENT)))break}}}!0===n?v._createEndLink():v._displayLinksManagementDialog()},_checkLinks:function(e,t,i,n,o,r){for(var s=!1,a=0;a<i.length;a++){for(var l=t[i[a]][n],c=0;c<l.length;c++){var d=e[l[c]],u=d.id;if(u=u.substr(u.lastIndexOf("/")+1),"http://www.3ds.com/vocabularies/syc/type/Enovia.Requirement%20Specification"===d.type&&u===o){v.defaultOptions.relationship=r,s=!0;break}}if(!0===s)break}return s},_displayLinksManagementDialog:function(){var e=["Downstream Derived Requirement","Upstream Derived Requirement"],t=v.defaultOptions.to.typeNls?v.defaultOptions.to.typeNls:v.defaultOptions.to;if(null!=t&&null!=t&&0!=t.length){var i="<div>",n=(v.defaultOptions.from.typeNls?v.defaultOptions.from.typeNls:v.defaultOptions.from.type)+' "'+v.defaultOptions.from.title+'"';n=n.length>40?n.substr(0,39)+'..."':n;for(var o="",r=0;r<t.length;r++){t[r].type;o=o+" "+(t[r].typeNls?t[r].typeNls:"Requirements ")+' "'+v.defaultOptions.to[r].title+'" '}for(r=0;r<e.length;r++){var s=e[r];s=s.split(" ").join("_");var l=p[s="CreateLinkAction_"+s];l=(l=l.replace("{first_object}",n)).replace("{second_object}",o),i+=m({index:r,rel:e[r],label:l})}i+="</div>",v._superDlg.dialog({title:p.CreateLinkAction_SelectRelationship,body:a(i),buttons:[{value:p.CreateLinkAction_Cancel,action:function(e){v._cancel(e)}},{value:p.CreateLinkAction_Confirm,action:function(e){v._confirm(e)}}]}),a("input[name=radios]")[0].checked=!0}},_cancel:function(e){e.hide()},_confirm:function(e){v.defaultOptions.relationship=a("input[name=radios]:checked",e.elements.content).val(),e.hide(),v._createEndLink()},_createEndLink:function(){var e,t=null,a={version:2,dataArray:[]};v.defaultOptions.relationship===g.TYPE_DOWNSTREAM_DERIVED_REQUIREMENT?(g.TYPE_DOWNSTREAM_DERIVED_REQUIREMENT,e=v.defaultOptions.from.id,v.defaultOptions.to.forEach(t=>{a.dataArray.push({pid:e,id:t.id,relationship:g.TYPE_DERIVED_REQUIREMENT,previousSibling:{},nextSibling:{}})})):v.defaultOptions.relationship===g.TYPE_UPSTREAM_DERIVED_REQUIREMENT?(g.TYPE_UPSTREAM_DERIVED_REQUIREMENT,t=v.defaultOptions.from.id,v.defaultOptions.to.forEach(e=>{a.dataArray.push({pid:e.id,id:t,relationship:g.TYPE_DERIVED_REQUIREMENT,previousSibling:{},nextSibling:{}})})):(v.defaultOptions.relationship,e=v.defaultOptions.from.id,v.defaultOptions.to.forEach(t=>{a.dataArray.push({pid:e,id:t.id,relationship:g.TYPE_DERIVED_REQUIREMENT,previousSibling:{},nextSibling:{}})})),i.endLinkConnect({securityContext:r.getSecurityContext(),json:a,onComplete:function(e){var t=(e=UWA.is(e,"string")?JSON.parse(e):e).results;if(a.dataArray.length>1)v._multiLinkConnect(t);else{var i=p.CreateLinkAction_Success;t.Success.length>0?n.sucessAlert(p.CreateLinkAction_Success):(i=t.Failure[0].message,n.warningAlert(i))}v._publishLinkTraceabilityEvent(e),sessionStorage.removeItem(f),UWA.is(v._scopeId)&&setTimeout(function(){v._logger.log("Publish topic DS/CATSmmUI/3DExperience/Proxy/refresh"),s.publish("DS/CATSmmUI/3DExperience/Proxy/refresh",{resources:[v._scopeId+"/traceability_model"],widgetId:v._widgetIdSMV,clearCache:!0})},500)},onFailure:function(e,t){var i=o.getParseErrorMessage(e,t);n.errorAlert(i)},onTimeout:function(e){var t=o.getParseErrorMessage(e);n.errorAlert(t)}})},_multiLinkConnect:function(e){var t=[],i=[],n=v.defaultOptions.relationship===g.TYPE_UPSTREAM_DERIVED_REQUIREMENT?g.TYPE_LINK_COVERED:g.TYPE_LINK_REFINED;e.Success.length>0&&e.Success.forEach(function(e){var i=v.context.getPADTreeDocument().getNodesById(e.physicalid)[0],n=v._getLinkReportPanelDetails(i);t.push(n)}),e.Failure.length>0&&e.Failure.forEach(function(e){var t="covered"===n?e["from.physicalid"]:e["to.physicalid"],o=v.context.getPADTreeDocument().getNodesById(t)[0],r=v._getLinkReportPanelDetails(o);r.errorMsg=e.message+" for <strong>{TNR}</strong>",i.push(r)}),new h({title:"LinkCreation",reportData:{Success:t,Failure:i},hasMsgFromAPI:!0})},_publishLinkTraceabilityEvent:function(e){var t=widget.getUrl();t=t.substr(0,t.indexOf("/webapps"));e.results.Success;let i=[];i.push(v.defaultOptions.from.id);for(var n=0;n<v.defaultOptions.to.length;n++)i.push(v.defaultOptions.to[n].id);v._commandProxy.traceabilityAuthoring({objectIds:i,appId:widget.getValue("appId")})},_getLinkReportPanelDetails:function(e){var t={};return t.type=e.getType(),t.title=e.getLabel(),t.name=e.options.name,t.revision=e.options.revision,t}});return b}),define("DS/RichView/Command/CtxMenu_EndLinkCmd",["DS/ApplicationFrame/Command","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/RichView/Command/CreateLinkAction","i18n!DS/RichView/assets/nls/CreateLinkAction"],function(e,t,i,n){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this._container=e.container,this.mediator=e.mediator,this.TOPIC_NAME="ENORERE_AP.StartLink",i._initialized||i.init({renderTo:this._container})},execute:function(e){var o=sessionStorage.getItem(this.TOPIC_NAME),r=UWA.is(o,"string")?JSON.parse(o):o;if(null!=r&&null!=r&&""!==r){for(var s=Array(),a=Array(),l=!1,c=0;c<e.length;c++){var d=e[c];if(d.physicalId==r.physicalId)l=!0;else if("Requirement"===d.kindof){var u={id:d.physicalId,type:d.type,typeNls:d.typeNls,kindof:d.kindof,path:d.path,title:d.title};s.push(u)}else a.push(d.title)}if(0!=a.length){var h="<h6>Excluded objects: Not the attributes of Requirement</h6> "+a.join(", ");t.sucessAlert(h)}if(l){h="Bad circular reference";t.sucessAlert(h)}var p={from:{id:r.physicalId,type:r.type,typeNls:r.typeNls,kindof:r.kindof,path:r.path,title:r.title},to:s};i.execute(p)}else t.errorAlert(n.CreateLinkAction_StartLink_Not_Found)}})}),define("DS/RichView/Command/DeleteLinkAction",["UWA/Class","DS/UIKIT/Input/Button","DS/UIKIT/Badge","DS/UIKIT/Scroller","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/UIKIT/Tooltip","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/REQCommandProxy","DS/RichView/RichContentEditor","DS/PADUtils/PADContext","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/TraceableRequirementsUtils/utils/RequirementErrorManager","i18n!DS/RichView/assets/nls/RichView","DS/TraceableRequirementsUtils/utils/RequirementNlsMgt","DS/RichView/Utils/RichviewConstant","DS/TraceableRequirementsUtils/utils/TRMReportPanel","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,s,a,l,c,d,u,h,p,g,m,f,v,b,_,y){"use strict";var R=null,C={},E=[],I=[],S=[],x=e.singleton({name:"DeletLinkAction",defaultOptions:{renderTo:".main-panel",mediator:null},_superModal:null,mediator:null,context:null,container:null,_logger:null,_commandProxy:null,_initialized:!1,_scopeId:null,_notifSMV:null,_widgetIdSMV:null,_onLoadingUI:!1,init:function(e){return R=this,this._logger=l.getLogger(x),this._logger.log("init"),this._parent(e),this.mediator=e.mediator,this.context=g.get(),this.defaultOptions.renderTo=e.renderTo,this.subscribeToSMVContextModification(),this._commandProxy=new h,this._initialized=!0,this._getLinkStatusNLS(),this},_getLinkStatusNLS:function(){0===Object.keys(C).length&&d.getAttributeRange({securityContext:u.getSecurityContext(),attributeName:"Link Status",onComplete:function(e){var t=UWA.is(e,"string")?JSON.parse(e):e,i=UWA.is(t.results[0],"string")?JSON.parse(t.results[0]):t.results[0];C=Object.keys(i).reduce((e,t)=>Object.assign({},e,{[i[t]]:t}),{})},onFailure:function(e){var t=f.getParseErrorMessage(e);m.errorAlert(t)},onTimeout:function(e){R._logger.log("RequirementWebServices.getInfo timed out");var t=f.getParseErrorMessage(e);m.errorAlert(t)}})},subscribeToSMVContextModification:function(){UWA.is(R._notifSMV)||(R._logger.log("Subscribing to topic: DS/CATSmmUI/3DExperience/Proxy/contextChanged"),R._notifSMV=c.subscribe("DS/CATSmmUI/3DExperience/Proxy/contextChanged",function(e){R._onSMVContextChanged(e)}))},_formatMessage:function(e){var t={resources:[],widgetId:e.widgetId};if(UWA.is(e.scope)&&UWA.is(e.scope.id)){var i=e.scope.id,n=e.scope.types,o=e.scope.title;t.resources.push({id:i,types:n,title:o})}return t},_onSMVContextChanged:function(e){var t=JSON.parse(localStorage.getItem("TRA-current-scope")),i=R._formatMessage(t);if(UWA.is(i.resources)&&i.resources.length>0){t=i.resources[0];UWA.is(t.types[0])&&"http://www.3ds.com/vocabularies/syc/type/Scope"===t.types[0]?(R._scopeId=t.id,R._widgetIdSMV=i.widgetId):(R._scopeId=null,R._widgetIdSMV=null)}else R._scopeId=null,R._widgetIdSMV=null},_getRequestPayload:function(e,t,i){return R=this,{root_physical_id:i,type_filter:[_.TYPE_REQUIREMENT],rel_filter:[_.TYPE_DERIEVED_REQUIREMENT],select_level:"1",object_selects:["type","name","revision","physicalid","type.kindof","attribute[Title]","attribute[Content Data]","attribute[Content Type]"],relationship_selects:["physicalid[connection]","attribute[TreeOrder]","type[connection]","attribute[Link Status]"],navigate_from_rel:e,navigate_to_rel:t,level:"1"}},execute:function(e){if(!this._onLoadingUI){this._onLoadingUI=!0;var t=e.physicalid;R.defaultOptions.physicalid=e.physicalid,R.defaultOptions.name=e.name,R.defaultOptions.type=e.type,R.linkRelIDToNodeInfo=new Map,E=[],I=[],(S=[]).push(t);var i=R._getRequestPayload("true","false",t);d.expand({json:i,authored:!0,onComplete:function(e){e=u.parseResponse(e);var i=UWA.is(e,"string")?JSON.parse(e):e;E=i.results,R._prepareMapForDetach(E);var n=R._getRequestPayload("false","true",t);d.expand({json:n,authored:!0,onComplete:function(e){e=u.parseResponse(e);var t=UWA.is(e,"string")?JSON.parse(e):e;I=t.results,R._prepareMapForDetach(I),R._buildDialog(I,E)},onFailure:function(e){var t=f.getParseErrorMessage(e);m.errorAlert(t)},onTimeout:function(e){R._logger.log("RequirementWebServices.getInfo timed out");var t=f.getParseErrorMessage(e);m.errorAlert(t)}})},onFailure:function(e){var t=f.getParseErrorMessage(e);m.errorAlert(t)},onTimeout:function(e){R._logger.log("RequirementWebServices.getInfo timed out");var t=f.getParseErrorMessage(e);m.errorAlert(t)}})}},_buildDialog:function(e,t){var i=_.Type_Attr,n=R.defaultOptions.type,o={[i]:[n]};b.retrieveNLS({nlsData:o}).then(function(o){R.defaultOptions.type=o[i][n],R._buildDialogBody(e,t)}).catch(function(){R._buildDialogBody(e,t)})},_buildDialogBody:function(e,i){var o=R.defaultOptions.type+" "+R.defaultOptions.name,r=v.DeleteLinkAction_ToHeader;r=r.replace("{TNR}",o);var s=v.DeleteLinkAction_FromHeader;s=s.replace("{TNR}",o),R._footer=UWA.createElement("div"),R._cancelButton=new t({value:v.DeleteLinkAction_Cancel,name:"cancel_button"}),R._cancelButton.addEvents({onClick:function(e){R._onCancel(e)}}),R._deleteButton=new t({value:v.DeleteLinkAction_Delete,name:"delete_button",className:"primary",disabled:!0}),R._deleteButton.addEvents({onClick:function(e){R._onDelete(e)}}),R._deleteButton.inject(R._footer),R._cancelButton.inject(R._footer),R._dialogBody=UWA.createElement("div",{class:"delete-link-dialog",id:"dlg_"+R.defaultOptions.physicalid}),R._refinedSection=UWA.createElement("div",{id:"section_refined"}),R._refinedSectionHeader=UWA.createElement("h4",{text:r}),R._refinedSectionHeader.inject(R._refinedSection),R._coveredSection=UWA.createElement("div",{id:"section_covered"}),R._coveredSectionHeader=UWA.createElement("h4",{text:s}),R._coveredSectionHeader.inject(R._coveredSection),R._noRefinedLinks=UWA.createElement("h5",{class:"no-link",text:v.DeleteLinkAction_NoLinkFound}),R._noCoveredLinks=UWA.createElement("h5",{class:"no-link",text:v.DeleteLinkAction_NoLinkFound}),i.length>0?R._buildSection(i,R._refinedSection):R._noRefinedLinks.inject(R._refinedSection),e.length>0?R._buildSection(e,R._coveredSection):R._noCoveredLinks.inject(R._coveredSection),new p({mediator:R.mediator,selector:".delete-link-content",target:".content-data"}).startEditionForAll(),0===e.length&&0===i.length&&R._deleteButton.disable(),R._refinedSection.inject(R._dialogBody),R._coveredSection.inject(R._dialogBody),R._floatingComponent=new a({className:"DeleteLinkModal",title:v.DeleteLinkAction_DeleteLinks,body:R._dialogBody,footer:R._footer,overlay:!0,closable:!0,animate:!0,autocenter:!0,resizable:!0,events:{onResizeFloating:function(){R._logger.log("onResizeFloating")},onClose:function(){R._logger.log("onClose"),R._onCancel(R._floatingComponent)}}}).inject(UWA.Element.getElement.call(document,R.defaultOptions.renderTo)),R._floatingComponent.show(),new n({element:UWA.Element.getElement.call(R._floatingComponent.getBody(),".delete-link-dialog")})},_buildSection:function(e,t){for(var n=0;n<e.length;n++){var r=e[n],a=null,l=!1,c=r.physicalid?r.physicalid:r.resourceid;if(UWA.is(this.context)&&0!=this.context.options.model.getNodesById(c).length&&(l=!!UWA.is(this.context)&&this.context.options.model.getNodesById(c)[0].options.externalObject),widget&&widget.displayNameSettings){var d=widget.displayNameSettings[r.type]||widget.displayNameSettings[r["type.kindof"]];UWA.is(d)&&(a=u.computeDisplayName({name:r["ds6w:identifier"],title:r["ds6w:label"],revision:r["ds6wg:revision"]},d),a=R._decodeHtml(a))}UWA.is(a)||(a=r["ds6w:label"],a=R._decodeHtml(a));var h=r["attribute[Link Status]"];0===Object.keys(C).length&&this._getLinkStatusNLS();var p=C[h];if(r.resourceid!==R.defaultOptions.physicalid){var g=UWA.createElement("div",{class:"delete-link-object",id:r.relationid+"_rel","data-physicalid":r.resourceid}),m=UWA.createElement("div",{id:r.relationid+"_toggle"}),f=UWA.createElement("div",{class:"delete-link-content"}),b=UWA.createElement("div",{class:"delete-link-data"}),_="";_="Requirement Proxy"===r.type.value?v.ExternalObject_DisplayContent:R._decodeHtml(r["ds6wg:contentData"]);var y=UWA.createElement("div",{class:"content-data",id:r.relationid+"_data","data-physicalid":r.resourceid,contenteditable:!1,html:_});"Requirement Proxy"===r.type.value&&y.addEventListener("click",function(e){R._getProxyContentData(this,e)});var E,I=new o({type:"checkbox",value:r.relationid,label:a,checked:!1});switch(I.addEvents({onClick:function(e){0==jQuery("input:checkbox:checked",R._floatingComponent.elements.content).closest(".delete-link-object").length?R._deleteButton.setDisabled(!0):R._deleteButton.setDisabled(!1)}}),y.inject(b),b.inject(f),I.inject(m),m.inject(g),f.inject(g),h){case"Invalid":E="error";break;case"Suspect":E="warning";break;case"Valid":E="success"}var S=new i({id:r.relationid+"_statusLabel",content:p,className:"linkStatus "+E,selectable:!0});new s({target:S.getContent(),body:"Click here to update the status",position:"top"}),S.addEvents({onClick:function(e){var t,i;t=e.target.id,i=e.target.parentElement.parentElement.id,""!=t&&"undefined"!=t&&"null"!=t||(t=e.target.parentElement.id.split("_")[0],i=e.target.parentElement.parentElement.parentElement.id.split("_")[0]);var n=jQuery("#"+t+"_statusLabel").find(".badge-content").text().trim();R._updateUIElem(t,i,I,n)}}),g.inject(t),l?jQuery(I.getContent()).find(".control-label").prepend('<span class="trm-icon trm-icon-requirement-proxy"></span>'):jQuery(I.getContent()).find(".control-label").prepend('<span class="trm-icon trm-icon-requirement"></span>'),jQuery(I.getContent()).append(S.getContent())}}},_updateUIElem:function(e,t,i,n){jQuery("#"+e+"_statusLabel").hide();var o=t+"_statusComboBox",s=new r({placeholder:!1,className:"linkStatus small",id:o});R._getRelationshipStatus(o,s,n),jQuery("#"+t+"_toggle").find(".toggle.toggle-root").append(s.getContent()),jQuery("#"+t+"_statusComboBox").focus(),jQuery("#"+t+"_statusComboBox").focusout(function(){jQuery("#"+e+"_statusLabel").show(),jQuery("#"+e+"_toggle").find(".toggle.toggle-root").find(".select").remove()})},_getRelationshipStatus:function(e,t,i){e.split("_")[0];var n=C;jQuery.each(n,function(e,n){var o={};o[0]=e.trim(),o[1]=n.trim(),i==o[0]||i==o[1]?t.add({value:o[0],label:o[1],selected:!0}):t.add({value:o[0],label:o[1]})}),t.addEvents({onChange:function(e){var t=e.target.value,i=e.target.options[e.target.selectedIndex].text,n=e.target.id;R._updateLinkStatus(n,t,i)}})},_updateLinkStatus:function(e,t,i){var n=e.split("_")[0];d.editRelationAttributes({pid:n,securityContext:u.getSecurityContext(),json:{attribute:{name:"Link Status",value:t}},onComplete:function(e){jQuery("#"+n+"_toggle").find(".toggle.toggle-root").find(".select").remove(),jQuery("#"+n+"_statusLabel").find(".badge-content").text(i),jQuery("#"+n+"_statusLabel").show(),R._updateBackGroundColor(n,t);let o=jQuery("#"+n+"_rel")[0].attributes["data-physicalid"].value;R._updateLinkStatusColumn(o)},onFailure:function(e,t){var i=f.getParseErrorMessage(e,t);m.errorAlert(i)},onTimeout:function(e){R._logger.log("RequirementWebServices.getInfo timed out");var t=f.getParseErrorMessage(e);m.errorAlert(t)}})},_updateLinkStatusColumn:function(e){S.push(e),R._commandProxy.traceabilityAuthoring({objectIds:S,appId:widget.getValue("appId")}),S.pop()},_updateBackGroundColor:function(e,t){var i=jQuery("#"+e+"_statusLabel");i.find(".badge-content").text().trim();switch(t){case"Invalid":i.removeClass("badge-warning badge-error badge-success"),i.addClass("badge-error");break;case"Suspect":i.removeClass("badge-warning badge-error badge-success"),i.addClass("badge-warning");break;case"Valid":i.removeClass("badge-warning badge-error badge-success"),i.addClass("badge-success")}},_onCancel:function(){R._onLoadingUI=!1,R._logger.log("onCancel"),R._floatingComponent.hide(),R._floatingComponent.destroy()},_onDelete:function(){R._onLoadingUI=!1,R._logger.log("onDelete");for(var e=jQuery("input:checkbox:checked",R._floatingComponent.elements.content),t=e.closest(".delete-link-object"),i=[],n=0;n<t.length;n++)i.push(t[n].parentElement);R._floatingComponent.hide(),R._floatingComponent.destroy(),R._deleteLink(e,t,i)},_deleteLink:function(e,t,i){R._logger.log("_deleteLink");for(var n=[],o=0;o<e.length;o++)n.push(e[o].value),S.push(t[o].dataset.physicalid);d.detach({securityContext:u.getSecurityContext(),json:{relationship_physical_ids:n},onComplete:function(e){const t=(UWA.is(e,"string")?JSON.parse(e):e).results;R._handleLinkDetachNotification(n,t),R._commandProxy.traceabilityAuthoring({objectIds:S,appId:widget.getValue("appId")}),UWA.is(R._scopeId)&&setTimeout(function(){R._logger.log("Publish topic DS/CATSmmUI/3DExperience/Proxy/refresh"),c.publish("DS/CATSmmUI/3DExperience/Proxy/refresh",{resources:[R._scopeId+"/traceability_model"],widgetId:R._widgetIdSMV,clearCache:!0})},500)},onFailure:function(e,t){var i=f.getParseErrorMessage(e,t);m.errorAlert(i)},onTimeout:function(e){R._logger.log("RequirementWebServices.getInfo timed out");var t=f.getParseErrorMessage(e);m.errorAlert(t)}})},_handleLinkDetachNotification:function(e,t){if(!e||!t)return;let i=[],n=[];if(e.length>1){t.Success.length>0&&t.Success.forEach(e=>{const t=R.linkRelIDToNodeInfo.get(e)||{};let n=R._getLinkReportPanelDetails(t);i.push(n)}),t.Fail.length>0&&t.Fail.forEach(e=>{const i=R.linkRelIDToNodeInfo.get(e)||{},o=R._getLinkReportPanelDetails(i);o.errorMsg=`<strong> ${o.type} ${o.name} ${o.revision} : </strong> ${t.FailMessages[e]}`,n.push(o)}),new y({title:"LinkDetach",reportData:{Success:i,Failure:n},hasMsgFromAPI:!0})}else if(t.Success.length>0)m.sucessAlert(v.DeleteLinkAction_Success);else{let[e]=t.Fail;m.errorAlert(t.FailMessages[e])}},_decodeHtml:function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value},_getProxyContentData:function(e,t){var i=this,n=this.context.OSLCProviders;d.getInfo({securityContext:u.getSecurityContext(),pid:e.attributes["data-physicalid"].value,onComplete:function(e){e=u.parseResponse(e);var o=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0],r=o["ProxyItem.Proxy_Service"],s=o["ProxyItem.Proxy_URL"],a="",l="";if(UWA.is(n)){for(var c=0;c<n.repositories.length;c++){r===n.repositories[c].id&&(a=n.repositories[c].rootUrl,l=n.repositories[c].oauth);break}d.getOSLCContent({service:r,doors_url:a+s,tenant:u.getTenant(),Oauth:l,method:"GET",onComplete:function(e){var i=t.target,n=(e=jQuery(jQuery.parseXML(e)))[0].getElementsByTagNameNS(e[0].lookupNamespaceURI("jazz_rm"),"primaryText");if(n[0].childNodes[0].childNodes.length>0){for(var o=n[0].childNodes[0].childNodes,r="",s=0;s<o.length;s++)UWA.is(o[s].innerText)&&(r+=" "+o[s].innerText);i.innerText=r}else n=e[0].getElementsByTagName("dcterms:description"),i.innerText=n[0].innerHTML;console.log(e)},onFailure:function(e){i._logger.log(e);var t=f.getParseErrorMessage(e);m.errorAlert(t)},onTimeout:function(e){var t=f.getParseErrorMessage(e);m.errorAlert(t)}})}},onFailure:function(e){i._logger.log(e);var t=f.getParseErrorMessage(e);m.errorAlert(t)},onTimeout:function(e){i._logger.log("RequirementWebServices.getInfo timed out");var t=f.getParseErrorMessage(e);m.errorAlert(t)}})},_prepareMapForDetach:function(e){e&&e.length&&e.forEach(e=>{R.linkRelIDToNodeInfo.set(e.relationid,e)})},_getLinkReportPanelDetails:function(e){const t={};return t.type=e.type,t.title=e.label,t.name=e.name,t.revision=e["ds6wg:revision"],t}});return x}),define("DS/RichView/Service/ContextualMenu",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/ApplicationFrame/CommandsManager","DS/WebappsUtils/WebappsUtils","DS/TraceableRequirementsUtils/Utils","DS/PADUtils/PADContext","DS/RichView/Command/CtxMenu_StartLinkCmd","DS/RichView/Command/CtxMenu_EndLinkCmd","DS/RichView/Command/DeleteLinkAction","i18n!DS/RichView/assets/nls/RichView"],function(e,t,i,n,o,r,s,a,l,c,d,u){"use strict";var h=null,p=t.extend({model:null,_logger:void 0,mediator:null,init:function(e){h=this,this.model=e.model,this._logger=i.getLogger(p),this.menu_container=e.container,this.menu_id=e.id+"_menu",this.kindof=e.kindof,this.root=e.root,this.mediator=e.mediator,this.type=e.type,this.externalProviders=e.externalProviders,UWA.is(e.externalObject)?this.externalObject=e.externalObject:this.externalObject=!1,this._initTraceabilityCmd()},_initTraceabilityCmd:function(){this.StartLinkCmd=new l({ID:"StartLink_ctx"}),this.EndLinkCmd=new c({ID:"EndLink_ctx",container:".content-panel"}),d._initialized||d.init({renderTo:".main-panel",mediator:h.mediator})},inject:function(){var e=this.menu_container,t=this.menu_id,i=this._getContextualMenu(this.kindof,this.root),o=this._callbacks(i),r=new n({value:"",dropdownCaret:!1,removeOnHide:!0,id:t,className:"link",icon:"fonticon fonticon-menu-dot",dropdown:{className:"richview-menu",items:i,events:{onClick:function(e,t){var i=a.get().getSelectedNode().getRichViewElement(),n=o[t.name];n&&n.call(null,i)}}},events:{onClick:function(e){var t;if(UWA.is(this.elements.container.closest))t=this.elements.container.closest(".rich-object,.rich-container").id;else{t=function(e,t,i,n,o){for(var r=e.parentNode;r.className!=t&&r.className!=i&&r.className!=n&&r.className!=o;)r=r.parentNode;return r.id}(this.elements.container,"rich-object  right-border","rich-container  right-border","rich-container ","rich-container")}var i=h.model.getNodesByElementID(t)[0].getRichViewElement();i.container.hasClass("active")||(i.info.click(),!1===r.dropdown.isVisible&&r.dropdown.show())}}}).inject(e)},_getContextualMenu:function(e,t){var i=[];switch(e){case"Requirement":i=this.externalObject?this._getExternalRequirementMenu():this._getRequirementMenu(t);break;case"Comment":i=this._getCommentMenu();break;case"Chapter":i=this._getChapterMenu();break;default:i=this._getDefaultMenu()}return i},_getRequirementMenu:function(e){var t=[];return e||(t.push({name:"addChapter",text:u.AddChapter,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter")+".png",data:"",callback:this._addChapterCommand.bind(this)}),t.push({name:"addRequirement",text:u.AddRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement")+".png",data:"",callback:this._addRequirementCommand.bind(this)}),t.push({name:"addComment",text:u.AddComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment")+".png",data:"",callback:this._addCommentCommand.bind(this)})),t.push({className:"divider"}),t.push({name:"insertRequirement",text:u.InsertRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",data:"",callback:this._insertRequirementCommand.bind(this)}),this.externalProviders&&t.push({text:u.InsertNewExtReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",items:[{name:"CreateExternalSubRequirement",text:u.ExternalSubReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",callback:this._createExternalSubRequirementCommand.bind(this)},{name:"CreateExternalDerRequirement",text:u.ExternalDerivedReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",callback:this._createExternalDerRequirementCommand.bind(this)}]}),t.push({name:"insertExistingRequirement",text:u.InsertExistingRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertExisting")+".png",data:"",callback:this._insertInsertExistingRequirementCommand.bind(this)}),this.externalProviders&&t.push({text:u.InsertExistExtReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",items:[{name:"insertExternalSubRequirement",text:u.ExternalSubReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",callback:this._insertExternalSubRequirementCommand.bind(this)},{name:"InsertExternalDerRequirement",text:u.ExternalDerivedReq,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",callback:this._insertExternalDerRequirementCommand.bind(this)}]}),t.push({className:"divider"}),t.push({name:"startLink",text:u.RichView_Cmd_StartLink,icon:r.getWebappsAssetUrl("RichView","icons/32/DerivedRequirementStartLink")+".png",data:"",callback:this._startLink.bind(this)}),t.push({name:"endLink",text:u.RichView_Cmd_EndLink,icon:r.getWebappsAssetUrl("RichView","icons/32/DerivedRequirementEndLink")+".png",data:"",callback:this._endLink.bind(this)}),t.push({name:"linkManagement",text:u.RichView_Cmd_DeleteLink,icon:"",data:"",callback:this._linkManagement.bind(this)}),t.push({className:"divider"}),t=t.concat(this._getDefaultMenu(e))},_getExternalRequirementMenu:function(){var e=this._getDefaultMenu();return e.push({name:"addRequirement",text:u.AddRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement")+".png",data:"",callback:this._addRequirementCommand.bind(this)}),e},_getCommentMenu:function(){var e=[];return e.push({name:"addChapter",text:u.AddChapter,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter")+".png",callback:this._addChapterCommand.bind(this)}),e.push({name:"addRequirement",text:u.AddRequirement,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement")+".png",callback:this._addRequirementCommand.bind(this)}),e.push({name:"addComment",text:u.AddComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment")+".png",data:"",callback:this._addCommentCommand.bind(this)}),e.push({className:"divider"}),e=e.concat(this._getDefaultMenu())},_getChapterMenu:function(){var e=[];return e.push({name:"addChapter",text:u.AddChapter,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewChapter")+".png",callback:this._addChapterCommand.bind(this)}),e.push({name:"addRequirement",text:u.AddRequirement,data:"",icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewRequirement")+".png",callback:this._addRequirementCommand.bind(this)}),e.push({name:"addComment",text:u.AddComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertNewComment")+".png",data:"",callback:this._addCommentCommand.bind(this)}),e.push({className:"divider"}),e.push({name:"insertChapter",text:u.InsertChapter,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubChapter")+".png",data:"",callback:this._insertChapterCommand.bind(this)}),e.push({name:"insertRequirement",text:u.InsertRequirement,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubReq")+".png",data:"",callback:this._insertRequirementCommand.bind(this)}),e.push({name:"insertComment",text:u.InsertComment,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertSubComment")+".png",data:"",callback:this._insertCommentCommand.bind(this)}),e.push({name:"insertExisting",text:u.InsertExisting,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdInsertExistingObject")+".png",data:"",callback:this._insertInsertExistingCommand.bind(this)}),e.push({className:"divider"}),e=e.concat(this._getDefaultMenu())},_getDefaultMenu:function(e){var t=[];return e||t.push({name:"detach",text:u.RichView_Cmd_Detach,icon:r.getWebappsAssetUrl("RichView","icons/32/iconReqCmdDetach")+".png",data:"",callback:this._detach.bind(this)}),t.push({name:"properties",text:u.RichView_Cmd_Properties,icon:r.getWebappsAssetUrl("RichView","icons/32/I_CATSSEditorDisplayProperties")+".png",data:"",callback:this._editProperties.bind(this)}),t},_addRequirementCommand:function(){this._launchAction({command:"AddNewRequirement"})},_addChapterCommand:function(){this._launchAction({command:"AddNewChapter"})},_addCommentCommand:function(){this._launchAction({command:"AddNewComment"})},_insertRequirementCommand:function(){this._logger.log("_insertRequirement"),this._launchAction({command:"InsertRequirement"})},_insertChapterCommand:function(){this._logger.log("_insertRequirement"),this._launchAction({command:"InsertChapter"})},_insertCommentCommand:function(){this._logger.log("_insertComment"),this._launchAction({command:"InsertComment"})},_insertInsertExistingCommand:function(){this._logger.log("_insertInsertExistingCommand"),this._launchAction({command:"InsertExisting"})},_insertInsertExistingRequirementCommand:function(){this._logger.log("_insertInsertExistingRequirementCommand"),this._launchAction({command:"InsertExistingRequirement"})},_insertExternalSubRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"InsertExternalSubRequirement"})},_insertExternalDerRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"InsertExternalDerRequirement"})},_createExternalSubRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"CreateExternalSubRequirement"})},_createExternalDerRequirementCommand:function(){this._logger.log("_insertExternalRequirement"),this._launchAction({command:"CreateExternalDerRequirement"})},_startLink:function(e){this._logger.log("_startLink");var t=h.model.getNodesByElementID(e.id)[0].getOccurencePathWithType(null,!0),i={id:e.objectId,physicalId:e.physicalId,type:e.type,kindof:e.kindof,path:t,title:e.title};this.StartLinkCmd.execute(i)},_endLink:function(e){var t=a.get().getSelectedNodes();if(this._endLinkCmd=new c({container:".pad_view_container"}),null!=t&&null!=t&&0!=t.length){for(var i=Array(),n=0;n<t.length;n++){var o=t[n],r="";o.options.hasOwnProperty("kindof")?r=o.options.kindof:o.options.hasOwnProperty("reqKindOf")&&(r=o.options.reqKindOf);o.getID();var s=o.getID(),l=o.options.grid["ds6w:type"],d={id:s,physicalId:s,type:o.options.type,typeNls:l,kindof:r,path:o.getOccurencePathWithType(null,!0),title:o.options.label};i.push(d)}this.EndLinkCmd.execute(i)}},_linkManagement:function(e){this._logger.log("_linkManagement"),e.title=s._decodeHTML(e.title),d.execute({physicalid:e.physicalId,name:e.title,type:e.type})},_editProperties:function(){this._logger.log("_editProperties"),this._launchAction({command:"ActionBar_Attributes"})},_detach:function(){this._logger.log("_detach"),this._launchAction({command:"Detach"})},_launchAction:function(e){this._logger.log("_launchAction");var t=o.getCommand(e.command);t&&t.begin()},_callbacks:function(e){for(var t={},i=0;i<e.length;i++){var n=e[i];if(t[n.name]=n.callback,UWA.is(n.items))for(var o=0;o<n.items.length;o++){var r=n.items[o];t[r.name]=r.callback}}return t}});return p}),define("DS/RichView/Views/RichObject",["DS/RichView/Utils/RichEditorBase","UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/RichView/Service/ContextualMenu","DS/RichView/Command/CtxMenu_StartLinkCmd","DS/RichView/Command/CtxMenu_EndLinkCmd","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/TraceableRequirementsUtils/utils/RequirementErrorManager","i18n!DS/RichEditor/assets/nls/RichEditor","DS/Logger/Logger","DS/UIKIT/Mask","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,s,a,l,c,d,u,h,p,g){"use strict";let m=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;var f=function(e){var t;t=e.type_icon_url?'<span class="object-link"><span class="trm-icon" ><img width="18" height="18" src="'+e.type_icon_url+'" onerror="this.onerror=null;"></span> ':'<span class="object-link"><span class="trm-icon trm-icon-'+e.icon+'"></span> ';var i='<span class="rich-object-header-content">';UWA.is(e.externalObject)&&e.externalObject&&(e.icon="requirement-proxy");var n="";return n=widget.getValue("trm_richview_DisableAutoNumbering")?'<span class="rich-object-container-index" style="display: none;"> '+e.containerIdx+' - </span><span class="rich-object-index" style="display: none;"> '+e.index+"  </span>":'<span class="rich-object-container-index"> '+e.containerIdx+' - </span><span class="rich-object-index"> '+e.index+"  </span>","Sub Requirement"===e.connection?i+=n+'<span class="fonticon fonticon-level-down"></span>'+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span></span></span>":i+=n+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span></span></span>",a(i)},v=function(e){var t,i,n=" right-border";return m&&(n=""),UWA.is(e.externalObject)&&e.externalObject&&(e.icon="requirement-proxy"),t=e.type_icon_url?'<span class="object-link"><span class="trm-icon" ><img width="18" height="18" src="'+e.type_icon_url+'" onerror="this.onerror=null;"></span> ':'<span class="object-link"><span class="trm-icon trm-icon-'+e.icon+'"></span> ','<div id="'+e.id+'" draggable="true" data-objectid="'+e.objectId+'" data-level="'+e.level+'" data-physicalid="'+e.physicalId+'" data-relid="'+e.connectionId+'" class="rich-object '+e.className+n+'"><div class="rich-object-info"></div><div class="rich-content"><div id="'+e.id+'_header" class="rich-object-header"><span class="rich-object-menu"></span><span class="rich-object-header-content">'+(i="",i=widget.getValue("trm_richview_DisableAutoNumbering")?'<span class="rich-object-container-index rich-container-hidden-numbering"> '+e.containerIdx+' - </span><span class="rich-object-index rich-container-hidden-numbering"> '+e.index+"  </span>":'<span class="rich-object-container-index"> '+e.containerIdx+' - </span><span class="rich-object-index"> '+e.index+"  </span>","Sub Requirement"===e.connection?i+'<span class="fonticon fonticon-level-down"></span><span class="object-link">'+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>":i+t+'<span><div id="'+e.id+'_title_content" class="rich-object-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>")+'</span></span></div><div class="rich-object-body"><div class="rich-object-content"><div id="'+e.id+'_content" contenteditable="'+e.editable+'" class="content-data">'+e.content+'</div><div style="display:none;"  id="'+e.id+'_placeholder"></div></div></div></div></div></div>'},b=e.extend(t,i,n,{defaultOptions:{model:null,node:null,rootId:null,mediator:null,id:null,objectId:null,physicalId:null,type:"",kindof:"",title:"",containerIdx:"",index:"",content:"",connection:"",connectionId:null,parentId:null,level:0,editable:"true",droppable:null,placeholder:!1,defaultType:"Requirement",fetchContent:!1,context:null,isDocx:!1,underCA:!1,changeid:"",format:"html",isHTMLReady:!0,convertBeforeEdit:!1,bi_color:null,containerType:"rich-object"},model:null,node:null,id:null,objectId:null,parentId:null,physicalId:null,connection:null,connectionId:null,level:null,index:null,containerIdx:null,title:null,container:null,info:null,content:null,header:null,menu:null,type:null,kindof:null,context:null,mediator:null,traceabilityAuthoring:!0,isHTMLReady:!0,isDocx:!1,underCA:!1,changeid:"",format:"html",convertBeforeEdit:!1,init:function(e){this._logger=p.getLogger(b),this._logger.log("init"),UWA.merge(e||{},this.defaultOptions),this._parent(e),this.containerIdx=this.options.containerIdx;var t=!1;UWA.is(this.node)&&UWA.is(this.node._options)&&(t=this.node._options.externalObject),this.container=a(v({icon:this.options.kindof.toLowerCase(),title:this.options.title.escapeHTML(),type_icon_url:this.options.type_icon_url,containerIdx:this.options.containerIdx,index:this.options.index,connection:this.options.connection,level:this.options.level,externalObject:t,id:this.options.id,editable:this.options.editable,content:this.options.content,objectId:this.options.objectId,physicalId:this.options.physicalId,connectionId:this.options.connectionId,type:this.options.type,className:!0===this.options.placeholder?"placeholder":""})),this.menu=this.container.find(".rich-object-menu"),this.info=this.container.find(".rich-object-info"),this.content=this.container.find(".rich-object-content"),this.body=this.container.find(".rich-object-body"),this.header_content=this.container.find(".rich-object-header-content"),this.header=this.container.find(".rich-object-header"),this._menuAttached=!1},create:function(){return!0===this.options.placeholder?this:(this.createObject(),this.node.setRichViewElementID(this.id),this.node.setRichViewElement(this),!0===this.options.fetchContent&&this.refreshContent(),this.StartLinkCmd=new r({ID:"StartLink_DnD"}),this.EndLinkCmd=new s({ID:"EndLink_DnD",container:".content-panel"}),this)},update:function(e){var t=Object.assign({},e);e=UWA.merge(e||{},this.options),this.options=e;for(var i=Object.keys(t),n=0;n<i.length;n++)switch(i[n]){case"bi_color":UWA.is(e.bi_color)&&""!==e.bi_color?(this.options.bi_color=e.bi_color,this.info.css("border-left-color",e.bi_color)):(this.options.bi_color=null,this.info.attr("style")&&this.info.removeAttr("style"));break;case"level":this.level=this.options.level,this.container.data("level",this.options.level),this.container[0].dataset.level=this.options.level;break;case"underCA":this.options.underCA=e.underCA,this.underCA=this.options.underCA;break;case"changeid":this.options.changeid=e.changeid,this.changeid=this.options.changeid;break;case"content":e.hasOwnProperty("isDocx")&&(this.isHTMLReady=!(e.isDocx&&!e.content),this.convertBeforeEdit=("rtf.gz.b64"==e.format||e.isDocx)&&e.content.toLowerCase().indexOf("<img")>=0,this.isHTMLReady||(this.options.content=h.Msg_NoPreview)),this.context.updateRichContent({content:this.options.content,element:this.container.find(".content-data"),editable:e.editable});break;case"title":if(this.title!==e.title){this.options.title=e.title,this.title=this.options.title;var o=this.header_content[0];o="Sub Requirement"===this.connection?o.children[3].children[0].children[1].children[0]:o.children[2].children[1].children[0],this.context.updateRichContent({content:this.title,element:a(o),editable:this.options.editable}),this.mediator.publish("onRefresh")}break;case"contentPlaceHolder":"hide"===e.contentPlaceHolder?this.content.find("#"+this.id+"_placeholder").hide():this.content.find("#"+this.id+"_placeholder").show();case"index":this.options.index=e.index,this.options.index=this.options.index,this.container.find(".rich-object-index").text(this.options.index+" ");break;case"containerIdx":this.options.containerIdx=e.containerIdx,this.options.containerIdx=this.options.containerIdx,this.container.find(".rich-object-container-index").text(this.options.containerIdx+" - ");break;case"connection":this.options.connection=e.connection,this.connection=this.options.connection;var r=f({icon:this.options.kindof.toLowerCase(),type_icon_url:this.options.type_icon_url,title:this.options.title,containerIdx:this.options.containerIdx,index:this.options.index,connection:this.options.connection,level:this.options.level,externalObject:this.node._options.externalObject,id:this.options.id,editable:this.options.editable});this.header_content.replaceWith(r),this.header_content=r;break;case"connectionId":this.options.connectionId=e.connectionId,this.connectionId=this.options.connectionId,this.container.data("relid",this.options.connectionId),this.container[0].dataset.relid=this.options.connectionId;break;case"parentId":this.options.parentId=e.parentId,this.parentId=this.options.parentId;break;case"editable":e.editable=!0,e.underCA&&""===e.changeid&&UWA.is(context.getAuthoringContextHeader)&&(e.editable=!0),e.underCA&&!UWA.is(context.getAuthoringContextHeader)&&(e.editable=!1),this.options.editable=e.editable,this.editable=this.options.editable,this.container.find(".content-data").attr("contenteditable",e.editable);case"isDocx":this.options.isDocx=e.isDocx,this.isDocx=this.options.isDocx}},refresh:function(e){e=e||[];for(var t=0;t<e.length;t++)switch(e[t]){case"content":var i=this.container.find(".content-data").html();this.mediator.publish("onUpdateCKEditorContent",{content:i,element:this.container.find(".content-data")});break;case"title":this.context.updateRichContent({content:this.title,element:a(this.header_content[0].children[2].children[1].children[0]),editable:this.options.editable})}},_scroll:function(e){var t=this,i=t.isVisible(e.position);if(i&&this.physicalId&&!t.content.find("#"+t.id+"_placeholder").is(":visible")){let e="#"+t.id+"_content",i=UWA.Element.getElement.call(document,e);g.mask(i),this.loadContent().then(()=>{g.unmask(i)}).catch(()=>{g.unmask(i),t.content.find("#"+t.id+"_placeholder").hide()}),t.content.find("#"+t.id+"_placeholder").show()}i&&!1===this._menuAttached&&(this._menuAttached=!0,this._menu()),t._scrollElements(e)},_menu:function(){new o({model:this.model,container:this.menu[0],id:this.id,kindof:this.kindof,externalObject:this.node.options.externalObject,type:this.type,externalProviders:this.context.externalProviders,root:this.node.isRoot()}).inject()},refreshContent:function(){var e=this;c.getContent({securityContext:l.getSecurityContext(),pid:e.physicalId,onComplete:function(t){var i=(t=UWA.is(t,"string")?JSON.parse(t):t).results;UWA.is(i["Content Data"])||(i["Content Data"]=""),e.update({content:i["Content Data"],format:i["Content Type"],isDocx:i.isDocx,editable:i.editable})},onFailure:function(e){var t=u.getParseErrorMessage(e);d.errorAlert(t)},onTimeout:function(e){var t=u.getParseErrorMessage(e);d.errorAlert(t)}})},loadContent:function(){var e=this;return new Promise((t,i)=>{c.getContent({securityContext:l.getSecurityContext(),pid:e.physicalId,onComplete:function(i){var n=(i=UWA.is(i,"string")?JSON.parse(i):i).results;UWA.is(n["Content Data"])||(n["Content Data"]=""),e.update({content:n["Content Data"],format:n["Content Type"],isDocx:n.isDocx,editable:n.editable}),t()},onFailure:function(e){var t=u.getParseErrorMessage(e);d.errorAlert(t),i()},onTimeout:function(e){var t=u.getParseErrorMessage(e);d.errorAlert(t),i()}})})},createDerivationLink:function(e){let t={id:e.data.items[0].objectId,physicalId:e.data.items[0].objectId,type:e.data.items[0].objectType,kindof:"Requirement",path:e.data.items[0].path,title:e.data.items[0].displayName};this.StartLinkCmd.execute(t);let i=this.model.getNodesByElementID(this.id)[0].getOccurencePathWithType(null,!0),n=[{id:this.objectId,physicalId:this.physicalId,type:this.type,kindof:"Requirement",path:i,title:this.title}];this.EndLinkCmd.execute(n)}});return b}),define("DS/RichView/Views/RichContainer",["UWA/Class/Events","UWA/Class/Listener","UWA/Class/Options","DS/RichView/Service/ContextualMenu","DS/TraceableRequirementsUtils/jQuery","DS/RichView/Utils/RichEditorBase","DS/Logger/Logger","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,s){"use strict";var a=function(e){return o('<div id="'+e.id+'" class="rich-container '+e.className+'" draggable="true" data-objectid="'+e.objectId+'" data-level="'+e.level+'" data-physicalid="'+e.physicalId+'" data-relid="'+e.connectionId+'"></div>')},l=function(){return o('<span class="rich-container-info"></span>')},c=function(e){return widget.getValue("trm_richview_DisableAutoNumbering")?o('<span class="rich-container-title header-size-'+e.size+'"><span class="rich-container-title-index rich-container-hidden-numbering"> '+e.index+' - </span><span><div id="'+e.id+'_content" class="rich-container-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>"):o('<span class="rich-container-title header-size-'+e.size+'"><span class="rich-container-title-index"> '+e.index+' - </span><span><div id="'+e.id+'_content" class="rich-container-title-editable" contenteditable="'+e.editable+'">'+e.title+"</div></span></span>")},d=function(){return o('<span class="collapsable-container"><span class="fonticon fonticon-minus-squared site-icon"></span></span>')},u=function(){return o('<span class="rich-container-menu"></span>')},h=r.extend(e,t,i,{defaultOptions:{model:null,node:null,rootId:null,mediator:null,id:null,objectId:null,physicalId:null,type:"",kindof:"",title:"",index:"",connection:"",connectionId:null,level:0,editable:"true",defaultType:"Requirement",placeholder:!1,droppable:null,context:null,bi_color:null,containerType:"rich-container"},model:null,node:null,id:null,objectId:null,parentId:null,physicalId:null,connection:null,connectionId:null,level:null,index:null,title:null,container:null,info:null,header:null,menu:null,menu_context:null,type:null,kindof:null,context:null,mediator:null,cestamp:null,init:function(e){UWA.merge(e||{},this.defaultOptions),this._parent(e);this._logger=s.getLogger(h),this._logger.log("init"),UWA.merge(e||{},this.defaultOptions),this.options=e,this.container=a({id:this.options.id,objectId:this.options.objectId,physicalId:this.options.physicalId,connectionId:this.options.connectionId,level:this.options.level,className:!0===this.options.placeholder?"placeholder":""}),this.info=l(),this.header=c({size:this.options.level>6?6:this.options.level,index:this.options.index,title:this.options.title.escapeHTML(),editable:this.options.editable,id:this.options.id}),this.menu=d(),this.menu_context=u(),this.container.append(this.info).append(this.menu).append(this.menu_context).append(this.header),this._menu_context_attached=!1},create:function(){return!0===this.options.placeholder?this:(this.createObject(),!0===this.options.fake?this.menu_context.remove():(this.node.setRichViewElementID(this.id),this.node.setRichViewElement(this)),this)},update:function(e,t){for(var i=Object.keys(e),n=0;n<i.length;n++)switch(i[n]){case"bi_color":UWA.is(e.bi_color)&&""!==e.bi_color?(this.options.bi_color=e.bi_color,this.info.css("border-left-color",e.bi_color)):(this.options.bi_color=null,this.info.attr("style")&&this.info.removeAttr("style"));break;case"level":var o=this.options.level>6?6:this.options.level;this.options.level=e.level,this.level=this.options.level,this.container.data("level",this.options.level),this.container[0].dataset.level=this.options.level;var r=this.options.level>6?6:this.options.level;this.header.removeClass("header-size-"+o),this.header.addClass("header-size-"+r);break;case"index":this.options.index=e.index,this.index=this.options.index,this.header.find(".rich-container-title-index").text(this.options.index+" - ");break;case"containerIdx":this.options.index=e.containerIdx,this.index=this.options.index,this.header.find(".rich-container-title-index").text(this.options.index+" - ");break;case"title":this.options.title!==e.title&&(this.options.title=e.title,this.title=this.options.title,this.context.updateRichContent({content:this.title,element:this.header.find(".rich-container-title-editable"),editable:this.options.editable}),this.mediator.publish("onRefresh"));break;case"connectionId":this.options.connectionId=e.connectionId,this.connectionId=this.options.connectionId,this.container.data("relid",this.options.connectionId),this.container[0].dataset.relid=this.options.connectionId;break;case"parentId":this.options.parentId=e.parentId,this.parentId=this.options.parentId;break;case"connection":this.options.connection=e.connection,this.connection=this.options.connection}},refresh:function(e){e=e||[];for(var t=0;t<e.length;t++)switch(e[t]){case"title":this.context.updateRichContent({content:this.title,element:this.header.find(".rich-container-title-editable"),editable:this.options.editable})}},_scroll:function(e){this.isVisible(e.position)&&!1===this._menu_context_attached&&(this._menu_context_attached=!0,this._menu_context()),this._scrollElements(e)},_menu_context:function(){new n({model:this.model,container:this.menu_context[0],id:this.id,kindof:this.kindof}).inject()}});return h}),define("DS/RichView/Views/RichPlaceholder",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/RichView/Views/RichObject"],function(e,t,i,n){"use strict";var o={};var r=t.extend({defaultOptions:{physicalid:"",type:"",kindOf:"",target:{element:null,id:""},position:"",content:"",objectId:""},physicalId:null,type:null,kindof:null,position:null,objectId:null,content:null,target:{element:null,id:""},previousSibling:{},nextSibling:{},init:function(e){this._logger=i.getLogger(r),this._logger.log("init"),UWA.merge(e||{},this.defaultOptions),this.options=e,this.objectId=this.options.objectId,this.physicalId=this.options.physicalId,this.position=this.options.position,this.content=this.options.content,this.type=this.options.type,this.kindof=this.options.kindof,this.target=this.options.target},create:function(e){var t=function(){var e="";do{e="object_"+Math.floor(1e6*Math.random())}while(o[e]);return o[e]=e,e}(),i=new n({id:t+"_placeholder",title:'<span class="fonticon fonticon-dot-3"></span>',content:this.content,droppable:void 0!==this.options.droppable[this.type]?this.options.droppable[this.type]:this.options.droppable[this.kindof],placeholder:!0}).create(),r=void 0,s=void 0;if(UWA.is(this.target.element)){var a=e.getNodesByElementID(this.target.element.attr("id"))[0];r=(r="over"!==this.position?a.getParent():a)?r.getRichViewElement():void 0}switch(UWA.is(r)||(r={type:e.getRoots()[0].options.type,objectId:e.getRoots()[0].getID(),kindof:e.getRoots()[0].options.kindof},s=1),this.position){case"over":if(UWA.is(this.target.element)){var l=e.getNodesByElementID(this.target.element.attr("id"))[0],c=l.getChildren(),d=this.target.element;if(UWA.is(c)&&c.length>1){var u=c[c.length-2];d=UWA.is(u.getRichViewElement())?u.getRichViewElement().container:null;var h=u.getAllDescendants();if(UWA.is(h)&&h.length>0){u=h[h.length-1];d=UWA.is(u.getRichViewElement())?u.getRichViewElement().container:null}}d.after(i.container),s=l.getLevel()+1,this.previousSibling={},this.nextSibling={}}else{var p=jQuery(".rich-container,.rich-object:not(.placeholder)");p.size()>0&&(this.target.element=p.eq(p.size()-1)),this.target.element.after(i.container),s=1}}return this.parent=r,this.newLevel=s,this.placeholder=i,this}});return r}),define("DS/RichView/Views/RichViewUtilities",["UWA/Class/Promise","DS/TraceableRequirementsUtils/Utils","DS/RichView/Views/RichPlaceholder","DS/RichView/Views/RichContainer","DS/RichView/Views/RichObject","DS/PADUtils/PADContext","text!DS/RichView/assets/RichViewSetting.json"],function(e,t,i,n,o,r,s){var a=JSON.parse(s),l={};return{removeDeletedNodes:function(e,t){var i=this,n=r.get();e.map(function(e){return e.getOccurencePath()}).forEach(function(e){var n=e[e.length-1],o=e[e.length-2],r=i.getObjectElements({id:n,relid:o,occurencePath:e},t);if(UWA.is(r.element)){var s={element:r.element,occurencePath:e};i.removeNodeFromView(s,t,!1)}}),n.onCleanSelection(!1),n.mediator.publish("onRefresh")},getObjectElements:function(e,t){var i=e.id,n=e.relid,o=e.path,r=null,s=null,a=t.getNodesById(i);if(a.length>0){r=a[0].getRichViewElementID(),s=a[0].getRichViewElement()?a[0].getRichViewElement().container:null;for(var l=0;l<a.length;l++){var c=a[l];if(UWA.is(o)){var d=c.getOccurencePath(),u=o;if(u.length>d.length){var h=u.length-d.length;u=u.slice(h,u.length-1)}this.isSamePath(u,d)&&(r=c.getRichViewElementID(),s=c.getRichViewElement()?c.getRichViewElement().container:null)}else{n===c.getRelationID()&&(r=c.getRichViewElementID(),s=c.getRichViewElement()?c.getRichViewElement().container:null)}}}return{id:r,element:s}},removeNodeFromView:function(e,t,i){var n=e.element,o=t.getNodesByElementID(n.attr("id"))[0],r=o.getAllDescendants();if(UWA.is(r)&&r.length>0)for(var s=0;s<r.length;s++){var a=r[s];a.getRichViewElement().container.remove(),a.remove()}n.remove(),o.unselect(),o.remove(),t.getModelEvents().publish({event:"setPathTags",context:t}),0===jQuery(".rich-container,.rich-object:not(.placeholder)").length&&widget.dispatchEvent("onRefresh")},getPlaceHolderForInsert:function(e,t,n,o,r){var s,l,c,d=e.options.type,u=e.options.kindof;return s=e.getRichViewElement(),l=null===e.getRichViewElementID()?"":e.getRichViewElementID(),c=s?s.container:null,new i({physicalid:n.physicalid,type:d,kindof:u,target:{element:c,id:l},position:o,content:"",droppable:a.droppable}).create(r)},insertNodesInRichView:function(e,t,i,n,o,r){var s=r.getNodesById(e);if(s.length>0)for(var a=o.getOccurencePath(),l=0;l<s.length;l++){var c=this.getPlaceHolderForInsert(s[l],a,i,t,r);this.insertAndRefreshView(r,c,i,n,o)}},insertAndRefreshView:function(e,i,n,o,s){var l=r.get();UWA.is(n.level)||(n.level=i.newLevel);var c,d=t.getAuthorizedTypesWithParent(),u=e.getRoots();(UWA.is(i.parent.id)&&""!==i.parent.id&&(u=e.getNodesByElementID(i.parent.id)),s)||(s=require("DS/RichView/Models/RichViewModelParser").process.createNode({data:n,tenant:t.getTenant()},d),u[0].addChild(s),e.sortInTreeOrder(u));i.position,UWA.is(c)||(c=i.placeholder,n.objectId=n.matrixID,n.physicalId=n.physicalid,n.id=this.getRandomId(),n.level=i.newLevel,n.content=i.content,UWA.is(o)&&"insertExisting"===o&&(i.fetchContent=!0),n.fetchContent=!!UWA.is(i.fetchContent)&&i.fetchContent,n.title=n.label);var h=null,p=UWA.is(n.type,"object")?n.type.value:n.type,g=n["type.kindof"];if(a.container.indexOf(p)>=0||a.container.indexOf(g)>=0?(h=this.getRichContainer(n,s,e),!0,!1):(a.rich.indexOf(p)>=0||a.rich.indexOf(g)>=0)&&(s.options.externalObject&&(n.fetchContent=!1),h=this.getRichObject(n,s,e),!1,!0),s.options.externalObject){var m=s.getRichViewElement();m.update({content:"[ "+RichViewNls.ExternalObject_DisplayContent+" ]",editable:!1,isDocx:!0}),m.content[0].addEventListener("click",function(e){l.getProxyContentData(this,e)})}c.container.after(h),c.container.remove(),l.mediator.publish("onScroll",{position:l._currentPosition}),l.onCleanSelection(!1),l.mediator.publish("onRefresh")},getRichContainer:function(e,i,o){var s=r.get(),l=i.conatinerIdx,c=t.getAuthorizedTypesWithParent();if(!i.conatinerIdx){for(var d=1,u=i;UWA.is(u);){u=u.getPreviousBrother(),UWA.is(u)&&(d=this.GetContainerLevel(u),(a.container.indexOf(u.options.type)>=0||a.container.indexOf(u.options.kindOf)>=0)&&(d+=1));break}for(var h=d,p=i;UWA.is(p)&&(p=p.getParent(),UWA.is(p));)if(""!==p.options.type&&(a.container.indexOf(p.options.type)>=0||a.container.indexOf(p.options.kindOf)>=0)){h=""==h?p._options.level:p.getRichViewElement().index+"."+h;break}l=h}var g=e["ds6w:label"]?e["ds6w:label"]:e.title;e.title=""!==g?g:e.name,e.resourceid=e.resourceid?e.resourceid:e.physicalid,e.relationid=e.relationid?e.relationid:e["physicalid[connection]"],e.level=i.getDepth(),e.from=e["from.physicalid[connection]"]?e["from.physicalid[connection]"]:e.from;var m=UWA.is(e.type,"object")?e.type.value:e.type,f=e.kindof?e.kindof:c[m];return new n({model:o,node:i,rootId:s.rootId,mediator:s.mediator,id:e.id,objectId:e.objectId,physicalId:e.resourceid,type:m,kindof:f,title:e.title,cestamp:e.cestamp,index:l,connection:e["ds6w:businessType"],connectionId:e.relationid,parentId:e.from,level:e.level,droppable:void 0!==a.droppable[m]?a.droppable[m]:a.droppable[f],context:s}).create().container},getRichObject:function(e,i,n){var s,a=r.get();e.parentId=e.from,s=i&&i.richObjIdx&&i.conatinerIdx?{index:i.richObjIdx,containerIdx:i.conatinerIdx}:a._generateObjectIdx(i);var l=e["ds6w:label"]?e["ds6w:label"]:e.title;e.title=""!==l?l:e.name,e.resourceid=e.resourceid?e.resourceid:e.physicalid,e.relationid=e.relationid?e.relationid:e["physicalid[connection]"],e.level=i.getDepth(),e.from=e["from.physicalid[connection]"]?e["from.physicalid[connection]"]:e.from;var c=UWA.is(e.type,"object")?e.type.value:e.type,d=t.getKindOf(c);return new o({model:n,node:i,rootId:a.rootId,mediator:a.mediator,id:e.id,objectId:e.objectId,physicalId:e.resourceid,type:c,kindof:d,title:e.title,index:s.index,containerIdx:s.containerIdx,content:e.content,connection:e["ds6w:businessType"],connectionId:e.relationid,parentId:e.from,level:e.level,type_icon_url:e.type_icon_url||e.icon,droppable:void 0!==a.options.droppable[c]?a.options.droppable[c]:a.options.droppable[d],fetchContent:void 0!==e.fetchContent&&e.fetchContent,context:a}).create().container},GetContainerLevel:function(e){for(var t=1,i=e;UWA.is(i)&&(i=i.getPreviousBrother(),UWA.is(i));)(a.container.indexOf(i.options.type)>=0||a.container.indexOf(i.options.kindOf)>=0)&&(t+=1);return t},isSamePath:function(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},getRandomId:function(){var e="";do{e="object_"+Math.floor(1e6*Math.random())}while(l[e]);return l[e]=e,e},getRequestPayload:function(e){var i=r.get(),n=a.expand.cv_expand_data.no_folder_expand,o=t.determineAuthoredFlag(),s=UWA.extend({type_filter:n.type_filter_bo,rel_filter:n.type_filter_rel}),l=[e];return!1===o?(s.expand_iter="-1",s.paths=l,s.rootID=e,s.BIProxy=i._biFilter,s.object_selects=a.expand.cv_expand_data.no_folder_expand.select_bo,s.select_relation=["physicalid","ds6w:type","spec.TreeOrder","ds6w:businessType"]):(s.root_physical_id=e,s.relationship_selects=["physicalid[connection]","attribute[TreeOrder]","from.physicalid"],s.object_selects=a.expand.mql_expand_data.object_selects),s},getSupportedTypes:function(){return t.getAuthorizedTypesWithParent()}}}),define("DS/RichView/Models/RichViewModelParser",["DS/Logger/Logger","UWA/Class/Promise","DS/RichView/Models/RichViewModel","DS/RichView/Views/RichViewUtilities","DS/TraceableRequirementsUtils/utils/RequirementNlsMgt"],function(e,t,i,n,o){"use strict";e.getLogger("DS/RichView/Models/RichViewModelParser");var r={},s={};let a=null;const l=Object.freeze({INSERT:"INSERT",DELETE:"DELETE"});var c=document.createElement("textarea"),d=function(e){if(!UWA.is(e)||""==e)return"";try{return c.innerHTML=e,c.value}catch(e){return""}},u=new Map,h=new Map,p=[],g=function(e,t){var i={resourceid:"",ensureNLS:!0,grid:{}};let n=Object.keys(e),o=n.length;if(o)for(var r=0;r<o;r++){let o=n[r],s=e[o];switch(o){case"resourceid":case"physicalid":i.resourceid=s,i.physicalID=s;break;case"id":i.matrixID=s;break;case"name":i.name=s,i.grid["ds6w:identifier"]=s,i.req_name=s;break;case"ds6w:label":case"attribute[Title]":i.label=s,i.title=s,i.grid[o]=s,i.req_label=s;break;case"ds6w:type":case"type":UWA.is(s,"object")?(i.grid[o]=s.displayName,i.type=s.value):(i.grid[o]=s,i.type=e.type?e.type:s),i.kindof=t[i.type]?t[i.type]:i.type,i["type.kindof"]=i.kindof;break;case"ds6wg:revision":case"revision":i.grid["ds6wg:revision"]=s,i.revision=s;break;case"icon":case"type_icon_url":void 0===i.icons&&(i.icons=[]);let n={iconPath:"url("+s+")",className:"dgv-icons"};i.icons.push(n),i.type_icon_url=s;break;case"thumbnails":case"thumbnail":case"thumbnail_2d":case"preview_url":i.thumbnail=s,i.grid.thumbnail=s;break;case"relationid":case"physicalid[connection]":i.relationid=s;break;case"from":case"from.physicalid[connection]":i.from=s,i.parentID=s;break;case"ds6wg:contentType":i.format=s;break;case"ds6wg:contentData":i.content=s;break;case"editable":i.editable=s;break;case"cestamp":i.cestamp=s;break;case"current.access[read]":i.editable=s.toLowerCase();break;case"isDocx":i.isDocx=s;break;case"level":i.level=s;break;case"modified":i.modified=s;break;case"ds6w:responsible":i.owner=s;break;case"spec.TreeOrder":case"attribute[TreeOrder]":i.relationOrder=parseFloat(s),isNaN(i.relationOrder)&&(i.relationOrder=-1);break;case"type[connection]":i.relationtype=s;break;default:UWA.is(s,"object")?i.grid[o]=s.displayName:i.grid[o]=s}}return i},m=function(e,t){return e.options.relationOrder-t.options.relationOrder};return r.processStructure=function(e){function t(e,t){return e.relationOrder-t.relationOrder}if(!e.refresh)for(let e=0;e<p.length;e++){var i=p[e];i.children.length>1&&(i.children=i.children.sort(t))}},r.addChild=function(e,t,i){if(!e)return;let n=u.get(e);if(!n){let t=i.treedocument.getNodesById(e)[0],o=UWA.extend({},t.options,!0);o.children=[],u.set(o.resourceid,o),n=u.get(e)}if(!n)return void console.log("Unknown parent");n.children||(n.children=[]);var o=UWA.clone(t);n.children.push(o),i.expandAll&&(o.childComputed=!0);var r,s,a=h.get(o.resourceid);a||(a=[]),a.push(o),s=n,-1===(r=p).indexOf(s)&&r.push(s);let l=u.get(o.resourceid);l&&!1===i.authored&&UWA.merge(o,l,!0),h.set(o.resourceid,a),u.set(o.resourceid,o)},r.buildStructure=function(e,t){u=new Map,h=new Map,p=[];let i=[];for(var n=0;n<e.data.length;n++){var o=g(e.data[n],t);e.nodeMap&&o.relationid&&e.nodeMap.set(o.resourceid+"_"+o.relationid,o),o.tenant=e.tenant,i.push(o),u.set(o.resourceid,o)}i.forEach(function(t){r.addChild(t.from,t,e)})},r.refreshTreeStructure=function(e,t,i,o,s){let a=!1,c=null;s||(c=(new Date).getTime(),a=!0,s=[]),s.push(t);var d=[];i&&i.children&&i.children.forEach(function(i){var a=r.getNodesByRelationId(i.relationid);a&&a.length?function(e,t,i,n,o,s){t.forEach(function(t){r.refreshTreeStructure(n,t,e,o,s),i.push(t)})}(i,a,d,e,o,s):function(e,t,i,o,s,a){let c=o.addChild(e);c.options.children=[],o.options.children.sort(m),n.insertNodesInRichView(o.options.resourceid,"over",e,"insertExisting",c,i),r.updateNodesInMap(c,l.INSERT),r.refreshTreeStructure(i,c,e,s,a),t.push(c)}(i,d,e,t,o,s)});let u=t.getChildren(),h=[];if(u&&(h=u.filter(function(e){return-1===d.indexOf(e)})),h.length>0&&(h.forEach(e=>r.updateNodesInMap(e,l.DELETE)),n.removeDeletedNodes(h,e)),a){e.prepareUpdate(),s.forEach(function(e){var t=o.get(e.getID());if(t){var i={grid:t.grid,label:t.label,cestamp:t.cestamp,level:(e.getOccurencePath().length-1)/2};e.updateOptions(i);var n=e.getRichViewElement();UWA.is(n)&&n.update({title:t.label,contentPlaceHolder:"hide"})}}),e.pushUpdate();var p=(new Date).getTime();console.log("rich view refresh: "+(p-c)/1e3)}},r.setRelIdToNodeModelMap=(e=>{e&&(a=e)}),r.getNodesByRelationId=(e=>{if(a)return a.get(e)}),r.prepareRelIdToNodeModelMap=function(e){const t=new Map;return UWA.is(e)?(e.getRelationID()&&t.set(e.getRelationID(),e),e.processDescendants({processNode:function(e){if(e&&e.nodeModel){const i=e.nodeModel,n=i.getRelationID();if(n){let e=t.get(n)||[];e.push(i),t.set(n,e)}}}}),t):t},r._updateRelIDToNodeModelMap=((e,t)=>{const i=e.getRelationID();let n=a.get(i)||[];if(i)switch(t){case l.INSERT:n.push(e),a.set(i,n);break;case l.DELETE:a.delete(i)}}),r.updateNodesInMap=((e,t)=>{e&&a&&(r._updateRelIDToNodeModelMap(e,t),e.processDescendants({processNode:function(e){e&&e.nodeModel&&r._updateRelIDToNodeModelMap(e.nodeModel,t)}}))}),s.process={root:function(e,t){var n=g(e.data,t);n.tenant=e.tenant;var o=new i(n);e.treedocument.addRoot(o)},createNode:function(e,t){var n=g(e.data,t);return new i(n)},streaming:function(e,t){let i=e.treedocument;var n=e.root_node;let o;r.buildStructure(e,t),r.processStructure(e);let s=u.get(n.options.resourceid);if(s&&n.hasChildren()&&-1===e.expandLevel&&n.removeChildrens(),s&&s.children&&(o=s.children,delete s.children),s&&n.updateOptions(s),n.isRoot()){let e=!!i.filterBI&&i.filterBI.HasFilter(n.getID());var a=UWA.clone(n.options.icons[0]);a&&(!0===e.hasFilter?(a.badges={bottomRight:{iconName:"filter",fontIconSize:"1x",className:"dgv-badge"}},n.updateOptions({icons:[a]})):(a.badges={bottomRight:null},n.updateOptions({icons:[a]})))}o?i.withTransactionUpdate(function(){i.loadModel(o,n)}):(n.updateOptions({children:null}),n.setState({state:"noChildren"}))},refresh:function(e,i){return new t(function(t,n){var o=e.root_node;let s=e.treedocument;r.buildStructure(e,i);let a=u.get(o.getID()),l=r.prepareRelIdToNodeModelMap(o);r.setRelIdToNodeModelMap(l),r.refreshTreeStructure(s,o,a,u,!1),t()})},content:function(e){for(var t=e.response,i=0;i<t.length;i++){var n=t[i].id;e.treedocument.getNodesByMatrixID(n).forEach(function(e){var n="";if(UWA.is(e.getRichViewElement())){var o=e.getRichViewElement();e.options.externalObject?(n="[ "+RichViewNls.ExternalObject_DisplayContent+" ]",t[i].editable=!1,o.content[0].addEventListener("click",function(e){_that.getProxyContentData(this,e)})):n=d(t[i].content);var r=jQuery(o.container).find("#"+o.id+"_content");r.length>0&&r.html()!==n&&o.update({content:n,editable:t[i].editable,isDocx:t[i].isDocx,underCA:t[i].underCA,changeid:t[i].changeid})}})}},sortStructure:function(e,t){return u=new Map,h=new Map,p=[],r.buildStructure({treeDoc:e.treedocument,data:e.data,expandLevel:e.expandLevel,isAuthored:e.authored,rootNodes:e.rootNodes[0]},t),r.processStructure(e),e.rootNodes.map(e=>{if(u.get(e.getID()))return u.get(e.getID())})}},s}),define("DS/RichView/Models/RichViewDocument",["DS/Logger/Logger","DS/UIKIT/Mask","DS/Tree/TreeDocument","DS/RichView/Models/RichViewModel","i18n!DS/RichView/assets/nls/RichView","DS/RichView/Views/RichViewUtilities","DS/RichView/Service/WebServiceController","DS/RichView/Models/RichViewModelParser","DS/TraceableRequirementsUtils/Utils","DS/TraceableRequirementsUtils/utils/RequirementAlertManager"],function(e,t,i,n,o,r,s,a,l,c){"use strict";var d=null;return i.extend({defaultOptions:{nodeModelClass:n},init:function(e){d=this,this._parent(e)},sortInTreeOrder:function(e){e&&e.forEach(function(e){e.sortChildren({isRecursive:!0,sortFunction:function(e,t){if(e.options&&t.options){if(e.options.relationOrder<t.options.relationOrder)return-1;if(e.options.relationOrder>t.options.relationOrder)return 1}return 0}})})},reparentNode:function(e,t,i,n,o,r){t.removeChild(e),e.setRelationID(o),e.setRelationOrder(n),e.setParentID(i.getID()),i.addChild(e),e.setRelationType(r);var s=e.getLevel(),a=-1,l=e.getBrothers();UWA.is(l)&&l.length>0?(a=l[0].getLevel(),UWA.is(r)&&""!==r||(r=l[0].getRelationType())):a=i.getLevel()+1,e.setLevel(a),e.setRelationType(r);for(var c=a-s,u=e.getAllDescendants(),h=0;h<u.length;h++){var p=u[h].getLevel()+c;u[h].setLevel(p)}d.sortInTreeOrder([i])},setFilterBIProxy:function(e){this.options.filterBI=e},getNodesById:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesById(e);t=t.concat(n)}),t},getNodesByMatrixID:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesByMatrixID(e);t=t.concat(n)}),t},getNodeByOccurencePath:function(e){for(var t=this.getRoots(),i=0;i<t.length;i++){var n=t[i].getNodeByPath(e,void 0,void 0,!0);if(n)return n}},getNodesByRelId:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesByRelId(e);t=t.concat(n)}),t},getNodesByElementID:function(e){var t=[];return this.getRoots().forEach(function(i){var n=i.getNodesByElementID(e);t=t.concat(n)}),t},getNodesByIDPath:function(e){var t=[];return this.getRoots().forEach(function(i){!function e(t,i,n,o){if(t.getID()===i[n])if(n===i.length-1)o.push(t);else{var r=t.getChildren();r&&r.length>0&&(n+=1,r.forEach(function(t){e(t,i,n,o)}))}}(i,e,0,t)}),t},initiateRefresh:function(e){let t=this;return new Promise((i,n)=>{let r=e&&e.roots;if(r||(r=this.getRoots()),0===r.length)return void c.notifyAlert(o.RichView_Notif_Refresh);let s=l.determineAuthoredFlag();t.refresh(e,r,s),i()})},refresh:function(e){let i=this,n=e&&e.roots;if(0===n.length)return;let d=UWA.Element.getElement.call(document," .content-panel");t.mask(d);var u=n[0].getID(),h=l.determineAuthoredFlag(),p=r.getRequestPayload(u);!0===h&&(p.withRoot=!0);var g=r.getSupportedTypes();s.getExpandData(p,function(r){r&&!r.results&&!h&&l.determineAuthoredFlag()?i.initiateRefresh(e):a.process.refresh({root_node:n[0],data:r.results,tenant:l.getTenant(),treedocument:i,authored:h,idCardEvents:e.idCardEvents},g).then(function(){t.unmask(d),c.notifyAlert(o.RichView_Notif_Refresh)})})}})}),define("DS/RichView/RichView",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Options","UWA/Class/Events","UWA/Class/Promise","DS/Logger/Logger","DS/HomePage/HomePage","DS/TraceableRequirementsUtils/jQuery","DS/TraceableRequirementsUtils/jQueryUI","DS/UIKIT/Scroller","DS/CATSystemSlidePanel/SlidePanel","DS/RichView/Navigation","DS/RichView/RichContentEditor","DS/RichView/Views/RichObject","DS/RichView/Views/RichContainer","DS/RichView/Service/WebServiceController","DS/CoreEvents/ModelEvents","DS/RequirementFrameUtils/components/idCard/IDCardWrapper","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/UIKIT/Spinner","DS/Controls/ProgressBar","DS/TraceableRequirementsUtils/utils/TRMConstant","DS/TraceableRequirementsUtils/Services/RequirementWebServices","DS/TraceableRequirementsUtils/utils/RequirementAlertManager","DS/TraceableRequirementsUtils/utils/RequirementErrorManager","DS/TraceableRequirementsUtils/views/DndController","DS/TraceableRequirementsUtils/Utils","DS/RichView/Service/WidgetPreferences","DS/RichView/Views/RichViewInfos","DS/PlatformAPI/PlatformAPI","DS/RichView/Service/KeyboardShortcuts","DS/PADUtils/PADContext","DS/PADUtils/PADCommandProxy","DS/PADUtils/PADSession","DS/TraceableRequirementsUtils/utils/TRMSearchNav","DS/RichEditor/RichEditor","DS/i3DXCompassServices/i3DXCompassPubSub","DS/RichView/Models/RichViewDocument","DS/RichView/Models/RichViewModelParser","DS/RichView/mixins/_delimiterUtilities","DS/TraceableRequirementsUtils/REQCommandProxy","DS/RequirementFrameUtils/components/idcardtemplate/IDCardTemplate","DS/TraceableRequirementsUtils/utils/RequirementNlsMgt","DS/TraceableRequirementsUtils/mixins/_ReqBIFilter","DS/Windows/DockingElement","DS/RichView/Utils/RichviewConstant","i18n!DS/RichView/assets/nls/RichView","text!DS/RichView/assets/RichViewSetting.json","DS/RichView/Utils/UpdateSearchView","DS/TraceableRequirementsUtils/utils/SearchManager","i18n!DS/TraceableRequirementsUtils/assets/nls/TraceableRequirementsUtils","text!DS/TraceableRequirementsUtils/assets/RequirementRelationshipsPatterns.json","css!DS/RichView/RichView.css"],function(e,t,i,n,o,r,s,a,l,c,d,u,h,p,g,m,f,v,b,_,y,R,C,E,I,S,x,w,D,A,T,U,P,O,k,V,W,N,j,M,q,L,F,B,K,z,H,Q,J,Y,$,G,X){"use strict";var Z={serverStart:0,serverEnd:0,buildStart:0,buildEnd:0,contentStart:0,contentEnd:0};function ee(){var e="";do{e="object_"+Math.floor(1e6*Math.random())}while(ie[e]);return ie[e]=e,e}var te=45,ie={},ne={},oe=null,re=null,se=!1,ae=!1,le=!1,ce=!1,de=!1,ue=!1,he=!1,pe=!1,ge=!1,me=[],fe=!1,ve=!1,be=!0,_e="",ye=document.createElement("textarea"),Re=JSON.parse(J),Ce=t.extend(i,n,K,q,{name:"richview_container",defaultOptions:{isSemanticQualityPanelOpen:!1,x3dAppId:"REQ_appId",mediator:null,data:null,root:"Requirement Specification",rich:"Requirement,Comment",container:"Chapter",CfgAuthoringContext:null,droppable:{Requirement:{Requirement:"before,after,over",Comment:"before,after",Chapter:"before,after",Files:"over","text/plain":"before,after,over","text/html":"before,after,over","text/searchitems":"before,after,over",Text:"before,after,over"},Comment:{Requirement:"before,after",Comment:"before,after",Chapter:"before,after",Files:"over","text/plain":"before,after","text/html":"before,after","text/searchitems":"before,after,over",Text:"before,after,over"},Chapter:{Chapter:"before,after,over",Requirement:"before,after,over",Comment:"before,after,over","text/plain":"over","text/html":"over","text/searchitems":"before,after,over",Text:"before,after,over"},"Requirement Specification":{Chapter:"over",Requirement:"over",Comment:"over"}},relationship:{Requirement:"Sub Requirement",Chapter:"Specification Structure","Requirement Specification":"Specification Structure"}},_logger:null,_commandProxy:null,_padCommandProxy:null,_reqCommandProxy:null,_curentlyLoadingReqSpec:!1,_smvSelectionEvent:null,externalTypes:["ProxyItem"],externalProviders:!1,OSLCProviders:void 0,_csrf:null,_isReady:{actionbar:!1,richview:!1,dropinvite:!1},_isSelectionEmpty:!0,_traceabilityScope:{id:null,title:null},context:null,init:function(e){if(re=this,"dummy"!=widget.id)try{require(["text!DS/OSLCConsumer/assets/OSLCConfig.json"],function(e){re.OSLCProviders=JSON.parse(e),UWA.is(re.OSLCProviders)&&UWA.is(re.OSLCProviders.repositories)&&re.OSLCProviders.repositories.length>0&&(re.externalProviders=!0)})}catch(e){console.log("/OSLCConsumer/assets/OSLCConfig.json file not found")}UWA.merge(e||{},re.defaultOptions),this._parent(e),this._logger=r.getLogger(Ce),this._logger.log("init"),P.set(this),re.context=P.get(),UWA.is(widget.getValue("x3dAppId"))||widget.addPreference({name:"x3dAppId",type:"hidden",defaultValue:re.defaultOptions.x3dAppId}),widget.addPreference({name:"useIndexAccleration",defaultValue:!0,type:"boolean",value:!0,label:Q.TRM_UseIndex}),widget.addPreference({name:"trm_richview_usespellchecker",type:"boolean",defaultValue:!1,label:Q.TRM_SpellCheckActivation}),widget.addPreference({name:"trm_richview_DisableAutoNumbering",type:"boolean",defaultValue:!1,label:Q.TRM_DisableAutoNumbering}),re.options.model=new j,re.options.model.filterBI=re._biFIlter,self.widget.addEvent("endEdit",function(){re.utilities.onEndEdit(),re._onWidgetResize()}),widget.addEvent("onRefresh",function(){re._onWidgetRefresh(!0);var e={action:"refresh",appId:widget.getValue("appId")};re._reqCommandProxy.refresh(e)}),widget.addEvent("onResize",function(){re._onWidgetResize()}),re.optionalStartup=[],re.initializeBI(re)},_initDivs:function(){var e=UWA.createElement("div",{class:"main-panel"}),t={};re.modelEvents=t.modelEvents=new f,t.container=e;var i=new F;i.init(t),re.idCardContainer=i.getTopContainer(),re.contentContainer=i.getBottomContainer();var n=UWA.createElement("div",{class:"content-panel"});n.inject(re.contentContainer),UWA.createElement("div",{class:"navigation-panel"}).inject(n);var o=UWA.createElement("div",{class:"richview-editor-container"});o.inject(n),UWA.createElement("div",{class:"richview-editor-content"}).inject(o),UWA.createElement("div",{class:"properties-panel off"}).inject(e),re.richView=a(re.container).append(e),re.contentPanel=a(".content-panel",re.richView),re.idCardPanel=a(".id-card-panel",re.richView),re.richViewEditorContainer=a(".richview-editor-container",re.richView),re.richViewEditorContent=a(".richview-editor-content",re.richView),re.navigationPanel=a(".navigation-panel",re.richView),re.propertiesPanel=a(".properties-panel",re.richView),re._subscribeEvents()},_subscribeEvents:function(){re.modelEvents.subscribe({event:"splitview-vertical-resized"},function(){re._onWidgetResize()})},inject:function(e){return this.mediator=this.options.mediator,this.container=e,a(e).parent().css("height","100%"),a(e).css("height","100%"),this.richviewinfos=new A({renderTo:UWA.Element.getElement.call(document,".AfrActionBar"),events:{}}),w.app_initialization(function(){re._initWidgetPreferences(),UWA.is(re.CfgAuthoringContext)||require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(e){re.CfgAuthoringContext=e;var t=document.querySelector(".Content");e.initialize2(t,L.appId(),"show","bottom-right",function(e){re.dispatchEvent("onAuthoringCtxAvailable",e),T.subscribe(re.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){re.mediator.publish("onRefresh")},1e3)}),T.subscribe("toggleDeActiveCA"+re.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){re.mediator.publish("onRefresh")},200)}),T.subscribe("toggleActiveCA"+re.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){re.mediator.publish("onRefresh")},200)}),T.subscribe("removeAuthCtxEvent"+re.CfgAuthoringContext.myAuthkey,function(e){setTimeout(function(){re.mediator.publish("onRefresh")},200)})},{isEvolution:!0})}),o.allSettled(me).then(function(){require(["DS/TraceableRequirementsUtils/Services/RequirementTypeMgt"],function(e){e.defineDefaultTypes(re._defineOptionsForPref())}),re._loadData()})}),re.isConcurrentEngineeringEnabled="false",E.getReQConfigAuthManagement({familyid:"ConcurrentEngineering",onComplete:function(e){var t=JSON.parse(e);t.family[0]&&t.family[0].parameter.forEach(function(e){"ReqCEEnabled"==e.id&&e.argument.forEach(function(e){"Enabled"===e.argValue&&(re.isConcurrentEngineeringEnabled="true")})})},onFailure:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)}}),this},_initializeEditInWord:function(){this.contentPanel.on("dblclick",".content-data",function(e){var t=new W;if(!("Word"!=t.getPreferredEditor()||t.isMobile&&t.isMobile())){var i=a(this).closest(".rich-object"),n=re.options.model.getNodesByElementID(i.attr("id"))[0],o=n.options.matrixID;if(UWA.is(n)&&UWA.is(n.options.externalObject)&&n.options.externalObject)return void I.errorAlert(Q.RichView_Notif_NotAuthorized);var r=n.getRichViewElement();if(!r.isHTMLReady)return;t.openRichTextInWord({uid:o,onClose:function(e,i,n){a("DIV.rich-object[data-objectid='"+e+"'] .content-data").html(n),t.saveRichText(e,i),(r=re.options.model.getNodesByElementID(a("DIV.rich-object[data-objectid='"+e+"']").attr("id"))[0]).update({content:n})}})}})},_initWidgetEvents:function(){!1===widget.hasEvent("onRefresh")&&widget.addEvent("onRefresh",function(){re._onWidgetRefresh(!0);var e={action:"refresh",appId:widget.getValue("appId")};re._reqCommandProxy.refresh(e)}),!1===widget.hasEvent("onResize")&&widget.addEvent("onResize",function(){re._onWidgetResize()}),!1===widget.hasEvent("onDestroy")&&widget.addEvent("onDestroy",function(){re._onWidgetDestroy()}),!1===widget.hasEvent("onSearch")&&widget.addEvent("onSearch",function(e){console.log("Search in Current Dashboard called with query : "+e),ve=!0,_e=e,be=!1,re._onWidgetSearch(e)}),!1===widget.hasEvent("onResetSearch")&&widget.addEvent("onResetSearch",function(){be=!0,console.log("Reset Search in Current Dashboard "),ve=!1,_e="",re._onWidgetSearch()})},_loadData:function(){var e=null,t=this.utilities.useCompassContent(),i=this.utilities.reloadSaveObject();UWA.is(this.options.data)&&""!==this.options.data?re._loadDataForOdtMode():UWA.is(t)&&""!==t?e=t:UWA.is(i)&&""!==i&&(e=i),UWA.is(e)?E.getInfo({securityContext:w.getSecurityContext(),pid:e,selectables:re.utilities.getSelectable(),onComplete:function(t){if(Array.isArray(e)||(e=e.split(",")),!(t=w.parseResponse(t)).results||t.results.length<e.length)if(w.determineAuthoredFlag())I.errorAlert(Q.RichView_Notif_LoadError);else if(t.infos&&t.infos.sources&&t.infos.sources.length>0&&t.infos.sources[0].error){var i=t.infos.sources[0],n=i.error.errorMessage||"An error has occurred in "+i.name;I.errorAlert(n)}else k.setAuthoringState(!0,Q.disabling_index_object_not_found),re._loadData();else if(t.results.length>e.length)I.errorAlert("Too Many Results");else{let i=(t=UWA.is(t,"string")?JSON.parse(t):t).results?t.results[0]:{};var o=w.getKindOf(i["ds6w:type"]);o===H.TYPE_REQUIREMENT||o===H.TYPE_REQUIREMENT_SPECIFICATION?(re.options.data=e[0],M.process.root({treedocument:re.options.model,data:i,tenant:w.getTenant(),treedocument:re.options.model},w.getAuthorizedTypesWithParent()),re._init()):re._initDropZone()}},onFailure:function(e,t){re._initDropZone(),re.utilities.cleanObject();var i=S.getParseErrorMessage(t);I.errorAlert(i)},onTimeout:function(e){re._initDropZone();var t=S.getParseErrorMessage(e);I.errorAlert(t)}}):re._initDropZone()},_loadDataForOdtMode:function(){re._buildView(),this.json=this.options.data,this.root=this.json[0],E.getInfo({securityContext:w.getSecurityContext(),pid:null,selectables:re.utilities.getSelectable(),onComplete:function(e){e=w.parseResponse(e),e=UWA.is(e,"string")?JSON.parse(e):e,M.process.root({treedocument:re.options.model,data:e.results[0],tenant:w.getTenant()},w.getAuthorizedTypesWithParent()),re._richView(re.json),re.mediator.publish("onRefresh"),re._startEdition()},onFailure:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)}})},_initDropZone:function(){var e={root_type:Re.root_type,commands:Re.commands,Icons:Re.Icons};re.dropinvit=new s({widget:widget,settings:e,isRichView:!0}),re.dropinvit.inject(UWA.Element.getElement.call(document,re.container)),re._initWidgetEvents(),re._initProxyEvents()},applyFilter:function(e){console.log("filter RichView Data",e);var t=this,i="";if((i=e.filterRootIds?e.filterRootIds[0]:e.resourceid)===re.getRootId())if(e.empty)i===re.getRootId()&&t._onWidgetRefresh();else{var n=[],r=!1,s=new o(function(t,n){0==e.empty?E.getKindOf({securityContext:w.getSecurityContext(),pid:i,onComplete:function(e){var i=(UWA.is(e,"string")?JSON.parse(e):e).results;console.log("Kind Of: "+i),"Requirement Group"==i&&(r=!0),t()},onFailure:function(e){re._logger.log(e);var t=S.getParseErrorMessage(e);I.errorAlert(t),n()},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t),n()}}):t()});s&&n.push(s),o.allSettled(n).then(function(n){if(!r){var o=e.CVQuery;if(e.empty)t._onWidgetRefresh();else{t.options.model.getRoots()[0].options.children=null,(a(".scroller-content",t.richViewEditorContainer).length>0?a(".scroller-content",t.richViewEditorContainer):t.richViewEditorContent).empty();o=re.utilities.getRequestPayload(i);E.expand({json:o,onComplete:function(e){e=w.parseResponse(e),e=(e=UWA.is(e,"string")?JSON.parse(e):e).results?e.results:e,t._richView(e),re.mediator.publish("onScroll",{position:0})},onFailure:function(e){re._logger.log(msg);var t=S.getParseErrorMessage(e,null,Q.RichView_Notif_LoadError);I.errorAlert(t),re._initDropZone(),reject()},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)}})}}})}},_init:function(){this._initWidgetEvents(),this._initProxyEvents(),this._initMediatorEvents(),this.current_selection={element:null,objectId:re.options.model.getRoots()[0].options.matrixID,physicalid:re.options.model.getRoots()[0].getID(),kindof:re.options.model.getRoots()[0].options.kindof,type:re.options.model.getRoots()[0].options.type,path:re.options.model.getRoots()[0].getOccurencePath(),ParentLabel:re.options.model.getRoots()[0].getParent().options.title,label:re.options.model.getRoots()[0].options.title},re.options.model.getRoots()[0].select(),UWA.is(this.options.data,"string")&&this._fetchData(this.options.data).then(function(){re.utilities.setWidgetTitle(),widget.dispatchEvent("onCheckScopeRV")}),this._initKeyboardShortcuts(),this._initWidgetPreferences(),this.utilities.saveObject(this.options.data),this.rootId=this.options.data,this._promises=[],this._promisesData=[]},_onInitialDrop:function(e){re.dragElementId=void 0;let t=e.physicalid;t=UWA.is(t,"array")?t[0]:t;let i=e.occurrencePath;i&&i.length>0&&(re.dragElementId=i[0][i[0].length-1]),re.options.data=t,t!==re.rootId?E.getInfo({securityContext:w.getSecurityContext(),pid:t,selectables:re.utilities.getSelectable(),onComplete:function(e){e=w.parseResponse(e);var i=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0]["ds6w:type"],n=w.getKindOf(i);re._curentlyLoadingReqSpec=!1,-1!=re.options.root.indexOf(i)||-1!=re.options.root.indexOf(n)?(M.process.root({treedocument:re.options.model,data:e.results[0],tenant:w.getTenant()},w.getAuthorizedTypesWithParent()),UWA.is(re.dropinvit)&&a(".welcome_panel_container").size()>0?(re.dropinvit.remove(),re._init()):(re.utilities.saveObject(t),re._onWidgetRefresh())):I.warningAlert(Q.RichView_Notif_NotAuthorized)},onFailure:function(e,t){var i=S.getParseErrorMessage(e,t,Q.RichView_Notif_LoadError);I.errorAlert(i),re._initDropZone()},onTimeout:function(e){var t=S.getParseErrorMessage(e,null,Q.RichView_Notif_LoadError);I.errorAlert(t),re._initDropZone()}}):(re._curentlyLoadingReqSpec=!1,I.notifyAlert(G.rootExist)),re._reqCommandProxy.drop({id:t,appId:widget.getValue("appId"),widgetId:widget.id,action:"load"})},_subscribers:{subscribeToRefreshElement:function(){return re.mediator.subscribe("onRefreshElement",function(e){var t=e.element.attr("id"),i=e.refresh;re.options.model.getNodesByElementID(t)[0].getRichViewElement().refresh(i)}),!0},subscribeToUpdateElement:function(){return re.mediator.subscribe("onUpdateElement",function(e){for(var t=e.updates,i=re.options.model.getNodesById(e.physicalId),n=0;n<i.length;n++)i[n].getRichViewElement().update(Object.assign({},t))}),!0},subscribeToNavigationClick:function(){return re.mediator.subscribe("onNavigationClick",function(e){re.scroller.scrollToElement("#"+e,"top"),a("#"+e).hasClass("active")||a("#"+e).find(".rich-container-title-index,.rich-object-info").click()}),!0},subscribeToDragActionInsertRequirement:function(){return re.mediator.subscribe("onDrag:ActionInsertRequirement",function(e){var t=a(e.target).data("current-droppable");t&&updateHighlight(e.ui,t)}),!0},subscribeToRefresh:function(){return re.mediator.subscribe("onRefresh",function(e){re._calculateIndex(e)}),!0},subscribeToNotification:function(){return re.mediator.subscribe("onNotification",function(e){oe.add({className:e.className,message:e.message})}),!0},subscribeToInsert:function(){return re.mediator.subscribe("onInsert",function(e){re.authoring.insertWithPromise(e)}),!0},subscribeToReorder:function(){return re.mediator.subscribe("onReorder",function(e){re.authoring.reorder(e)}),!0},subscribeToOnNewRichView:function(){return re.mediator.subscribe("onNewRichView",function(e){re.utilities.saveObject(e),re._onWidgetRefresh()}),!0}},onInnerSelection:function(e,t){var i=re.getSelectedNode(),n=!1;if(i&&i.getID()!==e.getID()){i.unselect();var o="#"+i.options.elementID;a(o).toggleClass("active",!1),i.cleanupHighlightHeader(),e.select();var r="#"+e.options.elementID;a(r).toggleClass("active",!0),n=!0}var s=e.getOccurencePath();!re.externalSelection&&re._reqCommandProxy&&!1!==be?(re._reqCommandProxy.reqSelect({paths:[s],appId:widget.getValue("appId"),widgetId:widget.id}),re.externalSelection=!1):!1===be&&(be=!0);var l={paths:[s],attributes:{}};l.attributes[e.getID()]={tenant:w.getTenant()},i&&1!=n||re._padCommandProxy.select(l);var c=UWA.is(e.getRichViewElement())?e.getRichViewElement().container:null;re.current_selection={element:c,objectId:e.options.matrixID,physicalid:e.getID(),kindof:e.options.kindof,type:e.options.type,path:s,ParentLabel:e.getParent().options.title,label:e.options.title},N.publish("setObject",{objectId:e.getID(),envId:w.getTenant(),contextId:w.getSecurityContext()}),re.idCard.updateSelection(e),re._logger.log("An object has been selected in RichView",e)},onCleanSelection:function(e){if(0===re.contentPanel.find(".rich-object.active, .rich-container.active").length){re.options.model.unselectAll(),re.options.model.getRoots()[0].select(),re.current_selection={element:null,objectId:re.rootId,physicalid:re.rootId,kindof:re.options.root,type:re.options.parentType,path:[re.rootId],ParentLabel:re.options.model.getRoots()[0].getParent().options.title,label:re.options.model.getRoots()[0].options.title},!1!==e&&re._reqCommandProxy.reqSelect({paths:[[re.rootId]],appId:widget.getValue("appId"),widgetId:widget.id});var t={paths:[[re.rootId]],attributes:{}};t.attributes[re.rootId]={tenant:w.getTenant()},re._padCommandProxy.select(t),re.idCard.updateSelection()}},cleanAll:function(){re.richView.empty(),re._resetMembers(),re.utilities.cleanObject(),re.utilities.cleanWidgetTitle(),re.inject(re.container),re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model})},_onWidgetDestroy:function(){re._padCommandProxy.destroy(),re._reqCommandProxy.destroy(),re.cleanAll(),re._logger.log("onWidgetDestroy")},onToggleidCard:function(){},_onWidgetResize:function(){if(re._logger.log("onWidgetResize"),"true"===UWA.Element.getElement.call(document,".AfrActionBar").getAttribute("data-open"))var e=re.richView.parent().parent().height()-70;else e=re.richView.parent().parent().height()-20;re.richView.parent().height(e),re.options.height=e,re.navigationPanel&&re.navigationPanel.updateSize&&re.navigationPanel.updateSize(re.richView.parent().width(),re.options.height),re.navigation&&re.navigation.resizeList&&re.navigation.resizeList(),re._resizeContentPanel(),re.richviewinfos.setBody(),UWA.is(re._reqCommandProxy)&&re._reqCommandProxy.resizeRV()},_onWidgetRefresh:function(e){if(CKEDITOR){let e=Object.keys(CKEDITOR.instances);for(let t=0;e&&t<e.length;t++)CKEDITOR.instances[e[t]].destroy()}if(!0===e){var t=re.options.model,i=t.getRoots();t.initiateRefresh({roots:i,idCardEvents:re.idCard.idcard.modelEvents}).then(function(){re.mediator.publish("onScroll",{position:0}),re.utilities.setWidgetTitle()})}else re.richView.empty(),re._resetMembers(),re.inject(re.container);re._logger.log("onWidgetRefresh")},_onWidgetSearch:function(e){let t=e;_e&&_e.length>0?t=_e:ve&&!1===ve&&re._pagerview.hide();let i=re.options.model.getRoots()[0];if((i?i.getAllDescendants():[]).forEach(e=>e.cleanupHighlightHeader()),!t&&re._pagerview)return void re._pagerview.hide();let n=re.utilities.getRequestPayload(i.getID());if($.resetSearchProperties(),n.searchOptions={searchString:t},n.attributesToSearch=["ds6w:label","ds6w:type","CONTENT_TEXT"],$.setMaxNoOfNodesToSearch($.getMaxNoOfNodesToSearch()+1),w.determineAuthoredFlag())re._pagerview&&re._pagerview.hide(),I.notifyAlert(Q.SearchAuthoringModeError);else{let e=$.getMaxNoOfNodesToSearch();$.performSearch(n).then(function(t){let i=M.process.sortStructure({rootNodes:re.options.model.getRoots(),data:t.results,tenant:w.getTenant(),treedocument:re.options.model,authored:w.determineAuthoredFlag(),expandLevel:-1},w.getAuthorizedTypesWithParent());Y.executeViewUpdate.call(re,t,i,e)}).catch(e=>{let t=S.getParseErrorMessage(e);I.errorAlert(t)})}},_resetMembers:function(){Z={serverStart:0,serverEnd:0,buildStart:0,buildEnd:0,contentStart:0,contentEnd:0},{},0,9999,"",{},void 0,9999,15,te=45,ie={},ne={},re.scroller=null,this.shortcuts&&this.shortcuts.removeKeyboardEventsListener(),this.current_selection={},this.options.data=null,this.rootId=null,re.options.model.unselectAll(),re.options.model.removeRoots()},_initProxyEvents:function(){UWA.is(this._padCommandProxy)||(this._padCommandProxy=O.create({events:{onRefresh:function(e){re.utilities.refreshAuthoredObject(e)},onSelect:function(e,t){re.externalSelection=!0,re.utilities.syncViewOnExternalSelection(e),re.externalSelection=!1}}})),UWA.is(this._reqCommandProxy)||(this._reqCommandProxy=L.create({events:{onReqSelect:function(e,t){re.utilities.syncViewOnInternalSelection(e),console.log("rich view req select event",e),console.log("rich view req select data",t),console.log("rich view req select data widget id",widget.id),console.log("rich view req select data widget x3dSharedId",widget.getValue("x3dSharedId")),setTimeout(function(){if(e.data&&e.data.filtered){var t=e.data;re.applyFilter(t)}},1e3)},onDrop:function(e){re._curentlyLoadingReqSpec||(re._curentlyLoadingReqSpec=!0,re.utilities.loadSpec(e))},onAttach:function(e){re.externalSelection=!0,re.utilities.attachObject(e),re.externalSelection=!1},onDetach:function(e){UWA.is(e)&&UWA.is(e.path)&&(e.path.indexOf(re.rootId)>-1&&re.utilities.detachObject(e))},onReorder:function(e){re.utilities.reorderObject(e)},onResetTreeorder:function(e){re.utilities.resetObjectTreeorder(e)},onPreferenceModification:function(e){re.utilities.updatePreferences(e)},onRevise:function(e){re.utilities.reviseObject(e)},onRefresh:function(e){UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")&&re._onWidgetRefresh(!0)}}})),UWA.is(this._smvSelectionEvent)||(this._logger.log("Listening to topic DS/CATSmmUI/3DExperience/Proxy/localSelectionChanged"),this._smvSelectionEvent=T.subscribe("DS/CATSmmUI/3DExperience/Proxy/localSelectionChanged",function(e){re.utilities.syncViewOnExternalSelection(e)}))},_initMediatorEvents:function(){!0!==ge&&(ge=this._subscribers.subscribeToRefreshElement()),!0!==pe&&(pe=this._subscribers.subscribeToUpdateElement()),!0!==se&&(se=this._subscribers.subscribeToNavigationClick()),!0!==ae&&(ae=this._subscribers.subscribeToDragActionInsertRequirement()),!0!==le&&(le=this._subscribers.subscribeToNotification()),!0!==ce&&(ce=this._subscribers.subscribeToInsert()),!0!==de&&(de=this._subscribers.subscribeToReorder()),!0!==ue&&(ue=this._subscribers.subscribeToRefresh()),!0!==he&&(he=this._subscribers.subscribeToOnNewRichView())},_initKeyboardShortcuts:function(){null===this.shortcuts&&(this.shortcuts=U.init()),this.shortcuts.addKeyboardEventListener()},_initWidgetPreferences:function(){me=[];var e=this._defineOptionsForPref(),t=(new D).addPreferencesToWidget(e);me.push(t);var i=require("DS/PADUtils/PADSession"),n=require("DS/PADUtils/PADSettingsMgt"),o=widget.getValue("useIndexAccleration");i.setUseIndexPreference(o,void 0,!0),n.setSetting("useIndexAccleration",o)},_defineOptionsForPref:function(){var e={types:[]},t=re.options.rich.split(","),i=re.options.container.split(","),n=t.concat(i);return n.push(re.options.root),n.forEach(function(t){e.types.push(t)}),e},getAttributeInfo:function(e){return Re.attributeInfo.filter(function(t){return t.dataIndex===e||t.dbName===e})},scrollToElement:function(e){re.scroller.scrollToElement("#"+e,"top")},updateScopeInformation:function(e){this.idCard.updateScope(e)},getRelationshipType:function(e){return re.options.relationship[e]},getDefaultType:function(e){var t=e.replace(" ","_"),i=widget.getPreference("trm_types_"+t);return UWA.is(i)?widget.getValue("trm_types_"+t):e},saveCSRF:function(e){this._csrf=e},getCSRF:function(){return this._csrf},getTenant:function(){return w.getTenant()},isIndexMode:function(){return!w.determineAuthoredFlag()},getAuthoringContextHeader:function(){var e;if(UWA.is(this.CfgAuthoringContext))try{var t=this.CfgAuthoringContext.get();t&&t.AuthoringContextHeader&&(e=t.AuthoringContextHeader)}catch(e){console.warn("CfgAuthoringContext throw an error")}return e},_buildView:function(){re._initDivs();return _.mask(UWA.Element.getElement.call(document,".main-panel")),new o(function(e,t){re.options.height=re.richView.parent().height(),re.navigation=null,re._currentPosition=0,re._navigationPanel(),re._initializeEditInWord(),oe=new b({closable:!0,visible:!0,autoHide:!0,fullWidth:!0,hideDelay:3e3}).inject(UWA.Element.getElement.call(document,re.contentPanel.selector),"top");var i={selectables:re.utilities.getSelectable(),id:re.options.data};m.getInfo(i).then(function(t){var i=M.process.createNode({treedocument:re.options.model,data:t[0],tenant:w.getTenant()},w.getAuthorizedTypesWithParent());re.idCard=new v,re.idCard.init({nodeModel:i,container:re.idCardContainer,modelEvents:re.modelEvents}),re._scrollView(),re._onWidgetResize(),re._attachControls(),e()})})},getProxyContentData:function(e,t){var i,n,o=this,r=this.context.OSLCProviders,s="[ "+Q.get("ExternalObject_LoadingError")+" ]",l=Q.get("ExternalObject_LoadingError");if(UWA.is(e.getClosest,"function"))i=e.getClosest(".rich-object[data-physicalid][data-relid]");else{i=UWA.is(e.closest,"function")?e.closest(".rich-object[data-physicalid][data-relid]"):function(e,t){for(;(e=e.parentElement)&&!(e.matches||e.matchesSelector||e.msMatchesSelector).call(e,t););return e}(e,".rich-object[data-physicalid][data-relid]"),console.error('"nodeToSelect" is not a UWA element!')}if(!UWA.is(i)&&!UWA.is(r))return console.error('Proxy content data cannot be retreived! Check rich-object for (1)                  "data-relid", (2) "data-physicalid" and (3) check if context.OSLCProviders is defined.'),void(UWA.is(o.mediator)&&I.errorAlert(l));n=e.hasClassName("content-data")?e:e.getElement(".content-data");var c=i.attributes["data-physicalid"].value,d=i.attributes["data-relid"].value,u=UWA.createElement("span",{class:"richview-loading-external-indication",html:Q.get("ExternalObject_LoadingContent")+" "});new y({class:"richview-spinner"}).inject(u).show();n.innerHTML="",u.inject(n),E.getInfo({securityContext:w.getSecurityContext(),pid:c,onComplete:function(e){e=w.parseResponse(e);for(var t=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0],i=t["ProxyItem.Proxy_Service"],n=t["ProxyItem.Proxy_URL"],c="",u="",h=0;h<r.repositories.length;h++){i===r.repositories[h].id&&(c=r.repositories[h].rootUrl,u=r.repositories[h].oauth);break}var p=o.context.options.model.getNodesByRelId(d)[0].getRichViewElement();E.getOSLCContent({service:i,doors_url:c+n,tenant:w.getTenant(),Oauth:u,method:"GET",dataType:"xml",onComplete:function(e){var t;e=a(a.parseXML(e));UWA.is(e[0].lookupNamespaceURI("jazz_rm"))?(t=e[0].getElementsByTagNameNS(e[0].lookupNamespaceURI("jazz_rm"),"primaryText"),UWA.is(t[0])?p.update({content:t[0].firstChild.innerHTML}):(console.error("Tag with proxy req content was not found in response."),p.update({content:s}))):(t=e[0].getElementsByTagNameNS(e[0].lookupNamespaceURI("dcterms"),"description"),UWA.is(t[0])?p.update({content:t[0].innerHTML}):(console.error("Tag with proxy req content was not found in response."),p.update({content:s})))},onFailure:function(e){o._logger.log(e);var t=S.getParseErrorMessage(e,null,l);I.errorAlert(t),p.update({content:s})},onTimeout:function(e){var t=S.getParseErrorMessage(e,null,l);I.errorAlert(t),p.update({content:s}),o._logger.log("RequirementWebServices.getInfo timed out")}})},onFailure:function(e){o._logger.log(e);var t=S.getParseErrorMessage(e,null,l);I.errorAlert(t),proxy_object.update({content:s})},onTimeout:function(e){var t=S.getParseErrorMessage(e,null,l);I.errorAlert(t),proxy_object.update({content:s}),o._logger.log("RequirementWebServices.getInfo timed out")}})},showProgressBar:function(){re.utilities.loading()},hideProgressBar:function(){re.utilities.loading(!0)},getSetting:function(t){return e.is(t,"string")&&e.is(Re[t])?Re[t]:null},_generateObjectIdx:function(e){e.getLevel();var t=e.getParent();if(-1==t._nodeDepth)return{index:0,containerIdx:0};var i="",n="";return re._isContainer(t.options.type)||re._isContainer(t.options.kindof)||!0===t.isRoot()?(i=!0===t.isRoot()?"0":t.getRichViewElement().index,n=re.GetRichObjectLevel(e)):(i=t.getRichViewElement().containerIdx,n=re.GetRichObjectLevel(e),n=t.getRichViewElement().index+"."+n),{index:n,containerIdx:i}},_fetchData:function(e){return Z.globalStart=Z.serverStart=(new Date).getTime(),new o(function(t,i){re._buildView().then(function(){re._startEdition();var n=re.utilities.getRequestPayload(e);E.expand({json:n,securityContext:w.getSecurityContext(),onComplete:function(e){e=w.parseResponse(e),e=(e=UWA.is(e,"string")?JSON.parse(e):e).results?e.results:e,Z.serverEnd=Z.buildStart=(new Date).getTime(),re._logger.log("Server response: "+(Z.serverEnd-Z.serverStart)/1e3),re._richView(e),Z.buildEnd=Z.contentStart=(new Date).getTime(),re._logger.log("Build view: "+(Z.buildEnd-Z.buildStart)/1e3),UWA.is(re.navigation)||(re.navigation=new u({mediator:re.mediator,selector:re.container+" .rich-container",preview:re.container,context:re.context}).inject(re.container+" .navigation-panel .syc-panel-tab-contents")),void 0===re.dragElementId?re.idCard.updateSelection():re.dragElementId=void 0,re.mediator.publish("onScroll",{position:0}),1==ve&&(be=!1,re._onWidgetSearch()),t()},onFailure:function(e){var t=S.getParseErrorMessage(e,null,Q.RichView_Notif_FatalError);I.errorAlert(t),re._initDropZone(),re.utilities.cleanObject(),i()},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t),i()}})})})},_scrollView:function(){if(re.scroller)return!0;var e=!1,t={scroll:function(t,i,n,o){e||(e=!0,setTimeout(function(){re._currentPosition=Math.abs(parseInt(a(re.scroller.elements.yScrollbar).css("top"),10)),re.mediator.publish("onScroll",{position:re._currentPosition}),e=!1},100))}.bind(this)};re.scroller=new c({element:UWA.Element.getElement.call(document,re.container+" .richview-editor-content")}).inject(UWA.Element.getElement.call(document,re.container+" .richview-editor-container"),"top"),re.scroller.elements.content.addEvents(t)},_calculateIndex:function(e){var t,i=Array(16).fill(0),n=Array(16).fill(0),o="0",r=0,s=0,a=0,l=0,c=!1;if(!UWA.is(e,"array")){var d=re.options.model.getRoots()[0].getAllDescendants();e=[re.options.model.getRoots()[0]].concat(d),c=!0}for(var u=0;u<e.length;u++){var h=e[u],p=parseInt(h._nodeDepth),g=h.options.type,m=h.options.kindof;if(this._isContainer(g)||this._isContainer(m)){let e="";if(a=1,p<l)for(var f=p;f<i.length-1;f++)i[f+1]=0;if(p<r)for(f=p;f<i.length-1;f++)n[f+1]=0;if(l=p,s=p,p<=16){i[p]++;for(var v=1;v<p;v++)e=e+i[v]+".";o=e+i[p]}if(c)h.getRichViewElement().update({containerIdx:o});else h.conatinerIdx=o}else if(this._isRich(g)||this._isRich(m)){let e="";if(p<s&&(a=0),p<r)for(f=p;f<n.length-1;f++)n[f+1]=0;if((s=Math.min(p,s))>=p){for(v=1;v<p-1;v++)e=e+i[v]+".";p>0&&(o=e+i[p-1])}if(p<=16){n[p]++;for(v=Math.max(s,1)+a;v<p;v++)e=e+n[v]+".";t=e+n[p]}if(r=p,c)h.getRichViewElement().update({containerIdx:o,index:t});else h.conatinerIdx=o,h.richObjIdx=t}}},_richView:function(e){({}),0,9999,"",{},void 0,9999;var t=w.determineAuthoredFlag();let i=new Map;var n=re.options.model.getRoots();M.process.streaming({root_node:n[0],data:e,tenant:w.getTenant(),treedocument:re.options.model,nodeMap:i,authored:t},w.getAuthorizedTypesWithParent());var o=[];this._isRich(n[0].options.kindof)&&o.push(n[0]);var r=n[0].getAllDescendants();o=o.concat(r);var s=a(".scroller-content",this.richViewEditorContainer).length>0?a(".scroller-content",this.richViewEditorContainer):this.richViewEditorContent,l=[];0===o.length&&(s.empty(),this._generateFakeContainer()),i.set(n[0].options.resourceid,n[0].options),re.options.model.sortInTreeOrder(n),re._calculateIndex(o);for(var c=0;c<o.length;c++){var d=o[c];let e=(d.getOccurencePath().length-1)/2;d.setLevel(e);var u=i.get(d.options.resourceid+"_"+d.options.relationid);u||(u=i.get(d.options.resourceid)),u.objectId=u.id,u.physicalId=u.resourceid,u.id=ee(),u.title=u.label||u["ds6w:label"];var h=UWA.is(u.type,"object")?u.type.value:u.type,p=u["type.kindof"];this._isContainer(h)||this._isContainer(p)?l.push(this._richContainer(u,d)):(this._isRich(h)||this._isRich(p))&&l.push(this._richObject(u,d))}if(s.append(l),UWA.is(re.eventInit)&&re.eventInit?re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model}):setTimeout(function(){re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model})},1e3),_.unmask(UWA.Element.getElement.call(document,".main-panel")),re.dragElementId){let e=re.options.model.getNodesById(re.dragElementId)[0];re.onInnerSelection(e),re.scroller.scrollToElement("#"+e.getRichViewElementID(),"center")}},_generateFakeContainer:function(){var e=a(".scroller-content",this.contentPanel).length>0?a(".scroller-content",this.contentPanel):this.contentPanel;fe=!0,this.fakeContainer=new g({mediator:re.mediator,id:ee(),objectId:re.options.data,physicalId:re.options.data,type:re.options.parentType,kindof:re.options.parentType,title:Q.RichView_Tooltip_NoObjects,index:"",connection:"",connectionId:"",level:1,editable:"false",droppable:{Chapter:"over",Comment:"over",Requirement:"over","text/plain":"before,after,over","text/html":"before,after,over","text/searchitems":"before,after,over",Text:"before,after,over"},context:re.context,fake:!0}).create(),this.fakeContainer.container.addClass("fake-rich-container"),e.append(this.fakeContainer.container),this.fakeContainer.container.find(".rich-container-title-index").click()},_richContainer:function(e,t){re=this;var i=t.conatinerIdx;if(!t.conatinerIdx){for(var n=1,o=t;UWA.is(o);){o=o.getPreviousBrother(),UWA.is(o)&&(n=re.GetContainerLevel(o),(re._isContainer(o.options.type)||re._isContainer(o.options.kindof))&&(n+=1));break}for(var r=n,s=t;UWA.is(s)&&(s=s.getParent(),UWA.is(s));)if(""!==s.options.type&&(re._isContainer(s.options.type)||re._isContainer(s.options.kindof))){r=""==r?s._options.level:s.getRichViewElement().index+"."+r;break}i=r}var a=e["ds6w:label"]?e["ds6w:label"]:e.title;e.title=""!==a?a:e.name,e.resourceid=e.resourceid?e.resourceid:e.physicalid,e.relationid=e.relationid?e.relationid:e["physicalid[connection]"],e.level=t.getDepth(),e.from=e["from.physicalid[connection]"]?e["from.physicalid[connection]"]:e.from;var l=UWA.is(e.type,"object")?e.type.value:e.type,c=w.getKindOf(l);return new g({model:re.options.model,node:t,rootId:re.rootId,mediator:re.mediator,id:e.id,objectId:e.objectId,physicalId:e.resourceid,type:l,kindof:c,title:e.title,cestamp:e.cestamp,index:i,connection:e["ds6w:businessType"],connectionId:e.relationid,parentId:e.from,level:e.level,droppable:void 0!==re.options.droppable[l]?re.options.droppable[l]:re.options.droppable[c],context:re.context,cestamp:e.cestamp}).create().container},_richObject:function(e,t){var i;e.parentId=e.from,i=t&&t.richObjIdx&&t.conatinerIdx?{index:t.richObjIdx,containerIdx:t.conatinerIdx}:re._generateObjectIdx(t);var n=e["ds6w:label"]?e["ds6w:label"]:e.title;e.title=""!==n?n:e.name,e.resourceid=e.resourceid?e.resourceid:e.physicalid,e.relationid=e.relationid?e.relationid:e["physicalid[connection]"],e.level=t.getDepth(),e.from=e["from.physicalid[connection]"]?e["from.physicalid[connection]"]:e.from;var o=UWA.is(e.type,"object")?e.type.value:e.type,r=w.getKindOf(o);return new p({model:re.options.model,node:t,rootId:re.rootId,mediator:re.mediator,id:e.id,objectId:e.objectId,physicalId:e.resourceid,type:o,kindof:r,title:e.title,index:i.index,containerIdx:i.containerIdx,content:e.content,connection:e["ds6w:businessType"],connectionId:e.relationid,parentId:e.from,level:e.level,type_icon_url:e.type_icon_url||e.icon,droppable:void 0!==re.options.droppable[o]?re.options.droppable[o]:re.options.droppable[r],fetchContent:void 0!==e.fetchContent&&e.fetchContent,context:re.context,cestamp:e.cestamp}).create().container},_selectionMgt:function(e,t){var i=re.getSelectedNode(),n=a(e).parents(t+":first"),o=n.data("relid"),r=n.data("physicalid"),s=re.options.model.getNodesByRelId(o)[0];if(UWA.is(s)||(s=re.options.model.getNodesById(r)[0]),i){var l=i.getRelationID();if(o===l&&null!=o)1!=ve?(s.select(),n.toggleClass("active",!0),re.onInnerSelection(s)):(s.unselect(),n.toggleClass("active",!1),re.mediator.publish("onUnselect:object",n),re.onCleanSelection(!1));else{if(i.cleanupHighlightHeader(),!n.hasClass("fake-rich-container")){var c=re.contentPanel.find('[data-relid="'+l+'"]');if(0==c.length&&i.isRoot()){var d=i.getID();c=re.contentPanel.find('[data-physicalid="'+d+'"]')}c.toggleClass("active",!1),re.options.model.unselectAll(),s.select(),re.onInnerSelection(s)}n.toggleClass("active",!0)}}else s.select(),n.toggleClass("active",!0),re.onInnerSelection(s)},_attachControls:function(){this.contentPanel.on("click",".rich-container-title-index,.rich-container-info",function(e){re._selectionMgt(this,".rich-container")}),this.contentPanel.on("click",".rich-object-info,.rich-object-container-index,.rich-object-index",function(e){re._selectionMgt(this,".rich-object")}),this.contentPanel.on("click",".collapsable-container",function(e){re._logger.log("Click",e);var t=a(this).parents(".rich-container:first"),i=t.attr("id"),n=parseInt(t.data("level"));void 0===ne[i]||!1===ne[i]?(a(".fonticon",this).removeClass("fonticon-minus-squared").addClass("fonticon-plus-squared"),ne[i]=!0):(a(".fonticon",this).removeClass("fonticon-plus-squared").addClass("fonticon-minus-squared"),ne[i]=!1);for(var o=t.nextAll(),r=0;r<o.length;r++){var s=o.eq(r);if(!((s.hasClass("rich-object")||s.hasClass("rich-container"))&&parseInt(s.data("level"))>n))break;ne[i]?s.addClass("collapsed-object"):s.removeClass("collapsed-object")}})},_startEdition:function(){re._objectRichEditor=new h({mediator:re.mediator,selector:".rich-object",target:".content-data",commandProxy:re._padCommandProxy,reqCommandProxy:re._reqCommandProxy,richView:re}),re._containerRichEditor=new h({mediator:re.mediator,selector:".rich-container",target:".rich-container-title-editable",commandProxy:re._padCommandProxy,reqCommandProxy:re._reqCommandProxy,richView:re}),re._objectTitleRichEditor=new h({mediator:re.mediator,selector:".rich-object",target:".rich-object-title-editable",commandProxy:re._padCommandProxy,reqCommandProxy:re._reqCommandProxy,richView:re}),re._objectRichEditor.startEditionForAll(),re._containerRichEditor.startEditionForAll(),re._objectTitleRichEditor.startEditionForAll()},updateRichContent:function(e){re._objectRichEditor.updateHtmlContent(e)},_navigationPanel:function(){var e=new d(.2,a(this.richView).width(),this.options.height,"left");e.contents.style.overflowY="hidden",e.createTab("navigationMaintab").setIconClassName("fonticon fonticon-list"),this.navigationPanel.append&&this.navigationPanel.append(e.container),e.container.addEventListener("syc-panel-resize",function(){re._resizeContentPanel(),widget.setValue("trm_navigation_open",re.navigationPanel.isVisible())}),this.navigationPanel=e,this._resizeContentPanel(),widget.getValue("trm_navigation_open")||widget.addPreference({name:"trm_navigation_open",type:"hidden",defaultValue:!1}),!0===widget.getValue("trm_navigation_open")&&!1===this.navigationPanel.isVisible()?(this.navigationPanel.open(),this._resizeContentPanel()):!1===widget.getValue("trm_navigation_open")&&!0===this.navigationPanel.isVisible()&&(this.navigationPanel.close(),this._resizeContentPanel())},_resizeContentPanel:function(){var e=this.richViewEditorContainer,t=this.navigationPanel;if(t&&t.isVisible){var i=!1===t.isVisible()?0:t.size;e.css("margin-left",i+te)}},_isContainer:function(e){return this.options.container.indexOf(e)>=0},_isRich:function(e){return this.options.rich.indexOf(e)>=0},_plainTextFromHtml:function(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText},setTraceabiltyScope:function(e,t){this._traceabilityScope.id=e,this._traceabilityScope.title=t},getTraceabilityScope:function(){return this._traceabilityScope},getRootId:function(){return re.rootId},getSelectedElement:function(){return this.current_selection&&Object.keys(this.current_selection).length>0?this.current_selection:null},getSelectedNodes:function(){return re.options.model.getSelectedNodes()},getSelectedNode:function(){return re.options.model.getSelectedNodes()[0]},getSecurityContext:function(){return{SecurityContext:w.getSecurityContext()}},getPADTreeDocument:function(){return re.options.model},beginBlockingTransaction:function(e){(e=UWA.is(e)&&"string"!=typeof e?e:document.querySelector(re.container))&&_.mask(e)},endBlockingTransaction:function(e){(e=UWA.is(e)?e:document.querySelector(re.container))&&_.unmask(e)},author:function(e){k.setAuthoringState(e,Q.disabling_index_authored_operation)},refreshOnCreate:function(e,t){Array.isArray(e)&&(e=e[0]);var i,n=!1;if(UWA.is(e["ds6w:type"])){i=e["ds6w:type"];var o=w.getKindOf(i);-1==re.options.root.indexOf(i)&&-1==re.options.root.indexOf(o)||(n=!0)}if(!0===n){var r=e.resourceid;this.options.data=r,M.process.root({treedocument:re.options.model,data:e,tenant:w.getTenant()},w.getAuthorizedTypesWithParent()),this._curentlyLoadingReqSpec=!1,UWA.is(this.dropinvit)&&a(".welcome_panel_container").size()>0?(this.dropinvit.remove(),this._init()):(re.utilities.saveObject(r),re._onWidgetRefresh()),!0===t&&re._reqCommandProxy.drop({id:r,appId:widget.getValue("appId"),widgetId:widget.id,action:"new"})}else I.warningAlert(Q.RichView_Notif_NotAuthorized)},refreshOnInsert:function(e,t,i,n){var o,r,s=this,a=s.getSelectedElement();r=a.element,a.position=n||"over",a.content="",a.fetchContent=!0,a.target={element:r,id:UWA.is(r)?r.attr("id"):""},e.forEach(function(e){o=UWA.is(t)?t:s.authoring.placeholder(a),s.authoring._refreshOnInsert(e,o,null,!0,i)})},refreshOnRemove:function(e,t){let i=e.path.length,n=e.path[i-2],o=re.options.model.getNodesByRelId(n);e.PhysicalDelete&&(o.forEach(e=>{var t=e.options.elementRV.container,i=e.getAllDescendants();if(UWA.is(i)&&i.length>0)for(var n=0;n<i.length;n++){var o=i[n];o.getRichViewElement().container.remove(),o.remove()}t.remove(),e.unselect(),e.remove()}),re.onCleanSelection(!1),re.mediator.publish("onRefresh")),!0===t&&re._reqCommandProxy.detach({appId:widget.getValue("appId"),path:e.path,physicalid:e.physicalid,PhysicalDelete:e.PhysicalDelete}),re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model}),0===a(".rich-container,.rich-object:not(.placeholder)").length&&re._onWidgetRefresh()},authoring:{insertWithPromise:function(e){var t,i=re.authoring.placeholder(e);function n(){var e=re._promisesData.shift();return re.authoring.insert(e)}re._promisesData.push(i),re._promises.push(n),t=o.resolve(),re._promises.forEach(function(e){t=t.then(n)})},placeholder:function(e){var t=ee(),i=new p({id:t+"_placeholder",title:'<span class="fonticon fonticon-fonticon fonticon-dot-3"></span>',content:e.content,droppable:void 0!==re.options.droppable[e.type]?re.options.droppable[e.type]:re.options.droppable[e.kindof],placeholder:!0}).create();!0===fe&&(e.position="over");var n=void 0,o=void 0;if(UWA.is(e.target.element)){var r=re.options.model.getNodesByElementID(e.target.element.attr("id"))[0];e.target.element;n=(n="over"!==e.position?r.getParent():r).getRichViewElement()}else n={type:re.options.model.getRoots()[0].options.type,objectId:re.options.model.getRoots()[0].getID(),kindof:re.options.model.getRoots()[0].options.kindof};switch(UWA.is(n)||(n={type:re.options.model.getRoots()[0].options.type,objectId:re.options.model.getRoots()[0].getID(),kindof:re.options.model.getRoots()[0].options.kindof}),e.relationship=re.options.relationship[n.type]||re.options.relationship[n.kindof],e.position){case"before":e.target.element.before(i.container);var s=re.options.model.getNodesByElementID(e.target.element.attr("id"))[0];e.nextSibling={id:s.getID(),relId:s.getRelationID()};var l=s.getPreviousBrother();UWA.is(l)?e.previousSibling={id:l.getID(),relId:l.getRelationID()}:e.previousSibling={},o=s.getLevel();break;case"after":var c=(l=re.options.model.getNodesByElementID(e.target.element.attr("id"))[0]).getAllDescendants(),d=l.getRichViewElement().container;if(UWA.is(c)&&c.length>0)d=c[c.length-1].getRichViewElement().container;d.after(i.container),e.previousSibling={id:l.getID(),relId:l.getRelationID()};s=l.getNextBrother();e.nextSibling={},UWA.is(s)&&(e.nextSibling={id:s.getID(),relId:s.getRelationID()}),o=l.getLevel();break;case"over":if(UWA.is(e.target.element)){var u=re.options.model.getNodesByElementID(e.target.element.attr("id"))[0],h=u.getChildren(),g=e.target.element;if(UWA.is(h)&&h.length){g=(m=h[h.length-1]).getRichViewElement().container;var m;c=m.getAllDescendants();if(UWA.is(c)&&c.length>0)g=(m=c[c.length-1]).getRichViewElement().container}g.after(i.container),o=u.getLevel()+1,e.previousSibling={},e.nextSibling={},!0===fe&&(n={type:re.options.model.getRoots()[0].options.type,objectId:re.options.model.getRoots()[0].getID(),kindof:re.options.model.getRoots()[0].options.kindof},o=1)}else{var f=a(".rich-container,.rich-object:not(.placeholder)");f.size()>0&&(e.target.element=f.eq(f.size()-1)),e.target.element.after(i.container),o=1}}return"insertNew"!==e.operation&&_.mask(UWA.Element.getElement.call(e.target.element.parent()[0],"#"+t+"_placeholder")),e.parent=n,e.newLevel=o,e.placeholder=i,e},insert:function(e){switch(e.operation){case"insertNew":e.hasOwnProperty("content")&&[].push({name:"Content Data",value:UWA.Utils.base64Encode(re.utilities.jsonEscape(e.content))},{name:"Content Type",value:e.contentType},{name:"Content Text",value:UWA.Utils.base64Encode(re._plainTextFromHtml(e.content))});var t=null,i=null;UWA.is(e.previousSibling)&&null!=e.previousSibling.relId&&(t=e.previousSibling.relId),UWA.is(e.nextSibling)&&null!=e.nextSibling.relId&&(i=e.nextSibling.relId);var n=[];(UWA.is(e.previousSibling)||UWA.is(e.nextSibling))&&n.push(t+","+i),re.cmdOption={randomId:ee(),selectedIDs:n,data:e},require(["DS/TraceableRequirementsUtils/Command/ReqKeyBoardShortCut_InsertCmd"],function(e){new e(re.cmdOption).execute()})}},_refreshOnRevise:function(e,t,i,n,o,r,s){UWA.is(e.level)||(e.level=t.newLevel);var l=null;null!=r&&null!=r&&(l=r.container[0]);var c=re.options.model.getRoots(),d=M.process.createNode({data:e,tenant:w.getTenant()},w.getAuthorizedTypesWithParent());if(UWA.is(t.parent.id)&&""!==t.parent.id&&(c=re.options.model.getNodesByElementID(t.parent.id)),UWA.is(s.getParent()))for(var u=s.getParent()._options.children.length-1;u>=0;u--)if(s.getParent()._options.children[u]._options.physicalID==s._options.physicalID){s.getParent()._options.children.splice(u,1);break}re.mediator.publish("onRefresh"),c[0].addChild(d),re.options.model.sortInTreeOrder(c),UWA.is(i)||(i=t.placeholder,t.position,e.objectId=e.id,e.physicalId=e.physicalid,e.id=ee(),e.level=t.newLevel,e.content=t.content,UWA.is(o)&&"insertExisting"===o&&(t.fetchContent=!0),e.fetchContent=!!UWA.is(t.fetchContent)&&t.fetchContent,UWA.is(e["attribute[Title]"])?e.title=e["attribute[Title]"]:e.title="");var h=null,p=UWA.is(e.type,"object")?e.type.value:e.type,g=e["type.kindof"];if(re._isContainer(p)||re._isContainer(g)?(h=re._richContainer(e,d),!0,!1):(re._isRich(p)||re._isRich(g))&&(d.options.externalObject&&(e.fetchContent=!1),h=re._richObject(e,d),!1,!0),d.options.externalObject){var m=d.getRichViewElement();m.update({content:"[ "+Q.ExternalObject_DisplayContent+" ]",editable:!1,isDocx:!0}),m.content[0].addEventListener("click",function(e){re.getProxyContentData(this,e)})}i.container.after(h),i.container.remove(),!0===fe&&(re.fakeContainer.container.remove(),!0,fe=!1),h.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1e3,"swing",function(){a(this).removeClass("highlight-creation",1e3,"swing")}),setTimeout(function(){d.options.externalObject&&d.getRichViewElement().info.click()},100),re.mediator.publish("onRefresh"),re.scroller.scrollToElement("#"+h.attr("id"),"center"),re.mediator.publish("onScroll",{position:re._currentPosition}),re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model});var f=w.determineAuthoredFlag();if(UWA.is(o)&&"insertExisting"===o&&!d.options.externalObject){var v=re.utilities.getRequestPayload(e.physicalid);E.expand({json:v,securityContext:w.getSecurityContext(),onComplete:function(t){t=w.parseResponse(t);var i=UWA.is(t,"string")?JSON.parse(t):t;i=i.results?i.results:i;let n=new Map;M.process.streaming({root_node:d,data:i,tenant:w.getTenant(),nodeMap:n,treedocument:re.options.model,authored:f},w.getAuthorizedTypesWithParent());var o=d.getAllDescendants(),r=(UWA.is(e.type,"object")?e.type.value:e.type,d.getRichViewElement().container[0].parentNode);null===r&&(r=a(".scroller-content",re.contentPanel).length>0?a(".scroller-content",re.contentPanel):re.contentPanel);d.getRichViewElementID(),d.getRichViewElement().container;for(var s=0;s<o.length;s++){for(var c=o[s],u=i[s],h=!1,p=c._options.name,g=0;g<i.length;g++)if(i[g].name==p){u=i[g],h=!0;break}if(!0===h){u.objectId=u.id,u.physicalId=u.physicalid,u.id=ee(),u.content="Loading...",u.fetchContent=!0,u.title=re.utilities.decodeHtml(u.title||u["attribute[Title]"]),u.level=parseInt(u.level)+parseInt(e.level);var m=UWA.is(u.type,"object")?u.type.value:u.type,v=w.getKindOf(m),b=null;re._isContainer(m)||re._isContainer(v)?b=re._richContainer(u,c):(re._isRich(m)||re._isRich(v))&&(b=re._richObject(u,c)),null!=l?r.insertBefore(b[0],l):r.append(b[0])}}re.mediator.publish("onRefresh"),re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model})},onFailure:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)}})}re.options.model.sortInTreeOrder(c)},_refreshOnInsert:function(e,t,i,n,o){UWA.is(e.level)||(e.level=t.newLevel),e.type_icon_url=e.type_icon_url||e.icon;var r,s=re.options.model.getRoots(),l=M.process.createNode({data:e,tenant:w.getTenant()},w.getAuthorizedTypesWithParent()),c=e["from.physicalid[connection]"];UWA.is(c)&&""!==c&&(s=re.options.model.getNodesById(c)),s[0].addChild(l),re.options.model.sortInTreeOrder(s),r=t.position,UWA.is(i)||(i=t.placeholder,e.objectId=e.id,e.physicalId=e.physicalid,e.id=ee(),e.level=t.newLevel,e.content=t.content,UWA.is(o)&&"insertExisting"===o&&(t.fetchContent=!0),e.fetchContent=!!UWA.is(t.fetchContent)&&t.fetchContent,e.title=UWA.is(e["attribute[Title]"])?e["attribute[Title]"]:e["ds6w:label"],e.title=UWA.is(e.title)?e.title:""),UWA.is(t.path)||(t.target.element.hasClass("fake-rich-container")?t.path=[re.rootId,e["physicalid[connection]"],e.physicalId]:t.path=s[0].getOccurencePath()),!1!==n&&re._reqCommandProxy.attach({path:t.path,object:e,selection:re.getSelectedNode().getOccurencePath(),mode:"after"===r?"append":"insert"});var d=null,u=UWA.is(e.type,"object")?e.type.value:e.type,h=e["type.kindof"];if(re._isContainer(u)||re._isContainer(h)?(d=re._richContainer(e,l),!0):(re._isRich(u)||re._isRich(h))&&(l.options.externalObject&&(e.fetchContent=!1),d=re._richObject(e,l),!1),l.options.externalObject){var p=l.getRichViewElement();p.update({content:"[ "+Q.ExternalObject_DisplayContent+" ]",editable:!1,isDocx:!0}),p.content[0].addEventListener("click",function(e){re.getProxyContentData(this,e)})}i.container.after(d),i.container.remove(),!0===fe&&(re.fakeContainer.container.remove(),!0,fe=!1),d.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1e3,"swing",function(){a(this).removeClass("highlight-creation",1e3,"swing")}),setTimeout(function(){l.options.externalObject&&l.getRichViewElement().info.click()},100),re.mediator.publish("onRefresh",{level:parseInt(l.getRichViewElement().level)}),re.scroller.scrollToElement("#"+d.attr("id"),"center"),re.mediator.publish("onScroll",{position:re._currentPosition}),re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model});var g=w.determineAuthoredFlag();if(UWA.is(o)&&"insertExisting"===o&&!l.options.externalObject){var m=re.utilities.getRequestPayload(e.physicalid);E.expand({json:m,securityContext:w.getSecurityContext(),onComplete:function(t){t=w.parseResponse(t);var i=UWA.is(t,"string")?JSON.parse(t):t;i=i.results?i.results:i;let n=new Map;M.process.streaming({root_node:l,data:i,tenant:w.getTenant(),nodeMap:n,treedocument:re.options.model,authored:g},w.getAuthorizedTypesWithParent()),re.options.model.sortInTreeOrder(re.options.model.getRoots());for(var o=l.getAllDescendants(),r=[],s=0;s<i.length;s++){var a=o[s],c=i[s],u=!1,h="";if(void 0!==a){h=a._options.name;for(var p=0;p<i.length;p++)if(i[p].name==h){c=i[p],u=!0;break}}if(!0===u){c.objectId=c.id,c.physicalId=c.physicalid,c.id=ee(),c.content="Loading...",c.fetchContent=!0,c.title=re.utilities.decodeHtml(c.title||c["attribute[Title]"]),c.level=parseInt(c.level)+parseInt(e.level);var m=UWA.is(c.type,"object")?c.type.value:c.type,f=w.getKindOf(m);re._isContainer(m)||re._isContainer(f)?r.push(re._richContainer(c,a)):(re._isRich(m)||re._isRich(f))&&r.push(re._richObject(c,a))}}d.after(r),re.mediator.publish("onRefresh"),re.scroller.scrollToElement("#"+d.attr("id"),"center"),re.mediator.publish("onScroll",{position:re._currentPosition}),re.options.model.getModelEvents().publish({event:"setPathTags",context:re.options.model})},onFailure:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)}})}},reorder:function(e){e.source.element,e.target.element;var t=e.source.id,i=(e.target.id,e.source.element.prev()),n=re.options.model.getNodesByElementID(e.source.id)[0],o=n.getAllDescendants(),r=new Array;r.push(n.getRichViewElement().container);for(var s=0;s<o.length;s++){var l=o[s];r.push(l.getRichViewElement().container),l.getRichViewElement().container}var c=re.options.model.getNodesByElementID(e.target.id)[0],d=void 0;if((d="over"===e.position?c:c.getParent()).getOccurencePath().indexOf(n.getOccurencePath()[n.getOccurencePath().length-1])>-1)return I.errorAlert(Q.RichView_Notif_FailureAndRollback),void re.utilities.loading(!0);var u={},h=void 0,p={},g=void 0;"after"===e.position?(u={id:(h=c).getID(),relid:h.getRelationID()},g=c.getNextBrother(),UWA.is(g)&&(p={id:g.getID(),relid:g.getRelationID()})):"before"===e.position&&(p={id:(g=c).getID(),relid:g.getRelationID()},h=c.getPreviousBrother(),UWA.is(h)&&(u={id:h.getID(),relid:h.getRelationID()}));var m=d.options["type.kindof"],f=JSON.parse(X)[m],v=n.options["type.kindof"];if(f&&f[v]){switch(e.position){case"before":e.target.element.before(r);break;case"after":var b=c.getChildren();if(UWA.is(b)&&b.length>0){var y=b[b.length-1],R=y.getAllDescendants();if(R.length>0)y=R[R.length-1];y.getRichViewElement().container.after(r)}else c.getRichViewElement().container.after(r);break;case"over":var C=d.getChildren();if(UWA.is(d.getChildren())&&C.length>0){var x=C[C.length-1],D=x.getAllDescendants();if(D.length>0)x=D[D.length-1];x.getRichViewElement().container.after(r)}else d.getRichViewElement().container.after(r)}re.scroller.scrollToElement("#"+t,"center");for(let e of r)e.removeClass("being-dragged droppable-child");var A={};A.prevRelID=u.relid,A.nextRelID=p.relid;var T=[n.getRelationID()],U=re.authoring._createReorderInput(d,A,T);E.reorder({securityContext:w.getSecurityContext(),json:U,onComplete:function(e){var t=UWA.is(e,"string")?JSON.parse(e):e;if("success"==t.status){re.context.author(!0);var s=t.results,l=Object.keys(s);l=(l=l.filter(e=>"internalImpacts"!==e)).filter(e=>"reset"!==e);var c,u=n;c=re.authoring._createReorderResponce(l,u,U,s);var h=n.getParent().getOccurencePath(),p=d.getOccurencePath();if(null!=t.results.internalImpacts){var g=Object.keys(t.results.internalImpacts)[0];re.options.model.getNodesByRelId(g)[0].setRelationOrder(t.results.internalImpacts[g])}if(t.results.reset?(re._reqCommandProxy.resetTreeorder({appId:widget.getValue("appId"),id:d.getID()}),re.utilities.resetObjectTreeorder({id:d.getID()})):re._reqCommandProxy.reorder({appId:widget.getValue("appId"),id:n.getID(),old_position:{id:n.getParent().getID(),relid:n.getRelationID(),path:h},new_position:{id:c["from.physicalid[connection]"],relid:c["physicalid[connection]"],path:p,treeOrder:c["attribute[TreeOrder]"]},status:c.status}),n.getParent().getID()===d.getID())n.setRelationOrder(parseFloat(c["attribute[TreeOrder]"])),n.setRelationID(c["physicalid[connection]"]),re.options.model.sortInTreeOrder([d]);else{let e=n.getRelationID();re.options.model.reparentNode(n,n.getParent(),d,parseFloat(c["attribute[TreeOrder]"]),c["physicalid[connection]"],c["type[connection]"]),re.authoring._handleDuplicateOnReparent(e)}n.getRichViewElement().update({connectionId:n.getRelationID(),connection:n.getRelationType(),parentId:n.getParentID(),level:n.getLevel()});for(var m=0;m<o.length;m++){o[m].getRichViewElement().update({level:o[m].getLevel()})}for(var f=0;f<r.length;f++){var v=r[f];v.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-creation",1e3,"swing",function(){a(this).removeClass("highlight-creation",1e3,"swing")}),_.unmask(UWA.Element.getElement.call(v.parent()[0],"#"+v.attr("id")))}if("keep"==c.status){var b=UWA.clone(r);i.after(b)}re.mediator.publish("onRefresh"),re.utilities.loading(!0),I.sucessAlert(Q.RichView_Notif_OperationSucceeded)}"error"==t.status&&(I.warningAlert(t.message),i.after(r))},onFailure:function(e){re.scroller.scrollToElement("#"+i.attr("id"),"center");for(var t=0;t<r.length;t++)r[t].detach();i.after(r);for(t=0;t<r.length;t++){var n=r[t];n.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-fail",1e3,"swing",function(){a(this).removeClass("highlight-fail",1e3,"swing")}),_.unmask(UWA.Element.getElement.call(n.parent()[0],"#"+n.attr("id")))}re.mediator.publish("onRefresh"),re.utilities.loading(!0);var o=S.getParseErrorMessage(e,null,Q.RichView_Notif_FailureAndRollback);I.errorAlert(o)},onTimeout:function(e){re.scroller.scrollToElement("#"+i.attr("id"),"center");for(var t=0;t<r.length;t++)r[t].detach();i.after(r);for(t=0;t<r.length;t++){var n=r[t];n.find(".rich-object-info").removeClass("highlight-operation").addClass("highlight-fail",1e3,"swing",function(){a(this).removeClass("highlight-fail",1e3,"swing")}),_.unmask(UWA.Element.getElement.call(n.parent()[0],"#"+n.attr("id")))}re.mediator.publish("onRefresh"),re.utilities.loading(!0);var o=S.getParseErrorMessage(e,null,Q.RichView_Notif_FailureAndRollback);I.errorAlert(o)}})}else I.warningAlert(Q.RichView_INSERT_FAILED)},_handleDuplicateOnReparent:function(e){re.options.model.getNodesByRelId(e).forEach(e=>{e.options.elementRV.container.remove()})},_createReorderInput:function(e,t,i,n){var o=null,r=null;t&&(o=t.prevRelID,r=t.nextRelID);var s="",a={version:2,target:{kind:s=null!=o&&null!=r?"afterChild":null!=r?"firstChild":"lastChild",parent:e.getID()},rels:i,mode:n||"move"};return"afterChild"==s&&(a.target.rel=o),a},_createReorderResponce:function(e,t,i,n){var o={};return o["physicalid[connection]"]=n[e].result,o["attribute[TreeOrder]"]=n[e].order,o.status=n[e].status,o["from.physicalid[connection]"]=i.target.parent,o.physicalid=t.getID(),o.name=t.options.name,o.type=t.getType(),o.revision=t.options.revision,o["attribute[Title]"]=t.options.req_label,o["type.kindof"]=t.options.kindof,o["old_physicalid[connection]"]=t.getRelationID(),o}},shortcuts:null,utilities:{getRequestPayload:function(e){var t=Re.expand.cv_expand_data.no_folder_expand,i=w.determineAuthoredFlag(),n=UWA.extend({type_filter:t.type_filter_bo,rel_filter:t.type_filter_rel});n.rootID=e;var o=[e];return!1===i?(n.expand_iter="-1",n.paths=o,n.BIProxy=re._biFilter,n.object_selects=Re.expand.cv_expand_data.no_folder_expand.select_bo,n.select_relation=["physicalid","ds6w:type","spec.TreeOrder","ds6w:businessType"]):(n.root_physical_id=e,n.relationship_selects=["physicalid[connection]","attribute[TreeOrder]","from.physicalid"],n.object_selects=Re.expand.mql_expand_data.object_selects),n},getSelectable:function(){var e=w.determineAuthoredFlag(),t=Re.selectable;return!0===e?t.db_select:t.cv_select},useCompassContent:function(){var e=void 0!==widget.getValue("X3DContentId")?JSON.parse(widget.getValue("X3DContentId")):null;if(null!==e){var t=e.data;if(null!==t){if(t.items.length>0){var i=t.items[0].objectId;if(UWA.is(i))return re._logger.log("3DCompass content has been detected: ",i),i}}}},reloadSaveObject:function(){if(widget.getValue("custo_root_pid")){var e=widget.getValue("custo_root_pid");if(UWA.is(e))return re._logger.log("Saved Object has been detected: ",e),e}else widget.addPreference({name:"custo_root_pid",type:"hidden",defaultValue:""})},saveObject:function(e){re._logger.log("Save Object to widget preferences: ",e),widget.getValue("custo_root_pid")||widget.addPreference({name:"custo_root_pid",type:"hidden",defaultValue:""}),widget.setValue("custo_root_pid",e)},cleanObject:function(){widget.setValue("custo_root_pid",""),re.options.data=null},updateIdCard:function(e){var t=M.process.createNode({treedocument:re.options.model,data:e,tenant:w.getTenant()},w.getAuthorizedTypesWithParent());re.idCard.idcard.modelEvents.publish({event:"refresh-idcard-attributes",data:t})},cleanWidgetTitle:function(){widget.setTitle("")},jsonEscape:function(e){return e.replace(/\n/g,"")},encodeHtml:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(e).replace(/[&<>"'\/]/g,function(e){return t[e]})},decodeHtml:function(e){if(!UWA.is(e)||""==e)return"";try{return ye.innerHTML=e,ye.value}catch(e){return""}},disableAutoNumbering:function(e){var t=a(".rich-container-hidden-numbering",re.richView);if(!1===e.value&&t.length>0){var i=a(".rich-object-container-index",re.richView),n=a(".rich-object-index",re.richView),o=a(".rich-container-title-index",re.richView);i.removeClass("rich-container-hidden-numbering"),n.removeClass("rich-container-hidden-numbering"),o.removeClass("rich-container-hidden-numbering")}if(!0===e.value&&0==t.length){i=a(".rich-object-container-index",re.richView),n=a(".rich-object-index",re.richView),o=a(".rich-container-title-index",re.richView);i.addClass("rich-container-hidden-numbering"),n.addClass("rich-container-hidden-numbering"),o.addClass("rich-container-hidden-numbering")}},loading:function(e){for(var t=oe.getMessages(),i=null,n=0;n<t.length;n++){if(t[n].getElement(".wux-controls-progressbar-linear-lite")){i=t[n];break}}if(e&&i)return oe.options.autoHide=!0,void oe.remove(i);e?oe.options.autoHide=!0:i?oe.remove(i):(oe.options.autoHide=!1,re.mediator.publish("onNotification",{className:"primary",message:""}),new R({shape:"linear",displayStyle:"lite",infiniteFlag:!0,statusFlag:!1,emphasize:"info"}).inject(oe.elements.container.getElement(".alert-message.alert-primary")))},onEndEdit:function(){var e=self.widget.getPreferences();e.forEach(function(e){switch(e.name){case"trm_security_ctx":w.setXPrefCredentials(widget,e.value);case"trm_richview_DisableAutoNumbering":re.utilities.disableAutoNumbering(e)}}),re._reqCommandProxy.preferenceModification({preferences:e,appId:widget.getValue("appId"),widgetId:widget.id}),re._objectRichEditor.updateCKEditorSpellCheckSetting()},updatePreferences:function(e){if(UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var t=e.preferences;UWA.is(t)&&t.length>0&&t.forEach(function(e){widget.hasPreference(e.name)?(widget.setValue(e.name,e.value),re._logger.log("update "+e.name+" preference")):"pad_security_ctx"===e.name&&(widget.setValue("trm_security_ctx",e.value),re._logger.log("update trm_security_ctx preference")),"trm_security_ctx"===e.name&&w.setXPrefCredentials(widget,e.value)})}},setWidgetTitle:function(){let e=re.utilities.getSelectable();new o(function(t,i){E.getInfo({securityContext:w.getSecurityContext(),pid:re.options.data,selectables:e,onComplete:function(e){e=w.parseResponse(e);var i=(e=UWA.is(e,"string")?JSON.parse(e):e).results[0],n="";UWA.is(i["ds6w:label"])&&""!==i["ds6w:label"]?n+=" "+i["ds6w:label"]:n+=" "+i.name,self.widget.setTitle(n);var o=i["ds6w:type"],r=w.getKindOf(o);re.options.parentType=i["ds6w:type"],re.options.parentName=i.name,re.options.parentTitle=i["ds6w:label"],re.options.parentKindof=r;var s=["ds6w:status","ds6w:type"];let a={};s.forEach(e=>{a[e]=[i[e]]});s.map(e=>i[e]);B.retrieveNLS({nlsData:a}).then(function(e){s.forEach(t=>{i[t]=e[t][a[t][0]]}),re.utilities.updateIdCard(i)}).catch(function(){re.utilities.updateIdCard(i)}),re.options.model.getRoots()[0].options.title=i["ds6w:label"];for(var l=re.options.model.getNodesById(i.resourceid),c=0;c<l.length;c++){var d=l[c];d.options.title=""!==i["ds6w:label"]?i["ds6w:label"]:i.name,d.setCEStamp(i.cestamp);var u=d.getRichViewElement();UWA.is(u)&&u.update({title:""!==i["ds6w:label"]?i["ds6w:label"]:i.name})}t()},onFailure:function(e,i){var n=S.getParseErrorMessage(i);I.errorAlert(n),t()},onTimeout:function(e,i){var n=S.getParseErrorMessage(i);I.errorAlert(n),t()}})})},refreshAuthoredObject:function(e){if(UWA.is(e.authored)&&UWA.is(e.authored.modified)&&0!==e.authored.modified.length){var t=e.authored.modified;"object"==typeof t&&UWA.is(t.physicalid)&&(t=t.physicalid);var i=re.options.model.getRoots();if(0===i.length)return;t[0]===i[0].getID()?re.utilities.setWidgetTitle():E.getInfo({securityContext:w.getSecurityContext(),pid:t,selectables:re.utilities.getSelectable(),onComplete:function(e){e=w.parseResponse(e),(e=UWA.is(e,"string")?JSON.parse(e):e).results.forEach(function(e){for(var t=re.options.model.getNodesById(e.resourceid),i=0;i<t.length;i++){var n=t[i];n.options.title=""!==e["ds6w:label"]?e["ds6w:label"]:e.name,null!=n.options.elementRV&&n.setCEStamp(e.cestamp);var o=n.getRichViewElement();UWA.is(o)&&o.update({title:""!==e["ds6w:label"]?e["ds6w:label"]:e.name,cestamp:e.cestamp}),n.isSelected()&&re.idCard.updateSelection(n)}})},onFailure:function(e,t){var i=S.getParseErrorMessage(e,t);I.errorAlert(i)},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)}})}else if(UWA.is(e.authored)&&UWA.is(e.authored.deleted))for(var n=e.authored.deleted[0],o=re.options.model.getNodesById(n),r=0;r<o.length;r++){var s=o[0];if("Requirement Specification"===s.options.kindof)re.cleanAll();else{e={path:s.getOccurencePath(),appId:"notRichview",PhysicalDelete:!0};re.utilities.detachObject(e)}}},findAndScrollToObject:function(e){var t=re.utilities.findObjectElement(e);UWA.is(t)&&UWA.is(t.id)&&UWA.is(t.element)&&(re.scroller.scrollToElement("#"+t.id,"top"),!0!==a(t.element).hasClass("active")&&a(t.element).find(".rich-container-title-index,.rich-object-info").click())},isSamePath:function(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},findObjectElement:function(e){var t=e.id,i=e.relid,n=e.path,o=null,r=null,s=re.options.model.getNodesById(t);if(s.length>0){o=s[0].getRichViewElementID(),r=s[0].getRichViewElement()?s[0].getRichViewElement().container:null;for(var a=0;a<s.length;a++){var l=s[a];if(UWA.is(n)){var c=l.getOccurencePath(),d=n;if(d.length>c.length){var u=d.length-c.length;d=d.slice(u,d.length-1)}re.utilities.isSamePath(d,c)&&(o=l.getRichViewElementID(),r=l.getRichViewElement()?l.getRichViewElement().container:null)}else{i===l.getRelationID()&&(o=l.getRichViewElementID(),r=l.getRichViewElement()?l.getRichViewElement().container:null)}}}return{id:o,element:r}},syncViewOnExternalSelection:function(e){if(UWA.is(e.protocol)&&"3DXContent"===e.protocol){var t=JSON.parse(widget.getValue("subscribeToTRASelect")),i=Re.authorised_apps;if(JSON.stringify(i).includes(e.source)&&t){var n=e.data.items;if(UWA.is(n)&&n.length>0){var o=n[0].objectId;re.utilities.findAndScrollToObject({id:o})}}}else if(UWA.is(e.paths)&&e.paths.length>0){var r=e.paths[0],s=(o=r[r.length-1],r[r.length-2]);re.utilities.findAndScrollToObject({id:o,relid:s})}},syncViewOnInternalSelection:function(e){if(UWA.is(e.appId)&&e.appId!==widget.getValue("appId")&&UWA.is(e.paths)){var t=e.paths[0],i=t[t.length-1],n=re.options.model.getRoots().length>0?re.options.model.getRoots()[0].getID():"";if(i!==n){var o=t[t.length-2];E.getKindOf({securityContext:w.getSecurityContext(),pid:i,onComplete:function(e){var n=(UWA.is(e,"string")?JSON.parse(e):e).results;n===re.options.root||"DOCUMENTS"===n?(UWA.is(re.dropinvit)&&a(".welcome_panel_container").size()>0&&re.dropinvit.remove(),re.utilities.saveObject(i),re._onWidgetRefresh()):null==o&&re.options.root.indexOf(n)>-1&&re.getRootId()!=i?(re.utilities.saveObject(i),re._onWidgetRefresh()):"Requirement"==re.options.parentKindof&&re.utilities.findAndScrollToObject({id:i,relid:o,path:t})},onFailure:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t)}})}else{if(re.getSelectedNode().getID()!==i)a(".content-panel").find(".rich-object.active,.rich-container.active").toggleClass("active",!1),re.options.model.unselectAll(),re.onCleanSelection(!1);else if("Requirement"==re.options.parentKindof){o=t[t.length-2];re.utilities.findAndScrollToObject({id:i,relid:o,path:t})}}}},loadSpec:function(e){if(UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){if(UWA.is(e.paths))var t=e.paths[0];else t=e.data.object.physicalid;t!==re.rootId?E.getInfo({securityContext:w.getSecurityContext(),pid:t,selectables:re.utilities.getSelectable(),onComplete:function(e){e=w.parseResponse(e);var t=UWA.is(e,"string")?JSON.parse(e):e,i=t.results[0]["ds6w:type"],n=w.getKindOf(i);re._curentlyLoadingReqSpec=!1,-1!=re.options.root.indexOf(i)||-1!=re.options.root.indexOf(n)?re.refreshOnCreate(t.results,!1):re._logger.log("The dropped object is not a "+re.options.root)},onFailure:function(e){re._logger.log(e);var t=S.getParseErrorMessage(e);I.errorAlert(t)},onTimeout:function(e){var t=S.getParseErrorMessage(e);I.errorAlert(t),re._logger.log("RequirementWebServices.getInfo timed out")}}):re._curentlyLoadingReqSpec=!1}},attachObject:function(e){re._logger.log("attachObject");var t=function(e,t,i,n){if(re.options.model.getRoots().length>0)if(e===re.options.model.getRoots()[0].getID()){var o=re.authoring.placeholder({physicalid:a,type:re.options.model.getRoots()[0].options.type,kindof:re.options.model.getRoots()[0].options.kindof,target:{element:null,id:""},position:t,content:""});re.authoring._refreshOnInsert(r,o,null,!1,n)}else{var s=re.options.model.getNodesById(e);if(s.length>0){var l;i.slice(0,i.length-3);l="over"===t?i[i.length-4]:i[i.length-2];for(var c=null,d=null,u=null,h=0;h<s.length;h++){s[h].getOccurencePath();if(s[h].getRelationID()===l){c=s[h].getRichViewElement(),d=s[h].getRichViewElementID(),u=c.container;break}}if(UWA.is(d)){o=re.authoring.placeholder({physicalid:a,target:{element:u,id:d},position:t,content:"",type:c.type,objectId:c.physicalId,kindof:c.kindof});re.authoring._refreshOnInsert(r,o,null,!1,n)}}}};if(UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var i=e.eventData;Array.isArray(e.eventData)||(i=[e]);var n,o="",r=void 0,s=void 0,a="";i.forEach(function(e){switch(o=e.mode,r=e.object,s=e.path,a=s[s.length-1],o){case"insert":n=s[s.length-3],t(n,"over",s);break;case"insertExisting":n=s[s.length-3],t(n,"over",s,o);break;case"append":n=e.selection[e.selection.length-1],t(n,"after",e.selection);break;case"prepend":n=e.selection[e.selection.length-1],t(n,"before",e.selection);break;case"appendExisting":n=e.selection[e.selection.length-1],t(n,"after",e.selection,"insertExisting");break;case"prependExisting":n=e.selection[e.selection.length-1],t(n,"before",e.selection,"insertExisting")}})}},detachObject:function(e){if(re._logger.log("detachObject"),UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var t=e.path,i=t[t.length-1],n=t[t.length-2],o=re.utilities.findObjectElement({id:i,relid:n,path:t});if(UWA.is(o.element)){var r={element:o.element,path:t,physicalid:e.physicalid,PhysicalDelete:e.PhysicalDelete};re.refreshOnRemove(r,!1)}}},resetObjectTreeorder:function(e){re.author(!0);var t=re.options.model.getNodesById(e.id)[0],i={appId:e.appId,path:t.getOccurencePath(),object:{"attribute[Title]":t.options.title,"attribute[TreeOrder]":t.options.relationOrder,"from.physicalid[connection]":t.options.parentID,physicalid:e.id,"physicalid[connection]":t.options.relationid,"type.kindof":t.options.kindof,"type[connection]":t.options.relationtype,type:{displayName:t.options.grid["ds6w:type"],value:t.options.type},revision:t.options.grid["ds6wg:revision"]},selection:t._parentNode.getOccurencePath(),mode:"insertExisting"};re.utilities.detachObject({appId:e.appId,path:t.getOccurencePath(),PhysicalDelete:!0}),re.utilities.attachObject(i)},reorderObject:function(e){if(re._logger.log("reorderObject"),UWA.is(e)&&UWA.is(e.appId)&&e.appId!==widget.getValue("appId")){var t=e.old_position,i=e.new_position,n=(e.id,t.id,t.relid,t.path),o=(i.id,i.relid),r=i.relType,s=i.path,l=i.treeOrder,c=re.options.model.getNodesByRelId(o);if(0===c.length)return;c=c[0];var d,u=re.options.model.getNodeByOccurencePath(n),h=re.options.model.getNodeByOccurencePath(s);if(!UWA.is(u))if(-1!=(d=n.indexOf(re.rootId))){var p=n.slice(d);u=re.options.model.getNodeByOccurencePath(p)}if(!UWA.is(h))if(-1!=(d=s.indexOf(re.rootId))){p=s.slice(d);h=re.options.model.getNodeByOccurencePath(p)}if(!UWA.is(u)||!UWA.is(h))return;var g=c.getRichViewElement(),m=c.getAllDescendants();u.getID()===h.getID()?(c.setRelationOrder(parseFloat(l)),re.options.model.sortInTreeOrder([h])):re.options.model.reparentNode(c,u,h,parseFloat(l),o,r);var f=new Array;if(f.push(c.getRichViewElement().container),UWA.is(m)&&m.length>0)for(var v=0;v<m.length;v++){var b=m[v];f.push(b.getRichViewElement().container)}var _=c.getNextBrother(),y=c.getPreviousBrother();if(UWA.is(_))_.getRichViewElement().container.before(f);else if(UWA.is(y)){var R=y.getAllDescendants(),C=y.getRichViewElement().container;if(UWA.is(R)&&R.length>0)C=R[R.length-1].getRichViewElement().container;C.after(f)}else{if(!0===c.getParent().isRoot())(a(".scroller-content",re.contentPanel).length>0?a(".scroller-content",re.contentPanel):re.contentPanel).find(".rich-object, .rich-container").last().after(f);else c.getParent().getRichViewElement().container.after(f)}g.update({connectionId:c.getRelationID(),connection:c.getRelationType(),parentId:c.getParentID(),level:c.getLevel()});for(var E=0;E<m.length;E++){m[E].getRichViewElement().update({level:m[E].getLevel()})}re.mediator.publish("onRefresh"),re.scroller.scrollToElement("#"+c.getRichViewElementID(),"center")}},reviseObject:function(e){if("DOCUMENTS"===e.data.object["type.kindof"])re.utilities.loadSpec(e),console.log("Reqspec has been selected");else{var t=re.options.model.getNodesByRelId(e.data.old_rel_id)[0],i=function(e,i,o,s){var l;if(l=re.GetNextBrotherRichViewElem(n,t),re.options.model.getRoots().length>0)if(e===re.options.model.getRoots()[0].getID()){var c=re.authoring.placeholder({physicalid:a,type:re.options.model.getRoots()[0].options.type,kindof:re.options.model.getRoots()[0].options.kindof,target:{element:null,id:""},position:i,content:""});re.authoring._refreshOnRevise(r,c,null,!1,s,l,t)}else{var d=re.options.model.getNodesById(e);if(d.length>0){var u;o.slice(0,o.length-3);u="over"===i?o[o.length-4]:o[o.length-2];for(var h=null,p=null,g=null,m=0;m<d.length;m++){d[m].getOccurencePath();if(d[m].getRelationID()===u){h=d[m].getRichViewElement(),p=d[m].getRichViewElementID(),g=h.container;break}}if(UWA.is(p)){c=re.authoring.placeholder({physicalid:a,target:{element:g,id:p},position:i,content:"",type:h.type,objectId:h.physicalId,kindof:h.kindof});re.authoring._refreshOnRevise(r,c,null,!1,s,l,t)}}}},n=t.getNextBrother(),o=t.getPreviousBrother(),r=e.data.object,s=e.newPath,a=e.newPath[e.newPath.length-1];UWA.is(n)?("before",i(n.getOccurencePath()[n.getOccurencePath().length-1],"before",n.getOccurencePath(),"insertExisting")):UWA.is(o)?("after",i(o.getOccurencePath()[o.getOccurencePath().length-1],"after",o.getOccurencePath(),"insertExisting")):i(s[s.length-3],"over",s,"insertExisting");var l=t.getAllDescendants();if(UWA.is(l)&&l.length>0)for(var c=0;c<l.length;c++){var d=l[c];d.getRichViewElement().container.remove(),d.remove()}t.getRichViewElement().container.remove(),t.remove(),re.utilities.detachObject(e),re.mediator.publish("onRefresh")}},closeTRMSearchNav:function(){this._selectedIdx=0,this._matchedNodes=[],this._pagerview&&this._pagerview.hide()}},getRichObject:function(e){var t=re.options.model.getNodesByElementID(e);return t.length>0&&UWA.is(t[0].getRichViewElement)?t[0].getRichViewElement():void 0},GetContainerLevel:function(e){for(var t=1,i=e;UWA.is(i)&&(i=i.getPreviousBrother(),UWA.is(i));)(re._isContainer(i.options.type)||re._isContainer(i.options.kindof))&&(t+=1);return t},GetRichObjectLevel:function(e){for(var t=1,i=e;UWA.is(i)&&(i=i.getPreviousBrother(),UWA.is(i));)(re._isRich(e._options.kindof)||re._isRich(e._options.type))&&(t+=1);return t},GetNextBrotherRichViewElem:function(e,t){for(var i=null,n=e,o=t;null==i||null==i;){if(UWA.is(n))i=n.getRichViewElement();else{if(o=o.getParent(),!UWA.is(o))break;n=o.getNextBrother()}if(!UWA.is(o))break}return i},getEditMode:function(){return!0}});return Ce});