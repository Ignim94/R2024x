define("DS/CreateSpecification/control/CreateEng",["UWA/Core","UWA/Controls/Abstract","DS/Controls/TooltipModel","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/createform/view/NewForm","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/DocumentServiceProvider","DS/XSRCommonComponents/utils/Constants","DS/WebappsUtils/WebappsUtils","DS/XSRCommonComponents/createform/util/FormJson","i18n!DS/CreateSpecification/assets/nls/CreateSpecification"],function(e,t,i,s,n,a,r,o,l,p,c,d,u,h,m,f){"use strict";return t.extend({newForm:null,templateList:null,formFields:null,target:null,options:null,dialog:null,CADInsertables:null,CAD_ORIGIN_TYPE_V6:"V6",CAD_ORIGIN_TYPE_V5:"V5",prodAttributePromRes:null,init:function(e){this._parent(e),this.basicModelEvents=e.appCore.basicModelEvents,this.target=e.appCore.specMainContainer,this.onCreateSuccess=e.onCreateSuccess,this.parentId=e.parentId},execute:function(){this.container=widget.body,c.maskLoader(this.container);var e=(new m).getPhyProdFieldJson();this.initDetailedView(e)},initDetailedView:function(e){var t=e,i=n.workUnderContext?n.workUnderContext.getChange():void 0;i&&i.change&&i.change.id&&(t.showWorkUnderIndicator=!0,t.workUnderTitle=i.change.title),this.newForm=new r(t).render(),this.formFields=this.newForm.formfieldControls;var s=this,l=this.options;l.Title=f.NewEngineeringItem,l.Content=this.newForm.container,l.width=500,l.renderTo=this.target,c.unmaskLoader(this.container),this.dialog=new a(l),this.dialog.destroyPrevDialog(),this.dialog.render(),this.newForm.listenTo(this.newForm,"SELECT_CHANGE_EVENT",function(e){if("type"===e.toLowerCase()){let e=s.getInput("Type");s.getProductAttributes(e),s.formFields.Template&&(s.formFields.Template.inputfield.value="",s.loadTemplate(e))}else"template"===e.toLowerCase()&&s.templateChangeEvent()}),this.newForm.listenTo(this.newForm,"CONTAINS_DIRTY_FIELD",function(e){s.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",e)}),this.injectPhysicalPrdTypes(),this.formFields.CADAuthoring&&!0===widget.getValue("CADAuthoring")&&this.fetchCADInsertables();var p=function(){var e={};e.title=e.filename=s.getInput("Title");let t=s.getInput("Description");var i=s.getInput("Type");return e.type=i,s.parentId&&(e.parentId=s.parentId),!0===widget.getValue("CADAuthoring")&&(e.CheckfilenameDisplay=s.cadTemplates.CheckfilenameDisplay,e.filenameStatus=s.cadTemplates.filenameStatus,e.Templates=s.cadTemplates.results,e.Specializedtypes=s.cadTemplates.types,e.cadOriginType=s.getInput("CADAuthoring")?s.getInput("CADAuthoring"):"V6"),s.prodAttributePromRes.then(function(i){if(i.Attributes&&(s.prdAttributes=i.Attributes),s.prdAttributes&&s.prdAttributes.length>0){let i=JSON.parse(s.prdAttributes);i[0].attributes&&i[0].attributes.length>0&&i[0].attributes.forEach(function(i){"V_Name"==i.name?i.value=e.title:"V_description"==i.name&&(i.value=t)}),e.attributes=JSON.stringify(i)}return new o({isChangeControlled:!0}).createPhysicalPrd({data:e})}).catch(s.onError.bind(s))};this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_OK",function(){s.validateFields()&&(s.enableOrDisableDialogButtons(!1),s.dialog.closeDialog(),s.showCreateLoader(),p().then(s.createSpecCallBack.bind(s),s.onError.bind(s)))}),this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_APPLY",function(){var e=s.validateFields();if(e){s.enableOrDisableDialogButtons(e);var t=f.replace(f.get("CreatingTechSpecLoader"),{title:s.getInput("Title")});s.dialog.maskOrUnMaskDialog(t),p().then(s.createSpecApplyCallBack.bind(s)).catch(s.onError.bind(s)),s.getProductAttributes(s.getInput("Type"))}})},createSpecApplyCallBack:function(e){if(void 0!==e&&e.result&&"success"===e.result.toLowerCase()){p.displayNotification({eventID:"success",msg:f.PhysicalPrdCreateSuccess});var t=this.getInput("Template"),i=this.getInput("Type");this.createSpecReport(e.physicalid,t),this.onCreateSuccess&&this.onCreateSuccess(e.physicalid,i);var s=this.getInput("RevisionComment"),n=this.getInput("Description"),a=[];if(s||n){s&&a.push({attribute:u.ITEM_REVISIONCOMMENT,value:s,isBasicAttribute:!1}),n&&a.push({attribute:u.ITEM_DESCRIPTION,value:n,isBasicAttribute:!1});var r={itemid:e.physicalid,request:a};(new o).updateAttributes(r)}this.resetFields(),this.dialog.maskOrUnMaskDialog(),this.enableOrDisableDialogButtons(!1)}else this.onError()},parseResponse:function(e){var t=JSON.parse(e.rawAttr)[0].attributes,i=e.instances;if(i&&i[0]){var s=i[0];for(var n in s)if(s.hasOwnProperty(n)){var a=s[n];"to[VPMInstance].physicalid"===n&&(n="instanceId");var r={};r.name=n,r.value=a,t.push(r)}}return t},showCreateLoader:function(){var e=this.getInput("Title"),t=f.replace(f.get("CreatingTechSpecLoader"),{title:e});c.maskLoader(this.container,t)},stopLoader:function(){c.unmaskLoader(this.container)},createSpecCallBack:function(e){var t=this;if(e&&"failure"===e.result.toLowerCase()){c.unmaskLoader(t.container);var i=e.message?e.message:f.PhysicalPrdCreateFailure;p.displayNotification({eventID:"error",msg:i})}else if(null!=e){t.onCreateSuccess&&t.onCreateSuccess(e.id,t.getInput("Type"));var s=t.getInput("RevisionComment"),n=t.getInput("Description"),a=[];if(s||n){s&&a.push({attribute:u.ITEM_REVISIONCOMMENT,value:s,isBasicAttribute:!1}),n&&a.push({attribute:u.ITEM_DESCRIPTION,value:n,isBasicAttribute:!1});var r={itemid:e.physicalid,request:a};(new o).updateAttributes(r)}var l=t.getInput("Template");t.createSpecReport(e.physicalid,l,function(){t.stopLoader(),p.displayNotification({eventID:"success",msg:f.PhysicalPrdCreateSuccess});var i={};if(i.itemPid=e.physicalid,e.rawAttr&&"string"==typeof e.rawAttr){var s=JSON.parse(e.rawAttr)[0].attributes;t.basicModelEvents&&!t.parentId&&s.forEach(function(e){var t=e.name,s=e.value;"ds6w:type"===t&&(i.typeActual=s)})}})}},enableOrDisableDialogButtons:function(e){e?this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!1}):this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!0})},onError:function(e){this.enableOrDisableDialogButtons(this.validateFields()),this.stopLoader(),this.dialog.maskOrUnMaskDialog(),c.unmaskLoader(this.container),p.displayNotification({eventID:"error",msg:e&&e.message||f.PhysicalPrdCreateFailure})},injectPhysicalPrdTypes:function(){var e=s.getNewProductIncludedtypes();let t=[],i=e=>{let i=0,s=[...e];s.forEach((e,t)=>{"VPMReference"==e.valueItem?i=t:e.labelItem=e.labelItem}),t.push(s[i]),s.splice(i,1),t=t.concat(s)};e?(Object.keys(e).forEach(t=>{"Raw Material"===e[t].labelItem&&e.splice(t,1)}),i(e)):new l({id:"getPhysicalPrdTypes"}).invoke().then(e=>{var t=e.response;i(t)}).catch(this.onError.bind(this));this.newForm.updateField(t,"Type",!1)},fetchCADInsertables:function(){var e=new o;this.templateList=e.getCADData({calledFrom:"fetchCADInsertables"}).then(this.fetchCADTemplates.bind(this)).catch(this.onError.bind(this))},fetchCADTemplates:function(e){this.CADInsertables=e,(new o).getCADData({data:"templateType=assembly&tenant="+widget.getValue("x3dPlatformId"),calledFrom:"fetchCADTemplates"}).then(this.filterAndInjectCADInsertables.bind(this)).catch(this.onError.bind(this))},filterAndInjectCADInsertables:function(t){this.cadTemplates=t,this.cadList=this.CADInsertables;for(var i=[],s=this.cadList.results,n={type:"assembly"},a="3DExperience",r=0;r<s.length;r++){if(s[r].CAD==a){var o=h.getWebappsAssetUrl("ENOCollabSharingCmds","icons/3DEXPERIENCE.png");if("assembly"==n.type||"component"==n.type){a=e.i18n("3DExperience");var l="ProductTemplate";"component"==n.type&&(l="PartTemplate");var p={Connector:a,icon:o,labelItem:("        "+a+" - "+e.i18n(l)).trim(),valueItem:this.CAD_ORIGIN_TYPE_V6};this.getpreferredCAD();i.push(p)}}}for(r=0;r<s.length;r++)for(var c=s[r],d=this.getavailableUPSChoice(c,this.cadTemplates.results),u=0;u<d.length;u++)i.push(d[u]);e.is(i)&&i.length>0&&(this.formFields.CADAuthoring.inputfield.elementsList=i,1===i.length&&(this.formFields.CADAuthoring.inputfield.value=i[0].valueItem,this.setToolTip(i[0])))},getavailableUPSChoice:function(t,i){var s=[],n=t.CAD,a=t.prefix,r="icons/"+t.icon+".png",o=e.i18n(a),l=h.getWebappsAssetUrl("ENOCollabSharingCmds",r),p=this.getpreferredCAD();return i.forEach(function(t){var i=t.fileName,r=i;if(1==i.startsWith(a)){i=i.substring(a.length,i.length);var c="        "+o+" - "+e.i18n(i),d={Connector:o,icon:l,labelItem:c.trim(),valueItem:r};null!==p?p==n&&s.push(d):s.push(d)}}),s},getpreferredCAD:function(){return"false"===widget.getValue("CADAuthoring")?"3DExperience":null},loadTemplate:function(e){if(this.formFields.Template){var t=new l({id:"getSpecTemplates"});this.templateList=t.invoke({data:{specType:e}}).then(e=>{this.templateList=e,this.templateList&&this.templateList.response.length>0?(this.newForm.updateField(this.templateList.response,"Template",!1),this.formFields.Template.inputfield.placeholder=f.SelectTemplate):(this.newForm.updateField(null,"Template",!1),this.formFields.Template.inputfield.placeholder=f.NoResults)}).catch(e=>{console.log(e),this.newForm.updateField(null,"Template",!1),this.formFields.Template.inputfield.placeholder=f.NoResults})}},typeChangeEvent:function(){var e=this.formFields.Type.inputfield;if(this.formFields.Template&&void 0!==e){var t=e.selectedIndex;e.elementsList[t];this.loadTemplate()}},templateChangeEvent:function(){var e=this.formFields.Template.inputfield.value;for(var t in void 0===e&&this.resetToolTip(),this.templateList.response)this.templateList.response.hasOwnProperty(t)&&e==this.templateList.response[t].valueItem&&this.setToolTip(this.templateList.response[t])},resetToolTip:function(){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:""})},setToolTip:function(e){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:e.description})},validateFields:function(){var t,i,s=!0,n=!1;for(t in this.formFields)if(this.formFields.hasOwnProperty(t)){var a=this.formFields[t],r=!!e.is(a.parentfield)&&a.parentfield.isHidden(),o=!!e.is(a.inputfield.fieldoptions)&&a.inputfield.fieldoptions.mandatory,l=e.is(a.inputfield.fieldoptions)?a.inputfield.fieldoptions.label:"";if(!r&&o)if(!this.hasValue(a.inputfield.value))a.inputfield._giveFocus(),n=!0,i=void 0!==i?i+","+l:l,s=!1}return n&&p.displayNotification({eventID:"error",msg:f.RequiredFields+i}),s},resetFields:function(){this.newForm.resetFields()},createSpecReport:function(e,t,i){if(this.hasValue(t)){var s={data:{itemPid:e,template:t}};new l({id:"SpecificationReport"}).create(s).then(function(e){var t=e.specPid;i&&i(t)}.bind(this)).catch(this.onError.bind(this))}else i&&"function"==typeof i&&i()},hasValue:function(e){return null!=e&&""!==e},getProductAttributes:function(e){this.prodAttributePromRes=(new o).fetchPhysicalPrdAttributes(e)},getInput:function(e){if(this.formFields[e])return this.formFields[e].inputfield.value}})});