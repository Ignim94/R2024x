define("DS/CreateSpecification/control/CreateSpec",["UWA/Core","UWA/Controls/Abstract","DS/Controls/TooltipModel","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/createform/view/NewForm","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/DocumentServiceProvider","DS/XSRCommonComponents/utils/Constants","i18n!DS/CreateSpecification/assets/nls/CreateSpecification"],function(e,t,i,s,n,o,l,a,r,p,d,c){"use strict";return t.extend({newForm:null,templateList:null,formFields:null,target:null,options:null,dialog:null,init:function(e){this._parent(e),this.options=e,this.basicModelEvents=e.appCore.basicModelEvents,this.target=e.appCore.specMainContainer,this.createCloseAction=e.createCloseAction,this.createAction=e.createAction},loadFields:function(){var e=this;this.container=widget.body,r.maskLoader(this.container),new l({id:"getCreateSpecUIFormSettings"}).invoke().then(e.initDetailedView.bind(this)).catch(function(t){var i=t&&t.message||c.LoadingError;a.displayNotification({eventID:"error",msg:i}),r.unmaskLoader(e.container)})},initDetailedView:function(e){var t=e;this.newForm=new o(t).render(),this.formFields=this.newForm.formfieldControls;var i=this,s=this.options;s.Title=c.NewSpecification,s.Content=this.newForm.container,s.width=500,s.renderTo=this.target,r.unmaskLoader(this.container),this.dialog=new n(s),this.dialog.destroyPrevDialog(),this.dialog.render(),this.file=this.formFields.File.inputfield,this.newForm.listenTo(this.newForm,"EVENT_TYPE_CHANGE",function(e){var t=e.field;"Type"===t?i.typeChangeEvent():"Template"===t&&i.templateChangeEvent()}),this.newForm.listenTo(this.newForm,"CONTAINS_DIRTY_FIELD",function(e){i.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",e)}),this.injectTechSpecTypes(),this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_OK",function(){if(i.validateFields()){i.enableOrDisableDialogButtons(!1),i.dialog.closeDialog(),i.showCreateLoader();var e=i.getCreateSpecRequestInput();(new p).createDocument(null,null,e).then(i.createSpecCallBack.bind(i),i.onError.bind(i))}}),this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_APPLY",function(){i.getInput("Template"),i.getInput("Type");var e=i.validateFields();if(e){i.enableOrDisableDialogButtons(e);var t=i.getCreateSpecRequestInput();i.dialog.maskOrUnMaskDialog(t.title),(new p).createDocument(null,null,t).then(i.createSpecApplyCallBack.bind(i)).catch(i.onError.bind(i))}})},createSpecApplyCallBack:function(e){this.dialog.maskOrUnMaskDialog();var t=this.getInput("Template");void 0!==e&&(this.fileActions(e[0].id,t),console.log("spec PhysicalId"+e[0].id),this.createAction&&this.createAction(e[0].id),a.displayNotification({eventID:"success",msg:c.SpecificationCreateSuccess}),this.enableOrDisableDialogButtons(!1),this.resetFields())},showCreateLoader:function(){var e=this.getInput("Title"),t=c.replace(c.get("CreatingTechSpecLoader"),{title:e});r.maskLoader(this.container,t)},stopLoader:function(){r.unmaskLoader(this.container)},createSpecCallBack:function(e){var t=this,i=this.getInput("Template");if(void 0!==e){console.log("spec PhysicalId"+e[0].id),t.fileActions(e[0].id,i,function(i){t.stopLoader(),t.createCloseAction(e[0].id,e[0].type);var s={};s.itemPid=e[0].id,s.typeActual=e[0].type,a.displayNotification({eventID:"success",msg:c.SpecificationCreateSuccess})})}},enableOrDisableDialogButtons:function(e){this.dialog&&(e?this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!1}):this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!0}))},onError:function(e){console.log(e),a.displayNotification({eventID:"error",msg:e.error||c.SpecificationCreateFailure}),this.enableOrDisableDialogButtons(this.validateFields()),this.stopLoader(),r.unmaskLoader(this.container),this.dialog&&this.dialog.maskOrUnMaskDialog()},injectTechSpecTypes:function(){var e=s.getTechSpecSubtypes();e?this.initTypeList({response:e}):new l({id:"getTechSpecTypes"}).invoke().then(this.initTypeList.bind(this)).catch(this.onError.bind(this))},initTypeList:function(t){this.typeList=t,e.is(this.typeList)&&this.typeList.response.length>0&&(this.formFields.Type.inputfield.elementsList=this.typeList.response,1===this.typeList.response.length&&(this.formFields.Type.inputfield.value=this.typeList.response[0].valueItem),this.loadTemplate())},loadTemplate:function(){var e=this.formFields.Type.inputfield;if(this.formFields.Template&&this.hasValue(e.value)){var t=new l({id:"getSpecTemplates"});this.templateList=t.invoke({data:{specType:e.value}}).then(this.initTemplateList.bind(this)).catch(this.initTemplateList.bind(this))}},initTemplateList:function(t){this.templateList=t,e.is(this.templateList)&&this.templateList.response.length>0?(this.formFields.Template.inputfield.placeholder=this.formFields.Template.inputfield.fieldoptions.placeholder,this.formFields.Template.inputfield.elementsList=this.templateList.response,this.formFields.Template.inputfield.value=void 0,1===this.templateList.response.length&&(this.formFields.Template.inputfield.value=this.templateList.response[0].valueItem,this.setToolTip(this.templateList.response[0]))):(this.formFields.Template.inputfield.elementsList="",this.formFields.Template.inputfield.elementsList="",this.formFields.Template.inputfield.placeholder=c.NoResults)},typeChangeEvent:function(){var e=this.formFields.Type.inputfield;if(void 0!==e){var t=e.selectedIndex;e.elementsList[t];this.loadTemplate()}},templateChangeEvent:function(){var e=this.formFields.Template.inputfield.value;for(var t in void 0===e&&this.resetToolTip(),this.templateList.response)this.templateList.response.hasOwnProperty(t)&&e==this.templateList.response[t].valueItem&&this.setToolTip(this.templateList.response[t])},resetToolTip:function(){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:"",allowUnsafeHTMLShortHelp:!1})},setToolTip:function(e){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:e.description,allowUnsafeHTMLShortHelp:!1})},resetFields:function(){this.newForm.resetFields()},getCreateSpecRequestInput:function(){var e={};for(var t in this.formFields){var i=this.formFields[t],s=t.toLowerCase();"title"===s?e.title=i.inputfield.value.trim():"type"===s?e[s]=i.inputfield.value.trim():"description"===s&&(e[s]=this.hasValue(i.inputfield.value)?i.inputfield.value.trim():"")}return e.policy="Technical Specification",this.createSpecInput=e,e},validateFields:function(){var t,i,s=!0,n=!1;for(t in this.formFields){var o=this.formFields[t],l=!!e.is(o.parentfield)&&o.parentfield.isHidden(),r=!!e.is(o.inputfield.fieldoptions)&&o.inputfield.fieldoptions.mandatory,p=e.is(o.inputfield.fieldoptions)?o.inputfield.fieldoptions.label:"";if(!l&&r)if(!this.hasValue(o.inputfield.value))o.inputfield._giveFocus(),n=!0,i=void 0!==i?i+","+p:p,s=!1}return n&&a.displayNotification({eventID:"error",msg:c.RequiredFields+i}),s},fileActions:function(e,t,i){var s=[],n=this.file.blob,o=this.file._blobName;if(this.hasValue(n)){n.lastModifiedDate=new Date,n.name=o;var a=(new p).uploadFile({data:{itemPid:e,files:n}});s.push(a)}var r=function(){i&&i()};if(this.hasValue(t)){r=function(e){var t=e[0].specPid||e[1].specPid;i&&i(t)};var d={data:{itemPid:e,template:t}},c=new l({id:"SpecificationReport"}).create(d);s.push(c)}Promise.all(s).then(r).catch(this.onError.bind(this))},hasValue:function(e){return null!=e&&""!==e},getInput:function(e){if(this.formFields[e])return this.formFields[e].inputfield.value}})});