define("DS/DMUPlaySection/DMUClippingRobot",["UWA/Class","DS/DMUMeasurable/DMUManipulableClippingPlane","DS/DMUMeasurable/DMUToolsMaths","DS/Visualization/ThreeJS_DS","DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUMeasurable/DMUMeasurable","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUSwitchRepService","DS/DMUMeasurable/DMUSectionPosService","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/Ruler/Ruler","DS/Ruler/AngularRuler","DS/Robot/LineTranslationNode","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/DMUMeasurable/DMUPreVisuNode3D","DS/DMUMeasurable/DMUMeasureEnums"],function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,v,f,m,S,h,C,y,b,M,P,w,D,x,V,A){"use strict";return e.extend({init:function(e,N){this._parent();var R,_,T,O,E=e,I=E.getFrameWindow(),U=I.getViewer(),B=m,L=S,k=h,F=E.getAppType(),z=new d({viewer:U}),G=!1,W=!1,j=!1,H=!1,X=!1;this.isManipulationOnGo=function(){return j||X||H};var Y=E.manipulationInformationCB,J={clearTimeout:void 0,lockedNodeIds:[]};function Z(){J&&J.clearTimeout&&(J.clearTimeout(),J.clearTimeout=void 0)}function q(){z&&J&&(z.unlockNodes({nodeIDsToUnlock:J.lockedNodeIds,nodeIDsToUnlockMeshInRAM:J.lockedNodeIds}),J.lockedNodeIds=[])}var Q,K,$,ee,te,ie,ne,oe,re,ae=this,le=[],se=[],ce={origin:new n.Vector3,initOrigin:new n.Vector3,direction:null,initValue:null,value:null,origin3D:null},ue={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},pe=function(){var e=(new n.Vector3).copy(E.getUDirection()),t=(new n.Vector3).copy(E.getVDirection()),i=(new n.Vector3).copy(E.getNormal()),o=(new n.Matrix4).makeBasis(e,t,i.negate()),r=(new n.Vector3).copy(E.getCenter());return o.setPosition(r),o},ge=!1,de=function(e){var t=e;if(t){var i=t.clone().normalize();i.x>.9995||i.y>.9995||i.z>.9995?t=i:(-i.x>.9995||-i.y>.9995||-i.z>.9995)&&(ge=!0,t=i.negate())}return t},ve=function(){return c.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value},fe=function(){return c.readPreferences({name:"cke",PreferenceNames:["Angle"]}).preferences[0].value},me=function(e){re=null;var t=new n.Vector3,i=new n.Vector3,o=new n.Vector3;return e.extractBasis(t,i,o),o.x>.9995||-o.x>.9995||o.y>.9995||-o.y>.9995||o.z>.9995||-o.z>.9995?(re=new n.Vector3(0,0,0),oe=re.clone()):(re=(new n.Vector3).getPositionFromMatrix(e),oe=re.clone()),re};N?(oe=N,re=N):me(pe()),this._getRulerOriginPos=function(){return oe?oe.clone():oe};var Se=function(e){var t=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"mesh",!1);if(0!==t.path.length&&t.path[0]){var i,o=t.path[0];return(i=o&&o.getWorldMatrix?(new n.Vector3).getPositionFromMatrix(o.getWorldMatrix()):new n.Vector3(0,0,0))&&(ce.origin3D=i.clone(),oe=i.clone(),re=i.clone()),o?{origin3D:i}:void 0}},he=function(e,t){if(K&&e&&(e.axis||e.manipulator.axis)){var i=(new n.Vector3).copy(e.axis?e.axis:e.manipulator.axis);ue.direction=i;var o=t?E.getVDirection():E.getUDirection();!function(e,t){if(K){var i=(new n.Vector3).copy(e);K.direction=i.negate(),K.setValue(0),K.initValue=K.value,K.origin=(new n.Vector3).copy(E.getCenter()),K.originVector=(new n.Vector3).copy(t),K.display()}}(e.axis?e.axis:e.manipulator.axis,o)}};this.buildRobot=function(){if(!R){j=!1,H=!1,X=!1;var e=U.picking.primitive,c=U.pPicking.primitive,d={},m={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},S=function(e){var t,i,o,r,a,l,s=e.clone();return t=(s=s.negate()).x,i=s.y,o=s.z,r=Math.abs(t),a=Math.abs(i),l=Math.abs(o),r>=a&&r>=l?t>0?new n.Vector3(1,0,0):new n.Vector3(-1,0,0):a>r&&a>=l?i>0?new n.Vector3(0,1,0):new n.Vector3(0,-1,0):l>r&&l>a?o>0?new n.Vector3(0,0,1):new n.Vector3(0,0,-1):s},h=function(e){e&&(e.drawMode="Section",ae._preVisuNode?ae._preVisuNode.buildPreVisuNode({data:e}):(ae._preVisuNode=new V(U),ae._preVisuNode.buildPreVisuNode({data:e}),ae._preVisuNode.setNoZ(!0),ae._preVisuNode.setPickable(D.PICKTHROUGH),U&&(M.getSceneRoot(U).add(ae._preVisuNode),U.render())),ae._preVisuNode.setVisibility(U.getVisibleSpace()))},C=function(){ae._preVisuNode&&(M.getSceneRoot(U).remove(ae._preVisuNode),U.render(),ae._preVisuNode.removeChildren(),ae._preVisuNode.remove(),ae._preVisuNode=void 0)},y=function(e){var t=(new n.Matrix4).copy(ee),i=(new n.Matrix4).setPosition((new n.Vector3).getPositionFromMatrix(te)),o=(new n.Matrix4).getInverse(i).multiply(t),r=(new n.Matrix4).copy(e).multiply(o),a=(new n.Matrix4).copy(i).multiply(r);E.setPlaneGeometryCB({referential:a})};R=new o({frameWindow:I,lightDisplay:"3dPlay"===F,getRulerUnitCB:ve,getAngularRulerUnitCB:fe,checkDirforRuler:de});var b=pe();R.setPosition({robotMatrix:b,translationRulerOrigin:me(b)}),ce.origin3D=re;var w=E.getCenter();ce.origin=w.clone(),ce.initOrigin=w.clone(),ce.baseOrigin=w.clone(),R.setVisibility(!0),R.robotOrigin3DCompute=Se,R.moveRulerOrigin=function(){E.setClippingRepVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})},R.moveRulerOriginEnd=function(){E.setClippingRepVisibility(!0)},R.robotMatrixCompute||(R.robotMatrixCompute=function(e){Z(),W=!0,T&&B.remove({pathElement:T});var t=l.getViewpointInfo(U.currentViewpoint),i=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"primHybrid",!0);if(i.path.length>0&&i.path[0]&&z&&(m.none||!(x(!0)||0===m.point&&0===m.center&&0===m.axisSystem&&0===m.line&&0===m.plane&&0===m.cylinder&&1===m.surface))){var o=z.switchToAV1({path:i.path[0],lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){J.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(J.lockedNodeIds||(J.lockedNodeIds=[]),t.forEach(function(e){-1===J.lockedNodeIds.indexOf(e)&&J.lockedNodeIds.push(e)}))},onFailureCB:function(){J.clearTimeout=void 0}});if(o&&o.clearTimeout&&(J.clearTimeout=o.clearTimeout),o&&o.nodeIDsOfAlreadyLoadedNode&&o.nodeIDsOfAlreadyLoadedNode.length){var r=[];o.nodeIDsOfAlreadyLoadedNode.forEach(function(e){-1===J.lockedNodeIds.indexOf(e)&&(r.push(e),J.lockedNodeIds.push(e)),r&&r.length&&(z.lockNodes({nodeIDsTolock:r,nodeIDsTolockMeshInRAM:r}),r=[])})}}if(0!==i.path.length&&i.path[0]&&i.position){d.axisX=void 0,d.axisY=void 0,d.axisZ=void 0,d.position=void 0;var a,s,c=i.path[0];i.normal&&(a=i.normal),i.position&&(s=i.position);var v=!1,f={};if(m.none||m.axisSystem||x()){var y=c,b=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var i=e.externalPath[t];if(M.isPLMNode(i))break;if("AxisSystems"===i.name)return t}return 0}(y);if(b||x()){if(t&&t.sight){var P;if(m.none||m.axisSystem){y&&y.getWorldMatrix?P=y.getWorldMatrix():(P=(new n.Matrix4).makeBasis(new n.Vector3(1,0,0),new n.Vector3(0,1,0),new n.Vector3(0,0,1))).setPosition(new n.Vector3(0,0,0));var w=y.externalPath[b+1];if(Boolean(w)&&Boolean(w.getMatrixWorld())){for(var D=new k,V=0;V<=b+1;V++)D.addElement(y.externalPath[V]);var N=D.getWorldMatrix();N&&(P=N)}for(var R=[],_=0;_<b+2;_++){var E=y.externalPath[_];R.push(E)}R.length&&(T=new k(R),B.add({pathElement:T}))}else{var I=c;P=I.getWorldMatrix(),x()&&(P=(I=function(e){var t=e;return e.pathElement=new k,t.externalPath.some(function(t){return e.pathElement.addElement(t),t&&M.is3DLeaf(t)}),t.internalPath.length>0&&(e.originalPathElement=t),e}(c)).getWorldMatrix())}var F=P.clone(),j=new n.Vector3,H=new n.Vector3,X=new n.Vector3;if(F.extractBasis(j,H,X),s=(new n.Vector3).getPositionFromMatrix(F),(a=function(e,t,i,n){if(e||t&&i&&n){var o,r=t,a=void 0,l=e.clone();return l=l.negate(),t&&(a=o=l.angleTo(t),r=t),i&&(o=l.angleTo(i))<a&&(a=o,r=i),n&&(o=l.angleTo(n))<a&&(a=o,r=n),r}}(t.sight,j,H,X))&&(a.equals(j.clone())||a.equals(j.clone().negate())?(f.axis1=H,f.axis2=X):a.equals(H.clone())||a.equals(H.clone().negate())?(f.axis1=j,f.axis2=X):(a.equals(X.clone())||a.equals(X.clone().negate()))&&(f.axis1=H,f.axis2=j)),x()){var Y=[],q=(new n.Matrix4).makeBasis(f.axis1,f.axis2,a);q.setPosition(s),Y.worldMatrix=q,Y.resultType=A.ResultType.PRODUCT,h(Y)}v=!0}v||(a=void 0,s=void 0,v=!0)}}var Q,K,$=M.isOOCTileSetNodeInPath(c);if(c&&!v&&(c.getLastElement().sgNode||$)){var ee;if($){var te=(new n.Matrix4).getInverse(c.getWorldMatrix()),ie=i.position,ne=ie.clone().applyMatrix4(te);ee=new u({canonic:{type:g.GeometryType.POINT,position:ne},pathElement:c,selpoint:ie})}else ee=new u({primitive:c.getLastElement().sgNode,pathElement:c,selpoint:i.position});var oe=ee.getType();switch(ae._preVisuNode&&O!==oe&&C(),oe){case g.GeometryType.POINT:W=!1,m.none||m.point?(h(ee),t&&t.sight&&(a=S(t.sight))):(a=void 0,s=void 0);break;case g.GeometryType.LINE:if(W=!1,m.none||m.line){if(h(ee),t&&t.sight){var re=ee.getPoints(),le=new n.Vector3;le.subVectors(re.beginPoint,re.endPoint).normalize();var se=le.dot(t.sight);a=le.multiplyScalar(se>0?1:-1).negate(),s=i.position}}else a=void 0,s=void 0;break;case g.GeometryType.CIRCLE:W=!1,m.none||m.center?(h(ee),t&&t.sight&&(a=S(t.sight)),s=ee.getCenter()):(a=void 0,s=void 0);break;case g.GeometryType.SPHERE:case g.GeometryType.SURFACE:case g.GeometryType.PLANE:if(oe===g.GeometryType.SPHERE&&!m.surface)break;var ce=i.normal;if(!ce.length()&&oe===g.GeometryType.PLANE){let e=ee.getPlane();e&&e.normal&&(ce=ee.getPlane().normal)}if(m.none||m.plane||m.surface){if(m.none&&oe===g.GeometryType.SURFACE||m.surface&&(!m.plane||oe===g.GeometryType.SURFACE))ee.normal=ce,ee.resultType=A.ResultType.SURFACE,G=!1,O===oe&&(G=!0),O=oe,ee.onlyUpdatePos=G;else if(m.plane&&!m.surface&&oe!==g.GeometryType.PLANE){a=void 0,s=void 0;break}h(ee),a=ce}else a=void 0,s=void 0;break;case g.GeometryType.CYLINDER:case g.GeometryType.CONE:if(m.none||m.cylinder){h(ee),a=i.normal;var ue=ee.getPoints(),pe=i.position.toArray(),ge=ue.beginPoint.toArray(),de=ee.getAxis().toArray(),ve=a.toArray(),fe=p.computeTwoLinesDistance(pe,ve,ge,de).aPosition2;s=new n.Vector3(fe[0],fe[1],fe[2])}else m.surface?(G=!1,O===oe&&(G=!0),O=oe,ee.onlyUpdatePos=G,ee.resultType=A.ResultType.SURFACE,ee.normal=i.normal,h(ee),s=i.position,a=i.normal):(a=void 0,s=void 0);break;default:a=void 0,s=void 0}}else if(!v&&(m.surface||m.none)){var me=[];me.normal=i.normal;var Se=i.position;me.getSelPoint=function(){return Se},me.resultType=A.ResultType.SURFACE,G=!1,O===A.ResultType.SURFACE&&(G=!0),O=A.ResultType.SURFACE,me.onlyUpdatePos=G,h(me)}if(!a||!s)return U.setPicking({displayHL:!1}),U.setPrePicking({displayHL:!1}),void(c&&(B.empty(),L.empty()));if(U.setPicking({displayHL:!0}),U.setPrePicking({displayHL:!0}),a.negate(),a.normalize(),v&&f&&f.axis1&&f.axis2)Q=f.axis1,K=f.axis2;else{var he=M.getXYAxisDirFromZ(a.clone());he.xDir&&he.yDir&&(Q=he.xDir,K=he.yDir)}d.axisX=Q.clone(),d.axisY=K.clone(),d.axisZ=a.clone(),d.position=s.clone();var Ce=(new n.Matrix4).makeBasis(Q,K,a.negate()),ye=(new n.Vector3).copy(s);return Ce.setPosition(ye),{robotMatrix:Ce}}ae._preVisuNode&&C()}),function(){R.moveBegin=function(e){ae.clearRulers(),X=!0,"translation"===e.kind?function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){_&&_.setVisibleFlag(!0);var i=E.getPlaneGeometryCB();ee=(new n.Matrix4).copy(i.referential),te=e.robotMatrix,Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):function(e){if(j=!0,_&&_.setVisibleFlag(!0),Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=E.getPlaneGeometryCB();ee=(new n.Matrix4).copy(i.referential),"ruler"===e.from&&"rotation"===e.kind&&ee.setPosition(E.getCenter()),te=e.robotMatrix,Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)},R.move=function(e){X=!0,e&&("ruler"===e.from?"translation"===e.kind?function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=E.getCenter(!0),n=E.getPlaneGeometryCB().referential;n.setPosition(i.clone().add(e.translationVector)),E.setPlaneGeometryCB({referential:n}),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):(function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var n,o=e.axis.clone().dot(E.getUDirection()),r=e.axis.clone().dot(E.getVDirection());i.areEqual(Math.abs(r),1,"float")?(n=i.isLessOrEqual(r,0)?-e.rotationAngle:e.rotationAngle,ee=ee.rotateY(n),E.setPlaneGeometryCB({referential:ee,toRelocate:!0})):(n=i.isLessOrEqual(o,0)?-e.rotationAngle:e.rotationAngle,ee=ee.rotateX(n),E.setPlaneGeometryCB({referential:ee,toRelocate:!0})),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.ROTATION,evt:e.event})}}(e),me(e.robotMatrix)):"robot"===e.from&&("translation"===e.kind?function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=(new n.Matrix4).makeTranslation(e.translationVector.x,e.translationVector.y,e.translationVector.z);y(i),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):(function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=e.axis,o=e.rotationAngle,r=(new n.Matrix4).makeRotationAxis(i,o);y(r),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.ROTATION,evt:e.event})}}(e),me(e.robotMatrix))))},R.moveEnd=function(e){"translation"===e.kind?function(e){Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})&&(ee=void 0,te=void 0),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:e.event}),j=!1}(e):function(e){j=!1,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})&&(ee=void 0,te=void 0);var i=pe();R.setPosition({robotMatrix:i,translationRulerOrigin:me(i),doNotResetRuler:1}),ce.origin3D=re,Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.ROTATION,evt:e.event})}(e),X=!1};R.moveRobotBegin=function(i){Z(),ae.clearRulers(),j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:i.event})&&(x()||(e=U.picking.primitive,c=U.pPicking.primitive,1!==e&&U.setPicking({primitive:1}),1!==c&&U.setPrePicking({primitive:1})),E.setClippingRepVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:i.event}))},R.moveRobot=function(e){j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:e.event})&&(E.setClippingRepVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:e.event}))},R.moveRobotEnd=function(i){if(j=!1,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER})){ae._preVisuNode&&C(),E.setClippingRepVisibility(!0);var o,r,a=E.getPlaneGeometryCB().referential;if(d.axisX&&d.axisY&&d.axisZ&&d.position){if(a.makeBasis(d.axisX,d.axisY,d.axisZ),a.setPosition(d.position),!E.isBoxMode||!E.isBoxMode()){var l=P.computeBoundingBox(U,void 0,E.isPersistentClippingCB,function(){return s.getContextViewer({viewer:U})}),u=v.computePlaneDim(l,a,W);u&&(u.fPlaneSizeV&&u.fPlaneSizeU&&(o=u.fPlaneSizeU,r=u.fPlaneSizeV),u.plane&&((a=u.plane).extractBasis(d.axisX,d.axisY,d.axisZ),d.position=(new n.Vector3).getPositionFromMatrix(a)))}var p=E.computePlaneCenter(a);p&&a.setPosition(p),E.setPlaneGeometryCB({referential:a,uSize:o,vSize:r,uStep:o?o/20:void 0,vStep:r?r/20:void 0});var g=(new n.Matrix4).makeBasis(d.axisX,d.axisY,d.axisZ.clone().negate()),f=(new n.Vector3).copy(d.position);g.setPosition(f),R.setPosition({robotMatrix:g,translationRulerOrigin:me(g)});var m=(new n.Vector3).getPositionFromMatrix(g);ce.origin=m.clone(),ce.initOrigin=m.clone(),ce.baseOrigin=m.clone(),ce.origin3D=re}}x()||(U.setPicking({primitive:e}),U.setPrePicking({primitive:c})),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.CENTER,evt:i.event}),Z(),q(),O=void 0,G=!1}}(),function(){var e=localStorage.getItem("SectionSelectionFilter");e&&12===e.length&&e.startsWith("0-")&&(m.point="1"===e.charAt(2)?1:0,m.center="1"===e.charAt(3)?1:0,m.axisSystem="1"===e.charAt(4)?1:0,m.line="1"===e.charAt(5)?1:0,m.plane="1"===e.charAt(6)?1:0,m.cylinder="1"===e.charAt(7)?1:0,m.surface="1"===e.charAt(8)?1:0,m.product="1"===e.charAt(9)?1:0,0===m.point&&0===m.center&&0===m.axisSystem&&0===m.line&&0===m.plane&&0===m.cylinder&&0===m.surface&0===m.product?m.none=1:m.none=0);var t=function(){if(_){m={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},_.getActiveState("point")&&(m.none=0,m.point=1),_.getActiveState("center")&&(m.none=0,m.center=1),_.getActiveState("axisSystem")&&(m.none=0,m.axisSystem=1),_.getActiveState("line")&&(m.none=0,m.line=1),_.getActiveState("plane")&&(m.none=0,m.plane=1),_.getActiveState("cylinder")&&(m.none=0,m.cylinder=1),_.getActiveState("surface")&&(m.none=0,m.surface=1),_.getActiveState("product")&&(m.none=0,m.product=1);var e="0-"+m.point+m.center+m.axisSystem+m.line+m.plane+m.cylinder+m.surface+m.product+"-1";localStorage.setItem("SectionSelectionFilter",e)}};if(!_){var i={};i.point=f.point,i.center=f.center,i.axisSystem=f.axisSystem,i.line=f.line,i.plane=f.plane,i.cylinder=f.cylinder,i.surface=f.surface,i.product=f.product;var n=a.getWebappsAssetUrl("DMUMeasure","icons/32/");(_=new r({body:I.getUIFrame(),frmWindow:I,Idpanel:"SectionSelectionFilter",classpanel:"SectionSelectionFilter",typeSeparator:"bubble",lJsonElement:[{type:"element",id:"point",nls:i.point,url:n+"I_Meas_Point.png",callback:t,bexclude:!1,bstateActif:m.point},{type:"element",id:"center",nls:i.center,url:n+"I_Meas_PointCircle.png",callback:t,bexclude:!1,bstateActif:m.center},{type:"element",id:"axisSystem",nls:i.axisSystem,url:n+"I_Meas_Axis.png",callback:t,bexclude:!1,bstateActif:m.axisSystem},{type:"element",id:"line",nls:i.line,url:n+"I_Meas_Line.png",callback:t,bexclude:!1,bstateActif:m.line},{type:"element",id:"plane",nls:i.plane,url:n+"I_Meas_Plane.png",callback:t,bexclude:!1,bstateActif:m.plane},{type:"element",id:"cylinder",nls:i.cylinder,url:n+"I_Meas_Cylinder.png",callback:t,bexclude:!1,bstateActif:m.cylinder},{type:"element",id:"surface",nls:i.surface,url:n+"I_Meas_Surface.png",callback:t,bexclude:!1,bstateActif:m.surface},{type:"element",id:"product",nls:i.product,url:n+"I_Meas_Product.png",callback:t,bexclude:!1,bstateActif:m.product}]}))&&(_.build(),_.setVisibleFlag(!0))}}()}function x(e){return!(1!==m.product||0!==m.point||0!==m.center||0!==m.axisSystem||0!==m.line||0!==m.plane||0!==m.cylinder||!e&&0!==m.surface)}};var Ce=function(){(Q=new C(I,{displayOrigin:!1,offset:20,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:"3dPlay"===F})).setVisibilityFree(!0);var e,i,o;(se=[]).push(Q.subscribe("OriginManipulateBegin",function(){e=Q.displayOrigin,i=(Q.origin3DPos||Q.origin).clone()})),Q.onOriginManipulator=function(n){if(o=null,Se){var r=Se({event:n.event,viewer:U});(o=r&&r.origin3D)&&Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})}return Q.displayOrigin=e,o?(Q.displayOrigin=!0,E&&E.setClippingRepVisibility(!1),o.clone()):i},se.push(Q.subscribe("OriginManipulateEnd",function(){R&&R.setPosition({translationRulerOrigin:o?o.clone():o}),ce.origin3D=o?o.clone():o,E&&E.setClippingRepVisibility(!0)})),se.push(Q.subscribe("RulerManipulateBegin",function(e){var i;i=e,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&(R&&R.setVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:i.event}))})),se.push(Q.subscribe("RulerManipulate",function(e){!function(e){if(Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=E.getPlaneGeometryCB().referential,o=(new n.Vector3).getPositionFromMatrix(i);i.setPosition(o.clone().add(e.translationVector)),E.setPlaneGeometryCB({referential:i}),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}ae.updateRobotPos()}(e)})),se.push(Q.subscribe("RulerManipulateEnd",function(e){var i;i=e,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&R&&R.setVisibility(!0),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:i.event}),ae.updateRobotPos()}))},ye=function(){(K=new y(I,{radius:150,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0,lightDisplay:"3dPlay"===F})).setVisibilityFree(!0);(le=[]).push(K.subscribe("AngularRulerManipulateBegin",function(e){!function(e){if(Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=E.getPlaneGeometryCB();ee=(new n.Matrix4).copy(i.referential),R&&(te=(new n.Matrix4).copy(R.getMatrix()),R.setVisibility(!1)),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)})),le.push(K.subscribe("AngularRulerManipulate",function(e){!function(e){if(Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var n,o=e.direction.clone().dot(E.getUDirection()),r=e.direction.clone().dot(E.getVDirection());i.areEqual(Math.abs(r),1,"float")?(n=i.isLessOrEqual(r,0)?-e.diffAngle:e.diffAngle,E.setPlaneGeometryCB({referential:ee.rotateY(n*Math.PI/180)})):(n=i.isLessOrEqual(o,0)?-e.diffAngle:e.diffAngle,E.setPlaneGeometryCB({referential:ee.rotateX(n*Math.PI/180)})),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}ae.updateRobotPos(!1,!0)}(e)})),le.push(K.subscribe("AngularRulerManipulateEnd",function(e){var i;i=e,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:i.event})&&(ee=void 0,R&&R.setVisibility(!1)),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.ROTATION,evt:i.event}),ae.updateRobotPos(!1,!0)}))};return this.clean=function(){this.isManipulationOnGo()||(ge=!1,R&&(R.destroy(),R=null),_&&(_.clear(),_=null),ie&&(U.removeNode(ie),ie.removeChildren(),ie.remove(),ie=void 0),Q&&se&&se.length>0&&(se.forEach(function(e){Q.unsubscribe(e)}),se=[]),K&&le&&le.length>0&&(le.forEach(function(e){K.unsubscribe(e)}),le=[]),Z(),q(),this.clearRulers())},this.update=function(e){void 0!==e&&"boolean"==typeof e&&(void 0===e||X||R.setVisibility(!e),_&&_.setVisibleFlag(!e))},this.updateRobotPos=function(e,t){if(R){var i=!1;U.getVisibleSpace()||(i=!0),ae.update(i);var n=pe();if(t?R.setPosition({robotMatrix:n,translationRulerOrigin:me(n),doNotResetRuler:j}):R.setPosition({robotMatrix:n,doNotResetRuler:j}),t){var o=E.getCenter();ce.origin=o.clone(),ce.initOrigin=o.clone(),ce.baseOrigin=o.clone(),ce.origin3D=re}}e&&ae.clearRulers()},this.updateOnTranslationBegin=function(e){if(H=!0,ge=!1,$=e.intersection.position,this.clearAngularRuler(),Q||Ce(),!ie){ie=new x;var t={position:new n.Vector3(0,0,0),touchMode:!1},i=new w({name:"fixedSizeNode3D",ratio:7}),o=new b(t);o.name="arrowTranslationNode",o.mat.color=new n.Color("#1B6E9C"),o.mat.opacity=1,o.setNoZ(!0),i.addChild(o),U&&ie&&(ie.addChild(i),U.addNode(ie),U.render({forceDynamicMode:!0}))}ie&&(ie.setMatrix(pe().setPosition($.clone())),ie.setVisibilityInTree(!1),ie.setVisibility(U.getVisibleSpace()),ie.setPickable(D.PICKTHROUGH));var r=(new n.Vector3).copy(e.manipulator.axis).negate();r=de(r);var a=E.getCenter().clone(),l=(new n.Vector3).copy(r).multiplyScalar((new n.Vector3).copy(ce.baseOrigin).sub(a).dot(r));ce.initOrigin=(new n.Vector3).copy(a).add(l);var s=(new n.Vector3).copy(ce.initOrigin);ce.origin3D&&(s=new n.Line3(ce.initOrigin,(new n.Vector3).copy(ce.initOrigin).add(r)).closestPointToPoint(ce.origin3D,!1));ce.origin=s;var c=(new n.Vector3).copy(ce.origin).sub(a).dot(r);if(ce.direction=r,ce.value=s.distanceTo(a)*(c>0?-1:1),ce.initValue=ce.value,Q){var u=r.clone().negate().normalize().multiplyScalar(ce.value);Q.origin=$.clone().add(u),Q.origin3DPos=ce.origin3D,ne=ce.value,Q.initOrigin=ce.initOrigin,Q.setValue(ce.value),Q.direction=ce.direction,Q.initValue=ce.initValue,Q.displayOrigin=Boolean(ce.origin3D),Q.unit=ve(),Q.display(),Q.beginManipulation()}this.updateRobotPos(),R&&!X&&R.setVisibility(!0)},this.snapTranslationCallback=function(e){var t=e.translationVector;if(Q){var i=Q.getSnappedTranslationVector(e);0===i.returnCode&&(t=i.snappedTranslationVector)}return t},this.snapRotationCallback=function(e){var t={value:180*e.angle/Math.PI,axis:e.axis};if(ue&&ue.direction&&ue.direction.dot(e.axis)<0&&(t.value=360-t.value),K){var i=K.getSnappedRotationValue(e);0===i.returnCode&&(t={value:i.snappedRotationAngle,axis:i.axis})}return t},this.updateOnTranslation=function(e){if(H=!0,Q){var t=ce.value;ce.value=ce.initValue+e.translationVector.length()*(ce.direction.dot(e.translationVector)>0?1:-1),Q.setValue(ce.value);var i=pe(),o=new n.Vector3,r=new n.Vector3,a=new n.Vector3;t&&t>ce.value&&(i.extractBasis(o,r,a),a.negate(),i.makeBasis(o,r,a));var l=(new n.Vector3).copy(e.manipulator.axis).normalize(),s=ne-ce.value;ge&&(i.extractBasis(o,r,a),a.negate(),i.makeBasis(o,r,a),s=ce.value-ne);var c=l.multiplyScalar(s),u=$.clone().add(c);ie.setMatrix(i.setPosition(u.clone()))}else!Q&&e.intersection&&e.manipulator&&this.updateOnTranslationBegin({intersection:e.intersection,manipulator:e.manipulator});this.updateRobotPos()},this.updateOnTranslationEnd=function(){ge=!1,H=!1,R&&!X&&R.setVisibility(!0),ie&&ie.setVisibility(!U.getVisibleSpace()),Q&&(Q.endManipulation(),Q.display()),ie&&(U.removeNode(ie),ie.removeChildren(),ie.remove(),ie=void 0),$=void 0},this.updateOnRotationBegin=function(e,t){this.clearLinearRuler(),K||ye(),he(e,t),this.updateRobotPos(),R&&!X&&R.setVisibility(!0),K&&(K.display(),K.beginManipulation())},this.updateOnRotation=function(e,t){K||this.updateOnRotationBegin({axis:e.axis},t),function(e){if(K&&e){var t=(new n.Vector3).copy(e.axis),o=K.direction.dot(t),r=i.isLessThan(o,0)?2*Math.PI-e.angle:e.angle;K.setValue(K.initValue+180*r/Math.PI),K.refresh()}}(e),this.updateRobotPos(!1,!0)},this.updateOnRotationEnd=function(){R&&!X&&R.setVisibility(!0),K&&(K.display(),K.endManipulation())},this.clearRulers=function(){this.clearLinearRuler(),this.clearAngularRuler()},this.clearLinearRuler=function(){Q&&Q.clear()},this.clearAngularRuler=function(){K&&K.clear()},this}})}),define("DS/DMUPlaySection/DMUSectionImport",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.importData=function(t,i,n){t&&i&&e&&("Clipping"===t.type&&t.PropertiesSection&&!t.PropertiesSection.Hatching&&(t.PropertiesSection.Hatching={},t.PropertiesSection.Hatching.Display=!1),i.fillObjectAttributes(e,t,n),i.registerForPostImport(e))},this.afterImport=function(){e&&e.fireEvent("onDMUObjectInitialized",{dmuObject:e})}}})}),define("DS/DMUPlaySection/DMUStoreyNavigratorController",["UWA/Class","DS/PADUtils/PADSettingsMgt","DS/CAT3DWebStoreyComponents/CAT3DWebStoreyNavigatorControler"],function(e,t,i){"use strict";var n,o=[],r=[];function a(e,t,i){e&&t&&r.push({buildingRootID:t,storeyInfo:"NoData",context:e}),i&&i()}function l(e,t){if(!t||!e||!e.context)var i;e&&e.getBuidlingRootID&&(i=e.getBuidlingRootID(),t.SetRootForStoreys([i]));var n=e.context,o=e.storyeRetrivalFailCB;t.GetStoreys().then(function(l){if(l&&l.length){let o,a;i&&function(e){let t=!1;if(e.context&&e.buildingRootID){for(var i=0;i<r.length;i++)r[i].context===e.context&&(r[i].buildingRootID===e.buildingRootID?(t=!0,r[i].storeyInfo=e.storeyInfo,r[i].isActive=e.isActive):r[i].isActive=!1);t||r.push(e)}}({buildingRootID:i,storeyInfo:l,context:e.context,isActive:!0}),n&&(o=n.getFrameWindow(),n.getViewer&&(a=n.getViewer())),t.CreateStoreyNavigator({frameWindow:o,viewer:a}),e.storyeRetrivalSuccessCB&&e.storyeRetrivalSuccessCB(t)}else a(n,i,o)},function(){a(n,i,o)})}return e.singleton({init:function(){i||window.require(["DS/CAT3DWebStoreyComponents/CAT3DWebStoreyNavigatorControler"],function(e){i=e})},getDMUStoreyNavigratorController:function(e){var n=this.giveDMUStoreyNavigratorController(e);if(!n&&e&&e.context&&i){let r,a,s=e.context;s&&(r=s.getFrameWindow(),s.getViewer&&(a=s.getViewer())),n=new i({securityContext:t.getSetting("pad_security_ctx"),frameWindow:r,viewer:a}),o.push({context:e.context,storeyNavigratorController:n}),l(e,n)}return n?Object.freeze(n):n},initNavigatoreUI:function(e){if(e&&e.context){var t=e.storeyNavigatorControler?e.storeyNavigatorControle:this.giveDMUStoreyNavigratorController(e);t?l(e,t):t=this.getDMUStoreyNavigratorController(e)}},giveDMUStoreyNavigratorController:function(e){var t;if(e&&e.context)for(var i=0;i<o.length;i++)if(o[i].context===e.context){t=o[i].storeyNavigratorController;break}return t?Object.freeze(t):t},getStoreyInfo:function(e,t){if(e&&t){for(var i,n=0;n<r.length;n++)r[n].context===t&&r[n].buildingRootID===e&&r[n].isActive&&(i=r[n].storeyInfo);return i}},isNoDataOnStoreyOfRoot:function(e,t){let i=!1;if(!e||!t)return i;for(var n=0;n<r.length;n++)r[n].context===t&&r[n].buildingRootID===e&&(i="NoData"===r[n].storeyInfo);return i},clearStoreyNavigratorController:function(e){if(e&&e.context){for(var t=0;t<o.length;t++)if(o[t].context===e.context){o[t].storeyNavigratorController&&o[t].storeyNavigratorController.DestroyStoreyNavigator(),o.splice(t,1),n&&(n=void 0);break}!function(e){if(e)for(var t=0;t<r.length;t++)r[t].context===e&&r.splice(t,1)}(e.context)}},setActivateClippingActionFlag:function(e){n=e},getActivateClippingActionFlag:function(){return n}})}),define("DS/DMUPlaySection/DMUClippingManipulationTool",["UWA/Core","UWA/Class","DS/Controls/Slider","DS/Controls/SpinBox","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/CATWebUXPreferences/CATWebUXPreferencesManager","css!DS/DMUPlaySection/DMUPlaySection.css"],function(e,t,i,n,o,r,a,l){"use strict";return t.extend({init:function(t){var s=t||{};this._parent(s);var c=this,u=s.iReviewContext,p=0;if(s.frameWindow&&!(isNaN(s.initValue)||isNaN(s.initMinValue)||isNaN(s.initMaxValue)||isNaN(s.initManipRange))){(s.initValue<s.initMinValue||s.initValue>s.initMaxValue)&&(s.initValue=.5*(s.initMinValue+s.initMaxValue));var g,d,v=s.viewType?s.viewType:"ExploreView";s.initStepValue=void 0!==s.initStepValue&&s.initStepValue>0?parseFloat(s.initStepValue):p/10;var f="Millimeter",m=a.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value;if("number"==typeof s.initManipRange){var S,h,C,y;p=r.convert(s.initManipRange,"Length",f,m);var b={},M=v,P="ExploreView"===M,w=!0;c.bPerformRefreshOrCreate=!0;var D=new e.Element("div",{class:"DMUSectionTranslationSliderSpinnerContainer",styles:{opacity:0}}).inject(s.frameWindow.getUIFrame());s.hasCompareObject&&D.setStyles({top:"70px"});var x=1,V=r.convert(s.initMinValue,"Length",f,m),A=r.convert(s.initMaxValue,"Length",f,m);if("number"==typeof s.initStepValue){var N=Math.abs(A-V);x=s.initStepValue<N?s.initStepValue:N}var R=o.getWebappsBaseUrl()+"DMUBaseCommands/assets/icons/32/";new e.createElement("img",{class:"WebSectionImg",src:R+"I_WebClippingTool.png",styles:{left:"0px"}}).inject(D),C=e.createElement("div",{class:"TranslationSliderContainer",styles:{display:!0===P?"":"none"}}).inject(D),(S=new i({minValue:V,maxValue:A,stepValue:x,value:r.convert(s.initValue,"Length",f,m)}).inject(C)).getTextFromValue=function(){var e="true"===a.readPreferences({name:"cke",PreferenceNames:["TrailingZeros"]}).preferences[0].value;return a.convertUnitValueToString("Length",r.convert(this.value,"Length",m,"Millimeter"),u,!0,!1,e)},S.addEventListener("beginEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.beginManipulation&&s.iOwner.beginManipulation(),c.bPerformRefreshOrCreate=!0}),S.addEventListener("change",function(){c.bPerformRefreshOrCreate=!1,s.onChangeSliderCB&&s.onChangeSliderCB(S.value),s.iOwner&&s.iOwner.doManipulation&&s.iOwner.doManipulation(),c.bPerformRefreshOrCreate=!0}),S.addEventListener("endEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.endManipulation&&s.iOwner.endManipulation(),c.bPerformRefreshOrCreate=!0});var _=a.readPreferences({name:"cke",PreferenceNames:["LengthDisplay"]}),T=parseFloat(_.preferences[0].value);y=e.createElement("div",{class:"TranslationSpinnerContainer",styles:{display:!1===P?"":"none"}}).inject(D),(h=new n({minValue:V,maxValue:A,stepValue:x,value:r.convert(s.initValue,"Length",f,m),units:r.Length[m].symbol,decimals:T}).inject(y)).elements.container.addClassName("TranslationSpinner"),h.addEventListener("beginEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.beginManipulation&&s.iOwner.beginManipulation(),c.bPerformRefreshOrCreate=!0}),h.addEventListener("change",function(){c.bPerformRefreshOrCreate=!1,s.onChangeSpinnerCB&&s.onChangeSpinnerCB(h.value),s.iOwner&&s.iOwner.doManipulation&&s.iOwner.doManipulation(),c.bPerformRefreshOrCreate=!0}),h.addEventListener("endEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.endManipulation&&s.iOwner.endManipulation(),c.bPerformRefreshOrCreate=!0}),b.onFreeZoneResize||(s.frameWindow.getImmersiveFrame().addEventListener("freeZoneResize",O),b.onFreeZoneResize=1),setTimeout(function(){D&&(O(),D.setStyles({opacity:1}))},50),this.setActiveView=function(e){"ExploreView"===e?(void 0!==C&&C.setStyle("display",""),void 0!==y&&y.setStyle("display","none"),M="ExploreView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider()):"DetailedView"===e&&(void 0!==C&&C.setStyle("display","none"),void 0!==y&&y.setStyle("display",""),M="DetailedView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider())},this.getActiveView=function(){return M},this.setValue=function(e,t){isNaN(e)||(e=r.convert(e,"Length",f,m),"Slider"===t&&S?(S._properties&&S._properties.value&&(S._properties.value.value=e),S._updateCursor&&S._updateCursor()):"Spinner"===t&&h&&(h.value=e))},this.getValue=function(e){return"Slider"===e&&S?S.value:"Spinner"===e&&h?h.value:void 0},this.setRangeValues=function(e,t,i){isNaN(e)||isNaN(t)||(e=r.convert(e,"Length",f,m),t=r.convert(t,"Length",f,m),"Slider"===i&&S?(S.minValue=e,S.maxValue=t):"Spinner"===i&&h&&(h.minValue=e,h.maxValue=t))},this.getRangeValues=function(e){return"Slider"===e&&S?{minValue:S.minValue,maxValue:S.maxValue}:"Spinner"===e&&h?{minValue:h.minValue,maxValue:h.maxValue}:void 0},this.getSpinnerUnit=function(){if(h)return h.units},this.getSpinnerDecimalValue=function(){if(h)return h.decimals},this.getVisibleFlag=function(e){return"Slider"===e&&C?"none"!==C.getStyle("display"):"Spinner"===e&&y?"none"!==y.getStyle("display"):w},this.setVisibleFlag=function(e){w=e,D.setStyle("display",w?"":"none")},this.update=function(e){if(null!=e){var t="Slider";"DetailedView"===M&&(t="Spinner"),void 0!==e.minValue&&void 0!==e.maxValue&&c.setRangeValues(e.minValue,e.maxValue,t),void 0!==e.value&&c.setValue(e.value,t)}},this.subscribeToPrefChangeEvt=function(e){null!=e&&(g||(g=l.givePreferenceManager({context:s.frameWindow}))&&e.event&&e.cb&&(d=g.subscribe(e.event,e.cb)))},this.unsubscribeToPrefChangeEvt=function(){g&&(d=g.unsubscribe(d)),g=d=null},this.clean=function(){t.frameWindow&&D&&D.parentNode===t.frameWindow.getUIFrame()&&t.frameWindow.getUIFrame().removeChild(D),b.onFreeZoneResize&&s.frameWindow&&s.frameWindow.getImmersiveFrame().removeEventListener("freeZoneResize",O),D=null,b={},t.iOwner&&t.iOwner._movegauge&&(t.iOwner._movegauge=null),c.unsubscribeToPrefChangeEvt()},v!==M&&this.setActiveView(v)}}function O(){if(D){var e=s.frameWindow.getImmersiveFrame().getFreeZone().getSize();if(e.width){var t=0,i=s.frameWindow.getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea),n=i.getContainedWindows();if(n&&(1===n.length&&n[0].isAWindowGroup()&&n[0].getEmbeddedWindows().length||1===n.length&&!n[0].isAWindowGroup())){for(var o=n[0].getEmbeddedWindows?n[0].getEmbeddedWindows():n,r=!1,a=0;a<o.length;a++)o[a].visibleFlag&&(r=!0);if(r&&!i.collapseDockingZoneFlag){var l=i._collapserSize;t=i.dockingZoneSize+l}}else i.interactiveDockAreaVisibleFlag&&(t=i.dockingZoneSize);let c=125;s.hasCompareObject&&(c=137.5),t+=e.width/2-c,D.setStyles({left:t+"px"})}}}}})}),define("DS/DMUPlaySection/DMUSectionPosPreVisuNode3D",["DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsAvatars","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUToolsMaterial","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/SceneGraphFactory"],function(e,t,i,n,o,r,a,l,s){"use strict";return n.extend({init:function(c){this._parent();var u,p,g=c;function d(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)}function v(e,t,n){var o=function(e,t){var n=(new i.Projector).projectVector(t.clone(),e.viewpoints[0].getCamera()),o=Math.round((0-n.y)*(e.canvas.offsetHeight/2)+e.canvas.offsetHeight/2),r=Math.round(n.x*(e.canvas.offsetWidth/2)+e.canvas.offsetWidth/2);return{top:o,left:r,bottom:e.canvas.offsetHeight-o,right:e.canvas.offsetWidth-r,inWindow:o>0&&o<e.canvas.offsetHeight&&r>0&&r<e.canvas.offsetWidth}}(e,t),a=function(e,t,n){var o=new i.Vector3((t-window.pageXOffset)/e.canvas.offsetWidth*2-1,-(n-window.pageYOffset)/e.canvas.offsetHeight*2+1,.5),r=(new i.Projector).pickingRay(o,e.currentViewpoint.camera);return{position:r.ray.origin,direction:r.ray.direction}}(e,o.left+n,o.top);return r.computePointLineDistance(t.toArray(),a.position.toArray(),a.direction.toArray()).distance}var f={};f.preSolidLine=a.retrieveMaterialFromGAS({color:new i.Color(16753920),lineWidth:window.devicePixelRatio,pattern:o.LinePatternEnum.SOLID}),f.dotDashedLineBlack=a.retrieveMaterialFromGAS({color:new i.Color(0),lineWidth:window.devicePixelRatio+1,pattern:o.LinePatternEnum.DOTDASHED}),f.crossPointPreHighlight=a.retrieveMaterialFromGAS({symbol:1,size:10,color:new i.Color(65535)}),f.preFaceMaterial=a.retrieveMaterialFromGAS({color:new i.Color(16753920),opacity:1}),f.preFaceMaterial.force=!0,f.preSolidLine.force=!0,f.preFaceMaterial.line=f.preSolidLine,this.getAxisNode=function(i){var n,o,r,a=i.getType()===e.GeometryType.CIRCLE,l=a?{beginPoint:i.getCenter().clone(),endPoint:i.getCenter().clone()}:i.getPoints();n=i.getAxis().clone();var s=a?60:30,c=v(g,l.beginPoint,s);return n.normalize().multiplyScalar(c),o=l.beginPoint.clone().sub(n),r=l.endPoint.clone().add(n),t.createLineNode(o,r,f.dotDashedLineBlack)},this.getPointNode=function(e){if(e)return f.crossPointPreHighlight.force=!0,s.createPointsNode({positions:e.clone().toArray(),material:f.crossPointPreHighlight})};var m=new n;d(this,m),this.buildPreVisuNode=function(e){if(e&&e.data&&e.data.point&&e.data.normal){m.removeChildren();var i=e.data.point,n=e.data.normal,o=g.currentViewpoint,r=v(g,i,40);u=t.createRectangleNode(r,r,i,n,f.preFaceMaterial,!1),p||(p=t.createArrowNormalNode(o)),p&&p.setMatrix(l.getMatFromNormWithPos(n,i)),d(m,u),d(m,p),e.data.measurable&&e.data.toShowAxisVisu()&&d(m,this.getAxisNode(e.data.measurable,!0))}},this.remove=function(){m&&(m.removeChildren(),m.remove(),m=void 0),u&&(u.removeChildren(),u.remove(),u=void 0),p&&(p.removeChildren(),p.remove(),p=void 0)}}})}),define("DS/DMUPlaySection/DMUToolsSection",["DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUSectionPosService","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUToolsSceneGraph","DS/WebPolyPlanarSectionOper/WebPolyPlanarSectionOper","DS/DMUPlaySection/DMUStoreyNavigratorController"],function(e,t,i,n,o,r,a,l,s,c,u,p){"use strict";var g={computeSectionCurvesUsingPolyPlanarOperator:function(e,t,i){var n=new u(e);return n?n.Run(t,i):{}},computeSectionPlaneReferencial:function(o,a,l,s){var c=new i.Vector3((a.max.x+a.min.x)/2,(a.max.y+a.min.y)/2,(a.max.z+a.min.z)/2),u=n.getViewpointInfo(o.currentViewpoint),p=e.dot(u.sight.toArray(),[1,0,0]),g=e.dot(u.sight.toArray(),[0,1,0]),d=e.dot(u.sight.toArray(),[0,0,1]),v=Math.abs(p),f=Math.abs(g),m=Math.abs(d),S=new i.Matrix4;if(s&&"Automatic"!==s?S=function(e,t){let n=e;var o;switch(t.toLowerCase()){case"x":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateY(-Math.PI/2).setPosition(o);break;case"y":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateX(Math.PI/2).setPosition(o);break;case"z":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateY(Math.PI).setPosition(o)}return n}(S,s):r.isLessOrEqual(v,f)||r.isLessOrEqual(v,m)?r.isLessOrEqual(f,m)?r.isLessThan(d,0)&&S.rotateY(Math.PI):r.isLessThan(g,0)?S.rotateX(Math.PI/2):S.rotateX(-Math.PI/2):r.isLessOrEqual(p,0)?S.rotateY(-Math.PI/2):S.rotateY(Math.PI/2),S.setPosition(c),l){var h=t.computePlaneDim(a,S,!1,!0);if(!isNaN(h.fSliceOffset)&&h.fSliceOffset>0){var C=this.computePlaneCenter(S,2*h.fSliceOffset,!0);C&&S.setPosition(C)}}return S},checkLineIntersection:function(e,t){var i=e[0][0],n=e[0][1],o=e[1][0],r=e[1][1],a=t[0][0],l=t[0][1],s=t[1][0],c=t[1][1],u={x:null,y:null,bIsOnLine1:!1,bIsOnLine2:!1},p=(c-l)*(o-i)-(s-a)*(r-n);if(0===p)return u;var g=n-l,d=i-a,v=(o-i)*g-(r-n)*d;return g=((s-a)*g-(c-l)*d)/p,d=v/p,u.x=i+g*(o-i),u.y=n+g*(r-n),g>0&&g<1&&(u.bIsOnLine1=!0),d>0&&d<1&&(u.bIsOnLine2=!0),u},trimPolylines:function(e,t){var n,o=[];t&&(n=[[[t.min.x,t.min.y],[t.max.x,t.min.y]],[[t.max.x,t.min.y],[t.max.x,t.max.y]],[[t.max.x,t.max.y],[t.min.x,t.max.y]],[[t.min.x,t.max.y],[t.min.x,t.min.y]]]);var r,a,l,s,c=!1,u=0,p=0,d=0;for(u=0;u<e.length;u++){a=e[u]._Vertices.length,c=!1;var v=[];for(p=0;p<a;p++)if(l=new i.Vector2(e[u]._Vertices[p][0],e[u]._Vertices[p][1]),!t||t&&t.containsPoint(l))v.push([e[u]._Vertices[p][0],e[u]._Vertices[p][1],e[u]._Vertices[p][2]]),c=!0;else{r=p,c&&(r=--p,c=!1);var f=!1;if(r<a-1)for(d=0;d<n.length;d++)(s=g.checkLineIntersection(n[d],[[e[u]._Vertices[r][0],e[u]._Vertices[r][1]],[e[u]._Vertices[r+1][0],e[u]._Vertices[r+1][1]]])).bIsOnLine1&&s.bIsOnLine2&&(v.push([s.x,s.y,e[u]._Vertices[r][2]]),f=!0);!f&&v.length>0&&(o.push(v),v=[])}v.length>0&&o.push(v)}return o},getEditCmd:function(e){var t=o.getContextViewer({viewer:e});return s.getEditCmd(t)},getClippingCmd:function(e){var t=o.getContextViewer({viewer:e});return s.getClippingCmd(t)},computePlaneCenter:function(e,t,n){var o=t,r=(new i.Vector3).getPositionFromMatrix(e);if(!isNaN(o)&&n){var a=e.decompose(),l=new i.Vector3(0,0,1).applyQuaternion(a[1]).normalize();l.negate(),l=l.multiplyScalar(o/2),r=r.add(l)}return r},computeClippingSlice:function(e,t){if(e&&e.radius&&e.center){var n=e.radius;if(t){var o=t.decompose(),r=(new i.Vector3).getPositionFromMatrix(t),s=new i.Vector3(0,0,1).applyQuaternion(o[1]).normalize(),c=e.center;s=s.multiplyScalar(n),c=c.add(s);var u=s.clone().normalize(),p=a.computeTwoPlanesDistance(r.toArray(),u.toArray(),c.toArray(),u.toArray());p&&0===p.returnCode&&p.relationship===l.Relationship.PARRALLEL&&(n=p.distance)}return n}},cleanClippingVisu:function(e){let t=o.giveEventsController({viewer:e});t&&t.fireEvent("onEditCommandEnd");let i=o.getReviewContext({viewer:e});if(i){let e=s.retriveClippingObjsFromSlide(i);e&&e.forEach(function(e){if(e){var t=e.getNode();t&&(t.setPickingInManipulationModeForLineTraslation(!0),t.cleanClippingRobot())}})}},initClippingVisu:function(e,t){if(!e||!t)return;let i=o.giveEventsController({viewer:e});i&&i.fireEvent("initClippingVisu",t)},getRootsForClipping:function(e){let t=o.getReviewContext({viewer:e});if(t&&t.getReviewCtxInformation){let e=t.getReviewCtxInformation();if(e&&e.contextId)return[c.getNodeFromID(e.contextId)]}return c.getRootReferences(e)},isClippingEligibleForStoreyMode:function(e,t){for(var i=g.getRootsForClipping(e),n=0;n<i.length;n++)if(i[n]){let e=c.getNodeType(i[n]);if("Building"===e||"AecSite"===e){let e=c.getNodeID(i[n]);if(!p.isNoDataOnStoreyOfRoot(e,t))return i[n]}}},getBuildingRootData:function(e,t,i){if(!e)return;let n,o;i&&(o=[]);let r=!1;if(t){let e=c.getNodeType(t);if("Building"===e||"AecSite"===e){r=!0;let e={rootNode:t,ID:c.getNodeID(t)};i?o.push(e):o=e}}if(!r){n=g.getRootsForClipping(e);for(var a=0;a<n.length;a++)if(n[a]){var l=n[a];let e=c.getNodeType(l);if("Building"===e||"AecSite"===e){let e={rootNode:l,ID:c.getNodeID(l)};if(!i){o=e;break}o.push(e)}}}return o},getStoreyinfoOnSlide:function(e){if(!e)return;let t;var i=o.getReviewContext({viewer:e});if(i&&i.getCurrentSessionMarkup){var n=i.getCurrentSessionMarkup();if(n){var r=n.getCurrentSlide();if(r){var a=r.getEnvironmentOverload();t="string"==typeof a.state.sContructionItemId?a.state.sContructionItemId:void 0}}}return t},setStoreyinfoOnSlide:function(e,t){if(!t||!e||"string"!=typeof t)return;let i=t;var n=o.getReviewContext({viewer:e});if(n&&n.getCurrentSessionMarkup){var r=n.getCurrentSessionMarkup();let e;if(r){if(r){let t=n.getRestrictions(r);t.markup&&void 0!==t.markup.canEdit&&(e=t.markup.canEdit)}if(r&&r.getActiveFlag()&&r.isVisible()&&!r.isReadOnly()&&r.getCurrentSlide&&r.getCurrentSlide()&&e){var a=r.getCurrentSlide();if(!r.isReadOnly()){var l=a.getEnvironmentOverload();l&&l.state&&(l.state.sContructionItemId=i,a.updateEnvironmentOverload(l),a.fireEvent("onDMUSlideSessionInfoChanged",{dmuObject:a,info:"storeyId"}))}}}}return i}};return g}),define("DS/DMUPlaySection/DMUClippingNode3D",["UWA/Core","DS/DMUBaseUI/DMUNode3D","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUManipulableClippingPlane","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/DMUBaseCommands/EXPToolsWUX","DS/Visualization/ClippingContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/PADUtils/PADSettingsMgt","DS/DMUPlaySection/DMUToolsSection","DS/DMUPlaySection/DMUClippingRobot","DS/Ruler/Ruler","DS/SceneGraphNodes/FixedSizeNode3D","DS/Robot/LineTranslationNode","DS/Mesh/Mesh","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"].concat(["DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController"]),function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,v,f,m,S,h,C,y,b){"use strict";var M=e.Class.extend({init:function(e){var t=e.frameWindow,i=e.getAppType,n=e.nodeInfo,r=e.viewer,a=e.type,u=e.originPlaneType,p=!1;this.isManipulationOnGO=function(){return p};var g,d,v,f,y,b,M=[];function P(){g=new m(t,{displayOrigin:!1,offset:20,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:"3dPlay"===i()});(d=[]).push(g.subscribe("RulerManipulateBegin",function(e){!function(e){if(p=!0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:e.event})){var t=n.getPlaneGeometryCB(a);f=(new s.Vector3).getPositionFromMatrix(t.referential),n.manipulationInformationCB({action:o.ManipulationAction.BEGIN,type:o.ManipulationType.TRANSLATION,evt:e.event})}}(e)})),d.push(g.subscribe("RulerManipulate",function(e){!function(e){if(p=!0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:e.event})){if(f){var t=n.getPlaneGeometryCB(a);f=(new s.Vector3).getPositionFromMatrix(t.referential)}var i=f.clone().add(e.translationVector);n.setPlaneGeometryCB({newCenter:i,from:a,UpdateRobotpos:!0}),n.manipulationInformationCB({action:o.ManipulationAction.DO,type:o.ManipulationType.TRANSLATION,evt:e.event})}}(e)})),d.push(g.subscribe("RulerManipulateEnd",function(e){var t;t=e,p=!1,f=void 0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:t.event}),n.manipulationInformationCB({action:o.ManipulationAction.END,type:o.ManipulationType.TRANSLATION,evt:t.event})}))}function w(){return n.getPlaneGeometryCB(a).referential}P(),this.updateOnTranslationBegin=function(e){if(p=!0,f=e.intersection.position,"ConstructionItem"===u?(b||(b=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB().referential)),M.origin3D=b):M.origin3D=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB(u).referential),g||P(),!y){y=new c;var t={position:new s.Vector3(0,0,0),touchMode:!1},i=new S({name:"fixedSizeNode3D",ratio:7}),o=new h(t);o.name="arrowTranslationNode",o.mat.color=new s.Color("#1B6E9C"),o.mat.opacity=1,o.setNoZ(!0),i.addChild(o),r&&y&&(y.addChild(i),r.addNode(y),r.render())}y&&(y.setMatrix(w().setPosition(f.clone())),y.setVisibilityInTree(!1),y.setVisibility(r.getVisibleSpace()),y.setPickable(C.PICKTHROUGH));var d=(new s.Vector3).copy(e.manipulator.axis).negate(),m=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB(a).referential);M.initOrigin=m.clone();var D=(new s.Vector3).copy(M.initOrigin);M.origin3D&&(D=new s.Line3(M.initOrigin,(new s.Vector3).copy(M.initOrigin).add(d)).closestPointToPoint(M.origin3D,!1));M.origin=D;var x=(new s.Vector3).copy(M.origin).sub(m).dot(d);if(M.direction=d,M.value=D.distanceTo(m)*(x>0?-1:1),M.initValue=M.value,g){var V=d.clone().negate().normalize().multiplyScalar(M.value);g.origin=f.clone().add(V),g.origin3DPos=M.origin3D,v=M.value,g.initOrigin=M.initOrigin,g.setValue(M.value),g.direction=M.direction,g.initValue=M.initValue,g.unit=l.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value,g.display(),g.beginManipulation()}},this.setOrigin=function(e){b=e},this.snapTranslationCallback=function(e){var t=e.translationVector;if(g){var i=g.getSnappedTranslationVector(e);0===i.returnCode&&(t=i.snappedTranslationVector)}return t},this.updateOnTranslation=function(e){if(p=!0,g){var t=M.value;M.value=M.initValue+e.translationVector.length()*(M.direction.dot(e.translationVector)>0?1:-1),g.setValue(M.value);var i=w();if(t&&t<M.value){var n=new s.Vector3,o=new s.Vector3,r=new s.Vector3;i.extractBasis(n,o,r),r.negate(),i.makeBasis(n,o,r)}var a=(new s.Vector3).copy(e.manipulator.axis).normalize().multiplyScalar(v-M.value),l=f.clone().add(a);y.setMatrix(i.setPosition(l.clone()))}else!g&&e.intersection&&e.manipulator&&this.updateOnTranslationBegin({intersection:e.intersection,manipulator:e.manipulator})},this.updateOnTranslationEnd=function(){p=!1,y&&y.setVisibility(!r.getVisibleSpace()),g&&(g.endManipulation(),g.display()),y&&(r.removeNode(y),y.removeChildren(),y.remove(),y=void 0),f=void 0},this.clear=function(){p||(g&&g.clear(),g=null)}}});return t.extend({init:function(e){var t;this._parent({frmWindow:e._frmWindow,getType:e.getType});var l,m=this;m.clippingNode=!0;var S,h,P,w,D,x,V,A,N,R,_,T,O,E,I,U,B,L=!1,k=!1,F=!1,z=null,G=!1,W=new s.Plane,j=new s.Plane,H=new s.Plane,X=new s.Plane,Y=new s.Plane,J=new s.Plane,Z=new s.Plane,q=[],Q=[],K=[],$=new s.Box3,ee=1,te=function(e){if(e&&(e.setFrustumCulled&&e.setFrustumCulled(!1),e.children))for(var t=0;t<e.children.length;t++)te(e.children[t])},ie=function(){var e=!1;return d&&d.getSetting("enopad3dviewer_lightNodeModel")&&(e=!0),e};function ne(t){var i=e.getAttribute("fXDirSize");"Right"!==t&&"Left"!==t||(i=e.getAttribute("fSliceOffset"));var n=e.getAttribute("fYDirSize");return"Top"!==t&&"Bottom"!==t||(n=e.getAttribute("fSliceOffset")),{referential:e._getPlanReferential(t),uSize:i,vSize:n,uStep:e.getAttribute("fXDirGridStep"),vStep:e.getAttribute("fYDirGridStep"),sliceOffset:e.getAttribute("fSliceOffset"),planeType:e.getAttribute("sPlaneBoxMode")}}function oe(){m._robot||(l||(l=v.getEditCmd(e._viewer)),l&&((l.isRunning()||l.isPaused())&&v.cleanClippingVisu(e._viewer),v.initClippingVisu(e._viewer,e)))}function re(){return m._robot}function ae(t){if(t&&(t.uSize||t.vSize||t.uStep||t.vStep||t.referential)){if(t.uSize&&e.setAttribute("fXDirSize",t.uSize),t.vSize&&e.setAttribute("fYDirSize",t.vSize),t.uStep&&e.setAttribute("fXDirGridStep",t.uStep),t.vStep&&e.setAttribute("fYDirGridStep",t.vStep),t.referential){var i=t.referential.clone();if(t.toRelocate&&!e.isSinglePlaneMode()){var n=e.getPlaneCenter(i);i.setPosition(n)}e.setAttribute("mPlaneReferential",i),e.modifyPlaneReferential(i)}}else{var o,r,a,l=t.newCenter,c=!0;switch(t.from){case"Top":r="Bottom",a="fYDirSize";break;case"Bottom":r="Top",a="fYDirSize";break;case"Right":r="Left",a="fXDirSize";break;case"Left":r="Right",a="fXDirSize";break;case"Back":r=void 0,a="fSliceOffset",c=!1;break;default:(o=ne().referential).setPosition(l),c=!1,e.isSinglePlaneMode()||(r="Back",a="fSliceOffset")}if(a){var u=(new s.Vector3).getPositionFromMatrix(ne(r).referential);if(l&&u){var p=u.distanceTo(l),g=e.getAttribute(a);if(e.setAttribute(a,p),c&&p){var d=u.clone().sub(l.clone()).normalize();d.multiplyScalar(.5*(g-p));var v=ne(),f=(new s.Vector3).getPositionFromMatrix(v.referential);o=v.referential,f=f.clone().add(d).clone(),o.setPosition(f)}}}o&&e.setAttribute("mPlaneReferential",o)}t.UpdateRobotpos&&m._robot&&m._robot.updateRobotPos()}function le(){var t=o.State.STANDARD;return e.isInEdition()&&(t=o.State.INEDITION),t}function se(){return e.isSectionDisplayed()}function ce(){var t={mode:o.DisplayMode.PLANE,fillColor:e.getAttribute("cFillStyleColor"),opacity:e.getAttribute("fOpacity")};return"Grid"===e.getAttribute("sDisplayPlaneMode")&&(t.mode=o.DisplayMode.GRID),t}function ue(t){var n=!0;if(!t||t.type!==o.ManipulationType.TRANSLATION&&t.type!==o.ManipulationType.ROTATION&&t.type!==o.ManipulationType.RESIZE&&t.type!==o.ManipulationType.CENTER)return n;switch(t.action){case o.ManipulationAction.ENABLE:void 0===U&&(U=!e.isEditable()||function(){var t=a.isManipulationAllowed({viewer:e._viewer});if("boolean"==typeof t)return!t;var n=i.checkIfCommandIsRunning(e._viewer);return n&&"SelectiveSectionContextCmdHdr"===i.getCurrentCommand(e._viewer)&&(u.addInCSO(e,!1),n=!1),n}()||!e.isInEdition()),n=!U;break;case o.ManipulationAction.BEGIN:var r=Boolean(t.fromRobot);e.clearAllRuler(r),U||(t.type===o.ManipulationType.CENTER&&(m.enableClipping(!1),e._viewer.setSectionCapping(!1)),e.beginManipulation());break;case o.ManipulationAction.DO:U||e.doManipulation();break;case o.ManipulationAction.END:U?e.isClippingPlaneVisible()&&e.endManipulation(t.evt,!0):(t.type===o.ManipulationType.CENTER&&(m.enableClipping(!0),e._viewer.setSectionCapping(!0)),e.endManipulation(t.evt)),U=void 0;break;case o.ManipulationAction.LONG_HOLD:U||e.onLongHold()}return n}function pe(t){var i=e.isEditable();return new o({viewer:e._viewer,frameWindow:e._frmWindow,bTranslationManipulator:i,sType:t,getState:le,getShowState:se,getGeometry:ne,setGeometry:ae,getDisplayInformation:ce,getManipulationInformation:ue,appType:e._typeApps,context:e._context,initRobotCB:oe,getRobotCB:re,ruler:"NormalMode"!==e.getAttribute("sPlaneBoxMode")?new M({frameWindow:e._frmWindow,getAppType:m.getAppType,nodeInfo:m,viewer:e._viewer,type:t,originPlaneType:e.isConstructionItemMode()?"ConstructionItem":function(e){if(!e)return"Back";var t;switch(e){case"Back":break;case"Top":t="Bottom";break;case"Bottom":t="Top";break;case"Right":t="Left";break;case"Left":t="Right"}return t}(t)}):void 0,storeyMode:e.isConstructionItemMode()})}function ge(t){var i=e.getAttribute("sPlaneBoxMode");"Grid"!==e.getAttribute("sDisplayPlaneMode")&&("Back"!==t||"SliceMode"!==i&&"BoxMode"!==i||(D?D.update():((D=pe(t)).setName(y.sectionplane),(P=new c).setVisibilityInTree(!1),m.addChild(P),P.addChild(D))),"BoxMode"===i&&("Top"===t?_?_.update():((_=pe(t)).setName(y.sectionplane),(x=new c).setVisibilityInTree(!1),m.addChild(x),x.addChild(_)):"Bottom"===t?T?T.update():((T=pe(t)).setName(y.sectionplane),(V=new c).setVisibilityInTree(!1),m.addChild(V),V.addChild(T)):"Right"===t?O?O.update():((O=pe(t)).setName(y.sectionplane),(A=new c).setVisibilityInTree(!1),m.addChild(A),A.addChild(O)):"Left"===t&&(E?E.update():((E=pe(t)).setName(y.sectionplane),(N=new c).setVisibilityInTree(!1),m.addChild(N),N.addChild(E)))))}function de(){var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||(n=e.getAttribute("fSliceOffset"));var a=e.getAttribute("fXDirGridStep"),l=e.getAttribute("fYDirGridStep");a||(a=t/10),l||(l=i/10);var c=e.getAttribute("iGridAbsoluteMode");R=new g({window:e._frmWindow,viewer:e._viewer,context:r.getContextViewer({viewer:e._viewer}),nbMaxLabel:300,stepRequiredX:a,stepRequiredY:l,stepRequiredZ:0===n?0:a,gridMatrix:(new s.Matrix4).copy(e._getPlanReferential()),freeZoneDim:e._viewer.canvas.getBoundingClientRect(),id:"Section",owner:h,isEditable:!1,isLabelManipulable:!1,isAbsoluteMode:1===c})}function ve(){var i=e.isSectionDisplayed()&&(e.isInEdition()||e.isClippingPlaneVisible());i||m.clearAllRulers(),e._bIsInShowSpace||(i=!i);var n=i;if(e._bVisible&&(n=!i),"NoPlane"===e.getAttribute("sDisplayPlaneMode")&&i&&(i=!i),w)if(w.setVisibility(i),w.setVisibilityFree(n),!e.isEditable()&&m._robot)m._robot.update(Boolean(e._bIsInShowSpace));else if(m._robot){var o;!1===(e._bIsInShowSpace?i:!i)?(o=!i,m._robot.update(o)):(o=!e.isInEdition(),e._bIsInShowSpace||(o=!o)),m._robot.update(o)}D&&(D.setVisibility(i),D.setVisibilityFree(n)),_&&(_.setVisibility(i),_.setVisibilityFree(n)),T&&(T.setVisibility(i),T.setVisibilityFree(n)),O&&(O.setVisibility(i),O.setVisibilityFree(n)),E&&(E.setVisibility(i),E.setVisibilityFree(n)),function(){var i=e.getAttribute("sPlaneBoxMode"),n=(new s.Matrix4).translate(new s.Vector3(0,0,.1));w&&w.setMatrix(n),D&&D.setMatrix(n),_&&_.setMatrix(n),T&&T.setMatrix(n),O&&O.setMatrix(n),E&&E.setMatrix(n),h.setMatrix(e._getPlanReferential()),"SliceMode"!==i&&"BoxMode"!==i||!P||P.setMatrix(e._getPlanReferential("Back")),"BoxMode"===i&&(x&&x.setMatrix(e._getPlanReferential("Top")),V&&V.setMatrix(e._getPlanReferential("Bottom")),A&&A.setMatrix(e._getPlanReferential("Right")),N&&N.setMatrix(e._getPlanReferential("Left")));var o=e.getAttribute("sSectionRender"),a=e.isSectionDisplayed(),l=!1!==e.getAttribute("bClippingActiveState");L&&a&&S&&o!==S&&"NoCut"!==S&&(e._viewer.removeClippingPlane(W),j&&e._viewer.removeClippingPlane(j),m.enableClipping(!1),e._viewer.setSectionCapping(!1),L=!1),S=o,t||(t=r.getContextViewer({viewer:e._viewer})),a&&!L&&b&&t&&b.getSectionVisibilityFlag(t)&&b.setSectionVisibilityFlag(t,!1);if("CutOneSide"===o&&(!L&&l&&a&&(L=!0,e._viewer.setSectionCappingMaterial(W,null),e._viewer.addClippingPlane(W,z),"SliceMode"===i?e._viewer.addClippingPlane(H,z):"BoxMode"===i&&(e._viewer.addClippingPlane(H,z),e._viewer.addClippingPlane(X,z),e._viewer.addClippingPlane(Y,z),e._viewer.addClippingPlane(Z,z),e._viewer.addClippingPlane(J,z)),m.enableClipping(!0),e._viewer.setSectionCapping(!0)),L&&!a&&(L=!1,e._viewer.removeClippingPlane(W),"SliceMode"===i?e._viewer.removeClippingPlane(H):"BoxMode"===i&&(e._viewer.removeClippingPlane(X),e._viewer.removeClippingPlane(Y),e._viewer.removeClippingPlane(Z),e._viewer.removeClippingPlane(J)),m.enableClipping(!1),e._viewer.setSectionCapping(!1)),L&&a&&!e._viewer.getSectionCapping()&&e._viewer.setSectionCapping(l)),"OnlyContour"===o){if(!L&&a){L=!0;var c=(new s.Matrix4).copy(e._getPlanReferential());j.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),j.applyMatrix4(c.rotateX(Math.PI)),e._viewer.addClippingPlane(W,z),e._viewer.addClippingPlane(j,z),m.enableClipping(!0),e._viewer.setSectionCapping(!1)}L&&!a&&(L=!1,e._viewer.removeClippingPlane(W),e._viewer.removeClippingPlane(j),m.enableClipping(!1),e._viewer.setSectionCapping(!1))}}(),W.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),W.applyMatrix4(e._getPlanReferential()),"SliceMode"!==e.getAttribute("sPlaneBoxMode")&&"BoxMode"!==e.getAttribute("sPlaneBoxMode")||(H.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),H.applyMatrix4(e._getPlanReferential("Back"))),"BoxMode"===e.getAttribute("sPlaneBoxMode")&&(X&&(X.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),X.applyMatrix4(e._getPlanReferential("Top"))),Y&&(Y.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),Y.applyMatrix4(e._getPlanReferential("Bottom"))),J&&(J.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),J.applyMatrix4(e._getPlanReferential("Right"))),Z&&(Z.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),Z.applyMatrix4(e._getPlanReferential("Left"))))}function fe(t,i){if(Array.isArray(t))for(var n=0;n<t.length;n++)fe(t[n],i);else if(t.enableClippingPlane(W,i),"OnlyContour"===e.getAttribute("sSectionRender"))t.enableClippingPlane(j,i);else{var o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||t.enableClippingPlane(H,i),"BoxMode"===o&&(t.enableClippingPlane(X,i),t.enableClippingPlane(Y,i),t.enableClippingPlane(J,i),t.enableClippingPlane(Z,i))}}function me(e){w&&w.setPickable(e),D&&D.setPickable(e),_&&_.setPickable(e),T&&T.setPickable(e),O&&O.setPickable(e),E&&E.setPickable(e)}m.enableClipping=function(t){var i;if(m){Q&&fe(Q,!1),ie()&&I&&(n.removeSceneGraphOverrideSet(e._viewer,I),I=null),function(){var t,i,o,r;q=[],K=[];var a=e.collectCutObjects();t=a.CutObjects,i=a.CutObjectsOOC,F=a.bIsPartial,ee=a.cutUncutMode;var l=0,s=0;if(F)if(ie())for(l=i.length,s=0;s<l;s++){var c=i[s];c&&K.push(c)}else for(l=t.length,s=0;s<l;s++)(o=t[s])&&(r=n.getLastInstance(o),q.push(r.getLastElement()));else{var u=e._viewer.getVisibleSpace();!1===e._bIsInShowSpace&&!1===u&&"Markup"!==e.getParent().getType()||(q=n.getRootReferences(e._viewer))}}();var o=r.getContextViewer({viewer:e._viewer});if(o){var a=o.getController();if(a){var l=a.get3DLayerController();if(l)l.getLayers().forEach(function(e){e.getNode3DBag()&&q.push(e.getNode3DBag())}),t?B||(B=l.subscribe({event:"layerCreated"},function(e){var i=[],n=l.getLayer(e.id);if(n){n.getNode3DBag()&&i.push(n.getNode3DBag()),fe(i,t)}})):(l.unsubscribe(B),B=null)}}Q=q,fe(q,t),t?function(t){if(t&&t.length>0){I=n.createSceneGraphOverrideSet(e._viewer);var i=[];if(i.push(W),"OnlyContour"===e.getAttribute("sSectionRender"))i.push(j);else{var o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||i.push(H),"BoxMode"===o&&(i.push(X),i.push(Y),i.push(J),i.push(Z))}if(ee){var r=n.getOverrides(I,{idPaths:K});if(r&&r.length){var a=new p;a.setPlanes(i),r.forEach(function(e){e.setClippingContext(a)})}}else{var l=n.getRootReferences(e._viewer);for(let e=0;e<l.length;e++){let t=n.buildPathElement(l[e]);if(t){let e=[];e.push(t);let o=n.getOverrides(I,{pathElements:e});if(o&&o.length){let e=new p;e.setPlanes(i);for(let t=0;t<o.length;t++)o[t].setClippingContext(e)}}}var s=n.getOverrides(I,{idPaths:K});if(s&&s.length){var c=new p;c.setExcludeFromClippingPlanes(i),c.setEnableClippingProfile("off"),s.forEach(function(e){e.setClippingContext(c)})}}}}(K):ie()&&e.removeCurvesAndHatching();var s=n.getSceneRoot(e._viewer).children;for(i=0;i<s.length;i++)s[i].toBeSectionned&&s[i].enableClippingPlane(W,t);G=t}},m.isClippingEnabled=function(){return G},m.clean=function(t){if(m.clearAllRulers(!0),t&&m._robot&&m.cleanClippingRobot(),m){var i=n.getRootReferences(e._viewer);ie()&&e.removeCurvesAndHatching(),fe(i,!1),fe(Q,!1),e._viewer.setSectionCappingMaterial(W,null),e._viewer.removeClippingPlane(W),W=new s.Plane,e._viewer.removeClippingPlane(j),j=new s.Plane,e._viewer.removeClippingPlane(H),H=new s.Plane,e._viewer.removeClippingPlane(X),X=new s.Plane,e._viewer.removeClippingPlane(Y),Y=new s.Plane,e._viewer.removeClippingPlane(Z),Z=new s.Plane,e._viewer.removeClippingPlane(J),J=new s.Plane,w&&w.clean(),R&&h&&(R.deleteGrids({owner:h,fromStorage:!0}),R.setActiveState(!1)),m.removeChildren(),h=P=w=D=null,x=V=A=N=R=null,_=T=O=E=null,q.length=0,Q.length=0,L=!1,k=!1,F=!1,U=void 0,z=null}},m.resetClippingFlag=function(){L=!1},m.update=function(t){if(m)if(v.getRootsForClipping(e._viewer).length&&e&&e.isConstructionItemMode()&&!e.isBuidlingRootAvailable(void 0,!0))e.resetToNormalMode();else{t&&m.clean();var i=void 0;if(e.isCustomColorSorce("Capping")&&(i=e.getAttribute("cCappingColor")),i!==z&&(z=i),h||h||((h=new c).setVisibilityInTree(!1),m.addChild(h),"Grid"!==e.getAttribute("sDisplayPlaneMode")?((w=new pe).setName(y.sectionplane),h.addChild(w),ge("Back"),ge("Top"),ge("Bottom"),ge("Right"),ge("Left")):de(),m.addChild(e.getSectionCurveNode()),te(m)),m.setName(e.getAttribute("sName")),w&&w.update(),R&&h&&(R.deleteGrids({owner:h,fromStorage:!0}),e.isSectionDisplayed()||R.setActiveState(!1)),"Grid"!==e.getAttribute("sDisplayPlaneMode")){var n=e.getAttribute("sPlaneBoxMode");"SliceMode"!==n&&"BoxMode"!==n||(ge("Back"),"BoxMode"===n&&(ge("Top"),ge("Bottom"),ge("Right"),ge("Left")))}else R&&h&&e.isSectionDisplayed()?function(){R.setActiveState(!0);var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||(n=e.getAttribute("fSliceOffset")),$&&$.set(new s.Vector3(-t/2,-i/2,0),new s.Vector3(t/2,i/2,n)),R.drawGrids({specifications:[{BBox:$}]})}():e.isSectionDisplayed()&&de();var o=null,r=!1;e.getAttribute("bSectionCurvesVisible")&&e.isSectionCurveComputationNeeded()&&(o=function(){e.isSecondaryViewerShow()&&e.renderSecondaryViewer()},r=!0),e.manageCurvesAndHatching({computeCurves:r,action:o}),ve()}},m._getManpForRobot=function(){if(w)return w},m.updateRobotPos=function(e){m._robot&&m._robot.updateRobotPos(e)},m.manageLock=function(t){var i=!0;return m&&t!==k?(k=t,m.update(),i=!1):function(){if(w&&w._updateManipulators(),D&&D._updateManipulators(),_&&_._updateManipulators(),T&&T._updateManipulators(),O&&O._updateManipulators(),E&&E._updateManipulators(),m._robot){var t=0!==e._viewer.getVisibleSpace(),i=le()===o.State.INEDITION;i||(r=!1,l||(l=v.getEditCmd(e._viewer)),l&&(r=l.isRunning()),i=r);var n=!(t&&i);m._robot.update(n)}var r}(),i},m.isLocked=function(){return k},m.getFrameWindow=function(){return e._frmWindow},m.getAppType=function(){return e._typeApps},m.getCenter=function(e){var t=ne(),i=(new s.Vector3).getPositionFromMatrix(t.referential),n=t.planeType;if(!(e||"BoxMode"!==n&&"SliceMode"!==n||isNaN(t.sliceOffset))){var o=t.referential.decompose(),r=new s.Vector3(0,0,1).applyQuaternion(o[1]);r=r.normalize().multiplyScalar(t.sliceOffset/2),i=i.add(r)}return i},m.computePlaneCenter=function(t){return v.computePlaneCenter(t,e.getAttribute("fSliceOffset"),!e.isSinglePlaneMode())},m.getNormal=function(){var e=ne().referential.decompose();return new s.Vector3(0,0,1).applyQuaternion(e[1])},m.getUDirection=function(){var e=ne().referential.decompose();return new s.Vector3(1,0,0).applyQuaternion(e[1])},m.getVDirection=function(){var e=ne().referential.decompose();return new s.Vector3(0,1,0).applyQuaternion(e[1])},m.getPlaneGeometryCB=function(e){return ne(e)},m.setPlaneGeometryCB=function(e){ae(e)},m.manipulationInformationCB=function(e){return ue(e)},m.setClippingRepVisibility=function(e){w&&w._setPlaneVisibility(e),D&&D._setPlaneVisibility(e),_&&_._setPlaneVisibility(e),T&&T._setPlaneVisibility(e),O&&O._setPlaneVisibility(e),E&&E._setPlaneVisibility(e)},m.setPickingInManipulationModeForLineTraslation=function(e){w&&w.setPickingInManipulationModeForLineTraslation(e),D&&D.setPickingInManipulationModeForLineTraslation(e),_&&_.setPickingInManipulationModeForLineTraslation(e),T&&T.setPickingInManipulationModeForLineTraslation(e),O&&O.setPickingInManipulationModeForLineTraslation(e),E&&E.setPickingInManipulationModeForLineTraslation(e)},m.setRobot=function(e){m._robot=e,!w||e&&P||w.setRobot(e)},m.getRobot=function(){return m._robot},m.isBoxMode=function(){return"BoxMode"===e.getAttribute("sPlaneBoxMode")},m.clearAllRulers=function(e){w&&w.clearRuler(),D&&D.clearRuler(),_&&_.clearRuler(),T&&T.clearRuler(),O&&O.clearRuler(),E&&E.clearRuler(),!e&&m._robot&&m._robot.updateRobotPos()},m.initClippingRobot=function(t){e.isConstructionItemMode()||(m._robot||m.setRobot(new f(m,t)),m._robot.buildRobot())},m.cleanClippingRobot=function(){m._robot&&m._robot.clean(),m._robot=null},m.isClippingNode=function(){return!0},m.isPersistentClippingCB=function(){return"DMUTemporaryBag"!==e.getParent().getType()},e.isSectionDisplayed()&&m.update(),m._eventController=r.giveEventsController({viewer:e._viewer}),m.cbTokenForSetUnSetPickThrough=[],m._eventController&&(m.cbTokenForSetUnSetPickThrough.push(m._eventController.addEvent("onSetPickThroughtRequest",()=>{me(C.PICKTHROUGH)})),m.cbTokenForSetUnSetPickThrough.push(m._eventController.addEvent("onUnsetPickThroughRequest",()=>{me(C.PICKABLE)}))),m.clearEventToken=function(){m._eventController&&m.cbTokenForSetUnSetPickThrough&&m.cbTokenForSetUnSetPickThrough.forEach(e=>{m._eventController.removeEvent(e)})},m.setRulerOrigin=function(e){w&&w.setRulerOrigin&&w.setRulerOrigin(e)},m.getCurrentStoreyOrigin=function(){e.getCurrentStoreyOrigin()}}})}),define("DS/DMUPlaySection/DMUClippingBase",["UWA/Core","DS/DMUBaseExperience/DMUOverloadableObject","DS/Visualization/Node3D","DS/DMUPlaySection/DMUToolsSection","DS/DMUPlaySection/DMUClippingManipulationTool","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUMeshCreation","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUSectionPosService","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseUIControllers/DMUMarkupsController","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/DMUPlaySection/DMUClippingNode3D","DS/DMUPlaySection/DMUSectionImport","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADAlert","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIServices/DMUObjectsServices","DS/CATWebUXPreferences/DMUClippingPrefService","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUModelServices","DS/DMUControls/DMUWarningPanel","DS/DMUControls/EXPNotify","DS/DMUPlaySection/DMUStoreyNavigratorController","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"],function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,v,f,m,S,h,C,y,b,M,P,w,D,x,V,A,N,R,_,T,O){"use strict";var E=[{name:"mPlaneReferential",type:"Matrix4",JSONname:"PropertiesSection.PlaneReferential",defaultValue:new v.Matrix4},{name:"fXDirSize",type:"float",JSONname:"PropertiesSection.XDirSize"},{name:"fYDirSize",type:"float",JSONname:"PropertiesSection.YDirSize"},{name:"fSliceOffset",type:"float",JSONname:"PropertiesSection.SliceOffset"},{name:"sPlaneBoxMode",type:"string",JSONname:"PropertiesSection.PlaneBoxMode",defaultValue:"NormalMode"},{name:"bSectionCurvesVisible",type:"bool",JSONname:"PropertiesSection.SectionCurvesVisible",defaultValue:!1},{name:"bCustomCappingColor",type:"bool",JSONname:"PropertiesSection.GraphicProperties.Capping.customColor"},{name:"cCappingColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.Capping.color"},{name:"bCustomContourColor",type:"bool",JSONname:"PropertiesSection.GraphicProperties.LineStyle.customColor"},{name:"cLineStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.LineStyle.color"},{name:"sLineStylePattern",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.pattern"},{name:"fLineStyleThicknessIndex",type:"float",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thicknessIndex",defaultValue:1},{name:"cFillStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.FillStyle.color",defaultValue:new v.Color(3575492)},{name:"fOpacity",type:"float",JSONname:"PropertiesSection.GraphicProperties.FillStyle.opacity",defaultValue:.5},{name:"bVisible",type:"bool",JSONname:"PropertiesSection.GraphicProperties.visible",defaultValue:!0},{name:"bClippingPlaneVisible",type:"bool",JSONname:"PropertiesSection.GraphicProperties.clippingPlanesVisible"},{name:"sTargetIds",type:"listStrings",JSONname:"targetIds",defaultValue:[]},{name:"sDisplayPlaneMode",type:"string",JSONname:"PropertiesSection.DisplayPlaneMode",defaultValue:"Plane"},{name:"sDisplayContourMode",type:"string",JSONname:"PropertiesSection.DisplayContourMode",defaultValue:"Contour"},{name:"sSectionRender",type:"string",JSONname:"PropertiesSection.SectionRender",defaultValue:"CutOneSide"},{name:"bPartialClippingMode",type:"bool",JSONname:"PropertiesSection.PartialClippingMode"},{name:"sUpdateAndFreezeMode",type:"string",JSONname:"PropertiesSection.UpdateAndFreezeMode",defaultValue:"Update"},{name:"fXDirGridStep",type:"float",JSONname:"PropertiesSection.XDirGridStep"},{name:"fYDirGridStep",type:"float",JSONname:"PropertiesSection.YDirGridStep"},{name:"vTranslationValue",type:"float",JSONname:"PropertiesSection.TranslationValue",defaultValue:0},{name:"iGridAbsoluteMode",type:"int",JSONname:"PropertiesSection.GridAbsoluteMode",defaultValue:1},{name:"sLinkedObjectId",type:"string",JSONname:"linkedObjectId"},{name:"mRelativePosition",type:"Matrix4",JSONname:"relativePosition"},{name:"iCutUncutMode",type:"int",JSONname:"PropertiesSection.CutUncutMode"},{name:"bClipping",type:"bool",JSONname:"PropertiesSection.Clipping"},{name:"bClippingActiveState",type:"bool",JSONname:"PropertiesSection.ClippingActiveState"},{name:"fLineStyleThickness",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thickness"}];return t.extend({init:function(t){var I,U,B=t.viewer,L=t.expParent,k=t.typeApps,F=t.modeType,z=t.sectionEditCmd,G=t.context,W=t.clippingPrecisePosCmd,j=t.sType?t.sType:"Clipping",H=t.contextbarLib,X=t.propertiesLib,Y=t.nodeClass,J=this;if(this.storeyMode=t.isStoreyMode,this.csoList=t.csoList,this._parent(B,L),this._frmWindow&&(this._executionContext=this._frmWindow.getExecutionContext?this._frmWindow.getExecutionContext():this._frmWindow.getContextualUIManager&&this._frmWindow.getContextualUIManager()?this._frmWindow.getContextualUIManager()._executionContext:void 0),this.addParameters(E),G)this._context=G;else{var Z,q=C.getContextViewer({reviewContext:C.getReviewContext({viewer:B})});q&&(Z=q.getCommandContext()),this._context=Z||"Default"}this.setAttribute("sType",j),W&&(I=W),this._sectionObjectMode=F,this._tokenModelEvent=[],z?U=z:(U=n.getEditCmd(B))&&(U.isRunning()||U.isPaused())&&U.cancel(),J._typeApps=k,J.updateAppType=function(e){e&&(J._typeApps=e)},this._nSectionCurvesNode=new i,this._nSectionCurvesNode.getDMUType=function(){return J.getType()},this._nSectionCurvesNode.contourNode=!0;var Q=new i,K=!0,$=(new v.Matrix4).makeScale(10,0,0),ee=!0,te=[],ie=[],ne=[],oe=[],re=[],ae=!1,le=!1,se=null,ce=[],ue=null,pe=null,ge=!1,de=!0,ve=[];this._translationValue=0;var fe=!1;this._vTranslationValue=50;var me=H||"DS/DMUSection/DMUClippingContextualBar",Se=[],he=0;var Ce,ye=C.getContextViewer({reviewContext:C.getReviewContext({viewer:B})}),be=ye.subscribe({event:"onRepresentationLoaded"},function(){if(J.getAttribute("sLinkedObjectId")){var e=J.getAttribute("sLinkedObjectId");if(null!=e)e.length>0&&(!function(){if(J.getAttribute("sLinkedObjectId")&&J.getAttribute("mRelativePosition")){var e=J.getAttribute("sLinkedObjectId");if(null!=e&&e.length>0){var t=J.getAttribute("mRelativePosition"),i=new v.Matrix4;i.getInverse(t);var n=e[0],o=x.getAbsolutePositionMatrix(J,i,n);if(null!=o){var r={attribute:"mPlaneReferential",value:o.rotateX(Math.PI)};J.set(r),J.getNode().updateRobotPos(!0),J._viewer.render()}}}}(),ye.unsubscribe(be))}}),Me=function(){return s.isOOC(P,J._viewer)};function Pe(){let e=J.getBB();J._bSphere||(J._bSphere=c.computeBoundingSphere(J._viewer,ne,function(){return!0},function(){return C.getContextViewer({viewer:J._viewer})}));var t=new v.Vector3((e.max.x+e.min.x)/2,(e.max.y+e.min.y)/2,(e.max.z+e.min.z)/2),i=Math.ceil(Math.max(2*J._bSphere.radius,e.max.distanceTo(e.min))),n=J.getCenter(),o=-1,r=1,a=0,l=!1,s=J.getNormal().normalize();s=function(e){var t=e;if(t){var i=t.clone().normalize();i.x>.9995||i.y>.9995||i.z>.9995?t=i.negate():(-i.x>.9995||-i.y>.9995||-i.z>.9995)&&(t=i)}return t}(s),J._dotXNormal=s.clone().dot(new v.Vector3(1,0,0)),J._dotYNormal=s.clone().dot(new v.Vector3(0,1,0)),J._dotZNormal=s.clone().dot(new v.Vector3(0,0,1));var u,p=t.clone().projectOnVector(s.clone()),g=n.clone().projectOnVector(s.clone());J._vProjBoxCenterOnPlaneNormal=n.clone().add(p.clone().sub(g.clone())),J._centerNearPlane=(new v.Vector3).addVectors(J._vProjBoxCenterOnPlaneNormal,s.clone().multiplyScalar(.5*i)),J._centerFarPlane=(new v.Vector3).subVectors(J._vProjBoxCenterOnPlaneNormal,s.clone().multiplyScalar(.5*i));let d,f=J.getNode();if(f&&(d=f.getRobot()),d&&(u=d._getRulerOriginPos()),null==u&&(u=n.clone()),null!=u){var m=J._centerNearPlane.clone().distanceTo(n.clone()),S=J._centerFarPlane.clone().distanceTo(n.clone()),h=s.clone().negate(),y=u.clone().projectOnVector(s.clone()),b=(y=n.clone().add(y.clone().sub(g.clone()))).clone().sub(n.clone()),M=y.clone().sub(J._centerFarPlane.clone()),P=y.clone().sub(J._centerNearPlane.clone()),w=b.clone().normalize().dot(h.clone().normalize()),D=M.clone().normalize().dot(h.clone().normalize()),x=P.clone().normalize().dot(h.clone().normalize());a=n.clone().distanceTo(y.clone()),r=J._centerFarPlane.clone().distanceTo(y.clone()),o=J._centerNearPlane.clone().distanceTo(y.clone()),w>.9995&&(a=-a),D>.9995&&(r=-r),x>.9995&&(o=-o),Math.abs(m+S-i)<=.001||(m>S?(a=r,l=!0):m<S&&(a=o,l=!0))}return{value:a,minValue:o,maxValue:r,manipRange:i,bSectionPlaneOutOfmanipRange:l}}function we(e){if(void 0!==l.getValue(J,"vTranslationValue")){var t=D.convert(e,"length",h.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value,"mm");l.setValue(t,J,"vTranslationValue")}}function De(){if(!J.isSinglePlaneMode()||!J.isSectionDisplayed())return;var e=Pe();J.setTranslationValue(e.value,!1),J._movegauge&&(J._movegauge.unsubscribeToPrefChangeEvt(),J._movegauge.clean(),J._movegauge=null);let t=!1,i=C.getReviewContext({viewer:J._viewer});if(L){let e;if("DMUTemporaryBag"===L.getType())e=L.getDMUObjects("DMUCompare3D");else if(i){let t=i.getCurrentSessionMarkup();t.getCurrentSlide()&&(e=t.getCurrentSlide().getDMUObjects("DMUCompare3D"))}e&&e.length&&(t=!0)}if(!J.isConstructionItemMode()&&V.manipulation.getStatus()){J.clearOtherslider();var n=h.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value;J._movegauge=new o({iOwner:J,iReviewContext:i,frameWindow:J._frmWindow,runningApp:J._typeApps,initValue:e.value,initMinValue:e.minValue,initMaxValue:e.maxValue,initStepValue:V.manipulation.getIncrementValToSet(n),initManipRange:e.manipRange,onChangeSliderCB:we,onChangeSpinnerCB:we,notifyOutOfRange:e.bSectionPlaneOutOfmanipRange,hasCompareObject:t,viewType:"3dPlay"===J._typeApps||V.manipulation.isExploreView()?"ExploreView":"DetailedView"}),J._movegauge&&J._movegauge.subscribeToPrefChangeEvt&&J._movegauge.subscribeToPrefChangeEvt({event:"onPreferencesChanged",cb:Ce})}}function xe(e){null!==J._nSectionCurvesNode&&J._nSectionCurvesNode.removeChildren(),e||(null!==Q&&Q.removeChildren(),ae=!0),oe=[],re=[]}function Ve(){Se.length>0&&ve.length>0&&ve.forEach(function(e){e&&e.removeSectionCappingMaterial()}),ve=[],Se=[],le=!0,he=0}function Ae(e,t){var i;if(e.length>0&&t.length>0){var n=J.getAttribute("sLineStylePattern"),o=J.getAttribute("fLineStyleThickness");o||(o=J.getAttribute("fLineStyleThicknessIndex"));var r=a.createPolylines(e,t,o,n);(i=f.createMeshNode(r)).name=O.sectioncurves,i.measurable=!0}return i}function Ne(e,t){var i=Ae(e,t);i&&Q.add(i)}function Re(e,t,o){for(var r=[],a=[],l=e.aAllPolygons.length,s=J.getAttribute("cLineStyleColor"),c=J.isCustomColorSorce("Contour"),u=0;u<l;u++){var p=n.trimPolylines(e.aAllPolygons[u]._Polylines,o);p.length>0&&(r.push(p),a.push(c?s:e.aAllColors[u]),oe.push(p),re.push(c?s:e.aAllColors[u]))}!function(e,t,n){if(K||J.isSecondaryViewerShow()){var o=Ae(t,n);if(o){var r=new i;r.name=O.sectioncurves,r.measurable=!0,r.getDMUType=function(){return J.getType()},r.add(o),e&&r.setMatrix(e),J._nSectionCurvesNode.add(r)}J._nSectionCurvesNode.setVisibility(J._bIsInShowSpace)}J.isSecondaryViewerShow()&&Ne(t,n)}(t,r,a)}function _e(e){e?J.setSectionCurveUpdateStatus(!0):J.setSectionCurveUpdateStatus(!1),J.refreshNode(),J._viewer.render({forceDynamicMode:!0})}function Te(){var e=[],t=J.getAttribute("sTargetIds"),i=t.length,n=C.getReviewContext({viewer:J._viewer});if(n){var o=n.getCurrentSessionMarkup();if(o){var r=o.getAttribute("oLinksManager");if(r&&i>0)for(var a=0;a<i;a++){var l,s=r.getChildWithID(t[a]);s&&(l=r.getOccurrenceIdPath(s.path)),l&&e.push(l)}}}return e}if(this.cleanLockedInRAMNodes=function(){if(ce.length>0&&ue){for(var e=0;e<ce.length;e++)ue.unlockRepresentationMeshInRAM(ce[e]);ce=[]}},this.unsuscribeOnRepLoading=function(){se&&(pe&&pe.unsubscribe(se),se=null)},this.isSectionDisplayed=function(){return J.isVisible()&&J.getActiveFlag()&&J.isDisplayed()&&J.getAttribute("bVisible")},this.isSectionUpdateReq=function(){return(J.isTemporaryClipping()||J.isVisible())&&J.getActiveFlag()&&J.isDisplayed()&&J.getAttribute("bVisible")},this.isClippingPlaneVisible=function(){return!0===J.getAttribute("bClippingPlaneVisible")},this._cleanManipulationTool=function(){J._movegauge&&(J._movegauge.unsubscribeToPrefChangeEvt(),J._movegauge.clean(),J._movegauge=null)},J._buildManipulationTool=function(){J.isSectionDisplayed()&&(J._movegauge&&J._movegauge.getVisibleFlag()||(De(),J._movegauge&&J._movegauge.setVisibleFlag(!0)))},Ce=function(){J._movegauge&&J._movegauge.getVisibleFlag()&&(J._movegauge.unsubscribeToPrefChangeEvt(),J._movegauge.clean(),J._movegauge=null,De(),J._movegauge&&J._movegauge.setVisibleFlag(!0))},this.refreshSlider=function(){if(!J._movegauge||J._movegauge.bPerformRefreshOrCreate){if(fe=!0,J._movegauge){var e=Pe();J._movegauge.update({value:e.value,minValue:e.minValue,maxValue:e.maxValue,stepValue:localStorage.getItem("IncrementValue"),notifyOutOfRange:e.bSectionPlaneOutOfmanipRange}),J.setTranslationValue(e.value,!1),J._movegauge&&J._movegauge.setVisibleFlag(!0)}fe=!1}},this._viewer){var Oe;this._bIsInShowSpace=0!==this._viewer.getVisibleSpace();var Ee,Ie,Ue=function(e){Oe&&clearTimeout(Oe),Oe=setTimeout(function(){if(Oe=null,J._bBox=null,J._bSphere=null,!J||!J._viewer||!J.isSectionDisplayed())return;J._bUpdateOnModelChange=!0;let t=J.getNode();if(t&&J.isConstructionItemMode()&&e&&n.getRootsForClipping(J._viewer).length){let e,o,r=n.getBuildingRootData(J._viewer,void 0,!0),a=!1,l=!1;if(pe||(pe=C.getContextViewer({viewer:J._viewer})),r)for(var i=0;i<r.length;i++)if(a||r[i]&&r[i].ID&&(a=!0,e=r[i]),(o=T.getStoreyInfo(r[i]?r[i].ID:void 0,pe))&&o.length){l=!0;break}if(!a||!l)if(a){if(!l){T.clearStoreyNavigratorController({context:pe});let i=e=>{let t=e.GetPosition3D();J.updateClippingPosAndOrientation(t),n.setStoreyinfoOnSlide(J._viewer,e.GetCurrentStorey()),J.manageNavigatorEdition(),J._viewer.render()},o=()=>{if(localStorage.setItem("DMUClippingBoxMode","NormalMode"),J.setAttribute("sPlaneBoxMode","NormalMode"),t){let e=t.getRobot();e||(t.initClippingRobot(),e=t.getRobot()),e&&e.updateRobotPos()}J.refreshNode(),J._viewer.render()};J._storeyNavigatorcntroller=T.getDMUStoreyNavigratorController({context:pe,getBuidlingRootID:()=>e?r.ID:void 0,storyeRetrivalSuccessCB:i,storyeRetrivalFailCB:o})}}else J.resetToNormalMode(t)}t.resetClippingFlag(),J.refreshNode(),J._viewer.render(),J._bUpdateOnModelChange=void 0},100)},Be=C.giveEventsController({viewer:this._viewer});if(Be&&!this._tokenModelEvent.length)Ie=Be.addEvent(m.Events.EXPRootModifiedEvent,function(){Ue(!0)}),this._tokenModelEvent.push(Ie),Ie=Be.addEvent(m.Events.EXPMoveEvent,Ue),this._tokenModelEvent.push(Ie),Ie=Be.addEvent(m.Events.EXPHideShowEvent,Ue),this._tokenModelEvent.push(Ie),Ie=Be.addEvent(m.Events.EXPModelUpdatedEvent,Ue),this._tokenModelEvent.push(Ie),Ie=Be.addEvent(m.Events.EXPLineLayoutComputationBeginEvent,function(){J.isSectionDisplayed()&&(Ee=J.isVisible(),J.setVisibleFlag(!1,!1,!0),J.refreshNode(),J._viewer.render())}),this._tokenModelEvent.push(Ie),Ie=Be.addEvent(m.Events.EXPLineLayoutComputationEndEvent,function(){"boolean"==typeof Ee&&(J.setVisibleFlag(Ee,!1,!0),Ee=void 0,Ue())}),this._tokenModelEvent.push(Ie),Me()||(Ie=Be.addEvent(m.Events.EXPStartProgressiveLoad,function(){xe(),Ve(),J._bLoadingInProgress=!0,_e(!1),J._bPreviousLoadingInProgress=!0}),this._tokenModelEvent.push(Ie),Ie=Be.addEvent(m.Events.EXPEndProgressiveLoad,function(){J._bLoadingInProgress=!1,_e(!0),J._bPreviousLoadingInProgress=!1}),this._tokenModelEvent.push(Ie));if(!J._tokenOnPimCtrlOpacityChange){require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(e){pe||(pe=C.getContextViewer({viewer:J._viewer})),J._pimCtrl=e.giveItfCtrl({pad3DViewer:pe}),J._pimCtrl&&(J.itfZeroOpacityflag=!0,J._tokenOnPimCtrlOpacityChange=J._pimCtrl.subscribe("onOpacityChange",function(e){e.data&&(0===e.data.oldValue&&0!==e.data.newValue||0!==e.data.oldValue&&0===e.data.newValue)&&(0===e.data.newValue?J.itfZeroOpacityflag=!0:J.itfZeroOpacityflag=!1,Ue())}))})}var Le=S.getDMUMarkupsController({context:this._viewer,frmWindow:this._frmWindow});Le&&Le.registerMarker(this)}this.initAuthoringData=function(){-1!==C.getAuthoringFeatureTypes().indexOf("Section")&&(-1===C.getAuthoringFeatureTypes().indexOf("Section")||J.getContextualCommandList||require([me],function(e){var t=new e;J.getContextualCommandList=t.getContextualCommandList,J.getSharedContextualCommandList=t.getSharedContextualCommandList,J.getSharedHeaderTypes=t.getSharedHeaderTypes,t.setCheckCmdHdrState&&(J.setCheckCmdHdrState=t.setCheckCmdHdrState),t.applyStateToContextHdr&&(J.applyStateToContextHdr=t.applyStateToContextHdr),"ProgressiveVisuLoading"!==J._typeApps&&(J.getSharedContextualMenuCommandList=t.getSharedContextualMenuCommandList,J.getContextualMenuCommandList=t.getContextualMenuCommandList),t.register({frmWindow:J._frmWindow,type:J.getType()});var i=1===y.get().length?y.get()[0].pathElement.clone():null;i&&i.getLastElement(!0).getDMUType&&(i.getLastElement(!0)===J.getNode()||i.getLastElement(!0)===J._nSectionCurvesNode)&&(y.empty(),y.add({pathElement:i}))}),J.getPropertiesObject||"ProgressiveVisuLoading"===J._typeApps||require([X||"DS/DMUSection/DMUClippingProperties"],function(e){var t=new e(J);J.getPropertiesObject=function(){return t}}))},this.removeAuthoringData=function(){-1!==C.getAuthoringFeatureTypes().indexOf("Section")&&-1!==C.getAuthoringFeatureTypes().indexOf("Section")&&require([me],function(e){var t=new e;J.getContextualCommandList=null,J.getSharedContextualCommandList=null,J.getSharedHeaderTypes=null,J.getSharedContextualMenuCommandList=null,J.getContextualMenuCommandList=null,J.setCheckCmdHdrState=null,J.applyStateToContextHdr=null,t.unregister({frmWindow:J._frmWindow})})};var ke=new M(J);this.importData=ke.importData,this.afterImport=ke.afterImport,this.initAuthoringData(),this.getDMUObjectFromPathElement=function(e){if(e)for(var t=e.clone();t;){if(t.getLastElement(!0)===J.getNode())return J;t=t.getParentPath()}};var Fe=!1;this.getDoNotEndEditCmdState=function(){return Fe},this._startEditCommand=function(){if(I)J.removeCurvesAndHatching(),I.begin(),I=void 0;else{if(U=n.getEditCmd(J._viewer)){var e=J.getNode();if(e){let t,i=e.getRobot();i&&(t=i._getRulerOriginPos()),e.initClippingRobot(t)}}"DMUClipping"===this.getType()&&(J._movegauge?this.refreshSlider():De())}},this._endEditCommand=function(){if(U=n.getEditCmd(this._viewer),this.getDoNotEndEditCmdState()||!U||U.isEnding&&U.isEnding()||!U.isRunning()&&!U.isPaused())this.getDoNotEndEditCmdState()&&(Fe=!1);else{n.cleanClippingVisu(this._viewer);var e=J.getNode();e&&e.setRobot(null)}};var ze=this.setReadOnly;function Ge(){let e=n.getEditCmd(J._viewer);e&&(e.isRunning()||e.isPaused())&&e.cancel()}this.setReadOnly=function(e,t){var i=Boolean(t);ze(e,i),J.getNode()&&J.getNode().update(!0),this.setStoreyNavigatorEditionState(!e)};let We=this.setDisplayedFlag;this.setDisplayedFlag=function(e){let t=J.isConstructionItemMode(),i=t?this._storeyNavigatorcntroller:void 0;t&&!i&&(i=T.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})}),this._storeyNavigatorcntroller=i),e?i&&(i.ShowStoreyNavigator(),this.isReadOnly()||this.manageNavigatorEdition(!0)):(i&&i.HideStoreyNavigator(),this.isInEdition()&&Ge()),We(e)};let je=this.setVisibleFlag;this.setVisibleFlag=function(e,t,i){i||(!e&&this.isInEdition()?Ge():(this.manageNavigatorEdition(),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.ShowStoreyNavigator())),je(e,t)},this.removeCurvesAndHatching=function(){xe(),Ve(),this.cleanLockedInRAMNodes(),this.unsuscribeOnRepLoading()},this.manageCurvesAndHatching=function(t){if(!J._posCmdActive&&(J.promiseToResolve&&J.promiseToResolve.length&&(J.promiseToResolve.forEach(e=>{e("CancelOnDemand")}),J.promiseToResolve=[]),J._bClipping||"DMUSection"!==J.getType()||!this.isReadOnly()||"BoxMode"!==J.getAttribute("sPlaneBoxMode")||"OnlyContour"===J.getAttribute("sSectionRender"))){Me()||(xe(),Ve());var i,o=J.getAttribute("mPlaneReferential");"BoxMode"===J.getAttribute("sPlaneBoxMode")&&(i=new v.Box2);var r=J.getAttribute("fXDirSize"),a=J.getAttribute("fYDirSize"),l=J.getAttribute("bHatchingDisplay"),c=t.computeCurves;if(i&&i.set(new v.Vector2(-r/2,-a/2),new v.Vector2(r/2,a/2)),c&&ee&&J.isSectionDisplayed()&&(K||J.isSecondaryViewerShow())||J.isSectionDisplayed()&&l&&de&&J.isHatchingUpdateNeeded()){J.removeCurvesAndHatching(),$=o.clone(),ae=!1,le=!1;var u=function(e,c){var u=[],p=[];if(J._bIsInShowSpace?e.forEach(function(e){e&&e.getLastElement&&!s.isOOCTileSetNode(e.getLastElement(!0))&&u.push(e)}):c.forEach(function(e){e&&e.getLastElement&&!s.isOOCTileSetNode(e.getLastElement(!0))&&p.push(e)}),J._bIsInShowSpace&&u.length>0||!J._bIsInShowSpace&&p.length>0){if(t.computeCurves&&ee&&J.isSectionDisplayed()&&(K||J.isSecondaryViewerShow())){var g=o;if(Re(n.computeSectionCurvesUsingPolyPlanarOperator(J._viewer,g,J._bIsInShowSpace?u:p),g,i),"SliceMode"!==J.getAttribute("sPlaneBoxMode")&&"BoxMode"!==J.getAttribute("sPlaneBoxMode")||(g=J._getPlanReferential("Back"),Re(n.computeSectionCurvesUsingPolyPlanarOperator(J._viewer,g,J._bIsInShowSpace?u:p),g,i)),"BoxMode"===J.getAttribute("sPlaneBoxMode")){var d=J.getAttribute("fSliceOffset");i&&i.set(new v.Vector2(-r/2,-d/2),new v.Vector2(r/2,d/2)),g=J._getPlanReferential("Top"),Re(n.computeSectionCurvesUsingPolyPlanarOperator(J._viewer,g,J._bIsInShowSpace?u:p),g,i),g=J._getPlanReferential("Bottom"),Re(n.computeSectionCurvesUsingPolyPlanarOperator(J._viewer,g,J._bIsInShowSpace?u:p),g,i),i&&i.set(new v.Vector3(-d/2,-a/2,0),new v.Vector3(d/2,a/2,0)),g=J._getPlanReferential("Right"),Re(n.computeSectionCurvesUsingPolyPlanarOperator(J._viewer,g,J._bIsInShowSpace?u:p),g,i),g=J._getPlanReferential("Left"),Re(n.computeSectionCurvesUsingPolyPlanarOperator(J._viewer,g,J._bIsInShowSpace?u:p),g,i)}t.action&&t.action(),J._viewer.render({forceDynamicMode:!0})}var f="Single"===J.getAttribute("sHatchingAnglesMode");J.isSectionDisplayed()&&l&&de&&function(e){var t=J.getAttribute("cHatchingColor")?J.getAttribute("cHatchingColor").getHexString():void 0,i=J.getAttribute("fHatchingLineStyleThickness"),n=J.getAttribute("fHatchingSingleAngleValue"),o=J.getAttribute("fHatchingPitchValue")?J.getAttribute("fHatchingPitchValue")*window.devicePixelRatio:void 0,r=void 0;if(J.isCustomColorSorce("Capping")&&(r=J.getAttribute("cCappingColor")),e.cutObjects&&e.cutObjects.length>0){var a;if(0===Se.length)if("Single"===e.anglesMode)a=new v.ScreenSizeHatchingMeshMaterial({stripesDirection:new v.Vector2(Math.cos(n),Math.sin(n)),stripesColor:"#"+t,stripesWidth:i,spaceColor:r,autoSpaceColor:void 0===r,spaceWidth:o*window.devicePixelRatio}),Se.push(a);else if("Various"===e.anglesMode){let e=[30*Math.PI/180,-30*Math.PI/180,60*Math.PI/180,-60*Math.PI/180];for(let n=0;n<e.length;n++)a=new v.ScreenSizeHatchingMeshMaterial({stripesDirection:new v.Vector2(Math.cos(e[n]),Math.sin(e[n])),stripesColor:"#"+t,stripesWidth:i,spaceColor:r,autoSpaceColor:void 0===r,spaceWidth:o}),Se.push(a)}if(1===Se.length)e.cutObjects.forEach(function(e){if(e){var t=e.getLastElement();t&&-1===ve.indexOf(t)&&(t.setSectionCappingMaterial(Se[0]),ve.push(t))}});else if(4===Se.length)for(let t=0;t<e.cutObjects.length;t++){var l=e.cutObjects[t];if(l){var s=l.getLastElement();s&&-1===ve.indexOf(s)&&(s.setSectionCappingMaterial(Se[he%4]),he++,ve.push(s))}}J._viewer.render({forceDynamicMode:!0})}}({cutObjects:J._bIsInShowSpace?u:p,anglesMode:f?"Single":"Various"})}},p=!1;if(Me()&&(p=!0),p){if(pe||(pe=C.getContextViewer({viewer:J._viewer})),ue||pe&&(ue=pe.getController()),ue&&pe){var g=s.getRootReferences(J._viewer,!0),d=[],f=[],m=t=>{if(!t||!t.root||!t.cuttingPlane&&!t.cuttingBox)return;let i=t.root,n=t.cuttingPlane,o=t.cuttingBox,r=Boolean(t.computeCurves),a=ue.getRootStats(i.getModelIdentification());a&&a.initialPathes&&a.initialPathes.length&&a.initialPathes.forEach(t=>{f.push(ue.completeSessionWithClippingOperatorCandidates({path:e.clone(t),sectionPlane:n,box:o,meshInRAM:r}))})};if(J.isSinglePlaneMode()){var S=J.getCenter(),h=J.getUDirection(),y=J.getVDirection(),b={origin:[S.x.toString(),S.y.toString(),S.z.toString()],u_direction:[h.x.toString(),h.y.toString(),h.z.toString()],v_direction:[y.x.toString(),y.y.toString(),y.z.toString()]};if(g.length>0)for(var M=0;M<g.length;M++)m({root:g[M],cuttingPlane:b,computeCurves:c})}if("SliceMode"===J.getAttribute("sPlaneBoxMode")){var P=J.getCenter(),D=J.getUDirection(),x=J.getVDirection(),V={origin:[P.x.toString(),P.y.toString(),P.z.toString()],u_direction:[D.x.toString(),D.y.toString(),D.z.toString()],v_direction:[x.x.toString(),x.y.toString(),x.z.toString()]},A=J.getCenter(J._getPlanReferential("Back")),N=J.getUDirection(J._getPlanReferential("Back")),R=J.getVDirection(J._getPlanReferential("Back")),_={origin:[A.x.toString(),A.y.toString(),A.z.toString()],u_direction:[N.x.toString(),N.y.toString(),N.z.toString()],v_direction:[R.x.toString(),R.y.toString(),R.z.toString()]};if(g.length>0)for(var T=0;T<g.length;T++)m({root:g[T],cuttingPlane:V,computeCurves:c}),m({root:g[T],cuttingPlane:_,computeCurves:c})}else if("BoxMode"===J.getAttribute("sPlaneBoxMode")){var E=J.getAttribute("fSliceOffset"),I=new v.Vector3(a,r,E),U=(new v.Matrix4).copy(o);U.rotateZ(-Math.PI/2),U.translate(new v.Vector3(-a/2,-r/2,0));var B=[U.elements[0],U.elements[1],U.elements[2],U.elements[4],U.elements[5],U.elements[6],U.elements[8],U.elements[9],U.elements[10],U.elements[12],U.elements[13],U.elements[14]],L={corner_min:[0,0,0],corner_max:[I.x,I.y,I.z],transformation_matrix:B,intersection_mode:"across"};if(g.length>0)for(var k=0;k<g.length;k++)m({root:g[k],cuttingBox:L,computeCurves:c})}var F=function(e){if(J.promiseToResolve=[],e.length>0){e.forEach(function(e){if(e.selectedPaths.length>0){var t=Te();e.selectedPaths.forEach(function(e){var i=e.length;if(t.length>0){for(var n=!1,o=0;o<t.length;o++){var r=t[o],a=r.length;if(a<i)for(var l=0;l<a;l++){if(r[l]!==e[l]){n=!1;break}n=!0}if(n)break}n&&d.push(e)}i>0&&c&&ce.push(e[i-1])}),t.length>0?d.push.apply(d,t):d.push.apply(d,e.selectedPaths)}}),se||(se=pe.subscribe({event:"onRepresentationLoaded"},function(e){if(c&&ue.hasMeshInRAM(e)||l&&!c){for(var t=[],i=0;i<d.length;i++)-1!==d[i].indexOf(e)&&t.push(ue.buildPathFromArray(d[i]));if(t.length>0){for(var n=[],o=[],r=0;r<t.length;r++)s.parseForLeafNodes(t[r],J._viewer,n,o,Boolean(J.itfZeroOpacityflag));u(n,o)}}}));for(var t=[],i=[],n=0;n<d.length;n++){var o=d[n][d[n].length-1];if(ue.isReferenceComplete(o)&&(c&&ue.hasMeshInRAM(o)||l&&!c)){var r=ue.buildPathFromArray(d[n]);s.parseForLeafNodes(r,J._viewer,t,i,Boolean(J.itfZeroOpacityflag))}}u(t,i)}},z=function(){w&&w.displayNotification({eventID:"warning",msg:O.notifyComputeContourfailure}),J.unsuscribeOnRepLoading(),xe(),Ve(),ae=!1};J.isConstructionItemMode()?f.forEach(e=>{Promise.race([e,new Promise(e=>{J.promiseToResolve||(J.promiseToResolve=[]),J.promiseToResolve.push(e)})]).then(function(e){"string"!=typeof e&&F([e])},function(){J.promiseToResolve=[],z()})}):Promise.all(f).then(function(e){F(e)},function(){z()})}}else J.collectCutObjects(),u(te,ie)}}},this._getPlanReferential=function(e){var t=new v.Matrix4;if(J.getAttribute("mPlaneReferential")&&(t=t.copy(J.getAttribute("mPlaneReferential")),e)){var i=J.getAttribute("fSliceOffset");"Back"===e?(t.rotateX(Math.PI),t.translate(new v.Vector3(0,0,-i))):"Top"===e?(t.rotateX(-Math.PI/2),t.translate(new v.Vector3(0,-i/2,-J.getAttribute("fYDirSize")/2))):"Bottom"===e?(t.rotateX(Math.PI/2),t.translate(new v.Vector3(0,i/2,-J.getAttribute("fYDirSize")/2))):"Left"===e?(t.rotateY(Math.PI/2),t.translate(new v.Vector3(-i/2,0,-J.getAttribute("fXDirSize")/2))):"Right"===e&&(t.rotateY(-Math.PI/2),t.translate(new v.Vector3(i/2,0,-J.getAttribute("fXDirSize")/2)))}return t},this.isSectionCurveComputationNeeded=function(){var e=!1;if(!J._bLoadingInProgress)if(J._bUpdateOnModelChange)e=J._bUpdateOnModelChange;else{var t=J.getAttribute("mPlaneReferential");J.isSectionDisplayed()&&(ae||!p.areMatrixEqual($.elements,t.elements)||J._bPreviousLoadingInProgress)&&(e=!0)}return e},this.isHatchingUpdateNeeded=function(){var e=!1;if(!J._bLoadingInProgress)if(J._bUpdateOnModelChange)e=J._bUpdateOnModelChange;else{var t=J.getAttribute("mPlaneReferential");J.isSectionDisplayed()&&(le||!p.areMatrixEqual($.elements,t.elements)||J._bPreviousLoadingInProgress)&&(e=!0)}return e},this.isSecondaryViewerShow=function(){return J._iViewerSecondaryWindow&&J._iViewerSecondaryWindow.isShow()};var He=!1,Xe=!1;this.isManipulationOnGo=function(){return He||J._posCmdActive},this.beginManipulation=function(){He=!0,Xe=!1,de=!1,this.getAttribute("bHatchingDisplay")&&this.getNode().isClippingEnabled()&&(this.getNode().enableClipping(!1),Ve(),this.getNode().enableClipping(!0)),J.isSecondaryViewerShow()||(ee=!1),ee||J._viewer.picking.primitive&&J.getAttribute("bSectionCurvesVisible")&&J._viewer.setRenderMode("SectionLine",!0),ge=!1,J._movegauge&&J.refreshSlider?J.refreshSlider():De()},this.doManipulation=function(e){He=!0,Xe=!0,Me()&&(ee=!1,xe(!0),this.cleanLockedInRAMNodes()),void 0===e&&_e(!1),J.updatePosToStoreyNavigator(),J._viewer.render({forceDynamicMode:!0}),J._movegauge&&J.refreshSlider?J.refreshSlider():De()},this.addOrRemoveFromCSO=function(e){var t={pathElement:s.buildPathElement(J.getNode())};y.isIn(t)?e||y.remove(t):e&&y.add(t)},this.endManipulation=function(e,t){if(ee=!0,de=!0,J.updatePosToStoreyNavigator(),!ge){var i={pathElement:s.buildPathElement(J.getNode())};e&&e.from&&(Fe=!0,!e||e&&!e.from[0].event.ctrlKey?(y.empty(),y.add(i)):y.isIn(i)?y.remove(i):y.add(i),Fe&&(Fe=!1))}if(t)return!0;_e(!0),J._viewer.picking.primitive&&J._viewer.setRenderMode("SectionLine",!1),J._movegauge&&J.refreshSlider?J.refreshSlider():De(),He=!1,Xe&&J.fireEvent("onDMUObjectAttributeModified",{dmuObject:J}),Xe=!1,J.fireEvent("onEndSectionManipulation",{dmuObject:J})},this.onLongHold=function(){ge=!0},this.setObjects=function(e,t){if(e&&e.length>0){ne||(ne=[]);var i=e.length,o=J.getParent();if(o&&o.getOccurence){for(var r,a,l=J.getAttribute("sTargetIds"),c=0;c<i;c++)if(r=o.getOccurence({pathElement:e[c]},!0))if((a=l.indexOf(r.id))>=0){var u=l.slice(0,a),p=l.slice(a+1);l=u.concat(p);var g=ne.slice(0,a),d=ne.slice(a+1);ne=g.concat(d)}else l.push(r.id),ne.push(e[c]);J.setAttribute("sTargetIds",l)}if(!t){var v=s.computeBoundingBox(J._viewer,ne),f=Math.max(v.max.x-v.min.x,v.max.y-v.min.y,v.max.z-v.min.z),m=n.computeSectionPlaneReferencial(J._viewer,v);J.getNode()&&J.getNode().resetClippingFlag(),J.setAttribute("fXDirSize",f),J.setAttribute("fYDirSize",f),J.modifyPlaneReferential(m),J.getNode()&&J.getNode().updateRobotPos(!0)}}},this.collectCutObjects=function(){var e=[],t=!1,i=1;if(0===te.length&&0===ie.length){var n=C.getContextViewer({viewer:J._viewer});if(Me())(e=Te())&&e.length>0&&(t=!0,void 0!==J.getAttribute("iCutUncutMode")&&(i=J.getAttribute("iCutUncutMode")));else{var o=function(){if(!ne||0===ne.length){ne=[];var e=J.getAttribute("sTargetIds"),t=e.length,i=C.getReviewContext({viewer:J._viewer});if(i){var n=i.getCurrentSessionMarkup();if(n){var o=n.getAttribute("oLinksManager");if(o&&t>0)for(var r,a=0;a<t;a++)(r=o.getOccurrencePathElement(e[a]))&&ne.push(r)}}}return ne}();if(o&&o.length>0){t=!0;for(var r=o.length,a=0;a<r;a++)s.parseForLeafNodes(o[a],J._viewer,te,ie,Boolean(J.itfZeroOpacityflag))}else s.parseForLeafNodesOfScene(n,te,ie,Boolean(J.itfZeroOpacityflag))}}return t||(t=ne&&ne.length>0),{CutObjects:te,NoCutObjects:ie,CutObjectsOOC:e,bIsPartial:t,cutUncutMode:i}},this.onViewerEventCB=function(e){var t=!0,i=C.getReviewContext({viewer:this._viewer});if(i&&(!i.isVisible()||i.getCurrentSessionMarkup()&&!i.getCurrentSessionMarkup().isVisible())&&(t=!1),t){J.getNode()&&J.getNode().onViewerEventCB&&J.getNode().onViewerEventCB(e);var n=0!==J._viewer.getVisibleSpace();if("beginExplodeCmd"===e.eventType){J._bIsInShowSpace===n&&J.setVisibleFlag(!1,!1,!0);var o={pathElement:s.buildPathElement(J.getNode())};y.isIn(o)?y.remove(o):(o={pathElement:s.buildPathElement(J._nSectionCurvesNode)},y.isIn(o)&&y.remove(o)),J.refreshNode(),J.getNode().enableClipping(!1),J._viewer.setSectionCapping(!1)}else"endExplodeCmd"===e.eventType&&(J._bIsInShowSpace===n&&J.setVisibleFlag(!0,!1,!0),J.refreshNode(),J.getNode().enableClipping(!0),J._viewer.setSectionCapping(!0))}},this.setSectionCurveUpdateStatus=function(e){K=e};var Ye=this.refreshNode;this.refreshNode=function(e){if(J.getNode()&&(!L.isImporting||L.isImporting&&!L.isImporting())){te=[],ie=[];var t=J.isSectionDisplayed();J.getNode().update(e),J._viewer.render({forceDynamicMode:!0}),!t&&J._iViewerSecondaryWindow&&J._iViewerSecondaryWindow.clear(),Ye()}},this.manageLock=function(e){var t,i=!1;if(L&&"DMUTemporaryBag"===L.getType()&&(i=!0),i)t="boolean"==typeof e?e:!!this._viewer._lockUnlockCmd&&this._viewer._lockUnlockCmd.getState();else{var n=!this._bClippingPlaneVisible;J.getNode()&&(t=!J.isInEdition()&&n)}J.getNode()&&J.getNode().manageLock(t)},this.sectionToXYZ=function(e){let t=J.getAttribute("sPlaneBoxMode");"BoxMode"!==t&&(e=this.updateClippingSize(e)),J.modifyPlaneReferential(e),J.getNode()&&J.getNode().updateRobotPos(!0),J._viewer.render({forceDynamicMode:!0}),J._movegauge&&J.refreshSlider?J.refreshSlider():De(),"BoxMode"===t&&J.fireEvent("onDMUObjectAttributeModified",{dmuObject:J}),J.fireEvent("onEndSectionManipulation",{dmuObject:J})},this.updateClippingSize=function(e){var t=e,i=this.getBB(),n=g.computePlaneDim(i,e,!1,!1,!0);if(n){if(n.fPlaneSizeV&&n.fPlaneSizeU){var o=n.fPlaneSizeU,r=n.fPlaneSizeV;J.setAttribute("fXDirSize",o),J.setAttribute("fYDirSize",r),J.setAttribute("fXDirGridStep",o/20),J.setAttribute("fYDirGridStep",r/20)}n.plane&&(t=n.plane)}return t},this.sectionToX=function(e){e&&J.getNode().clearAllRulers();var t=J.getClippingCenter(),i=(new v.Matrix4).rotateY(-Math.PI/2).setPosition(t);i.setPosition(J.getPlaneCenter(i)),J.sectionToXYZ(i)},this.sectionToY=function(e){e&&J.getNode().clearAllRulers();var t=J.getClippingCenter(),i=(new v.Matrix4).rotateX(Math.PI/2).setPosition(t);i.setPosition(J.getPlaneCenter(i)),J.sectionToXYZ(i)},this.sectionToZ=function(e,t,i){i&&J.getNode().clearAllRulers();var n=J.getClippingCenter(),o=(new v.Matrix4).rotateY(Math.PI).setPosition(n);o.setPosition(e?t||new v.Vector3(0,0,0):J.getPlaneCenter(o)),J.sectionToXYZ(o)},this.sectionFlip=function(e){e&&J.getNode().clearAllRulers();var t={attribute:"mPlaneReferential",value:J.getAttribute("mPlaneReferential").rotateX(Math.PI)};J.set(t),J.getNode()&&J.getNode().updateRobotPos(!0),J.refreshNode(),J._viewer.render(),J._movegauge&&J.refreshSlider?J.refreshSlider():De(),this.updatePosToStoreyNavigator(),"BoxMode"===J.getAttribute("sPlaneBoxMode")&&J.fireEvent("onDMUObjectAttributeModified",{dmuObject:J}),J.fireEvent("onEndSectionManipulation",{dmuObject:J})},this.sectionViewpoint=function(){J.getNode().clearAllRulers();var e=J.getAttribute("mPlaneReferential"),t=1.5*J.getAttribute("fXDirSize"),i=e.decompose(),n=i[0],o=i[1],a=new v.Vector3(1,0,0).applyQuaternion(o),l=new v.Vector3(0,1,0).applyQuaternion(o),s=new v.Vector3(0,0,1).applyQuaternion(o),c=a.dot(new v.Vector3(0,0,1)),p=l.dot(new v.Vector3(0,0,1)),g=Math.abs(c),d=Math.abs(p),f=a;if(u.isZero(g)&&u.isZero(d)){var m=r.getViewpointInfo(J._viewer.currentViewpoint),S=a.dot(m.sight),h=l.dot(m.sight),C=Math.abs(S),y=Math.abs(h);u.isLessOrEqual(y,C)?u.isLessOrEqual(C,y)||(f=a.multiplyScalar(u.isLessThan(S,0)?-1:1)):f=l.multiplyScalar(u.isLessThan(h,0)?-1:1)}else u.isLessOrEqual(d,g)?u.isLessOrEqual(g,d)||(f=a.multiplyScalar(u.isLessThan(c,0)?-1:1)):f=l.multiplyScalar(u.isLessThan(p,0)?-1:1);r.moveViewpoint({freeZoneSize:J._frmWindow.getImmersiveFrame().getFreeZone().getBoundingClientRect(),viewerSize:{width:J._frmWindow.getViewer().SCREEN_WIDTH,height:J._frmWindow.getViewer().SCREEN_HEIGHT},viewpoint:J._viewer.currentViewpoint,target:n,sightDirection:s,upDirection:f,targetDistance:t,duration:400}),J.getNode()&&J.getNode().updateRobotPos(!0)},this.sectionCut=function(e){J.getNode().clearAllRulers();var t=e;l.setValue(t,J,"sSectionRender")},this.sectionGrid=function(){var e;J.getNode().clearAllRulers(),e="Plane"===l.getValue(J,"sDisplayPlaneMode")?"Grid":"Plane",l.setValue(e,J,"sDisplayPlaneMode")},this.sectionSlice=function(){J.getNode().clearAllRulers();l.setValue("SliceMode",J,"sPlaneBoxMode"),l.setValue(20,J,"fSliceOffset")},this.getTranslationValue=function(){return J._translationValue},this.setTranslationValue=function(e,t){if(!1===t||!0===fe)J._translationValue=e;else{var i=J.getCenter(),n=J.getNormal();n=function(e){var t=e;if(t){var i=t.clone().normalize();i.x>.9995||i.y>.9995||i.z>.9995?t=i.negate():(-i.x>.9995||-i.y>.9995||-i.z>.9995)&&(t=i)}return t}(n);var o=i.clone(),r=J._centerNearPlane.distanceTo(J._centerFarPlane),a=J._centerNearPlane.distanceTo(i.clone()),l=J._centerFarPlane.distanceTo(i.clone());if(Math.abs(a+l-r)<=.001){var s=J.getTranslationValue();o=i.clone().add(n.clone().normalize().multiplyScalar(s-e))}else{var c=J.getTranslationValue();a<l?o=J._centerNearPlane.clone().add(n.clone().normalize().multiplyScalar(c-e)):a>l&&(o=J._centerFarPlane.clone().add(n.clone().normalize().multiplyScalar(c-e)))}J._translationValue=e;var u=J.getAttribute("mPlaneReferential");u.setPosition(o),J.modifyPlaneReferential(u),J.getNode().updateRobotPos(!0),J._viewer.render({forceDynamicMode:!0})}},this.modifyPlaneReferential=function(e){if(e){var t={attribute:"mPlaneReferential",value:J.getAttribute("mPlaneReferential").copy(e)};J.set(t),J.getNode().update()}},this.getCenter=function(e){var t=e||J.getAttribute("mPlaneReferential");return(new v.Vector3).getPositionFromMatrix(t)},this.getClippingCenter=function(){var e=J.getAttribute("mPlaneReferential"),t=(new v.Vector3).getPositionFromMatrix(e),i=J.getAttribute("sPlaneBoxMode");if("BoxMode"===i||"SliceMode"===i){var n=J.getNode();if(n&&n.getCenter)t=n.getCenter();else{var o=J.getAttribute("fSliceOffset");if(!isNaN(o)){var r=e.decompose(),a=new v.Vector3(0,0,1).applyQuaternion(r[1]);a=a.normalize().multiplyScalar(o/2),t=t.add(a)}}}return t},this.getPlaneCenter=function(e){return n.computePlaneCenter(e,this.getAttribute("fSliceOffset"),!this.isSinglePlaneMode())},this.getNormal=function(e){var t=(e||J.getAttribute("mPlaneReferential")).decompose();return new v.Vector3(0,0,1).applyQuaternion(t[1])},this.computePlaneRef=function(e,t,i){let n=e;var o;n||(n=this.getNormal().negate().normalize());var r=!1;if(i&&n){let e=n.angleTo(this.getNormal().normalize());(u.isZero(e)||u.isZero(Math.PI-e))&&(r=!0)}var a=n.negate().normalize(),l=this.getBB();let c=t&&!r?t:this.getClippingCenter();if(l){let e=l.center();if(e&&a&&c){let t=d.computePointLineDistance(c.toArray(),e.toArray(),a.toArray()).aPosition;t&&(c=new v.Vector3(t[0],t[1],t[2]))}}var p=s.getXYAxisDirFromZ(a.clone());return p.xDir&&p.yDir&&(o=(new v.Matrix4).makeBasis(p.xDir,p.yDir,a)).setPosition(c),o},this.getUDirection=function(e){var t=(e||J.getAttribute("mPlaneReferential")).decompose();return new v.Vector3(1,0,0).applyQuaternion(t[1])},this.getVDirection=function(e){var t=(e||J.getAttribute("mPlaneReferential")).decompose();return new v.Vector3(0,1,0).applyQuaternion(t[1])},this.renderSecondaryViewer=function(){J._iViewerSecondaryWindow&&J._iViewerSecondaryWindow.render()},this.getSectionCurvesFor2DViwer=function(){return oe.length>0&&Ne(oe,re),Q},this.getSectionCurveNode=function(){return J._nSectionCurvesNode},this.removeSectionCurve=function(){xe()},this.setNode(Y?new Y(this):new b(this)),this.displayWarning=function(e,t){var i=J._frmWindow,n=e,o=t;J.warningPanel&&J.warningPanel.destroy(),J.warningPanel=new R({title:O.warningDlg.title,message:O.warningDlg.message,checkboxMessage:null,checked:!0,frmWindow:i,callbacks:{onValidateCB:async function(){let e=n.getAttribute?{}:n;n.getAttribute&&(e=await N.getObjectDefinition(n));let t=new A({viewer:i.getViewer(),experience:o});J.getNode().clean(!0),J.importData(e,t,o),J.refreshNode(!0),J.afterImport(),J.updatePosToStoreyNavigator()},onCancelCB:function(){},onCloseCB:function(){}}})},this.notifyWrongPaste=function(e){var t=J._frmWindow;J._notify&&J._notify.destroy(),this._notify=new _({body:t.getUIFrame(),type:"error",message:e?O.warningDlg.errMessageCtoS:O.warningDlg.errMessageStoC})};var Je=this.setInEdition;let Ze;this.setInEdition=function(e,t,i){if(null!=t){Je(e);var n=J.getNode();if(i)n&&(e&&n.initClippingRobot(),n.update());else if(J.isEditable())if(this.manageNavigatorEdition(),e){var o=c.isManipulationAllowed({viewer:J._viewer}),r=l.checkIfCommandIsRunning(J._viewer)&&!o;if(n){var a=n._getManpForRobot();r||a||(r=!0)}if(!r){let t=J.getNode();t&&t.manageLock(!e)&&t.update(),J._startEditCommand()}}else J._movegauge&&!this.getDoNotEndEditCmdState()&&(J._movegauge.unsubscribeToPrefChangeEvt(),J._movegauge.clean(),J._movegauge=null),J.getNode()&&!this.getDoNotEndEditCmdState()&&J.getNode().manageLock(!e),J._endEditCommand()}},Ze=!0,addEventListener("custom:StoreyChanged",e=>{J&&J.isSectionUpdateReq()&&Ze&&J.isConstructionItemMode()&&e&&e.detail&&J.updateClippingPosAndOrientation(e.detail,!0)}),addEventListener("custom:OrientationChanged",e=>{J&&J.isSectionUpdateReq()&&Ze&&J.isConstructionItemMode()&&e&&e.detail&&J.updateClippingPosAndOrientation(e.detail,!0)}),this.unRegisterStoreyEvents=function(){Ze&&(Ze=!1,removeEventListener("custom:StoreyChanged",()=>{}),removeEventListener("custom:OrientationChanged",()=>{}),this.setStoreyNavigatorVisu(!1))},J._eventController||(J._eventController=C.giveEventsController({viewer:J._viewer})),J._eventController&&(J.editclippingCmdEventToken&&J.editclippingCmdEventToken.length||(J.editclippingCmdEventToken=[],J.editclippingCmdEventToken.push(J._eventController.addEvent("onEditCommandStart",()=>{J._buildManipulationTool()})),J.editclippingCmdEventToken.push(J._eventController.addEvent("onEditCommandEnd",()=>{J._cleanManipulationTool()}))))},getBB:function(){let e=this._viewer;return this._bBox||(this._bBox=c.computeBoundingBox(e,void 0,()=>!0,()=>C.getContextViewer({viewer:e}))),this._bBox},retriveCurrentStoreyInfo:function(){if(!this.isConstructionItemMode())return;let e=n.getStoreyinfoOnSlide(this._viewer);if(e)return e;let t=T.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})});return t?t.GetCurrentStorey():void 0},updateStoreyNav:function(e){var t=this;if(!this.isConstructionItemMode())return;let i=this._storeyNavigatorcntroller;i||(i=T.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})}));let o=e||n.getStoreyinfoOnSlide(this._viewer);i?(o&&i.SetCurrentStorey(o),this.updatePosToStoreyNavigator()):(i=T.getDMUStoreyNavigratorController({context:C.getContextViewer({viewer:t._viewer}),getBuidlingRootID:()=>{var e=n.getBuildingRootData(t._viewer);return e?e.ID:void 0},storyeRetrivalSuccessCB:e=>{o&&e.SetCurrentStorey(o),t.updatePosToStoreyNavigator(),t.manageNavigatorEdition()},storyeRetrivalFailCB:()=>{localStorage.setItem("DMUClippingBoxMode","NormalMode"),t.setAttribute("sPlaneBoxMode","NormalMode"),t.refreshNode(!0)}}),this._storeyNavigatorcntroller=i)},setStoreyNavigatorVisu:function(e){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=T.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&(e?(this._storeyNavigatorcntroller.ShowStoreyNavigator(),this.isReadOnly()||this.manageNavigatorEdition(!0)):this._storeyNavigatorcntroller.HideStoreyNavigator()))},setStoreyNavigatorEditionState:function(e){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=T.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.SetEditMode(e))},manageNavigatorEdition:function(e){if(!this.isConstructionItemMode())return;let t="DMUTemporaryBag"!==this.getParent().getType(),i=t?this.isInEdition():e;if("boolean"==typeof i){if(t&&this._storeyNavigatorcntroller){let e=n.getStoreyinfoOnSlide(this._viewer);e&&this.updateStoreyNav(e)}this.setStoreyNavigatorEditionState(i)}},manageNavigatoreVisu:function(e){this.setStoreyNavigatorVisu(e)},isBuidlingRootAvailable:function(e,t){if(!this.isConstructionItemMode())return!0;let i=e||C.getContextViewer({viewer:this._viewer});if(i){let e=n.isClippingEligibleForStoreyMode(this._viewer,i);if(!e)return!1;if(!t){let t=n.getBuildingRootData(this._viewer,e);if(!T.getStoreyInfo(t?t.ID:void 0,i))return!1}}return!0},manageConstrutionItemModeafterClone:function(){if(this.isConstructionItemMode()&&"DMUTemporaryBag"!==this.getParent().getType()){let e=C.getContextViewer({viewer:this._viewer});if(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=T.giveDMUStoreyNavigratorController({context:e})),!this._storeyNavigatorcntroller)return;if(!this.isBuidlingRootAvailable(e))return void this.resetToNormalMode();let t=n.getStoreyinfoOnSlide(this._viewer);t&&(this._storeyNavigatorcntroller.SetCurrentStorey(t),this.updatePosToStoreyNavigator(),n.setStoreyinfoOnSlide(this._viewer,this._storeyNavigatorcntroller.GetCurrentStorey()))}},updatePosToStoreyNavigator:function(){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=T.giveDMUStoreyNavigratorController({context:C.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.SetPosition3D(this.getNormal().negate().normalize(),this.getClippingCenter()))},updateClippingPosAndOrientation:function(e,t,i){if(!e||!e.position&&!e.Position3D&&!e.orientedDirection&&!e.OrientedDirection)return;let o=e.position||e.Position3D,r=e.orientedDirection||e.OrientedDirection;o&&(o=o.clone()),r&&(r=r.clone()),e.UUID&&n.setStoreyinfoOnSlide(this._viewer,e.UUID);let a=this.computePlaneRef(r,o,i);this.getNode().clearAllRulers();var l={attribute:"mPlaneReferential",value:a=this.updateClippingSize(a)};if(this.set(l),this.getNode().setRulerOrigin(o),this.updatePosToStoreyNavigator(),this.refreshNode(),t){let e=c.getClippingCmd(C.getContextViewer({viewer:this._viewer}));!1===e.getState()&&e.setState(!0)}},manageClippingCmd:function(){var e=c.getClippingCmdService();e&&e.updateClippingCommandState({contextViewer:C.getContextViewer({viewer:this._viewer}),reviewContext:C.getReviewContext({viewer:this._viewer})})},remove:function(){if(this.promiseToResolve&&this.promiseToResolve.length&&this.promiseToResolve.forEach(e=>{e("CancelOnDemand")}),this.promiseToResolve=null,this.unRegisterStoreyEvents(),this._movegauge&&(this._movegauge.unsubscribeToPrefChangeEvt(),this._movegauge.clean(),this._movegauge=null),"DMUTemporaryBag"===this.getParent().getType()){let e=c.getClippingCmd(C.getContextViewer({viewer:this._viewer}));e&&e.getState&&!0===e.getState()&&e.setState(!1)}var e=this.getNode();this.setAttribute("bClippingActiveState",!1),this.setVisibleFlag(!1,!1,!0),e.update(),e.clean(!0),e.cleanClippingRobot(!0);let t=n.getEditCmd(this._viewer);t&&(t.isRunning()||t.isPaused()?t.cancel():n.cleanClippingVisu(this._viewer)),e.setRobot(null),this.unsuscribeOnRepLoading(),this.cleanLockedInRAMNodes();var i=S.giveDMUMarkupsController({context:this._viewer});i&&i.unregisterMarker(this),S.unreferenceDMUMarkupsController({context:this._viewer});var o=C.giveEventsController({viewer:this._viewer});if(o)for(var r=0;r<this._tokenModelEvent.length;r++)o.removeEvent(this._tokenModelEvent[r]);this._tokenModelEvent=[],o&&this.editclippingCmdEventToken&&this.editclippingCmdEventToken.forEach(e=>{o.removeEvent(e)}),this._pimCtrl&&this._tokenOnPimCtrlOpacityChange&&(this._tokenOnPimCtrlOpacityChange&&this._pimCtrl.unsubscribe(this._tokenOnPimCtrlOpacityChange),this._tokenOnPimCtrlOpacityChange=null,this._pimCtrl=null),e.clean(),e.clearEventToken(),this._viewer.setSectionCapping(!1),this._iViewerSecondaryWindow&&this._iViewerSecondaryWindow.clear(),this._parent()},retriveClippingObjs:function(e){var t=function(e){if(e)return C.getReviewContext({viewer:e})};return function(e){return e&&e.getDMUObjects?((i=e.getDMUObjects("DMUClipping"))&&0===i.length&&(i=e.getDMUObjects("DMUSection")),i.length>0&&(t=i),t):[];var t,i}(function(e){var i=t(e);if(!i)return;function n(e){let t;return!!(e&&((!(t=e.getDMUObjects("DMUClipping"))||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let o,r=!1,a=!1,l=i.getCurrentSessionMarkup();l&&l.getActiveFlag()&&l.isVisible()&&l.getCurrentSlide&&(r=n(o=l.getCurrentSlide()));var s=i.getTransientReviewBag();return a=n(s),r||o&&!a?o:s}(e))},clearAllRuler:function(e){let t=this.retriveClippingObjs(this._viewer,!0);t&&t.length&&t.forEach(function(t){if(t){t.getNode().clearAllRulers(e)}})},clearOtherslider:function(){let e=this.retriveClippingObjs(this._viewer,!0);e&&e.length&&e.forEach(function(e){e&&e._cleanManipulationTool&&e._cleanManipulationTool()})},cleanNode:function(){this.getNode()&&this.getNode().clean()},setAttribute:function(e,t){"fLineStyleThicknessIndex"===e&&this._parent("fLineStyleThickness",null),this._parent(e,t)},isCustomColorSorce:function(e){var t;if("Capping"===e){t=this.getAttribute("bCustomCappingColor");let e=this.getAttribute("cCappingColor");null==t?t=Boolean(e):e||(t=!1)}if("Contour"===e){t=this.getAttribute("bCustomContourColor");let e=this.getAttribute("cLineStyleColor");null==t?t=Boolean(e):e||(t=!1)}return t},isSinglePlaneMode:function(){let e=this.getAttribute("sPlaneBoxMode");return"NormalMode"===e||"ConstructionItemMode"===e},isConstructionItemMode:function(){return"ConstructionItemMode"===this.getAttribute("sPlaneBoxMode")},getClippingModeForDragDrop:function(){return this.isConstructionItemMode()?"NormalMode":this.getAttribute("sPlaneBoxMode")},resetToNormalMode:function(e){this.setStoreyNavigatorVisu(!1),this.getNode().clean();if(this._lastClippingDefHdr=void 0,localStorage.setItem("DMUClippingBoxMode","NormalMode"),this.setAttribute("sPlaneBoxMode","NormalMode"),e){let t=e.getRobot();t||(e.initClippingRobot(),t=e.getRobot()),t&&t.updateRobotPos()}this.refreshNode()},isTemporaryClipping:function(){return"DMUTemporaryBag"===this.getParent().getType()}})}),define("DS/DMUPlaySection/DMUSection",["DS/DMUPlaySection/DMUClippingBase"],function(e){"use strict";return e.extend({init:function(e){e.sType="Section",this._parent(e)}})}),define("DS/DMUPlaySection/DMUClipping",["DS/DMUPlaySection/DMUClippingBase","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=[{name:"bHatchingDisplay",type:"bool",JSONname:"PropertiesSection.Hatching.Display",defaultValue:!0},{name:"cHatchingColor",type:"Color",JSONname:"PropertiesSection.Hatching.GraphicProperties.color",defaultValue:new t.Color(0)},{name:"fHatchingLineStyleThickness",type:"float",JSONname:"PropertiesSection.Hatching.GraphicProperties.LineStyle.thicknessIndex",defaultValue:1},{name:"sHatchingAnglesMode",type:"string",JSONname:"PropertiesSection.Hatching.AnglesMode",defaultValue:"Various"},{name:"fHatchingSingleAngleValue",type:"float",JSONname:"PropertiesSection.Hatching.SingleAngleValue",defaultValue:.523599},{name:"fHatchingPitchValue",type:"float",JSONname:"PropertiesSection.Hatching.HatchingPitchValue",defaultValue:10}];return e.extend({init:function(e){this._parent(e),this.addParameters(i)}})}),define("DS/DMUPlaySection/DMUClippingService",["UWA/Utils","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUPlaySection/DMUClipping","DS/DMUPlaySection/DMUToolsSection","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUSectionPosService","DS/CATWebUXPreferences/DMUClippingPrefService","DS/DMUBaseCommands/EXPToolsWUX","DS/Visualization/ThreeJS_DS","DS/DMUPlaySection/DMUStoreyNavigratorController","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"],function(e,t,i,n,o,r,a,l,s,c,u,p){"use strict";var g,d=function(e){if(e)return t.getReviewContext({viewer:e})},v=function(e){var t=d(e);if(t){var i=t.getCurrentSessionMarkup();return(!i||i&&!i.getActiveFlag()||i&&i.getActiveFlag()&&!i.isVisible()||i&&i.getActiveFlag()&&i.isVisible()&&i.isReadOnly()||i&&i.getActiveFlag()&&i.isVisible()&&!i.isReadOnly()&&!i.getCurrentSlide())&&(i=t.getTransientReviewBag()),i}};var f=function(e){return e&&e.getDMUObjects?((!(i=e.getDMUObjects("DMUClipping"))||i&&0===i.length)&&(i=e.getDMUObjects("DMUSection")),i.length>0&&(t=i),t):[];var t,i},m=function(e){var i=t.getContextViewer({viewer:e});return i?i.getCommandContext():"Default"};function S(e,i,n){if(!e||!i||!n)return;var l,s,c=i.sliceOffset,u=function(){return"DMUTemporaryBag"!==e.getParent().getType()},p=function(){return t.getContextViewer({viewer:n})};let g="NormalMode"!==i.boxMode&&"ConstructionItemMode"!==i.boxMode;var d=i.bbox?i.bbox:r.computeBoundingBox(n,i.objForBB,u,p),v=Math.max(d.max.x-d.min.x,d.max.y-d.min.y,d.max.z-d.min.z),f=i.planeReferential||o.computeSectionPlaneReferencial(n,d,g,i.planeDir),m=g&&!c,S=a.computePlaneDim(d,f,!1,m);if(m){var h=r.computeBoundingSphere(n,i.objForBB,u,p);c=isNaN(S.fSliceOffset)?o.computeClippingSlice(h,f):S.fSliceOffset}i.planeSizeU&&i.planeSizeV?(s=i.planeSizeV,l=i.planeSizeU):(l=v,s=v,S&&S.fPlaneSizeV&&S.fPlaneSizeU&&(i.planeSizeV||(s=S.fPlaneSizeV),i.planeSizeU||(l=S.fPlaneSizeU))),e.setAttributes([{name:"mPlaneReferential",value:f},{name:"fXDirSize",value:l},{name:"fYDirSize",value:s},{name:"fXDirGridStep",value:l/20},{name:"fYDirGridStep",value:s/20},{name:"fSliceOffset",value:c}])}var h={setClippingParameters:async function(l,s){var u=this,g=await async function(e){if(e){var n=t.getReviewContext({viewer:e});return n||(n=await i.createReviewContext({context:t.getContextViewer({viewer:e})})),n}}(l);if(g){var d=s.appType||"3dReview",v=!isNaN(s.indexOfClippingObj)&&s.indexOfClippingObj>0?s.indexOfClippingObj:0,f=s.sectionCommandMode,S=[],h=function(){var t=u.retriveClippingObjs(l),i=g.getTransientReviewBag();if(i)return(!(S=i.getDMUObjects("DMUClipping"))||S&&0===S.length)&&(S=i.getDMUObjects("DMUSection")),S.length>0?t=S[v]:((t=new n({viewer:l,expParent:i,typeApps:d,modeType:f,context:m(l),sectionEditCmd:o.getEditCmd(l)})).setAttributes([{name:"sID",value:i.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:i.computeNewName({object:t,prefix:p.sectionPrefix||"Section"})}]),i.addDMUObject&&(i.addDMUObject(t),t.fireEvent("onDMUObjectInitialized",{dmuObject:t}))),t}();if(h){var C,y,b=r.computeBoundingBox(l),M=Math.max(b.max.x-b.min.x,b.max.y-b.min.y,b.max.z-b.min.z),P=s.planeReferential||o.computeSectionPlaneReferencial(l,b);if(s.planeSizeU&&s.planeSizeV)y=s.planeSizeV,C=s.planeSizeU;else{C=M,y=M;var w=a.computePlaneDim(b,P,!0);w&&(w.fPlaneSizeV&&w.fPlaneSizeU&&(s.planeSizeV||(y=w.fPlaneSizeV),s.planeSizeU||(C=w.fPlaneSizeU)),w.plane&&!s.planeReferential&&(P=w.plane))}var D=s.opacity;D&&(D/=255);var x=function(e){if(e&&3===e.length)return new c.Color("rgb("+e[0]+","+e[1]+","+e[2]+")")};let e=s.sectionCurvesVisible;h.setAttributes([{name:"mPlaneReferential",value:P},{name:"fXDirSize",value:C},{name:"fYDirSize",value:y},{name:"sDisplayPlaneMode",value:"Plane"},{name:"sDisplayContourMode",value:"Contour"},{name:"sSectionRender",value:s.sectionRender||"CutOneSide"},{name:"sPartialClippingMode",value:!1},{name:"sUpdateAndFreezeMode",value:"Update"},{name:"fXDirGridStep",value:C/20},{name:"fYDirGridStep",value:y/20},{name:"sPlaneBoxMode",value:s.boxMode||"NormalMode"},{name:"fSliceOffset",value:s.sliceOffset||0},{name:"fOpacity",value:isNaN(D)?.5:D},{name:"bSectionCurvesVisible",value:e},{name:"bClipping",value:!0},{name:"bHatchingDisplay",value:s.hatchingDisplay},{name:"cHatchingColor",value:x(s.hatchingColor)},{name:"fHatchingLineStyleThickness",value:s.hatchingLineStyleThickness},{name:"sHatchingAnglesMode",value:s.hatchingAnglesMode},{name:"fHatchingSingleAngleValue",value:s.hatchingSingleAngleValue},{name:"fHatchingPitchValue",value:s.hatchingPitchValue}]),h.setAttribute("bCustomCappingColor",s.isCustomCappingColor),s.cappingColor&&h.setAttribute("cCappingColor",x(s.cappingColor)),h.setAttribute("bCustomContourColor",s.isCustomContourColor),s.lineStyleColor&&h.setAttribute("cLineStyleColor",x(s.lineStyleColor)),s.lineStyleThicknessIndex&&h.setAttribute("fLineStyleThicknessIndex",s.lineStyleThicknessIndex),s.lineStylePattern&&h.setAttribute("sLineStylePattern",s.lineStylePattern),s.fillStyleColor&&h.setAttribute("cFillStyleColor",x(s.fillStyleColor)),void 0!==s.clippingPlaneVisible&&h.setAttribute("bClippingPlaneVisible",s.clippingPlaneVisible),h.setInEdition(!1);var V=h.getNode();V&&V.update(!0),h.manageClippingCmd()}}},createClipping:function(i,r){if(d(i)){var a,s=r.appType||"3dReview",c=r.sectionCommandMode,v=r.precisePosCmd||void 0,f=function(e){var t=d(e);if(!t)return;var i=t.getCurrentSessionMarkup();let n=!0;if(i){let e=t.getRestrictions(i);e.markup&&void 0!==e.markup.canEdit&&(n=e.markup.canEdit)}return i&&i.getActiveFlag()&&i.isVisible()&&!i.isReadOnly()&&n&&i.getCurrentSlide()?i:t.getTransientReviewBag()}(i);if(f){var C;C=new n({viewer:i,expParent:f,typeApps:s,modeType:c,context:m(i),clippingPrecisePosCmd:v,sectionEditCmd:o.getEditCmd(i),csoList:r.csoList,isStoreyMode:"ConstructionItemMode"===r.boxMode}),v&&(C._posCmdActive=!0),C.setAttributes([{name:"sID",value:f.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:f.computeNewName({object:C,prefix:p.clippingPrefix})}]);var y=f;if(f.getCurrentSlide&&(y=f.getCurrentSlide()),y.addDMUObject&&(y.addDMUObject(C),a=!0),C){if(function(e,t,i){if(e&&t&&i){var n=t.boxMode||"NormalMode",o=t.sectionCommandMode;S(e,t,i),e.setAttributes([{name:"sDisplayPlaneMode",value:"Plane"},{name:"sDisplayContourMode",value:"Contour"},{name:"sSectionRender",value:t.sectionRender||"CutOneSide"},{name:"sPartialClippingMode",value:!1},{name:"sUpdateAndFreezeMode",value:"Update"},{name:"sPlaneBoxMode",value:n},{name:"fOpacity",value:void 0!==t.opacity?t.opacity:.2},{name:"bSectionCurvesVisible",value:t.sectionCurvesVisible||"ProgressiveVisuLoading"!==o&&l.contour.getComputeContourStatus()},{name:"bClipping",value:!0},{name:"bClippingActiveState",value:!0},{name:"bClippingPlaneVisible",value:Boolean(t.bDisplayPermanently)},{name:"bHatchingDisplay",value:t.isHatchingDisplayed},{name:"cHatchingColor",value:t.hatchingColor},{name:"fHatchingLineStyleThickness",value:t.hatchingThickness},{name:"sHatchingAnglesMode",value:t.hatchingAnglesMode},{name:"fHatchingSingleAngleValue",value:t.hatchingSingleAngleValue},{name:"fHatchingPitchValue",value:t.hatchingPitchValue}]),e.setAttribute("bCustomCappingColor",t.isCustomCappingColor),t.cappingColor&&e.setAttribute("cCappingColor",t.cappingColor),e.setAttribute("bCustomContourColor",t.isCustomContourColor),t.lineStyleColor&&e.setAttribute("cLineStyleColor",t.lineStyleColor),t.lineStyleThicknessIndex&&e.setAttribute("fLineStyleThicknessIndex",t.lineStyleThicknessIndex),t.fillStyleColor&&e.setAttribute("cFillStyleColor",t.fillStyleColor)}}(C,r,i),"ConstructionItemMode"===r.boxMode){let e=e=>{let t=e.GetPosition3D();C.updateClippingPosAndOrientation(t),o.setStoreyinfoOnSlide(i,e.GetCurrentStorey())},n=()=>{var e=o.getEditCmd(i);localStorage.setItem("DMUClippingBoxMode","NormalMode"),C.setAttribute("sPlaneBoxMode","NormalMode"),h.resetClipping(C,i),e&&!e.isRunning()&&e.begin()};var b=t.getContextViewer({viewer:i});let a=o.getBuildingRootData(i,r.buildingRoot),l=u.getStoreyInfo(a?a.ID:void 0,b);if(b&&a&&(l&&l.length||u.clearStoreyNavigratorController({context:b})),g=u.giveDMUStoreyNavigratorController({context:b})){g.ShowStoreyNavigator(),g.SetEditMode(!0),o.setStoreyinfoOnSlide(i,g.GetCurrentStorey());let e=g.GetPosition3D();C.updateClippingPosAndOrientation(e)}else g=u.getDMUStoreyNavigratorController({context:b,getBuidlingRootID:()=>a?a.ID:void 0,storyeRetrivalSuccessCB:e,storyeRetrivalFailCB:n})}a&&C.fireEvent("onDMUObjectInitialized",{dmuObject:C});var M=C.getNode();M&&M.update(),i.render()}return C}}},resetClipping:function(e,t){if(e&&t){S(e,l.getDefaultClippingProp(),t);var i=e.getNode();i&&i.update(!0),t.render()}},resizeClippingFromObject:function(e,t,i){if(e&&i){S(e,t,i);var n=e.getNode();n&&n.update(!0),i.render()}},retriveCurrentReview:function(e){return v(e)},retriveClippingObjs:function(e){var t=v(e);if(t)return t.getCurrentSlide&&(t=t.getCurrentSlide()),f(t)},retriveClippingObjsFromSlide:function(e){var t=this.retriveClippingObjs(e);if(!t||!t.length){var i=function(e){var t=d(e);if(!t)return;function i(e){let t;return!!(e&&((!(t=e.getDMUObjects("DMUClipping"))||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let n,o=!1,r=!1,a=t.getCurrentSessionMarkup();a&&a.getActiveFlag()&&a.isVisible()&&a.getCurrentSlide&&(o=i(n=a.getCurrentSlide()));var l=t.getTransientReviewBag();return r=i(l),o||n&&!r?n:l}(e);t=f(i)}return t},activateClipping:function(e,i){let n=t.getContextViewer({viewer:i});r.activateClipping(e,n)},deActivateClipping:function(e,i,n){let o=t.getContextViewer({viewer:i});e&&e.length||!g||g.HideStoreyNavigator(),r.deActivateClipping(e,o,n)},editClipping:async function(e,t,i){var n=t,r=!0===n.fromContextcmd,a=!i,c=o.getEditCmd(e);if(!e)return;var p=this.retriveClippingObjsFromSlide(e);let g=!1;var d;(!p||p.length<=0)&&a&&(p=[],d=n&&n.getDefaultValues?await n.getDefaultValues():l.getDefaultClippingProp(),p.push(this.createClipping(e,d)),g=!0);if(p&&p.length&&!(p.length<0)){var v=p.length>1;p.forEach(function(e){var t=e.getAttribute("bClippingActiveState");a&&!t&&(e.setAttribute("bClippingActiveState",a),e.setVisibleFlag(!0,!1,!0)),e.getNode().clearAllRulers(),e.setInEdition(a,r,v),v||e._posCmdActive||(a?s.addInCSO(e):e.addOrRemoveFromCSO()),e.isConstructionItemMode()&&!g&&a&&e.setStoreyNavigatorVisu(!0),u.getActivateClippingActionFlag()&&g&&e.isTemporaryClipping()&&e.isConstructionItemMode()||u.setActivateClippingActionFlag(!1)}),r&&(a?c.begin():c.cancel()),u.getActivateClippingActionFlag()&&(u.setActivateClippingActionFlag(!1),c&&c.isRunning()&&c.cancel()),e.render()}},setStoreyNavigatorVisibility:function(e){g&&(e?g.ShowStoreyNavigator():g.HideStoreyNavigator())}};return h});