define("DS/CADExportConfig/utils/ExportValidator",["UWA/Class","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CADExportConfig/utils/Constants","text!DS/CADExportConfig/assets/config/CadConfig.json"],function(e,t,i,r,s){"use strict";var o,d=function(e,t){t("cadexportconfig.error.cadsupport"===e?UWA.i18n(e).title+" "+o:null!=UWA.i18n(e).subtitle?UWA.i18n(e).subtitle:null!=UWA.i18n(e).title?UWA.i18n(e).title:UWA.i18n(e))};return UWA.Class.singleton({init:function(){this._parent();let e=JSON.parse(s);this.sLicenseList=e.cadlicense,this.sCadMasterList=this.sLicenseList.map(e=>e.cadmaster),this.sSelectNodes=[]},computeNodes:function(e,t){var i=this;i.sSelectNodes=[],i.isValidated=!1,i.errorkey=null,o=null;let s=!1,d=[],n=!0,a=[],l={};return new Promise(c=>{let p=e.some(e=>r.BOOKMARK_TYPES.includes(e.options.type));p?d=e.filter(e=>!r.BOOKMARK_TYPES.includes(e.options.type)):(e.some(e=>null==e.options.grid["ds6w:cadMaster"])&&e.forEach(e=>{let i=t.find(t=>t.resourceid===e.options.grid.id);null!=i&&null!=i["ds6w:cadMaster"]&&(e.options.grid["ds6w:cadMaster"]=i["ds6w:cadMaster"])}),d=e.filter(e=>null!=e.options.grid["ds6w:cadMaster"]),s=e.some(e=>null==e.options.grid["ds6w:cadMaster"]));let u=t.filter(e=>e.resourceid&&e.type||e.Path),f=u.flatMap(e=>e["ds6w:cadMaster"]?e["ds6w:cadMaster"]:[]),g=d.length>0?d.filter(e=>e.options.grid["ds6w:cadMaster"]).map(e=>e.options.grid["ds6w:cadMaster"]):[];if(f=[...new Set(f.concat(g))],Array.isArray(f)&&f.length?f.includes(r.CAD_MASTER_3DEXP)?i.errorkey="cadexportconfig.error.3dexpselected":f.length>1?i.errorkey="cadexportconfig.error.multicadsupport":1===f.length&&(i.sCadMasterList.includes(f[0])?(i.computedCadMaster=f[0],i.isValidated=!0):(n=!1,i.errorkey="cadexportconfig.error.cadsupport",o=sCadMaster[0])):(n=!1,i.isValidated=!1,i.errorkey="XEError.UnsupportedInputDatatype"),t.filter(e=>e.resourceid&&e["ds6w:cadMaster"]).some(e=>null==e["ds6w:cadMaster"])&&(n=!1,i.isValidated=!1,i.errorkey="XEError.UnsupportedInputDatatype"),!p&&e.length>0&&n)for(let t=0;t<e.length;t++){let s=e[t],o=null!=s.options.resourceid?s.options.resourceid:s.options.grid.resourceid;if(!s.isRoot()){if(null!=s.options.grid["ds6w:cadMaster"]&&s.options.grid["ds6w:cadMaster"]===r.CAD_MASTER_V5&&s.getParents().some(e=>e.options.grid["ds6w:cadMaster"]===r.CAD_MASTER_3DEXP)){i.errorkey="cadexportconfig.error.root3dexp.v5selected",i.isValidated=!1;break}if(null!=s.getParent().options.grid["ds6w:cadMaster"]){let e=null!=s.getParent().options.resourceid?s.getParent().options.resourceid:s.getParent().options.grid.resourceid;a.push({nodeid:o,parentid:e,parentcadmaster:s.getParent().options.grid["ds6w:cadMaster"]})}}let d=[];for(let e=0;e<s.getPath().length;e++){let t=null!=s.getPath()[e].options.resourceid?s.getPath()[e].options.resourceid:s.getPath()[e].options.grid.resourceid;s.getPath()[e].isRoot()?d.push(t):(d.push(t),d.push(t))}l[o]=d}if(i.isValidated){let t=[];if(p){t=u.flatMap(e=>e.identifier?e.resourceid:[]);let e=u.flatMap(e=>e.Path?e.Path[0]:[]),r=u.filter(t=>e.includes(t.resourceid));for(let e of r)i.sSelectNodes.push({physicalid:e.resourceid,identifier:e.identifier,type:e.type,cadmaster:e["ds6w:cadMaster"],Path:[e.resourceid],root:[]})}else if(s)for(let t=0;t<e.length;t++){let r=e[t];if(null==r.options.grid["ds6w:cadMaster"]&&null!=r.getChildren()&&r.getChildren().length>0)for(let e of r.getChildren()){let t=null!=e.options.grid["ds6w:type-original"]?e.options.grid["ds6w:type-original"]:e.options.grid["ds6w:type"],r=null!=e.options.resourceid?e.options.resourceid:e.options.grid.resourceid;i.sSelectNodes.push({physicalid:r,identifier:e.options.grid["ds6w:identifier"],type:t,cadmaster:e.options.grid["ds6w:cadMaster"],Path:[r],root:[]})}}if(d.length>0)for(let e of d){let r=null!=e.options.resourceid?e.options.resourceid:e.options.grid.resourceid;if(!t.includes(r)){let t=null!=e.options.grid["ds6w:type-original"]?e.options.grid["ds6w:type-original"]:e.options.grid["ds6w:type"],s=!p&&a.length>0?a.find(e=>e.nodeid===r):void 0,o=!p&&Object.keys(l).length>0?l[r]:[r];i.sSelectNodes.push({physicalid:r,identifier:e.options.grid["ds6w:identifier"],type:t,cadmaster:e.options.grid["ds6w:cadMaster"],Path:o,root:null!=s?[{physicalid:s.parentid,cadmaster:s.parentcadmaster}]:[]})}}}c()})},validateCadMasterRoles:function(){var e=this;return new Promise(t=>{e.isValidated&&i.getGrantedRoles(function(t){let i=e.sLicenseList.filter(t=>e.computedCadMaster.includes(t.cadmaster)).flatMap(e=>e.roles),r=t.map(e=>e.id);i.some(e=>r.includes(e))?e.isValidated=!0:(e.isValidated=!1,e.errorkey="cadexportconfig.error.rolesmatch")}),t()})},validateECasRoot:function(e,t){var i=this;return new Promise(s=>{if(i.isValidated){let s,o=e.some(e=>r.BOOKMARK_TYPES.includes(e.options.type));if((s=o?e.filter(e=>!r.BOOKMARK_TYPES.includes(e.options.type)):[...e]).length>0){let e=t.filter(e=>!(null==e.interface||!e.interface.split(",").includes(r.EMB_COMP_INT)));if(e.length>0){let r=e.map(e=>e.resourceid);for(let e=0;e<s.length>0;e++){if(!!r.includes(s[e].getID())&&(!!s[e].isRoot()||!!s[e].getParents().filter(e=>e.isRoot()).some(e=>r.includes(e.getID())))){i.errorkey="cadexportconfig.error.ecasroot",i.isValidated=!1;continue}let o=t.filter(e=>e.Path).map(e=>null!=e.Path?e.Path:[]);if(o.length>0){let t=o.filter(t=>!!(t.length>1&&t.includes(s[e].getID())));if(t.length>0){let e=[...t[0]];if(!r.includes(e[0])&&e.some(e=>r.includes(e))){i.isValidated=!0;break}if(r.includes(e[0])){i.errorkey="cadexportconfig.error.ecasroot",i.isValidated=!1;continue}}}}}}}s()})},validateNodes:function(e){let i=this,s=e.url3DSpace+r.VALIDATE_URL;return new Promise((r,o)=>{if(i.isValidated){let d={computedselected:i.sSelectNodes},n={Accept:"application/json","Content-Type":"application/json","Accept-Language":"en","X-Requested-With":"XMLHttpRequest",SecurityContext:e.securityContext};t.authenticatedRequest(s,{data:JSON.stringify(d),method:"POST",headers:n,onComplete:function(e){null!=(e=JSON.parse(e)).errorcode&&(i.isValidated=!1,i.errorkey=e.errorcode),r()},onFailure:function(e){i.isValidated=!1,i.errorkey="cadexportconfig.error.rootecservice",o()},onTimeout:function(e){i.isValidated=!1,i.errorkey="cadexportconfig.error.rootecservice",o()}})}else r()}).then(()=>{Boolean(i.isValidated)?e.resolve():d(i.errorkey,e.reject)},function(t){d(i.errorkey,e.reject)})}}).init()});