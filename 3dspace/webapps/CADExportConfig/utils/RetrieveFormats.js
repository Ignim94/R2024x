define("DS/CADExportConfig/utils/RetrieveFormats",["UWA/Core","DS/WAFData/WAFData","DS/CADExportConfig/utils/Constants"],function(t,e,a){"use strict";var n;return{generateFormats:async function(i){let r={format3d:[],format2d:[],isrender:!1};return n=await async function(n){function i(t,e){let n="";e.includes(a.CAD_MASTER_3DEXP)||1!=e.length||(n=e[0]),t(n)}return new Promise(r=>{var s=n.selectedNodes;let o=s.some(t=>a.BOOKMARK_TYPES.includes(t.options.type)),l=[],d=[];o?(l=s.filter(t=>!a.BOOKMARK_TYPES.includes(t.options.type)),d=l.filter(t=>null==t.options.grid["ds6w:cadMaster"]||""==t.options.grid["ds6w:cadMaster"])):(l=s.filter(t=>null!=t.options.grid["ds6w:cadMaster"]),d=s.filter(t=>null==t.options.grid["ds6w:cadMaster"]||""==t.options.grid["ds6w:cadMaster"]),s.filter(t=>null==t.options.grid["ds6w:cadMaster"]).forEach(t=>{if(null!=t.getChildren()&&null!=t.getChildren()&&t.getChildren().length>0){const e=d.findIndex(e=>e.getID()===t.getID());e>-1&&d.splice(e,1),t.getChildren().forEach(t=>{l.push(t)})}}));let u=l.length>0?[...new Set(l.flatMap(t=>""!=t.options.grid["ds6w:cadMaster"]?t.options.grid["ds6w:cadMaster"]:[]))]:[];if(d.length>0){let s={physicalid:[],label:"3DSpace-ExportAsCAD-"+Math.floor(Date.now()/1e3).toString(),select_predicate:["ds6w:cadMaster","physicalid"]};d.forEach(t=>{s.physicalid.push(t.getID())});const o=n.platformServices["3DSpace"]+a.URL_FETCH_SERVICE+n.platformServices.platformId;e.authenticatedRequest(o,{method:"POST",headers:{"content-type":"application/json",SecurityContext:n.securityContext},data:JSON.stringify(s),onComplete:function(e){let a=t.is(e,"string")?JSON.parse(e):e,n=[...new Set(a.results.flatMap(t=>null!=t.attributes.find(t=>"ds6w:cadMaster"===t.name)?t.attributes.find(t=>"ds6w:cadMaster"===t.name).value:[]))];u=u.concat(n),i(r,u)},onFailure:function(t){i(r,[])},onTimeout:function(t){i(r,[])}})}else i(r,u)})}(i),new Promise(function(s,o){if(0===n.trim().length)s(r);else{const o=i.platformServices["3DSpace"]+a.URL_DO_FORMAT+`${n}`;e.authenticatedRequest(o,{method:"GET",headers:{Accept:"application/json",SecurityContext:i.securityContext},onComplete:function(e){let i=t.is(e,"string")?JSON.parse(e):e;!function(e,n,i,r){if(t.is(n.derivedOutputFormats)&&0!==n.derivedOutputFormats.length){let t=[],s=[];n.derivedOutputFormats.forEach(e=>{e.hasOwnProperty("appliesOn")&&e.hasOwnProperty("category")&&e.category===i&&(e.appliesOn===a.FORMAT_3D?t.push({value:e.outputStreamId,label:e.formatToDisplay}):e.appliesOn===a.FORMAT_2D&&s.push({value:e.outputStreamId,label:e.formatToDisplay}))}),r.format3d=[...new Map(t.map(t=>[t.value,t])).values()],r.format2d=[...new Map(s.map(t=>[t.value,t])).values()],r.isrender=!0,e(r)}else e(r)}(s,i,n,r)},onFailure:function(t){s(r)},onTimeout:function(t){s(r)}})}})},getCadMaster:function(){return n}}});