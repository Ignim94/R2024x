/*!  Copyright 2020 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,n,i,t,o,r,a){"use strict";var l=150,s=150,u=1;return e.extend({init:function(e){var c,g,p,d,f,b,v,M,y,V,h,x=e.frameWindow,m=x.getViewer(),w=e.lightDisplay,R=!1,P=!1,O=e.getRulerUnitCB,C=e.getAngularRulerUnitCB,D=e.checkDirforRuler;Object.defineProperty(this,"robotMatrixCompute",{set:function(e){"function"==typeof e&&(c=e)},get:void 0}),Object.defineProperty(this,"robotOrigin3DCompute",{set:function(e){"function"==typeof e&&(g=e)},get:void 0}),Object.defineProperty(this,"moveBegin",{set:function(e){"function"==typeof e&&(p=e)},get:void 0}),Object.defineProperty(this,"move",{set:function(e){"function"==typeof e&&(d=e)},get:void 0}),Object.defineProperty(this,"moveEnd",{set:function(e){"function"==typeof e&&(f=e)},get:void 0}),Object.defineProperty(this,"moveRobotBegin",{set:function(e){"function"==typeof e&&(b=e)},get:void 0}),Object.defineProperty(this,"moveRobot",{set:function(e){"function"==typeof e&&(v=e)},get:void 0}),Object.defineProperty(this,"moveRobotEnd",{set:function(e){"function"==typeof e&&(M=e)},get:void 0}),Object.defineProperty(this,"moveRulerOriginBegin",{set:function(e){"function"==typeof e&&(y=e)},get:void 0}),Object.defineProperty(this,"moveRulerOrigin",{set:function(e){"function"==typeof e&&(V=e)},get:void 0}),Object.defineProperty(this,"moveRulerOriginEnd",{set:function(e){"function"==typeof e&&(h=e)},get:void 0});var T=new i("",m,!1,!1);T.name="RobotWithRuler_"+u++,T.target={getWorldMatrix:function(){return T.getMatrix()}},T.setMoveMode("CALLBACK_ONLY"),T.scalingNodeX.setVisibility(!1),T.scalingNodeX.setVisibilityFree(!0),T.scalingNodeY.setVisibility(!1),T.scalingNodeY.setVisibilityFree(!0),T.scalingNodeZ.setVisibility(!1),T.scalingNodeZ.setVisibilityFree(!0),T.setVisibility(!1),m.addNode(T);var A,E,S,B,N,U,X,L,k,F,Y,Z,W,j,z=[],G=[],I=[],H={origin:new n.Vector3,initOrigin:new n.Vector3,direction:null,initValue:null,value:null,origin3D:null},K={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},_=!1,q=function(){var e={x:new n.Vector3,y:new n.Vector3,z:new n.Vector3};function i(e,n){var i;return e.normalize(),e.x>.9995?i="x":e.y>.9995?i="y":e.z>.9995&&(i="z"),i?n+"|"+i:n}return function(n){n?(T.getMatrix().extractBasis(e.x,e.y,e.z),T.setLabels({labelX:i(e.x,"u"),labelY:i(e.y,"v"),labelZ:i(e.z,"w")})):T.setLabels()}}();function J(e){T.setPickable(e?o.PICKABLE:o.PICKTHROUGH)}function Q(){S&&S.clear(),B&&B.clear()}function $(){S&&(S.direction=null,S.origin=null,S.origin3DPos=null,S.setValue(0)),B&&(B.direction=null,B.origin=null,B.originVector=null,B.setValue(0)),Q()}function ee(){T.setToNonGhostState()}function ne(){J(!1),L=S.displayOrigin,X=(S.origin3DPos||S.origin).clone(),y&&y()}function ie(e){if(k=null,g){var n=g({event:e.event,viewer:m});k=n&&n.origin3D}return S.displayOrigin=L,k?(S.displayOrigin=!0,V&&V(),k.clone()):X}function te(){J(!0),k&&(H.origin3D=k.clone()),h&&h()}function oe(e){if("RulerManipulateBegin"===e.eventName||"AngularRulerManipulateBegin"===e.eventName)P=!0,F=new n.Vector3,Y=0,E=T.getMatrix(),p&&p({robotMatrix:T.getMatrix(),from:"ruler",axis:(new n.Vector3).copy(e.direction),kind:"RulerManipulateBegin"===e.eventName?"translation":"rotation",event:e.event});else if("RulerManipulate"===e.eventName)q(),F.add(e.translationVector),T.setMatrix((new n.Matrix4).copy(E).setPosition((new n.Vector3).getPositionFromMatrix(E).add(F))),d&&d({robotMatrix:T.getMatrix(),translationVector:e.translationVector,from:"ruler",axis:(new n.Vector3).copy(e.direction),kind:"translation",event:e.event}),m.render({forceDynamicMode:!0});else if("AngularRulerManipulate"===e.eventName){q();var i=e.diffAngle*Math.PI/180;Y+=i;var t=(new n.Matrix4).makeRotationAxis(e.direction,Y).multiply((new n.Matrix4).extractRotation(E));T.setMatrix(t.setPosition((new n.Vector3).getPositionFromMatrix(E))),K.value=B.value,d&&d({robotMatrix:T.getMatrix(),rotationAngle:i,from:"ruler",axis:(new n.Vector3).copy(e.direction),kind:"rotation",event:e.event})}else"RulerManipulateEnd"!==e.eventName&&"AngularRulerManipulateEnd"!==e.eventName||(T.setRobotMatrix(T.getMatrix()),P=!1,f&&f({robotMatrix:T.getMatrix(),from:"ruler",axis:(new n.Vector3).copy(e.direction),kind:"RulerManipulateEnd"===e.eventName?"translation":"rotation",event:e.event}),q(!0),m.render({forceDynamicMode:!0}))}function re(e){var i,t;if(J(!1),P=!0,m.setCursor("pointer"),Q(),i=e.manipulator,[T.arrowX,T.arrowY,T.arrowZ,T.translationPlaneYZ,T.translationPlaneXY,T.translationPlaneXZ,T.rotationArcYZ,T.rotationArcXZ,T.rotationArcXY].forEach(function(e){e&&e.manipulator&&e.manipulator!==i&&e.setToGhostState()}),T.robotHandle.setToGhostState(),"LineTranslationBegin"===e.eventChannel){t=(new n.Vector3).copy(e.manipulator.axis),D&&(t=D(t));var o=(new n.Vector3).getPositionFromMatrix(T.getMatrix()),a=(new n.Vector3).copy(t).multiplyScalar((new n.Vector3).copy(H.baseOrigin).sub(o).dot(t));H.initOrigin=(new n.Vector3).copy(o).add(a);var l=(new n.Vector3).copy(H.initOrigin);if(H.origin3D)l=new n.Line3(H.initOrigin,(new n.Vector3).copy(H.initOrigin).add(t)).closestPointToPoint(H.origin3D,!1);H.origin=l;var s=(new n.Vector3).copy(H.origin).sub(o).dot(t);if(H.direction=t,H.value=l.distanceTo(o)*(s>0?-1:1),H.initValue=H.value,S){let e;S.origin=H.origin,S.origin3DPos=H.origin3D,S.initOrigin=H.initOrigin,S.setValue(H.value),S.direction=H.direction,S.initValue=H.initValue,S.displayOrigin=Boolean(H.origin3D),O&&(e=O()),S.unit=e||r.getCurrentUnit("length").unit,S.display(),S.beginManipulation()}}else if("RotationBegin"===e.eventChannel){if(t=(new n.Vector3).copy(e.manipulator.axis),!K.direction||0===Math.round(100*t.dot(K.direction))){var u=new n.Vector3,c=new n.Vector3,g=new n.Vector3;T.getMatrix().extractBasis(u,c,g),u.normalize(),c.normalize();var d=Math.round(100*u.dot(t)),f=Math.round(100*c.dot(t));0===d?K.originVector=(new n.Vector3).copy(u):0===f&&(K.originVector=(new n.Vector3).copy(c)),K.value=0,K.direction=t}if(K.origin=(new n.Vector3).getPositionFromMatrix(T.getMatrix()),K.initValue=K.value,B){let e;B.originVector=K.originVector,B.setValue(K.value),B.origin=K.origin,B.direction=K.direction,B.initValue=K.initValue,C&&(e=C()),B.unit=e||r.getCurrentUnit("angle").unit,B.display(),B.beginManipulation()}}p&&p({robotMatrix:T.getMatrix(),from:"robot",axis:(new n.Vector3).copy(e.manipulator.axis),kind:"LineTranslationBegin"===e.eventChannel?"translation":"rotation",event:e.event})}function ae(e){if(m.setCursor("pointer"),q(),"LineTranslationManipulation"===e.eventChannel)H.value=H.initValue+e.translationVector.length()*(H.direction.dot(e.translationVector)>0?1:-1),S&&S.setValue(H.value);else if("RotationManipulation"===e.eventChannel){var i=(new n.Vector3).copy(e.axis),t=K.direction.dot(i)<0?2*Math.PI-e.angle:e.angle;K.value=K.initValue+180*t/Math.PI,B&&B.setValue(K.value)}e.translationVector&&d?d({robotMatrix:T.getMatrix(),axis:(new n.Vector3).copy(e.manipulator.axis),translationVector:e.translationVector,from:"robot",kind:"translation",event:e.event}):e.angle&&d&&d({robotMatrix:T.getMatrix(),axis:(new n.Vector3).copy(e.axis),rotationAngle:e.angle,from:"robot",kind:"rotation",event:e.event}),m.render({forceDynamicMode:!0})}function le(e){J(!0),ee(),"LineTranslationEnd"===e.eventChannel?S&&(S.endManipulation(),S.display()):"RotationEnd"===e.eventChannel&&B&&(B.endManipulation(),B.display()),P=!1,f&&f({robotMatrix:T.getMatrix(),from:"robot",axis:(new n.Vector3).copy(e.manipulator.axis),kind:"LineTranslationEnd"===e.eventChannel?"translation":"rotation",event:e.event}),q(!0),m.render({forceDynamicMode:!0})}function se(){_||(_=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(e,n){T&&((S=new e(x,{displayOrigin:!1,offset:l,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:w})).setVisibilityFree(!0),G.push(S.subscribe("OriginManipulateBegin",ne)),S.onOriginManipulator=ie,G.push(S.subscribe("OriginManipulateEnd",te)),G.push(S.subscribe("RulerManipulateBegin",function(e){oe(e)})),G.push(S.subscribe("RulerManipulate",function(e){oe(e)})),G.push(S.subscribe("RulerManipulateEnd",function(e){oe(e)})),(B=new n(x,{radius:s,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0,lightDisplay:w})).setVisibilityFree(!0),I.push(B.subscribe("AngularRulerManipulateBegin",function(e){oe(e)})),I.push(B.subscribe("AngularRulerManipulate",function(e){oe(e)})),I.push(B.subscribe("AngularRulerManipulateEnd",function(e){oe(e)})))})),N||(N=a.givePreferenceManager({context:x}))&&(U=N.subscribe("onPreferencesChanged",function(){S&&S.getVisibleFlag()&&(S.unit=r.getCurrentUnit("length").unit,S.display()),B&&B.getVisibleFlag()&&(B.unit=r.getCurrentUnit("angle").unit,B.display())}))}function ue(e){b&&b({event:e.event}),m.setCursor("pointer"),P=!0,J(!1),T.arrowX.mat.opacity=.2,T.arrowY.mat.opacity=.2,T.arrowZ.mat.opacity=.2,T.translationPlaneYZ.planeMat.opacity=.2,T.translationPlaneXY.planeMat.opacity=.2,T.translationPlaneXZ.planeMat.opacity=.2,T.rotationArcYZ.planeMat.opacity=.2,T.rotationArcXZ.planeMat.opacity=.2,T.rotationArcXY.privilegedPlaneMat.opacity=.2,Z=T.getMatrix(),j=new n.Plane(m.currentViewpoint.getSightDirection()),se()}T.snapTranslationCallback=function(e){var n=e.translationVector;if(S){var i=S.getSnappedTranslationVector(e);0===i.returnCode&&(n=i.snappedTranslationVector)}return n},T.snapRotationCallback=function(e){var n={value:180*e.angle/Math.PI,axis:e.axis};if(K.direction.dot(e.axis)<0&&(n.value=360-n.value),B){var i=B.getSnappedRotationValue(e);0===i.returnCode&&(n={value:i.snappedRotationAngle,axis:i.axis})}return n};var ce=!1;z.push(T.subscribe("LineTranslationBegin",function(e){re(e)})),z.push(T.subscribe("RotationBegin",function(e){re(e)})),z.push(T.subscribe("ScalingBegin",function(e){re(e)})),z.push(T.subscribe("PlaneTranslationBegin",function(e){re(e)})),z.push(T.subscribe("LineTranslationManipulation",function(e){ae(e)})),z.push(T.subscribe("RotationManipulation",function(e){ae(e)})),z.push(T.subscribe("ScalingManipulation",function(e){ae(e)})),z.push(T.subscribe("PlaneTranslationManipulation",function(e){ae(e)})),z.push(T.subscribe("LineTranslationEnd",function(e){le(e)})),z.push(T.subscribe("RotationEnd",function(e){le(e)})),z.push(T.subscribe("ScalingEnd",function(e){le(e)})),z.push(T.subscribe("PlaneTranslationEnd",function(e){le(e)})),z.push(T.subscribe("ScreenPlaneTranslationBegin",function(e){ue(e)})),z.push(T.subscribe("ScreenPlaneTranslationManipulation",function(e){!function(e){q(),Q(),m.setCursor("pointer"),v&&v({event:e.event});var n=T.getMatrix().setPosition(e.intersection.ray.intersectPlane(j));if(c){var i=c({event:e.event,viewer:m});W=i&&i.robotMatrix.clone()}T.setRobotMatrix(W||n),m.render({forceDynamicMode:!0})}(e)})),z.push(T.subscribe("ScreenPlaneTranslationEnd",function(e){!function(e){P=!1,J(!0),ee(),Q(),$(),T.setRobotMatrix(W||Z);var i=T.getMatrix(),t=(new n.Vector3).getPositionFromMatrix(i);H.origin=t,H.initOrigin=t.clone(),H.baseOrigin=t.clone(),M&&M({event:e.event}),q(!0),m.render({forceDynamicMode:!0})}(e)})),A=t.subscribe({event:"/VISU/"},function(e){R&&("@onViewpointBeginMove"===e.eventType?ce=!0:"@onViewpointChange"===e.eventType?ce&&(T.setVisibility(!1),m.render({forceDynamicMode:!0})):"@onViewpointEndMove"===e.eventType&&(T.setVisibility(!0),ce=!1,m.render({forceDynamicMode:!0})))}),this.setPosition=function(e){if(!P){if(!e||!e.robotMatrix&&!e.translationRulerOrigin)throw new Error("No valid positions defined!");var i,t;e.robotMatrix&&(i=e.robotMatrix.clone(),t=(new n.Vector3).getPositionFromMatrix(i),T.setRobotMatrix(i),H.origin=t,H.initOrigin=t.clone(),H.baseOrigin=t.clone(),S&&(S.initOrigin=H.initOrigin,S.origin=H.origin)),e.translationRulerOrigin?H.origin3D=e.translationRulerOrigin.clone():null===e.translationRulerOrigin&&(H.origin3D=null),se(),e.doNotResetRuler||$(),q(),m.render({forceDynamicMode:!0})}},this.setVisibility=function(e){if("boolean"!=typeof e)throw new Error("Argument must be a boolean");R=e,T.setVisibility(e),q(!0)},this.destroy=function(){z.forEach(T.unsubscribe,T),z=null,t.unsubscribe(A),A=null,N&&(U=N.unsubscribe(U)),N=U=null,m.removeNode(T),Q(),S&&G.forEach(S.unsubscribe,S),B&&I.forEach(B.unsubscribe,B),T=x=m=null,S=B=null}}})});