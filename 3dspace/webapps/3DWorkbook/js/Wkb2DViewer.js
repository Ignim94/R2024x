define("DS/3DWorkbook/js/Wkb2DViewer",["UWA/Core","DS/CoreEvents/ModelEvents","DS/UIKIT/Mask","DS/UIKIT/Tooltip","DS/ApplicationFrame/FrameWindow","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/views/Wkb2DOrientationViewer","DS/DELMOMWKIExperience/js/WkiStreamUtil","DS/DELMOMWKIExperience/js/IndexFileParser","DS/DELMOMWKIExperience/js/WkiContentJsonParser","DS/DELMOMViewComponents/DELSlidesController","DS/3DWorkbook/js/WkbPinchZoomGesture","DS/3DWorkbook/js/Wkb2DPanController","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,i,n,o,s,r,a,l,u,c,d,m,v){"use strict";var g,w,p,f,D,h=null,b=null,E=null,S=!1;let k=!1;var y,C,I=null,V=0,M=!1;let A=0,W=0;var x=null,O=null,F=!1,P=null,L={},U=[],j=null,T=null;let z=null;var B=null;const R=1908/1057;function N(){const e={ematrixURL:g,securityContext:widget.getValue("collabSpace"),systemPID:w,modelEvtManager:D,wkiStreamUtil:b};B=new u(e)}var G=function(i){var n,o,r;(D=i.modelEvtManager||new t,S=!1,g=i.ematrixURL,f=null,p=null,x=i.widgetPreferences,k=i.displayMode===s.graphicsMode.Graphics2D,F=s.getPrefBoolValue(x,"showOrientationViewer"),null===h)&&(this.initOrientationView(),n=D.subscribe({event:"wkbNav-SelectOper"},function(e){K(e)}),U.push(n),n=D.subscribe({event:"wkbHeader-SelectOper"},function(e){K(e)}),U.push(n),n=D.subscribe({event:"wkbHeader-SelectOrder"},function(e){f="",N(),J(),A=0}),U.push(n),n=D.subscribe({event:"wkbMain-Remove2D"},J),U.push(n),n=D.subscribe({event:"wkbMain-GraphicsChanged"},function(t){"2D"===(p=t.mode)&&("SYSTEM"===t.object_type?V=0:(!function(t){p="2D",S=!0,e.is(t)&&_(t)}(I),V>0&&V!==W&&e.is(E)&&(M=!0,E.setActiveSlide({id:"slide"+V}))),Z(),ce())}),U.push(n),n=D.subscribe({event:"wkbMain-NavSizeChanged"},q),U.push(n),n=D.subscribe({event:"wkbMain-DetailSizeChanged"},q),U.push(n),n=D.subscribe({event:"ViewChanged"},function(e){V=e.ID,A=e.ID}),U.push(n),n=D.subscribe({event:"wkbDetails-InstructionSelected"},$),U.push(n),n=D.subscribe({event:"wkbNav-SystemLoaded"},()=>{const t="2D"===s.getPreferenceValue(x,"defaultViewType");if("firstoperation"===s.getPreferenceValue(x,"loadLevel")&&(t||k)){const t=document.getElementById("navListDiv").getChildren();e.is(t)&&t.length>0&&t[0].getChildren()[0].click()}}),U.push(n));return this.setContainer(),w=i.systemPhysicalId,e.is(i.wkiStreamUtil)?b=i.wkiStreamUtil:(o=w,r={serverURL:g,securityContext:widget.getValue("collabSpace"),PID:o,serverRequestTimeoutMS:s.serverRequestTimeoutMS,modelEvtManager:D},b=new a(r)),N(),this.wkiStreamUtil=b,this};function H(){if(e.is(h)){var t=h.getElement("#docContainer");if(e.is(t)){var i=h.getElement("#twoDViews");e.is(i)&&t.removeChild(i)}}}function K(e){A=0,H(),L={},I=e,f="",S&&_(e)}function _(t){if(e.is(h)){var n={object_type:"OPERATION",object_data:t.object_data};q(n),"3D"!==p&&(i.mask(h),function(e){S?Z():J();var t=e.object_data.id;t?X(t,e.object_data.physicalId):(Q(),i.unmask(h))}(n))}}function q(e){ce(),D.publish({event:"wkbNavPanel-resize",data:null})}function Z(){S=!0,null!==h&&h.setStyle("display","")}function J(){S=!1,null!==h&&(h.style.display="none")}function $(e){if(S){const t=new CustomEvent("DELMOMSELECTLINKEDVIEWS",{detail:{wkiInstPIDs:[e.pid],activateView:!0}});document.dispatchEvent(t)}}function Y(){var t,i,n;(t=h.getElement("#msgDiv"))&&h.removeChild(t),i=h.getElement("#controlGroupDiv"),e.is(i)&&i.hide(),n=h.getElement("#docContainer"),e.is(n)&&n.setStyle("display","none")}function Q(){var t=h.getElement("#msgDiv");e.is(t)||((t=s.createAndAppend(h,"div","msgDiv","msgDiv")).textContent=v.No2DFoundMsg)}function X(t,n){if(t!==f){var o=performance.now();widget.Debug.log("************** Begin load2DImages"),Y(),f=t;var s=l.getOperation2DViews(t);widget.Debug.log(`************** Time to load2DImages: ${(performance.now()-o)/1e3} seconds.`),e.is(s)&&s.length>0?b.getImageUrlForViews(s,se,!1):se()}else i.unmask(h)}var ee=function(t){if(e.is(t)){var i=h.getElement("#img0");e.is(i)&&(i.style.opacity=1,s.fadeInOutImage(i,t,"contain"),ce())}};function te(){var t;widget.getValue("hide2DMagnifierBar")||(t=h.getElement("#controlGroupDiv"),e.is(t)&&t.show())}function ie(){e.is(C)&&(C.destroy(),C=null),e.is(y)&&(y.dispose(),y=null),e.is(E)&&(E.clean(),E=null)}function ne(t){var i=h.getElement("#docContainer");e.is(i)||(i=s.createAndAppend(h,"div","imageDiv","docContainer")),0===h.offsetWidth&&40,ie(),C=s.createAndAppend(i,"div","twoDViews","twoDViews");s.createAndAppend(C,"div","docImage","img0");ee(t.image2DFiles[0]),function(t,i){var n,o=[];for(n=0;n<t.image2DFiles.length;n++){var s={};s.name=t.viewNames[n],s.preview=t.image2DFiles[n],s.uuid=t.UUIDs[n],o.push(s)}e.is(E)&&E.clean(),(E=new c(i)).displayPanel(o,B.wkiContent,A)}(t,{frameWindow:y=new o({context:"twoDViewsFrame",workbench:"",workbenchModule:"",height:"100%",viewerOptions:{multiViewer:!0},uiOptions:{displayActionBar:!1,displayTree:!1,displayImmersiveFrame:!0}}).inject(C),thumbnailListTitle:v.ViewsLbl,twoDView:!0,activateSlide:!1,beforeApplySlideCB:()=>{},afterApplySlideCB:(t,i,n)=>{if(e.is(i)&&(!t||t.id!==i.id)){ee(i.preview),F&&function(t){if(e.is(L[t.id])&&L[t.id].length>0)P.loadImage(L[t.id]);else{var i=l.getOrientationFile(f,t.id);e.is(i)?b.getExtendedStreamImageUrl(i,function(e){P.loadImage(e),L[t.id]=e}):console.log("2D orientation image missing")}}(i),M||D.publish({event:"ViewChanged",data:{ID:i.id,Name:i.name,From:0}});var o=document.createEvent("CustomEvent");o.initCustomEvent("DELMOMVIEWSELECTED2D",!1,!1,{viewName:i.name,viewID:i.id,uuid:i.uuid,isUserClicked:n}),window.dispatchEvent(o),M=!1,W=i.id}}})}function oe(t){var i=h.getElement("#twoDViews");e.is(i)||(ne(t),function(e){if(F){var t={config:O,immersiveFrame:y.getImmersiveFrame()};P=new r(t)}}())}async function se(t){var n;e.is(t)&&null!==t.image2DFiles&&0!==t.image2DFiles.length?(te(),n=h.getElement("#docContainer"),e.is(n)&&n.setStyle("display",""),de(),de(),await B.loadFile(f),oe(t)):Q(),i.unmask(h)}function re(e,t,i,n){switch(e){case"removeImageDiv":return H();case"load2DImages":return X(t);case"dispose":return me();case"zoomReset":return ce();case"zoomIn":return le();case"zoomOut":return ue();case"getSlidesController":return E;case"setContentJsonParser":B=t;break;default:return null}}function ae(t){var i=h.getElement("#twoDViews");if(e.is(i)){var n=i.getElement("#img0");if(e.is(n)){var o,s=0,r=i.clientHeight,a=i.clientWidth;R>a/r?((o=n.clientWidth*t)<a&&(o=a),s=o/R):((s=n.clientHeight*t)<r&&(s=r),o=s*R);var l=parseFloat(n.style.top),u=parseFloat(n.style.left),c=r/2,d=a/2,m=c-(c-l)/n.clientHeight*s,v=d-(d-u)/n.clientWidth*o;n.setStyle("width",o),n.setStyle("height",s),n.setStyle("top",m),n.setStyle("left",v)}}}function le(){ae(1.2)}function ue(){ae(.8)}function ce(){var t=h.getElement("#twoDViews");if(e.is(t)){var i=t.getElement("#img0");if(e.is(i)){var n,o=0,s=t.clientHeight,r=t.clientWidth;R>r/s?o=(n=r)/R:n=(o=s)*R,i.setStyle("width",n),i.setStyle("height",o),i.setStyle("top",(s-o)/2),i.setStyle("left",(r-n)/2)}}}function de(){var e=h.getElement("#controlGroupDiv");h.getElement("#docContainer").style.height=`${h.clientHeight-e.clientHeight}px`}function me(){e.is(z)&&(z.disconnect(),z=null),e.is(j)&&(j.destroy(),j=null),e.is(T)&&(T.destroy(),T=null),e.is(b)&&e.is(b.dispose)&&(b.dispose(),b=null),L=null,U.forEach(e=>D.unsubscribe(e)),U=[],h=null,ie()}return G.prototype={setContainer:function(){if(null===h){h=e.createElement("div",{id:"docDiv",class:"mainDocContainer"});var t=s.createAndAppend(h,"div","controlGroupDiv","controlGroupDiv"),i=s.createAndAppend(t,"div","controlsDiv","zoomControls");"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?j=new d({element:h}):T=new m({element:h});var o=s.createAndAppend(i,"div","wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-zoom-in zoomButtons","zoomin");o.onclick=function(){le()},new n({target:o,body:v.ZoomIn,position:"bottom",trigger:"hover focus"});var r=s.createAndAppend(i,"div","wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-zoom-out zoomButtons","zoomout");r.onclick=function(){ue()},new n({target:r,body:v.ZoomOut,position:"bottom",trigger:"hover focus"});var a=s.createAndAppend(i,"div","wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-reset zoomButtons","reset");a.onclick=function(){ce()},new n({target:a,body:v.Reset,position:"bottom",trigger:"hover focus"});var l=s.createAndAppend(h,"div","imageDiv","docContainer");(z=new ResizeObserver(q)).observe(l),h.testFunction=re}else h.style.display=""},getContainer:function(){return h},setPreferences:function(e){x=e,F=s.getPrefBoolValue(x,"showOrientationViewer"),this.initOrientationView()},initOrientationView:async function(){if(F){var e=g+"resources/wkb/invoke/v1/orientationViewConfig";O=await s.serverRequestPromise(e,"json","GET","")}else O=null},dispose:me,testFunction:re,testFunctionAsync:async function(e,t){switch(e){case"processImages":return se(t);default:return null}}},G});