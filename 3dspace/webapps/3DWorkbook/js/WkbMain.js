define("DS/3DWorkbook/js/WkbMain",["UWA/Core","UWA/Class","UWA/Controls/Lightbox","DS/UIKIT/Mask","DS/CoreEvents/ModelEvents","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADUtilsServices","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/3DWorkbook/js/WkbAppConfig","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/WkbNavPanel","DS/3DWorkbook/js/WkbDetails","DS/3DWorkbook/js/WkbSearch","DS/3DWorkbook/js/WkbHeaderPanel","DS/3DWorkbook/js/Wkb2DViewer","DS/3DWorkbook/js/Wkb3DViewer","DS/3DWorkbook/js/WkbWidgetCom","DS/3DWorkbook/js/WkbNavController","DS/3DWorkbook/js/models/WkbAttributeConfig","DS/3DWorkbook/js/models/WkbCapableResourceDS","DS/3DWorkbook/js/models/WkbPublishDataDS","DS/3DWorkbook/js/models/WkbLastIndexDateDS","DS/3DWorkbook/js/models/WkbMRUList","DS/3DWorkbook/js/models/WkbDataStore","DS/3DWorkbook/js/views/WkbProcessFlowDiagram","DS/3DWorkbook/js/views/WkbHomePage","DS/3DWorkbook/js/views/WkbConfirmModal","DS/3DWorkbook/js/views/WkbMainView","DS/3DWorkbook/js/WkbDefaultConfig","DS/DELMOMWKIExperience/js/WkiStreamUtil","DS/DELMOMWKIExperience/js/IndexFileParser","i18n!DS/3DWorkbook/assets/nls/3DWorkbook","css!DS/WelcomeScreenView/afr-welcome-screen.css"],function(e,t,i,n,s,o,a,r,d,l,c,u,b,g,f,D,m,h,p,w,k,v,y,S,P,W,M,C,I,R,x,E,L){"use strict";var N,j,O,V,U,T,A,z,_,F="",B=null,H=null,q=null,K=null;let Q;var G={},J=!1,X=!1,Y=null,$=null,Z=[],ee=[],te=null,ie=null,ne=!1,se=null,oe=null,ae=function(t){document.removeEventListener("keydown",ae);var i=document.querySelector(".button-primary.button-all.button-alert");e.is(i)&&i.click()},re=function(t,i){var n=e.createElement("button",{class:"button-primary button-all button-alert"});n.style.cursor="default",n.type="submit",n.value="Ok",n.textContent=L.GeneralOKLbl,n.onclick=function(){i.close()},n.inject(t),c.createAndAppend(t,"p","clear")},de=function(t,i,n,s){var o=e.createElement("div",{class:"alertWindow"}),a=e.createElement("div",{class:"fonticon fonticon-alert alertWindowTitleImg",styles:{"font-size":"40px"}}),r=e.createElement("div",{class:"alertWindowTitle"});r.textContent=n,a.inject(o),r.inject(o);var d=e.createElement("div",{class:"alertMsg",id:"AlertWindowMsg"+i});d.innerHTML=c.getAlertMessageBody(s),d.inject(o),re(d,t);var l=widget.body.getElement(".alert"+i);o.inject(l),document.addEventListener("keydown",ae)},le=function(e,t,n,s){var o="alert"+e,a=widget.body.getElement("."+o);a&&a.destroy();var r=new i({closeable:!1,className:o+" alertOverlay",exclusive:1===s});r.onOpen=function(){de(r,e,t.name,n),c.createAndAppend(r.elements.container,"p","clear")},r.fxOptions={fade:.5},r.inject(widget.body),r.open()},ce=function(t,i,n,s,o){e.is(o)||(o=!1),e.is(s)||(s="error");var a={level:s,title:t,subtitle:i,message:n,sticky:o};window.notifs.addNotif(a)},ue=function(){l.load(A,F).then(function(){var t;t=l.getAttributeConfig(),e.is(t)&&Object.entries(t).length>0?w.setConfig(t):w.setConfig(R),we(l.getWebRequestTimeout()),ie=l.getOrientationViewConfig()})},be=function(t){e.is(te)&&(te.destroy(),te=null);var i=ve.getProcessFlowDiv();i.children.length>0&&i.setContent("");var n={widget:"WKB",systemPID:t.object_data.systemPID,parentElement:i};te=new W(n),n={filterQuery:se,objectId:t.object_data.systemPID},te.update(n)};function ge(t,i){var n="";i=e.is(i)?i:"invalid backend response",console.log(`LOAD SYSTEM ERROR: ${t}, backend response: ${i}`);var s="LOAD SYSTEM ERROR: ";e.is(i)&&i.includes("No licenses are reserved for the given app")?s+=L.NoLicenseErrorMsg:s+=i,widget.Debug.debugMode&&(n=t.message);const o={src:"wkbMain",title:L.ErrorTitle,subtitle:L.ErrSystemWebService,message:n,type:"error"};ce(o.title,o.subtitle,o.message,o.type,!1),h.publishLoadError(s)}function fe(){return{serverURL:F,securityContext:c.getSecurityContext(),modelEvtManager:A}}async function De(e,t){const i=new v(fe());let n=null;return n=t?await i.getPublishedDataByIndex(e):await i.getPublishedData(e)}async function me(){const t=await De(_.physicalId,!1);if(e.is(t)&&e.is(t.modified,"string")&&t.modified.length>0){const e=c.parseModifiedDate(t.modified),i=new Date(e);return _.lastPublishModified=i.toLocaleString(),await async function(){return new y(fe()).getLastIndexDate()}()<i?L.PublishedIndexDateTimeConfirm:""}return _.noPublishedData=!0,L.PublishedNoDataConfirm}function he(e,t){console.log("**********************************Config panel closed****")}function pe(t){n.mask(widget.body),se="",oe=null,e.is(t.CVQuery3D)&&e.is(t.CVQuery3D.union)&&e.is(t.CVQuery3D.union.expand3d)&&t.CVQuery3D.union.expand3d.length>0&&(se=t.CVQuery3D.union.expand3d[0].config_filter,t.CVQuery3D.union.expand3d[0].config_filter_id&&(oe=t.CVQuery3D.union.expand3d[0].config_filter_id.physical_id)),(e.is(se)&&se.length>0||e.is(oe))&&(o.publish("Frame3DXInfra.Close"),e.is(_)&&P.loadConfiguredSystem(_.physicalId,se,oe).then(function(){j.loadDelmiaPlayerSystem(),n.unmask(widget.body)}))}var we=function(t){var i=c.getPreferenceValue(z,"requestTimeout");c.setServerRequestTimeout(i),e.is(t)&&""!==t&&(i=parseInt(t))>=0&&(c.setServerRequestTimeout(i),ne=!0)},ke=function(e){($=new M({wkbSearch:Y,ematrixURL:F,modelEvtManager:A})).inject(e)},ve=null;return t.extend({init:function(e){this.isRefreshingWKB=!1,e=e||{},widget.Debug.log("************** WbkMain Start Init"),A=new s,window.notifs=r,d.setNotificationManager(window.notifs),V=e.url,U=V.substr(0,V.indexOf("3DWorkbook")+11),e.title="3D Workbook",this.options=e,this._parent(e),z=e.preferences;var t=c.getPreferenceValue(z,"requestTimeout");if(c.setServerRequestTimeout(t),widget.setBody(""),N=e.widget_id,ve=new I(e),this.resetSubscriptions(),this.loadSearchAnd3DSpaceURL(e),p.isInitialized)p.setEventManager(A);else{const e={modelEvtManager:A};p.init(e)}var i={wkbMain:this,wkbDetails:H,wkb3DViewer:j,wkbNavPanel:B,wkbHeader:q,modelEvtManager:A};h.init(i),this.subscribeToApplyConfiguration(),widget.Debug.log("************** WbkMain End Init")},subscribeToApplyConfiguration:function(){var e=o.subscribe("onApplyNGFilter/"+widget.id,pe);ee.push(e),o.subscribe("Frame3DXInfra.onPanelClose",he)},loadSearchAnd3DSpaceURL:function(t){c.get3DSpaceURL(function(i){F=i,G={role:c.getPreferenceValue(z,"collabSpace"),container:t.widgetBody,widget_id:t.widget_id,ematrixURL:F,modelEvtManager:A},Y=new g(G);var n=widget.getValue("X3DContentId");e.is(n)?function(t,i,n){var s=0,o=function(){s+=1,e.is(c.getSecurityContext())?(s<10&&i.onSelectedObjectsSearch(t),s=10):s<10?setTimeout(function(){o()},300):n.publish({event:"wkbMain-PreloadFailed",data:{}})};o()}(n,Y,A):ke(t.widgetBody),ue(),P.init({modelEvtManager:A})})},executeSearch:function(t){e.is(Y)||(Y=new g(G)),Y.launchSearch(t)},resetSubscriptions:function(){Z.forEach(function(e){A.unsubscribe(e)}),Z=[];var t=this,i=A.subscribe({event:"wkbSearch-DataFound"},function(e){t.onSystemSelected(e)});Z.push(i),i=A.subscribe({event:"wkiStreamUtil-Notify"},function(e){ce(L.ErrorTitle,e.subtitle,e.message,"error",!1)}),Z.push(i),i=A.subscribe({event:"wkbMain-PreloadFailed"},function(e){ke(widget.body)}),Z.push(i),i=A.subscribe({event:"wkbMain-ShowProcessFlow"},be),Z.push(i),i=A.subscribe({event:"wkbNotify"},function(e){ce(e.title,e.subtitle,e.message,e.type,e.isVanishes)}),Z.push(i),i=A.subscribe({event:"wkbDetails-Alert"},function(e){t.onAlert(e)}),Z.push(i),i=A.subscribe({event:"wkbHeader-Select2D"},function(e){t.onSelect2D3DMode(e,"2D")}),Z.push(i),i=A.subscribe({event:"wkbHeader-Select3D"},function(e){t.onSelect2D3DMode(e,"3D")}),Z.push(i),i=A.subscribe({event:"wkbHeader-SelectHome"},function(t){ve.hide(),e.is($)?$.show():ke(widget.body)}),Z.push(i),i=A.subscribe({event:"wkbHomePage-Open"},function(e){t.onSelectMRUItem(e)}),Z.push(i),i=A.subscribe({event:"wkbHomePage-SelectOpenButton"},function(e){Y.activateSearchContext()}),Z.push(i),i=A.subscribe({event:"wkb3DViewer-DelViewerSetProcessComplete"},function(e){B.loadOperations().then(function(){"firstoperation"===widget.getValue("loadLevel")&&B.selectFirstOperation()})}),Z.push(i)},onRefresh:function(e){z=e},endEdit:function(t){if(z=t,e.is(j)&&j.setPreferences(t),e.is(O)&&O.setPreferences(t),!ne){var i=c.getPreferenceValue(z,"requestTimeout");c.setServerRequestTimeout(i)}var n=widget.getValue("PrefVolumeOffsetLbl");n=parseInt(n),isNaN(n)&&widget.setValue("","50"),(new S).refresh(),e.is($)&&$.refreshMRU(),c.updateWidgetTranslatorSetting()},closeDetailsPanel:function(){ve.closeDetailsPanel()},openDetailsPanel:function(){ve.openDetailsPanel()},closeNavPanel:function(){ve.closeNavPanel()},openNavPanel:function(){ve.openNavPanel()},onNavSizeChange:function(){setTimeout(function(){A.publish({event:"wkbMain-NavSizeChanged",data:{}})},500)},onDetailSizeChange:function(){setTimeout(function(){A.publish({event:"wkbMain-DetailSizeChanged",data:{}})},500)},getSystemData:function(){return _},resetWKB:function(e){e.resetSubscriptions(),e.destroy(),Y=new g(G)},onSelectMRUItem:function(t){var i=this;if(!e.is(t))return;n.mask(widget.body);let s=t.id,o=null;const a=t.id.split(",");a.length>1&&(s=a[0],o=a[1]);var r=F+"resources/wkb/invoke/v1/system?pid="+encodeURIComponent(s);c.getServerData(r,function(n){if(e.is(o)){const e=JSON.parse(n);e.headerOperationName=t.title,e.headerOperationPhysicalId=o,i.onSystemSelected(JSON.stringify(e))}else i.onSystemSelected(n)},ge,"text"),c.updateMRUListItem(t)},onSystemSelected:async function(t,i){var s=this;e.is(i)||(i=function(){});var o={container:widget.body,okButtonText:L.PublishedConfirmOkButtonText,koButtonText:null,className:"confirmModalMsg"};n.mask(widget.body),d.removeNotifications(),Q=_,(_=JSON.parse(t)).lastPublishModified="";var a=function(t){if(!t)return n.unmask(widget.body),_=null,Q=null,void i();P.loadData(_.physicalId).then(async function(t){if(!t)return _=Q,n.unmask(widget.body),void i();P.setSystemLastPublishModified(_.lastPublishModified);var o=await P.getSystem();if(!e.is(o))return n.unmask(widget.body),void i();if(o.isForDelmiaViewer){var a;if(0===(a=P.getScopedMfgItem()).length)return console.log("No scoped mfg item exists."),void i();if(a.length>1)return console.log("Too many scoped mfg item exists: "+a.length),void i();o.scopedMfgItemPID=a[0];var r=await P.isConfigured();o.isConfigured=r,_.isConfigured=r,s.loadWidget(_,i)}else s.loadWidget(_,i)})};(o.message="",widget.getValue("publishedDataCheck")?o.message=await me():await async function(){const t=await De(_.physicalId,!0);if(e.is(t)&&e.is(t.modified,"string")&&t.modified.length>0){const e=new Date(c.parseModifiedDate(t.modified));_.lastPublishModified=e.toLocaleString()}else _.lastPublishModified="",_.noPublishedData=!0}(),o.message.length>0)?new C(o).confirm(a):a(!0)},loadWidget:async function(t,i){var s=this,o=performance.now(),a=c.graphicsMode.Graphics3D,r=!1,d=!1;_=t;let l=await P.getSystem();if(e.is(l)){if(e.is(_.headerOperationName)&&e.is(_.headerOperationPhysicalId)&&(l.headerOperationName=_.headerOperationName,l.headerOperationPhysicalId=_.headerOperationPhysicalId),_.noPublishedData)return s.buildWidget(l),await B.loadOperations(),e.is(i)&&i(),void n.unmask(widget.body);var u={serverURL:F,securityContext:c.getSecurityContext(),PID:l.physicalId,serverRequestTimeoutMS:c.serverRequestTimeoutMS,modelEvtManager:A};K=new x(u);try{K.readIndexFile(async function(t){if(e.is(t))n.unmask(widget.body);else{if(e.is(E.mappingFile)&&(r=E.threeDXmlExists),(d||r)&&(d=!0),a=E.displayMode,s.resetWKB(s),l.displayMode=a,l.threeDXmlExists=r,l.threeDViewerDataExists=d,l.unitPID=_.unitPID,l.isForDelmiaViewer){l.threeDViewerDataExists=!0,l.scopedResourcePID=await async function(e){return new k(fe()).getCapableResource(e)}(_.physicalId),s.buildWidget(l),j.loadSystem({object_data:l,object_type:"SYSTEM"},!0),_.isConfigured||await B.loadOperations(),e.is(i)&&i(),n.unmask(widget.body);var u=performance.now();widget.Debug.log(`************** Time for onSystemSelected: ${(u-o)/1e3} seconds.`)}else e.is(_.publishedProductId)&&_.publishedProductId.length>0&&(l.publishedProductId=_.publishedProductId,d=!0,l.threeDViewerDataExists=d),s.buildWidget(l),await B.loadOperations(),l.displayMode!==c.graphicsMode.Graphics2D?j.loadSystem({object_data:l,object_type:"SYSTEM"},!0):j.setSelectedSystem({object_data:l,object_type:"SYSTEM"}),e.is(i)&&i(),n.unmask(widget.body);n.unmask(widget.body)}},!1)}catch(e){n.unmask(widget.body)}}else n.unmask(widget.body)},loadSystem:function(t,i){var n=this,s=performance.now();J=!1,e.is(t.breadcrumbDisabled)&&(J="true"===t.breadcrumbDisabled.toLowerCase()),X=!1,e.is(t.hideOperPanel)&&(X="true"===t.hideOperPanel.toLowerCase());var o=F+"resources/wkb/invoke/v1/system?pid="+encodeURIComponent(t.sysPID)+"&plmExternalId="+encodeURIComponent(t.sysPLMID)+"&revision="+encodeURIComponent(t.sysRevision)+"&title="+t.sysTitle;c.getServerData(o,function(e){var a=(performance.now()-s)/1e3;widget.Debug.log(`************** Time for loading ${o}: ${a} seconds.`);var r=JSON.parse(e);r.unitPID=t.unitPID,n.onSystemSelected(JSON.stringify(r),i)},ge,"text")},onSelect2D3DMode:function(t,i){var n={modelEvtManager:A,appURL:U,ematrixURL:F,widgetPreferences:z,widget_id:N,name:t.id,systemRefName:t.systemRefName,systemPhysicalId:t.systemPhysicalId};A.publish({event:"2D"===i?"wkbMain-Remove3D":"wkbMain-Remove2D",data:{}}),ve.headerDocking.freeZoneContent=null,e.is(O)||(O=new D(n)),e.is(j)||(j=new m(n));var s=j.getContainer(),o=O.getContainer(),a=e.createElement("div",{id:"playerGroupDiv",class:"playerGroupDiv"});s.inject(a),o.inject(a),ve.headerDocking.freeZoneContent=a;var r=t.object_type,d={physicalId:t.PID,parentType:t.parent_type,id:t.id,systemPhysicalId:t.systemPhysicalId,publishedProductId:t.publishedProductId};A.publish({event:"wkbMain-GraphicsChanged",data:{object_type:r,object_data:d,mode:i}})},onAlert:function(e){var t;for(t=e.length-1;t>-1;t--)le(t,e[t],e[t].text,e.length)},getAppURL:function(){return U},publishWidgetLoaded:function(e){h.publishWidgetLoaded(e)},getEventManager:function(){return A},destroy:function(){se=null,oe=null,e.is(te)&&(te.destroy(),te=null),e.is($)&&($.destroy(),$=null),e.is(j)&&(T=j.getCtx(),j.dispose()),A.publish({event:"wkbMain-Remove2D",data:{}}),e.is(O)&&(O.dispose(),O=null),e.is(Y)&&e.is(Y.onDestroy)&&(Y.onDestroy(),Y=null),e.is(H)&&(H.dispose(),H=null),e.is(B)&&B.dispose(),e.is(q)&&q.dispose(),e.is(ve)&&(ve.removeLeftDockingListener("collapse",this.onNavSizeChange),ve.removeLeftDockingListener("expand",this.onNavSizeChange),ve.removeLeftDockingListener("dockResize",this.onNavSizeChange),ve.removeRightDockingListener("collapse",this.onDetailSizeChange),ve.removeRightDockingListener("expand",this.onDetailSizeChange),ve.removeRightDockingListener("dockResize",this.onDetailSizeChange),ve.destroy()),e.is(void 0)&&(void 0).dispose()},userRoleError:function(){console.log("3DWorkbook user role error occurred")},hideDropContainer:function(){this.dropDiv.setStyle("display","none")},showDropContainer:function(){this.dropDiv.setStyle("display","flex")},buildWidget:function(t,i){i=i||{};var n={ematrixURL:F,system:t,systemPhysicalId:t.physicalId,systemRefName:t.id,publishedProductId:t.publishedProductId,modelEvtManager:A,wkbWidgetCom:void 0,widgetPreferences:z,wkiStreamUtil:K};B=new u(n);var s={modelEvtManager:A,appURL:U,widgetPreferences:z,ematrixURL:F,systemData:t,wkiStreamUtil:K,isDelmiaViewer:t.isForDelmiaViewer};H=new b(s);var o={modelEvtManager:A,appURL:U,ematrixURL:F,widgetPreferences:z,widget_id:N,name:t.displayName,systemRefName:t.id,systemPhysicalId:t.physicalId,publishedProductId:t.publishedProductId,ctx:T,displayMode:t.displayMode,threeDViewerDataExists:t.threeDViewerDataExists,breadcrumbDisabled:J};q=new f(o);var a={modelEvtManager:A,ematrixURL:F,widgetPreferences:z,systemRefName:t.id,systemPhysicalId:t.physicalId,publishedProductId:t.publishedProductId,ctx:T,threeDViewerDataExists:t.threeDViewerDataExists,displayMode:t.displayMode,isDelmiaViewer:t.isForDelmiaViewer,wkiStreamUtil:K,orientationViewConfig:ie};j=new m(a),O=new D(a);var r=X;e.is(i.hideOperPanel)&&(r=i.hideOperPanel);var d={wkb3DViewer:j,wkb2DViewer:O,wkbHeader:q,wkbDetails:H.getElement(),onSelectedObjectsSearch:Y.onSelectedObjectsSearch,hideOperPanel:r,wkbNavPanel:B,onNavSizeChange:this.onNavSizeChange};ve.buildWidget(t,d),ve.addLeftDockingListener("collapse",this.onNavSizeChange),ve.addLeftDockingListener("expand",this.onNavSizeChange),ve.addLeftDockingListener("dockResize",this.onNavSizeChange),ve.addRightDockingListener("collapse",this.onDetailSizeChange),ve.addRightDockingListener("expand",this.onDetailSizeChange),ve.addRightDockingListener("dockResize",this.onDetailSizeChange);var l={wkbMain:this,wkbDetails:H.getElement(),wkb3DViewer:j,wkbNavPanel:B,wkbHeader:q};h.setPanels(l),p.setDetailsPanel(H),p.setNavPanel(B),console.log("******************Finished buildWidget")},insertAlertOkButton:function(e,t){re(e,t)},insertAlertWindow:function(e,t,i,n){de(e,t,i,n)},setWkb2DViewer:function(e){O=e},setWkb3DViewer:function(e){j=e},setWkbSearch:function(e){Y=e},getSocket:function(){return this.socket},onWkbRefresh:async function(){var t=this;if(!t.isRefreshingWKB){e.is(_)&&(t.isRefreshingWKB=!0,await t.onSystemSelected(JSON.stringify(_),function(){t.isRefreshingWKB=!1}))}}})});