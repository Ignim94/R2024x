define("DS/3DWorkbook/js/views/WkbInstructionListView",["UWA/Core","UWA/Class","DS/Controls/Expander","DS/CoreEvents/ModelEvents","UWA/Utils/Client","DS/UIKIT/Scroller","DS/3DWorkbook/js/views/WkbViewsUtils","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/WkbDCPlanCard","DS/3DWorkbook/js/views/WkbDataCollectListView","DS/3DWorkbook/js/views/WkbCustomAttributesView","DS/3DWorkbook/js/views/WkbDCPlanChildListHeaderView","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(t,e,i,n,s,a,l,o,c,r,h,d,u){"use strict";var g=null;const C="alert",D="instruction",f="signoff",m="dcplan",k="datacollect";return e.extend({init:function(t){g=t.modelEvtManager||new n,l.ModelEventManager=t.modelEvtManager,this.container=null,this.attributeConfig=t.attributeConfig,this.wkbDCPDataCollectListMap=new Map,this.currentDataCollectListView=null,this.cardList=[],this.scroller=null,this.buildSkeleton()},buildSkeleton:function(){this.container=t.createElement("div",{class:"WorkInstructionList",styles:{height:s.getSize().height-230+"px",display:"block","white-space":"pre-line"}}),this.mainList=t.createElement("div",{class:"MainInstructionList",styles:{height:s.getSize().height-230+"px",display:"block","white-space":"pre-line"}}),this.mainList.inject(this.container);var e={modelEvtManager:g};this.wkbDCPlanChildListHeaderView=new d(e),this.wkbDCPlanChildListHeaderView.inject(this.container),this.dataCollectLists=t.createElement("div",{class:"DataCollectLists",styles:{height:s.getSize().height-230+"px",display:"none","white-space":"pre-line"}}),this.dataCollectLists.inject(this.container),g.subscribe({event:"wkbDataCollectListView-DCItemClick"},this._onDCItemClick.bind(this))},_onDCItemClick:function(){this.unHighlightWkiItems()},hideMainList:function(){this.mainList.hide()},showMainList:function(){t.is(this.currentDataCollectListView)&&this.currentDataCollectListView.hide(),this.mainList.show()},hideDCChildList:function(){t.is(this.currentDataCollectListView)&&this.currentDataCollectListView.hide(),this.dataCollectLists.hide()},showDCChildList:function(e){this.hideMainList(),this.currentDataCollectListView=this.wkbDCPDataCollectListMap.get(e),t.is(this.currentDataCollectListView)&&this.currentDataCollectListView.show(),this.dataCollectLists.show()},showDCHeader:function(){this.wkbDCPlanChildListHeaderView.show()},hideDCHeader:function(){this.wkbDCPlanChildListHeaderView.hide()},updateDCHeaderTitle:function(t){this.wkbDCPlanChildListHeaderView.updateTitle(t)},hide:function(){this.container.hide()},show:function(){this.container.show()},inject:function(t){this.container.inject(t)},getContainer:function(){return this.container},scrollToFirstLinkedItem:function(){},highlightLinkedDCPDataCollect:function(t,e){const i=this.wkbDCPDataCollectListMap.get(t);i&&i.secondaryHighlightLinkedCard(e)},getCard:function(t){for(var e=null,i=0;i<this.cardList.length;i+=1)if((e=this.cardList[i]).getPID()===t)return e},unhighlightLinkedInstruction:function(e){var i=this.getCard(e);t.is(i)&&i.unhighlight()},secondaryHighlightLinkedInstruction:function(e){const i=this.getCard(e);t.is(i)&&i.secondaryHighlight()},highlightLinkedInstruction:function(e){const i=this.getCard(e);t.is(i)&&i.highlight()},highlightLinkedCards:function(e){var i=this;e.forEach(e=>{if(t.is(e.Instruction.Row)){i.highlightLinkedDCPDataCollect(e.Instruction.InstPhyID,e.Instruction.Row.RowPhyID);const n=i.cardList.find(t=>t.getPID()===e.Instruction.InstPhyID);t.is(n)&&n.secondaryHighlight()}else i.secondaryHighlightLinkedInstruction(e.Instruction.InstPhyID)})},highlightLinkedCardsByPID:function(e){if("DCROW"===e.type){for(const i of this.wkbDCPDataCollectListMap.values())if(i.highlightLinkedCard(e.pid)){const e=this.getCard(i.parentInstancePID);t.is(e)&&e.highlight()}}else this.highlightLinkedInstruction(e.pid)},unHighlightWkiItems:function(){t.is(this.container)&&this.cardList.forEach(function(t){t.unhighlight()})},unHighlightAllDataCollectItems:function(){for(const t of this.wkbDCPDataCollectListMap.values())t.unHighlightAllCards()},getHighlightedCards:function(){var e=[];return t.is(this.cardList)?(this.cardList.forEach(t=>{l.isCardSelected(t.element)&&e.push(t)}),e):[]},getHighlightedCardsPID:function(){const t=this.getHighlightedCards();var e=[];return t.forEach(t=>{e.push(t.getPID())}),e},unhighlightAllCapableToolCards:function(){this.cardList.forEach(e=>{t.is(e.toolCards)&&e.toolCards.forEach(t=>{t.unhighlight()})}),t.is(this.currentDataCollectListView)&&this.currentDataCollectListView.unhighlightAllCapableToolCards()},resetList:function(){var t=this;this.cardList.forEach(function(e){e.removeOnClick(t._onWkiItemClick),e.destroy()}),this.cardList.length=0;for(const t of this.wkbDCPDataCollectListMap.values())t.clearTiles(),t.destroy();this.wkbDCPDataCollectListMap.clear(),this.currentDataCollectListView=null},loadCards:function(e){this._destroyScroll();var i=null,n=[];if(t.is(e)&&t.is(e.length)&&0!==e.length){for(let s=0;s<e.length;s++){switch(i=null,e[s].wkiType){case"DELWkiExecAlert":i=this._getAlertCard(e[s]),n.push(e[s]);break;case"DELWkiExecInstruction":i=this._getInstructionCard(e[s]);break;case"DELWkiExecDataCollect":i=this._getDataCollectCard(e[s]);break;case"DELWkiDataCollectPlanReference":e[s].children.length>0&&this._loadDataCollectCards(e[s]),i=this._getDataCollectPlanCard(e[s]);break;case"DELWkiExecSignOff":i=this._getSignOffCard(e[s])}t.is(i)&&(i.inject(this.mainList),this.cardList.push(i))}n.length>0&&g.publish({event:"wkbDetails-Alert",data:n}),this._addScroll(this.container,this.container.parentElement)}},syncToolHighlightToViewer:function(e,i){const n=this.container.querySelectorAll(".toolItem");t.is(n)&&l.doHighlight(n,e,i,!0)},syncHighlightToViewer:function(t,e){"REMOVE"===e?this.unhighlightLinkedInstruction(t):this.secondaryHighlightLinkedInstruction(t)},syncDCRowHighlightToViewer:function(e,i){if("REMOVE"===i){if(this.wkbDCPDataCollectListMap.size>0)for(const i of this.wkbDCPDataCollectListMap.values())if(i.unhighlightLinkedInstruction(e)){const e=this.getCard(i.parentInstancePID);t.is(e)&&e.unhighlight()}}else if(this.wkbDCPDataCollectListMap.size>0)for(const i of this.wkbDCPDataCollectListMap.values())if(i.secondaryHighlightLinkedInstruction(e)){const e=this.getCard(i.parentInstancePID);t.is(e)&&e.secondaryHighlight()}},addToolHighlightingData:function(t){if(l.addToolHighlightingData(this.cardList,t),this.wkbDCPDataCollectListMap.size>0)for(const e of this.wkbDCPDataCollectListMap.values())e.addToolHighlightingData(t)},_onWkiItemClick:function(t){const e=t.target.parentElement.className;if(e.indexOf("wux-controls-expander-container")>-1||e.indexOf("wux-controls-expander-header-container")>-1||e.indexOf("wux-controls-expander-header")>-1)return;if(l.isCardSelected(t.currentTarget))return;const i=t.currentTarget.dataset.id;g.publish({event:"wkbDetails-InstructionSelected",data:{pid:i,type:"WKIITEM",userSelect:!0}}),this.unHighlightWkiItems(),this.unHighlightAllDataCollectItems(),l.setCardStyleSelected(t.currentTarget)},_getAlertCard:function(e){var i,n=null,s="";t.is(e.documents)&&e.documents.length>0&&(n=l.getDocumentAttachmentElement(e.documents,e.displayName));var a=e.displayName+" - "+e.version,c=o.getAlertMessageBody(e.text);t.is(this.attributeConfig.alert)&&(s=h.getCustomAttributesElement(e,this.attributeConfig.alert).getHTML()),i="<div style='margin: 0;'>"+c+"</div>"+s;var r=l.getDetailCard(a,"alertItem wkiItem itemHover cardNoHighlight","fonticon fonticon-alert",i,n,!0);return r.type=C,r.setPID(e.instancePhysicalId),r.setOnClick(this._onWkiItemClick.bind(this)),t.is(e.capableResources)&&e.capableResources.length>0&&"capable"===widget.getValue("resType")&&l.insertCapableResources(e.capableResources,r,g,this.attributeConfig.tool),l.addDragElement(e,r.element),r},_getInstructionCard:function(e){var i="",n=t.createElement("div",{class:"",styles:{}});(t.is(e.documents)&&e.documents.length>0&&l.getDocumentAttachmentElement(e.documents,e.displayName).inject(n),t.is(this.attributeConfig.instruction))&&(i=h.getCustomAttributesElement(e,this.attributeConfig.instruction,!0).getHTML());var s=i,a=l.getDetailCard(e.displayName,"instructionItem wkiItem itemHover cardNoHighlight","fonticon fonticon-text",s,n,!0);return t.is(e.capableResources)&&e.capableResources.length>0&&"capable"===widget.getValue("resType")&&l.insertCapableResources(e.capableResources,a,g,this.attributeConfig.tool),a.setPID(e.instancePhysicalId),a.setOnClick(this._onWkiItemClick.bind(this)),a.type=D,l.addDragElement(e,a.element),a},_getSignOffCard:function(e){var i=null;t.is(e.documents)&&e.documents.length>0&&(i=l.getDocumentAttachmentElement(e.documents,e.displayName));var n=h.getCustomAttributesElement(e,this.attributeConfig.signoff),s=l.getDetailCard(e.displayName,"signoffItem wkiItem itemHover cardNoHighlight","fonticon fonticon-check",n.getHTML(),i,!0);return s.setPID(e.instancePhysicalId),s.setOnClick(this._onWkiItemClick.bind(this)),s.type=f,t.is(e.capableResources)&&e.capableResources.length>0&&"capable"===widget.getValue("resType")&&l.insertCapableResources(e.capableResources,s,g,this.attributeConfig.tool),l.addDragElement(e,s.element),s},_getDataCollectCard:function(e){var i=null;t.is(e.documents)&&e.documents.length>0&&(i=l.getDocumentAttachmentElement(e.documents,e.label));var n=h.getCustomAttributesElement(e,this.attributeConfig.datacollect),s=e.label;0===s.length&&(s=e.name);var a=l.getDetailCard(s,"dcItem wkiItem itemHover cardNoHighlight","fonticon fonticon-pencil",n.getHTML(),i,!0);return a.setPID(e.instancePhysicalId),a.setOnClick(this._onWkiItemClick.bind(this)),a.type=k,l.addDragElement(e,a.element),a},_onDCPlanExpand:function(t){g.publish({event:"wkbInstructionListView-DCPlanExpand",data:t})},_getDataCollectPlanCard:function(e){var i=null;t.is(e.documents)&&e.documents.length>0&&(i=l.getDocumentAttachmentElement(e.documents,e.name));var n=t.createElement("div");l.getAttributeDiv(u.DCCollectCount,e.children.length).inject(n);var s=e.name,a=h.getCustomAttributesElement(e,this.attributeConfig.datacollectplan),o={title:s,itemClass:"wkiItem dcItem cardNoHighlight",fonticonClass:"fonticon fonticon-pencil",html:n.getHTML()+a.getHTML(),stampElement:i,isClickable:!0,dcPlan:e,onContextMenuClickCB:this._onDCPlanExpand.bind(this)},r=new c(o);return t.is(e.capableResources)&&e.capableResources.length>0&&"capable"===widget.getValue("resType")&&l.insertCapableResources(e.capableResources,r,g,this.attributeConfig.tool),r.setPID(e.instancePhysicalId),r.type=m,l.addDragElement(e,r.element),r},_loadDataCollectCards:function(t){var e={modelEvtManager:g,attributeConfig:this.attributeConfig,planPID:t.physicalId,parentInstancePID:t.instancePhysicalId},i=new r(e);i.hide(),i.inject(this.dataCollectLists),i.loadCards(t),this.wkbDCPDataCollectListMap.set(t.instancePhysicalId,i)},_getWkiItemDivs:function(){var t=this.container.querySelectorAll(".alertItem, .dcItem, .signoffItem, .instructionItem, .dcPlanChildItem");return t=Array.from(t)},_addScroll:function(t,e){this.scroller=new a({element:t}).inject(e)},_destroyScroll:function(){t.is(this.scroller)&&(this.scroller.destroy(),this.scroller=null)},destroy:function(){this._destroyScroll(),this.attributeConfig=null,this.wkbDCPDataCollectListMap=null,this.currentDataCollectListView=null,this.cardList.length=0,this.container.destroy(),this.container=null}})});