define("DS/3DWorkbook/js/Wkb3DViewer",["UWA/Core","DS/UIKIT/Mask","DS/CoreEvents/ModelEvents","DS/Notifications/NotificationsManagerViewOnScreen","DS/DELMOMWKIExperience/js/WKI3DPlayer","DS/DELMOMWKIExperience/js/WkiStreamUtil","DS/DELMOMWKIExperience/js/IndexFileParser","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/WkbWidgetCom","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,i,n,s,a,o,r,c,l){"use strict";var u,d,p,b,w,f,D,h,m=null,g=null,v=null,y=null,S=null,I=null,k={},E=!1,P=!1,V=!1,C=!0,M=!1,j=null,L=null,_=!1,x=!1,T=0,N=0,F=!1,O=!1,W=null,R=[],U=function(t){w=t.modelEvtManager||new i,m=t.ctx,u=t.ematrixURL,S=t.systemRefName,_=!1,d=t.widgetPreferences,y=t.publishedProductId,L=t.wkiStreamUtil,j=t.orientationViewConfig,e.is(t.threeDViewerDataExists)&&(C=t.threeDViewerDataExists),e.is(t.isDelmiaViewer)&&(M=t.isDelmiaViewer);var n=r.graphicsMode.Graphics3D===t.displayMode,s=r.getPreferenceValue(d,"defaultViewType");if(F="2D"===s&&!n,null===I){let t=null;t=w.subscribe({event:"wki3DPlayer-Notify"},function(t){var i=l.ErrorTitle,n="error";e.is(t.type)&&(n=t.type),e.is(t.title)&&(i=t.title),w.publish({event:"wkbNotify",data:{src:t.src,title:i,subtitle:t.subtitle,message:t.message,isVanishes:!1,type:n}})}),R.push(t),t=w.subscribe({event:"wkbNav-SelectOper"},function(e){q(e)}),R.push(t),t=w.subscribe({event:"wkbHeader-SelectOper"},function(e){q(e)}),R.push(t),t=w.subscribe({event:"wkbHeader-SelectOrder"},function(e){!function(e){D="",e.object_type="SYSTEM"}(e),H(),Y(h)}),R.push(t),t=w.subscribe({event:"wkbMain-GraphicsChanged"},function(e){if("3D"===e.mode){if(H(),"SYSTEM"===e.object_type);else if(f&&G(f),T>0&&T!==N){var t=document.createEvent("CustomEvent");t.initCustomEvent("DELMOMSETVIEW",!1,!1,{viewID:T}),document.dispatchEvent(t)}}else z()}),R.push(t),t=w.subscribe({event:"wkiDelPlayer-playerReady"},B),R.push(t),t=w.subscribe({event:"wkiDelPlayer-setProcessComplete"},A),R.push(t),t=w.subscribe({event:"wkbMain-Remove3D"},z),R.push(t),t=w.subscribe({event:"ViewChanged"},function(e){T=e.ID;var t=document.createEvent("CustomEvent");t.initCustomEvent("SETDEFAULTSLIDE",!1,!1,{viewID:T}),document.dispatchEvent(t)}),R.push(t),t=w.subscribe({event:"wkbMain-NavSizeChanged"},ae),R.push(t),t=w.subscribe({event:"wkbMain-DetailSizeChanged"},ae),R.push(t),t=w.subscribe({event:"HighlightLinkedObjects-wkb3DViewer"},re),R.push(t),t=w.subscribe({event:"selectItems-wkb3DViewer"},Z),R.push(t),t=w.subscribe({event:"selectItem-wkb3DViewer"},ee),R.push(t),t=w.subscribe({event:"unselectItem-wkb3DViewer"},te),R.push(t),t=w.subscribe({event:"clearSelections-wkb3DViewer"},ie),R.push(t),t=w.subscribe({event:"wkbDetails-InstructionSelected"},oe),R.push(t)}return this.setContainer(),this};function A(){w.publish({event:"wkb3DViewer-DelViewerSetProcessComplete",data:{}})}function B(){h.object_data.isConfigured||g.loadSystem(h.object_data.physicalId,h.object_data.scopedMfgItemPID,h.object_data.scopedResourcePID,h.object_data.installPath)}function z(){null!==I&&(I.style.visibility="hidden",I.style.left="-300px"),E=!1}function H(){null!==I&&(I.style.left="0px",I.style.visibility="visible",I.style.height="100%"),E=!0}function K(t){e.is(L)&&L.dispose();var i={serverURL:u,securityContext:widget.getValue("collabSpace"),PID:t,serverRequestTimeoutMS:r.serverRequestTimeoutMS,modelEvtManager:w};L=new a(i)}function Y(t,i){e.is(t)&&$(t,i)}function q(e){T=0;var t=document.createEvent("CustomEvent");t.initCustomEvent("SETDEFAULTSLIDE",!1,!1,{viewID:0}),document.dispatchEvent(t),f=e,D=null,G(e)}function G(e){e.object_type="OPERATION",E&&x?$(e):E?(_=!0,Y(h)):F&&Y(h,!0)}function $(t,i){if(!e.is(t.object_data.physicalId)){if(!e.is(v)||"SYSTEM"!==t.object_type)return;t.object_data.physicalId=v,t.object_data.parentPhysicalId=v,t.object_data.systemPhysicalId=v,t.object_data.publishedProductId=y,t.object_data.xml3DFile=p||""}(E||i)&&"SYSTEM"===t.object_type?(De(t.object_data.physicalId,!0,t.object_data),v=t.object_data.systemPhysicalId,p=t.object_data.xml3DFile):E&&"OPERATION"===t.object_type&&t.object_data.physicalId!==D&&(D=t.object_data.physicalId,De(t.object_data.physicalId,!1,t.object_data))}function J(t){if(widget.Debug.log("************** Wkb3DViewer: onMapLoaded"),e.is(t)){var i=(new DOMParser).parseFromString(t,"text/xml");c.publishMappingFileLoaded(i),w.publish({event:"wkb3DViewer-MapFileLoaded",data:{mapData:i,player:g}})}}function Q(){var e;(t.unmask(I.parentElement.parentElement),t.unmask(I.parentElement.parentElement.parentElement),n.inject(widget.body),w.publish({event:"wkb3DViewer-LoadingBackgroundDone"}),b||X(),window.onresize=function(){window.clearTimeout(e),e=setTimeout(ae,500)},m=g.player.getCtx(),c.publishModelLoaded(),x=!0,_)?fe():"firstoperation"===widget.getValue("loadLevel")&&!h.object_data.isConfigured&&ge()}async function X(){try{const e=await g.loadOperByContext(k);w.publish({event:"wkb3DViewer-onOperationLoadComplete",data:e})}catch(e){console.error(e)}}function Z(e){return O=!0,g.selectNodes(e).then(function(){O=!1})}function ee(e){O=!0,g.selectNode(e).then(function(){O=!1})}function te(e){O=!0,g.unselectNode(e).then(function(){O=!1})}async function ie(t){e.is(g)&&await g.emptySelection(t)}function ne(e){var t={action:e.action.toUpperCase(),idPath:e.instancePath};w.publish({event:"wkb3DViewer-HighlightCallback",data:t}),c.publishPartSelected(e)}function se(t){e.is(t.viewID)&&(N=t.viewID,w.publish({event:"ViewChanged",data:{ID:N,Name:t.viewName,From:1}}))}function ae(){w.publish({event:"wkbNavPanel-resize",data:null})}function oe(e){}async function re(e){E&&(await ie(!0),M&&await g.unhighlightAllViews(),g.highlightLinkedObjects(e.instruction.pid,e.part))}function ce(){g.addEventListener("ScenarioChange",function(e){e.detail.scenario,V&&(V=!1,b||X())}),g.addEventListener("ScenarioStop",function(e){e.detail.scenario,V=!0}),g.addEventListener("MarkerSelected",e=>(function(e){w.publish({event:"wkb3DViewer-MarkerSelected",data:e})})(e)),g.addEventListener("ViewerClearedSelections",()=>void w.publish({event:"wkb3DViewer-ViewerClearedSelections",data:{}})),g.addEventListener("PartSelected",function(e){O||ne(e)}),g.addEventListener("ViewSelected",function(e){se(e)})}function le(){b?x&&g.resetViewer():E&&X()}async function ue(e,i,n){e.innerHTML="",e.style.display="",F?w.publish({event:"wkb3DViewer-LoadingBackground",data:null}):t.mask(I.parentElement.parentElement),W=new s(e,i,n),g=await W.loadPlayer(),ce()}function de(t,i){e.is(t)&&(widget.Debug.log("************** Wkb3DViewer: LoadMapFile"),e.is(L)||K(i),e.is(t)&&t.length>0&&L.getFileFromExtendedStream(t,J))}function pe(){return r.getPrefBoolValue(d,"showOrientationViewer")?j:null}function be(t){return!!(e.is(t)&&t.length>0)}function we(t){var i={callback:Q,serverURL:u,requiredAuth:"passport",ctx:m},n=o.mappingFile;if(i.modelEvtManager=w,i.systemMapFile=n,i.systemRefName=S,i.systemPID=t.systemPhysicalId,i.securityContext=widget.getValue("collabSpace"),i.wkiStreamUtil=L,i.modelEvtManager=w,e.is(t.type)&&"SYSTEM"===t.type&&(i.configFilterBinary=t.configFilterBinary,i.scopedMfgItemPID=t.scopedMfgItemPID,i.scopedResourcePID=t.scopedResourcePID,i.installPath=t.installPath,i.isConfiguredSystem=t.isConfigured,e.is(t.unitPID)&&(i.unitPID=t.unitPID,i.showConfigPanel=!1)),i.orientationConfig=pe(),C||M&&be(i.systemPID)||be(y)){P=be(y)||M;var s=performance.now();P?(widget.Debug.log("************** processViewer: Connected Mode = true"),i.mode="connected",de(n,t.systemPhysicalId),e.is(g)?le():(i.productId=y,ue(I,"",i)),widget.Debug.log(`************** Time to processViewer: Connected Mode = true: ${(performance.now()-s)/1e3} seconds.`)):(widget.Debug.log("************** processViewer: Connected Mode = false"),i.mode="file",de(n,t.systemPhysicalId),e.is(g)?le():ue(I,"",i),widget.Debug.log(`************** Time to processViewer: Connected Mode = false: ${(performance.now()-s)/1e3} seconds.`))}else{g&&(g.ResetScenarios(),g=null),I.textContent="",r.createAndAppend(I,"div","msgDiv","msgDiv").textContent=l.No3DFoundMsg,w.publish({event:"wkb3DViewer-No3D"}),x=!0,_&&fe()}}function fe(){$(f),_=!1}function De(e,t,i){widget.Debug.log("************** Wkb3DViewer: load3DPlayer"),b=t,t||(k={referenceName:i.id,instanceName:i.instanceName,PID:i.physicalId,instancePID:i.instancePhysicalId,rirPath:i.rirPath,ctxType:"allInfo"}),we(i)}function he(){e.is(W)&&(W.dispose(),g=null,W=null),e.is(L)&&(L.dispose(),L=null),f=null,I=null,h=null,x=!1,E=!1,R.forEach(function(e){w.unsubscribe(e)}),k={}}function me(){return m}function ge(){var t=document.getElementById("navListDiv").getChildren();e.is(t)&&t.length>0&&t[0].getChildren()[0].click()}function ve(e,t,i,n){switch(e){case"processViewer":return we(t);case"hide3DViewer":return z();case"show3DViewer":return H();case"renderGraphics":return $(t);case"onThreeDPartSelect":return ne(t);case"xmlMapLoaded":return J(t);case"onViewSelected":return se(t);case"initializeStreamUtil":return K(t);case"wkiStreamUtil":return L;default:return null}}return U.prototype={setContainer:function(){null===I?((I=e.createElement("div",{id:"playerDiv",class:"playerDiv"})).testFunction=ve,I.dispose=he,I.getCtx=me):I.style.display=""},loadSystem:function(e,t){h=e,"system"===r.getPreferenceValue(d,"loadLevel")||e.object_data.isForDelmiaViewer?Y(e,t):ge()},loadDelmiaPlayerSystem:function(t){e.is(t)&&(h=t),g.loadSystem(h.object_data.physicalId,h.object_data.scopedMfgItemPID,h.object_data.scopedResourcePID,h.object_data.installPath)},setSelectedSystem:function(e){h=e},getContainer:function(){return I},get3DPlayer:function(){return g},set3DPlayer:function(e){g=e},getCurrentViewID:function(){return N},setPreferences:function(e){d=e},getOrientationConfig:function(){return pe()},getCtx:me,dispose:he,testFunction:ve},U});