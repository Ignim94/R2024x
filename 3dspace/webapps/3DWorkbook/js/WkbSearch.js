define("DS/3DWorkbook/js/WkbSearch",["UWA/Core","UWA/Class","UWA/Promise","UWA/Utils/InterCom","DS/CoreEvents/ModelEvents","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/models/WkbSystemDS","DS/UIKIT/Mask","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,s,r,i,n,o,a,c){"use strict";var d,h="",l={},u=!0,m=!1;class S extends Error{constructor(e){super(e),this.name="InvalidPhysicalIdError",this.title=c.ErrNotSupportedTitle,this.subTitle=c.ErrNotSupportedSubtitle}}class f extends Error{constructor(e){super(e),this.name="WebServiceError",this.title=c.ErrorTitle,this.subTitle=c.ErrSystemWebService}}class g extends Error{constructor(e){super(e),this.name="NoLicenseError",this.title=c.NoLicenseErrorTitle,this.subTitle=c.NoLicenseErrorMsg}}var b=function(e,t,s){d.publish({event:"wkbNotify",data:{src:"wkbSearch",title:e,subtitle:t,message:s,isVanishes:!1,type:"error"}})};function k(t,s){const r=["DELLmiPPRSystemReference","DELLmiProductionSystemReference","DELLmiGeneralSystemReference","DELLmiWorkPlanSystemReference","DELLmiServiceWorkPlanSystemReference","DELLmiQtyControlProcessReference","DELLmiTransferSystemReference","DELLmiTransformationSystemReference"];if(r.includes(t.objectType))return!0;if(!e.is(s)||0===s.length)return!1;var i=s;return!!r.some(function(e){return i.indexOf(e)>-1})}function y(e){return["DELLmiHeaderOperationReference"].includes(e)}return t.extend({init:function(t){d=(t=t||{container:null}).modelEvtManager||new i,h=t.ematrixURL,this.socketName="search_socket_"+(new Date).getTime(),u="process"===widget.getValue("searchFor"),l.role=t.role,l.title="3D Workbook",l.mode="furtive",l.default_with_precond=!0,l.precond=u?"flattenedtaxonomies:types/DELLmiPPRSystemReference":"flattenedtaxonomies:types/DELLmiHeaderOperationReference",l.show_precond=!1,l.multiSel=!1,l.app_socket_id=this.socketName,l.widget_id=t.widget_id,e.is(this.socket)||(this.socket=new r.Socket(this.socketName,{dispatchRetryInterval:0}),this.socket.subscribeServer("SearchComServer"),this.socket),this.onSelectedObjectsSearch=this.onSelectedObjectsSearch.bind(this),this.registerContext()},registerContext:function(){e.log("Initialize the search Context"),this.socket.dispatchEvent("RegisterContext",l),this.socket.addListener("Selected_Objects_search",this.onSelectedObjectsSearch.bind(this))},displayUserRoleError:function(e){},activateSearchContext:function(){try{if(!e.is(this.socket))throw new Error("Socket not initialized");this.socket.dispatchEvent("InContextSearch",l)}catch(e){console.log("3DWorkbook.WkbSearch.activateSearchContext: "+e)}},getSystemPID:async function(t){var s=[],r=null,i=0;if(t instanceof Array)return t[0].id;var n=null;try{n=JSON.parse(t)}catch(e){return new S("failed to parse JSON data")}if(e.is(n.data)&&e.is(n.data.items))for(r=n.data.items;i<r.length;i+=1)if(s.length=0,r[i].objectType instanceof Array){if(s=r[i].objectType,k(r[i],s))return r[i].objectId}else{if(k(r[i]))return r[i].objectId;var a=new o({ematrixURL:h,modelEvtManager:d});if(await a.getIsValidSystem(r[i].objectId))return r[i].objectId}return new S("failed to find system type")},getHeaderOperationPID:function(t){return new s(function(s,r){if(e.is(t,"array")&&1===t.length)return s(t[0].id);const i=JSON.parse(t);if(e.is(i.data)&&e.is(i.data.items,"array")&&1===i.data.items.length){const e=i.data.items[0];if(y(e.objectType))return s(e.objectId)}return r(new S("failed to find header operation type"))})},getHeaderOperationName:function(t){if(e.is(t,"array")&&1===t.length)return t[0]["ds6w:label"];const s=JSON.parse(t);if(e.is(s.data)&&e.is(s.data.items,"array")&&1===s.data.items.length){const e=s.data.items[0];if(y(e.objectType))return e.displayName}return""},getSystemPIDFromHeaderOpPID:async function(e){var t=new o({ematrixURL:h,modelEvtManager:d});try{return await t.getSystemPIDFromHeaderOpPID(e,h,widget.getValue("collabSpace"))}catch(e){throw new f(e)}},getSystemModeFromSearchResult:function(t){if(e.is(t,"array")&&1===t.length)return void(m=!y(t[0]["ds6w:type_value"]));const s=JSON.parse(t);if(e.is(s.data)&&e.is(s.data.items,"array")&&1===s.data.items.length){const e=s.data.items[0];m=!y(e.objectType)}},getPIDFromSearchResult:function(e){return this.getSystemModeFromSearchResult(e),m?this.getSystemPID(e):this.getHeaderOperationPID(e)},getSystemData:function(t){const r=`${h}resources/wkb/invoke/v1/system?pid=${encodeURIComponent(t)}`;return new s((t,s)=>{n.getServerData(r,function(e){t(e)},function(t,r){console.log(`error getting system PID from service: ${t}, backend response: ${r}`);var i="";widget.Debug.debugMode&&(i=t.message),e.is(r)&&r.includes("No licenses are reserved for the given app")?s(new g(i)):s(new f(i))},"json")})},onSelectedObjectsSearch:function(t){a.mask(widget.body);var r=null,i=null;this.getPIDFromSearchResult(t).then(n=>(console.log(`SEARCH PHYSICAL ID = ${n}`),e.is(n,"string")&&n.length>0?(this.socket.dispatchEvent("clearSearch"),m?n:(r=n,i=this.getHeaderOperationName(t),this.getSystemPIDFromHeaderOpPID(n))):s.reject(new S("invalid search physical id")))).then(e=>this.getSystemData(e)).then(e=>{m||(e.headerOperationName=i,e.headerOperationPhysicalId=r),d.publish({event:"wkbSearch-DataFound",data:JSON.stringify(e)}),n.updateMRUList(e)}).catch(t=>{t instanceof S?(b(t.title,t.subTitle,""),a.unmask(widget.body)):t instanceof f?(b(t.title,t.subTitle,t.message),a.unmask(widget.body)):t instanceof g?(b(t.title,t.subTitle,t.message),a.unmask(widget.body)):(e.is(t)&&console.log(t.message),a.unmask(widget.body))})},resetSearchFilters:function(e){var t={};t.widget_id=l.widget_id,this.socket.dispatchEvent("unregisterSearchContext",t),this.socket.unsubscribeServer("SearchComServer"),this.socket.removeListener("Selected_Objects_search",this.listener),this.socket.disconnect(),this.socket=new r.Socket(this.socketName,{dispacthRetryInterval:0}),this.socket.subscribeServer("SearchComServer"),this.socket.dispatchEvent("RegisterContext",l),this.socket.addListener("Selected_Objects_search",this.onSelectedObjectsSearch),this.socket},unregisterSearchContext:function(){e.log("Unset the search Context"),this.socket.dispatchEvent("UnregisterContext",{widget_id:l.widget_id}),this.socket.removeListener("Selected_Objects_search",this.onSelectedObjectsSearch),this.socket.disconnect(),delete this.socket},onDestroy:function(){null,this.unregisterSearchContext(),e.is(null)&&(null.onclick=null)},launchSearch:function(e){l.default_search_criteria=e,this.activateSearchContext()}})});