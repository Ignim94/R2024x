define("DS/3DWorkbook/js/WkbWidgetCom",["UWA/Core","UWA/Class","DS/PlatformAPI/PlatformAPI","DS/CoreEvents/ModelEvents","DS/DELMOMWKIExperience/js/ParserUtility","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/WkbNavController","DS/3DWorkbook/js/models/WkbDataStore","DS/DELMOMWKIExperience/js/MappingFileParser","DS/3DPlayExperienceModule/SceneGraphNodeServices","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,i,n,s,o,a,r,l,c,h){"use strict";var D={},p={},u={},y={},g=null,d=[];let P=0,I=null,b="",f=null;function m(t){var i,n="",s={};if(s.action=t.action,!e.is(t.pathElement))return s;for(var a=t.pathElement.externalPath,r=a.length-1;r>0;r-=1)if(e.is(a[r].isPLMInstance)&&a[r].isPLMInstance()){a[r].plmexternalId,n=c.getId(a[r]);break}return(i=o.getInstancePath(n,b)).length>0&&(s.phyID=i[i.length-1].instPhyID,s.path=function(e){for(var t=[],i={},n=0;n<e.length;n+=1)(i={}).objPLMID=e[n].referenceName,i.refName=e[n].referenceTitle,i.instName=e[n].instanceName,t.push(i);return t}(i),s.objPLMID=i[i.length-1].referenceName,s.refName=i[i.length-1].referenceTitle,s.instName=i[i.length-1].instanceName),s.productPath=function(e){for(var t,i=[],n=0;n<e.length;n+=1)(t={}).id=c.getId(e[n]),t.name=e[n].name,t.plmexternalId=e[n].plmexternalId,t.title=e[n].title,t.worktype=e[n].worktype,t.persistentId=e[n].persistentId,i.push(t);return i}(a),s}function L(t){return"DELMIA"===u.get3DPlayer().playerType?e.is(t.phyID)?[t.phyID]:[]:function(e){let t=[];return e.phyID&&e.phyID.length>0?0===(t=l.getHighlightPathsByValues([e.phyID],["InstPhyID"])).length&&t.push(e.phyID):e.path&&e.path.length>0?t=(t=o.getHighlightIdByExternalPath(e.path,b)).length>0?[t]:[]:e.objPLMID&&e.objPLMID.length>0&&e.instName&&e.instName.length>0?t=u.get3DPlayer().getObjectPathsByReferenceAndInstanceName(e.objPLMID,e.instName):e.instName&&e.instName.length>0?t=u.get3DPlayer().getObjectPathsByInstanceName(e.instName):e.objPLMID&&e.objPLMID.length>0?t=u.get3DPlayer().getObjectPathsByReferenceName(e.objPLMID):e.refName&&e.refName.length>0?t=u.get3DPlayer().getHighlightPaths(e.refName):console.error("WkbWidgetCom:  Invalid item data"),t}(t)}function N(e,t){const i=e.split("."),n=t.split(".");return i[0]===n[0]}function A(t){e.is(t.opPID)&&t.opPID.length>0?(f={}).object_data={physicalId:t.opPID}:e.is(t.opPLMID)&&t.opPLMID.length>0?((f={}).object_data={id:t.opPLMID},e.is(t.opInstName)&&t.opInstName.length>0&&(f.object_data.instanceName=t.opInstName)):e.is(t.opInstName)&&t.opInstName.length>0?(f={}).object_data={instanceName:t.opInstName}:e.is(t.opRefName)&&t.opRefName.length>0&&((f={}).object_data={referenceName:t.opRefName}),e.is(f)&&function(t){var i=!0,n=!0,s=!0,o=!0;e.is(t.displayParts)&&(i="true"===t.displayParts.toLowerCase()),e.is(t.displayResources)&&(n="true"===t.displayResources.toLowerCase()),e.is(t.displayDocuments)&&(s="true"===t.displayDocuments.toLowerCase()),e.is(t.display0DInst)&&(o="true"===t.display0DInst.toLowerCase()),f.object_data.displayParts=i,f.object_data.displayResources=n,f.object_data.displayDocuments=s,f.object_data.display0DInst=o}(t)}function E(e,t){let i=[];for(let n=0;n<t.length;n++){const s={};s[e]=t[n],i=i.concat(L(s))}return i}var C=t.singleton({init:function(t){if(e.is(t)){D=t.wkbMain,p=t.wkbDetails,u=t.wkb3DViewer,y=t.wkbNavPanel,g=t.modelEvtManager,this.subscribeAll();var i=g.subscribe({event:"ViewChanged"},function(e){P=e.ID,I=e.Name});d.push(i),document.addEventListener("DELMOMOPENNESSMARKERSELECTED",this.onMarkerSelected)}},setPanels:function(e){D=e.wkbMain,p=e.wkbDetails,u=e.wkb3DViewer,y=e.wkbNavPanel},subscribeAll:function(){i.subscribe("CAADELWKB.loadOper",this.onWkbLoad),i.subscribe("CAADELWKB.selectNode",this.onSelectNode),i.subscribe("CAADELWKB.unselectNode",this.onUnselectNode),i.subscribe("CAADELWKB.hideShow",this.onHideShowNode),i.subscribe("CAADELWKB.colorize",this.onSetNodeColor),i.subscribe("CAADELWKB.setOpacity",this.onSetNodeOpacity),i.subscribe("CAADELWKB.resetColor",this.onResetNodeColor),i.subscribe("CAADELWKB.reframeOn",this.onReframeOnNode),i.subscribe("CAADELWKB.getCurrentViewID",this.onGetCurrentView),i.subscribe("CAADELWKB.setViewID",this.onSetView),i.subscribe("CAADELWKB.navigatePrevView",this.onNavigatePrevView),i.subscribe("CAADELWKB.navigateNextView",this.onNavigateNextView),i.subscribe("CAADELWKB.setViewPointInfo",this.onSetViewPoint),i.subscribe("CAADELWKB.getViewPointInfo",this.onGetViewPoint),i.subscribe("CAADELWKB.getBoundingBox",this.onGetBoundingBox),i.subscribe("CAADELWKB.getPartPosition",this.onGetPartPosition),i.subscribe("CAADELWKB.highlightLinkedMarkers",this.onHighlightLinkedMarkers),i.subscribe("CAADELWKB.reframeOnMarkers",this.onReframeOnMarkers),i.subscribe("CAADELWKB.getOpersWhereUsed",this.onGetOpersWhereUsed),i.subscribe("CAADELWKB.selectInstruction",this.onSelectInstruction),i.subscribe("CAADELWKB.selectDCRow",this.onSelectDCRow)},publishOperationSelected:function(e){const t={opInstName:e.instanceName,opRefName:e.displayName,opPID:e.physicalId,opPLMID:e.id};i.publish("CAADELWKB.operSelected",t)},publishPartSelected:function(e){var t=null;t="DELMIA"===u.get3DPlayer().playerType?{action:e.action,phyID:e.instancePath}:m(e),i.publish("CAADELWKB.addSelectionCB",t)},publishMappingFileLoaded:function(e){b=e;var t=(new s).xmlToJson(e);l?l.setMapFileJson(t):l.init(t),i.publish("CAADELWKB.getObjsFromMapping",t)},publishModelLoaded:function(){i.publish("CAADELWKB.modelLoaded",{playerType:u.get3DPlayer().playerType}),e.is(f)&&(y.selectOperation(f),f=null)},publishWidgetLoaded:function(e){i.publish("CAADELWKB.widgetLoaded",e)},publishLoadError:function(e){i.publish("CAADELWKB.systemOperLoadError",e)},publishCurrentView:function(e){i.publish("CAADELWKB.getCurrentView",e)},onWkbLoad:function(t){var i=function(){e.is(t.operDetailCollapsed)&&e.is(p)&&e.is(y)?("TRUE"===t.operDetailCollapsed.toUpperCase()?D.closeDetailsPanel():D.openDetailsPanel(),"TRUE"===t.operPanelCollapsed.toUpperCase()?D.closeNavPanel():D.openNavPanel()):setTimeout(i,200)};!function(t){e.is(t.sysPID)||(t.sysPID=""),e.is(t.sysPLMID)||(t.sysPLMID=""),e.is(t.sysRevision)||(t.sysRevision=""),""!==t.sysPLMID&&""===t.sysRevision&&(t.sysPLMID=""),e.is(t.sysTitle)||(t.sysTitle="")}(t),A(t);const n=D.getSystemData(),s=e.is(n)&&function(e,t){let i=!1;return t.sysPID&&t.sysPID.length>0?t.sysPID!==e.physicalId&&(i=!0):t.sysPLMID&&t.sysPLMID.length>0&&t.sysRevision&&t.sysRevision.length>0?t.sysPLMID===e.id&&N(e.version,t.sysRevision)||(i=!0):t.sysTitle&&t.sysTitle.length>0&&(t.sysTitle===e.name&&N(e.version,t.sysRevision)||(i=!0)),i}(n,t);if(!e.is(n)||s)D.loadSystem(t,i);else if(e.is(f))try{y.selectOperation(f),f=null,i()}catch(e){console.log("WIDGETCOM: ERROR Loading operation "+e),f=null}},onSelectNode:function(e){const t=L(e);"DELMIA"===u.get3DPlayer().playerType?t.length>0&&u.get3DPlayer().selectNode(t[0]):u.get3DPlayer().selectNode(t)},onUnselectNode:function(e){const t=L(e);"DELMIA"===u.get3DPlayer().playerType?t.length>0&&u.get3DPlayer().unselectNode(t[0]):u.get3DPlayer().unselectNode(t)},onHideShowNode:function(e){const t=L(e);u.get3DPlayer().setNodeVisibility(t,e.isVisible)},onSetNodeColor:function(e){const t=L(e);var i=e.color.split(" ");u.get3DPlayer().setObjectsColor(t,i[0],i[1],i[2])},onSetNodeOpacity:function(e){const t=L(e);t.length>0&&u.get3DPlayer().setObjectOpacity(t[0],e.opacity)},onResetNodeColor:function(e){const t=L(e);t.length>0&&u.get3DPlayer().resetObjectsColor(t)},onReframeOnNode:function(t){let i=[];if(e.is(t.phyID)&&t.phyID.length>0)i=E("phyID",t.phyID.split(","));else if(e.is(t.path)&&t.path.length>0&&Array.isArray(t.path[0]))for(let e=0;e<t.path.length;e++){if(!Array.isArray(t.path[e]))continue;const n=[];for(let i=0;i<t.path[e].length;i++)n.push(t.path[e][i]);const s={};s.path=n,i=i.concat(L(s))}else if(e.is(t.path)&&t.path.length>0||e.is(t.objPLMID)&&t.objPLMID.length>0&&e.is(t.instName)&&t.instName.length>0){var n=L(t);n.length>0&&i.push(n[0])}else e.is(t.instName)&&t.instName.length>0?i=E("instName",t.instName.split(",")):e.is(t.objPLMID)&&t.objPLMID.length>0?i=E("objPLMID",t.objPLMID.split(",")):e.is(t.refName)&&t.refName.length>0&&(i=E("refName",t.refName.split(",")));if(i.length>0)if("DELMIA"===u.get3DPlayer().playerType){const e=[],t=r.getPartInstanceToReferenceMap();i.forEach(i=>e.push(t.get(i))),e.length>0&&u.get3DPlayer().reframeOn({referencePIDs:e})}else u.get3DPlayer().reframeOn({instancePaths:i})},onGetCurrentView:function(){C.publishCurrentView({id:P.toString(),title:I})},onSetView:function(e){var t=document.createEvent("CustomEvent");t.initCustomEvent("DELMOMSETVIEW",!1,!1,e),document.dispatchEvent(t)},onNavigatePrevView:function(e){a.gotoPrevView()},onNavigateNextView:function(e){a.gotoNextView()},onSetViewPoint:function(t){var i={};e.is(t)&&(e.is(t.eyePosition)&&e.is(t.eyePosition.x)&&e.is(t.eyePosition.y)&&e.is(t.eyePosition.z)&&(i.eyePosition=t.eyePosition),e.is(t.orientation)&&e.is(t.orientation.x)&&e.is(t.orientation.y)&&e.is(t.orientation.z)&&e.is(t.orientation.w)&&(i.orientation=t.orientation),e.is(t.targetDistance)&&("DELMIA"===u.get3DPlayer().playerType?i.targetDistance=t.targetDistance:i.distanceToTarget=t.targetDistance),i.duration=100,u.get3DPlayer().setViewPoint(i))},onGetViewPoint:async function(){var e=await u.get3DPlayer().getViewPointData();i.publish("CAADELWKB.getViewPointData",e)},onGetPartPosition:async function(t){var n="";if(e.is(t)&&e.is(t.Part)&&e.is(t.Operation)){var s=t.Part,o=t.Operation;if("DELMIA"===u.get3DPlayer().playerType){if(e.is(s.phyID)&&e.is(o.phyID))n=(await u.get3DPlayer().getPartPosition(o.phyID,s.phyID)).position}else{var a=function(t){var i;return e.is(t.objPLMID)&&t.objPLMID.length>0?i=l.getPartIdByValue(t.objPLMID,"ReferenceName"):e.is(t.instName)&&t.instName.length>0?i=l.getPartIdByValue(t.instName,"InstanceName"):e.is(t.refName)&&t.refName.length>0?i=l.getPartIdByValue(t.refName,"ReferenceTitle"):e.is(t.phyID)&&t.phyID.length>0&&(i=l.getPartIdByValue(t.phyID,"InstPhyID")),i}(s);e.is(a)&&a.length>0&&(n=function(t,i){var n,s="";return e.is(i)&&(e.is(i.objPLMID)&&i.objPLMID.length>0?n=l.getPartForOperation(t,i.objPLMID,"ReferenceName"):e.is(i.instName)&&i.instName.length>0?n=l.getPartForOperation(t,i.instName,"InstanceName"):e.is(i.refName)&&i.refName.length>0&&(n=l.getPartForOperation(t,i.refName,"ReferenceTitle")),e.is(n)&&(s=n.position)),s}(a,o))}}n.length>0?i.publish("CAADELWKB.partPosition",n):i.publish("CAADELWKB.partPosition","Position not found for operation and part")},onGetBoundingBox:async function(e){const t=L(e);if(1===t.length){var n=await u.get3DPlayer().getBoundingBox(t[0]);i.publish("CAADELWKB.boundingBoxData",n)}},onHighlightLinkedMarkers:function(t){e.is(t)&&e.is(t.phyID)&&u.get3DPlayer().highlightLinkedMarkers(t.phyID,!0)},onMarkerSelected:function(t){if(e.is(t)&&e.is(t.detail,"array")){const n=new Set;t.detail.forEach(t=>{const i=t.Instruction;e.is(i.InstPhyID)&&n.add(i.InstPhyID),e.is(i.Row)&&n.add(i.Row.RowPhyID)}),i.publish("CAADELWKB.marker3DSelected",{phyID:Array.from(n)})}},onReframeOnMarkers:function(t){e.is(t)&&e.is(t.instPhyID)&&(u.get3DPlayer().highlightLinkedMarkers(t.instPhyID,!0),u.get3DPlayer().reframeOnSelectedMarkers())},onGetOpersWhereUsed:function(t){if(e.is(t)&&e.is(t.instPID,"string"))if(e.is(r.system)){const e=r.getAllOperationLinkedToInstruction(t.instPID);i.publish("CAADELWKB.opersWhereUsed",JSON.stringify(e))}else i.publish("CAADELWKB.opersWhereUsed",h.NoSystemLoaded)},onSelectInstruction:function(t){e.is(t)&&e.is(t.phyID,"string")&&g.publish({event:"wkbDetails-InstructionSelected",data:{pid:t.phyID,type:"WKIITEM",userSelect:!1}})},onSelectDCRow:function(t){e.is(t)&&e.is(t.phyID,"string")&&g.publish({event:"wkbDetails-InstructionSelected",data:{pid:t.phyID,type:"DCROW",userSelect:!1}})},setViewer:function(e){u=e},dispose:function(){d.forEach(e=>{g.unsubscribe(e)}),d=[]}});return C});