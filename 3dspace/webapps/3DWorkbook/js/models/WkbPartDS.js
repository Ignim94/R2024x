define("DS/3DWorkbook/js/models/WkbPartDS",["UWA/Core","UWA/Class","UWA/Promise","DS/3DWorkbook/js/WkbHighlightUtil","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/models/WkbModelUtils","DS/3DWorkbook/js/models/WkbDataStore","DS/3DWorkbook/js/models/WkbAttributeConfig","DS/3DWorkbook/js/models/WkbPart","DS/3DWorkbook/js/models/WkbDataStorePart","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,n,r,s,i,a,o,u,c,l){"use strict";var f=null;function d(e,t){t.push("V_usage");var n={input_physical_ids:e,primitives:[{navigate_to_sr:{id:3,filter:{role:["51"],semantics:["5"]},mode:"last"},navigate_to_rel:{id:4,mode:"stop_at_bo"}}],patterns:{references:[{id:3},{id:4}]},attributes:t,fileAttributes:[],version:3,label:"DELMOMWKB: partReferencesJson"};return JSON.stringify(n)}function g(t,n){var r=0,s=0,i=[],a=0,o=n;for(s=0;s<n.length;s+=1)if(o=n[s].outputs.instanceToReferenceRelations,e.is(o)){for(r=0;r<o.length;r+=1)if(o[r].to.physicalid===t){if(!((a+=1)<20)){i=[];break}i.push(o[r])}for(r+=1;r<o.length;r+=1)o[r].to.physicalid===t&&(a+=1);a>19&&(i.quantity=a)}return i}return t.extend({init:function(e){f=e},getPartsByIndex:async function(t,n,r){var a,u=n+"cvservlet/navigate?SecurityContext="+encodeURIComponent(r);if(!e.is(t)||0===t.length)return[];try{var c=(a={input_physical_ids:t,primitives:[{navigate_from_sr:{id:2,filter:{role:["52"],semantics:["7"]},mode:"ends"}}],patterns:{links:[{id:2}]},attributes:["bo.PLMEntity.V_usage"],fileAttributes:[],version:3,label:"DELMOMWKB: partImplementLinksJson"},JSON.stringify(a)),g=await s.serverRequestPromise(u,"json","POST",c),h=this.getFilteredLinkPIDs(g),p=[];if(e.is(h)&&h.length>0){var v=o.getAttributes(["part"]),m=d(h,o.addDefaultAttributes(v));p=await s.serverRequestPromise(u,"json","POST",m)}if(p=this.getCombinedResults(p),!e.is(p)||!e.is(p.result)||0===p.result.length)return[];var D=null;if(function(t){var n=0;if(!e.is(t.result))return!0;for(n=0;n<t.result.length;n+=1)if(e.is(t.result[n].outputs.references)&&t.result[n].outputs.references.length>0&&"DELLmiGeneralOperationReference"===t.result[n].outputs.references[0]["ds6w:type"])return!1;return!0}(p))D=await this.addInstancesData(t,p,n,r);else{var b=await this.addInstancesData(t,p,n,r);D=await this.getPartDataForAssignedOpers(b,n,r)}var P=null;return D.references.length>0&&(P=this.transformToPartData(D)),widget.wkbIsLanguageTranslation&&e.is(P)&&P.length>0&&(P=await i.getTranslatedObjects(P,f)),P}catch(e){console.log(e);var y="";widget.Debug.debugMode&&(y=e.message),f.publish({event:"wkbNotify",data:{src:"wkbPartDS",title:l.ErrorTitle,subtitle:l.ErrPartListWebService,message:y,isVanishes:!1,type:"error"}})}},getPartsByDatastore:function(e){return new n(function(t,n){t(a.getParts(e))})},getMfgKitChildParts:async function(e,t){const n=t+`resources/v1/modeler/dsmfg/dsmfg:MfgItem/${e}/Expand`;var r=s.getPrefixedSecurityContext();const i=JSON.stringify({expandDepth:1,withPath:!1});var a=await s.serverRequestPromise(n,"json","POST",i,r);return this._getPartsFromKitResults(a)},_isOperation:function(e){switch(e.type){case"DELLmiGeneralOperationReference":case"DELLmiLoadingOperationReference":case"DELLmiHeaderOperationReference":case"DELLmiOperationPPRReference":case"DELLmiInterruptOperationReference":case"DELLmiChangeOverOperationReference":return!0}return!1},_isOperationExist:function(e){var t=!1;for(const n of e)if(this._isOperation(n)){t=!0;break}return t},_getOperationIndexes:function(e){var t=[];for(const n of e)this._isOperation(n)&&t.push(e.indexOf(n));return t},_removeOperations:function(e,t){for(const n of t)e.splice(n,1)},_getExtendedScopedParts:async function(t){var n=[],r=[],s=new Map,i=null;for(const a of t)this._isOperation(a)&&0!==a.occurancePath.length&&(i=s.get(a.occurancePath[0]),e.is(i)||(i=this._getPartDataStore(),await i.loadSystemData(a.occurancePath[0]),s.set(a.occurancePath[0],i)),r=await i.getParts([a.physicalId]),n=n.concat(r));return n},_getPartDataStore:function(){var e={};return e.modelEvtManager=f,new c(e)},getPartsData:async function(t,r,s){var a=null,o=[];if(!e.is(t)||0===t.length)return new n(function(e,t){e([])});a=await this.getPartsByDatastore(t,r,s),e.is(a)&&0===a.length&&(a=await this.getPartsByIndex(t,r,s));const u=this._getOperationIndexes(a);return u.length>0&&(o=await this._getExtendedScopedParts(a),this._removeOperations(a,u)),a=a.concat(o),widget.wkbIsLanguageTranslation&&e.is(a)&&a.length>0&&(a=await i.getTranslatedObjects(a,f)),a},getFilteredLinkPIDs:function(t){var n=[];if(!e.is(t.result)||0===t.result.length||!e.is(t.result[0].outputs)||!e.is(t.result[0].outputs.links)||0===t.result[0].outputs.links.length)return n;var r=0;for(r=0;r<t.result.length;r+=1)t.result[r].outputs.links.forEach(function(t){e.is(t["bo.PLMEntity.V_usage"])?"Dressup"!==t["bo.PLMEntity.V_usage"]&&n.push(t.physicalid):n.push(t.physicalid)});return n},getCombinedResults:function(t){var n=1;if(!e.is(t)||0===t.length)return t;for(var r=t,s=r.result[0].outputs.references;n<r.result.length;n+=1)s.push(r.result[n].outputs.references[0]),r.result.splice(n,1);return r},getPartDataForAssignedOpers:function(e,t,r){var i=this;return new n(function(n,a){var u=i._getOperPIDs(e),c=o.getAttributes("part"),l=o.addDefaultAttributes(c),f=d(u,l),g=t+"cvservlet/navigate?SecurityContext="+encodeURIComponent(r);s.serverRequestPromise(g,"json","POST",f).then(function(e){i.addInstancesData(u,e,t,r).then(function(e){n(e)})})})},_getPartsFromKitResults:function(t){var n=[],r=new Map,s=new Map;t.member.forEach(function(e){switch(e.type){case"CreateKit":case"DetailedFasten":break;case"DELFmiFunctionIdentifiedInstance":r.set(e.id,e);break;default:s.set(e.id,e)}});for(const t of r.values()){const r=s.get(t.reference);if(!e.is(r))continue;const i=new u;i.loadWithDataStore(r,t),n.push(i)}return n},_getOperPIDs:function(t){var n=0,r=[];if(!e.is(t.instances)||0===t.instances.length)return r;var s=t.instances[0].outputs.instanceToReferenceRelations;for(n=0;n<s.length;n+=1)"DELLmiGeneralOperationInstance"===s[n]["ds6w:type"]&&r.push(s[n].physicalid);return r},addInstancesData:function(t,r,i,a){return new n(function(n,o){(function(t){var n=0;if(!e.is(t.result))return!1;for(n=0;n<t.result.length;n+=1)if(e.is(t.result[n].outputs.references))return!0;return!1})(r)||n({references:r,instances:{result:[]}});var u,c=(u={input_physical_ids:t,primitives:[{navigate_from_sr:{id:2,filter:{role:["52"],semantics:["7"]},mode:"ends"},navigate_to_sr:{id:3,filter:{role:["51"],semantics:["5"]},mode:"path"}},{navigate_from_sr:{id:4,filter:{role:["52"],semantics:["7"]},mode:"ends"},navigate_to_sr:{id:5,filter:{role:["51"],semantics:["5"]},mode:"last"},navigate_to_rel:{id:6,mode:"return_rel"}}],patterns:{instancePaths:[{id:2},{id:3}],instanceToReferenceRelations:[{id:4},{id:5},{id:6}]},fileAttributes:[],flags:[],version:3,label:"DELMOMWKB: partInstancesJson"},u=JSON.stringify(u)),l=i+"cvservlet/navigate?SecurityContext="+encodeURIComponent(a);s.serverRequestPromise(l,"json","POST",c).then(function(e){var t={references:r.result,instances:e.result};n(t)},function(e){o(e)})})},transformToPartData:function(t){var n,r,s=0,i=0,a={},c={config:o.attributeConfig.part},l={},f=[],d={},h={},p=function(t){for(var n=0,r=0,s=null,i=null,a=[];r<t.length;r+=1)if(s=t[r].outputs.instancePaths,e.is(s))for(n=0;n<s.length;n+=1)a[(i=s[n].elements)[i.length-1].physicalid]=i;return a}(t.instances);if(!e.is(t.references)||0===t.references.length)return[];var v=function(e){d=new u(c),h.elements=p[e.physicalid],d.loadWithIndexData(n,e,h,1),f.push(d)},m=null;for(i=0;i<t.references.length;i+=1)if(m=t.references[i].outputs.references,e.is(m))for(s=0;s<m.length;s+=1)n=m[s],e.is(a[n.physicalid])||(a[n.physicalid]=1,r=g(n.physicalid,t.instances),e.is(r.quantity)?((d=new u(c)).loadWithIndexData(n,l,l,r.quantity),f.push(d)):r.forEach(v));return f},addHighlightId:function(t,n){var i={instName:""},a="Connected"===s.getMapMode(n);t.forEach(t=>{var s=null;e.is(n)?a?s=r.getPathConnected(t.physicalId,n):(i.instName=t.instanceName,s=r.getPathFromMap([i],n)):s=t.physicalId,t.highlightID=s})}})});