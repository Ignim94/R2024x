define("DS/3DWorkbook/js/models/WkbDataStorePart",["UWA/Core","UWA/Class","DS/3DWorkbook/js/WkbUtils","DS/DELMOMWKIExperience/js/models/WkiSystem","DS/3DWorkbook/js/models/WkbOperation","DS/3DWorkbook/js/models/WkbPart","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,i,s,r,n,a){"use strict";const c="dsprcs:MfgOperationOcc",o=["title","name","revision","text"],m=["parent","name"],l=["isScope","itemRef","scopeContext","scopeContextWithRef","composer","itemOcc","operationOcc","usage","implLinkUsage","bo.SymbolicID.V_SymbolicID"];var u=null,f=null,g=null,d="",p=null,h=function(e,t,i){p.publish({event:"wkbNotify",data:{src:"WkbDataStore",title:e,subtitle:t,message:i,isVanishes:!1,type:"error"}})};return t.extend({uninitializedCalls:"throw",init:function(e){f=i.ematrixURL,g=i.getPrefixedSecurityContext(),this.system=null,this.isForDelmiaViewer=!1,this.cnxToCapableResourcePID=new Map,p=e.modelEvtManager},setSystemData:function(e){u=e},_getDynamicMask:function(){var e={};return e["dsprcs:MfgProcess"]=o,e["dsprcs:MfgOperation"]=o,e["dsprcs:ItemSpecification"]=l,e["dsprcs:MfgOperationInstance"]=m,e},_getProcessExpandPayload:function(e,t,i){var s={id:e,occurrenceWithRef:!0,requestedAttributesOnly:!0,dynamicMask:this._getDynamicMask(),expandVersion:2};return s=JSON.stringify(s)},loadSystemData:async function(t){const i=this._getProcessExpandPayload(t),s=f+"resources/v1/modeler/dsprcs/invoke/dsprcs:expand",r=await this._getData(s,i,"POST");if(e.is(r)&&e.is(r.member,"array")&&r.member.length>0)return this.clearCache(),u=r,!0;let n="";return widget.Debug.debugMode&&(n=`dsprcs:expand webservice returned invalid data: ${JSON.stringify(r)}`),h(a.ErrorTitle,a.ErrSystemWebService,n),!1},loadData:async function(e,t,i,s){return await this.loadSystemData(e,t,i,s)},getSystem:async function(){if(e.is(this.system))return this.system;if(!e.is(u))return null;var t=u.member[0],i=new s;return e.is(t)&&i.loadWithDataStore(t),"ForConfiguredProcess"===i.usage&&(this.isForDelmiaViewer=!0),i.configFilterBinary=this.configFilterBinary,i.scopedMfgItemPID=this.scopedMfgItem,i.installPath=this.getInstallPath(),widget.wkbIsLanguageTranslation&&(i=await this.getTranslatedSystem(i)),this.system=i,this.system},_getOperationOccs:function(){let t=[];return e.is(u.member[0][c])?t=u.member[0][c].member:t},getOperations:async function(){var t=[],i=this._getOperationOccs();if(0===i.length)return t;if(t=function(e,t){for(var i=0,s=[];i<e.length;i+=1){var r=new t;r.loadWithDataStore(e[i]),s.push(r)}return s}(i,r,u.member[0].id),widget.wkbIsLanguageTranslation&&t.length>0){t=await this.getTranslatedObjects(t);for(let i=0;i<t.length;i+=1){const r=t[i];if(e.is(r.children)&&r.children.length>0){var s=await this.getTranslatedObjects(r.children);t[i].children=s}}}return t},_getAllItemsSpecifications:function(t){const i=this._getOperationOccurrence(t);let s=[];if(e.is(i["dsprcs:ItemSpecificationOcc"])&&(s=i["dsprcs:ItemSpecificationOcc"].member),!e.is(i[c]))return s;const r=i[c].member;for(let t=0;t<r.length;t+=1)if(e.is(r["dsprcs:ItemSpecificationOcc"])){const e=r["dsprcs:ItemSpecificationOcc"].member;s=s.concat(e)}return s},getParts:async function(t){var i=[],s=[],r=[],a=[],c=new Map,o=new Map;for(let n=0;n<t.length;n+=1){const a=this._getOperationOccurrence(t[n]);e.is(a)&&e.is(a["dsprcs:ItemSpecificationOcc"])&&a["dsprcs:ItemSpecificationOcc"].member.forEach(function(t){if(!e.is(t.itemOcc)||e.is(t.implLinkUsage)&&"Dressup"===t.implLinkUsage)return;const n=t.itemOcc[t.itemOcc.length-1];if(i.push(n),t.itemOcc.length>1){const e=t.itemOcc[t.itemOcc.length-2];s.push(e),c.set(e,t),o.set(e,n),r.push(t)}else s.push("")})}if(0===i.length)return[];let m=JSON.stringify(i),l=f+"resources/v1/modeler/dsmfg/dsmfg:MfgItem/getItems?$mask=dsmfg:MfgItemMask.Details",u=await this._getData(l,m,"POST");if(!e.is(u.member))return[];u=u.member;const g=new Map(u.map(e=>[e.id,e]));let d=[];if(m=JSON.stringify(s),l=f+"resources/v1/modeler/dsmfg/dsmfg:MfgItem/getItems?$mask=dsmfg:MfgItemInstanceMask.Details",d=await this._getData(l,m,"POST"),!e.is(d.member))return a;d=d.member;const p=new Map(d.map(e=>[e.id,e]));return r.forEach(function(e){const t=e.itemOcc[e.itemOcc.length-1],i=new n,s=e.itemOcc[e.itemOcc.length-2];i.loadWithDataStore(g.get(t),p.get(s),e),a.push(i)}),a},_getOperationOccurrence:function(t){if(""===t||!e.is(t))return d;if(!e.is(u.member[0][c]))return{};var i=u.member[0][c].member;if(d=i.find(function(e){return e.id.indexOf(t)>0}),e.is(d))return d;var s=null;for(let r=0;r<i.length;r+=1)if(e.is(i[r][c])&&(s=i[r][c].member,d=s.find(function(e){return e.id.indexOf(t)>0}),e.is(d)))return d;return d},_getData:async function(e,t,s){var r=performance.now(),n=null;s=s||"GET",t=t||"";try{n=await i.serverRequestPromise(e,"json",s,t,g)}catch(e){var c="";widget.Debug.debugMode&&(c=e.message),h(a.ErrorTitle,a.ErrSystemWebService,c)}var o=performance.now();return widget.Debug.log(`************** Time for WkbDataStore._getData(${e}): ${(o-r)/1e3} seconds.`),n},clearCache:function(){this.system=null,this.isForDelmiaViewer=!1}})});