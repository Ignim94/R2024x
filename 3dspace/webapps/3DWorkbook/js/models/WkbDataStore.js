define("DS/3DWorkbook/js/models/WkbDataStore",["UWA/Core","UWA/Class","DS/3DWorkbook/js/WkbUtils","DS/DELMOMWKIExperience/js/models/WkiSystem","DS/3DWorkbook/js/models/WkbAttributeConfig","DS/3DWorkbook/js/models/WkbOperation","DS/3DWorkbook/js/models/WkbInstruction","DS/3DWorkbook/js/models/WkbDCPlan","DS/3DWorkbook/js/models/WkbDCRow","DS/3DWorkbook/js/models/WkbDataCollect","DS/3DWorkbook/js/models/WkbSignoff","DS/3DWorkbook/js/models/WkbAlert","DS/3DWorkbook/js/models/WkbPart","DS/3DWorkbook/js/models/WkbMfgItemDS","DS/3DWorkbook/js/models/WkbSystemDS","DS/3DWorkbook/js/models/WkbLangTranslator","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,r,s,n,i,c,a,o,l,u,m,d,p,f,g,b){"use strict";const h="dsprcs:MfgOperationOcc",O="dsprcs:MfgOperation",D=["title","name","revision","text"],k=["title","name","revision","treeOrder","text","bo.dellmilinkonmbom.v_linkonmbom","bo.delwkilinkonrsc.v_linkonrsc"],y=["title","name","revision","bo.dellmilinkonmbom.v_linkonmbom","bo.delwkilinkonrsc.v_linkonrsc"],S=["treeOrder"],I=["parent","name"],v=["dcType","label","title","name","bo.dellmilinkonmbom.v_linkonmbom","bo.delwkilinkonrsc.v_linkonrsc"],C=["dcType","label","capableResourceId","bo.dellmilinkonmbom.v_linkonmbom","bo.DELLmiLinkOnRsc.V_LinkOnRsc"],_=["resource","isPreferred","isReservedFromFirstStep","bo.SymbolicID.V_SymbolicID"],P=["resource","dependsOn","isReservedFromFirstStep","bo.SymbolicID.V_SymbolicID"],R=["resource","operationOcc"],w=["isScope","itemRef","scopeContext","scopeContextWithRef","composer","itemOcc","operationOcc","usage","implLinkUsage","bo.SymbolicID.V_SymbolicID"],W=["usage"],M=["capableResourceId","availabilityMode","bo.SymbolicID.V_SymbolicID"],x=["capableResourceId","availabilityMode"];var A=null,T=null,L=r.getPrefixedSecurityContext(),E="",j=null;let F=new Map;var V=function(e,t,r){j.publish({event:"wkbNotify",data:{src:"WkbDataStore",title:e,subtitle:t,message:r,isVanishes:!1,type:"error"}})},N=function(e,t){for(var r=0,s=[];r<e.length;r+=1){var n=new t;n.loadWithDataStore(e[r]),s.push(n)}return s};function U(e,t){for(var r={},s=[],n=0,i=null;n<e.length;n++)r[i=e[n]]||(r[i]=!0,s.push(i));for(n=0;n<t.length;n++)r[i=t[n]]||(r[i]=!0,s.push(i));return s}return t.singleton({uninitializedCalls:"throw",init:function(e){this.operationOccMap=new Map,this.lastPublishModified="",T=r.ematrixURL,L=r.getPrefixedSecurityContext(),this.system=null,this.isForDelmiaViewer=!1,this.cnxToCapableResourcePID=new Map,j=e.modelEvtManager},setSystemData:function(e){this.clearCache(),A=e},_getAllDCPlanRowAttributes:function(){var e=[];return e=U(n.getAttributes(["dcplanrow_real"]),C),e=U(n.getAttributes(["dcplanrow_integer"]),e),e=U(n.getAttributes(["dcplanrow_text"]),e),e=U(n.getAttributes(["dcplanrow_boolean"]),e),e=U(n.getAttributes(["dcplanrow_timestamp"]),e)},_getDynamicMask:function(){var e={},t=n.getAttributes(["system"]);return t=U(t,D),e["dsprcs:MfgProcess"]=t,t=U(t=n.getAttributes(["operation"]),D),e["dsprcs:MfgOperation"]=t,e["dsprcs:ItemSpecification"]=w,t=U(t=n.getAttributes(["alert"]),k),e["dsprcs:Alert"]=t,e["dsprcs:AlertInstance"]=S,t=U(t=n.getAttributes(["instruction"]),y),e["dsprcs:Instruction"]=t,e["dsprcs:InstructionInstance"]=S,t=U(t=n.getAttributes(["datacollect"]),v),e["dsprcs:DataCollect"]=t,e["dsprcs:DataCollectInstance"]=S,t=U(t=n.getAttributes(["datacollectplan"]),v),e["dsprcs:DataCollectPlan"]=t,e["dsprcs:CheckList"]=t,e["dsprcs:DataCollectPlanInstance"]=S,e["dsprcs:CheckListInstance"]=S,e["dsprcs:DataCollectRow"]=this._getAllDCPlanRowAttributes(),t=U(t=n.getAttributes(["signoff"]),k),e["dsprcs:SignOff"]=t,e["dsprcs:SignOffInstance"]=S,t=U(t=n.getAttributes(["document"]),D),e["dsdoc:Document"]=t,e["dsprcs:PrimaryCapableResource"]=_,e["dsprcs:SecondaryCapableResource"]=P,e["dsprcs:PreAssignedWorkCenter"]=R,e["dsprcs:WkiDocument"]=W,e["dsprcs:MfgOperationInstance"]=I,e["dsprcs:PrimaryResourceLinkDetail"]=M,e["dsprcs:SecondaryResourceLinkDetail"]=x,e},_getProcessExpandPayload:function(t,r,s){var n={id:t,occurrenceWithRef:!0,requestedAttributesOnly:!0,dynamicMask:this._getDynamicMask(),expandVersion:2};return e.is(r)&&r.length>0&&(n.config_filter=r),e.is(s)&&(n.config_filter_id=s),n=JSON.stringify(n)},loadSystemData:async function(t,r,s,n){const i=this._getProcessExpandPayload(t,r,n),c=T+"resources/v1/modeler/dsprcs/invoke/dsprcs:expand",a=await this._getData(c,i,"POST");if(e.is(a)&&e.is(a.member,"array")&&a.member.length>0)return this.clearCache(),this.configFilterBinary=r,this.scopedMfgItem=s,A=a,!0;let o="";return widget.Debug.debugMode&&(o=`dsprcs:expand webservice returned invalid data: ${JSON.stringify(a)}`),V(b.ErrorTitle,b.ErrSystemWebService,o),!1},loadConfiguredSystem:async function(e,t,r){var s;s=this._getProcessExpandPayload(e,t,r);var n=T+"resources/v1/modeler/dsprcs/invoke/dsprcs:expand";A=await this._getData(n,s,"POST")},loadData:async function(e,t,r,s){return await this.loadSystemData(e,t,r,s)},setCurrentOperation:function(e){E=e},getScopedMfgItem:function(){if(!e.is(A))return null;var t=A.member[0]["dsprcs:ItemSpecification"].member[0];return t.isScope?Array.isArray(t.itemRef)?t.itemRef:[t.itemRef]:[]},isConfigured:async function(){var t=r.getServerConfig();t.modelEvtManager=j;var s=new p(t),n=this.getScopedMfgItem();if(await s.getIsMfgItemConfigured(n[0]))return!0;var i=await this.getSystem();if(!e.is(i))return!1;var c=new f(t);return await c.getIsSystemConfigured(i.physicalId)},_findDCPlanReference:function(t,r,s,n){var i=this._getOperationOccurrence(r);return e.is(i)&&e.is(i[s])?i[s].member.find(function(e){return e[n].id===t}):null},getDataCollectRows:function(t,r){var s=[],n="dsprcs:DataCollectPlan",i=this._findDCPlanReference(t,r,"dsprcs:DataCollectPlanOcc","dsprcs:DataCollectPlan");if(e.is(i)||(i=this._findDCPlanReference(t,r,"dsprcs:CheckListOcc","dsprcs:CheckList"),n="dsprcs:CheckList"),e.is(i)&&e.is(i[n]["dsprcs:DataCollectRow"])){var c=i[n]["dsprcs:DataCollectRow"].member;s=N(c,o)}return s},_addTextToWkiItems:async function(t,r){var s,n=0,i=0,c=null,a=null,o=[];for(n=0;n<t.length;n+=1)o.push(t[n].physicalId);var l=JSON.stringify(o),u=T+"resources/v1/modeler/dsprcs/dsprcs:"+r+"/bulkFetch?$mask=dsprcs:"+r+"Mask.Details";if(s=await this._getData(u,l,"POST"),!e.is(s.member)||0===s.member.length)return t;var m=s.member;for(n=0;n<m.length;n+=1)for(c=m[n].id,i=0;i<t.length;i+=1)if(c===t[i].physicalId){e.is(t[i].text)&&(t[i].text=m[n].text),(a=t[i].attributeMetaList.findIndex(function(e){return"text"===e}))>0&&(t[i].attributeValues[a]=m[n].text);break}return t},getWkiItems:async function(e,t){for(var r=0,s=null,n=[],i=this._getOperationOccurrence(e),o=Object.keys(i);r<o.length;r+=1)switch(s=o[r]){case"dsprcs:InstructionOcc":var d=N(i[s].member,c);t||d.length>0&&(d=await this._addTextToWkiItems(d,"Instruction")),n=n.concat(d);break;case"dsprcs:SignOffOcc":var p=N(i[s].member,u);t||p.length>0&&(p=await this._addTextToWkiItems(p,"SignOff")),n=n.concat(p);break;case"dsprcs:AlertOcc":var f=N(i[s].member,m);t||f.length>0&&(f=await this._addTextToWkiItems(f,"Alert")),n=n.concat(f);break;case"dsprcs:DataCollectOcc":var g=N(i[s].member,l);n=n.concat(g);break;case"dsprcs:CheckListOcc":case"dsprcs:DataCollectPlanOcc":var b=N(i[s].member,a);n=n.concat(b)}return n.sort(function(e,t){return parseFloat(e.treeOrder)-parseFloat(t.treeOrder)}),widget.wkbIsLanguageTranslation&&n.length>0&&(n=await this.getTranslatedObjects(n)),n},getPublishedUsage:function(){return e.is(this.system)?this.system.usage:""},setSystemLastPublishModified:function(e){this.lastPublishModified=e},getInstallPath:function(){var t=[];if(!(e.is(A)&&e.is(A.member,"array")&&0!==A.member.length&&e.is(A.member[0]["dsprcs:ItemSpecification"])&&e.is(A.member[0]["dsprcs:ItemSpecification"].member)))return t;var r=A.member[0]["dsprcs:ItemSpecification"].member[0];return e.is(r.scopeContextWithRef)&&(t=r.scopeContextWithRef),t},getTranslatedObjects:async function(e){var t=new g({modelEvtManager:j});return await t.translateAttributes(e)},getTranslatedSystem:async function(e){var t=new g({modelEvtManager:j});return e=await t.translateSystem(e)},getSystem:async function(){if(e.is(this.system))return this.system;if(!e.is(A))return null;var t=A.member[0],r=new s;return e.is(t)&&r.loadWithDataStore(t,n),"ForConfiguredProcess"===r.usage&&(this.isForDelmiaViewer=!0),r.lastPublishModified=this.lastPublishModified,r.configFilterBinary=this.configFilterBinary,r.scopedMfgItemPID=this.scopedMfgItem,r.installPath=this.getInstallPath(),widget.wkbIsLanguageTranslation&&(r=await this.getTranslatedSystem(r)),this.system=r,this.system},getSystemDocuments:function(){var e=A.member[0]["dsdoc:Document"];return this._documentsExist(e)?e.member:[]},_documentsExist:function(t){return!!(e.is(t)&&e.is(t.member)&&t.member.length>0)},_getOperationOccs:function(){let t=[];return e.is(A.member[0][h])?t=A.member[0][h].member:t},getOperationDocuments:function(e){var t=this._getOperationOccurrence(e)[O]["dsdoc:Document"];return this._documentsExist(t)?t.member:[]},_getWkiItemReferenceName:function(e){var t=null;switch(e){case"dsprcs:InstructionOcc":t="dsprcs:Instruction";break;case"dsprcs:SignOffOcc":t="dsprcs:SignOff";break;case"dsprcs:AlertOcc":t="dsprcs:Alert";break;case"dsprcs:DataCollectOcc":t="dsprcs:DataCollect";break;case"dsprcs:CheckListOcc":t="dsprcs:CheckList";break;case"dsprcs:DataCollectPlanOcc":t="dsprcs:DataCollectPlan"}return t},_getInstructionReference:function(t,r){const s=Object.keys(r);for(let i=0;i<s.length;i++){const c=s[i];var n=this._getWkiItemReferenceName(c);if(e.is(n))for(let e=0;e<r[c].totalItems;e++){const s=r[c].member[e];if(s[n].id===t)return s[n]}}return null},getWkiItemDocuments:function(t,r){var s=[];if(!e.is(t)||!e.is(r))return s;var n=this._getOperationOccurrence(r),i=this._getInstructionReference(t,n);return e.is(i)&&e.is(i["dsdoc:Document"])?i["dsdoc:Document"].member:s},getOperations:async function(){var t=[],r=this._getOperationOccs();if(0===r.length)return t;if(t=N(r,i,A.member[0].id),widget.wkbIsLanguageTranslation&&t.length>0){t=await this.getTranslatedObjects(t);for(let r=0;r<t.length;r+=1){const n=t[r];if(e.is(n.children)&&n.children.length>0){var s=await this.getTranslatedObjects(n.children);t[r].children=s}}}return t},getChildOperations:async function(t){var r=[],s=[],n=this._getOperationOccs();if(0===n.length)return r;var c=(r=N(n,i,A.member[0].id)).find(e=>e.physicalId===t);return e.is(c)&&(s=c.children),s},getPrimaryCapableResource:function(t,r){let s=null,n=null;if(e.is(r)){n=this._getOperationOccurrence(r)[O]}else n=A.member[0];if(e.is(n)&&e.is(n["dsprcs:PrimaryCapableResource"])){s=n["dsprcs:PrimaryCapableResource"].member.find(e=>e.resource===t)}return s},getPrimaryCapableResourceFromLink:function(t){const r=this._getOperationOccs();for(let s=0;s<r.length;s+=1){const n=r[s][O];if(e.is(n)&&e.is(n["dsprcs:PrimaryCapableResource"])){const r=n["dsprcs:PrimaryCapableResource"].member.find(e=>e.id===t);if(e.is(r))return r}if(e.is(n)&&e.is(n["dsprcs:SecondaryCapableResource"])){const r=n["dsprcs:SecondaryCapableResource"].member.find(e=>e.id===t);if(e.is(r))return r}}return null},_isResourceExist:function(t){return!(!e.is(t)||!e.is(t["dsprcs:SecondaryCapableResource"])||!t["dsprcs:SecondaryCapableResource"].member.length>0)},getOperationSecondaryResourceData:function(e){const t=this._getOperationOccurrence(e)[O];return this._isResourceExist(t)?t["dsprcs:SecondaryCapableResource"].member:[]},getSecondaryResourceData:function(e,t){const r=this.getOperationSecondaryResourceData(e,t);if(0===r.length)return[];const s=this.getPrimaryCapableResource(t,e).id;var n=[];return r.forEach(e=>{e.dependsOn===s&&n.push(e)}),n},getSecondaryCapableToolPIDs:function(e,t){const r=this.getOperationSecondaryResourceData(e,t);if(0===r.length)return[];const s=this.getPrimaryCapableResource(t,e).id;var n=[];return r.forEach(e=>{e.dependsOn===s&&n.push(e.resource)}),n},_getCapableResourcesData:function(t){if(!e.is(t)||!e.is(t["dsprcs:PrimaryCapableResource"]))return[];return t["dsprcs:PrimaryCapableResource"].member},getCapableResourcePIDs:function(e){var t=[];return this._getCapableResourcesData(e).forEach(e=>{t.push(e.resource)}),t},getAssignedCapableResourcePIDs:function(e,t){return["test"]},getOperationCapableResourceData:function(e){var t=this._getOperationOccurrence(e);return this._getCapableResourcesData(t[O])},getOperationCapableResources:function(e){var t=this._getOperationOccurrence(e);return this.getCapableResourcePIDs(t[O])},getOperationCapableToolPIDs:function(e){var t=this._getOperationOccurrence(e);return this.getCapableResourcePIDs(t[O])},getSystemCapableToolPIDs:function(e){var t=A.member[0];return this.getCapableResourcePIDs(t)},_getAllItemsSpecifications:function(t){const r=this._getOperationOccurrence(t);let s=[];if(e.is(r["dsprcs:ItemSpecificationOcc"])&&(s=r["dsprcs:ItemSpecificationOcc"].member),!e.is(r[h]))return s;const n=r[h].member;for(let t=0;t<n.length;t+=1)if(e.is(n["dsprcs:ItemSpecificationOcc"])){const e=n["dsprcs:ItemSpecificationOcc"].member;s=s.concat(e)}return s},getParts:async function(t){var r=[],s=[],n=[],i=[],c=new Map;F=new Map;for(let i=0;i<t.length;i+=1){const a=this._getOperationOccurrence(t[i]);e.is(a)&&e.is(a["dsprcs:ItemSpecificationOcc"])&&a["dsprcs:ItemSpecificationOcc"].member.forEach(function(t){if(!e.is(t.itemOcc)||e.is(t.implLinkUsage)&&"Dressup"===t.implLinkUsage)return;const i=t.itemOcc[t.itemOcc.length-1];if(r.push(i),t.itemOcc.length>1){const e=t.itemOcc[t.itemOcc.length-2];s.push(e),c.set(e,t),F.set(e,i),n.push(t)}else s.push("")})}if(0===r.length)return[];let a=JSON.stringify(r),o=T+"resources/v1/modeler/dsmfg/dsmfg:MfgItem/getItems?$mask=dsmfg:MfgItemMask.Details",l=await this._getData(o,a,"POST");if(!e.is(l.member))return[];l=l.member;const u=new Map(l.map(e=>[e.id,e]));let m=[];if(a=JSON.stringify(s),o=T+"resources/v1/modeler/dsmfg/dsmfg:MfgItem/getItems?$mask=dsmfg:MfgItemInstanceMask.Details",m=await this._getData(o,a,"POST"),!e.is(m.member))return i;m=m.member;const p=new Map(m.map(e=>[e.id,e]));return n.forEach(function(e){const t=e.itemOcc[e.itemOcc.length-1],r=new d,s=e.itemOcc[e.itemOcc.length-2];r.loadWithDataStore(u.get(t),p.get(s),e),i.push(r)}),i},getPartInstanceToReferenceMap:function(){return F},_getOperationOccurrence:function(t){var r=null;if(!e.is(t))return this.operationOccMap.get(E);if(r=this.operationOccMap.get(t),e.is(r))return r;if(!e.is(A.member[0][h]))return{};var s=A.member[0][h].member;if(r=s.find(function(e){return e.id.indexOf(t)>0}),e.is(r))return this.operationOccMap.set(t,r),r;for(let n=0;n<s.length;n+=1)if(e.is(s[n][h])&&(r=s[n][h].member.find(function(e){return e.id.indexOf(t)>0}),e.is(r)))return this.operationOccMap.set(t,r),r;return r},_getData:async function(e,t,s){var n=performance.now(),i=null;s=s||"GET",t=t||"";try{i=await r.serverRequestPromise(e,"json",s,t,L)}catch(e){var c="";widget.Debug.debugMode&&(c=e.message),V(b.ErrorTitle,b.ErrSystemWebService,c)}var a=performance.now();return widget.Debug.log(`************** Time for WkbDataStore._getData(${e}): ${(a-n)/1e3} seconds.`),i},getPreassignedWorkCenterPID:async function(t){var r=null;const s=this._getOperationOccurrence(t);if(!e.is(s)||!e.is(s["dsprcs:PreAssignedWorkCenter"]))return r;const n=s["dsprcs:PreAssignedWorkCenter"].member;return n.length>0&&(r=n[0].resource),r},getAllOperationLinkedToInstruction:function(t){var r=[];const s=this._getOperationOccs();if(0===s.length)return r;for(let n=0;n<s.length;n++){const i=s[n][h].member;for(let s=0;s<i.length;s++){const n=i[s]["dsprcs:InstructionOcc"];e.is(n)&&(n.member.find(e=>{const r=e["dsprcs:InstructionInstance"];return!!r&&r.id===t})&&r.push(i[s]["dsprcs:MfgOperationInstance"].id))}}return r},clearCache:function(){this.operationOccMap.clear(),this.lastPublishModified="",this.system=null,this.isForDelmiaViewer=!1}})});