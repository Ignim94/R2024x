define("DS/3DWorkbook/js/models/WkbToolDS",["UWA/Core","UWA/Class","UWA/Promise","DS/3DWorkbook/js/WkbHighlightUtil","DS/3DWorkbook/js/WkbUtils","DS/3DWorkbook/js/models/WkbModelUtils","DS/3DWorkbook/js/models/WkbDataStore","DS/3DWorkbook/js/models/WkbAttributeConfig","DS/3DWorkbook/js/models/WkbTool","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,r,s,a,n,i,o,l,c){"use strict";var u=null;let d=null;function g(e,t){var r;for(r=0;r<e.length;r+=1)if(e[r].input_object.physicalid===t)return e[r].outputs.references[0];return null}return t.extend({init:function(e,t){u=e,d=t},getSystemCapableToolsByDatastore:async function(t){var r=i.getSystemCapableToolPIDs(t),s=await this.getCapableResourceObjects(r);return widget.wkbIsLanguageTranslation&&e.is(s)&&s.length>0&&(s=await n.getTranslatedObjects(s,u)),s},getSystemCapableTools:async function(e){return this.getSystemCapableToolsByDatastore(e)},_addLinkAttributes:function(t,r,s){const a=e.is(s);t.forEach(t=>{if(a)t.isPreferred=s.get(t.physicalId);else{const s=i.getPrimaryCapableResource(t.physicalId,r);e.is(s)?(t.isPreferred=s.isPreferred,t.isReservedFromFirstStep=s.isReservedFromFirstStep):(t.isPreferred=!1,t.isReservedFromFirstStep=!1)}})},getOperationCapableTools:async function(t){var r=i.getOperationCapableToolPIDs(t),s=await this.getCapableResourceObjects(r,t);return s=await this._addSecondaryCapableResources(s,t),widget.wkbIsLanguageTranslation&&e.is(s)&&s.length>0&&(s=await n.getTranslatedObjects(s,u)),s},getOperationCapableToolsEx:async function(t){var r=[],s=[],a=t.physicalId,o=i.getOperationCapableToolPIDs(a);if(e.is(o)&&o.length>0&&(r=await this.getCapableResourceObjects(o,a)),"OPERATION"===t.parentType){const e=t.rirPath[2];s=await this.getCapResourcesFromHeader(e,a)}return r=r.concat(s),r=await this._addSecondaryCapableResources(r,a),widget.wkbIsLanguageTranslation&&e.is(r)&&r.length>0&&(r=await n.getTranslatedObjects(r,u)),r},getWorkCenter:async function(t){if(!e.is(t)||0===t.length)return null;const r=d+"resources/v1/modeler/dsrsc/dsrsc:OrganizationalResource/"+t,s=a.getPrefixedSecurityContext();const n=(await a.serverRequestPromise(r,"json","GET",null,s)).member,i={config:o.attributeConfig.tool};var c=new l(i);return c.loadWithWebServiceData(n[0]),c},getWorkCenterTitle:async function(t){return e.is(t)?(await this.getWorkCenter(t)).title:null},getToolsData:async function(t,r){var s=[];if(!e.is(t))return[];var i=function(e){var t={input_physical_ids:[e],primitives:[{navigate_from_sr:{id:2,filter:{role:["51"],semantics:["5"]},mode:"ends"},navigate_to_sr:{id:3,filter:{role:["250"],semantics:["1"]},mode:"path"}}],patterns:{instances:[{id:2},{id:3}]},attributes:[],fileAttributes:[],version:3,label:"DELMOMWKB: ToolInstanceJson"};return JSON.stringify(t)}(t);try{const e=d+"cvservlet/navigate?SecurityContext="+encodeURIComponent(r);var o=await a.serverRequestPromise(e,"json","POST",i),l=await this.addReferenceData(o,r);l.references.length>0&&(s=this.transformToToolData(l))}catch(e){console.log(e);var g="";widget.Debug.debugMode&&(g=e.message),u.publish({event:"wkbNotify",data:{src:"wkbToolDS",title:c.ErrorTitle,subtitle:c.ErrToolListWebService,message:g,isVanishes:!1,type:"error"}})}return widget.wkbIsLanguageTranslation&&e.is(s)&&s.length>0&&(s=await n.getTranslatedObjects(s,u)),s},transformToToolData:function(e){var t,r=0,s=-1,a={config:o.attributeConfig.tool},n=[],i={},c=e.instances,u=null;for(r=0;r<c.length;r+=1)i=new l(a),(s=c[r].elements.length-1)<0||(i.instancePhysicalId=c[r].elements[s].physicalid,t=g(e.references,i.instancePhysicalId),u=c[r].elements,i.loadWithIndexData(t,c[r].elements[s],u),n.push(i));return n},_transformCapableToolData:function(t,r){var s=[];if(!e.is(t.member)||0===t.member.length)return s;const a=t.member,n={config:o.attributeConfig.tool};for(let t=0;t<a.length;t+=1){var i=new l(n);e.is(r)?i.loadWithWebServiceData(a[t],r[t]):i.loadWithWebServiceData(a[t]),s.push(i)}return s},addReferenceData:function(t,s){return new r(function(r,n){var i=0,l=-1,c=null,u=o.getAttributes("tool"),g=o.addDefaultAttributes(u),f=[];0!==t.result.length&&e.is(t.result[0].outputs.instances)||r(c={references:[],instances:t});var h=t.result[0].outputs.instances;if(e.is(h)){for(i=0;i<h.length;i+=1)(l=h[i].elements.length-1)>=0&&f.push(h[i].elements[l].physicalid);var p=function(e,t){var r={input_physical_ids:e,primitives:[{navigate_to_rel:{id:7}}],patterns:{references:[{id:7}]},attributes:t,fileAttributes:[],flags:[],version:3,label:"DELMOMWKB: ToolReferenceJson"};return r=JSON.stringify(r)}(f,g);const e=d+"cvservlet/navigate?SecurityContext="+encodeURIComponent(s);a.serverRequestPromise(e,"json","POST",p).then(function(e){c={references:e.result,instances:h},r(c)},function(e){n(e)})}})},_getSecondaryResources:function(t,s,n){const i=d+"resources/v1/modeler/dsrsc/dsrsc:Resource/getItems?$mask=dsmvrsc:ResourceMask.Details",c=a.getPrefixedSecurityContext();return t=JSON.stringify(t),new r((r,u)=>{var d=[];a.serverRequestPromise(i,"json","POST",t,c).then(function(t){if(!e.is(t)||0===t.length)return r(d),d;var a={};a.config=o.attributeConfig.tool;var i=0;for(i=0;i<t.member.length;i+=1){var c=new l(a);c.loadWithWebServiceData(t.member[i],n[i]),d.push(c)}d.unshift({index:s}),r(d)})})},_addSecondaryCapableResources:async function(t,s){var a=this,n=[];return new r(function(o,l){var c=0;for(c=0;c<t.length;c+=1){const r=t[c];var u=i.getSecondaryCapableToolPIDs(s,r.physicalId);const o=i.getSecondaryResourceData(s,r.physicalId);e.is(u)&&u.length>0&&n.push(a._getSecondaryResources(u,c,o))}r.all(n).then(function(r){var s=0,a=0,n=null;for(e.is(r)||o(t);s<r.length;s+=1)n=r[s],e.is(n)&&0!==n.length&&(a=n[0].index,n.shift(),t[a].children=n);o(t)})})},_getPreferredOrder:function(e){if(e.length<2)return e;const t=e.findIndex(e=>!0===e.isPreferred);if(-1===t)return e;var r=e[t];return e.splice(t,1),e.unshift(r),e},getCapableResourceObjects:async function(t,r,s){var o=[],l=null;const c=d+"resources/v1/modeler/dsrsc/dsrsc:Resource/getItems?$mask=dsmvrsc:ResourceMask.Details",g=a.getPrefixedSecurityContext();if(!e.is(t)||0===t.length)return o;var f=JSON.stringify(t),h=await a.serverRequestPromise(c,"json","POST",f,g);return e.is(r)&&(l=i.getOperationCapableResourceData(r)),o=this._transformCapableToolData(h,l),this._addLinkAttributes(o,r,s),o=this._getPreferredOrder(o),widget.wkbIsLanguageTranslation&&e.is(o)&&o.length>0&&(o=await n.getTranslatedObjects(o,u)),o},getCurrentOperationIndex:function(e,t){for(var r=0;r<e.length;r++)if(e[r].physicalId===t)return r;return null},_isCapResourceAssignedByAvailMode:function(e,t,r){switch(e){case"Reserved":if(t>=r)return!0;break;case"StepOnly":if(t===r)return!0}return!1},_isDisplayedByUsage:function(t,r,s,a,n,i){var o=null;o=s[a];const l=r.find(e=>e.resource===t.physicalId);var c=o[n].find(e=>e.capableResourceId===l.id);if(e.is(c)&&("Reserved"===c.availabilityMode||"StepOnly"===c.availabilityMode))return!0;for(let t=a-1;t>-1;t--)if(c=(o=s[t])[n].find(e=>e.capableResourceId===l.id),e.is(c)){if("Released"===c.availabilityMode)return!1;if(this._isCapResourceAssignedByAvailMode(c.availabilityMode,a,t))return!0}return!!i},_addSecondaryCapResourcesFromHeader:async function(t,r,s){var a=this,n=null;const o=i.getOperationSecondaryResourceData(r),l=await i.getChildOperations(r),c=this.getCurrentOperationIndex(l,s);for(let r=0;r<t.length;r++){var u=[];n=t[r].children,e.is(n,"array")&&0!==n.length&&(n.forEach(e=>{a._isDisplayedByUsage(e,o,l,c,"secondaryResourceLinks",t[r].isReservedFromFirstStep)&&u.push(e)}),t[r].children=u)}return t},getPrimaryResourcesFromHeader:async function(t,r){var s,a=this,n=[],o=await this.getOperationCapableTools(t);if(!e.is(o)||0===o.length)return n;const l=await i.getChildOperations(t);s=this.getCurrentOperationIndex(l,r);const c=i.getOperationCapableResourceData(t);return o.forEach(e=>{a._isDisplayedByUsage(e,c,l,s,"primaryResourceLinks",e.isReservedFromFirstStep)&&n.push(e)}),n},getCapResourcesFromHeader:async function(e,t){var r=await this.getPrimaryResourcesFromHeader(e,t);return await this._addSecondaryCapResourcesFromHeader(r,e,t)},addHighlightId:function(t,r){var n=null,i="Connected"===a.getMapMode(r);t.forEach(t=>{var a=null;e.is(r)?i?a=s.getPathConnectedFromReferenceName(t.id,r):(n=t.id,a=s.getToolHighlightPathFromRefName(n,r,"3DXML")):a=t.physicalId,t.highlightID=a})}})});