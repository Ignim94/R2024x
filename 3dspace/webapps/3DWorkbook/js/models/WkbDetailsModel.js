define("DS/3DWorkbook/js/models/WkbDetailsModel",["UWA/Core","UWA/Class","UWA/Promise","DS/CoreEvents/ModelEvents","DS/3DWorkbook/js/models/WkbWkiItemsDS","DS/3DWorkbook/js/models/WkbDataCollectionDS","DS/3DWorkbook/js/models/WkbDocumentDS","DS/3DWorkbook/js/models/WkbToolDS","DS/3DWorkbook/js/models/WkbDataStore","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,n,a,s,o,i,r,l,c){"use strict";return t.extend({init:function(e){this.modelEvtManager=e.modelEvtManager||new a,this.ematrixURL=e.ematrixURL,this.security=e.security},getWkiIndexData:async function(t){var a=null,o=null;widget.Debug.log("************** getWkiIndexData");var i={ematrixURL:this.ematrixURL,securityContext:this.security,modelEvtManager:this.modelEvtManager},r=new s(i);try{if(a=await r.getWkiItems(t),e.is(a)||(a=[]),0===a.length)return a;var l=this._getOperationInstancePID(t);return a=await this._addAssignedCapableResources(a,l,i),o=await this._addDCPlanChildren(a,i),await this._addDocumentsToData(o,i,l)}catch(e){n.reject(e)}},getInstruction:async function(e,t){var n={ematrixURL:this.ematrixURL,securityContext:this.security,modelEvtManager:this.modelEvtManager},a=new s(n);return await a.getInstruction(e,t)},_addAssignedCapableResources:async function(t,n,a){if("capable"!==widget.getValue("resType"))return t;for(var s=0,o=null,i=new r(a.modelEvtManager,a.ematrixURL);s<t.length;s++){const a=t[s];e.is(a.capableResourcePIDs)&&a.capableResourcePIDs.length>0&&(o=await i.getCapableResourceObjects(a.capableResourcePIDs,n,a.capableRscPreferredMap),t[s].capableResources=o)}return t},_getOperationInstancePID:function(e){return e.length>1?e[e.length-2]:e[0]},_addDocumentsToData:function(t,a,s){return new n(function(n,o){var r=0,l=[],c=new i(a);if(e.is(t)){for(;r<t.length;r++)l.push(t[r].physicalId);c.getWkiItemDocuments(l,s,a.ematrixURL).then(function(a){for(r=0;r<t.length;r++)e.is(a)?e.is(a.get(t[r].physicalId))&&(t[r].documents=a.get(t[r].physicalId)):t[r].documents=[];n(t)},function(e){console.log(e),n(t)})}else n(t)})},_addDCPlanChildren:function(t,a){var s=0,i=[];return new n(function(r,l){for(;s<t.length;s+=1)switch(t[s].wkiType){case"DELWkiDataCollectPlanReference":t[s].children=[];var c=new o(a);i.push(c.getDataCollects(t[s].physicalId,s))}n.all(i).then(function(n){var a=0,s=0,o=null;if(e.is(n))for(;a<n.length;a+=1)o=n[a],e.is(o)&&(s=o[0].index,o.shift(),t[s].children=o);r(t)})})}})});