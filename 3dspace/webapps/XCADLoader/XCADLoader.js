define("DS/XCADLoader/XCADLoader",["UWA/Promise","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/XCADInputDocuments/XCADRepresentation","DS/XCADLoader/XCADGeomLoader","DS/Mesh/ThreeJS_Base","DS/ZipJS/zip-fs","DS/ZipJS2/LoaderInflate","DS/Visualization/Utils","DS/VisuDataAccess/ProxyAbstraction","DS/XCADLoader/XCADError","DS/XCADLoader/XCADSingleton","DS/XCADLoader/XCADZipUtils"],function(e,t,I,E,C,o,n,r,i,T,a,l,s){"use strict";const d=["IFCBUILDING","IFCBUILDINGSTOREY","IFCEXTERNALSPATIALELEMENT","IFCEXTERNALSPATIALSTRUCTUREELEMENT","IFCSITE","IFCSPACE","IFCSPATIALELEMENT","IFCSPATIALSTRUCTUREELEMENT","IFCSPATIALZONE"],F=["IFCBEAM","IFCBEAMSTANDARDCASE","IFCBUILDINGELEMENT","IFCBUILDINGELEMENTPROXY","IFCCHIMNEY","IFCCOLUMN","IFCCOLUMNSTANDARDCASE","IFCCOVERING","IFCCURTAINWALL","IFCDOOR","IFCDOORSTANDARDCASE","IFCFOOTING","IFCMEMBER","IFCMEMBERSTANDARDCASE","IFCPILE","IFCPLATE","IFCPLATESTANDARDCASE","IFCRAILING","IFCRAMP","IFCRAMPFLIGHT","IFCROOF","IFCSHADINGDEVICE","IFCSLAB","IFCSLABELEMENTEDCASE","IFCSLABSTANDARDCASE","IFCSTAIR","IFCSTAIRFLIGHT","IFCWALL","IFCWALLELEMENTEDCASE","IFCWALLSTANDARDCASE","IFCWINDOW","IFCWINDOWSTANDARDCASE"],R=["IFCAUDIOVISUALAPPLIANCE","IFCCABLEFITTING","IFCCABLESEGMENT","IFCCOMMUNICATIONSAPPLIANCE","IFCELECTRICAPPLIANCE","IFCELECTRICDISTRIBUTIONBOARD","IFCELECTRICFLOWSTORAGEDEVICE","IFCELECTRICGENERATOR","IFCELECTRICMOTOR","IFCELECTRICTIMECONTROL","IFCJUNCTIONBOX","IFCLAMP","IFCLIGHTFIXTURE","IFCMOTORCONNECTION","IFCOUTLET","IFCPROTECTIVEDEVICE","IFCPROTECTIVEDEVICETRIPPINGUNIT","IFCSOLARDEVICE","IFCSWITCHINGDEVICE","IFCTRANSFORMER"],A=["IFCAIRTERMINAL","IFCAIRTERMINALBOX","IFCAIRTOAIRHEATRECOVERY","IFCBOILER","IFCBURNER","IFCCABLECARRIERFITTING","IFCCABLECARRIERSEGMENT","IFCCHILLER","IFCCOIL","IFCCOMPRESSOR","IFCCONDENSER","IFCCOOLEDBEAM","IFCCOOLINGTOWER","IFCDAMPER","IFCDUCTFITTING","IFCDUCTSEGMENT","IFCDUCTSILENCER","IFCENGINE","IFCEVAPORATIVECOOLER","IFCEVAPORATOR","IFCFAN","IFCFILTER","IFCFLOWMETER","IFCHEATEXCHANGER","IFCHUMIDIFIER","IFCMEDICALDEVICE","IFCPIPEFITTING","IFCPIPESEGMENT","IFCPUMP","IFCSPACEHEATER","IFCTANK","IFCTUBEBUNDLE","IFCUNITARYEQUIPMENT","IFCVALVE","IFCVIBRATIONISOLATOR"],N=["IFCACTUATOR","IFCALARM","IFCALIGNMENT","IFCANNOTATION","IFCBUILDINGELEMENTPART","IFCCIVILELEMENT","IFCCONTROLLER","IFCDISCRETEACCESSORY","IFCDISTRIBUTIONCHAMBERELEMENT","IFCDISTRIBUTIONCONTROLELEMENT","IFCDISTRIBUTIONELEMENT","IFCDISTRIBUTIONFLOWELEMENT","IFCELEMENT","IFCELEMENTASSEMBLY","IFCELEMENTCOMPONENT","IFCENERGYCONVERSIONDEVICE","IFCFASTENER","IFCFEATUREELEMENT","IFCFEATUREELEMENTADDITION","IFCFEATUREELEMENTSUBTRACTION","IFCFIRESUPPRESSIONTERMINAL","IFCFLOWCONTROLLER","IFCFLOWFITTING","IFCFLOWINSTRUMENT","IFCFLOWMOVINGDEVICE","IFCFLOWSEGMENT","IFCFLOWSTORAGEDEVICE","IFCFLOWTERMINAL","IFCFLOWTREATMENTDEVICE","IFCFURNISHINGELEMENT","IFCFURNITURE","IFCGEOGRAPHICELEMENT","IFCGRID","IFCINTERCEPTOR","IFCLINEARPOSITIONINGELEMENT","IFCMECHANICALFASTENER","IFCOPENINGELEMENT","IFCOPENINGSTANDARDCASE","IFCPORT","IFCPOSITIONINGELEMENT","IFCPROJECTIONELEMENT","IFCPROXY","IFCREFERENT","IFCREINFORCINGBAR","IFCREINFORCINGELEMENT","IFCREINFORCINGMESH","IFCSANITARYTERMINAL","IFCSENSOR","IFCSTACKTERMINAL","IFCSTRUCTURALACTION","IFCSTRUCTURALACTIVITY","IFCSTRUCTURALCONNECTION","IFCSTRUCTURALCURVEACTION","IFCSTRUCTURALCURVECONNECTION","IFCSTRUCTURALCURVEMEMBER","IFCSTRUCTURALCURVEMEMBERVARYING","IFCSTRUCTURALCURVEREACTION","IFCSTRUCTURALITEM","IFCSTRUCTURALLINEARACTION","IFCSTRUCTURALMEMBER","IFCSTRUCTURALPLANARACTION","IFCSTRUCTURALPOINTACTION","IFCSTRUCTURALPOINTCONNECTION","IFCSTRUCTURALPOINTREACTION","IFCSTRUCTURALREACTION","IFCSTRUCTURALSURFACEACTION","IFCSTRUCTURALSURFACECONNECTION","IFCSTRUCTURALSURFACEMEMBER","IFCSTRUCTURALSURFACEMEMBERVARYING","IFCSTRUCTURALSURFACEREACTION","IFCSURFACEFEATURE","IFCSYSTEMFURNITUREELEMENT","IFCTENDON","IFCTENDONANCHOR","IFCTRANSPORTELEMENT","IFCUNITARYCONTROLELEMENT","IFCVIRTUALELEMENT","IFCVOIDINGFEATURE","IFCWASTETERMINAL"],L=["IFCBEAMTYPE","IFCBUILDINGELEMENTPROXYTYPE","IFCBUILDINGELEMENTTYPE","IFCCHIMNEYTYPE","IFCCOLUMNTYPE","IFCCOVERINGTYPE","IFCCURTAINWALLTYPE","IFCDOORTYPE","IFCFOOTINGTYPE","IFCMEMBERTYPE","IFCPILETYPE","IFCPLATETYPE","IFCRAILINGTYPE","IFCRAMPFLIGHTTYPE","IFCRAMPTYPE","IFCROOFTYPE","IFCSHADINGDEVICETYPE","IFCSLABTYPE","IFCSTAIRFLIGHTTYPE","IFCSTAIRTYPE","IFCWALLTYPE","IFCWINDOWTYPE"],O=["IFCAUDIOVISUALAPPLIANCETYPE","IFCCABLEFITTINGTYPE","IFCCABLESEGMENTTYPE","IFCCOMMUNICATIONSAPPLIANCETYPE","IFCELECTRICAPPLIANCETYPE","IFCELECTRICDISTRIBUTIONBOARDTYPE","IFCELECTRICFLOWSTORAGEDEVICETYPE","IFCELECTRICGENERATORTYPE","IFCELECTRICMOTORTYPE","IFCELECTRICTIMECONTROLTYPE","IFCJUNCTIONBOXTYPE","IFCLAMPTYPE","IFCLIGHTFIXTURETYPE","IFCMOTORCONNECTIONTYPE","IFCOUTLETTYPE","IFCPROTECTIVEDEVICETRIPPINGUNITTYPE","IFCPROTECTIVEDEVICETYPE","IFCSOLARDEVICETYPE","IFCSWITCHINGDEVICETYPE","IFCTRANSFORMERTYPE"],c=["IFCAIRTERMINALBOXTYPE","IFCAIRTERMINALTYPE","IFCAIRTOAIRHEATRECOVERYTYPE","IFCBOILERTYPE","IFCBURNERTYPE","IFCCABLECARRIERFITTINGTYPE","IFCCABLECARRIERSEGMENTTYPE","IFCCHILLERTYPE","IFCCOILTYPE","IFCCOMPRESSORTYPE","IFCCONDENSERTYPE","IFCCOOLEDBEAMTYPE","IFCCOOLINGTOWERTYPE","IFCDAMPERTYPE","IFCDUCTFITTINGTYPE","IFCDUCTSEGMENTTYPE","IFCDUCTSILENCERTYPE","IFCENGINETYPE","IFCEVAPORATIVECOOLERTYPE","IFCEVAPORATORTYPE","IFCFANTYPE","IFCFILTERTYPE","IFCFLOWMETERTYPE","IFCHEATEXCHANGERTYPE","IFCHUMIDIFIERTYPE","IFCMEDICALDEVICETYPE","IFCPIPEFITTINGTYPE","IFCPIPESEGMENTTYPE","IFCPUMPTYPE","IFCSPACEHEATERTYPE","IFCTANKTYPE","IFCTUBEBUNDLETYPE","IFCUNITARYEQUIPMENTTYPE","IFCVALVETYPE","IFCVIBRATIONISOLATORTYPE"];var P=0,S=function(){var n,S=null,u=null,M=null,D=null,b=[],m=0,v=0;function U(e,t){let I=[];(e.roots=I,t.rootProducts2.length>0)&&function e(t,I,E){var C=void 0,o={};let n=E.ifcEntities[I],r=n.substring(0,n.indexOf("("));if("IFCPROJECT"===r)C=e(t,E.assyProducts2[I].childrenList[0].productReferenceIdx.substring(1),E);else{o.label=r;var i=[];E.ifcTokenizeArgs(n,i);let a=[];a.push(I);let l=!1;d.includes(r)&&(l=!0);let s={ImportObject:"true",name:0};s.name=E.assyProducts2[I].referenceName,"$"===s.name&&(s.name=""),o.grid=s,l&&(s.ConversionStructure="ForLifecycle");let P={LineType:"Entity",uid:a,inCoord:!0,nbPLMObject:0,nbTotalGeometry:0,nbGeometry:0,nbTotalObjects:1};null!=i[6]&&i[6].length>1&&(P.nbGeometry+=1,P.nbTotalGeometry+=1),l&&(P.inCoord=!1,P.LineType="Spatial",P.NLS_grid={ConversionStructure:"ForLifecycle"},P.nbPLMObject+=1,null!=i[6]&&i[6].length>1&&"IFCSITE"!==r&&(P.nbPLMObject-=1)),"IFCPROJECT"===r&&(P.nbTotalObjects-=1),o.data=P,t.push(o);let S=0;if((S=E.assyProducts2[I].childrenList.length)>0){o.children=[];let t=[];for(var T=0;T<S;T++){let C=void 0,n=E.assyProducts2[I].childrenList[T].productReferenceIdx.substring(1),r=E.ifcEntities[n],i=r.substring(0,r.indexOf("("));if(l&&"IFCSITE"!==i&&"IFCBUILDING"!==i&&"IFCBUILDINGSTOREY"!==i&&"IFCSPACE"!==i){let r=void 0;if(F.includes(i))r="IfcBuildingElements";else if(R.includes(i))r="IfcElectricalDomain";else if(A.includes(i))r="IfcHvacDomain";else if(N.includes(i)){let e=E.productTypeMapping[n];r=L.includes(e)?"IfcBuildingElements":O.includes(e)?"IfcElectricalDomain":c.includes(e)?"IfcHvacDomain":"Other Discipline"}else r="Other Discipline";null==t[r]&&(t[r]=f(o.children,r,"Discipline"));let a=t[r].children;P.NLS_grid.ConversionStructure="ForCoordination",s.ConversionStructure="ForCoordination",null==t[r+"_"+i+"S"]&&(t[r+"_"+i+"S"]=f(a,i+"S","GroupOfEntities")),C=e(t[r+"_"+i+"S"].children,E.assyProducts2[I].childrenList[T].productReferenceIdx.substring(1),E),t[r].data.nbGeometry+=C.data.nbGeometry,t[r].data.nbTotalGeometry+=C.data.nbTotalGeometry,t[r].data.nbPLMObject+=C.data.nbPLMObject,t[r].data.nbTotalObjects+=C.data.nbTotalObjects,t[r].grid.nbPLMObject=t[r].data.nbPLMObject+" / "+t[r].data.nbTotalObjects,t[r].grid.nbGeometry=t[r].data.nbGeometry+" / "+t[r].data.nbTotalGeometry,t[r+"_"+i+"S"].data.nbGeometry+=C.data.nbGeometry,t[r+"_"+i+"S"].data.nbTotalGeometry+=C.data.nbTotalGeometry,t[r+"_"+i+"S"].data.nbPLMObject+=C.data.nbPLMObject,t[r+"_"+i+"S"].data.nbTotalObjects+=C.data.nbTotalObjects,t[r+"_"+i+"S"].grid.nbPLMObject=t[r+"_"+i+"S"].data.nbPLMObject+" / "+t[r+"_"+i+"S"].data.nbTotalObjects,t[r+"_"+i+"S"].grid.nbGeometry=t[r+"_"+i+"S"].data.nbGeometry+" / "+t[r+"_"+i+"S"].data.nbTotalGeometry}else C=e(o.children,E.assyProducts2[I].childrenList[T].productReferenceIdx.substring(1),E);o.data.nbGeometry+=C.data.nbGeometry,o.data.nbTotalGeometry+=C.data.nbTotalGeometry,o.data.nbPLMObject+=C.data.nbPLMObject,o.data.nbTotalObjects+=C.data.nbTotalObjects,o.grid.nbGeometry=P.nbGeometry+" / "+P.nbTotalGeometry,o.grid.nbPLMObject=P.nbPLMObject+" / "+P.nbTotalObjects}}else{P.AssociatedGeometry="0",P.nbGeometry=0,P.nbTotalGeometry=0;const e=n.split(",");null!=e[6]&&e[6].length>1&&(P.AssociatedGeometry="1",P.nbGeometry=1,P.nbTotalGeometry=1),l?(P.NLS_grid.ConversionStructure="ForCoordination",s.ConversionStructure="ForCoordination",0==P.nbGeometry?P.nbPLMObject=1:P.nbPLMObject=0,P.nbTotalObjects=1):(P.nbPLMObject=0,P.nbTotalObjects=1),s.nbGeometry=P.nbGeometry+" / "+P.nbTotalGeometry,s.nbPLMObject=P.nbPLMObject+" / "+P.nbTotalObjects}null==C&&(C=o)}return C}(I,t.rootProducts2[0].substring(1),t)}function f(e,t,I){var E={};E.label=t;E.grid={ImportObject:"true"};let C={LineType:I,inCoord:!0,nbPLMObject:0,nbTotalGeometry:0,nbGeometry:0,nbTotalObjects:0};E.data=C;return E.children=[],e.push(E),E}this.getProductStructure=async function(e,t){return this.ReadProductStructure=!0,this.load(e,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,t),e},this.getProductStructureAsJson=async function(e,t){this.ReadProductStructure=!0,this.load(e,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,t);var I={};return function(e){var t=[];e.columns=t;var I={},E={NLS_text:"IFCType"};I.data=E,I.dataIndex="tree",I.editableFlag=!1,I.text="IFC Structure",I.width="auto",t.push(I);var C={};E={NLS_text:"name"},C.data=E,C.dataIndex="name",C.editableFlag=!1,C.typeRepresentation="string",C.text="Name",C.width=120,t.push(C);var o={};E={NLS_text:"ImportObject"},o.data=E,o.dataIndex="ImportObject",o.editableFlag=!0,o.editionPolicy="EditionInPlace",o.typeRepresentation="boolean",o.text="Import",o.width=64,t.push(o);var n={};E={NLS_text:"ConversionStructure",possibleValues:["ForLifecycle","ForCoordination","ForDesign"],type:"enum"},n.data=E,n.dataIndex="ConversionStructure",n.editableFlag=!0,n.editionPolicy="EditionInPlace",n.typeRepresentation="ConversionStructure",n.text="Profile",n.width=144,t.push(n);var r={};E={NLS_text:"nbGeometry"},r.data=E,r.dataIndex="nbGeometry",r.editableFlag=!1,r.text="Geometries to Convert",r.width=184,t.push(r);var i={};E={NLS_text:"nbPLMObject",type:"runtime"},i.data=E,i.dataIndex="nbPLMObject",i.editableFlag=!1,i.text="Objects to Create",i.width=152,t.push(i)}(I),function(e){e.data={filterID:"TOFILL",formatUsage:"IFC"}}(I),U(I,e),JSON.stringify(I)},this.load=async function(d,F,R,A,N,L,O,c,U,f,G){if(S=null,u=null,M=null,D=null,null,"",b=[],1==this.ReadProductStructure){(p=d).forceRead=!0,p.noGeom=!0,await w(G)}else{F,n=F.substr(F.lastIndexOf(".")+1).toUpperCase(),S=R,u=A,M=N,D=L;var p=d,y=new o.MeshBasicMaterial({side:o.DoubleSide,transparent:!1}),Y=window.localStorage.getItem("XCAD_DebugMode");if(null!=G){if(1==d.zipped&&2==d.zipMethod&&(G=r.inflate(G)),null!=Y)var h=performance.now();if(await w(G),null!=Y){var g=performance.now();console.log("_processModel_"+P+" in "+(g-h)+" milliseconds."),window.localStorage.setItem("processModel_"+P,"_processModel in "+(g-h)+" milliseconds."),P++}}else if(1==d.zipped){var B=f.serverurl?f.serverurl:"";B+=f.filename?f.filename:"";var V=f.filename.substring(0,f.filename.lastIndexOf(".")),x=[];x.push(s.downloadFiles(B)),e.all(x).then(function(e){console.log("download Zip archive done");let t=void 0;e&&(e.forEach(function(e){l.addData(e),null!=e[V]&&(t=e[V])}),null!=t&&w(t))})}else{F.startsWith("blob")||(f.proxyurl=null);var _=new T;i.setProxyFromSpec(f,_);B=f.serverurl?f.serverurl:"";B+=f.filename?f.filename:"",_.executeGetHttpRequest(B,U,null,function(e){if(null!=Y)var t=performance.now();if(w(e),null!=Y){var I=performance.now();console.log("_processModel in "+(I-t)+" milliseconds."),window.localStorage.setItem("processModel_"+P,"_processModel in "+(I-t)+" milliseconds."),P++}})}}async function w(e){Date.now();var r=new a,i=await p.initialize(e);if(i instanceof a)return D&&D(i),void(u&&u({loaded:0,total:0}));var T=!1,l=void 0;if(1!=p.noGeom){var s=p.getRepresentation(E.XCAD_TESSELLATED_REPRESENTATION);if(void 0!==s)for(var d=(new C).load(s,u),R=0;R<d.length;R++){var A=(G=d[R]).primitive,N=G.transfo,L=G.descendants;if(0!=A.nbPrimitives||0==A.nbPrimitives&&d.length>1)if(void 0===l)(l=s.isIndexed&&!s.isIndexed()?I.createMeshNode(A,y):I.createMeshNode(A,y,0,"mono")).productType="Reference3D",null!=N&&l.setMatrix(N),m++;else{var c=void 0;c=s.isIndexed&&!s.isIndexed()?I.createMeshNode(A,y):I.createMeshNode(A,y,0,"mono"),null!=N&&c.setMatrix(N),l.addChild(c),j(L,c,s)}}else if(void 0!==(s=p.getRepresentation(E.XCAD_PRODUCT_REPRESENTATION)))for(var b=s.getRootProducts(),v=0;v<b.length;v++)0===(l=X(b[v],u,{},null)).children.length&&null==l.mesh3js&&(T=!0,console.error(F+" : "+n+" Root with no supported Geometry"),r.setError("XCADLoader/XCADLoader","error.EMPTY_ROOT",null),D&&D(r)),null!=O&&O.add(l);else T=!0,console.error(F+" : "+n+" file with no supported representation"),r.setError("XCADLoader/XCADLoader","error.NO_REP",null),D&&D(r);var U=p.getRepresentation(E.XCAD_TESSELLATED_ANNOTATION_REPRESENTATION);if(void 0!==U)if(0!=(d=(new C).load(U,u)).length){var f=new t("3DPlay_XCAD_Annotation");for(R=0;R<d.length;R++){var G;A=(G=d[R]).primitive,N=G.transfo;if(A.noz=!0,0!=A.nbPrimitives)for(var h=0;h<A.primitives.length;h++){1===A.primitives[h].attr.fill.color.r&&1===A.primitives[h].attr.fill.color.g&&1==A.primitives[h].attr.fill.color.b&&(A.primitives[h].attr.fill.color.r=0,A.primitives[h].attr.fill.color.g=0,A.primitives[h].attr.fill.color.b=0);var g=new o.LineBasicMaterial({color:A.primitives[h].attr.fill.color,dashType:A.primitives[h].attr.line.pattern,side:o.DoubleSide,force:!0});A.primitives[h].material=g}c=void 0;(c=U.isIndexed&&!U.isIndexed()?I.createMeshNode(A,y):I.createMeshNode(A,y,0,"mono")).productType="Annotation_Representation",c.setRenderLineMode(o.ShowAllRenderLineMode),null!=N&&c.setMatrix(N),f.add(c),null==Y&&f.setVisibility(!1)}null!=l&&null!=f&&l.addChild(f)}}if(null!=s&&null!=s._associatedDocument&&0==s._associatedDocument.nbInstPart&&(r.setError("XCADLoader/XCADLoader","error.EMPTY_PROD",null),D&&D(r)),null!=Y){var B="Number of detected instanciate Parts / Number of loaded instanciate Parts: "+s._associatedDocument.nbInstPart+" / "+m;console.log(B),window.localStorage.setItem("processModel_"+P,B),P++,B=m===s._associatedDocument.nbInstPart?"Number of part is OK":"Number of part is KO",console.log(B),window.localStorage.setItem("processModel_"+P,B),P++}U=null,s=null,p.close(),p=null,S&&(l?(S(l),l=null):S(null)),T||M&&M()}function j(e,t,E){for(var C=0;C<e.length;C++){var o=e[C].primitive,n=e[C].transfo,r=e[C].descendants,i=void 0;i=E&&E.isIndexed&&!E.isIndexed()?I.createMeshNode(o,y):I.createMeshNode(o,y,0,"mono"),null!=n&&i.setMatrix(n),t.addChild(i),j(r,i)}}function X(e,o,r,i){var T,l=new a,s=e.getProductAttributes(),d=s[0],R=e.getInstanceList(),A=e.getFilePath();if(void 0!==A){console.log(F+" has an external reference: "+A);var N=s[1];(T=new t(i)).productType="Instance3D",T.name=i,void 0!==N&&(N.name=d,T.add(N)),b[d]=T,m++}else{if(""!==d){var L=b[d];if(null!=L&&"Mesh3D"===L.getNodeType())return m++,L.clone();var O=e.getDocument();if(void 0!==O){O.initialize("");var c=O.getRepresentation(E.XCAD_TESSELLATED_REPRESENTATION);if(void 0!==c)for(var P=(new C).load(c,null),S=(N=void 0,0);S<P.length;S++){var u=P[S],M=u.primitive,U=u.transfo,f=u.descendants;if(0!=M.nbPrimitives||0==M.nbPrimitives&&P.length>1)if(void 0===N)(N=c.isIndexed&&!c.isIndexed()?I.createMeshNode(M,y):I.createMeshNode(M,y,0,"mono")).name=d,N.productType="Reference3D",b[d]=N,null!=U&&N.setMatrix(U),m++;else{var G=void 0;G=c.isIndexed&&!c.isIndexed()?I.createMeshNode(M,y):I.createMeshNode(M,y,0,"mono"),null!=U&&G.setMatrix(U),N.addChild(G),j(f,G,c)}}else console.warn(F+" : "+n+" file with empty representation"),l.setError("XCADLoader/XCADLoader","error.NO_REP",null),D&&D(l);O.close()}}R.length>0?void 0===T&&((T=new t(d)).productType="Instance3D",void 0!==N&&T.add(N),b[d]=T):T=N,v++;var p=Object.keys(e._document.assyProducts).length;o&&o({loaded:v,total:p});for(S=0;S<R.length;S++){var Y=H(R[S]);void 0!==Y&&T.add(Y)}}return T}function H(e){var t=e.getTransformation(),I=new o.Matrix4;if(void 0!==t&&t instanceof o.Matrix4)I=t;else{var E=void 0,C=void 0;void 0!==t?(E=t[1],C=t[0]):(E=[0,0,0],(C=[])[0]=[1,0,0],C[1]=[0,1,0],C[2]=[0,0,1]),I.set(C[0][0],C[0][1],C[0][2],E[0],C[1][0],C[1][1],C[1][2],E[1],C[2][0],C[2][1],C[2][2],E[2],0,0,0,1)}var n={CoordSys:""},r=X(e.getReferenceProduct(),null,0,e.getInstanceAttributes()[0]);if(null!=n.CoordSys&&1==n.CoordSys.Coord&&null!=n.CoordSys.Origin&&0!=n.CoordSys.Origin.length){var i=parseFloat(n.CoordSys.Origin[0]),T=parseFloat(n.CoordSys.Origin[1]),a=parseFloat(n.CoordSys.Origin[2]),l=new o.Matrix3,s=new o.Vector3(n.CoordSys.RefDir[0],n.CoordSys.RefDir[1],n.CoordSys.RefDir[2]),d=new o.Vector3(n.CoordSys.Axis[0],n.CoordSys.Axis[1],n.CoordSys.Axis[2]),F=new o.Vector3;F.crossVectors(d,s),l.set(s.x,F.x,d.x,s.y,F.y,d.y,s.z,F.z,d.z);var R=new o.Matrix4;R.set(l.elements[0],l.elements[3],l.elements[6],i,l.elements[1],l.elements[4],l.elements[7],T,l.elements[2],l.elements[5],l.elements[8],a,0,0,0,1),I.multiply(R)}return void 0!==r&&r.setMatrix(I),r}}};return S});