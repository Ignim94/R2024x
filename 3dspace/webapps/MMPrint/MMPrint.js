define("DS/MMPrint/MMPrintCmd",["DS/Windows/Dialog","DS/Controls/Button","DS/ApplicationFrame/Command","i18n!DS/MMPrint/assets/nls/MMPrint","DS/Visualization/ThreeJS_DS","DS/WAFData/WAFData","DS/WebUtils/WebServices"],function(e,t,n,i,r,o,a){"use strict";function s(e,t,n,i){var r=null,s=null;n?s=n.tenant:e.experience&&(s=e.experience.args.input.asset.originalAsset.tenant),async function(e){return await a.getSecurityContext(e)}(s).then(e=>(console.log("MMPrint ctx="+e),e)).then(function(d){a.getServiceUrl({serviceName:"derivedformataccess",platformId:s,onSuccess:function(a){r||(r=a.url),function e(t,n,i,r,a,s){var d=r+"/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes",l=a,p={specificationFilter:[{format:"pdf",filterConversionParams:[{key:"streamId",value:"print"}]}],referencedObject:[{source:"3DSpace",type:"Drawing",relativePath:""}]};p.specificationFilter[0].notifyIfMissing=!0,i?p.referencedObject[0].id=i.physicalid:t.experience&&(p.referencedObject[0].id=t.experience.args.input.asset.originalAsset.physicalid),o.authenticatedRequest(d,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:l},type:"json",data:JSON.stringify(p),onComplete:function(d){if(d.derivedOutputs&&d.derivedOutputs[0]&&d.derivedOutputs[0].derivedOutputFormats&&d.derivedOutputs[0].derivedOutputFormats[0]&&d.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===d.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===d.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){s=0;var l=r+"/api/v2/modeler/dsdo/DerivedOutputs/"+d.derivedOutputs[0].id+"/DerivedOutputFiles/"+d.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";o.authenticatedRequest(l,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){var t=e.data[0].dataelements,n=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true";console.log("Loading from DFA : "+n),u(n)},onFailure:function(e){console.log("onFailure download ticket"),c(t,n)}})}else++s<4?(console.log("restart locate in 3000 ms"),setTimeout(e(t,n,i,r,a,s),3e3)):(console.log("derivedOutputs is NULL"),c(t,n))},onFailure:function(e){console.log("onFailure derivedOutputs"),c(t,n)}})}(e,t,n,r,d,i)},onError:function(n){console.error("OnFailure getServiceUrl()",n.error),c(e,t)}})},function(e){console.log("MMPrint- failed to read ctx="+e)})}var u=function(e){o.authenticatedRequest(e,{proxy:"passport",method:"GET",responseType:"arraybuffer",onComplete:function(e){!function(e){var t=function(e,t="",n=512){for(var i=atob(e),r=[],o=0;o<i.length;o+=n){for(var a=i.slice(o,o+n),s=new Array(a.length),u=0;u<a.length;u++)s[u]=a.charCodeAt(u);var d=new Uint8Array(s);r.push(d)}return new Blob(r,{type:t})}(e,"application/pdf"),n=URL.createObjectURL(t),i=window.open(n);i.focus(),i.print()}(function(e){for(var t="",n=new Uint8Array(e),i=n.byteLength,r=0;r<i;r++)t+=String.fromCharCode(n[r]);return window.btoa(t)}(e))},onFailure:function(e){e&&console.log(e)}})};function d(e){try{!1===e.contentWindow.document.execCommand("print",!1,null)&&e.contentWindow.print()}catch(t){e.contentWindow.print()}}function c(n,o){var a=n.experience,s=n.getImmersiveFrame(),u="udl";if(o&&o.svgStream&&(u="svg"),n&&a||o){var c=null;if(a&&null==o&&(c=a.args.input.asset),null!=c&&("svg"===c.type||"Drawing"===c.type||"V6Drawing"===c.type)||"svg"===u){var l=document.createElement("iframe");document.body.appendChild(l);var p=null,m=0,v=0;a&&null==o?(p=a.getSource(),m=a.getCurrentSheetIndex(),v=a.getNumberOfSheets()):(p=o.svgStream,m=o.currentSheetIndex,v=o.numberOfSheets);var g=p;if(1===v){var f=p.search("<svg");g=p.substring(f,g.length)}else g=function(e,t){var n=t.indexOf("<svg",t.search("<svg")+4),i=t.lastIndexOf("</svg>"),r=t.substring(n,i),o=r.split("<svg");return r="<svg"+o[e+1]}(m,p);l.contentDocument.write(g.replaceAll(/(\<script)[\s\S]*?(<\/script\>)/gim,"")),l.contentDocument.documentElement.getElementsByTagName("body")[0].style.margin="0",l.position="fixed",l.top="0",l.left="100%",l.width="100%",l.height="100%",d(l),document.body.removeChild(l),l=null}else if(null!=c&&"udl"===c.type||"udl"===u){var h={GenerateCanvasSheet:function(e,t,n,i){e.currentViewpoint.reframe();var o,a,s,u,d=window.devicePixelRatio||1;o=e.currentViewpoint,a=e.SCREEN_HEIGHT*d/(o.camera.top-o.camera.bottom),s=i/a,u=o.getTargetDistance()/s,o.setTargetDistance(u);var c,l,p=n.width,m=n.height,v=new r.Vector3(e.SCREEN_WIDTH*d/i,0,0),g=new r.Vector3(0,e.SCREEN_HEIGHT*d/i,0),f=((l=new r.Vector3(0,n.height,0)).add(new r.Vector3(e.SCREEN_WIDTH*d/(2*i),-e.SCREEN_HEIGHT*d/(2*i),0)),l),h=0,w=0,S=0,y=0,E=0;t.set({height:m*i,width:p*i});for(var C=t.getContext("2d"),D=C.getImageData(0,0,t.width,t.height);w<=m;){for(h=0,y=0,c=f.clone();h<=p;){e.currentViewpoint.setEyePosition(c);var O,b,T={data:null,width:Math.floor(e.SCREEN_WIDTH*d),height:Math.floor(e.SCREEN_HEIGHT*d)};e.renderToTarget(T,e.currentViewpoint);for(var F=S*D.width*T.height*4,x=0;x<T.height;x++){b=F+x*D.width*4+y*T.width*4,O=(T.height-x-1)*T.width*4;for(var _=0;_<4*T.width;_+=4)T.width*y+_/4<=D.width&&(D.data[b+_]=T.data[O+_],D.data[b+_+1]=T.data[O+_+1],D.data[b+_+2]=T.data[O+_+2],D.data[b+_+3]=T.data[O+_+3])}T.data=null,T=null,c.add(v),h+=v.x,E=++y>E?y:E}f.sub(g),w+=g.y,S++}C.putImageData(D,0,0)}};l=document.createElement("iframe");document.body.appendChild(l);var w=n.getViewer(),S=UWA.createElement("canvas"),y=0,E=0;a&&null==o?(y=a.getCurrentSheet().id,E=a._UDLLoader.getSheetSize(y)):E=o.currentSheetSize;w.setReferenceAxisSystem(!1),h.GenerateCanvasSheet(w,S,E,5.5),w.setReferenceAxisSystem(!0);var C=S.toDataURL("image/png"),D=UWA.createElement("img");D.src=C,l.contentDocument.write(D.outerHTML),l.contentDocument.documentElement.getElementsByTagName("body")[0].style.margin="0",l.position="fixed",l.top="0",l.left="100%",l.width="100%",l.height="100%",D.addEventListener("load",function(){d(l),document.body.removeChild(l),l=null,D=null},!0)}else{(b=document.createElement("div")).innerHTML="<p>"+i.printRealSizeError+"</p>",s.visibleFlag=!0;var O=new e({title:i.printErrorTitle,content:b,immersiveFrame:s,buttons:{Ok:new t({onClick:function(e){O.destroy(),s.visibleFlag=!1,s=null}})}})}}else{var b;(b=document.createElement("div")).innerHTML="<p>"+i.printRealSizeError+"</p>",s.visibleFlag=!0;O=new e({title:i.printErrorTitle,content:b,immersiveFrame:s,buttons:{Ok:new t({onClick:function(e){O.destroy(),s.visibleFlag=!1,s=null}})}})}}return n.extend({init:function(e){this._parent(e,{isAsynchronous:!1,mode:"exclusive"}),this._counter=0},beginExecute:function(){var e=this.getFrameWindow();s(e,e.drawingPrintInfo,e.assetInfo,this._counter)}})});