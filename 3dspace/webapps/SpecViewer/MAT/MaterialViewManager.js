define("DS/SpecViewer/MAT/MaterialViewManager",["UWA/Core","DS/Controls/Abstract","DS/PlatformAPI/PlatformAPI","DS/SpecGridView/SpecGridView","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XSRSearch","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/GridCommonActionsManager","DS/SpecViewer/MAT/service/MATServiceProvider","DS/SpecViewer/MAT/model/MATItemModel","DS/XSRCommonComponents/utils/ItemServiceProvider","text!DS/SpecViewer/assets/MATConfig/MATToolBarCommands.json","text!DS/SpecViewer/assets/MATConfig/MATColumnConfig.json","i18n!DS/SpecViewer/assets/nls/SpecViewer","css!DS/SpecViewer/MAT/Material.css"],function(e,t,i,r,s,n,a,o,c,d,l,u,m,h,p,g){"use strict";return t.extend({init:function(e){var t=e;this.itemId=Array.isArray(t.itemId)?t.itemId[0]:t.itemId,this.container=t.container,this.preferredView=t.preferredView,this.currentTabKey=t.currentTabKey,this.appCore=t.appCore,this.specModel=t.specModel,this.toolBarActions=JSON.parse(h),this._columns=JSON.parse(p),this.modelEvents=t.appCore.specViewerModelEvents,this.itemTitle=e.specModel.getTitle(),this.itemMaturity=e.specModel.getMaturity(),this.basicModelEvents=t.appCore.basicModelEvents,this.MATEventList=[],this._subscribeEvents();var i={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container,contextItem:this.itemId};this.service=new l(i)},syncNodeBasedOnID:function(e){var t=this;t.matGrid.getTreeDocument().getSelectedNodes().forEach(function(i){i.getID()===e&&t.engService.fetchItemInfo([e]).then(function(e){i.set(e),t.syncInstanceModels(i)}).catch(function(e){console.log(e)})})},syncInstanceModels:function(t){let i=this.matGrid.getGridNodes();i&&e.is(i,"array")&&i.forEach(function(e){e.getID()===t.getID()&&e.getInstanceId()!=t.getInstanceId()&&e.syncInstances(t)}),this.matGrid.getTreeDocument().acceptChanges()},evt_LanchPrevNextCommand:function(e){e.commandId;var t=e.move,i=e.itemId,r=(e.callBackAction,this.matGrid.getTreeDocument().getSelectedNodes());if(r&&!r||!(r.length<=0||r.length>1)?(r=Array.isArray(r)?r[0]:r)&&r.getID()!==i&&(r=(new GridUtil).getModelById(i,this.matGrid)):r=(new GridUtil).getModelById(i,this.matGrid),r&&r.getID()===i){var n=s.getValidPreviousorNextNode(r,t);n&&(this.matGrid.unselectAll(),this.gridViewInstance=this.matGrid.getGridViewInstance(),this.gridViewInstance&&this.gridViewInstance.ensureNodeModelVisible(n),n.select())}},_subscribeEvents:function(){var t=this;this.MATEventList.push(this.modelEvents.subscribe({event:n.EVENT_GRID_TOTAL_SELECTED_NODES},function(e){t.selectedGridCount=e.count,t.selectedGridNodes=e.currentModel})),this.MATEventList.push(this.modelEvents.subscribe({event:n.EVENT_LAUNCH_PREV_NEXT_COMMAND},e=>t.evt_LanchPrevNextCommand(e))),this.platFormSubscrpition=i.subscribe("DS/PADUtils/PADCommandProxy/refresh",function(i){i.data.authored&&i.data.authored.modified&&i.data.authored.modified.forEach(function(i){var r;e.is(i,"object")?r=i.physicalid:e.is(i,"string")&&(r=i),t.syncNodeBasedOnID(r),t.basicModelEvents.publish({event:n.EVENT_INFORMATION_PANEL_REFRESH})})}),this.MATEventList.push(this.modelEvents.subscribe({event:"grid-list-remove-node-successful-"+t.currentTabKey},function(e){t.matGrid.removeRootNodes(e),0===t.matGrid.getGridNodeCount()&&t.specModel.setMadeOf(!1),(new m).checkMaterialMismatch(t.itemId).then(e=>{t.modelEvents.publish({event:"item-view-manager-material-icon-update",data:e.result})})})),this.MATEventList.push(this.modelEvents.subscribe({event:"grid-toolbar-action-click-"+t.currentTabKey},function(e){var i=async function(e){const i=await o._getSearchCriteria(t.appCore.immersiveFrame,t.appCore.immersiveFrame.elements.container.querySelector("div.grid-mat-container div.enox-collection-toolbar-actions span.fonticon-plus"));if(t.matGrid.getTreeDocument().getOriginalGridRoots().length>0){if(t.matGrid.getTreeDocument().getOriginalGridRoots().filter(t=>s.isCoveringMaterial(e)?s.isCoveringMaterial(t.getTypeActualName())&&!t.getAttributeValue("isPartial"):e===t.getTypeActualName()).length>0)return void c.displayNotification({eventID:"error",msg:s.isCoreMaterial(e)?g.ERROR_Material_Exist:g.ERROR_COVERING_MATERIAL_EXIST})}if([n.MATURITY_RELEASED,n.MATURITY_OBSOLETE].includes(t.specModel.getMaturityActualName().toUpperCase()))return void c.displayNotification({eventID:"error",msg:g.ERROR_Material_ADD_Editable_State});if(t.specModel.options.changeActionId&&!s._isWorkUnderEnabled())return void c.displayNotification({eventID:"error",msg:g.ERROR_MAT_ERROR_APPLY+"\n"+g.ERROR_MAT_ENABLE_WORK_UNDER});var r={allowedTypes:[e],role:"",subType:"",multiSel:!1,criteria:i,precondition:'(latestrevision=="TRUE") AND NOT [current]:"OBSOLETE" AND NOT [policy]:"Version"',in_apps_callback:function(i){if(i&&i.length>0)if(i.length>1)c.displayNotification({eventID:"error",msg:g.ERROR_MAT_One_Selection});else{a.maskLoader(t.container,g.InsertingLoader);var r=i[0];delete r.owner,"dsc_matref_ref_Core"===e?t.service.connectCoreMaterial(r.resourceid,t.itemId).then(function(e){if(e.success&&e.result){let i=t.createMATNode(r);(new m).checkMaterialMismatch(t.itemId).then(e=>{t.modelEvents.publish({event:"item-view-manager-material-icon-update",data:e.result})}),t.addNodesToGrid(i,!0),t._updateGroup(),c.displayNotification({eventID:"success",msg:e.result.message})}else c.displayNotification({eventID:"error",msg:msg}),a.unmaskLoader(t.container)}).catch(function(e){var i=e&&e.message||g.LoadingError;c.displayNotification({eventID:"error",msg:i}),a.unmaskLoader(t.container)}):t.service.connectCoveringMaterial([r.resourceid],t.itemId).then(function(e){if(e.success&&e.result){let i=t.createMATNode(r);t.addNodesToGrid(i,!0),t._updateGroup(),c.displayNotification({eventID:"success",msg:e.result.message})}else c.displayNotification({eventID:"error",msg:msg}),a.unmaskLoader(t.container)}),t.checkAndApplyGrouping(),a.unmaskLoader(t.container)}},excludeList:[]};new o(r).launchSearch(r)};if(e)switch(e){case"addMaterial":i("dsc_matref_ref_Core");break;case"addCoverMaterial":i("dsc_matref_ref_Covering");break;case"removeMaterial":!function(e){var i=t.matGrid.getTreeDocument().getSelectedNodes();if(i&&i.length>0){let a=i.reduce((e,t)=>{let i=e[t.getTypeActualName()]||[];return i.push(t),e[t.getTypeActualName()]=i,e},{});if(1!==Object.keys(a).length)return void c.displayNotification({eventID:"error",msg:g.ERROR_SELECT_SINGLE_TYPE});if(s.isCoveringMaterial(Object.keys(a)[0])&&i.filter(e=>e.getAttributeValue("isPartial")).length>0)return void c.displayNotification({eventID:"error",msg:g.ERROR_PARTIAL_MATERIAL_DETACH});var r;"remove"===e&&(r=n.REMOVE_CHILD_CMD),t.basicModelEvents.publish({event:n.EVENT_LAUNCH_COMMAND,data:{commandId:r,context:{item:{data:i,isChangeConnected:!1}}}})}else c.displayNotification({eventID:"error",msg:g.ERROR_No_Material_Selected})}("remove");break;case"Export":t._exportGrid();break;case"personalize":t._personalize()}})),this.MATEventList.push(this.modelEvents.subscribe({event:n.GRID_CONTEXT_MENU+"-spec_mat"},function(e){var i=t.matGrid.getTreeDocument().getSelectedNodes();e.gridInstance=t.matGrid;var r=[];if(i&&i.length>1)(0,d.getMultiActionMenu)(e,r);else if(i&&(0===i.length||1===i.length)){(0,d.getActionMenu)(e,r)}})),this.MATEventList.push(this.modelEvents.subscribe({event:"grid-toolbar-switch-view-"+t.currentTabKey},function(e){var i="grid-preferred-view-"+t.currentTabKey;widget.setValue(i,e),t.matGrid.switchView(e)})),this.MATEventList.push(this.modelEvents.subscribe({event:"grid-item-toolbar-mutiactions-list-"+t.currentTabKey},function(e){e&&(e.nodeModel=t.matGrid.getTreeDocument()),e.gridInstance=t.matGrid,(0,d.getToolbarActionMenu)(e)}))},render:function(){this._MATContainer=e.createElement("div",{class:"grid-mat-container"}).inject(this.container),this.initializeSingleGrid()},initializeSingleGrid:function(){var e={itemId:this.itemId,container:this._MATContainer,appCore:this.appCore,preferredView:this.preferredView,currentTabKey:this.currentTabKey,enableCrossWidgetFeature:!1,parentModel:this.specModel,enableInteractiveRightPanel:!0,rowGroupingOptions:{hideGroupedColumns:!0,depth:0,getGroupingNodeLabel:function(e){return e.getIdentifier()}}};this.matGrid=new r(e),this.loadMATs(this.itemId);var t=this.toolBarActions.actions,i=this._columns.columns,s=this.getNLSLabels(t),n=this.getNLSLabels(i);this.matGrid.setColumns(n),this.matGrid.render(),this.matGrid.setToolBarActions({actions:s}),this.setCustomTooltipOnTile(),this.validateMakeFromRelated()},validateMakeFromRelated:function(){let e=this,t=(e.specModel.hasMBMFConnection(),e.specModel.hasBOMAdded()||e.specModel.hasBOMConnection()),i=e.specModel.has3DPart();(t||i)&&e.modelEvents.publish({event:"xsr-hide-toolbar-add-corematerial-command-"+this.currentTabKey,data:{disableAddCoreMatCmd:!0}}),(new m).checkMaterialMismatch(this.itemId).then(t=>{if(t.success&&t.result){let i=t.result;if(i&&"true"===i.hasMaterialMismatch){let t=g.replace(g.get("MAT_GENERAL_WARNING"),{parentTitle:e.specModel.getTitle()});c.displayNotification({eventID:"info",msg:t})}}})},checkAndApplyGrouping:function(){let e=this,t=e.matGrid.getGroupByColumns();t?e.matGrid.checkAndUpdatePersistency(t):e.matGrid.setGroupByColumns(void 0)},loadMATs:function(e){var t=this;let i=[];i.push(t.service.listMaterials(e)),i.push(t.service.listCoveringMaterial(e)),Promise.allSettled(i).then(function(e){e.forEach((e,i)=>{if(0===i){if("rejected"==e.status)return c.displayNotification({eventID:"error",msg:g.Error_Material_load}),void a.unmaskLoader(t.container);if(e.value.success&&e.value.result){let i=e.value.result;i&&0!==i.length&&i.forEach(e=>{let i=t.createMATNode(e);t.addNodesToGrid(i,!1)})}else c.displayNotification({eventID:"error",msg:g.Error_Material_load}),a.unmaskLoader(t.container)}else if(1===i)if(e.value.success&&e.value.result){let i=e.value.result;i&&0!==i.length&&i.forEach(e=>{let i=t.createMATNode(e);t.addNodesToGrid(i,!1)})}else c.displayNotification({eventID:"error",msg:g.Error_Material_load}),a.unmaskLoader(t.container)}),t._updateGroup()}).catch(function(e){console.log(e)})},_updateGroup:function(){this.matGrid.getTreeDocument().getOriginalGridRoots().length>0&&(this.matGrid.unGroupRoots(),void 0===widget.getValue("xsr-noDefault-RelType")?this.matGrid.groupRoots("ds6w:type"):this.matGrid.updateGroupByIfAny())},createMATNode:function(e){e.parentItemModel=this.itemId;var t=new u({appCore:this.appCore,parentModel:this.specModel}).set(e);return t.currentTabKey=this.currentTabKey,t.appCore=this.appCore,t},addNodesToGrid:function(e,t){this.matGrid.addRootNodes(e,t),this.specModel.hasMadeOf&&!this.specModel.hasMadeOf()&&this.specModel.setMadeOf(!0),this.matGrid.getTreeDocument().acceptChanges(),this.matGrid.updateItemsOnTagger(e)},getNLSLabels:function(e){var t=e;if(t){var i=function(e){for(var t=0;t<e.length;t++)e[t].text=e[t].text&&g[e[t].text]?g[e[t].text]:e[t].text,e[t].subMenu&&i(e[t].subMenu)};i(t)}return t},setCustomTooltipOnTile:function(){this.matGrid.tileManager.grid.getCustomTooltip=function(e){return e._canBeGrouped()?g.label_Title+": "+e.getLabel()+"\n"+g.label_Type+": "+e.getType()+"\n"+g.label_Revision+": "+e.getRevision()+"\n":e.getLabel()}},onError:function(e){this.enableOrDisableDialogButtons(this.validateFields()),this.stopLoader(),this.dialog.maskOrUnMaskDialog(),a.unmaskLoader(this.container),c.displayNotification({eventID:"error",msg:e&&e.message||g.PhysicalPrdCreateFailure})},_exportGrid:function(){var e=this.itemTitle+"_"+this.itemMaturity+"_"+g.tab_MAT;this.matGrid.exportGrid(e)},_personalize:function(){this.matGrid.personalize()},destroy:function(){this._MATContainer.destroy(),this.matGrid.destroy(),this.platFormSubscrpition&&i.unsubscribe(this.platFormSubscrpition),this.MATEventList&&this.modelEvents.unsubscribeList(this.MATEventList)}})});