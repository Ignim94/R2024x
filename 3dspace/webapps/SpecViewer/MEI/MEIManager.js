define("DS/SpecViewer/MEI/MEIManager",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/PlatformAPI/PlatformAPI","DS/SpecGridView/SpecGridView","DS/XSRCommonComponents/utils/Utils","DS/SpecGridView/utils/GridUtil","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XSRSearch","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/utils/PlatformDataProvider","DS/XSRCommonComponents/utils/GridCommonActionsManager","DS/SpecViewer/MEI/controller/CreateMEI","DS/SpecViewer/MEI/service/MEIServiceProvider","DS/SpecViewer/MEI/model/MEIItemModel","DS/SpecViewer/BOM/service/EngineeringServiceWrapper","text!DS/SpecViewer/assets/MEIConfig/MEIToolBarCommands.json","text!DS/SpecViewer/assets/MEIConfig/MEIColumnConfig.json","i18n!DS/SpecViewer/assets/nls/SpecViewer","css!DS/SpecViewer/MEI/MEI.css"],function(e,t,i,r,n,s,a,o,c,d,l,u,m,p,h,g,v,f,E,I,M){"use strict";return i.extend({init:function(e){var t=e;this.itemId=Array.isArray(t.itemId)?t.itemId[0]:t.itemId,this.container=t.container,this.preferredView=t.preferredView,this.currentTabKey=t.currentTabKey,this.appCore=t.appCore,this.specModel=t.specModel,this.toolBarActions=JSON.parse(E),this._columns=JSON.parse(I),this.modelEvents=t.appCore.specViewerModelEvents,this.itemTitle=e.specModel.getTitle(),this.itemMaturity=e.specModel.getMaturity(),this.basicModelEvents=t.appCore.basicModelEvents,this.MEIEventList=[],this._subscribeEvents();var i={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container,contextItem:this.itemId};if(this.service=new g(i),u.isCloud()){var r=u.getPlatformId();m.getServiceURL("sourcing",r)||l.displayNotification({eventID:"error",msg:M.Message_SourcingDeployKO}),u.getSourcingCSRFToken()||u.setMEICSRFToken()}var n={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container,parentNodeModel:this.specModel};this.engService=new f(n)},syncNodeBasedOnID:function(e){var t=this;t.meiGrid.getTreeDocument().getSelectedNodes().forEach(function(i){i.getID()===e&&t.engService.fetchItemInfo([e]).then(function(e){i.set(e),t.syncInstanceModels(i)}).catch(function(e){console.log(e)})})},syncInstanceModels:function(t){let i=this.meiGrid.getGridNodes();i&&e.is(i,"array")&&i.forEach(function(e){e.getID()===t.getID()&&e.syncInstances(t)}),this.meiGrid.getTreeDocument().acceptChanges()},_subscribeEvents:function(){var i=this;this.MEIEventList.push(this.modelEvents.subscribe({event:o.EVENT_GRID_TOTAL_SELECTED_NODES},function(e){i.selectedGridCount=e.count,i.selectedGridNodes=e.currentModel})),this.platFormSubscrpition=r.subscribe("DS/PADUtils/PADCommandProxy/refresh",function(t){t.data.authored&&t.data.authored.modified&&t.data.authored.modified.forEach(function(t){var r;e.is(t,"object")?r=t.physicalid:e.is(t,"string")&&(r=t),i.syncNodeBasedOnID(r),i.basicModelEvents.publish({event:o.EVENT_INFORMATION_PANEL_REFRESH})})}),this.MEIEventList.push(this.modelEvents.subscribe({event:o.EVENT_LAUNCH_PREV_NEXT_COMMAND},function(e){var t=e.move,r=e.itemId,n=(e.callBackAction,i.meiGrid.getTreeDocument().getSelectedNodes());if(n&&!n||!(n.length<=0||n.length>1)?(n=Array.isArray(n)?n[0]:n)&&n.getID()!==r&&(n=(new a).getModelById(r,i.meiGrid)):n=(new a).getModelById(r,i.meiGrid),n&&n.getID()===r){var o=s.getValidPreviousorNextNode(n,t);o&&(i.meiGrid.unselectAll(),i.gridViewInstance=i.meiGrid.getGridViewInstance(),i.gridViewInstance&&i.gridViewInstance.ensureNodeModelVisible(o),o.select())}})),this.MEIEventList.push(this.modelEvents.subscribe({event:o.GRID_CONTEXT_MENU+"-"+i.currentTabKey},function(e){var t=e,r=i.meiGrid.getTreeDocument().getSelectedNodes();if(t.gridInstance=i.meiGrid,r&&r.length>1)(0,p.getMultiActionMenu)(t);else if(r&&(0===r.length||1===r.length)){(0,p.getActionMenu)(t)}})),this.MEIEventList.push(this.modelEvents.subscribe({event:"grid-item-toolbar-mutiactions-list-"+i.currentTabKey},function(e){e&&(e.nodeModel=i.meiGrid.getTreeDocument()),e.gridInstance=i.meiGrid,(0,p.getToolbarActionMenu)(e)})),this.MEIEventList.push(this.modelEvents.subscribe({event:"grid-list-remove-node-successful-"+i.currentTabKey},function(e){i.meiGrid.removeRootNodes(e),i.meiGrid.removeItemsOnTagger(e)})),this.MEIEventList.push(this.modelEvents.subscribe({event:"grid-toolbar-switch-view-"+i.currentTabKey},function(e){var t="grid-preferred-view-"+i.currentTabKey;widget.setValue(t,e),i.meiGrid.switchView(e)})),this.MEIEventList.push(this.modelEvents.subscribe({event:"grid-cell-value-update-"+i.currentTabKey},function(e){var t=e.newValue;if(i.currentTabKey===o.MEI_TAB||void 0!==e.nodeModel.getMEIInterface&&e.nodeModel.getMEIInterface()===o.MEI_INTERFACE){var r={};switch(r.partSource=e.nodeModel.getPartSource(),r.partSourceURL=e.nodeModel.getPartSourceURL(),r.manufacturerPartNumber=e.nodeModel.getMftPartNo(),r.title=e.nodeModel.getTitle(),r.description=e.nodeModel.getDescription(),r.cestamp=e.nodeModel.getCEstamp(),e.dataIndex){case"manufacturerPartNo":r.manufacturerPartNumber=t;break;case"partSource":r.partSource=t;break;case"partSourceURL":r.partSourceURL=t;break;case"tree":r.title=t;break;default:c.unmaskLoader(i.container)}}var n=e.nodeModel.getID();c.maskLoader(i.container,M.UpdatingLoader);var s=function(e,t){"success"===e?i.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+i.currentTabKey}):i.modelEvents.publish({event:"xsr-show-toolbar-reset-command-"+i.currentTabKey}),l.displayNotification({eventID:e,msg:t}),c.unmaskLoader(i.container)};!function(t){var r=function(e){s("error",e),i.modelEvents.publish({event:"xsr-show-toolbar-reset-command-"+i.currentTabKey}),c.unmaskLoader(i.container)};null==t.title||""===t.title?r(M.Error_EmptyTitle):null==t.manufacturerPartNumber||""===t.manufacturerPartNumber?r(M.Error_EmptyMftPartNo):(i.meiGrid.unselectAll(),e.nodeModel.select(),i.service.updateInstance(n,t).then(function(t){"TRUE"===t.member[0].modifyAccess?(e.nodeModel.set(t.member[0]),i.meiGrid.getTreeDocument().acceptChanges(),i.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+i.currentTabKey}),s("success",M.Notify_Updated)):s("error",M.Message_Error_Update)}).catch(function(e){s("error",M.Failure_Update)}))}(r)})),this.MEIEventList.push(this.modelEvents.subscribe({event:"grid-toolbar-action-click-"+i.currentTabKey},function(e){var r,n=function(e){var t=i.meiGrid.getTreeDocument().getSelectedNodes();if(t&&t.length>0){var r;"remove"===e?r=o.REMOVE_CHILD_CMD:"delete"===e&&(r=o.DELETE_ITEM_CMD),i.basicModelEvents.publish({event:o.EVENT_LAUNCH_COMMAND,data:{commandId:r,context:{item:{data:t}}}})}else{var n="";"delete"===e?n=M.actionErrMsgDelete:"remove"===e&&(n=M.actionErrMsgRemove),l.displayNotification({eventID:"error",msg:M.NoItemSelected+n})}};if(e)switch(e){case"createMftEqItem":(r={}).appCore=i.appCore,r.parentId=i.itemId,r.createCloseAction=r.createAction=function(e){var t=i.createMEINode(i.itemId,e);i.addNodesToGrid(t,!0),i.checkAndApplyGrouping(),i.meiGrid.addTagger(),t.acceptChanges(),t.sync()},new h(r).loadFields();break;case"addMftEqItem":!async function(){const e=await d._getSearchCriteria(i.appCore.immersiveFrame,i.appCore.immersiveFrame.elements.container.querySelector("div.grid-mei-container div.enox-collection-toolbar-actions span.fonticon-plus"));var r=function(e){var r={};if(e&&e.length>0){for(var n=c.maskLoader(i.container,M.InsertingLoader),s=[],o=e.length>0?100/e.length:0,d=0;d<e.length;d++){n.update(o.toString()),e.length;var m=e[d];m.id===i.itemId&&(r[m.id]=M.Insert_cyclic_failure),(new a).getModelById(m.id,i.meiGrid);var p={};if(p.title=m["ds6w:label"],p.state=m["ds6w:status_value"],p.source=m.sourceid_value,u.isCloud()){var h=[];h.push(i.service.getProxyObject(p,"SRC Manufacturer Equivalent Item Proxy Item",m.id)),h.push(i.service.getProxyObject(p,"SRC Engineering Item Proxy Item",i.itemId)),t.all(h).then(function(t){if(t&&t.length>0){var r=Object.values(t[0])[0],n=Object.values(t[1])[0];i.service.associateMEIWithEQ(null,p,r,n).then(function(t){i.addExistingPostAction(t,e.length,s)}).catch(function(e){l.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})}}).catch(function(e){l.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})}else i.service.associateMEIWithEQ(null,p,m.id,i.itemId).then(function(t){i.addExistingPostAction(t,e.length,s)}).catch(function(e){var t=e&&e.message||M.LoadingError;l.displayNotification({eventID:"error",msg:t}),c.unmaskLoader(i.container)})}i.checkAndApplyGrouping(),c.unmaskLoader(i.container)}};i.service.listMEIs(i.itemId).then(function(t){var i=[],n=t.data;if(null!=t&&n&&n.length>0)for(var s=0;s<n.length;s++)n[s].relateddata.target.length>0&&i.push(n[s].relateddata.target[0].dataelements.Proxy_Id);var a={allowedTypes:["VPMReference"],role:"",subType:"",criteria:e,precondition:'([ds6w:kind]:"ManufacturerEquivalentItemExtension") AND (latestrevision=="TRUE") AND NOT [current]:"OBSOLETE" AND NOT [policy]:"Version"',in_apps_callback:r,excludeList:i};new d(a).launchSearch(a)}).catch(function(e){var t=e&&e.message||M.LoadingError;l.displayNotification({eventID:"error",msg:t}),c.unmaskLoader(i.container)})}();break;case"removeitem":n("remove");break;case"deleteItem":n("delete");break;case"Export":i._exportGrid();break;case"personalize":i._personalize()}}))},render:function(){this._MEIContainer=e.createElement("div",{class:"grid-mei-container"}).inject(this.container),this.initializeSingleGrid()},initializeSingleGrid:function(){var e={itemId:this.itemId,container:this._MEIContainer,appCore:this.appCore,preferredView:this.preferredView,currentTabKey:this.currentTabKey,enableCrossWidgetFeature:!1,parentModel:this.specModel,enableInteractiveRightPanel:!0};this.meiGrid=new n(e),this.loadMEIs(this.itemId);var t=this.toolBarActions.actions,i=this._columns.columns,r=this.getNLSLabels(t),s=this.getNLSLabels(i);this.meiGrid.setColumns(s),this.meiGrid.render(),this.meiGrid.setToolBarActions({actions:r}),this.setCustomTooltipOnTile()},getNLSLabels:function(e){var t=e;if(t){var i=function(e){for(var t=0;t<e.length;t++)e[t].text=e[t].text&&M[e[t].text]?M[e[t].text]:e[t].text,e[t].subMenu&&i(e[t].subMenu)};i(t)}return t},setCustomTooltipOnTile:function(){this.meiGrid.tileManager&&(this.meiGrid.tileManager.grid.getCustomTooltip=function(e){return e._canBeGrouped()?M.label_Title+": "+e.getLabel()+"\n"+M.label_Type+": "+e.getTypeDisplayName()+"\n"+M.label_Revision+": "+e.getRevision()+"\n"+M.label_LastModified+": "+e.getModifedDate():e.getLabel()})},checkAndApplyGrouping:function(){let e=this,t=e.meiGrid.getGroupByColumns();t?e.meiGrid.checkAndUpdatePersistency(t):e.meiGrid.setGroupByColumns(void 0)},loadMEIs:function(e){var t=this;return t.service.listMEIs(e).then(function(i){var r=i.data;if(null!=i&&r&&r.length>0){for(var n=[],s=new Map,a=0;a<r.length;a++){var o={};r[a].relateddata.target.length>0&&(o.id=r[a].relateddata.target[0].dataelements.Proxy_Id,o.eqQualId=r[a].id,o.eqQualType=r[a].type,o.eqQualIsPreferred=r[a].dataelements["SRC Preferred"],n.push(o.id),s.set(o.id,o))}t.service.getMEIDetails(n,s).then(function(i){if(i&&i.member){for(var r=0;r<i.member.length;r++){var n=i.member[r],a=!1;for(var[o,c]of s)if(n.id==o&&!a){var d=Object.assign(n,c),l=t.createMEINode(e,d);t.addNodesToGrid(l,!1),t.meiGrid.addTagger(),l.acceptChanges(),a=!0}}t.checkAndApplyGrouping()}}).catch(function(e){console.log(e)})}else null!=i&&r&&0===r.length?t.meiGrid.displayEmptyObjectView():l.displayNotification({eventID:"error",msg:M.Failure_LoadingMEIs})}).catch(function(e){if(null!==e||u.isCloud()){var i=e&&e.message||M.LoadingError;l.displayNotification({eventID:"error",msg:i})}else l.displayNotification({eventID:"info",msg:M.Info_InstallSIP});c.unmaskLoader(t.container)})},addExistingPostAction:function(e,t,i){var r=this,n=[];if(e.success&&e.data[0]){i.push(e.statusCode);var s={};if(s.eqQualIsPreferred=e.data[0].dataelements["SRC Preferred"],s.eqQualId=e.data[0].dataelements.physicalid,s.eqQualType=e.data[0].dataelements.type,e.data[0].relateddata&&e.data[0].relateddata.target[0]){var a=e.data[0].relateddata.target[0].dataelements.Proxy_Id;n.push(a),r.service.getMEIDetails(n,null).then(function(e){if(e&&e.member){var n=Object.assign(e.member[0],s),a=new v(r.appCore).set(n);r.addNodesToGrid(a,!0),a.sync();var o=M.replace(M.get("MEIAddExistingSuccess"),{meiTitle:e.member[0].title,itemTitle:r.itemTitle});if(i.length===t&&t>1){var c=M.MEI_Insert_Success;l.displayNotification({eventID:"success",msg:c})}else i.length===t&&1===t&&l.displayNotification({eventID:"success",msg:o})}}).catch(function(e){console.log(e)})}}else l.displayNotification({eventID:"error",msg:M.Failure_mass_insert_mei}),c.unmaskLoader(r.container)},createMEINode:function(e,t){var i=new v(this.appCore).set(t);return i.currentTabKey=this.currentTabKey,i.appCore=this.appCore,i.onContainer=this.container,i.parentNodeModel=this.specModel,i},onError:function(e){this.enableOrDisableDialogButtons(this.validateFields()),this.stopLoader(),this.dialog.maskOrUnMaskDialog(),c.unmaskLoader(this.container),l.displayNotification({eventID:"error",msg:e&&e.message||M.PhysicalPrdCreateFailure})},addNodesToGrid:function(e,t){this.meiGrid.addRootNodes(e,t),this.meiGrid.updateItemsOnTagger(e)},_exportGrid:function(){var e=this.itemTitle+"_"+this.itemMaturity+"_"+M.label_MftEqItem;this.meiGrid.exportGrid(e)},_personalize:function(){this.meiGrid.personalize()},destroy:function(){this._MEIContainer.destroy(),this.meiGrid.destroy(),this.platFormSubscrpition&&r.unsubscribe(this.platFormSubscrpition),this.MEIEventList&&this.modelEvents.unsubscribeList(this.MEIEventList)}})});