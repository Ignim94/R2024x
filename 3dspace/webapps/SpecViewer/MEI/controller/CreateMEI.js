define("DS/SpecViewer/MEI/controller/CreateMEI",["UWA/Core","UWA/Controls/Abstract","DS/Controls/TooltipModel","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/createform/view/NewForm","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XSRSearch","DS/SpecViewer/MEI/service/MEIServiceProvider","DS/SpecViewer/MEI/controller/SearchSuppliersForMEI","DS/XSRCommonComponents/utils/Constants","DS/SpecViewer/MEI/model/MEIItemModel","DS/XSRCommonComponents/utils/RequestUtil","text!DS/SpecViewer/assets/MEIConfig/CreateMEIFields.json","i18n!DS/SpecViewer/assets/nls/SpecViewer"],function(e,t,i,r,a,o,n,s,l,d,c,u,m,f,p,h,I){"use strict";return t.extend({newForm:null,templateList:null,formFields:null,target:null,options:null,dialog:null,init:function(e){this._parent(e),this.options=e,this.basicModelEvents=e.appCore.basicModelEvents,this.target=e.appCore.specMainContainer,this.createCloseAction=e.createCloseAction,this.createAction=e.createAction,this.tenantID=p.getPlatformId();var t={appCore:e.appCore,modelContainer:this.target,contextItem:e.parentId};this.meiServiceProvider=new c(t)},loadFields:function(){this.container=widget.body,l.maskLoader(this.container);var e=JSON.parse(h),t=m.MEI_FORM;this.initDetailedView(e,t)},initDetailedView:function(e,t){var i=e;i.formName=t,this.newForm=new o(i).render(),this.formFields=this.newForm.formfieldControls;var n=this,c=this.options;c.Title=I.NewMftEqItem,c.Content=this.newForm.container,c.width=500,c.renderTo=this.target,l.unmaskLoader(this.container),this.dialog=new a(c),this.dialog.destroyPrevDialog(),this.dialog.render(),this.newForm.listenTo(this.newForm,"CONTAINS_DIRTY_FIELD",function(e){n.formFields.manufacturer.inputfield[0].value&&n.formFields.partNumber.inputfield.value&&n.formFields.title.inputfield.value?(n.dialog._dialog.buttons.Ok.disabled=!1,n.dialog._dialog.buttons.Apply.disabled=!1):(n.dialog._dialog.buttons.Ok.disabled=!0,n.dialog._dialog.buttons.Apply.disabled=!0)}),this.newForm.listenTo(this.newForm,"EVENT_MFT_BTN_CLICK",function(e){if(p.isCloud()){var t={};t.basicModelEvents=n.basicModelEvents,t.target=n.target,t.manufacturerField=n.formFields.manufacturer,t.createCloseAction=function(e){n.formFields.manufacturer.inputfield[0].value=e,n.formFields.manufacturer.inputfield[0].dbMftName=e},new u(t).initSearchSuppliersView()}else{!function(){var e={allowedTypes:["Company"],role:"",subType:"",criteria:"Company",precondition:"",multiSel:!1,in_apps_callback:function(e){n.formFields.manufacturer.inputfield[0].value=e[0]["ds6w:label"],n.formFields.manufacturer.inputfield[0].dbMftName=e[0]["ds6w:identifier"],n.newForm.checkDirtyFields.call(n),n.formFields.manufacturer.inputfield[0].displayClearFieldButtonFlag=!0},excludeList:[]};new d(e).launchSearch(e)}()}}),this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_OK",function(){var e={};n.validateFields()&&(n.enableOrDisableDialogButtons(!1),n.dialog.closeDialog(),n.showCreateLoader(),e.formValues=n.getCreateMEIRequestInput(),e.parentId=n.options.parentId,m(e).then(n.createMEICallBack.bind(n),n.onError.bind(n)))}),this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_APPLY",function(){var e={},t=n.validateFields();t&&(n.enableOrDisableDialogButtons(t),n.showCreateLoader(),e.formValues=n.getCreateMEIRequestInput(),e.parentId=n.options.parentId,m(e).then(n.createMEIApplyCallBack.bind(n)).catch(n.onError.bind(n)))});var m=function(e){return new Promise(function(t,i){n.meiServiceProvider.createMEI(e).then(function(i){var a={};i&&(a.id=i.member[0].id,a.title=i.member[0].title,a.state=i.member[0].state,a.manufacturer=i.member[0].manufacturer,a.manufacturerPartNumber=i.member[0].manufacturerPartNumber,a.partSource=i.member[0].partSource,a.partSourceURL=i.member[0].partSourceURL,a.name=i.member[0].name,a.description=i.member[0].description,a.created=a.created_generic=r.getDataGridformatedDate(i.member[0].created_generic),a.modified=a.modified_generic=r.getDataGridformatedDate(i.member[0].modified_generic),a.owner=i.member[0].owner),a.parentID=e.parentId;var o=a.id;if(p.isCloud()){var l=[];l.push(n.meiServiceProvider.getProxyObject(a,"SRC Manufacturer Equivalent Item Proxy Item",o)),l.push(n.meiServiceProvider.getProxyObject(a,"SRC Engineering Item Proxy Item",e.parentId)),Promise.all(l).then(function(i){if(i&&i.length>0){var r=Object.values(i[0])[0],o=Object.values(i[1])[0];n.meiServiceProvider.createGQForMEICreate(e,r).then(function(i){if(i.success&&i.data){var l={};l.GQId=i.data[0].id,l.GQType=i.data[0].type;var d=Object.assign(l,a);n.meiServiceProvider.associateMEIWithEQ(e,a,r,o).then(function(e){e.success&&e.data&&(d.eqQualId=e.data[0].dataelements.physicalid,d.eqQualIsPreferred=e.data[0].dataelements["SRC Preferred"],d.eqQualType=e.data[0].dataelements.type,t(d))}).catch(function(e){s.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})}}).catch(function(e){s.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})}}).catch(function(e){s.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})}else n.meiServiceProvider.createGQForMEICreate(e,o).then(function(i){if(i.success&&i.data){var r={};r.GQId=i.data[0].id,r.GQType=i.data[0].type;var l=Object.assign(r,a);n.meiServiceProvider.associateMEIWithEQ(e,a,o,e.parentId).then(function(e){e.success&&e.data&&(l.eqQualId=e.data[0].dataelements.physicalid,l.eqQualIsPreferred=e.data[0].dataelements["SRC Preferred"],l.eqQualType=e.data[0].dataelements.type,t(l))}).catch(function(e){s.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})}}).catch(function(e){s.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})}).catch(function(e){l.unmaskLoader(n.container),s.displayNotification({eventID:"error",msg:e.error?e.error:e.message})})})}},createMEIApplyCallBack:function(e){if(null==e)return l.unmaskLoader(this.container),s.clearNotifications(),void s.displayNotification({eventID:"error",msg:I.MEICreateFailure});void 0!==e&&(this.options.createAction(e),s.displayNotification({eventID:"success",msg:I.MEICreateSuccess}),this.enableOrDisableDialogButtons(!1),this.resetFields()),this.stopLoader()},showCreateLoader:function(){var e=this.getInput("title"),t=I.replace(I.get("CreateLoader"),{title:e});l.maskLoader(this.container,t)},stopLoader:function(){l.unmaskLoader(this.container)},createMEICallBack:function(e){if(null==e)return l.unmaskLoader(this.container),s.clearNotifications(),void s.displayNotification({eventID:"error",msg:I.MEICreateFailure});void 0!==e&&(this.options.createCloseAction(e),this.showCreateLoader(),s.clearNotifications(),s.displayNotification({eventID:"success",msg:I.MEICreateSuccess})),this.stopLoader()},enableOrDisableDialogButtons:function(e){this.dialog&&(e?this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!1}):this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!0}))},onError:function(e){s.displayNotification({eventID:"error",msg:(e.error?e.error:e.message)||I.MEICreateFailure}),this.enableOrDisableDialogButtons(this.validateFields()),this.stopLoader(),l.unmaskLoader(this.container),this.dialog&&this.dialog.maskOrUnMaskDialog()},resetToolTip:function(){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:"",allowUnsafeHTMLShortHelp:!1})},setToolTip:function(e){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:e.description,allowUnsafeHTMLShortHelp:!1})},resetFields:function(){this.newForm.formName===m.MEI_FORM&&this.newForm.formfieldControls.manufacturer&&(this.newForm.formfieldControls.manufacturer.inputfield[0].displayClearFieldButtonFlag=!1),this.newForm.resetFields()},getCreateMEIRequestInput:function(){var e={};for(var t in this.formFields){var i=this.formFields[t];"manufacturer"===t?p.isCloud()?e[t]=i.inputfield[0].uid:e[t]=i.inputfield[0].dbMftName:e[t]=this.hasValue(i.inputfield.value)?i.inputfield.value.trim():""}return this.createMEIInput=e,e},validateFields:function(){var t,i,r=!0,a=!1;for(t in this.formFields){var o=this.formFields[t],n=!!e.is(o.parentfield)&&o.parentfield.isHidden(),l=!!e.is(o.inputfield.fieldoptions)&&o.inputfield.fieldoptions.mandatory,d=e.is(o.inputfield.fieldoptions)?o.inputfield.fieldoptions.label:"";if(!n&&l)if(!this.hasValue(o.inputfield.value))o.inputfield._giveFocus(),a=!0,i=void 0!==i?i+","+d:d,r=!1}return a&&s.displayNotification({eventID:"error",msg:I.RequiredFields+i}),r},hasValue:function(e){return null!=e&&""!==e},getInput:function(e){if(this.formFields[e])return this.formFields[e].inputfield.value}})});