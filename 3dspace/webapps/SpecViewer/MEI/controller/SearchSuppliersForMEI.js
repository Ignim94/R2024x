define("DS/SpecViewer/MEI/controller/SearchSuppliersForMEI",["UWA/Core","UWA/Controls/Abstract","DS/Controls/LineEditor","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/SpecViewer/MEI/model/SupplierItemModel","DS/SpecViewer/MEI/service/MEIServiceProvider","DS/SpecViewer/MEI/view/MEISupplierTileView","DS/XSRCommonComponents/utils/PlatformDataProvider","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/createform/view/NewForm","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/Constants","text!DS/SpecViewer/assets/MEIConfig/MEISearchSuppliers.json","i18n!DS/SpecViewer/assets/nls/SpecViewer","css!DS/SpecViewer/MEI/view/MEISupplierDialog.css"],function(e,i,t,r,s,n,a,l,o,p,u,d,c,h,m,S,g,f){"use strict";return i.extend({suppliersForm:null,suppliersFormFields:null,target:null,options:null,dialog:null,init:function(i){this._parent(i),this.options=i,this.basicModelEvents=i.basicModelEvents,this.target=i.target,this.createCloseAction=i.createCloseAction,this.meiServiceProvider=new a,this.manufacturerField=i.manufacturerField,this.supplierContainer=new e.Element("div",{class:"xsr-MEI-Supplier-Container"})},loadIndustryValues:function(){var e=this;e.meiServiceProvider.getSuppliersIndustry({data:[{type:"companyclassificationlibrary"},{type:"levels",attributes:{language:"en"}},{type:"preferencestatus",attributes:{language:"en"}},{type:"categorylibrary"}]}).then(function(i){if(i&&i.data)for(var t=i.data,n=new r,a=0;a<t.length;a++)"companyclassificationlibrary"===t[a].type&&e.meiServiceProvider.getCompanyClassificationData({companyclassificationlibrary:t[a].id}).then(function(i){i&&i.results&&i.results.length>0&&(i.results.forEach(e=>{let i=e.attributes.filter(e=>"resourceid"===e.name)[0].value,t=e.attributes.filter(e=>"ds6w:label"===e.name)[0].value;n.addRoot(new s({label:t,value:i}))}),e.suppliersFormFields.industry.inputfield.elementsTree=n)})}).catch(function(i){m.unmaskLoader(e.container),h.displayNotification({eventID:"error",msg:i.errors?i.errors[0].details:f.Error_Industry_Fetch})})},initSearchSuppliersView:function(){this.container=widget.body,m.maskLoader(this.target),this.searchCriteriaContainer=new e.Element("div",{class:"xsr-MEI-SearchCriteria-Container"}),this.searchCriteriaContainer.inject(this.supplierContainer);var i=JSON.parse(g);i.formName=S.MEI_SUPPLIERS_FORM,this.suppliersForm=new c(i).render(),this.suppliersFormFields=this.suppliersForm.formfieldControls,this.suppliersForm.container.inject(this.searchCriteriaContainer);var t=this,s=this.options;s.Title=f.SearchSuppliers,s.Content=this.supplierContainer,s.width=500,s.height=450,s.renderTo=this.target,s.formName=S.MEI_SUPPLIERS_FORM,s.OKLabel=f.label_Search,s.RemoveApplyButton=!0,m.unmaskLoader(this.target),this.suppliersDialog=new d(s),this.suppliersDialog.render(),this.suppliersDialog._dialog.buttons.Ok.domId="SpecsMEI-SearchSupplier",this.suppliersDialog._dialog.buttons.Ok.disabled=!1,this.loadIndustryValues();var a=p.getPlatformId();o.getServiceURL("3dnetwork",a)||h.displayNotification({eventID:"error",msg:f.Msg_SupplyNetworkDeployKO}),this.suppliersDialog.listenTo(this.suppliersDialog,"EVENT_CLICK_SPEC_OK",function(){var e={};"SpecsMEI-SearchSupplier"===this._dialog.buttons.Ok.domId&&(m.maskLoader(t.supplierContainer,f.SearchingLoader),e.formValues=t.getSuppliersRequestInput(),l(e).then(t.searchSuppliersCallBack.bind(t),t.onError.bind(t)))});var l=function(e){var i=[],s=[],a=[],l=t.suppliersFormFields.name.inputfield.value.trim(),o=t.suppliersFormFields.industry.inputfield.value,p=t.suppliersFormFields.level.inputfield.value,u=t.suppliersFormFields.preference.inputfield.value,d={buyer:"",attributes:{preferences:["High","Medium"]},limit:20,skip:0};if(l&&(d.attributes.title=l),o&&o.length>0){for(var c=0;c<o.length;c++)i.push(o[c]);d.attributes.companyClassifications=i}if(p&&p.length>0){for(var S=0;S<p.length;S++)s.push(p[S]);d.attributes.levels=s}let g={Default:"Medium","Not Preferred":"Low",Preferred:"High"};if(u&&u.length>0){for(var v=0;v<u.length;v++)a.push(g[u[v]]);d.attributes.preferences=a}return new Promise(function(e,i){t.meiServiceProvider.searchSuppliersByCriteria(d).then(function(e){if(e){var i=e.companies,s=new r;if(i&&i.length)for(var a=0;a<i.length;a++){var l={};l.label=i[a].title,l.supplierName=i[a].uid,l.country=i[a].registrationLocation,l.industry=i[a].registrationId,l.supplierUUID=i[a].uid;var o=(new n).set(l);s.addRoot(o)}}t.supplierListModel=s,t.renderSupplierList(s);var p=document.getElementById("xsr-MEI-supplier-filter").getChildren();p&&p[0]&&p[0].setStyle("width","90%")}).catch(function(e){m.unmaskLoader(t.supplierContainer),h.displayNotification({eventID:"error",msg:e.errors?e.errors[0].details:f.Error_Invalid_Search})})})}},showAllNodes:function(e){var i=this;e&&Array.isArray(e)&&e.forEach(function(e,t){e._canBeGrouped()?(e.setSearchFilterState(!0),e.applyFilters()):i.showAllNodes(e.getChildren())})},renderSupplierList:function(i){var r=this;m.unmaskLoader(this.supplierContainer),this.suppliersDialog._dialog.buttons.Ok.label=f.add,this.suppliersDialog._dialog.buttons.Ok.domId="SpecsMEI-AddSupplier",this.suppliersDialog._dialog.buttons.Ok.disabled=!1;var s=new e.Element("div",{class:"xsr-MEISupplier-Toolbar-Container"}),n=new e.Element("div",{class:"xsr-MEISupplier-Body-Container"}),a=new e.Element("div",{class:"xsr-MEI-SupplierList-Container"});this.supplierListContainer=a;new e.Element("div",{class:"xsr-mei-supplier-back-btn fonticon fonticon-left fonticon-2x"}).inject(s).addEventListener("click",function(e){r.suppliersDialog._dialog.buttons.Ok.label=f.label_Search,r.suppliersDialog._dialog.buttons.Ok.domId="SpecsMEI-SearchSupplier",r.supplierListContainer&&r.hideContainer(r.supplierListContainer),r.searchCriteriaContainer&&r.showContainer(r.searchCriteriaContainer),r.suppliersDialog.listenTo(r.suppliersDialog,"EVENT_CLICK_SPEC_OK",function(){var e={};"SpecsMEI-SearchSupplier"===this._dialog.buttons.Ok.domId&&(m.maskLoader(r.supplierContainer,f.SearchingLoader),e.formValues=r.getSuppliersRequestInput(),"function"==typeof searchSuppliers&&searchSuppliers(e).then(r.searchSuppliersCallBack.bind(r),r.onError.bind(r)))})}.bind(this.suppliersDialog));var o,p=new t({domId:"xsr-MEI-supplier-filter",placeholder:f.placeHolder_FilterSupplier,displayClearFieldButtonFlag:!0});p.inject(s);var u=i.getRoots().length;o=u>1?f.label_Items:f.label_Item;new e.Element("div",{class:"xsr-MEISupplier-count-Container",text:u+" "+o}).inject(s);s.inject(a),p.addEventListener("uncommittedChange",function(e){var i=e.dsModel.valueToCommit,t=r.supplierListModel;t.prepareUpdate();var s=t.getChildren();r.showAllNodes(s),0!==i.length?(t.search({match:function(e){var t=e.nodeModel;if(!t._canBeGrouped())return!1;var r=t.getLabel()+" "+t.getSupplierName()+" "+t.getIndustry()+" "+t.getCountry();return i&&-1!==r.toUpperCase().indexOf(i.toUpperCase())?(t.setSearchFilterState(!0),!1):(t.setSearchFilterState(!1),!0)}}).forEach(function(e,i){e._canBeGrouped()&&(e.unmatchSearch(),e.setSearchFilterState(!1),e.applyFilters())}),t.pushUpdate()):t.pushUpdate()}.bind(this.suppliersDialog));var d={toolBarEvents:r.basicModelEvents,treeDocument:i};(this.searchCriteriaContainer&&this.hideContainer(this.searchCriteriaContainer),d.treeDocument.getRoots().length>0)?new l(d).render().inject(n):r.emptyMsg(n);n.inject(a),a.inject(this.supplierContainer),this.suppliersDialog.listenTo(this.suppliersDialog,"EVENT_CLICK_SPEC_OK",function(){if("SpecsMEI-AddSupplier"===r.suppliersDialog._dialog.buttons.Ok.domId){var e=r.supplierListModel.getSelectedNodes();if(!(e&&e.length>0))return void h.displayNotification({eventID:"error",msg:f.NoItemSelected});r.suppliersDialog.closeDialog(),r.manufacturerField.inputfield[0].value=e[0].getLabel(),r.manufacturerField.inputfield[0].uid=e[0].getSupplierName()}})},hideContainer:function(e){e.setStyle("display","none")},showContainer:function(e){e.setStyle("display","block")},getSuppliersRequestInput:function(){var e={};for(var i in this.suppliersFormFields){var t=this.suppliersFormFields[i];e[i]="name"===i?this.hasValue(t.inputfield.value)?t.inputfield.value.trim():"":this.hasValue(t.inputfield.value)?t.inputfield.value:""}return this.SuppliersInput=e,e},searchSuppliersCallBack:function(e){if(null==e)return h.clearNotifications(),void h.displayNotification({eventID:"error",msg:f.Error_SearchSupplier});void 0!==e&&this.options.createCloseAction(e),m.unmaskLoader(this.supplierContainer)},onError:function(e){this.suppliersDialog.maskOrUnMaskDialog(),m.unmaskLoader(this.supplierContainer),h.displayNotification({eventID:"error",msg:e&&e.message||f.Error_SearchSupplier})},hasValue:function(e){return null!=e&&""!==e},emptyMsg:function(i){var t=e.createElement("div",{class:"grid-empty-tile wux-datagridview-emptycontentmessage xsr-mei-grid"}),r=e.createElement("div");r.innerHTML=f.Msg_NotFound_Supplier,r.inject(t),t.inject(i)}})});