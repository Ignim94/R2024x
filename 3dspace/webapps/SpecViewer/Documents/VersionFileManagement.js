define("DS/SpecViewer/Documents/VersionFileManagement",["DS/SpecGridView/SpecGridView","DS/Controls/Abstract","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/Utils","DS/SpecViewer/Documents/view/VersionFileView","DS/XSRCommonComponents/utils/DocumentServiceProvider","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/createform/view/NewForm","DS/XSRCommonComponents/utils/XSRMask","DS/SpecViewer/Documents/service/RelatedDocServiceWrapper","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/RequestUtil","i18n!DS/SpecViewer/assets/nls/SpecViewer","css!DS/SpecViewer/Documents/MangeFiles.css"],function(e,i,t,n,o,s,r,a,c,l,d,m,h){"use strict";return i.extend({init:function(e){var i=e,t={columns:[{text:h.label_Filename,dataIndex:"fileName",typeRepresentation:"string",pinned:"left",autoRowHeightFlag:!1,alwaysVisibleFlag:!0},{text:h.ColumnActions,dataIndex:"actionsIcon",typeRepresentation:"UWAObject",sortableFlag:!1,resizableFlag:!0,width:"180",pinned:"left",alwaysVisibleFlag:!0,allowUnsafeHTMLContent:!0,getCellValue:this.getActionsIcon.bind(this)},{text:h.ColumnVersion,dataIndex:"version",typeRepresentation:"string"},{text:h.label_Owner,dataIndex:"fileOwner",typeRepresentation:"string"},{text:h.ColumnComments,dataIndex:"comments",typeRepresentation:"string",autoRowHeightFlag:!1},{text:h.ColumnLockedBy,dataIndex:"lockerFullName",typeRepresentation:"string"},{text:h.ColumnFileSize,dataIndex:"fileSize",typeRepresentation:"string"},{text:h.label_CreationDate,dataIndex:"originated",typeRepresentation:"string"},{text:h.label_LastModified,dataIndex:"modified",typeRepresentation:"string"}]};this.itemId=Array.isArray(i.itemId)?i.itemId[0]:i.itemId,this.container=i.container,this.preferredView=i.preferredView,this.currentTabKey=i.currentTabKey,this.appCore=i.appCore,this.modelEvents=this.appCore.specViewerModelEvents,this.specModel=i.specModel,this.itemTitle=this.specModel.getTitle(),this._columns=t;var n={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container};this.service=new l(n)},render:function(){if(this._versionContainer=UWA.createElement("div",{class:"xsr-manage-files-target"}).inject(this.container),n.isOriginatedInGLS(this.specModel)){var e=h.replace(h.get("FilesManagedInGLS"),{type_name:this.specModel.getType(),spec_title:this.specModel.getTitle()});this.msgDiv=new UWA.createElement("div",{class:"xsr-manage-files-preview-msg"}).inject(this._versionContainer),new UWA.createElement("div",{class:"preview-msg",text:e}).inject(this.msgDiv)}else this.fileView=new o({mContainer:this._versionContainer,ctx:this,appCore:this.appCore}),this.fileView.render(),this.specModel.hasAccess("modify")?this.fileView.toggleDropDiv(!1):this.fileView.toggleDropDiv(!0),this.initializeSingleGrid()},initializeSingleGrid:function(){var i={itemId:this.itemId,container:this._versionContainer,appCore:this.appCore,enableInteractiveRightPanel:!1,dvgOpts:{rowDragEnabledFlag:!1}};this.fileGrid=new e(i),this.getDocuments(),this.fileGrid.setColumns(this._columns.columns),this.fileGrid.render(),this.fileGrid.gridManager.grid.layout.cellHeight=30,this.fileGrid.getTreeDocument().setUseChangeTransactionMode(!1)},getCheckedOutFiles:function(){for(var e={},i=this.fileGrid.getTreeDocument().getOriginalGridRoots(),t=0,n=0;n<i.length;n++){var o=i[n];if(o.options.grid.showCheckin&&(t+=1,e.fileID=o.options.grid.id,e.fileName=o.options.grid.fileName),t>1)return e.isMultiFileCheckedOut=!0,e}return e},getFileTreeDocument:function(){return this.fileGrid.getTreeDocument()},getDocuments:function(){var e=this;this.service.getVersionFiles(this.itemId,!0,function(i){return i.options.grid.actionsIcon=e.actions(i),i}).then(function(i){i&&i.length>0?(e.fileGrid.addRootNodes(i,!1),e.fileGrid.getTreeDocument().expandAll(),e.fileGrid.checkAndUpdatePersistency()):e.fileGrid.displayEmptyObjectView()}).catch(function(e){console.log(e),t.displayNotification({eventID:"error",msg:h.Failure_files})})},actions:function(e){var i=e.options.grid,t=i.isLatestVersion,n=new UWA.createElement("div",{class:"xsr-file-actions-bar"}),o=i.parentHasModifyAccess;return o?this.fileView.toggleDropDiv(!1):this.fileView.toggleDropDiv(!0),i.showDownload&&!m.isMobile()&&this.fileView.downloadAction.call(this,n,e),t&&i.showCheckout&&i.showLock?(this.fileView.checkoutAction.call(this,n,e),this.fileView.lockAction.call(this,n,e)):t&&i.showCheckin&&i.showUnlock?(o&&this.fileView.checkInAction.call(this,n,e),this.fileView.unlockAction.call(this,n,e)):t&&i.showUnlock&&this.fileView.unlockAction.call(this,n,e),this.fileView.deleteAction.call(this,n,e),n},getActionsIcon:function(e){return e.nodeModel.options.grid.actionsIcon},prepareCallBackActions:function(e){var i,n,o=this;o.gridcontainer=this.container;var l=e.name,d=e.nodeModel;switch(l){case"download":i={data:{itemPid:o.itemId,checkout:!1,versionId:e.versionId,filename:e.fileName}},(n=new s).downloadFile(i).then(o._onSuccessAction.bind(o,d,void 0)).catch(o.onError.bind(o));break;case"checkout":i={data:{itemPid:o.itemId,checkout:!0,versionId:e.versionId,filename:e.fileName}},(n=new s).downloadFile(i).then(o._onSuccessAction.bind(o,d,h.Message_CheckoutSuccess)).catch(o.onError.bind(o));break;case"checkin":i={data:{itemPid:o.itemId,files:e.fileInfo,fileComments:e.comments,mode:e.mode,versionId:e.versionId}},c.maskLoader(o.gridcontainer,h.LoaderUploadingFile),n=new s,"modify"!==e.mode?o.service.getVersionFiles(o.itemId,!1).then(function(e){if(e.length>0){var s=h.replace(h.get("Message_CheckinFail"),{title:o.itemTitle});t.displayNotification({eventID:"error",msg:s}),o._onSuccessAction(d),c.unmaskLoader(o.gridcontainer)}else n.uploadFile(i).then(o._onUploadSuccessAction.bind(o)).catch(o.onError.bind(o))}).catch(o.onError.bind(o)):n.uploadFile(i).then(o._onUploadSuccessAction.bind(o)).catch(o.onError.bind(o));break;case"lock":i={data:{itemPid:o.itemId,versionId:e.versionId}},(n=new s).lockDocument(i).then(o._onSuccessActionLockUnLock.bind(o,d,h.Message_LockSuccess)).catch(o.onError.bind(o));break;case"unlock":i={data:{itemPid:o.itemId,versionId:e.versionId}},(n=new s).unlockDocument(i).then(o._onSuccessActionLockUnLock.bind(o,d,h.Message_UnlockSuccess)).catch(o.onError.bind(o));break;case"delete":!function(e){var i=new UWA.Element("div",{class:"Delete-Dialog-Option-Container"}),t=new UWA.Element("div",{class:"xsr-delete-message-icon"}).inject(i),n=(new UWA.Element("span",{class:"xsr-delete_warning_icon fonticon fonticon-attention fonticon-2x"}).inject(t),new UWA.Element("p",{class:"message-container",html:h.DeleteConfirm}).inject(t),{formStyle:"vertical",fields:[{name:"ConfirmMessage",element:i,type:"uwaobject"},{name:"Delete",type:"toggle",toggleType:"radio",direction:"vertical",toggleOptions:[{name:"DeleteLatest",label:h.DeleteLatest,disabled:!1,key:"deleteLatestVersion"},{name:"DeleteAll",label:h.DeleteAllVersion,disabled:!1,key:"deleteAllVersion"}]}]}),l=new a(n),d=l.render(),m={};m.position={at:"center",my:"center"},m.Title=h.DeleteVersionDialog,m.Content=d,m.width=550,m.height=150,m.renderTo=o.container,m.RemoveApplyButton=!0,m.OKLabel=h.label_Button_Ok;var g=new r(m);g.render(),l.listenTo(l,"TYPE_TOGGLE_CHANGE",function(e){var i={hasDirtyField:!1};g.dispatchEvent("CONTAINS_DIRTY_FIELD",i)}),g.listenTo(g,"EVENT_CLICK_SPEC_OK",function(){for(var i,t=l.formfieldControls.Delete.inputfield,n=0;n<t.length;n++)t[n].checkFlag&&(i="deleteAllVersion"===t[n].value);g.closeDialog(),c.maskLoader(o.gridcontainer,h.LoaderDeletingFiles),t={data:{itemPid:o.itemId,versionId:e.versionId,latestVersionId:e.latestVersionId,deleteAllVersions:i}},(new s).deleteVersion(t).then(o._onDeleteSuccessAction.bind(o)).catch(o.onError.bind(o))})}(e)}},_onDeleteSuccessAction:function(){c.unmaskLoader(this.gridcontainer),t.clearNotifications(),t.displayNotification({eventID:"success",msg:h.Message_DeleteSuccess}),this.fileGrid.getTreeDocument().removeRoots(),this.getDocuments()},_onUploadSuccessAction:function(){c.unmaskLoader(this.gridcontainer),t.clearNotifications(),t.displayNotification({eventID:"success",msg:h.Message_CheckinSuccess}),this.fileView.fileField.dispatchEvent("CLEAR_FIELD_VALUES"),this.fileGrid.getTreeDocument().removeRoots(),this.getDocuments(),this.modelEvents.publish({event:d.EVENT_MODEL_UPDATED,data:this.itemId})},_onSuccessActionLockUnLock:function(e,i){this.syncModel(e),i&&t.displayNotification({eventID:"success",msg:i}),this.modelEvents.publish({event:d.EVENT_MODEL_UPDATED,data:this.itemId})},_onSuccessAction:function(e,i){i&&t.displayNotification({eventID:"success",msg:i}),this.syncModel(e),this.modelEvents.publish({event:d.EVENT_MODEL_UPDATED,data:this.itemId})},syncModel:function(e){var i=this;if(e){var n=e.options.grid.id;this.service.getVersionFiles(this.itemId,!1).then(function(t){if(t&&t.length>0)for(var o=0;o<t.length;o++){var s=t[o];if(s.id===n){e.set(s),e.options.grid.actionsIcon=i.actions(e),e.updateOptions();break}}}).catch(function(e){console.log(e),t.displayNotification({eventID:"error",msg:h.Failure_files})})}},onError:function(e){console.log(e),this.gridcontainer&&c.unmaskLoader(this.gridcontainer);var i=h.LoadingError;e&&e.message&&(i=e.message),t.clearNotifications(),t.displayNotification({eventID:"error",msg:i})},destroy:function(){this._versionContainer.destroy(),this.fileGrid&&this.fileGrid.destroy()}})});