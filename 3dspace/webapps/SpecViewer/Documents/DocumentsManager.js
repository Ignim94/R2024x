define("DS/SpecViewer/Documents/DocumentsManager",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/PlatformAPI/PlatformAPI","DS/SpecGridView/SpecGridView","DS/XSRCommonComponents/utils/Utils","DS/SpecGridView/utils/GridUtil","DS/SpecViewer/Documents/service/RelatedDocServiceWrapper","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XSRSearch","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/GridCommonActionsManager","text!DS/SpecViewer/assets/DocConfig/DocToolBarCommands.json","text!DS/SpecViewer/assets/DocConfig/RefDocToolBarCommands.json","DS/XSRCommonComponents/utils/TypeUtils","text!DS/SpecViewer/assets/DocConfig/DocColumnConfig.json","i18n!DS/SpecViewer/assets/nls/SpecViewer","css!DS/SpecViewer/Documents/Documents.css"],function(e,t,i,o,n,r,s,c,a,d,l,u,m,h,p,g,v,f){"use strict";return i.extend({init:function(e){var t=e;this.itemId=Array.isArray(t.itemId)?t.itemId[0]:t.itemId,this.container=t.container,this.preferredView=t.preferredView,this.currentTabKey=t.currentTabKey,this.appCore=t.appCore,this.specModel=t.specModel,g.isTechnicalSpecification(t.itemType)?this.toolBarActions=JSON.parse(p):this.toolBarActions=JSON.parse(h),this._columns=JSON.parse(v),this.modelEvents=t.appCore.specViewerModelEvents,this.itemTitle=e.specModel.getTitle(),this.itemMaturity=e.specModel.getMaturity(),this.basicModelEvents=t.appCore.basicModelEvents,this.relDocEventList=[],this._subscribeEvents();var i={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container,contextItem:this.itemId};this.service=new c(i)},_subscribeEvents:function(){var i=this,n=function(e){i.docGrid.getTreeDocument().getSelectedNodes().forEach(function(t){t.getID()===e&&i.service.fetchDocInfo([e],t.getRelationshipType()).then(function(e){Object.assign(t.options,e[0].options),t.updateOtherDetails()}).catch(function(e){console.log(e)})})};this.relDocEventList.push(this.modelEvents.subscribe({event:"grid-sync-node-data"},function(e){e&&Array.isArray(e)?e.forEach(function(e){n(e)}):e&&n(e)})),this.relDocEventList.push(this.modelEvents.subscribe({event:a.EVENT_GRID_TOTAL_SELECTED_NODES},function(e){i.selectedGridCount=e.count,i.selectedGridNodes=e.currentModel})),this.platFormSubscrpition=o.subscribe("DS/PADUtils/PADCommandProxy/refresh",function(t){t.data.authored&&t.data.authored.modified&&(t.data.authored.modified.forEach(function(t){var o;e.is(t,"object")?o=t.physicalid:e.is(t,"string")&&(o=t),i.docGrid.getTreeDocument().getSelectedNodes().forEach(function(e){e.getID()===o&&e.sync()})}),i.basicModelEvents.publish({event:a.EVENT_INFORMATION_PANEL_REFRESH}))}),this.relDocEventList.push(this.modelEvents.subscribe({event:a.EVENT_LAUNCH_PREV_NEXT_COMMAND},function(e){e.commandId;var t=e.move,o=e.itemId,n=(e.callBackAction,i.docGrid.getTreeDocument().getSelectedNodes());if(n&&!n||!(n.length<=0||n.length>1)?(n=Array.isArray(n)?n[0]:n)&&n.getID()!==o&&(n=(new s).getModelById(o,i.docGrid)):n=(new s).getModelById(o,i.docGrid),n&&n.getID()===o){var c=r.getValidPreviousorNextNode(n,t);c&&(i.docGrid.unselectAll(),i.gridViewInstance=i.docGrid.getGridViewInstance(),i.gridViewInstance&&i.gridViewInstance.ensureNodeModelVisible(c),c.select())}})),this.relDocEventList.push(this.modelEvents.subscribe({event:a.GRID_CONTEXT_MENU+"-"+i.currentTabKey},function(e){var t=e,o=i.docGrid.getTreeDocument().getSelectedNodes();if(t.gridInstance=i.docGrid,o&&o.length>1)(0,m.getMultiActionMenu)(t);else if(o&&(0===o.length||1===o.length)){(0,m.getActionMenu)(t)}})),this.relDocEventList.push(this.modelEvents.subscribe({event:"grid-item-toolbar-mutiactions-list-"+i.currentTabKey},function(e){e&&(e.nodeModel=i.docGrid.getTreeDocument()),e.gridInstance=i.docGrid,(0,m.getToolbarActionMenu)(e)})),this.relDocEventList.push(this.modelEvents.subscribe({event:"grid-list-remove-node-successful-"+i.currentTabKey},function(e){i.docGrid.removeRootNodes(e),i.docGrid.removeItemsOnTagger(e)})),this.relDocEventList.push(this.modelEvents.subscribe({event:"grid-toolbar-switch-view-"+i.currentTabKey},function(e){var t="grid-preferred-view-"+i.currentTabKey;widget.setValue(t,e),i.docGrid.switchView(e)})),this.relDocEventList.push(this.modelEvents.subscribe({event:"grid-cell-value-update-"+i.currentTabKey},function(e){var t=e.newValue,o=e.nodeModel.getID();d.maskLoader(i.container,f.UpdatingLoader);var n=function(e,t){"success"===e?i.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+i.currentTabKey}):i.modelEvents.publish({event:"xsr-show-toolbar-reset-command-"+i.currentTabKey}),u.displayNotification({eventID:e,msg:t}),d.unmaskLoader(i.container)},r=function(t,r,s){i.docGrid.unselectAll(),e.nodeModel.select(),i.service.updateAndSyncAttributes(o,[{attribute:t,value:r,isBasicAttribute:s}],e.nodeModel).then(function(){i.docGrid.getTreeDocument().acceptChanges(),n("success",f.Notify_Updated)}).catch(function(e){n("error",f.Failure_Update)})};switch(e.dataIndex){case"ds6w:description":r(a.DESCRIPTION,t,!0);break;case"tree":var s=a.TITLE;t?r(s,t,!1):n("error",f.Error_EmptyTitle);break;default:d.unmaskLoader(i.container)}})),this.relDocEventList.push(this.modelEvents.subscribe({event:"grid-toolbar-action-click-"+i.currentTabKey},function(e){var o=function(e,o){return new t(function(t,n){d.maskLoader(i.container,f.LoaderUploadingFile),i.service.createDocumentFromFile(e,i.itemId,o).then(function(e){i.addNodesToGrid(e,!0),d.unmaskLoader(i.container),t()}).catch(function(o){var n=f.replace(f.get("Error_Document"),{title:e.name});u.displayNotification({eventID:"error",msg:n}),d.unmaskLoader(i.container),t()})})},c=function(e){var n=r.getFileInput();n.addEventListener("change",function(s){s.preventDefault(),s.stopImmediatePropagation();var c=s.target.files.length>0?s.target.files:s.dataTransfer.files;n.removeEvent("change"),n.destroy();var a=[];c.length>0&&i.docGrid.unselectAll();for(var d=0;d<c.length;d++){var l=c[d],m=l.name;if(r.isRestrictedFileFormat(m)){var h=f.replace(f.get("Restricted_Document"),{filename:m});u.displayNotification({eventID:"error",msg:h})}else a.push(o(l,e))}t.all(a).then(function(){i._updateGroup()}).catch(function(){i._updateGroup()})}),n.click()},m=async function(e){var o={allowedTypes:["Document"],role:"",criteria:await l._getSearchCriteria(i.appCore.immersiveFrame,i.appCore.immersiveFrame.elements.container.querySelector("div.grid-doc-container div.enox-collection-toolbar-actions span.fonticon-plus")),precondition:'(latestrevision=="TRUE") AND NOT [current]:"OBSOLETE" AND NOT [policy]:"Version"',in_apps_callback:function(o){console.log(o);var r={};if(o&&o.length>0){for(var c=d.maskLoader(i.container,f.InsertingLoader),a=o.length>0?100/o.length:0,l=[],m=0;m<o.length;m++){c.update(a.toString()),o.length;var h=o[m];if(h.id===i.itemId)r[h.id]=f.replace(f.get("Insert_cyclic_failure"),{title:i.itemTitle});else{var p=(new s).getModelById(h.id,i.docGrid);if(p&&p.getRelationshipType()===e){var g=f.replace(f.get("Document_exist"),{docTitle:p.getTitle()});r[h.id]=g}else{var v=i.service.createModelForSearchResult(o[m],i.itemId);l.push(i.service.addDocuments(v,e))}}}t.all(l).then(function(t){if(t){for(var o=0;o<t.length;o++)if(t[o].isSuccess){var s=t[o].currentModel;s.setRelationshipType(e),i.docGrid.unselectAll(),i.addNodesToGrid(s,!0),n(s.getID())}else{var c=t[o].currentModel,a=f.replace(f.get("Failure_Insert"),{title:c.getTitle()});r[c.getID()]=a}i._updateGroup(),r&&Object.entries(r).length>0?function(e){if(e)for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];u.displayNotification({eventID:"error",msg:i})}}(r):u.displayNotification({eventID:"success",msg:f.Document_Insert_Success})}}),d.unmaskLoader(i.container)}},excludeList:i.getExistingDocIds()};new l(o).launchSearch(o)},h=function(e){var t=i.docGrid.getTreeDocument().getSelectedNodes();if(t&&t.length>0){var o;"remove"===e?o=a.REMOVE_CHILD_CMD:"delete"===e&&(o=a.DELETE_ITEM_CMD),i.basicModelEvents.publish({event:a.EVENT_LAUNCH_COMMAND,data:{commandId:o,context:{item:{data:t}}}})}else{var n="";"delete"===e?n=f.actionErrMsgDelete:"remove"===e&&(n=f.actionErrMsgRemove),u.displayNotification({eventID:"error",msg:f.NoItemSelected+n})}};if(e)switch(e){case"createRelDoc":c(a.RELATED_DOC_REL_NAME);break;case"createAnnexDoc":c(a.ANNEX_DOC_REL_NAME);break;case"addRelDoc":m(a.RELATED_DOC_REL_NAME);break;case"addAnnexDoc":m(a.ANNEX_DOC_REL_NAME);break;case"removeitem":h("remove");break;case"deleteItem":h("delete");break;case"Export":i._exportGrid();break;case"personalize":i._personalize()}}))},render:function(){this._relDocContainer=e.createElement("div",{class:"grid-doc-container"}).inject(this.container),this.initializeSingleGrid()},initializeSingleGrid:function(){var e={itemId:this.itemId,container:this._relDocContainer,appCore:this.appCore,preferredView:this.preferredView,currentTabKey:this.currentTabKey,enableCrossWidgetFeature:!1,isColorized:!0,parentModel:this.specModel,enableInteractiveRightPanel:!0,rowGroupingOptions:{hideGroupedColumns:!0,depth:0,getGroupingNodeLabel:function(e){return e.getIdentifier()}}};this.docGrid=new n(e),this.loadDocuments();var t=this.toolBarActions.actions,i=this._columns.columns,o=this.getNLSLabels(t),r=this.getNLSLabels(i);this.docGrid.setColumns(r),this.docGrid.render(),this.docGrid.setToolBarActions({actions:o}),this.setCustomTooltipOnTile()},getNLSLabels:function(e){var t=e;if(t){var i=function(e){for(var t=0;t<e.length;t++)e[t].text=e[t].text&&f[e[t].text]?f[e[t].text]:e[t].text,e[t].subMenu&&i(e[t].subMenu)};i(t)}return t},setCustomTooltipOnTile:function(){this.docGrid.tileManager&&(this.docGrid.tileManager.grid.getCustomTooltip=function(e){return e._canBeGrouped()?f.label_Title+": "+e.getLabel()+"\n"+f.label_Type+": "+e.getType()+"\n"+f.label_Revision+": "+e.getRevision()+"\n"+f.label_LastModified+": "+e.getModifedDate():e.getLabel()})},loadDocuments:function(){var e=[];e.push(this.getDocuments(a.RELATED_DOC_REL_NAME)),e.push(this.getDocuments(a.ANNEX_DOC_REL_NAME));var i=this;t.all(e).then(function(){i.docGrid.getTreeDocument()&&(i.docGrid.getTreeDocument().getOriginalGridRoots().length<=0?i.docGrid.displayEmptyObjectView():(i.docGrid.addTagger(),i._updateGroup()))})},getDocuments:function(e){var i=this;return new t(function(t,o){i.service.getRelatedDocuments(i.itemId,e).then(function(e){e&&e.length>0&&i.docGrid.getTreeDocument()&&i.addNodesToGrid(e,!1),t()}).catch(function(e){console.log(e);var i=f.Failure_Documents;u.displayNotification({eventID:"error",msg:i}),t()})})},addNodesToGrid:function(e,t){this.docGrid.addRootNodes(e,t),this.docGrid.updateItemsOnTagger(e)},_exportGrid:function(){var e=this.itemTitle+"_"+this.itemMaturity+"_"+f.tab_Documents;this.docGrid.exportGrid(e)},_personalize:function(){this.docGrid.personalize()},_updateGroup:function(){this.docGrid.getTreeDocument().getOriginalGridRoots().length>0&&(this.docGrid.unGroupRoots(),void 0===widget.getValue("xsr-noDefault-RelType")?this.docGrid.groupRoots("relType"):this.docGrid.updateGroupByIfAny())},getExistingDocIds:function(){var e=[],t=this.docGrid.getTreeDocument().getOriginalGridRoots();if(t&&t.length>0)for(var i=0;i<t.length;i++){var o=t[i];e.push(o.getID())}return e},destroy:function(){this._relDocContainer.destroy(),this.docGrid.destroy(),this.platFormSubscrpition&&o.unsubscribe(this.platFormSubscrpition),this.relDocEventList&&this.modelEvents.unsubscribeList(this.relDocEventList)}})});