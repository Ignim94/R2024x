define("DS/SpecViewer/Documents/service/RelatedDocServiceWrapper",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/SpecViewer/Documents/model/RelatedDocumentModel","DS/SpecViewer/Documents/model/VersionedFileModel","DS/XSRCommonComponents/utils/DocumentServiceProvider","DS/XSRCommonComponents/utils/ResponseParser","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/RequestUtil"],function(e,t,n,s,a,r,o,i,l,d){"use strict";return n.extend({init:function(e){e&&(this.currentTabKey=e.currentTabKey,this.appCore=e.appCore,this.myContainer=e.modelContainer,this.contextParentID=e.contextItem)},createListNodes:function(t,n){var s=[],a=this;return t.forEach(function(t){var r=a.createListNode(t,n);e.is(r)&&s.push(r)}),s},_parseDocResponse:function(n,s){var a=[],r=this,o=[];return n.forEach(function(n){var i=new t(function(t,o){var i={},l=n.relateddata.ownerInfo[0].dataelements,d=n&&n.relateddata&&n.relateddata.files?n.relateddata.files[0]:null,c=d&&d.relateddata&&n.relateddata.versions?n.relateddata.versions:null;i["ds6w:type_value"]=n.type,i.physicalid=n.id,i["ds6w:description"]=n.dataelements.description,i["ds6w:globalType"]="ds6w:Document",i["ds6w:label"]=n.dataelements.title,i["ds6wg:revision"]=n.dataelements.revision,n.dataelements.isLatestRevision&&"string"==typeof n.dataelements.isLatestRevision?"false"==n.dataelements.isLatestRevision.toLowerCase()?i.isLastVersion=!1:i.isLastVersion=!0:i.isLastVersion=!!n.dataelements.isLatestRevision&&n.dataelements.isLatestRevision,i["ds6w:status_value"]=n.dataelements.state,i["ds6w:created"]=n.dataelements.originated,i["ds6w:modified"]=n.dataelements.modified,i["ds6w:identifier"]=n.dataelements.name,i["ds6w:policy_value"]=n.dataelements.policy,i.parentId=n.dataelements.parentId,i.hasDownloadAccess=n.dataelements.hasDownloadAccess,i.hasModifyAccess=n.dataelements.hasModifyAccess,i.hasDeleteAccess=n.dataelements.hasDeleteAccess,i.relType=s,i["ds6w:responsible"]=l.firstname+" "+l.lastname,i.icons=[n.dataelements.image?n.dataelements.image:"I_CDM_Document"],i.thumbnail=n.dataelements.image.endsWith(".gif")?"":n.dataelements.image,i.locker=d&&d.dataelements.locker&&d.dataelements.locker.length>1?d.dataelements.locker:null,i["ds6w:docExtension"]=d?d.dataelements.title.split(".").pop():null,i.isMultiFile=!!d&&n.relateddata.files.length>1,i.isVersionedFile=!!c&&c.length>1,i.versionId=d?d.id:null,i.fileName=d&&d.dataelements.title?d.dataelements.title:null,i.format=d&&d.dataelements.format?d.dataelements.format:null,i.fileSize=d&&d.dataelements.fileSize?d.dataelements.fileSize:null,i.comments=d&&d.dataelements.comments?d.dataelements.comments:null,i.fileOriginated=d&&d.dataelements.originated?d.dataelements.originated:null,i.fileModified=d&&d.dataelements.modified?d.dataelements.modified:null;var u,m={withNlsProp:["ds6w:type","ds6w:status"],classes:[],properties:{"ds6w:type":[n.type],"ds6w:status":[n.dataelements.state]}};r.resolveMissingNls(m).then(function(n){u=r.createListNode(i,r.genericOptionsMapper.bind(r,n[0])),e.is(u)&&a.push(u),t(u)})});o.push(i)}),o},_parseAndfetchVersionModel:function(e,n,s){var a=e.dataelements,r="true"===a.hasDeleteAccess.toLowerCase(),o="true"===a.hasModifyAccess.toLowerCase(),i="true"===a.hasDownloadAccess.toLowerCase(),c=e.relateddata.ownerInfo[0],u=e.relateddata.files,m=u.length>1,f=[],p=this,h=function(t){var n={},s=t.relateddata.ownerInfo[0].dataelements;n.id=t.id,n.type=t.type,n.relId=t.relId,n.parentId=e.id,n.parentPolicy=a.policy,n.parentStatus=a.state,n.parentRevision=a.revision,n.parentTitle=a.title,n.parentHasDownloadAccess=i,n.parentHasModifyAccess=o,n.parentHasDeleteAccess=r,n.parentOwner=c.dataelements.firstname+" "+c.dataelements.lastname,n.parentOwnerActualName=c.dataelements.name,n.fileName=n.tree=t.dataelements.title,n.comments=t.dataelements.comments,n.locker=t.dataelements.locker,n.lockerFullName=t.dataelements.locker,n.originated=t.dataelements.originated,n.fileSize=t.dataelements.fileSize?l.formatBytes(t.dataelements.fileSize):"",n.modified=t.dataelements.modified,n.format=t.dataelements.format,n.docExtension=t.dataelements.title.split(".").pop(),n.fileOwner=s.firstname+" "+s.lastname,n.fileOwnerActualName=s.name;var d=void 0!==n.locker&&null!==n.locker&&""!==n.locker;return n.showDelete=r,n.showDownload=i,n.showCheckout=!(!o||d),n.showLock=!(!o||d),n.showCheckin=!(!o||!d),n.showUnlock=!(!o||!d),n};return u.forEach(function(e){new t(function(t,a){var r,i=e&&e.relateddata&&e.relateddata.versions?e.relateddata.versions:null,l=h(e);if(l.isLatestVersion=!0,l.version=i.length+1,l.locker){var u=l.locker,w=c.dataelements.name,v=d.getloginUser().login,g=w===v,D=u===v;g&&!D?(l.showCheckin=!1,l.showUnlock=!!o):D||g||(l.showDelete=!1,l.showCheckout=!1,l.showLock=!1,l.showCheckin=!1,l.showUnlock=!1)}n?(r=p.createVersionModel(l),r=s(r)):r=l;for(var y=f.push(r),C=[],S=0;S<i.length;S++){var A,M=h(i[S]);M.version=i.length-S,n?(A=p.createVersionModel(M),A=s(A)):A=M,m?C.push(A):f.push(A)}n&&C.length>0?f[y-1].addChild(C):C.length>0&&f.push({versionFiles:C})})}),f},createListNode:function(e,t){var n=this._optionsRetrievor(e,t);return this.createGridModel(n)},createVersionModel:function(e){var t=(new a).set(e);return t.onContainer=this.myContainer,t.contextParentID=this.contextParentID,t},createGridModel:function(e){var t=(new s).set(e);return t.currentTabKey=this.currentTabKey,t.appCore=this.appCore,t.onContainer=this.myContainer,t.contextParentID=this.contextParentID,t.options.grid.parentType=i.TYPE_DOCUMENT,t},_optionsRetrievor:function(t,n){return n&&"function"===e.typeOf(n)?n(t):t},genericOptionsMapper:function(e,t){return t["ds6w:created"]=l.getformatedDate(t["ds6w:created"]),t["ds6w:modified"]=l.getformatedDate(t["ds6w:modified"]),t["ds6w:type"]=e["ds6w:type"][t["ds6w:type_value"]],t["ds6w:status"]=e["ds6w:status"][t["ds6w:status_value"]],t},resolveMissingNls:function(e){if(!Array.isArray(e.classes)||!e.properties)throw new Error("Ouups ! invalid input");var n=[];return n.push(l.getNlsOfPropertiesValues(e.properties)),t.all(n)},getNlsedListNodes:function(e){var n=this;return new t(function(t,s){if(!Array.isArray(e))return s(new Error(" inputs error"));var a=[],r={withNlsProp:["ds6w:type","ds6w:status"],classes:[],properties:{}};a.push(o.attributesParser(e,r)),n.resolveMissingNls(r).then(function(e){return t(n.createListNodes(a,n.genericOptionsMapper.bind(n,e[0])))})})},getRelatedDocuments:function(e,n){var s=this;return new t(function(a,o){(new r).getDocumentsFromParent(e,n).then(function(e){var r=s._parseDocResponse(e,n);t.all(r).then(function(e){a(e)}).catch(function(e){console.log(e)})}).catch(function(e){o(e)})})},getVersionFiles:function(e,n,s){var a=this,o={};return o.data={itemPid:e,getVersions:!0},new t(function(e,t){(new r).getDocumentInfo(o).then(function(t){if(n){var r=a._parseAndfetchVersionModel(t,!0,s);e(r)}else{var o=a._parseAndfetchVersionModel(t,!1);e(o)}}).catch(function(e){console.log(e),t()})})},fetchDocInfo:function(e,n){var s=this,a={};return a.data={itemPid:e},new t(function(e,o){(new r).getDocumentInfo(a).then(function(a){var r=s._parseDocResponse([a],n);t.all(r).then(function(t){e(t)})}).catch(function(e){return o(e)})})},addDocuments:function(e,n){return new t(function(t,s){(new r).attachDocument(e.getParentId(),e.getID(),n).then(function(n){n&&n.success?t({currentModel:e,isSuccess:!0}):t({currentModel:e,isSuccess:!1})}).catch(function(n){t({currentModel:e,isSuccess:!1})})})},createDocumentFromFile:function(e,n,s){var a=this;return new t(function(o,i){(new r).createDocument(e,n,{relationName:s}).then(function(e){var n=a._parseDocResponse(e,s);t.all(n).then(function(e){o(e)}).catch(function(e){console.log(e)})}).catch(function(e){i(e)})})},createModelForSearchResult:function(t,n){var s=this,a=function(e){return e.parentId=n,s.createGridModel(e)};if(Array.isArray(t)){for(var r=[],o=0;o<t.length;o++){var i=e.clone(t[o],!1);r.push(a(i))}return r}return a(e.clone(t,!1))},updateAndSyncAttributes:function(e,n,s){var a={itemid:e,request:n};return new t(function(e,t){(new r).updateAttributes(a).then(function(n){if(n.results&&n.results.length>0)for(var a=n.results,r=0;r<a.length;r++){if(200===a[r].status){var o=a[r].body;if(o.errors&&o.errors.length>0)t(o.errors);else{for(var d in o){var c=Array.isArray(o[d].value)?o[d].value[0]:o[d].value;i.DESCRIPTION===d&&(s.options.grid["ds6w:description"]=c),"modified"===d&&(s.options.grid["ds6w:modified"]=l.getformatedDate(c)),i.DOCUMENT_TITLE_SELECTABLE===d&&(s.options.grid["ds6w:label"]=c)}s.updateOtherDetails(),e()}}else t()}}).catch(function(e){console.log(e)})})}})});