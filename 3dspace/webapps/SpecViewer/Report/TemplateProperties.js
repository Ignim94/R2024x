define("DS/SpecViewer/Report/TemplateProperties",["UWA/Core","UWA/Class/View","DS/Controls/TooltipModel","DS/Controls/Button","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/createform/view/NewForm","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/DocumentServiceProvider","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/Notification","DS/SpecViewer/Report/model/TemplatePropertiesModel","i18n!DS/SpecViewer/assets/nls/SpecViewer"],function(e,t,o,l,n,i,a,s,r,p,c,d,m,h){"use strict";return t.extend({setup:function(e){this.specModel=e.specModel,this._specViewerModelEvents=e.appCore.specViewerModelEvents,this._basicModelEvents=e.appCore.basicModelEvents,this._triptychManager=e.appCore.triptychManager,this._propertiesPanel=e.appCore.specRightContainer,this._xSpecsMainContainer=e.appCore.specMainContainer,this.propModel=new m(this.specModel),this.isEditable=!!this.propModel.get("canApplyTemplate"),this.subscribeToEvents(),this.reportServices=new p},subscribeToEvents:function(){var e=this;e.basicEvent=[],e.specViewEvent=[],e.basicEvent.push(e._basicModelEvents.subscribe({event:c.XSR_EVENT_CHECK_RIGHT_BEFORE_CLOSE},function(t){var o=t.okCallBack,l=t.cancleCallBackFunc;e.cancelChanges.call(e,o,l)})),e.basicEvent.push(e._basicModelEvents.subscribe({event:"xsr-right-panel-closed"},function(){e.removeSubscriptions()})),e.basicEvent.push(e._basicModelEvents.subscribe({event:c.EVENT_SPEC_OTHER_ACTION_CLICK_SLIDEIN_OPEN},function(t){e._propertiesPanel.hasClassName(c.PROPERTIES_FIELD_DIRTY)?e._basicModelEvents.publish({event:c.XSR_EVENT_CHECK_RIGHT_BEFORE_CLOSE,data:{okCallBack:t.callBackFunc,cancleCallBackFunc:t.cancleCallBackFunc}}):("Information"!==t.cmdId?e._triptychManager.isRightPanelOpen()&&e.closeRightPane():(e._triptychManager.setCommandId("ReportTemplateInfo"),e.destroy()),t.callBackFunc&&"function"==typeof t.callBackFunc&&t.callBackFunc.call())}))},render:function(){this._specViewerModelEvents&&this._specViewerModelEvents.getEventByName(c.EVENT_DESTROY_INSTANCE)&&this._specViewerModelEvents.publish({event:c.EVENT_DESTROY_INSTANCE,data:{cmdId:c.REPORT_PROPERTIES}});var t=e.createElement("div",{id:"template-info-slide-in-panel"}).inject(this._propertiesPanel);this.slideInContent=t;var o=this.renderChangeTemplate(),l={reportTemplateTitle:{label:h.label_Title,value:this.propModel.get("reportTemplateTitle")},reportTemplateName:{label:h.label_Name,value:this.propModel.get("reportTemplateName")},reportTemplateRev:{label:h.label_Revision,value:this.propModel.get("reportTemplateRev")},reportTemplateDescription:{label:h.label_Description,value:this.propModel.get("reportTemplateDescription")}};this.getHeader().inject(t);var n=e.createElement("div",{class:"template-properties"});this.renderTemplateInfo(l).inject(n),o&&o.inject(n),n.inject(t);var i=this.getFooter().inject(t);this.closeButtonDiv=this.getCloseButton(i),this.applyCancelButtonsDiv=this.getApplyCancelButtons(i),this.applyCancelButtonsDiv.hide()},changeTemplate:function(){var t={itemPid:this.specModel.getID()},o=this;o.reportServices.isPDFReportCheckedIn(t).then(function(t){var l=o,i="Failed"===t.reportStatus||"Succeeded"===t.reportStatus||"None"===t.reportStatus;if(i){if(i){var a=l.propModel.get("newReportTemplateId"),s=l.propModel.get("specReportId");e.is(a)&&s?(n.maskLoader(l._propertiesPanel,h.Message_UpdateProperties),l.propModel.applyTemplate({data:{selectedTemplateId:a,specReportId:s}}).then(function(t){n.unmaskLoader(l._propertiesPanel);var o=t.responseStatus;e.is(o)&&"success"===o&&d.displayNotification({eventID:"success",msg:h.Message_Success_ChangeTemplate}),l.specModel.syncModel({onComplete:l._specTreeSyncModelCallBack.bind(l),onFailure:l._specTreeSyncModelCallBack.bind(l)})}).catch(function(e){n.unmaskLoader(l._propertiesPanel),console.log(e),d.displayNotification({eventID:"error",msg:e.message||h.Message_Error_ChangeTemplate})})):e.is(a)&&l.propModel.createSpecReport(a).then(function(e){e.specPid&&d.displayNotification({eventID:"success",msg:h.Message_Success_ApplyTemplate}),l.specModel.syncModel({onComplete:l._specTreeSyncModelCallBack.bind(l),onFailure:l._specTreeSyncModelCallBack.bind(l)})}).catch(function(e){console.log(e),d.displayNotification({eventID:"error",msg:e.message||h.Message_Error_UpdateTemplate})})}}else d.displayNotification({eventID:"warning",msg:h.Message_Error_ChangeTemplate+" "+h.message_ReportGenerationInProgress})}).catch(function(e){console.log(e)})},_specTreeSyncModelCallBack:function(e){if("succesful"!=e)throw new Error(e);var t=this.specModel.getSpecReportPid();this._specViewerModelEvents.publish({event:c.EVENT_REGENERATE_REPORT,data:t})},renderChangeTemplate:function(){var t=this;this.propModel.get("prevReportTemplateId");t.templateDropDownDiv=e.createElement("div",{id:"templateTextContainer"});var l={fields:[[{name:"reportTemplateTitle",mandatory:!1,placeholder:h.placeholder_TemplateTitle,disabled:!this.isEditable,type:"select",elementsList:[]}]]};if(t.templateDropDown=new s(l).render(),this.isEditable){t.templateDropDown.listenTo(t.templateDropDown,"EVENT_TYPE_CHANGE",function(e){var l=this.formfieldControls.reportTemplateTitle.inputfield,n=l.value;l.elementsList.forEach(function(e){n===e.valueItem&&(l.tooltipInfos=new o({shortHelp:e.description,allowUnsafeHTMLShortHelp:!1}),t.propModel.set("reportTemplateTitle",e.labelItem),t.propModel.set("reportTemplateName",e.name),t.propModel.set("reportTemplateRev",e.revision),t.propModel.set("reportTemplateDescription",e.description),t.propModel.set("newReportTemplateId",e.valueItem),t.switchToSaveCancel())})});this.propModel.addEvent("onChange:applicableTemplateList",function(l){!function(l){for(var n=0;n<l.length;n++){var i=l[n];if(t.propModel.get("prevReportTemplateId")===i.valueItem){l.splice(n,1);break}}e.is(l)&&l.length>0?(t.templateDropDown.formfieldControls.reportTemplateTitle.inputfield.tooltipInfos=new o({shortHelp:h.placeholder_TemplateTitle,allowUnsafeHTMLShortHelp:!1}),t.templateDropDown.formfieldControls.reportTemplateTitle.inputfield.elementsList=l):(t.templateDropDown.formfieldControls.reportTemplateTitle.inputfield.placeholder=h.placeholder_NoTemplate,t.templateDropDown.formfieldControls.reportTemplateTitle.inputfield.tooltipInfos=new o({shortHelp:h.placeholder_NoTemplate,allowUnsafeHTMLShortHelp:!1}))}(this.changedAttributes().applicableTemplateList)})}else t.templateDropDown.formfieldControls.reportTemplateTitle.inputfield.placeholder=h.placeholder_NoAccessTochangeTemplate,t.templateDropDown.formfieldControls.reportTemplateTitle.inputfield.tooltipInfos=new o({shortHelp:h.placeholder_NoAccessTochangeTemplate,allowUnsafeHTMLShortHelp:!1});return t.templateDropDown.inject(t.templateDropDownDiv),t.templateDropDownDiv},renderTemplateInfo:function(t){var l=e.createElement("div",{id:"templateInfoContainer"}),n=(e.createElement("div",{class:"template-header",text:h.label_ReportTemplate}).inject(l),function(e,t){var l=this.propModel.changedAttributes()[t];e.innerText=l||"--",e.tooltipInfos=new o({shortHelp:l||"",allowUnsafeHTMLShortHelp:!1})});if(t)for(var i in t){var a=t[i],s=a.label,r=a.value,p=e.createElement("div",{class:"template-field"}).inject(l),c=(e.createElement("div",{class:"template-label template-"+i,text:s}).inject(p),e.createElement("div",{class:"template-value template-"+i,text:r||"--"}).inject(p));this.propModel.addEvent("onChange:"+i,n.bind(this,c,i)),r&&(c.tooltipInfos=new o({shortHelp:r,allowUnsafeHTMLShortHelp:!1}))}return l},getHeader:function(){return e.Element("div",{id:"TemplatePropertiesHeader",class:"propertiesHeader",text:this.propModel.get("ItemTitle")+"- "+this.propModel.get("ItemRevision")})},getFooter:function(){return e.Element("div",{id:"TemplatePropertiesFooter",class:"propertiesFooter"})},getApplyCancelButtons:function(t){var o=e.createElement("div",{class:"xsr-properties-apply-cancel",id:"xsrApplyCancelButtons"}).inject(t),n=this;return this.buttonOk=new l({domId:"ApplyButton",allowUnsafeHTMLLabel:!1,label:h.label_Button_Save,emphasize:"primary",touchMode:!0,onClick:function(e){n.changeTemplate(),n.publishDirtyFieldInfo(!1),n.removeCheckandClose(),n.closeRightPane()}}).inject(o),new l({allowUnsafeHTMLLabel:!1,domId:"CancelButton",label:h.label_Button_Cancel,touchMode:!0,onClick:n.cancelChanges.bind(n)}).inject(o),o},cancelChanges:function(e,t){var o=this,l=o.drawConfirmationDialog();l.listenTo(l,"EVENT_CLICK_SPEC_OK",function(){l.closeDialog(),o.removeCheckandClose(),o.closeRightPane(),o.publishDirtyFieldInfo(!1),setTimeout(function(){e&&"function"==typeof e&&e.call()},500)}),t&&"function"==typeof t&&l.listenTo(l,"EVENT_CLICK_SPEC_CANCEL",function(){t.call()})},drawConfirmationDialog:function(){var e=new a({position:{at:"center",my:"center"},renderTo:this._xSpecsMainContainer,RemoveApplyButton:!0,OKLabel:h.label_Button_Ok,height:150,width:550,Title:h.Title_Confirmation,Content:h.Message_Cancel_Confirmation,activeFlag:!1});return e.render(),e._dialog.buttons.Ok.disabled=!1,e},getCloseButton:function(t){var o=this,n=e.createElement("div",{class:"xsr-properties-close-button",id:"xsrCloseButton"}).inject(t);new l({allowUnsafeHTMLLabel:!1,id:"CloseButton",label:h.label_Button_Close,touchMode:!0,emphasize:"primary",onClick:function(e){o.closeRightPane.call(o)}}).inject(n);return n},closeRightPane:function(){this.destroy(),this._triptychManager.hideRightPanel()},addCheckBeforeClose:function(){this._triptychManager.addCheckBeforeClose(c.TRIPTYCH_SIDE_Right,this.cancelChanges.bind(this))},removeCheckandClose:function(){this._triptychManager.removeCheckBeforeClose(c.TRIPTYCH_SIDE_Right)},switchToSaveCancel:function(){this.addCheckBeforeClose(),this.publishDirtyFieldInfo(!0),this.applyCancelButtonsDiv.show(),this.closeButtonDiv.hide()},publishDirtyFieldInfo:function(e){e&&!this._propertiesPanel.hasClassName(c.PROPERTIES_FIELD_DIRTY)?this._propertiesPanel.addClassName(c.PROPERTIES_FIELD_DIRTY):this._propertiesPanel.hasClassName(c.PROPERTIES_FIELD_DIRTY)&&this._propertiesPanel.removeClassName(c.PROPERTIES_FIELD_DIRTY)},removeSubscriptions:function(){this.basicEvent&&this._basicModelEvents.unsubscribeList(this.basicEvent),this.specViewEvent&&this._specViewerModelEvents.unsubscribeList(this.specViewEvent),this.slideInContent.destroy(),this._propertiesPanel.empty()},destroy:function(){this.removeSubscriptions(),i.deactivateReportInfoIcon()}})});