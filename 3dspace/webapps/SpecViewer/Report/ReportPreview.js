define("DS/SpecViewer/Report/ReportPreview",["DS/Controls/Abstract","UWA/Core","DS/PDFjs/PDFjs","DS/Controls/Loader","DS/Controls/Button","DS/XSRCommonComponents/utils/DocumentServiceProvider","DS/SpecViewer/Report/TemplateProperties","DS/XSRCommonComponents/utils/Notification","DS/Controls/TooltipModel","UWA/Promise","DS/XSRCommonComponents/utils/Utils","DS/ResizeSensor/js/ResizeSensor","DS/XSRCommonComponents/service/XSpecsActionsFactory","DS/SpecViewer/Report/CreateSpecificationReport","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/RequestUtil","i18n!DS/SpecViewer/assets/nls/SpecViewer","css!DS/SpecViewer/Report/Report.css"],function(e,t,o,n,i,s,r,a,l,c,p,d,u,h,m,f,g){"use strict";var w,v=0,S=1;return e.extend({stopChecking:!1,loader:{},loaderDiv:{},init:function(e){this.loaderDiv=t.createElement("div",{class:"xsr-preview-loader"}),this.specModel=e.specModel,this.appCore=e.appCore,this.templateID=e.specModel.getTemplatePid(),this.specPid=e.specModel.getSpecReportPid(),this.target=e.target,this.itemPid=e.specModel.getID(),this.itemType=e.specModel.getTypeActualName(),this.itemDisplayType=e.specModel.getType(),this.itemTitle=e.specModel.getTitle(),this.itemMaturityState=e.specModel.getMaturityActualName(),this.num=S=1,this.scale=1.5,this.mode=e.mode,this.modelEvents=e.modelEvents,this.isReportGenerationStarted=!1,this.loadReportPreview()},resetCounter:function(){!0,v=0},stopCounter:function(){!0},widthManagement:function(){var e=this.target,t=e.getElementsByClassName("xsr-pdf-toolbar"),o=e.getElementsByClassName("xsr-pdf-canvas-wrapper"),n=e.offsetWidth;t&&t[0]&&o&&o[0]&&(n&&n<422?(t[0].setStyle("height","60px"),o[0].setStyle("height","calc(100% - 60px)")):(t[0].setStyle("height","30px"),o[0].setStyle("height","calc(100% - 30px)")))},attachResizer:function(){var e=this.target,t=this;new d(e,function(){t.widthManagement()})},loadReportPreview:function(e){this.target=this.target||e.target,this.loaderDiv.inject(this.target),this.loader=new n({text:""}).inject(this.loaderDiv),this.loader.on(""),this.attachResizer(),w=performance.now();var t=this,o={itemPid:this.itemPid},i=function e(){console.log("stop checking, ",t.stopChecking),v++;var n=t.specModel.hasAccessOnSpecReport("checkin");(new s).isPDFReportCheckedIn(o).then(function(o){console.log(o);var i="Failed"!==o.reportStatus&&"Succeeded"!==o.reportStatus,s="None"===o.reportStatus;return!o.isPDFAvailable&&s?(t.updateGenReportView("reportinfo",g.Message_NoSpeReport,n),void(t.isReportGenerationStarted=!1)):!o.isPDFAvailable||"Succeeded"!==o.reportStatus&&"None"!==o.reportStatus?"Failed"===o.reportStatus?(t.updateGenReportView("reporterror",g.Message_SpeReportGenFailed,n),void(t.isReportGenerationStarted=!1)):(i&&(t.loader.text=g.Message_SpecReportGenProcess,t.isReportGenerationStarted=!0),void(v>=50||t.stopChecking?(t.updateGenReportView("reportinfo",g.Message_SpecReportGenTime,n),t.isReportGenerationStarted=!1,t.endLoading()):setTimeout(e,1e3))):(t.loader.text=g.Message_loadingReport,t.isReportGenerationStarted=!1,void function(){t.checkoutPDFReport.call(t).then(function(e){t.renderPDF.call(t,e),t.widthManagement()}).catch(function(e){console.log(e),t.updateGenReportView("reporterror",g.Message_SpeReportLoadFailed,!0)})}.apply(t))}).catch(function(e){console.log(e),t.updateGenReportView("reporterror",g.Message_SpeReportLoadFailed,n)})},r=function(){if(t.specPid=t.specModel.getSpecReportPid(),t.specPid)i();else{var e=t.specModel.hasAccess("modify");t.updateApplyTemplateView(e)}};if("RegeneratePDF"===this.mode)if(t.specPid=t.specModel.getSpecReportPid(),t.specPid)this.generatePDFReport().then(function(){t.isReportGenerationStarted=!0,r.call(this)}).catch(function(e){t.isReportGenerationStarted=!1,console.warn(e.message),t.updateGenReportView("reporterror",g.Message_SpeReportGenFailed,!0)});else{var a=t.specModel.hasAccess("modify");t.updateApplyTemplateView(a)}else if(p.isOriginatedInGLS(t.specModel)){var l={itemPid:t.specModel.getUuid(),webservice:"downloadGLSPDFReport"};(new s).checkout(l).then(t.renderPDF.bind(t)).catch(function(e){console.log(e),t.updatePreviewMsg("reportinfo",g.Message_NoSpeReport)})}else r()},updatePreviewMsg:function(e,o){var n=this;if(n.endLoading(),n.stopChecking=!0,!p.isOriginatedInGLS(n.specModel)){var i=t.createElement("div",{class:"xsr-report-empty-toolbar"}).inject(n.target);i.setStyle("height","35px"),this.reportTemplate=t.createElement("div",{class:"xsr-pdf-toolbar-info wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-info"}).inject(i),this.reportTemplate.tooltipInfos=new l({shortHelp:g.TemplateInfo,allowUnsafeHTMLShortHelp:!1}),this.reportTemplate.addEventListener("click",function(){n.openTemplateInformation()})}this.msgDiv=t.createElement("div",{class:"xsr-report-preview-msg"}).inject(n.target);var s=t.createElement("div",{class:"xsr-report-preview-background-icon"}).inject(this.msgDiv),r=p.getIconUrl("I_Pdfbackground");s.setStyle("background",r),s.setStyle("background-size","contain"),s.setStyle("background-position","center"),s.setStyle("background-repeat","no-repeat"),e&&"reporterror"===e&&t.createElement("div",{class:"xsr-preview-msg-icon "+e+" wux-ui-3ds wux-ui-3ds-3x wux-ui-3ds-attention"}).inject(this.msgDiv),t.createElement("div",{class:"preview-msg",text:o}).inject(this.msgDiv)},updateApplyTemplateView:function(e){var o=this;if(o.updatePreviewMsg("reportinfo",g.Message_NoTemplate),e){var n=t.createElement("div",{class:"xsr-report-apply-template"}).inject(this.msgDiv),s=new i({label:g.SelectTemplate,emphasize:"primary"});s.inject(n),s.addEventListener("buttonclick",function(){(new h).loadCreateForm.call(o)})}},updateGenReportView:function(e,o,n){var s=this;s.updatePreviewMsg(e,o);var r=t.createElement("div",{class:"xsr-report-regen"}).inject(this.msgDiv);if(n){var a=new i({label:g.GenerateReleaseSnapshot,emphasize:"primary"});a.inject(r),a.addEventListener("buttonclick",function(){u.launchRegeneratePDF({data:s.specModel})})}},removePreviewMsg:function(){this.msgDiv.destroy()},createToolbar:function(e){var o=this,n=t.is(e.generatedTime)?p.formatDate(e.generatedTime,!0):"",i=!!t.is(e.isTemplateObsolete)&&e.isTemplateObsolete,s=t.createElement("div",{class:"xsr-pdf-toolbar"}).inject(this.target),r=t.createElement("div",{class:"xsr-pdf-toolbar-left"}).inject(s),a=t.createElement("div",{class:"xsr-pdf-toolbar-right"}).inject(s),c="RELEASED"===this.itemMaturityState.toUpperCase()||"RELEASE"===this.itemMaturityState.toUpperCase()||"OBSOLETE"===this.itemMaturityState.toUpperCase();i&&!c&&(t.createElement("div",{class:"xsr-pdf-toolbar-obsolete-icon wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention"}).inject(r).tooltipInfos=new l({shortHelp:g.ErrorMessage_obsoleteTemplate,allowUnsafeHTMLShortHelp:!1}));var d=g.label_ReportDate+" "+n;t.createElement("div",{class:"xsr-pdf-toolbar-contents",text:d}).inject(r).tooltipInfos=new l({shortHelp:d,allowUnsafeHTMLShortHelp:!1});var h,m=t.createElement("div",{class:"xsr-pdf-toolbar-buttons"}).inject(a);p.isOriginatedInGLS(this.specModel)||(this.reportTemplate=t.createElement("div",{class:"xsr-pdf-toolbar-contents wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-info"}).inject(m),this.reportTemplate.tooltipInfos=new l({shortHelp:g.TemplateInfo,allowUnsafeHTMLShortHelp:!1}),this.reportTemplate.addEventListener("click",function(){o.openTemplateInformation()}),this.specModel.hasAccessOnSpecReport("checkin")&&(this.regenerateReport=t.createElement("div",{class:"xsr-pdf-toolbar-contents wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-redo"}).inject(m),this.regenerateReport.tooltipInfos=new l({shortHelp:g.label_RegeneratePDF,allowUnsafeHTMLShortHelp:!1}),this.regenerateReport.addEventListener("click",function(){u.launchRegeneratePDF({data:o.specModel})})),f.isSafarionIPadorPod()?(h=t.createElement("div",{class:"xsr-pdf-toolbar-contents wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-legend-eye"}).inject(m)).tooltipInfos=new l({shortHelp:g.label_PereviewPDF,allowUnsafeHTMLShortHelp:!1}):(h=t.createElement("div",{class:"xsr-pdf-toolbar-contents wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-download"}).inject(m)).tooltipInfos=new l({shortHelp:g.label_DownloadPDF,allowUnsafeHTMLShortHelp:!1}),h.addEventListener("click",this.downloadPDFReport.bind(this)));var w=t.createElement("div",{class:"xsr-pdf-toolbar-contents wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-zoom-in"}).inject(m);w.tooltipInfos=new l({shortHelp:g.tooltip_ZoomIn,allowUnsafeHTMLShortHelp:!1}),w.addEventListener("click",function(e){4!==o.scale&&(o.canvasContainer.empty(),S=1,o.scale+=.25,o.renderPage(S))});var v=t.createElement("div",{class:"xsr-pdf-toolbar-contents wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-zoom-out"}).inject(m);v.tooltipInfos=new l({shortHelp:g.tooltip_Zoomout,allowUnsafeHTMLShortHelp:!1}),v.addEventListener("click",function(e){.25!==o.scale&&(o.canvasContainer.empty(),S=1,o.scale-=.25,o.renderPage(S))}),f.BrowserEnum.SAFARI!==f.detectBrowser()&&this.createFullScreenButton(m)},openTemplateInformation:function(){p.activateReportInfoIcon(),this.appCore.triptychManager.setLaunchFromIcon(!1),this.appCore.triptychManager.isRightPanelOpen()?(p.deactivateInfoIcon(),this.templateProp?this.templateProp.destroy():this.appCore.specRightContainer.firstChild&&this.appCore.specRightContainer.firstChild.id&&"template-info-slide-in-panel"==this.appCore.specRightContainer.firstChild.id?(this.appCore.specRightContainer.empty(),p.deactivateReportInfoIcon(),this.appCore.triptychManager.hideRightPanel()):(this.appCore.specRightContainer.empty(),this.appCore.triptychManager.setCommandId("ReportTemplateInfo"),this.templateProp=new r({specModel:this.specModel,appCore:this.appCore}).render())):(this.appCore.triptychManager.setCommandId("ReportTemplateInfo"),this.appCore.triptychManager.showRightPanel(),this.templateProp=new r({specModel:this.specModel,appCore:this.appCore}).render())},renderPDF:function(e){var n=e.blob;this.createToolbar(e);var i=this;i.endLoading();var s=window.URL.createObjectURL(n);o.disableWorker=!0;var r=t.createElement("div",{class:"xsr-pdf-canvas-wrapper"}).inject(i.target);i.canvasContainer=t.createElement("div",{class:"xsr-pdf-preview-container"}).inject(r),i.num=S,i.scale=1.5,o.getDocument(s).then(function(e){i.pdfDoc=e,i.renderPage();var t=performance.now();console.log("Time taken: "+(t-w)/1e3)})},renderPage:function(e){var o=this.pdfDoc;!0;var n=e||this.num;this.canvas=t.createElement("canvas",{class:"xsr-pdf-page page"+n}).inject(this.canvasContainer),this.canvasContext=this.canvas.getContext("2d"),o.getPage(n).then(this.drawPage.bind(this))},drawPage:function(e){var t=this,o=this.pdfDoc,n=this.canvas,i=e.getViewport(this.scale),s={canvasContext:this.canvasContext,viewport:i};n.height=i.height,n.width=i.width,e.render(s).then(function(){!1,S<o.numPages&&(S++,t.renderPage(S))})},generatePDFReport:function(){var e=new s,t={specReportPid:this.specPid};return e.generatePDFReport(t)},downloadPDFReport:function(){var e=new s,t={itemPid:this.itemPid};e.downloadPDFReport(t)},mailPDFReport:function(){var e=new s,t={itemPid:this.itemPid};e.mailPDFReport(t)},checkoutPDFReport:function(){var e=new s,t={itemPid:this.itemPid};return e.checkout(t)},displayMessage:function(e,t){a.displayNotification({eventID:t||"info",msg:e})},endLoading:function(){v=-1,this.loader.off(""),this.loaderDiv.destroy()},destroy:function(){this.isReportGenerationStarted,v=0,!0,!1,this.stopChecking=!0,p.deactivateReportInfoIcon(),this.target.empty()},createFullScreenButton:function(e){var o=function(){return!(void 0!==document.fullScreenElement&&null===document.fullScreenElement||void 0!==document.msFullscreenElement&&null===document.msFullscreenElement||void 0!==document.mozFullScreen&&!document.mozFullScreen||void 0!==document.webkitIsFullScreen&&!document.webkitIsFullScreen)},n=this,i=t.createElement("div",{class:"xsr-pdf-toolbar-contents wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-resize-fullscreen"}).inject(e);i.tooltipInfos=new l({shortHelp:g.tooltip_FullScreen,allowUnsafeHTMLShortHelp:!1});var s=document.getElementById("spec_page");i.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),o()?(console.log("fullscreen"),function(){n.closeFullscreen(s)}.call(i)):(console.log("not fullscreen"),function(){n.openFullscreen(s)}.call(i))});var r=function(e){e.preventDefault(),e.stopPropagation(),o()?(console.log("fullscreen"),i.removeClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-resize-fullscreen"),i.addClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-resize-fullscreen-off"),i.tooltipInfos=new l({shortHelp:g.tooltip_ExitFullScreen,allowUnsafeHTMLShortHelp:!1}),n.isFullScreenMode=!1,n.regenerateReport.setStyle("display","none"),n.reportTemplate.setStyle("display","none")):(console.log("not fullscreen"),i.removeClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-resize-fullscreen-off"),i.addClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-resize-fullscreen"),i.tooltipInfos=new l({shortHelp:g.tooltip_FullScreen,allowUnsafeHTMLShortHelp:!1}),n.isFullScreenMode=!0,n.regenerateReport.setStyle("display","inline-flex"),n.reportTemplate.setStyle("display","inline-flex"))};document.addEventListener("fullscreenchange",r.bind(this)),document.addEventListener("webkitfullscreenchange",r.bind(this)),document.addEventListener("mozfullscreenchange",r.bind(this)),document.addEventListener("msfullscreenchange",r.bind(this)),document.addEventListener("MSFullscreenChange",r.bind(this))},openFullscreen:function(e){e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):e.msRequestFullscreen&&e.msRequestFullscreen()},closeFullscreen:function(e){document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},checkReportStatus:function(){return this.isReportGenerationStarted}})});