define("DS/SpecViewer/BOM/controller/ReplaceByController",["UWA/Controls/Abstract","DS/SpecViewer/BOM/service/EngineeringServiceWrapper","DS/XSRCommonComponents/utils/TypeUtils","DS/SpecViewer/BOM/ContQty/service/ContQtyServiceProvider","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/SpecGridView/utils/GridUtil","DS/XSRCommonComponents/utils/Constants","i18n!DS/SpecViewer/assets/nls/SpecViewer"],function(e,t,i,n,o,r,s,a){return e.extend({init:function(e){this.bomContext=e.bomContext,this.appCore=e.appCore,this.currentTabKey=e.currentTabKey,this.bomGrid=e.bomGrid,this.container=e.container,this.specModel=e.specModel,this.modelEvents=e.modelEvents;var i={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container,parentNodeModel:this.specModel};this.service=new t(i),this.CQProvider=new n,this.itemserviceprovider=new o},createNodeFromId(e){let t=this;var i=t.bomGrid.getTreeDocument().getSelectedNodes();if(e)return t.service.getEngItemNode([e],i)},postReplaceByAction(e){let t=this;t.itemModelMapping=t.bomGrid.gridTreeDocument.itemModelMapping;var n=t.bomGrid.getTreeDocument().getSelectedNodes();let o=widget.getValue(s.PERSISTENCY_BOM_VIEW),r=n.length;for(let s=0;s<r;s++){let r,a,d=[],l=n[s],p=l.getParent(),c=[],u=!1;l._canBeGrouped()&&d.push(...l.getAttributeValue("instanceIds"));let g=new Map;if(o||null==o){if(i.isPhyProd(l.getAttributeValue("ds6w:type"))){for(let t=0;t<d.length;t++)if(e.has(d[t])){const i=e.get(d[t]).old,n=e.get(d[t]).instance,o=e.get(d[t]).reference,r=e.get(d[t]).parent;g.has(o)||g.set(o,{instances:[],olds:[],parent:r}),g.get(o).instances.push(n),g.get(o).olds.push(i),c.push(i)}for(const[i,o]of g.entries()){let s=l.isRoot(),h=[],m=!1,f=!1,C=!1;const I=Array.from(g)[g.size-1][0];if(i===I&&(C=!0),r=i,a=o.instances,(h=s?t.bomGrid.getGridNodes().filter(e=>e.getID()==i):p.getChildren().filter(e=>e.getID()==i)).length>0&&(f=!0,m=n.includes(h[0]))){h[0].getAttributeValue("instanceIds").forEach(function(t){null!=e.get(t)&&f&&(f=!1)})}if(d.length===c.length){u=!0;let e=[];if(f)t.updateNodeOptions(l,h,a,c.length,s,d.length,C);else{let i={};i.references=[r],i.with_partials=!0,e.push(t.createNodeFromId(r)),e.push(t.service.fetchAlternateInfo([r])),e.push(t.itemserviceprovider.fetchCoreMatDetails(i)),t.resolveReplacePromises(e,l,a,u,s,p)}}else if(c.length<d.length){u=!1;let e=[];if(f){t.updateNodeOptions(l,h,a,c.length,s,d.length,C);const e=d.filter(function(e){return!c.includes(e)});i===I&&t.updateNodeWithRemainInstance(l,e)}else{let n={};n.references=[r],n.with_partials=!0,e.push(t.createNodeFromId(r)),e.push(t.service.fetchAlternateInfo([r])),e.push(t.itemserviceprovider.fetchCoreMatDetails(n)),t.resolveReplacePromises(e,l,a,u,s,p);const o=d.filter(function(e){return!c.includes(e)});i===I&&t.updateNodeWithRemainInstance(l,o)}}}}else if(i.isRawMaterial(l.getAttributeValue("ds6w:type"))){let i=l.getInstanceId();if(e.has(i)){u=!0;let n=l.isRoot();const o=e.get(i).instance,r=e.get(i).reference;let s={};s.references=[r],s.with_partials=!0;let a=[];a.push(t.createNodeFromId(r)),a.push(t.service.fetchAlternateInfo([r])),a.push(t.itemserviceprovider.fetchCoreMatDetails(s)),t.resolveReplacePromises(a,l,o,u,n,p)}}}else if(!o){let i=l.getInstanceId(),n=l.isRoot();if(e.has(i)){u=!0;const o=e.get(i).instance,r=e.get(i).reference;let s=[],a={};a.references=[r],a.with_partials=!0,s.push(t.createNodeFromId(r)),s.push(t.service.fetchAlternateInfo([r])),s.push(t.itemserviceprovider.fetchCoreMatDetails(a)),t.resolveReplacePromises(s,l,o,u,n,p)}}}},resolveReplacePromises(e,t,i,n,o,r){let s=this;i=Array.isArray(i)?i:[i],Promise.allSettled(e).then(e=>{e.forEach((d,l)=>{let p=e[0].value[0];if(0===l)s.setBasicAttributes(t,p,i,n,o,r);else if(1===l)jQuery.isEmptyObject(d.value.AlternateItemInfo)||(p.options.grid.Alternate="Yes",p.options.grid["ds6w:alternate"]=a.label_yes);else if(2===l&&null!=d.value)for(const[e,t]of d.value.entries()){let e=t.physicalid,i=t.V_Name?t.V_Name:"",n=t.revision?t.revision:"-";p.options.grid.coreMaterial=i+" "+n,p.options.grid.coreMaterialId=e}})})},setBasicAttributes(e,t,n,o,r,s){let a=this,d=e.getParentId(),l=e.parentNode;if(i.isPhyProd(e.getAttributeValue("ds6w:type")))t.options.grid.quantity=n.length,t.options.grid.instanceCount=n.length,t.setInstanceId(n[0]),t.options.grid.instanceIds=n,t.setInstanceTitle(e.options.grid.instanceTitle),t.setInstanceName(e.options.grid.instanceName),t.setParentId(d),t.setParentNode(l),t.parentNodeModel=e.parentNodeModel,t.options.grid.instanceId=n[0],t.options.grid.relationid=n[0],t.options.instanceId=n[0],t.options.relationid=n[0],a.addOrRemoveNodes(e,t,r,s,o);else if(i.isRawMaterial(e.getAttributeValue("ds6w:type"))){t.setInstanceId(n[0]),t.setParentId(d),t.setParentNode(l),t.parentNodeModel=e.parentNodeModel,t.options.grid.instanceCount=n.length,t.options.grid.instanceIds=n,t.options.grid.quantity=e.options.grid.quantity,t.options.grid.dimensionType=e.options.grid.dimensionType,t.options.grid.dimensionTypeNLS=e.options.grid.dimensionTypeNLS,t.options.grid.unit=e.options.grid.unit,t.options.grid.unitNLS=e.options.grid.unitNLS,t.setInstanceTitle(e.options.grid.instanceTitle),t.setInstanceName(e.options.grid.instanceName),t.options.grid.asRequired=e.options.grid.asRequired,t.options.grid.CQInstance=e.options.grid.CQInstance,t.options.grid.instanceId=n[0],t.options.grid.relationid=n[0],t.options.instanceId=n[0],t.options.relationid=n[0];let i={asRequired:e.options.grid.asRequired,quantity:e.options.grid.quantity,quantityUOM:e.options.grid.unit};a.CQProvider.updateContQtyData(i,t),a.addOrRemoveNodes(e,t,r,s,o)}},addOrRemoveNodes(e,t,i,n,o){let s=this;if(i)t.setAttribute("level",1),1==s.bomGrid.getGridNodeCount()&&(t.setCurrentPath(t),s.bomGrid.addRootNodes(t,!1),s._postAddUpdate(t),o?s.bomContext._removeNodes(e):e.setCurrentPath(e)),o?s.bomContext._removeNodes(e):e.setCurrentPath(e),t.setCurrentPath(t),s.bomGrid.addRootNodes(t,!1),s._postAddUpdate(t);else{let i=s.bomGrid.getTreeDocument();i.prepareUpdate(),o?n.removeChild(e):e.setCurrentPath(e),t.setAttribute("level",n.getAttributeValue("level")+1),n.addChild(t),t.setCurrentPath(t),i.pushUpdate(),i.acceptChanges(),s.bomGrid.gridTreeDocument.itemModelMapping=(new r).replaceItemModelMapping(s.bomGrid.gridTreeDocument.itemModelMapping,e,t,o)}},updateNodeOptions(e,t,i,n,o,r,s){let a=this,d=t[0].getParentInstanceIds().concat(i),l=t[0].getQuantity()+i.length;if(a.bomContext.canTriggerQuantityUpdateService=!1,t[0].updateOptions({grid:{quantity:l,instanceIds:d,instanceCount:d.length,relationid:d[0],instanceId:d[0]}}),t[0].setCurrentPath(t[0]),e.options.relationid=i[0],e.options.instanceId=i[0],a.bomContext.canTriggerQuantityUpdateService=!0,o&&s&&r===n)a.bomContext._removeNodes(e);else if(!o&&s&&r===n){let t=a.bomGrid.getTreeDocument();t.prepareUpdate(),e.getParent().removeChild(e),t.pushUpdate(),t.acceptChanges()}s||e.setCurrentPath(e)},updateNodeWithRemainInstance(e,t){this.bomContext.canTriggerQuantityUpdateService=!1,e.updateOptions({grid:{quantity:t.length,instanceId:t[0],relationid:t[0],instanceIds:t,instanceCount:t.length}}),e.options.relationid=t[0],e.options.instanceId=t[0],e.setCurrentPath(e);let i=(new r).updateItemModelMapping(this.bomGrid.gridTreeDocument.itemModelMapping,e);this.bomContext.bomGrid.gridTreeDocument.itemModelMapping=i,this.bomContext.canTriggerQuantityUpdateService=!0},_postAddUpdate(e){this.bomGrid.getTreeDocument().acceptChanges(),this.bomContext.updateParentforChangeInfo(),this.bomGrid.updateGroupByIfAny(),this.bomGrid.updateItemsOnTagger(e)}})});