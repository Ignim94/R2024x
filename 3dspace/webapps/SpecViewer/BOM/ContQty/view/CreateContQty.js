define("DS/SpecViewer/BOM/ContQty/view/CreateContQty",["UWA/Core","UWA/Controls/Abstract","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/DataGridView/DataGridView","DS/Windows/ImmersiveFrame","DS/Windows/Panel","DS/Controls/Tab","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/TypeUtils","DS/SpecViewer/BOM/ContQty/service/ContQtyServiceProvider","DS/Controls/LineEditor","DS/Controls/ComboBox","DS/Controls/Toggle","text!DS/SpecViewer/assets/CQConfig/ContQtyColumnConfig.json","i18n!DS/SpecViewer/assets/nls/ContQty"],function(t,e,i,n,o,r,d,a,s,l,u,g,c,p,h,m,f,y){"use strict";return e.extend({target:null,options:null,dialog:null,dataGridView:null,init:function(t){this._parent(t),this.basicModelEvents=t.appCore.basicModelEvents,this.target=t.appCore.specMainContainer,this.createCloseAction=t.createCloseAction,this.parentId=t.parentId,this.parentTitle=t.parentTitle,this.CQService=new c},loadFields:function(t){this.container=widget.body,l.maskLoader(this.container);var e=t;this.initDetailedView(e)},initDetailedView:function(e){var i=this;this.inputData=[];var n=this.options;n.Title=y.label_AddProd+" | "+this.parentTitle,n.width=800,n.height=250,n.renderTo=this.target,n.Content=this.getUIContainer(e),n.OKLabel=y.label_Button_Add,n.RemoveApplyButton=!0,l.unmaskLoader(this.getUIContainer(e)),this.dialog=new s(n),this.dialog.destroyPrevDialog(),this.dialog.render(),this.isOnlyPhysicalProducts(e)?this.dialog._dialog.buttons.Ok.disabled=!1:this.dialog._dialog.buttons.Ok.disabled=!0,l.unmaskLoader(this.container);this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_OK",function(){i.dialog._dialog.buttons.Ok.disabled=!0;for(var e=function(){var t=i.dataGridView,e=[];return t.getTreeDocument().getChildren().forEach(function(t){var i={},n=t.options.grid.quantity;if(n>0&&"EA"===t.options.grid.unit)for(var o=0;o<n;o++)i.unit=t.options.grid.unit?t.options.grid.unit:"",i.parentId=t.options.grid.parentId,i.rawMatID=t.options.grid.id,e.push(i);else i.unit=t.options.grid.unit?t.options.grid.unit:"",i.asRequired=t.options.grid.as_required,i.quantity=t.options.grid.quantity?t.options.grid.quantity.toString():"",i.rawMatID=t.options.grid.id,i.parentId=t.options.grid.parentId,e.push(i)}),e}(),n=[],o=0;o<e.length;o++){var s=e[o].parentId,l={};if("EA"===e[o].unit?l.childId=e[o].rawMatID:(l.childId=e[o].rawMatID,l.quantity=e[o].quantity,l.quantityUOM=e[o].unit,l.asRequired=e[o].asRequired),l&&"EA"===e[o].unit||!l.asRequired&&"EA"!==e[o].unit&&l.quantity&&l.quantityUOM||l.asRequired){var g=i.CQService.addContQty(l,s);n.push(g)}else u.displayNotification({eventID:"error",msg:y.ContQtyMand})}Promise.allSettled(n).then(function(e){if(e&&e.length>0){for(var n=[],s=0;s<e.length;s++)"fulfilled"===e[s].status?n.push(e[s].value):"rejected"===e[s].status&&u.displayNotification({eventID:"error",msg:e[s].reason?e[s].reason.message.trim()===y.Continous_Qunat_Template_Error?y.Continous_No_Access:e[s].reason.message:y.Error_AddCQ});if(i.fetchCQInfo(n),i._closeDialog(),0!==n.length){var l=new t.createElement("div",{class:"xsr-Success-report"}),g=new t.createElement("ul",{}),c=0;const e=new Map;for(o=0;o<n.length;o++){let t=n[o].instanceDetails.childId;if(e.has(t))e.get(t).set("count",e.get(t).get("count")+1);else{const i=new Map;i.set("parentName",n[o].instanceDetails.child.title),i.set("count",1),e.set(t,i)}}for(const[n,o]of e.entries()){const e=o.get("count"),n=o.get("parentName");1==e&&t.createElement("li",{text:y.replace(y.get("ContQty_Success"),{numberOfInstances:e,childItem:n,parentItem:i.parentTitle})}).inject(g),e>=2&&t.createElement("li",{text:y.replace(y.get("ContQty_Multi_Success"),{numberOfInstances:e,childItem:n,parentItem:i.parentTitle})}).inject(g),c++}g.inject(l);var p=new a({displayStyle:"strip"});p.add({label:"Success ("+c+")",isSelected:!0,content:l});var h=new t.createElement("div",{id:"container"});h.inject(i.options.renderTo);var m=new t.Element("div",{class:"xsr-dialog-immersiveframe"}).inject(h),f=new r;f.inject(m);new d({immersiveFrame:f,title:"Insert Existing Report",content:p,position:{my:"center",at:"center",of:f},width:600})}}}).catch(function(t){u.displayNotification({eventID:"error",msg:t?t.message:y.Error_AddCQ}),i._closeDialog()})})},_closeDialog:function(){var t=this.dialogContainer?this.dialogContainer:this.target;l.unmaskLoader(t),this.dialog.closeDialog()},fetchCQInfo:function(t){this.createCloseAction&&this.createCloseAction(t)},getUIContainer:function(e){for(var r=this,d=new i,a=[],s=0;s<e.length;s++){var l={Title:e[s].Title,quantity:e[s].DimensionType?void 0:1,unitNLS:e[s].DimensionType?void 0:y.EA,unit:e[s].DimensionType?void 0:"EA",as_required:!1,type:e[s].Type,id:e[s].id,parentId:e[s].parentId,"ds6wg:revision":e[s].revision,"ds6w:status":e[s].maturityNLS,dimension:e[s].DimensionType};a.push(l)}d.prepareUpdate(),a.forEach(function(t){var e=new n({label:t.Text,grid:t});d.addRoot(e)}),d.pushUpdate();var c=t.createElement("div",{class:"xsr-continousQty-container"}),v=t.createElement("div",{class:"xsr-continousQty-mandDiv"}).inject(c,"top");t.Element("span",{class:"xsr-mandatory-flag-title",text:"* "}).inject(v),t.createElement("span",{text:y.ContQtyMandLabel}).inject(v);var w=t.createElement("div",{class:"xsr-contQty-grid"}),C=[],D=new Map;e.forEach(function(t){t.Dimensions&&t.Dimensions.forEach(function(t){C.push(t.nlsLabel),D.set(t.nlsLabel,t.dbName)})});var E=JSON.parse(f).columns,b=this.getNLSLabels(E);b&&b.forEach(function(e){e.text=e.text,"uomupdated"===e.dataIndex&&(e.getCellValue=function(e){var i=e.nodeModel,n=t.createElement("div",{class:"uom-container","data-cellInfos":e}),o=!0,r=[],d=new Map;if(i&&"EA"===i.options.grid.unit)o=!1,r.push(i.options.grid.unitNLS);else{var a=Object.entries(g.getUOMUnits(i.options.grid.dimension));a&&a.forEach(function(t){r.push(t[1]),d.set(t[1],t[0])})}var s=i.options.grid.quantity,l=i.options.grid.unitNLS,u=i.options.grid.as_required,c=-1;null!=l&&(c=r.indexOf(l));var f=t.createElement("div").inject(n),v=new m({label:y.label_As_Required,type:"switch",checkFlag:u});v.getContent().addClassName("xsr-grid-wux-inline"),v.addEventListener("buttonclick",function(t){var e=t.dsModel.checkFlag;i.updateOptions({grid:{as_required:e}})});var w=o?"([0-9]*[.])?[0-9]+":"[0-9]+",C=new p({placeholder:y.placeholder_Quantity,value:s,pattern:w}).inject(f),D=new h({elementsList:r,selectedIndex:c,placeholder:y.placeholder_UOM}).inject(f);return g.isPhyProd(i.options.grid.type)?(C.getContent().addClassName("xsr-grid-lineeditor-full"),D.getContent().addClassName("xsr-grid-combobox-product"),D.disabled=!0):(v.inject(f),C.getContent().addClassName("xsr-grid-lineeditor"),D.getContent().addClassName("xsr-grid-combobox")),C.addEventListener("change",function(t){let e=""===t.dsModel.value?"":parseFloat(t.dsModel.value);i.updateOptions({grid:{quantity:e}})}),g.isPhyProd(i.options.grid.type)||D.addEventListener("change",function(t){let e=t.dsModel.value;null!=e&&i.updateOptions({grid:{unit:d.get(e),unitNLS:e}})}),o||g.isPhyProd(i.options.grid.type)||(D.disabled=!0,v.disabled=!0),n}),"as_required"===e.dataIndex&&(e.getCellSemantics=function(t){if("EA"===t.nodeModel.options.grid.unit)return{visibleFlag:!1}})}),r.dataGridView=new o({treeDocument:d,columns:b,showModelChangesFlag:!0,showTreeIconsFlag:!0,showRowBorderFlag:!0,showNodeKPIColorFlag:d.isColorized,cellSelection:"multiple",rowSelection:"none"});var M=[],I=!1;this.dataGridView.getTreeDocument().onNodeModelUpdate(function(t,e){if(t.data.attributes){var i=t.data.attributes;if(i.hasOwnProperty("quantity")||i.hasOwnProperty("as_required")||i.hasOwnProperty("unitNLS")){var n={};if(n.rowID=this._rowID,n.nodeModel=this,n.nodeModel.options.grid.quantity<=0||"EA"===n.nodeModel.options.grid.unit&&!Number.isInteger(n.nodeModel.options.grid.quantity))return r.dataGridView.getTreeDocument().getChildren().forEach(function(t){t.options.grid.id!==n.nodeModel.options.grid.id||(t.options.grid=n.nodeModel.options.grid)}),"EA"!==n.nodeModel.options.grid.unit&&""!==n.nodeModel.options.grid.quantity?u.displayNotification({eventID:"error",msg:y.QtyNegativeErrMsg}):M[n.rowID]||(M[n.rowID]=1),r.dataGridView.getTreeDocument().getChildren().forEach(function(t){""!=t.options.grid.quantity||(I=!0)}),!I&&M.length>0?r.dialog._dialog.buttons.Ok.disabled=!1:r.dialog._dialog.buttons.Ok.disabled=!0,void r.dataGridView.getTreeDocument().getChildren().forEach(function(t){t.options.grid.id!==n.nodeModel.options.grid.id||("EA"!==t.options.grid.unit||M[n.rowID]?""!=t.options.grid.quantity&&(t.options.grid.quantity=M[n.rowID]):t.options.grid.quantity=1)});n&&r.dataGridView.getTreeDocument().getChildren().forEach(function(t){t.options.grid.id!==n.nodeModel.options.grid.id||(t.options.grid=n.nodeModel.options.grid)}),I=!1,r.dataGridView.getTreeDocument().getChildren().forEach(function(t){"EA"===t.options.grid.unit||!1!==t.options.grid.as_required||t.options.grid.quantity&&t.options.grid.unit?(t.options.grid.quantity&&!t.options.grid.unit||!t.options.grid.quantity&&t.options.grid.unit)&&(I=!0):I=!0}),r.dialog._dialog.buttons.Ok.disabled=!!I,r.dataGridView.getTreeDocument().getChildren().forEach(function(t){t.options.grid.id!==n.nodeModel.options.grid.id||(M[n.rowID]=t.options.grid.quantity)})}}}),r.dataGridView.addEventListener("change",function(t,e){if(!e||e.nodeModel.options.grid.quantity<=0||"EA"===e.nodeModel.options.grid.unit&&!Number.isInteger(e.nodeModel.options.grid.quantity))return r.dataGridView.getTreeDocument().getChildren().forEach(function(t){e&&t.options.grid.id===e.nodeModel.options.grid.id&&(t.options.grid=e.nodeModel.options.grid)}),e&&"EA"!==e.nodeModel.options.grid.unit?u.displayNotification({eventID:"error",msg:y.QtyNegativeErrMsg}):(M[e.rowID]||(M[e.rowID]=1),u.displayNotification({eventID:"error",msg:y.QuantityErr})),!I&&M.length>0?r.dialog._dialog.buttons.Ok.disabled=!1:r.dialog._dialog.buttons.Ok.disabled=!0,void r.dataGridView.getTreeDocument().getChildren().forEach(function(t){e&&t.options.grid.id===e.nodeModel.options.grid.id&&("EA"!==t.options.grid.unit||M[e.rowID]?t.options.grid.quantity=M[e.rowID]:t.options.grid.quantity=1)});r.dataGridView.getTreeDocument().getChildren().forEach(function(t){t.options.grid.id!==e.nodeModel.options.grid.id||(t.options.grid=e.nodeModel.options.grid)}),I=!1,r.dataGridView.getTreeDocument().getChildren().forEach(function(t){"EA"===t.options.grid.unit||!1!==t.options.grid.as_required||t.options.grid.quantity&&t.options.grid.unit?(t.options.grid.quantity&&!t.options.grid.unit||!t.options.grid.quantity&&t.options.grid.unit)&&(I=!0):I=!0}),r.dialog._dialog.buttons.Ok.disabled=!!I,r.dataGridView.getTreeDocument().getChildren().forEach(function(t){t.options.grid.id!==e.nodeModel.options.grid.id||(M[e.rowID]=t.options.grid.quantity)})});var S=r.dataGridView.getTypeRepresentationFactory();S.registerTypeTemplates(JSON.stringify({UWAObjectTemplate:{path:"DS/SpecGridView/utils/UWAObjectTemplate",options:{}}}));return S.registerTypeRepresentations(JSON.stringify({UWAObject:{stdTemplate:"UWAObjectTemplate"}})),r.dataGridView.inject(w),w.inject(c),c},isOnlyPhysicalProducts:function(t){for(var e=0;e<t.length;e++)if(t[e].DimensionType)return!1;return!0},getNLSLabels:function(t){var e=t;if(e){var i=function(t){for(var e=0;e<t.length;e++)t[e].text=t[e].text&&y[t[e].text]?y[t[e].text]:t[e].text,t[e].subMenu&&i(t[e].subMenu)};i(e)}return e}})});