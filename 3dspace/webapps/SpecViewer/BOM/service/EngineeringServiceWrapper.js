define("DS/SpecViewer/BOM/service/EngineeringServiceWrapper",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/SpecViewer/BOM/model/EngineeringItemModel","DS/ENOMadeFromUX/service/MBMFServiceProvider","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/XSRCommonComponents/utils/ResponseParser","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/TypeUtils","i18n!DS/SpecViewer/assets/nls/SpecViewer"],function(e,t,n,r,s,o,i,a,c,u,d){"use strict";return n.extend({init:function(e){e&&(this.currentTabKey=e.currentTabKey,this.appCore=e.appCore,this.myModelConatiner=e.modelContainer,this.parentNodeModel=e.parentNodeModel)},_processExpandResponse:function(e,t,n){if(e&&(!Array.isArray(e)||0===e.length))return t([]);this.getListNodesFromServerExpand(e).then(function(e){return t(e)}).catch(function(e){n(e)})},getListNodesFromServerExpand:function(e){var n=this;return new t(function(t,r){var o=i.parseAndBuildIRPCStructure(e,["ds6w:type","ds6w:status"]);n.resolveMissingNls(o.nlsTracker).then(function(r){if(!o.root)return t([]);var a=[];for(var c in o.nodes)if(o.nodes[c].children&&o.nodes[c].children.length>0){var u=o.nodes[c].physicalid;o.nodes[c].children.forEach(function(e){e.parentId=u,a.push(e)})}var d=n.createListNodes(a,n.expandListNodeOptionsMapper.bind(n,r[0]));let l=[];d.forEach(function(e){l.push(e.getID()),(async()=>{let t=await(new s).getReferenceMap(e.options.grid.physicalId);void 0!==t&&t.success&&Object.keys(t.result.MadeFromConnections).forEach(n=>{t.result.MadeFromConnections[n]&&t.result.MadeFromConnections[n].forEach(t=>{t&&e.setreferenceArrayList(t)})})})()}),n.fetchAlternateInfo(l).then(function(r){if("success"===r.status)return n._setAlternateInfo(d,r.AlternateItemInfo),i.cleanExpandParsedData(o),e=void 0,d.sort((e,t)=>e.options.treeOrder>t.options.treeOrder?1:-1),t(d)}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})})},_setAlternateInfo:function(e,t){for(var n in t){let r=t[n];e.forEach(function(e){e.getID()===n&&(r&&(e.setAlternate("Yes"),e.setDisplayAlternate(d.label_yes)),e.updateOptions(e.options))})}},updateAlternateInfo:function(e){var t=this;let n=[];e.forEach(function(e){n.push(e.getID())}),n.length>0&&t.fetchAlternateInfo(n).then(function(n){"success"===n.status?t._setAlternateInfo(e,n.AlternateItemInfo):console.log("getAlternateItemInfo service failed"+n.status)}).catch(function(e){console.log(e)})},createListNodes:function(t,n){var r=[],s=this;return t.forEach(function(t){var o=s.createListNode(t,n);e.is(o)&&r.push(o)}),r},createListNode:function(e,t){var n=this._optionsRetrievor(e,t);return this.createGridModel(n)},createGridModel:function(e){var t=!u.isFormulatedProduct(e["ds6w:type_value"]),n=new r({shouldDisplayChildren:t}).set(e);return n.currentTabKey=this.currentTabKey,n.appCore=this.appCore,n.onContainer=this.myModelConatiner,this.selNodes&&this.selNodes.length>0&&this._isMultiLevel?n.parentNodeModel=this.selNodes[0]:n.parentNodeModel=this.parentNodeModel,n},_optionsRetrievor:function(t,n){return n&&"function"===e.typeOf(n)?n(t):t},expandListNodeOptionsMapper:function(e,t){var n=this.genericEngItemOptionsMapper(e,t.instanceOf);return n.instanceId=t.physicalid,n.parentId=t.parentId,n.treeOrder=t["ro.plminstance.V_treeorder"],n.instanceName="VPMRepInstance"!==t.type?t["ds6w:label"]||t["ro.PLMInstance.PLM_ExternalID"]:"",n.instanceType=t.type,n},genericEngItemOptionsMapper:function(e,t){return t["ds6w:created"]=c.getformatedDate(t["ds6w:created"]),t["ds6w:modified"]=c.getformatedDate(t["ds6w:modified"]),e&&(t["ds6w:type"]=e["ds6w:type"][t["ds6w:type_value"]],t["ds6w:status"]=e["ds6w:status"][t["ds6w:status_value"]]),t},resolveMissingNls:function(e){if(!Array.isArray(e.classes)||!e.properties)throw new Error("Ouups ! invalid input");var n=[];return n.push(c.getNlsOfPropertiesValues(e.properties)),t.all(n)},fetchAlternateInfo:function(e){if(!Array.isArray(e))throw new Error("fetchData need an array as input");var n={referenceIds:e};return new t(function(e,t){(new o).getAlternateInfo(n).then(function(t){e(t)}).catch(function(e){return t(e)})})},getNlsedListNodes:function(e){var n=this;return new t(function(t,r){if(!Array.isArray(e))return r(new Error(" inputs error"));var s=[],o={withNlsProp:["ds6w:type","ds6w:status"],classes:[],properties:{}};s.push(i.attributesParser(e,o)),n.resolveMissingNls(o).then(function(e){return t(n.createListNodes(s,n.genericEngItemOptionsMapper.bind(n,e[0])))}).catch(function(e){console.log(e)})})},_indexFormatFetchManager:function(e,t,n){if(!e||!e.serverResponse||!Array.isArray(e.serverResponse.results))return n?n("invalid input : missing serverResponse"):null;var r=void 0!==e.createNode&&e.createNode;this.getEngItemsListFromServerFetch(e.serverResponse,e.uwaModel,e.withconfig,r).then(function(e){return t(e)}).catch(function(e){n(e)})},getEngItemsListFromServerFetch:function(e,n,r,s){var o=this;return new t(function(t,n){if(!Array.isArray(e.results))return n(e);var r=i.parseFetchResult(e,["ds6w:type","ds6w:status"]);o.resolveMissingNls(r.nlsTracker).then(function(e){return t(s?o.createListNodes(r.results,o.genericEngItemOptionsMapper.bind(o,e[0])):o._optionsRetrievor(r.results[0],o.genericEngItemOptionsMapper.bind(o,e[0])))}).catch(function(e){console.log(e)})})},dbExpand:function(e){return(new o).dbExpand(e)},expand:function(e,n){var r=this;return r._isMultiLevel=n,new t(function(t,n){(new o).expand(e).then(async function(e){const s=e.results.reduce((e,t)=>{if(t.attributes&&!t.path){if(!t.attributes.find(e=>"ro.plminstance.V_treeorder"===e.name)){const n=t.attributes.find(e=>"resourceid"===e.name);n&&e.push(n.value)}}return e},[]);let i=await(new o).gateMaturityNPolicy(s),a=r.modifyMainObject(e.results,i.result);r._processExpandResponse(a,t,n)}).catch(function(e){console.log(e)})})},modifyMainObject:function(e,t){const n=t.reduce((e,t)=>(e[t.id]=t,e),{});return e.map(e=>{if(e.attributes&&e.attributes.some(e=>"resourceid"===e.name)){const t=e.attributes.find(e=>"resourceid"===e.name).value,r=n[t];return r&&(e.attributes.push({name:"ds6w:status",value:`${r.policy}.${r.status}`}),e.attributes.push({name:"ds6w:policy",value:r.policy})),e}return e})},expandV2:function(e){return new t(function(t,n){(new o).expandV2(e).then(function(e){t(e)}).catch(function(e){console.log(e)})})},getEngItemNode:function(e,n){var r=this;return r.selNodes=n,new t(function(t,n){(new o).fetchItemData(e,null).then(function(e){var s={serverResponse:e,withconfig:!0,createNode:!0};if(e.infos&&0===e.infos.nhits)return t([]);r._indexFormatFetchManager(s,t,n)}).catch(function(e){return n(e)})})},authoringExpand:function(e){var n=this;return new t(function(t,r){(new o).authoringExpandOfItem(e,a.TYPE_VPMREFERENCE).then(function(e){n._processExpandResponse(e,t,r)}).catch(function(e){console.log(e)})})},fetchItemInfo:function(e){var n=this;return new t(function(t,r){(new o).fetchItemData(e,null).then(function(e){var s={serverResponse:e,withconfig:!0,createNode:!1};if(e.infos&&0===e.infos.nhits)return t([]);n._indexFormatFetchManager(s,t,r)}).catch(function(e){return r(e)})})},addInstances:function(e){return new t(function(t,n){new o({isChangeControlled:!0}).addInstance(e).then(function(e){if(console.log(e),e&&"success"===e.status){var r=e.results;Array.isArray(r)&&t(r)}else n(e)}).catch(function(e){n(e)})})},deleteInstances:function(e){return new t(function(t,n){new o({isChangeControlled:!0}).removeInstance(e).then(function(e){console.log(e),e&&"success"===e.status?t():n(e)}).catch(function(e){n(e)})})},createModelForSearchResult:function(t,n){var r=this,s=function(e){return e.parentId=n,r.createGridModel(e)};if(Array.isArray(t)){for(var o=[],i=0;i<t.length;i++){var a=e.clone(t[i],!1);o.push(s(a))}return o}return s(e.clone(t,!1))},updateAndSyncAttributes:function(e,n,r,s,i){var u={itemid:e,request:n,isRelorBus:s,relId:r.getInstanceId(),nodeModel:r,customAttribute:i};return new t(function(e,t){new o({isChangeControlled:!0}).updateAttributes(u).then(function(n){if(n.results&&n.results.length>0)for(var s=n.results,o=0;o<s.length;o++){if(200===s[o].status){var i=s[o].body;if(i.errors&&i.errors.length>0)t(i.errors);else{for(var u in i){var d=Array.isArray(i[u].value)?i[u].value[0]:i[u].value;a.ITEM_DESCRIPTION_SELECTABLE===u&&(r.options.grid["ds6w:description"]=d),"modified"===u&&(r.options.grid["ds6w:modified"]=c.getformatedDate(d)),a.ITEM_V_NAME_SELECTABLE===u&&r.setTitle(d),c.getAttributeSelectable(a.INSTANCE_PATH)===u&&(r.setInstanceTitle(d),r.setInstanceName(d))}r.updateOtherDetails(),e(r)}}else t()}}).catch(function(e){console.log(e)})})},connectMBMFItem:function(e,n){return new t(function(t,r){(new s).connectMBMFItem(e,n).then(function(e){e&&"success"===e.status?t():r(e)}).catch(function(e){r(e)})})},disconnectMBMFItem:function(e,n){return new t(function(e,t){(new s).disconnectMBMFItem(MBMFNode).then(function(n){n&&"success"===n.status?e():t(n)}).catch(function(e){t(e)})})}})});