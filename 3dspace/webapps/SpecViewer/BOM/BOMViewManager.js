define("DS/SpecViewer/BOM/BOMViewManager",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/PlatformAPI/PlatformAPI","DS/SpecGridView/SpecGridView","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/TypeUtils","DS/XSRCommonComponents/utils/XSRMask","DS/SpecGridView/utils/GridUtil","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/utils/ContextManager","DS/SpecViewer/BOM/service/EngineeringServiceWrapper","DS/XSRCommonComponents/service/XSpecsActionsFactory","DS/XSRCommonComponents/utils/Constants","DS/CreateSpecification/control/XSRNewProductCmdController","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/GridCommonActionsManager","DS/XSRCommonComponents/utils/XSpecLocalStorage","DS/SpecViewer/BOM/model/EngineeringItemModel","DS/XSRCommonComponents/components/XSpecDnD/DragDropUtil","DS/XSRCommonComponents/utils/XSRSearch","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/ENOMadeFromUX/service/MBMFServiceProvider","DS/SpecViewer/BOM/ContQty/service/ContQtyServiceProvider","DS/ENOMadeFromUX/utils/MBMFUtils","DS/SpecViewer/BOM/ContQty/controller/AddContQty","DS/ENOMadeFromUX/utils/PostSearchAction","DS/Controls/ModalContainer","DS/Controls/SpinBox","DS/Controls/Button","DS/XSRCommonComponents/utils/RMCommonServiceProvider","DS/SpecViewer/BOM/model/BOMGridCol","DS/SpecViewer/BOM/controller/ReplaceByController","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/IndexServiceProvider","text!DS/SpecViewer/assets/BOMConfig/BOMColumnConfig.json","text!DS/SpecViewer/assets/BOMConfig/BOMToolBarCommands.json","i18n!DS/SpecViewer/assets/nls/SpecViewer","i18n!DS/SpecViewer/assets/nls/ContQty","css!DS/SpecViewer/BOM/BOM.css"],function(e,t,i,a,n,r,o,s,d,l,c,u,p,m,h,g,f,b,M,I,y,v,A,C,N,S,T,R,w,_,D,E,F,P,G,V,O,B,L){"use strict";return i.extend({init:function(e){var t=e;this.appCore=e.appCore,this.appCore.localStorage=b,this.itemId=Array.isArray(t.itemId)?t.itemId[0]:t.itemId,this.container=t.container,this.modelEvents=this.appCore.specViewerModelEvents,this.currentCommand=null,this.basicModelEvents=this.appCore.basicModelEvents,this.specViewContainer=this.appCore.specViewContainer,this.currentTabKey=e.currentTabKey,this.canTriggerQuantityUpdateService=!0,this.itemTitle=e.specModel.getTitle(),this.itemMaturity=e.specModel.getMaturity();var i=e.appCore.specTagsFilter.taggerProxy;this.filterProxy=i,this.addNGFilterEvent(i),this.specModel=e.specModel,c.setContextItemId(this.specModel.getID()),c.setContextItemTitle(this.itemTitle),this.appCore.specRouteManager.setActiveSpecItem(this.specModel),this._bomSubscriptionList=[],this._subscribeEvents();var a={appCore:this.appCore,currentTabKey:this.currentTabKey,modelContainer:this.container,parentNodeModel:this.specModel};this.service=new u(a),this.MBMFService=new A,this.isRootAdded=!0,this.expandStack=[],this.expandInProgress=!1,this.expandLevel=1,this.disableMBMFCmd=this.specModel.hasBOMConnection(),this.canTriggerCellEvents=!0,this.isReorderTriggered=!1},syncInstanceModels:function(t){if(0==widget.getValue(m.PERSISTENCY_BOM_VIEW)||"function"==typeof t.getMBMFReferenceName){let i=this.bomGrid.getVisibleNodes();i&&e.is(i,"array")&&i.forEach(function(e){e.getID()===t.getID()&&(e.syncInstances(t),e.acceptChanges())}),this.bomGrid.getTreeDocument().acceptChanges()}},_updateAlternateItemInfo:function(e){var t=this;e.forEach(function(e){if(t.bomGrid.getGridNodeCount()>0){t.bomGrid.getGridNodes().forEach(function(t){if(t.getID()==e.physicalid){let i=e.alternate;"Yes"===i?(t.setDisplayAlternate(B.label_yes),t.setAlternate(i)):(t.setDisplayAlternate(B.label_no),t.setAlternate("")),t.updateOptions(t.options)}})}})},progressiveExpand:async function(e,i){var a=this;let n={pid:this.itemId};e&&(n.level=e+1),i&&(n.filter=i),s.maskLoader(a.container,B.UpdatingLoader);let r=await a.service.expandV2(n);if(r.hasOwnProperty("errors"))return g.displayNotification({eventID:"info",msg:B.ERROR_IndexModeFetch}),void s.unmaskLoader(a.container);0===r.results.length&&(a.bomGrid.getTreeDocument().removeRoots(),a.bomGrid.getTreeDocument().acceptChanges(),s.unmaskLoader(a.container));let{nodes:d,paths:l,idsToFetchMBMF:c,idsToFetchCoreNAlternates:u,policies:p}=r.results.reduce((e,t)=>{if(t.hasOwnProperty("Path")){let i=e.paths;i||(i=[],e.paths=i),i.push(t.Path)}else{let i=e.nodes;if(i||(i={},e.nodes=i),t.physicalid=t.resourceid,i[t.resourceid]=t,"MustBeMadeFrom"!==t.type&&"VPMInstance"!==t.type){let i=e.idsToFetchCoreNAlternates;i||(i=new Set,e.idsToFetchCoreNAlternates=i),t.resourceid!==a.itemId&&i.add(t.resourceid)}if(t["ds6w:policy"]){let i=e.policies;i||(i=new Set,e.policies=i),i.add(t["ds6w:policy"])}}if(Object.keys(t).some(e=>e.endsWith("V_ContQuantity"))){let i=e.idsToFetchMBMF;i||(i=[],e.idsToFetchMBMF=i),i.push(t.resourceid)}return e},{}),m=[...o.physicalProductArr,...o.rawMaterialArray];(m=m.reduce((e,t)=>(e[t.valueItem]=t.labelItem,e),{})).Formulated_Product=B.Formulated_Product;let h=[],f=Array.from(u);h.push((new G).fetchItemData(f,["preview_url"])),f.forEach(e=>{h.push(new P({id:"getAttributeDetails"}).getDetails({lIds:[e],relIDs:[],busIDs:[],plmparameters:"false",attributes:"true",navigateToMain:"false",readonly:"true",debug_properties:""})),h.push(new P({id:e}).get({mask:"SpecAndRelatedInfoObjectMask",typeActual:d[e]["ds6w:type"],typeName:m[d[e]["ds6w:type"]]}))});let b={},M=await t.allSettled(h);M[0].value.results.forEach(e=>{if(e){let a=void 0,n=void 0;var t=e.attributes;if(t)for(var i=0;i<t.length;i++)"preview_url"===t[i].name?a=t[i].value:"resourceid"===t[i].name&&(n=t[i].value);if(n){let e=b[n];e||(e={},b[n]=e),e.thumbnail=a}}}),M.slice(1).forEach((e,t)=>{if(t%2==0){if(null!=e.value){var i=e.value.results[0].data;const t=e.value.results[0].physicalID;let n=b[t];n||(n={},b[t]=n,n.custom_attributes={});let r=n.custom_attributes;r||(r={},n.custom_attributes=r),i&&i.forEach(e=>{e.value?e.type&&"boolean"===e.type?r[a.currentTabKey+e.path]=e.value[0].toString():r[a.currentTabKey+e.path]=e.value:r[a.currentTabKey+e.path]=""})}}else if(void 0!==e.value.member[0]["@id"]){let t=b[e.value.member[0]["@id"]];t||(t={},b[key]=t,t.SpecAndRelatedInfoObjectMask={});let i=t.SpecAndRelatedInfoObjectMask;i||(i={},t.SpecAndRelatedInfoObjectMask=i);var n=e.value.member[0];if(i.cestamp=n.cestamp,i.currentAccess=n.access||"",n.specificationReport){var r=n.specificationReport.member[0];if(i.specReportPid=r["@id"]||"",i.specReportType=r.typedisplayName||"",i.specReportTypeActualName=r.typeactualName||"",i.specReportTypeSymbolicName=r.symbolicTypeName||"",i.specReportName=r.name||"",i.specReportRevision=r.revision||"",i.specReportMaturity=r.maturitydisplayName||"",i.specReportMaturityActualName=r.maturityactualName||"",i.specReportCreator=r.creator||"",i.specReportDescription=r.description||"",i.specReportTitle=r.title||"",i.specReportCurrentAccess=r.access||"",i.isReportCheckedIn=!(!r.hasReport||""===r.hasReport||null===r.hasReport||void 0===r.hasReport),r.template){var o=r.template.member[0];i.templatePid=o["@id"],i.templateTitle=o.title||"",i.templateName=o.name||"",i.templateRevision=o.revision||"",i.templateState=o.maturityactualName||""}}if(n.changeDetails){var s=n.changeDetails[a.getID()];if(s){if(Array.isArray(s))for(var d=0;d<s.length;d++){var l=s[d];if("Complete"!=l.current){s=l;break}}i.changeActionName=s.name,i.changeActionState=s.current,i.changeActionId=s.physicalid,i.changeActionType=s.type,i.changeActionpolicy=s.policy,i.changeActionRelType=s.relationship,i.changeActionRelID=s["physicalid[connection]"],i.changeActionRequestedFor=s["attribute[Requested Change]"],i.changeActionTitle=s["attribute[Synopsis]"]}}}});let I=new v;p&&p.size>0?I.getStatesNLS({policies:Array.from(p)}).then(e=>{let t=e.policies.reduce((e,t)=>{let{policyName:i,states:a}=t;return a.forEach(t=>{let a=i+"."+t.stateSysName;e[a]=t.stateUserName}),e},{});a.loadTreeStructure(d,l,t,n.level,b)}):s.unmaskLoader(a.container);let y=[];if(u&&u.size>0){let e={};e.references=Array.from(u),e.with_partials=!0,y.push(I.fetchCoreMatDetails(e))}if(u&&u.size>0&&y.push(a.service.fetchAlternateInfo(Array.from(u))),c&&c.length>0){var A={};A.connectionids=c,y.push(I.getMBMF(A))}t.allSettled(y).then(e=>{let t={},i={},n={};a.canTriggerCellEvents=!1,e.forEach((e,a)=>{let r=e.value;if(r)if(0===a)for(const[e,t]of r.entries()){let a=t.physicalid,n=t.V_Name?t.V_Name:"",r=t.revision?t.revision:"-",o=i[e];o||(o={},i[e]=o),o.coreMaterial=n+" "+r,o.coreMaterialId=a}else if(1===a)for(const i in e.value.AlternateItemInfo){let e=t[i];e||(e={},t[i]=e),e.Alternate="Yes",e["ds6w:alternate"]=B.label_yes}else r.result.forEach(e=>{let t=e.resourceid,i=n[t];i||(i={},n[t]=i),i.quantity=e.quantity,i.unit=e.unit})}),a.bomGrid.getTreeDocument().getAllDescendants().forEach(e=>{if("function"!=typeof e.getID)return;let a=e.getAttributeValue("physicalId"),r=e.getAttributeValue("instanceId"),s=i[a]||{},d=t[a]||{},l=n[r],c={};c.coreMaterial=s.coreMaterial||"",c.coreMaterialId=s.coreMaterialId||"",c.Alternate=d.Alternate||"",c["ds6w:alternate"]=d.Alternate||"",l&&(l.quantity&&(c.quantity=l.quantity),l.unit&&(c.unit=l.unit,c.unitNLS=o.getUOMUnits(l.unit)),c.qty_unit=l.quantity+" "+l.unit,c.unitNLS=o.getUOMUnits(l.unit)),e.updateOptions({grid:c}),e.acceptChanges()}),a.canTriggerCellEvents=!0,a.updateReferenceList()})},clearGrid(){this.bomGrid.getTreeDocument().removeRoots(),this.bomGrid.getTreeDocument().acceptChanges()},loadTreeStructure(e,t,i,a,n,d){var l=this;l.clearGrid();let c=[...o.physicalProductArr,...o.rawMaterialArray];(c=c.reduce((e,t)=>(e[t.valueItem]=t.labelItem,e),{})).Formulated_Product=B.Formulated_Product;let u={},p=[];t.forEach(t=>{if(t.length<3)return;let a={parentId:"",instanceId:"",occurrencePath:[],occurenceTitle:"",parentPath:""},s=t.length-1;for(let m=0;m<t.length;m++){let h=t[m];if(a.occurrencePath.push(e[h].physicalid),l.itemId!==h){if(m%2==1&&null!=e[h]["ds6w:label"]&&(a.occurenceTitle=e[h]["ds6w:label"]),m%2==1&&(a.instanceId=h),m%2==0){let t=Object.assign({},e[h]),g=e[a.instanceId],f=a.parentId||l.itemId,b=h,I=a.occurrencePath.join("/"),y=a.parentPath,v=(a.occurrencePath.length-1)/2,A=u[I];if(!A){let h={shouldDisplayChildren:!1};t.instanceTitle=a.occurenceTitle,t.instanceName=a.occurenceTitle,t.instanceId=a.instanceId,t.parentId=f,t.instanceCount=1,t.relationid=a.instanceId,t.level=v;let b=t["ds6w:type"];if(t["ds6w:type"]=c[b],t["ds6w:type_value"]=b,t["ds6w:status_value"]=t["ds6w:status"],t["ds6w:status"]=i?i[t["ds6w:status"]]:t["ds6w:status"],t["ds6wg:PLMReference.V_isLastVersion"]="TRUE"===t["ds6wg:PLMReference.V_isLastVersion"],t.islastrevision="TRUE"===t.islastrevision,t["ds6w:reserved"]="TRUE"===t["ds6w:reserved"],t["ds6w:manufacturable"]="TRUE"===t["ds6w:manufacturable"],t["ds6w:created"]=r.getformatedDate(t["ds6w:created"]),t["ds6w:modified"]=r.getformatedDate(t["ds6w:modified"]),t.ReferenceName=g["ds6wg:madefrom_referencedescription.referencename"],t.coreMaterial="Loading...",t.coreMaterialId="Loading...",t.Alternate="Loading...",t["ds6w:alternate"]="Loading...","MustBeMadeFrom"===g.type?(t.madeFromProductTitle=t["ds6w:label"],t.madeFromProductID=t.resourceid,t.madeFromRelationId=t.instanceId,t.madeFrom=!0,(o.isRawMaterial(b)||o.isFormulatedProduct(b))&&(t.asRequired="TRUE"===g["ro.madefromquantity_AsRequired.AsRequired"],t.isComputed="TRUE"===g["ds6wg:madefrom_referencedescription.iscomputed"],t.madeFromParentID=g.from,t.madeFromProductType={dbName:t["ds6w:type_value"],nlsLabel:t["ds6w:type"]},o.isRawMaterial(b)&&(t.dimensionType={dbName:t["ds6wg:raw_material.v_dimensiontype"],nlsLabel:t["ds6wg:raw_material.v_dimensiontype"]}),Object.keys(g).some(e=>e.endsWith("V_ContQuantity"))?(t.unitNLS="loading...",t.unit="loading..."):(t.unitNLS="",t.quantity=""))):(o.isRawMaterial(b)||o.isFormulatedProduct(b))&&(t.asRequired="TRUE"===g["ro.VPMInstanceQuantity_AsRequired.AsRequired"],t.CQInstance=!0,o.isRawMaterial(b)&&(t.dimensionType=t["ds6wg:raw_material.v_dimensiontype"]),Object.keys(g).some(e=>e.endsWith("V_ContQuantity"))?(t.unitNLS="loading...",t.unit="loading..."):(t.unitNLS="",t.unit="",t.quantity="")),(A=new M(h).set(t,!1)).updateAddtitionalValues(),n){let e=n[t.physicalid];e&&(A.setCustomAttributes(e.custom_attributes),A.setSpecAndRelatedInfoObjectMask(e.SpecAndRelatedInfoObjectMask),A.setThumbnail(e.thumbnail))}A.currentTabKey=l.currentTabKey,A.appCore=l.appCore,A.currentPath=I;let C=u[y];if(C){if(o.isFormulatedProduct(C.getAttributeValue("ds6w:type_value")))break;C.addChild(A),A.parentNodeModel=C}else p.push(A),A.parentNodeModel=l.specModel;if(d&&s===m&&d[t.physicalid]){d[t.physicalid].forEach(t=>{let i=Object.assign([],a.occurrencePath);i.push(t.relId),i.push(t.madeFromProduceId);let s=i.join("/"),d=(i.length-1)/2,u=Object.assign({},e[t.madeFromProduceId]),p=e[t.relId],m=A.getAttributeValue("physicalId"),h=d;u.instanceId=t.relId,u.parentId=m,u.instanceCount=1,u.relationid=t.relId,u.level=h,u.islastrevision=u.isLastVersion,u["ds6w:reserved"]="TRUE"===u["ds6w:reserved"],u["ds6w:manufacturable"]="TRUE"===u["ds6w:manufacturable"],u["ds6w:created"]=r.getformatedDate(u["ds6w:created"]),u["ds6w:modified"]=r.getformatedDate(u["ds6w:modified"]),u.ReferenceName=p["ds6wg:madefrom_referencedescription.referencename"],u["ds6w:type"]=c[u["ds6w:type_value"]],u.coreMaterial="Loading...",u.coreMaterialId="Loading...",u.Alternate="Loading...",u["ds6w:alternate"]="Loading...",u.madeFromProductTitle=u["ds6w:label"],u.madeFromProductID=u.resourceid,u.madeFromRelationId=u.instanceId,u.madeFrom=!0,o.isRawMaterial(u["ds6w:type_value"])||o.isFormulatedProduct(u["ds6w:type_value"])?(u.asRequired="TRUE"===p["ro.madefromquantity_AsRequired.AsRequired"],u.isComputed="TRUE"===p["ds6wg:madefrom_referencedescription.iscomputed"],u.madeFromParentID=p.from,u.madeFromProductType={dbName:u["ds6w:type_value"],nlsLabel:u["ds6w:type"]},u.unit={dbName:p.unit,nlsLabel:p.unitNLS},u.quantity=p.quantity,u.qty_unit=p.quantity+" "+p.unit):(u.unitNLS="",u.quantity="");let g=new M({shouldDisplayChildren:!1}).set(u,!1);if(g.updateAddtitionalValues(),n){let e=n[u.physicalid];e&&(g.setCustomAttributes(e.custom_attributes),g.setSpecAndRelatedInfoObjectMask(e.SpecAndRelatedInfoObjectMask),g.setThumbnail(e.thumbnail))}A.addChild(g),g.parentNodeModel=A,g.currentTabKey=l.currentTabKey,g.appCore=l.appCore,g.currentPath=s})}u[I]=A}A&&(a.parentId=b,a.parentPath=I)}}else a.parentId=h}});var h=widget.getValue(m.PERSISTENCY_BOM_VIEW);void 0===h&&(h=!0);let g=h?l.getGroupNodesOnQuantityV2(p):p,f=[];for(let e in g)f.push(g[e]);l.bomGrid.addRootNodes(f),l.appliedNGFilter||l.bomGrid.getTreeDocument().withTransactionUpdate(()=>{l.bomGrid.gridTreeDocument.itemModelMapping=[],l.expand_nodes(f,a,!0)}),s.unmaskLoader(l.container)},expand_nodes(e,t,i){void 0===i&&(i=!1);var a=this;e&&e.forEach(e=>{if(a.bomGrid.gridTreeDocument.itemModelMapping.push({id:e}),e.getAttributeValue("level")===t)a.appliedNGFilter||o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value"))||e.addChild(new M({shouldDisplayChildren:!1}));else if(i&&void 0===e.getAttributeValue("madeFrom")){if(o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value")))return;e.setState({state:"expanded"}),a.expand_nodes(e.getChildren(),t,i)}else if(!i){if(o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value")))return;e.setState({state:"expanded"}),a.expand_nodes(e.getChildren(),t,i)}})},evt_SpecsExpandNodes:function(e){var t=this,i=e.data.nodeModel;if(o.isFormulatedProduct(i.getAttributeValue("ds6w:type_value")))return t.bomGrid.getTreeDocument().setUseChangeTransactionMode(!1),i.removeChildren(),void t.bomGrid.getTreeDocument().setUseChangeTransactionMode(!0);if(t.appliedNGFilter)i.setState({state:"expanded"});else{t.expandStack.push(i.getID());var a=i._options.grid.physicalId,n=widget.getValue(m.PERSISTENCY_BOM_VIEW);null==n&&(n=!0);var r=i.getChildren();r&&r.length>0&&(t.bomGrid.getTreeDocument().setUseChangeTransactionMode(!1),i.removeChildren(),t.bomGrid.getTreeDocument().setUseChangeTransactionMode(!0)),a&&t.service.expand([a],!0).then(function(e){if(e&&e.length>0){let a=new Map;var r;for(var s in t.getBOMAndCoreMatDetails(e,null,!1),r=n?t.getGroupNodesOnQuantity(e):e){var l=r[s];l.setAttribute("level",i.getAttributeValue("level")+1),i.addChild(l),l.parentNodeModel=i,l.setCurrentPath(l);var c={};c[l.getID()]=l;var u=t.bomGrid.gridTreeDocument.itemModelMapping.filter(function(e){return Object.keys(e)[0]===l.getID()});if(u&&u.length>0){let e=(new d).updateItemModelMapping(t.bomGrid.gridTreeDocument.itemModelMapping,l);t.bomGrid.gridTreeDocument.itemModelMapping=e}else t.bomGrid.gridTreeDocument.itemModelMapping.push(c);(o.isRawMaterial(l.getTypeActualName())||o.isFormulatedProduct(l.getTypeActualName()))&&a.set(l.getInstanceId(),l)}t.bomGrid.getTreeDocument().acceptChanges(),t.getContinousQuantityData(a)}t.getMBMFNodes(a,[i],!1,null,null),1==t.expandStack.length&&t.expandInProgress&&t._bomExpandTree(),t.expandStack.pop()}).catch(function(e){t.expandStack.pop(),g.displayNotification({eventID:"error",msg:B.Error_Expand_BOMChildren})}).finally(()=>s.unmaskLoader(t.container))}},evt_LanchPrevNextCommand:function(e){e.commandId;var t=e.move,i=e.itemId,a=(e.callBackAction,this.bomGrid.getTreeDocument().getSelectedNodes());if(a&&!a||!(a.length<=0||a.length>1)?(a=Array.isArray(a)?a[0]:a)&&a.getID()!==i&&(a=(new d).getModelById(i,this.bomGrid)):a=(new d).getModelById(i,this.bomGrid),a&&a.getID()===i){var n=r.getValidPreviousorNextNode(a,t);n&&(this.bomGrid.unselectAll(),this.gridViewInstance=this.bomGrid.getGridViewInstance(),this.gridViewInstance&&this.gridViewInstance.ensureNodeModelVisible(n),n.select())}},updateSameNodesInBom:function(e){var t=this;let i=o.isRawMaterial(e.nodeModel.getAttributeValue("ds6w:type")),a=e.nodeModel.getAttributeValue("madeFromRelationId")?"madeFromRelationId":"relationid",n=e.nodeModel.getAttributeValue(a);void 0!==n||i||(a="instanceId",n=e.nodeModel.getAttributeValue(a));let r=t.bomGrid.getTreeDocument().getAllDescendants().filter(t=>t.getAttributeValue(a)===n&&t._id!==e.nodeModel._id);if(i){let{quantity:i,asRequired:a,unit:n,unitNLS:o}=e.nodeModel.options.grid;r.forEach(e=>{t.canTriggerCellEvents=!1,e.updateOptions({grid:{quantity:i,asRequired:a,unit:n,unitNLS:o}}),t.canTriggerCellEvents=!0})}else{let{quantity:i,instanceCount:a,instanceIds:n,instanceTitle:o}=e.nodeModel.options.grid;r.forEach(e=>{t.canTriggerCellEvents=!1,e.updateOptions({grid:{quantity:i,instanceCount:a,instanceIds:n,instanceTitle:o}}),t.canTriggerCellEvents=!0})}},evt_GridToolbarSwitchViewBOM:function(e){var t="grid-preferred-view-"+this.currentTabKey;widget.setValue(t,e),this.bomGrid.switchView(e),m.BIG_TILE===e?(this.isTileView=!0,this.toggleMBMFCommand(!1,!1)):m.GRID_VIEW===e&&(this.isTileView=!1,this.toggleMBMFCommand(!0,!1),this.isReferenceView||this.toggleMBMFCommand(!1,!1))},evt_GridCellValueUpdateBOM:function(e){var t=this;if(t.canTriggerCellEvents){var i=e.newValue,a=e.oldValue,n=e.nodeModel.getID();s.maskLoader(t.container,B.UpdatingLoader);var d=function(e,i){"success"===e?(t.bomGrid.getTreeDocument().acceptChanges(),t.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+t.currentTabKey})):t.modelEvents.publish({event:"xsr-show-toolbar-reset-command-"+t.currentTabKey}),g.displayNotification({eventID:e,msg:i}),s.unmaskLoader(t.container)},l=function(i,a,r){t.bomGrid.unselectAll(),e.nodeModel.select(),t.service.updateAndSyncAttributes(n,[{attribute:i,value:a}],e.nodeModel,r,!!e.dataIndex.startsWith("bom")).then(function(e){t.syncInstanceModels(e),d("success",B.Notify_Updated),t.updateFetchMode()}).catch(function(e){s.unmaskLoader(t.container),console.error(e),d("error",B.Failure_Update)})};let P="bus";if(e.dataIndex.startsWith("bom")){var c=r.getInstanceCustomAttributesData(),u=e.dataIndex.split("bom")[1],p=e.newValue.toString();c&&c.includes(u)?l(u,p,"rel"):l(u,p,P)}else switch(e.dataIndex){case"ds6w:description":l(u=m.ITEM_DESCRIPTION,p=i,P);break;case"tree":var h=m.ITEM_V_NAME,f=i;i?l(h,f,P):d("error",B.replace(B.get(B.Error_EmptyTitle),{columnName:B.label_Title}));break;case"instanceTitle":var b=m.INSTANCE_PATH;f=i;P="rel",i?l(b,f,P):d("error",B.replace(B.get(B.Error_EmptyIncolumn),{columnName:B.label_InstanceTitle}));break;case"asRequired":var M={};e.nodeModel.getCQInstance()?e.nodeModel.getUnit()&&e.nodeModel.getQuantity()?(M.quantityUOM=e.nodeModel.getUnit(),M.quantity=e.nodeModel.getQuantity(),M.asRequired=i,(new C).updateContQtyData(M,e.nodeModel).then(function(a){a&&!a.success?(t.updateFetchMode(),e.nodeModel.setAsRequired(i),t.updateSameNodesInBom(e),t.bomGrid.unselectAll(),e.nodeModel.select(),widget.getValue(m.PERSISTENCY_BOM_VIEW)&&e.nodeModel.sync(),e.nodeModel.acceptChanges(),g.displayNotification({eventID:"success",msg:L.update_successful}),t.syncInstanceModels(e.nodeModel)):(g.displayNotification({eventID:"error",msg:a.message}),e.nodeModel.setAsRequired(!1)),s.unmaskLoader(t.container)}).catch(function(e){g.displayNotification({eventID:"error",msg:e.message}),s.unmaskLoader(t.container)})):(e.nodeModel.setAsRequired(a),t.bomGrid.unselectAll(),e.nodeModel.select(),e.nodeModel.sync(),e.nodeModel.acceptChanges(),g.displayNotification({eventID:"error",msg:L.ContQtyMandLabel}),s.unmaskLoader(t.container)):(M.uomType=e.nodeModel.getDimensionType(),M.quantity=e.nodeModel.getQtyAndUnit(),M.asRequired=i,N.getMBMFUpdateService(M,e.nodeModel).then(function(a){a&&a.success?(t.updateFetchMode(),e.nodeModel.setAsRequired(i),t.bomGrid.unselectAll(),e.nodeModel.select(),e.nodeModel.sync(),e.nodeModel.acceptChanges(),t.updateSameNodesInBom(e)):(g.displayNotification({eventID:"error",msg:a.result.message}),e.nodeModel.setAsRequired(!1)),s.unmaskLoader(t.container)}).catch(function(e){g.displayNotification({eventID:"error",msg:e.result.message}),s.unmaskLoader(t.container)}));break;case"quantity":if(!t.canTriggerQuantityUpdateService)return;if(e.nodeModel.getCQInstance()&&!e.nodeModel.getMadeFrom()){i||d("error",B.replace(B.get(B.Error_EmptyIncolumn),{columnName:B.Quantity}));M={};if(!e.nodeModel.getUnit()){t.syncNodePostUpdate(e,i),g.displayNotification({eventID:"error",msg:L.UOM_update_err}),s.unmaskLoader(t.container);break}M.quantityUOM=e.nodeModel.getUnit(),M.quantity=i,M.asRequired=e.nodeModel.getAsRequired(),(new C).updateContQtyData(M,e.nodeModel).then(function(n){n&&!n.success?(t.syncNodePostUpdate(e,i),t.updateFetchMode(),t.updateSameNodesInBom(e),g.displayNotification({eventID:"success",msg:L.update_successful}),t.syncInstanceModels(e.nodeModel)):(g.displayNotification({eventID:"error",msg:n.message}),t.syncNodePostUpdate(e,a)),s.unmaskLoader(t.container)}).catch(function(e){g.displayNotification({eventID:"error",msg:e.message}),s.unmaskLoader(t.container)})}else if(e.nodeModel.getMadeFrom()){i||d("error",B.replace(B.get(B.Error_EmptyIncolumn),{columnName:B.Quantity})),(M={}).uomType=e.nodeModel.getDimensionType(),M.quantity=i+" "+e.nodeModel.getUnit(),M.asRequired=e.nodeModel.getAsRequired(),N.getMBMFUpdateService(M,e.nodeModel).then(function(n){n&&n.success?(t.updateFetchMode(),t.syncNodePostUpdate(e,i),t.updateSameNodesInBom(e),e.nodeModel.setQtyAndUnit(i+" "+e.nodeModel.getUnit())):(g.displayNotification({eventID:"error",msg:n.result.message}),t.syncNodePostUpdate(e,a)),s.unmaskLoader(t.container)}).catch(function(e){g.displayNotification({eventID:"error",msg:e.result.message}),s.unmaskLoader(t.container)})}else{if(!Number.isInteger(i)||i<1){t.syncNodePostUpdate(e,a),g.displayNotification({eventID:"error",msg:L.QuantityErr}),s.unmaskLoader(t.container);break}if(a<i){var I=i-a,y={parentId:e.nodeModel.getParentId(),instanceIDs:e.nodeModel.getParentInstanceIds(),itemId:e.nodeModel.getID(),quantity:I};t.bomGrid.unselectAll(),t.createInstances(y,e.nodeModel,!1).then(function(i){i&&i.error?d("error",B.Failure_Update):(d("success",B.Notify_Updated),e.nodeModel.sync(),t.updateSameNodesInBom(e))}).catch(function(e){console.error(e)})}else if(a>i){var v=[],A=e.nodeModel.getParentInstanceIds();i!==Math.floor(i)&&(i=Math.floor(i));for(var S=i;S<A.length;S++)v.push(A[S]);var T={instances:v};t.deleteInstances(T,e.nodeModel).then(function(){d.call(this,"success",B.Notify_Updated),e.nodeModel.sync(),t.updateSameNodesInBom(e)}).catch(d.bind(this,"error",B.Failure_Update))}}break;case"unitNLS":if(e.nodeModel.getCQInstance()&&!e.nodeModel.getMadeFrom()){M={};if(w=Object.entries(o.getUOMUnits(e.nodeModel.getDimensionType()))){var R=new Map;w.forEach(function(e){R.set(e[1],e[0])})}if(!i&&e.nodeModel.getAsRequired()){e.nodeModel.setUnit(a),e.nodeModel.setQuantityUOM(R.get(a)),t.bomGrid.unselectAll(),e.nodeModel.select(),e.nodeModel.sync(),e.nodeModel.acceptChanges(),g.displayNotification({eventID:"error",msg:L.UOM_blank_error}),s.unmaskLoader(t.container);break}if(!i&&e.nodeModel.options.grid.quantity){e.nodeModel.setUnit(a),t.bomGrid.unselectAll(),e.nodeModel.select(),e.nodeModel.sync(),e.nodeModel.acceptChanges(),g.displayNotification({eventID:"error",msg:L.ContQtyMandLabel}),s.unmaskLoader(t.container);break}if(!e.nodeModel.options.grid.quantity){e.nodeModel.setUnit(i),t.bomGrid.unselectAll(),e.nodeModel.select(),e.nodeModel.sync(),e.nodeModel.acceptChanges(),g.displayNotification({eventID:"error",msg:L.Qty_update_err}),s.unmaskLoader(t.container);break}M.quantityUOM=R.get(i),M.quantity=e.nodeModel.options.grid.quantity,M.asRequired=e.nodeModel.getAsRequired(),(new C).updateContQtyData(M,e.nodeModel).then(function(a){a&&!a.success?(e.nodeModel.setUnit(R.get(i)),!i&&e.nodeModel.getAsRequired()&&e.nodeModel.setQuantity(""),t.updateFetchMode(),t.updateSameNodesInBom(e),t.bomGrid.unselectAll(),e.nodeModel.select(),widget.getValue(m.PERSISTENCY_BOM_VIEW)&&e.nodeModel.sync(),e.nodeModel.acceptChanges(),g.displayNotification({eventID:"success",msg:L.update_successful}),t.syncInstanceModels(e.nodeModel)):g.displayNotification({eventID:"error",msg:a.message}),s.unmaskLoader(t.container)}).catch(function(e){g.displayNotification({eventID:"error",msg:e.message}),s.unmaskLoader(t.container)})}else{var w;if((M={}).uomType=e.nodeModel.getDimensionType(),w=Object.entries(o.getUOMUnits(e.nodeModel.getDimensionType()))){R=new Map;w.forEach(function(e){R.set(e[1],e[0])})}M.quantity=e.nodeModel.options.grid.quantity+" "+R.get(i),M.asRequired=e.nodeModel.getAsRequired(),N.getMBMFUpdateService(M,e.nodeModel).then(function(a){a&&a.success?(t.updateFetchMode(),e.nodeModel.setUnit(i),e.nodeModel.setQtyAndUnit(e.nodeModel.options.grid.quantity+" "+R.get(i)),t.bomGrid.unselectAll(),e.nodeModel.select(),e.nodeModel.sync(),e.nodeModel.acceptChanges(),t.updateSameNodesInBom(e)):g.displayNotification({eventID:"error",msg:a.result.message}),s.unmaskLoader(t.container)}).catch(function(e){g.displayNotification({eventID:"error",msg:e.result.message}),s.unmaskLoader(t.container)})}break;case"referenceName":if(e.nodeModel.getMadeFrom()){(M={}).referenceName=i||"";let n,r=e.nodeModel.getAttributeValue("physicalId"),o=e.nodeModel.getAttributeValue("madeFromRelationId"),d=(n=void 0===e.nodeModel.parentNodeModel?e.nodeModel.getTreeDocument().getAllDescendants():e.nodeModel.parentNodeModel.getAllDescendants()).length;var _=0;for(let t=0;t<d;t++){var D,E=n[t].options.grid.tree,F=e.nodeModel.options.grid.tree;if(n[t].options.grid.madeFromRelationId&&e.nodeModel.options.grid.madeFromRelationId!=n[t].options.grid.madeFromRelationId)if(E==F)if(i||(D=""),D==n[t].options.grid.referenceName){_=1;break}}if(1==_){t.bomGrid.getTreeDocument().cancelChanges(),g.displayNotification({eventID:"error",msg:B.ERROR_UNIQUE_REFERENCE_NAME}),s.unmaskLoader(t.container);break}0==e.nodeModel.getBrothers().filter(e=>r===e.getAttributeValue("physicalId")&&o!==e.getAttributeValue("madeFromRelationId")).filter(e=>i===e.getAttributeValue("referenceName")).length?(e.nodeModel.options.grid.quantity>0&&(M.uomType=e.nodeModel.getDimensionType(),M.quantity=e.nodeModel.getQtyAndUnit()),e.nodeModel.parentNodeModel.setreferenceArrayList(i),e.nodeModel.parentNodeModel.removereferencevalue(a),M.asRequired=e.nodeModel.getAsRequired(),N.getMBMFUpdateService(M,e.nodeModel).then(e=>{e&&e.success&&(t.updateReferenceList(),t.bomGrid.getTreeDocument().acceptChanges(),t.updateFetchMode())}).catch(e=>{g.displayNotification({eventID:"error",msg:e?e.result.message:B.Failure_Update}),s.unmaskLoader(t.container)}).finally(()=>{s.unmaskLoader(t.container)})):(t.bomGrid.getTreeDocument().cancelChanges(),g.displayNotification({eventID:"error",msg:B.ERROR_UNIQUE_REFERENCE_NAME}),s.unmaskLoader(t.container))}break;default:s.unmaskLoader(t.container)}}},evt_GridToolbarActionClickBOM:function(e){var t=this.bomGrid.getTreeDocument().getSelectedNodes();if(t&&0===t.length?this.isRootAdded=!0:this.isRootAdded=!1,e)switch(e){case"create":this._launchCreateScreen();break;case"add":case"addRawMat":case"addMBMFItem":case"addMBMFRawMat":case"addFP":case"addMBMFFP":this.currentCommand=e,this._launchSearch(e,this.isRootAdded);break;case"createRawMat":this._launchRMCreateScreen();break;case"removeitem":this._removeOrDeleteNodes("remove");break;case"deleteItem":this._removeOrDeleteNodes("delete");break;case"Export":this._exportGrid();break;case"personalize":this._personalize();break;case"DefineFilter":if("index"!==widget.getValue("fetchmode"))return void g.displayNotification({eventID:"error",msg:B.Error_AdvanceFilter});this._launchAdvancedFilter(e);break;case"quantity":this.drawGridBasedOnMode(!0);break;case"instance":this.drawGridBasedOnMode(!1);break;case"expandall":"index"===widget.getValue("fetchmode")&&this.appliedNGFilter?this.expand_nodes(this.bomGrid.getTreeDocument().getRoots(),void 0,!0):this._bomExpandTreeV3(!0);break;case"expandNLevel":this.bomExpandTreeInput();break;case"collapseall":this.bomCollapseAll();break;case"reorder":let i=this.isRootAdded?this.specModel:t;this.currentCommand=e,this.reorderTree(i);break;case"AuthPaste":let a=this.isRootAdded?this.specModel:t;this.currentCommand=e,this.pasteItems(a)}},bomExpandTree:function(e){s.maskLoader(this.container,B.Loaderloading),this.bomGrid.model.collapseAll(),this.expandInProgress=!0,this.expandLevel=-1,e&&e>0&&(this.expandLevel=e),this._bomExpandTree(!0)},bomExpandTreeInput:function(){var t=this,i=e.createElement("div",{class:"expandLevelInput"});let a=new w({minValue:1,decimals:0,stepValue:1,pageStepValue:1,displayStyle:"lite"});a.inject(i);let n=new _({displayStyle:"lite",label:"proceed",icon:{iconName:"check",fontIconFamily:WUXManagedFontIcons.Font3DS},showLabelFlag:!1});n.inject(i),n.getContent().addEventListener("buttonclick",function(){let e=a.value;R.removeModal(t.container),"index"===widget.getValue("fetchmode")&&t.appliedNGFilter?(t.bomGrid.getTreeDocument().collapseAll(),t.expand_nodes(t.bomGrid.getTreeDocument().getRoots(),e,!0)):t._bomExpandTreeV3(!0,e)}),R.createModal(t.container,i)},_bomExpandTreeV3:async function(e,t,i){var a=this;s.maskLoader(a.container,B.Loaderloading);let n="index"===widget.getValue("fetchmode");null!=t&&(t=n?t+1:t+1+"");try{let d={},l={},c=new Set;if(n){let e={pid:this.itemId,level:t};i&&(e.filter=i);let n=await a.service.expandV2(e);if(n.hasOwnProperty("errors"))return g.displayNotification({eventID:"info",msg:B.ERROR_IndexModeFetch}),void s.unmaskLoader(a.container);0===n.results.length&&(a.clearGrid(),a.updateBOMToolBarCmds(),s.unmaskLoader(a.container)),d=n.results.reduce((e,t)=>{if(t.hasOwnProperty("Path")){let i=e.paths;i||(i=[],e.paths=i),i.push(t.Path)}else{let i=e.nodes;if(i||(i={},e.nodes=i),t.physicalid=t.resourceid,i[t.resourceid]=t,"MustBeMadeFrom"!==t.type&&"VPMInstance"!==t.type){let i=e.types;i||(i=new Set,e.types=i),i.add(t["ds6w:type"])}let a=e.states;if(a||(a=new Set,e.states=a),a.add(t["ds6w:status"]),Object.keys(t).some(e=>e.endsWith("V_ContQuantity"))){let i=e.mbmfIds;i||(i=[],e.mbmfIds=i),i.push(t.resourceid)}}return e},{})}else{let e=(d=(await this.service.dbExpand({pids:[this.itemId],level:t||"-1"})).results.reduce((e,t)=>{if(t.hasOwnProperty("attributes")){let i=t.attributes.find(e=>"did"===e.name),n=t.attributes.find(e=>"resourceid"===e.name),r=t.attributes.find(e=>"ds6w:type"===e.name),s=t.attributes.find(e=>"ro.plminstance.V_treeorder"===e.name),d=t.attributes.find(e=>"ds6w:status"===e.name),l=e.didresourceidAttrMap;if(l||(l=new Map,e.didresourceidAttrMap=l),l[i.value]=n.value,s){let i=e.instIds;i||(i=new Set,e.instIds=i);let a=t.attributes.find(e=>"resourceid"===e.name);a&&i.add(a.value)}if(d){let t=e.states;t||(t=new Set,e.states=t),t.add(d.value)}let c=e.nodes;c||(c={},e.nodes=c);let u=t.attributes.reduce((e,t)=>(e[t.name]=t.value,e),{});if(u.physicalid=n.value,c[n.value]=u,"VPMInstance"!==r.value&&"VPMRepInstance"!==r.value){if(n.value!==a.itemId&&o.isPhyProd(r.value)){let t=e.phyPrdIds;t||(t=new Set,e.phyPrdIds=t),t.add(n.value)}let t=e.types;t||(t=new Set,e.types=t),t.add(r.value)}else if("VPMRepInstance"===r.value){let i=e.repInstIds;i||(i=new Set,e.repInstIds=i);let a=t.attributes.find(e=>"resourceid"===e.name);i.add(a.value)}}else if(t.hasOwnProperty("path")){let i=e.paths;i||(i=[],e.paths=i),i.push(t.path)}return e},{})).didresourceidAttrMap,i=d.instIds,n=d.repInstIds||new Set,r=d.nodes,u=(d.states,d.paths),p=(d.types,d.phyPrdIds||new Set);if(!i)return a.clearGrid(),await a.getMBMFNodes(this.itemId),a.updateBOMToolBarCmds(),void s.unmaskLoader(a.container);u=u.map(t=>t.map(t=>e[t])),d.paths=u;let m=[],h=u.reduce((e,t)=>{let i=t[t.length-1],a=t[t.length-2];return p.has(i)?e.add(i):n.has(a)&&(c.add(i),e.add(t[t.length-3])),e},new Set);if((h=Array.from(h||new Set)).length>0){let e=(await a.MBMFService.getMBMFInfoBulk(h)).reduce((e,t)=>{t.value.result;return t.value.result.forEach(t=>{let i=t.Product_Id;t.MadeFromConnections&&t.MadeFromConnections.length>0&&t.MadeFromConnections.forEach(t=>{let a=e.mbmfPathsByParentId;a||(a={},e.mbmfPathsByParentId=a);let n=a[i];n||(n=[],a[i]=n),n.push({relId:t.madeFromRelationId,madeFromProduceId:t.madeFromProductID});let o={};o["ds6wg:madefrom_referencedescription.iscomputed"]=(t.isComputed+"").toUpperCase(),o.treeOrder=t.treeOrder,o["ro.madefromquantity_AsRequired.AsRequired"]=(t.asRequired+"").toUpperCase(),o.quantityType=t.quantityType,t.quantityUOM&&(o.unit=t.quantityUOM.dbName,o.unitNLS=t.quantityUOM.nlsLabel),o["ds6wg:madefrom_referencedescription.referencename"]=t.ReferenceName,o.quantity=t.quantity,o.physicalid=o.resourceid=t.madeFromRelationId,o.type="MustBeMadeFrom",o.from=i,r[t.madeFromRelationId]=o;let s={};s["ds6w:type"]=t.madeFromProductType.nlsLabel,s["ds6w:type_value"]=t.madeFromProductType.dbName,s["ds6w:label"]=t.madeFromProductTitle,s.dimensionType=t.quantityType,s.madeFromProductTitle=t.madeFromProductTitle,s.dimensionType=t.dimensionType,s.cestamp=t.cestamp,s.madeFromProductRevision=t.madeFromProductRevision,s.madeFromProductType=t.madeFromProductType,s.physicalid=s.resourceid=t.madeFromProductID,r[t.madeFromProductID]=s;let d=e.mbmfIds;d||(d=new Set,e.mbmfIds=d),d.add(t.madeFromProductID)})}),e},{});l=e.mbmfPathsByParentId,m=Array.from(e.mbmfIds||new Set)}if(m.length>0){(await a.MBMFService.fetchItemInfo(m)).forEach(e=>{r[e.resourceid]=Object.assign(e,r[e.resourceid])})}}let{nodes:u,states:p,paths:m,types:h}=d;if(!h)return;let f=await r.getNlsOfPropertiesValues({"ds6w:type":Array.from(h),"ds6w:status":Array.from(p)});a.loadTreeStructureV2(u,m,f,e,t?parseInt(t):void 0,l,c),a.updateBOMToolBarCmds()}catch(e){console.error(e),g.displayNotification({eventID:"error",msg:B.Failure_Products})}finally{s.unmaskLoader(a.container)}},loadTreeStructureV2:function(e,t,i,a,n,d,l){var c=this;c.clearGrid();let u={},p=[];t.forEach(t=>{if(t.length<3)return;let a={parentId:"",instanceId:"",occurrencePath:[],occurenceTitle:"",parentPath:""},n=t.length-1;for(let s=0;s<t.length;s++){let m=t[s];if(a.occurrencePath.push(e[m].physicalid),c.itemId!==m){if(s%2==1&&null!=e[m]["ds6w:label"]&&(a.occurenceTitle=e[m]["ds6w:label"]),s%2==1&&(a.instanceId=m),s%2==0){let t=Object.assign({},e[m]),h=e[a.instanceId],g=a.parentId||c.itemId,f=m,b=a.occurrencePath.join("/"),I=a.parentPath,y=(a.occurrencePath.length-1)/2,v=u[b];if(!v){let m={shouldDisplayChildren:!1};t.instanceTitle=a.occurenceTitle,t.instanceName=a.occurenceTitle,t.instanceId=a.instanceId,t.parentId=g,t.instanceCount=1,t.relationid=a.instanceId,t.level=y;let f=t["ds6w:type"];t["ds6w:type_value"]=f,t["ds6w:type"]=i["ds6w:type"][f];let A=t["ds6w:status"];if(t["ds6w:status_value"]=A,t["ds6w:status"]=i["ds6w:status"][A],t["ds6wg:PLMReference.V_isLastVersion"]="TRUE"===t["ds6wg:PLMReference.V_isLastVersion"],t.islastrevision="TRUE"===t.islastrevision,t["ds6w:reserved"]="TRUE"===t["ds6w:reserved"],t["ds6w:manufacturable"]="TRUE"===t["ds6w:manufacturable"],t["ds6w:created"]=r.getformatedDate(t["ds6w:created"]),t["ds6w:modified"]=r.getformatedDate(t["ds6w:modified"]),t.treeOrder=h["ro.plminstance.V_treeorder"],t.coreMaterial="Loading...",t.coreMaterialId="Loading...",t.Alternate="Loading...",t["ds6w:alternate"]="Loading...",o.isPhyProd(t["ds6w:type"])||(t.unitNLS="loading...",t.unit="loading...",t.quantity=void 0),"MustBeMadeFrom"===h.type){if(t.madeFrom=!0,t.asRequired="TRUE"===h["ro.madefromquantity_AsRequired.AsRequired"],t.isComputed="TRUE"===h["ds6wg:madefrom_referencedescription.iscomputed"],t.ReferenceName=h["ds6wg:madefrom_referencedescription.referencename"],t.madeFromRelationId=h.resourceid,t.madeFromParentID=h.from,t.madeFromProductType={dbName:t["ds6w:type_value"],nlsLabel:t["ds6w:type"]},o.isRawMaterial(f)||o.isFormulatedProduct(f)){let e=o.isRawMaterial(f)?t["ds6wg:raw_material.v_dimensiontype"]:t["ds6wg:formulated_product.v_dimensiontype"];t.dimensionType={dbName:e,nlsLabel:e}}t.instanceName="",t.instanceTitle=""}else(o.isRawMaterial(f)||o.isFormulatedProduct(f))&&(t.asRequired="TRUE"===h["ro.VPMInstanceQuantity_AsRequired.AsRequired"],t.CQInstance=!0);(v=new M(m).set(t,!1)).updateAddtitionalValues(),v.currentTabKey=c.currentTabKey,v.appCore=c.appCore,v.currentPath=b;let C=u[I];if(C){if(o.isFormulatedProduct(C.getAttributeValue("ds6w:type_value")))break;C.addChild(v),C.getChildren().sort((e,t)=>parseFloat(e.treeOrder)-parseFloat(t.treeOrder)),v.parentNodeModel=C}else p.push(v),v.parentNodeModel=c.specModel;if(d&&n===s&&(d[t.physicalid]||l.has(t.physicalid))){let i=l.has(t.physicalid);(i?d[g]:d[t.physicalid]).forEach(t=>{let n=Object.assign([],a.occurrencePath);n.push(t.relId),n.push(t.madeFromProduceId);let s=n.join("/"),d=(n.length-1)/2,l=Object.assign({},e[t.madeFromProduceId]),u=e[t.relId],m=v.getAttributeValue("physicalId"),h=d;l.instanceId=t.relId,l.parentId=m,l.instanceCount=1,l.relationid=t.relId,l.level=h,l.islastrevision=l.isLastVersion,l["ds6w:reserved"]="TRUE"===l["ds6w:reserved"],l["ds6w:manufacturable"]="TRUE"===l["ds6w:manufacturable"],l["ds6w:created"]=r.getformatedDate(l["ds6w:created"]),l["ds6w:modified"]=r.getformatedDate(l["ds6w:modified"]),l.ReferenceName=u["ds6wg:madefrom_referencedescription.referencename"],l.coreMaterial="Loading...",l.coreMaterialId="Loading...",l.Alternate="Loading...",l["ds6w:alternate"]="Loading...",l.madeFromProductTitle=l["ds6w:label"],l.madeFromProductID=l.resourceid,l.madeFromRelationId=l.instanceId,l.madeFrom=!0,l.isMakeFromFullyLoaded=!0,o.isRawMaterial(l["ds6w:type_value"])||o.isFormulatedProduct(l["ds6w:type_value"])?(l.asRequired="TRUE"===u["ro.madefromquantity_AsRequired.AsRequired"],l.isComputed="TRUE"===u["ds6wg:madefrom_referencedescription.iscomputed"],l.madeFromParentID=u.from,l.madeFromProductType={dbName:l["ds6w:type_value"],nlsLabel:l["ds6w:type"]},l.unit={dbName:u.unit,nlsLabel:u.unitNLS},l.quantity=u.quantity,l.qty_unit=u.quantity+" "+u.unit):(l.unitNLS="",l.quantity="");let g=new M({shouldDisplayChildren:!1}).set(l,!1);if(g.updateAddtitionalValues(),i)if(C){if(o.isFormulatedProduct(C.getAttributeValue("ds6w:type_value")))return;C.addChild(g),C.getChildren().sort((e,t)=>parseFloat(e.treeOrder)-parseFloat(t.treeOrder)),g.parentNodeModel=C}else p.push(g),g.parentNodeModel=c.specModel;else v.addChild(g),g.parentNodeModel=v;g.currentTabKey=c.currentTabKey,g.appCore=c.appCore,g.currentPath=s})}u[b]=v}v&&(a.parentId=f,a.parentPath=b)}}else a.parentId=m}});var h=widget.getValue(m.PERSISTENCY_BOM_VIEW);void 0===h&&(h=!0),p.sort((e,t)=>parseFloat(e.options.treeOrder)-parseFloat(t.options.treeOrder));let g=h?c.getGroupNodesOnQuantityV2(p):p,f=[];for(let e in g){let t=g[e];a||t.addChild(new M({shouldDisplayChildren:!1})),f.push(t)}c.bomGrid.addRootNodes(f),a&&c.bomGrid.getTreeDocument().withTransactionUpdate(()=>{c.bomGrid.gridTreeDocument.itemModelMapping=[],c.expand_nodes(f,n,!0)}),s.unmaskLoader(c.container)},updateVisibleNodes:async function(e){let i=this;if(e&&0!==e.length){let{ids:n,instIds:s,cqInstIds:d,mbmfInstIds:l}=e.filter(e=>null!=e.getAttributeValue("physicalId")&&null!=e.getAttributeValue("isFullyLoaded")&&!e.getAttributeValue("isFullyLoaded")).map(e=>(e.setAttribute("isFullyLoaded",!0),e)).reduce((e,t)=>{let i=t.currentPath.split("/"),a=(t.getAttributeValue("ds6w:type_value"),i[i.length-1]),n=i[i.length-2],r=e.ids;if(r||(r=new Set,e.ids=r),r.add(a),t.getAttributeValue("CQInstance")){let t=e.cqInstIds;t||(t=new Set,e.cqInstIds=t),t.add(n)}if(t.getAttributeValue("madeFrom")&&!t.getAttributeValue("isMakeFromFullyLoaded")){let t=e.mbmfInstIds;t||(t=new Set,e.mbmfInstIds=t),t.add(n)}let o=e.instIds;return o||(o=new Set,e.instIds=o),o.add(i[i.length-2]),e},{});if(!n)return;n=Array.from(n),s=Array.from(s),d=Array.from(d||new Set),l=Array.from(l||new Set);let c=[];c.push((new G).fetchItemData(n,["preview_url"])),c.push(new P({id:"getAttributeDetails"}).getDetails({lIds:n,relIDs:[],busIDs:[],plmparameters:"false",attributes:"true",navigateToMain:"false",readonly:"true",debug_properties:""}));let u=new v,p={};p.references=n,p.with_partials=!0,c.push(u.fetchCoreMatDetails(p)),c.push(i.service.fetchAlternateInfo(n)),c.push(new P({id:"SpecAndRelatedInfoBulk"}).invoke({mask:"SpecAndRelatedInfoObjectMask",data:{ids:n}}));let h=d&&d.length>0;h&&c.push((new C).getContQtyInstances(d));let f=l&&l.length>0;if(f){var a={};a.connectionids=l,c.push(u.getMBMF(a))}let b=!1;if(!widget.getValue(m.PERSISTENCY_BOM_VIEW)){let e=r.getInstanceCustomAttributesData()||[];if(b=e.length>0){let t={attributes:e,relIds:s};c.push(new P({id:"getAttributeDetails"}).getInstanceTypeData(t))}}let M=await t.allSettled(c),I={};M[0].value.results.forEach(e=>{if(e){let a=void 0,n=void 0;var t=e.attributes;if(t)for(var i=0;i<t.length;i++)"preview_url"===t[i].name?a=t[i].value:"resourceid"===t[i].name&&(n=t[i].value);if(n){let e=I[n];e||(e={},I[n]=e),e.thumbnail=a}}}),M[1].value.results.forEach(e=>{if(e){let t=e.data;const a=e.physicalID;let n=I[a];n||(n={},I[a]=n,n.custom_attributes={});let r=n.custom_attributes;r||(r={},n.custom_attributes=r),t&&t.forEach(e=>{e.value?e.type&&"boolean"===e.type?r[i.currentTabKey+e.path]=e.value[0].toString():r[i.currentTabKey+e.path]=e.value:r[i.currentTabKey+e.path]=""})}});let y=M[2];if("rejected"===y.state)g.displayNotification({eventID:"error",msg:B.Error_Material_load});else{let e=y.value;if(e)for(const[t,i]of e.entries()){let e=i.physicalid,a=i.V_Name?i.V_Name:"",n=i.revision?i.revision:"-",r=I[t];r||(r={},I[t]=r),r.coreMaterial=a+" "+n,r.coreMaterialId=e}}let A=M[3].value;if(A)for(const e in A.AlternateItemInfo){let t=I[e];t||(t={},I[e]=t),t.Alternate="Yes",t["ds6w:alternate"]=B.label_yes}if(M[4].value.member.forEach(e=>{const t=e["@id"];let a=I[t];a||(a={},I[t]=a,a.SpecAndRelatedInfoObjectMask={});let n=a.SpecAndRelatedInfoObjectMask;if(n||(n={},a.SpecAndRelatedInfoObjectMask=n),n.cestamp=e.cestamp,n.currentAccess=e.access||"",e.specificationReport){let t=e.specificationReport.member[0];if(n.specReportPid=t["@id"]||"",n.specReportType=t.typedisplayName||"",n.specReportTypeActualName=t.typeactualName||"",n.specReportTypeSymbolicName=t.symbolicTypeName||"",n.specReportName=t.name||"",n.specReportRevision=t.revision||"",n.specReportMaturity=t.maturitydisplayName||"",n.specReportMaturityActualName=t.maturityactualName||"",n.specReportCreator=t.creator||"",n.specReportDescription=t.description||"",n.specReportTitle=t.title||"",n.specReportCurrentAccess=t.access||"",n.isReportCheckedIn=!(!t.hasReport||""===t.hasReport||null===t.hasReport||void 0===t.hasReport),t.template){var r=t.template.member[0];n.templatePid=r["@id"],n.templateTitle=r.title||"",n.templateName=r.name||"",n.templateRevision=r.revision||"",n.templateState=r.maturityactualName||""}}if(e.changeDetails){var o=e.changeDetails[i.getID()];if(o){if(Array.isArray(o))for(var s=0;s<o.length;s++){var d=o[s];if("Complete"!=d.current){o=d;break}}n.changeActionName=o.name,n.changeActionState=o.current,n.changeActionId=o.physicalid,n.changeActionType=o.type,n.changeActionpolicy=o.policy,n.changeActionRelType=o.relationship,n.changeActionRelID=o["physicalid[connection]"],n.changeActionRequestedFor=o["attribute[Requested Change]"],n.changeActionTitle=o["attribute[Synopsis]"]}}}),h&&M[5].value.result.forEach(e=>{let{instanceId:t,...i}=e,a=I[t];a||(a={},I[t]=a),a.cqInfo=i}),f){M[h?6:5].value.result.forEach(e=>{let{resourceid:t,...i}=e,a=I[t];a||(a={},I[t]=a),a.mbmfInfo=i})}if(b){let e=M[M.length-1].value;e&&e.response.forEach(e=>{let{physicalid:t,...a}=e;if(!t)return;let n=I[t];n||(n={},I[t]=n,n.custom_attributes={});let r=n.custom_attributes;r||(r={},n.custom_attributes=r);for(let e in a){let t=e.split("[")[1];r[i.currentTabKey+t.split("]")[0]]=a[e]}})}return i.canTriggerCellEvents=!1,e.forEach(e=>{let t=e.getAttributeValue("physicalId"),i=e.getAttributeValue("instanceId"),a=I[t],n=I[i];if(!a&&!n)return;if(a=a||{},n)for(let e in n.custom_attributes)a.custom_attributes[e]=n.custom_attributes[e];let r={isFullyLoaded:!0,isMakeFromFullyLoaded:!0};r.Alternate=a.Alternate||"",r["ds6w:alternate"]=a.Alternate||"",r.coreMaterial=a.coreMaterial||"",r.coreMaterialId=a.coreMaterialId||"";let s=void 0;if(n){let t=n.cqInfo;if(t)t.quantity?r.quantity=t.quantity:r.quantity=e.getAttributeValue("quantity")||"",t.quantityUOM?(r.unit=t.quantityUOM.dbName,r.unitNLS=t.quantityUOM.nlsLabel):(r.unit="",r.unitNLS=""),t.quantityType&&(s=t.quantityType.dbName?t.quantityType.dbName:t.quantityType,r.dimensionTypeNLS=t.quantityType.nlsLabel?t.quantityType.nlsLabel:t.quantityType),t.dimensionType&&(s=t.dimensionType,r.dimensionTypeNLS=t.dimensionType),r.asRequiredActualValue=t.asRequired,r.asRequired=t.asRequired,r.CQInstance=!0,r.quantity&&r.unit&&(r.qty_unit=r.quantity+" "+r.unit);else{let t=n.mbmfInfo;t&&(t.quantity?r.quantity=t.quantity:r.quantity=e.getAttributeValue("quantity")||"",t.unit&&(r.unit=t.unit,r.unitNLS=o.getUOMUnits(t.unit)),r.qty_unit=t.quantity+" "+t.unit,r.unitNLS=o.getUOMUnits(t.unit))}}e.updateOptions({grid:r}),e.setCustomAttributes(a.custom_attributes),s&&e.setDimensionType(s),e.setSpecAndRelatedInfoObjectMask(a.SpecAndRelatedInfoObjectMask),e.setThumbnail(a.thumbnail),e.acceptChanges()}),void(i.canTriggerCellEvents=!0)}},_bomExpandTreeV2:async function(e,i){var a=this;s.maskLoader(a.container,B.Loaderloading),i&&(i=i+1+"");try{let e=await this.service.dbExpand({pids:[this.itemId],level:i||"-1"}),{didresourceidAttrMap:n,instIds:r,nodes:d,policies:l,childIds:c,paths:u}=e.results.reduce((e,t)=>{if(t.hasOwnProperty("attributes")){let i=t.attributes.find(e=>"did"===e.name),n=t.attributes.find(e=>"resourceid"===e.name),r=t.attributes.find(e=>"ds6w:type"===e.name),o=t.attributes.find(e=>"ro.plminstance.V_treeorder"===e.name),s=t.attributes.find(e=>"ds6w:policy"===e.name),d=e.didresourceidAttrMap;if(d||(d=new Map,e.didresourceidAttrMap=d),d[i.value]=n.value,s){let t=e.policies;t||(t=new Set,e.policies=t),t.add(s.value)}if(o){let i=e.instIds;i||(i=new Set,e.instIds=i);let a=t.attributes.find(e=>"resourceid"===e.name);a&&i.add(a.value)}let l=e.nodes;l||(l={},e.nodes=l);let c=t.attributes.reduce((e,t)=>(e[t.name]=t.value,e),{});if(c.physicalid=n.value,l[n.value]=c,"VPMInstance"!==r.value){let t=e.childIds;t||(t=new Set,e.childIds=t),n.value!==a.itemId&&t.add(n.value)}}else if(t.hasOwnProperty("path")){let i=e.paths;i||(i=[],e.paths=i),i.push(t.path)}return e},{});if(!r)return a.clearGrid(),await a.getMBMFNodes(this.itemId),void s.unmaskLoader(a.container);let p=(u=u.map(e=>e.map(e=>n[e]))).reduce((e,t)=>{let i=t[t.length-1];return e.add(i),e},new Set),m=[...o.physicalProductArr,...o.rawMaterialArray];(m=m.reduce((e,t)=>(e[t.valueItem]=t.labelItem,e),{})).Formulated_Product=B.Formulated_Product;let h=Array.from(p).reduce((e,t)=>(e.push(a.MBMFService.getMBMFInfo(t)),e),[]),f=await t.allSettled(h),b={},M=f.reduce((e,t)=>{let i=t.value;if(i.result.MadeFromConnections&&i.result.MadeFromConnections.length>0)for(var a=0;a<i.result.MadeFromConnections.length;a++){let t=i.result.MadeFromConnections[a],n=b[t.madeFromParentID];n||(n=[],b[t.madeFromParentID]=n),n.push({relId:t.madeFromRelationId,madeFromProduceId:t.madeFromProductID});let r={};r["ds6wg:madefrom_referencedescription.iscomputed"]=(t.isComputed+"").toUpperCase(),r.treeOrder=t.treeOrder,r["ro.madefromquantity_AsRequired.AsRequired"]=(t.asRequired+"").toUpperCase(),r.quantityType=t.quantityType,r.unit=t.quantityUOM.dbName,r.unitNLS=t.quantityUOM.nlsLabel,r["ds6wg:madefrom_referencedescription.referencename"]=t.ReferenceName,r.quantity=t.quantity,r.physicalid=r.resourceid=t.madeFromRelationId,r.type="MustBeMadeFrom",r.from=t.madeFromParentID,d[t.madeFromRelationId]=r;let o={};o["ds6w:type"]=t.madeFromProductType.dbName,o["ds6w:label"]=t.madeFromProductTitle,o.dimensionType=t.quantityType,o.madeFromProductTitle=t.madeFromProductTitle,o.dimensionType=t.dimensionType,o.cestamp=t.cestamp,o.madeFromProductRevision=t.madeFromProductRevision,o.madeFromProductType=t.madeFromProductType,o.physicalid=o.resourceid=t.madeFromProductID,d[t.madeFromProductID]=o,e.add(t.madeFromProductID)}return e},new Set),I=Array.from(M),y=Array.from(c),A=new Set([...M,...c]),N=Array.from(A),S=I.length>0,T=[];S&&T.push(a.MBMFService.fetchItemInfo(I)),T.push((new G).fetchItemData(y,["preview_url"])),N.forEach(e=>{T.push(new P({id:"getAttributeDetails"}).getDetails({lIds:[e],relIDs:[],busIDs:[],plmparameters:"false",attributes:"true",navigateToMain:"false",readonly:"true",debug_properties:""})),T.push(new P({id:e}).get({mask:"SpecAndRelatedInfoObjectMask",typeActual:d[e]["ds6w:type"],typeName:m[d[e]["ds6w:type"]]}))});let R={},w=await t.allSettled(T);if(S){w[0].value.forEach(e=>{d[e.resourceid]=Object.assign(e,d[e.resourceid])})}(S?w[1]:w[0]).value.results.forEach(e=>{if(e){let a=void 0,n=void 0;var t=e.attributes;if(t)for(var i=0;i<t.length;i++)"preview_url"===t[i].name?a=t[i].value:"resourceid"===t[i].name&&(n=t[i].value);if(n){let e=R[n];e||(e={},R[n]=e),e.thumbnail=a}}}),w.slice(S?2:1).forEach((e,t)=>{if(t%2==0){if(null!=e.value){var i=e.value.results[0].data;const t=e.value.results[0].physicalID;let n=R[t];n||(n={},R[t]=n,n.custom_attributes={});let r=n.custom_attributes;r||(r={},n.custom_attributes=r),i&&i.forEach(e=>{e.value?e.type&&"boolean"===e.type?r[a.currentTabKey+e.path]=e.value[0].toString():r[a.currentTabKey+e.path]=e.value:r[a.currentTabKey+e.path]=""})}}else if(void 0!==e.value.member[0]["@id"]){let t=R[e.value.member[0]["@id"]];t||(t={},R[key]=t,t.SpecAndRelatedInfoObjectMask={});let i=t.SpecAndRelatedInfoObjectMask;i||(i={},t.SpecAndRelatedInfoObjectMask=i);var n=e.value.member[0];if(i.cestamp=n.cestamp,i.currentAccess=n.access||"",n.specificationReport){var r=n.specificationReport.member[0];if(i.specReportPid=r["@id"]||"",i.specReportType=r.typedisplayName||"",i.specReportTypeActualName=r.typeactualName||"",i.specReportTypeSymbolicName=r.symbolicTypeName||"",i.specReportName=r.name||"",i.specReportRevision=r.revision||"",i.specReportMaturity=r.maturitydisplayName||"",i.specReportMaturityActualName=r.maturityactualName||"",i.specReportCreator=r.creator||"",i.specReportDescription=r.description||"",i.specReportTitle=r.title||"",i.specReportCurrentAccess=r.access||"",i.isReportCheckedIn=!(!r.hasReport||""===r.hasReport||null===r.hasReport||void 0===r.hasReport),r.template){var o=r.template.member[0];i.templatePid=o["@id"],i.templateTitle=o.title||"",i.templateName=o.name||"",i.templateRevision=o.revision||"",i.templateState=o.maturityactualName||""}}if(n.changeDetails){var s=n.changeDetails[a.getID()];if(s){if(Array.isArray(s))for(var d=0;d<s.length;d++){var l=s[d];if("Complete"!=l.current){s=l;break}}i.changeActionName=s.name,i.changeActionState=s.current,i.changeActionId=s.physicalid,i.changeActionType=s.type,i.changeActionpolicy=s.policy,i.changeActionRelType=s.relationship,i.changeActionRelID=s["physicalid[connection]"],i.changeActionRequestedFor=s["attribute[Requested Change]"],i.changeActionTitle=s["attribute[Synopsis]"]}}}});let _=new v;l&&l.size>0?_.getStatesNLS({policies:Array.from(l)}).then(e=>{let n=e.policies.reduce((e,t)=>{let{policyName:i,states:a}=t;return a.forEach(t=>{let a=i+"."+t.stateSysName;e[a]=t.stateUserName}),e},{});a.loadTreeStructure(d,u,n,i?parseInt(i):void 0,R,b);let o=[];if(N&&N.length>0){let e={};e.references=N,e.with_partials=!0,o.push(_.fetchCoreMatDetails(e))}if(N&&N.length>0&&o.push(a.service.fetchAlternateInfo(N)),r&&r.size>0){Array.from(r),o.push((new C).getContQtyInstances(Array.from(r)))}t.allSettled(o).then(e=>{let t={},i={},n={};a.canTriggerCellEvents=!1,e.forEach((e,a)=>{let r=e.value;if(r)if(0===a)for(const[e,t]of r.entries()){let a=t.physicalid,n=t.V_Name?t.V_Name:"",r=t.revision?t.revision:"-",o=i[e];o||(o={},i[e]=o),o.coreMaterial=n+" "+r,o.coreMaterialId=a}else if(1===a)for(const i in e.value.AlternateItemInfo){let e=t[i];e||(e={},t[i]=e),e.Alternate="Yes",e["ds6w:alternate"]=B.label_yes}else r.result.forEach(e=>{let{instanceId:t,...i}=e,a=n[t];a||(a={},n[t]=a),n[t]=Object.assign(a,i)})}),a.bomGrid.getTreeDocument().getAllDescendants().forEach(e=>{if("function"!=typeof e.getID)return;let a=e.getAttributeValue("physicalId"),r=e.getAttributeValue("instanceId"),o=i[a]||{},s=t[a]||{},d=n[r],l={};l.coreMaterial=o.coreMaterial||"",l.coreMaterialId=o.coreMaterialId||"",l.Alternate=s.Alternate||"",l["ds6w:alternate"]=s.Alternate||"",d&&Object.keys(d).length>0&&(d.quantity&&(l.quantity=d.quantity),d.quantityUOM&&(l.unit=d.quantityUOM.dbName,l.unitNLS=d.quantityUOM.nlsLabel),d.quantityType&&(l.dimensionType=d.quantityType.dbName,l.dimensionTypeNLS=d.quantityType.nlsLabel),l.asRequiredActualValue=d.asRequired,l.asRequired=d.asRequired,l.CQInstance=!0,l.qty_unit=l.quantity+" "+l.unit),e.updateOptions({grid:l}),e.acceptChanges()}),a.canTriggerCellEvents=!0,a.updateReferenceList()})}):s.unmaskLoader(a.container)}catch(e){console.error(e),g.displayNotification({eventID:"error",msg:B.Failure_Products})}finally{s.unmaskLoader(a.container)}},_bomExpandTree:function(){let e=!1;this.bomGrid.getTreeDocument().getAllDescendants().forEach(t=>{t.isExpanded()||null===t.options.children||(e=!0,t.expand())}),this.expandLevel--,this.expandLevel<0?this.expandInProgress=!!e:0!=this.expandLevel&&e||(this.expandInProgress=!1),this.expandInProgress||s.unmaskLoader(this.container)},bomCollapseAll:function(){this.bomGrid.model.collapseAll()},_launchCreateScreen:function(){var e=this,t={};t.appCore=e.appCore;var i=e.bomGrid.getTreeDocument().getSelectedNodes();let a=widget.getValue(m.PERSISTENCY_BOM_VIEW);if(e.isReferenceView=null==a||!0===a,i&&1===i.length){if(i[0].getMBMFChild())return void N.getMsgAddNodeOnMBMFParent();e.isReferenceView&&!e.isTileView?(t.parentId=i[0].getPhysicalId(),t.parentTitle=i[0].getTitle()):e.isTileView||!e.isReferenceView?(e.isTileView&&e.bomGrid.tileManager&&e.bomGrid.tileManager.grid.unselectAll(),e.bomGrid.getTreeDocument().unselectAll(),t.parentId=e.itemId,t.parentTitle=e.itemTitle,g.displayNotification({eventID:"info",msg:B.Info_AddItemTileUsageView})):(t.parentId=e.itemId,t.parentTitle=e.itemTitle)}else{if(i&&i.length>1)return void g.displayNotification({eventID:"error",msg:B.Error_Add_BOMChildren});{t.parentId=e.itemId,t.parentTitle=e.itemTitle;let i=e.bomGrid.model.getRoots();if(i.length>0)for(var n=0;n<i.length;n++)if(i[n].getMadeFrom())return void N.getMsgAddNodeOnMBMF()}}t.onCreateSuccess=t.createAction=function(t,a,n){let r=t;e.createNodeFromId(r).then(function(t){e.updateFetchMode();var a=t[0];n&&(a.setInstanceId(n.relationshipID),a.addInstanceIds(n.relationshipID),a.setParentId(n.fromID),a.setInstanceTitle(n.relationshipname),a.setInstanceName(n.relationshipname));let r=null;e.isTileView&&e.bomGrid.tileManager?(r=e.bomGrid.tileManager.model.getSelectedNodes(),e._addNewNode(a,r,!0)):(r=e.bomGrid.getTreeDocument().getSelectedNodes(),e._addNewNode(a,r,!0)),a.sync();let o=e.bomGrid.getTreeDocument().getAllDescendants().filter(e=>e.getAttributeValue("physicalId")===i[0].getAttributeValue("physicalId")&&!e.isSelected());i.push(...o),i.forEach(t=>{"noExpandState"===t._expandState&&t.setState({state:"expanded"}),null===t.getChildren()&&"collapseState"===t._expandState&&(t.collapse(),t.expand()),"expandState"!==t._expandState&&null!=t.getChildren()&&e.expand_nodes(i),null!==t.getChildren()&&t.expand()})}).catch(function(e){console.error(e)})},new h(t).execute()},_launchSearch:async function(e){const t=await y._getSearchCriteria(this.appCore.immersiveFrame,this.appCore.immersiveFrame.elements.container.querySelector("div.multigrid-bom-container div.enox-collection-toolbar-actions span.fonticon-plus"));var i=this.bomGrid.getTreeDocument().getSelectedNodes();if(i&&i.length>1)g.displayNotification({eventID:"error",msg:B.Error_Add_BOMChildren});else{let a=!1;switch(["addMBMFRawMat","addRawMat"].includes(e)&&(a=!0),e){case"addMBMFItem":case"addMBMFRawMat":case"addMBMFFP":this._addExistingMBMF(a,t,i,e);break;case"add":case"addFP":case"addRawMat":this._addExisting(a,t,e)}}},_addExistingMBMF:function(e,t,i,a){let n=this.bomGrid.getGridNodes().filter(function(e){return e.IsComputed()});if(n&&n.length>0)return void N.getMsgAddNodeOnLayeredProd();let r={appCore:this.appCore,currentTabKey:this.currentTabKey,container:this.container,bomGrid:this.bomGrid,isReferenceView:this.isReferenceView,isTileView:this.isTileView,specModel:this.specModel,modelEvents:this.modelEvents,isMBMF:!0,callBack:this.getMBMFNodes,excludeList:[]};"addMBMFFP"===a&&(r.isMBMFFP=!0),new T(r).triggerSearch({searchOnlyRawM:e,query:t})},_addExisting:function(e,t,i){var a=this.bomGrid.getTreeDocument().getSelectedNodes();if(a&&0===a.length&&this.isReferenceView&&!this.isTileView){this.specModel;let e=this.bomGrid.model.getRoots();if(e.length>0)for(var n=0;n<e.length;n++)if(e[n].getMadeFrom())return void N.getMsgAddNodeOnMBMF()}else if(a&&1===a.length){if(a[0].getMBMFChild())return void N.getMsgAddNodeOnMBMFParent();this.isReferenceView&&!this.isTileView?a[0]:this.isTileView||!this.isReferenceView?(this.bomGrid.getTreeDocument().unselectAll(),this.specModel,g.displayNotification({eventID:"info",msg:B.Info_AddItemTileUsageView})):this.specModel}else this.specModel;var r={};r.appCore=this.appCore,r.currentTabKey=this.currentTabKey,r.container=this.container,r.bomGrid=this.bomGrid,r.isReferenceView=this.isReferenceView,r.isTileView=this.isTileView,r.specModel=this.specModel,r.modelEvents=this.modelEvents,"addFP"===i&&(r.isFP=!0);new S(r).launchAddInstance({searchOnlyRawM:e,query:t})},_removeOrDeleteNodes:function(e){var t=this.bomGrid.getTreeDocument().getSelectedNodes();if(t&&t.length>0)if("remove"===e){var i=!!t[0].getMadeFrom();if(t.length>=1&&i&&t[0].parentNodeModel){var a=t[0].options.grid.referenceName;" EngineeringItemModel"==t[0].parentNodeModel.options.grid.modelType&&t[0].parentNodeModel.removereferencevalue(a)}for(var n=0;n<t.length-1&&t.length>1;n++){var r=!!t[n+1].getMadeFrom();if(r&&t[n+1].parentNodeModel){a=t[n+1].options.grid.referenceName;" EngineeringItemModel"==t[n+1].parentNodeModel.options.grid.modelType&&t[n+1].parentNodeModel.removereferencevalue(a)}if(!r===i)return void g.displayNotification({eventID:"error",msg:B.Error_Remove_MBMF_VPMInstance})}p.launchUPSUnparent({data:t})}else"delete"===e&&p.deleteItem({data:t});else{var o="";"delete"===e?o=B.actionErrMsgDelete:"remove"===e&&(o=B.actionErrMsgRemove),g.displayNotification({eventID:"error",msg:B.NoItemSelected+o})}},_launchAdvancedFilter:function(e){var t=this.bomGrid.getTreeDocument().getSelectedNodes(),i=this.specModel;this.appCore.specRouteManager.setActiveSpecItem(i),this.appCore.specRouteManager.setSelectedNodes(t);var a={};a.appCore=this.appCore,a.physicalid=this.itemId,a.commandId=e,p.launchAdvancedFilter(a)},_mapFetchAndCQResponse:function(e,t){for(var i=this.bomGrid.getTreeDocument().getSelectedNodes(),a=[],n=0;n<e.length;n++){var r=e[n];if(r){for(var o=0;o<t.length;o++){var s=t[o];if(r.physicalid===s.id){r["ds6w:responsible"]&&(s.owner=r["ds6w:responsible"]),Object.assign(r,s);var d=new M({shouldDisplayChildren:!0}).set(r);d.currentTabKey=this.currentTabKey,d.appCore=this.appCore,a.push(d),this._addNewNode(d,i,!0),this.bomGrid.getTreeDocument().acceptChanges(),i&&i.length>0?i[0].getTitle():(this.itemTitle,d.parentNodeModel=this.service.parentNodeModel)}}this.setMatInfoOnNodes(a,null)}}},evt_AddCQNodeBOMSuccess:function(e){var i=this;i.updateFetchMode();let a=!0;if(e&&e.hasOwnProperty("canExpand")&&(a=e.canExpand),e&&e.nodes){for(var n=[],r=[],o=0;o<e.nodes.length;o++){var s=e.nodes[o].child,d=e.nodes[o],l={};(l=Object.assign(d,s)).parentid=d.parent||d.parentId,l.instanceName=d.instanceTitle,l["ds6w:type"]=s.type.nlsLabel,l["ds6w:type_value"]=s.type.dbName,l.instanceType=d.instanceType.dbName||d.instanceType,d.quantityUOM&&(l.unit=d.quantityUOM),d.quantityType&&(l.dimensionType=d.quantityType),d.quantity||(l.quantity=null),l.CQInstance=!0,l.asRequired=!!l.asRequired&&l.asRequired;let{quantityType:t,quantityUOM:a,...u}=l;r.push(u);var c=i.service.fetchItemInfo([l.id]);n.push(c)}t.all(n).then(function(e){if(e&&e.length>0){i._mapFetchAndCQResponse(e,r);var t=i.bomGrid.getTreeDocument().getSelectedNodes();if(0==t.length)return;let a=i.bomGrid.getTreeDocument().getAllDescendants().filter(e=>e.getAttributeValue("physicalId")===t[0].getAttributeValue("physicalId")&&!e.isSelected());t.push(...a),t.forEach(e=>{"noExpandState"===e._expandState&&e.setState({state:"expanded"}),null===e.getChildren()&&"collapseState"===e._expandState&&(e.collapse(),e.expand()),"expandState"!==e._expandState&&null!=e.getChildren()&&i.expand_nodes(t),null!==e.getChildren()&&e.expand()})}}).catch(function(e){console.error(e),g.displayNotification({eventID:"error",msg:L.Error_AddCQ})})}},evt_addMBMFNodes:function(e){let t=this;if(!e.success||!Array.isArray(e.resp))return;(new v).checkMaterialMismatch(t.itemId).then(e=>{t.modelEvents.publish({event:"item-view-manager-material-icon-update",data:e.result})});let i=new Map;e.resp.forEach(e=>{i.set(e.madeFromProductID,e)});let a=t.bomGrid.getTreeDocument().getSelectedNodes()?t.bomGrid.getTreeDocument().getSelectedNodes()[0]:null,n=!!a;t.updateFetchMode(),N.postMBMFInfo(Array.from(i.keys()),e.resp,null,e.resp[0].madeFromParentID).then(e=>{let i={MBMFInfo:e,VPMInstanceNodes:[],selNodes:a,isSelected:n,invokedFromSearch:!1};t.postGetMBMFDetails(i)})},_notifyError:function(e){e=e||B.DeleteMutipleFailed;this.singleItem&&(e=B.replace(B.get("Error_Get_MBMF"),{title:this.nodes[0].getTitle()})),g.displayNotification({eventID:"error",msg:e}),s.unmaskLoader(widget.body)},_subscribeEvents:function(){var i=this;this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"xsr-grid-lazy-load-"+this.currentTabKey},async function(e){await i.updateVisibleNodes(e)})),this.platformXENAlternateSubscription=a.subscribe("XEN/PUBLIC_EVENT/ENGINEERING_ITEM/ALTERNATE_UPDATED",function(e){i.updateFetchMode(),i._updateAlternateItemInfo(e)}),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"xsr-reorder-event-update"},function(e){i.isReorderTriggered&&(i.isReorderTriggered=!1,i.bomGrid.model.getUseChangeTransactionMode()||i.bomGrid.model.setUseChangeTransactionMode(!0))})),i.appCore&&i.appCore.basicModelEvents&&i.appCore.basicModelEvents.subscribe({event:"XSR-REORDER-TRIGGER-UPDATE"},()=>{i.isReorderTriggered=!0}),this.modelEvents.subscribe({event:"XSR-CUSTOM-VIEW-SAVE"},function(){i.updateBOMToolBarCmds()}),a.subscribe("XSR/PUBLIC_EVENT/MAKE_FROM_UPDATE",function(e){i.updateFetchMode(),i.canTriggerCellEvents=!1;let t=e[0].details.asRequired,a=e[0].details.dimensionType,n=e[0].details.quantity,r=e[0].details.unit,o=e[0].details.unitNLS;i.bomGrid.getTreeDocument().getAllDescendants().forEach(i=>{e[0]&&e[0].details.madeFromRelationId===i.getAttributeValue("madeFromRelationId")&&(i.updateOptions({grid:{asRequired:t,dimensionType:a,quantity:n,unit:r,unitNLS:o}}),i.acceptChanges())}),i.canTriggerCellEvents=!0}),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:m.EVENT_BOM_GRID_ICON_CLICK},function(e){if("Alternate"===e.column){let t={commandId:m.INFORMATION_CMD,selectedNode:e.cellInfo.nodeModel,appCore:i.appCore,selectFacet:m.FACET_ALTERNATE};f.launch(t)}})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:m.SPECS_EXPAND_NODES+"-"+this.currentTabKey},e=>i.evt_SpecsExpandNodes(e))),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"reorder-close-event-listener-bom"},e=>{let t=function(e){"click"==e.type?i.bomGrid.model.setUseChangeTransactionMode(!1):"close"==e.type&&i.bomGrid.model.setUseChangeTransactionMode(!0)};e?(e.reorderDlg._dialog.addEventListener("close",t,!1),e.reorderDlg._dialog.buttons.Ok.addEventListener("click",t,!1)):i.bomGrid.model.setUseChangeTransactionMode(!0)})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"xsr-add-item-on-drop"},function(e){if(e.length>0){var a=[];e.forEach(function(e){var t=i.createNodeFromId(e.id);a.push(t)})}t.all(a).then(function(e){var t=[];if("object"==typeof e&&e.length>0){for(let i=0;i<e.length;i++)t.push(e[i][0].options.grid);var a={};if(a.appCore=i.appCore,a.currentTabKey=i.currentTabKey,a.container=i.container,a.bomGrid=i.bomGrid,a.isReferenceView=i.isReferenceView,a.isTileView=i.isTileView,a.specModel=i.specModel,a.modelEvents=i.modelEvents,i.bomGrid.getTreeDocument().getOriginalGridRoots().some(e=>void 0!==e.getMadeFrom()))return void N.getMsgAddNodeOnMBMF();new S(a).CreateDragAndDrop(t)}})}));var n=!1;this._bomSubscriptionList.push(this.modelEvents.subscribe({event:m.EVENT_GRID_TOTAL_SELECTED_NODES},async function(e){const{count:t,currentModel:a}=e;let r=!1;i.selectedGridCount=t,i.selectedGridNodes=a,n=!1;let s=widget.getValue(m.PERSISTENCY_BOM_VIEW);void 0===s&&(s=!0,widget.setValue(m.PERSISTENCY_BOM_VIEW,!0)),!1===s&&(r=i.selectedGridNodes.some(e=>e.options.grid.madeFromRelationId&&null!=e.options.grid.madeFromRelationId))&&i.bomGrid.toolbar.disableCommands(["AuthPaste"]);const d=i.containsReleasedOrObsolete(i.selectedGridNodes),l=1===i.selectedGridCount,c=0===i.selectedGridCount,u=i.appCore.localStorage.xSpecData.hasOwnProperty("clipboard"),p=i.selectedGridNodes.some(e=>{const t=e.getAttributeValue("ds6w:type");return o.isRawMaterial(t)||o.isFormulatedProduct(t)||o.isFormulatedProduct(e.getAttributeValue("ds6w:type_type"))});if(d&&i.bomGrid.toolbar.disableCommands(["AuthPaste"]),p?i.bomGrid.toolbar.disableCommands(["add"]):i.bomGrid.toolbar.enableCommands(["add"]),l){const e=i.selectedGridNodes[0].getTypeActualName(),t=o.isFormulatedProduct(e),a=o.isRawMaterial(e),l=null!=i.selectedGridNodes[0].getAttributeValue("madeFromRelationId"),c="expandState"===i.selectedGridNodes[0]._expandState,p="collapseState"===i.selectedGridNodes[0]._expandState,m=p&&(null===i.selectedGridNodes[0].getAllDescendants()||i.selectedGridNodes[0].getAllDescendants().length<2),h=p&&i.selectedGridNodes[0].getAllDescendants().length>=2&&i.selectedGridNodes[0].getAllDescendants().some(e=>null!=e.getAttributeValue("physicalId")&&null!=e.getAttributeValue("madeFromRelationId"));s||(i.bomGrid.toolbar.disableCommands(["add"]),c||h||l||m?i.bomGrid.toolbar.disableCommands(["reorder"]):i.bomGrid.toolbar.enableCommands(["reorder"])),t||a||i.specModel.has3DPart()?i.bomGrid.toolbar.disableCommands(["add","AuthPaste","reorder"]):s||!u||r||d||i.bomGrid.toolbar.enableCommands(["AuthPaste"]),c?await i.MBMFService.getMBMFInfo(i.selectedGridNodes[0].getID()).then(function(e){e&&e.success?e.result.MadeFromConnections&&e.result.MadeFromConnections.length>0&&(i.bomGrid.toolbar.disableCommands(["AuthPaste"]),n=!0):i._notifyError()}).catch(function(e){var t="";e&&!e.success&&(t=B.Error_Get_MBMF),i._notifyError(t)}):i.selectedGridNodes[0].getNumberOfDescendants()>0&&i.selectedGridNodes[0].getAllDescendants().some(e=>null!=e.getAttributeValue("physicalId")&&null!=e.getAttributeValue("madeFromRelationId"))&&i.bomGrid.toolbar.disableCommands(["AuthPaste"]),i.selectedGridNodes[0].getNumberOfDescendants()>1?i.selectedGridNodes[0].getAllDescendants().some(e=>null!=e.getAttributeValue("physicalId")&&null!=e.getAttributeValue("madeFromRelationId"))?i.toggleMBMFCommand(!0,!0):i.toggleMBMFCommand(!0,!1):i.toggleMBMFCommand(!0,!0)}else c&&(s&&i.bomGrid.toolbar.enableCommands(["add"]),s||(i.specModel.hasMBMFConnection()?i.bomGrid.toolbar.disableCommands(["reorder"]):i.bomGrid.toolbar.enableCommands(["reorder"]),i.bomGrid.toolbar.disableCommands(["add"])),s||!u||i.specModel.has3DPart()||i.bomGrid.toolbar.enableCommands(["AuthPaste"])),s||c||i.bomGrid.toolbar.disableCommands(["add"]),i.toggleMBMFCommand(!0,!1);if(i.selectedGridCount>1){const e=i.selectedGridNodes.some(e=>{const t=e.getAttributeValue("ds6w:type");return o.isRawMaterial(t)||o.isFormulatedProduct(t)||o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value"))});s||r||e||!u||d?s||r&&e&&d||i.bomGrid.toolbar.disableCommands(["AuthPaste"]):i.bomGrid.toolbar.enableCommands(["AuthPaste"]),i.bomGrid.toolbar.disableCommands(["reorder"]),i.selectedGridNodes.some(e=>"expandState"!==e._expandState)&&i.selectedGridNodes.some(e=>null!=e.options.grid.MBMFChild)&&i.bomGrid.toolbar.disableCommands(["AuthPaste"])}else c&&!s&&u&&!i.specModel.has3DPart()&&i.bomGrid.toolbar.enableCommands(["AuthPaste"]);if(!c||"function"!=typeof i.specModel.getMaturityActualName||"RELEASED"!==i.specModel.getMaturityActualName()&&"OBSOLETE"!==i.specModel.getMaturityActualName()||i.bomGrid.toolbar.disableCommands(["add"]),!1===s){let e=i.bomGrid.gridView,t=!1;if(e){let i=e._customViewsManager._customViews[0];i&&i.groupingOptions&&i.groupingOptions.dataIndexesToGroup&&i.groupingOptions.dataIndexesToGroup.length>0&&(t=!0)}t&&i.bomGrid.toolbar.disableCommands(["reorder"])}})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:m.EVENT_LAUNCH_PREV_NEXT_COMMAND},e=>i.evt_LanchPrevNextCommand(e))),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"bom-grid-fetch-mode-update"},function(e){i.updateFetchMode()})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-sync-node-data"},function(e){e&&Array.isArray(e)?e.forEach(function(e){i.syncNodeBasedOnID(e)}):e&&i.syncNodeBasedOnID(e)})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-toolbar-commands-update"},function(e){i.bomGrid.toolbar.disableCommands(["add","removeitem","deleteItem","AuthPaste"])})),this.platFormSubscrpition=a.subscribe("DS/PADUtils/PADCommandProxy/refresh",function(t){t.data.authored&&t.data.authored.modified&&(i.updateFetchMode(),t.data.authored.modified.forEach(function(t){var a;e.is(t,"object")?a=t.physicalid:e.is(t,"string")&&(a=t),i.syncNodeBasedOnID(a),i.basicModelEvents.publish({event:m.EVENT_INFORMATION_PANEL_REFRESH})}))}),this.platFormSubscrpition=a.subscribe("DS/Information/CommandProxy/AddExtension",function(t){t.authored&&t.authored.modified&&(i.updateFetchMode(),t.authored.modified.forEach(function(t){var a;e.is(t,"object")?a=t.physicalid:e.is(t,"string")&&(a=t),i.syncRemoveCustomDataNode(a),i.syncNodeBasedOnID(a),i.basicModelEvents.publish({event:m.EVENT_INFORMATION_PANEL_REFRESH})}))}),this.platFormXENSubscrpition=a.subscribe("XEN/PUBLIC_EVENT/ENGINEERING_ITEM/PART_NUMBER_UPDATED",function(e){if(e&&Array.isArray(e.references)){var t=e.references;i.updateFetchMode();for(var a=0;a<t.length;a++){var n=t[a].physicalid;i.syncNodeBasedOnID(n),i.basicModelEvents.publish({event:m.EVENT_INFORMATION_PANEL_REFRESH})}}}),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:m.GRID_CONTEXT_MENU+"-bom"},async function(e){var t=i.bomGrid.getTreeDocument().getSelectedNodes();const a="expandState"===i.selectedGridNodes[0]._expandState;e.gridInstance=i.bomGrid;let n=widget.getValue(m.PERSISTENCY_BOM_VIEW);null==n&&(n=!0);let r=i.containsReleasedOrObsolete(t);var s=["Information_Widget","Alternates"];if(n&&(s.push("UPSAuthCut"),s.push("UPSAuthCopy"),s.push("UPSAuthPaste"),s.push("UPSAuthReorderProduct")),n||(s.push("UPSAuthUnparent"),s.push("DeleteItem")),r&&s.push("UPSAuthPaste"),a)await i.MBMFService.getMBMFInfo(t[0].getID()).then(function(e){e&&e.success?e.result.MadeFromConnections&&e.result.MadeFromConnections.length>0&&(s.push("UPSAuthCut"),s.push("UPSAuthCopy"),s.push("UPSAuthPaste")):i._notifyError()}).catch(function(e){var t="";e&&!e.success&&(t=B.Error_Get_MBMF),i._notifyError(t)});else for(var d=0;d<t.length;d++)null!=t[d].getAttributeValue("physicalId")&&null!=t[d].getAttributeValue("madeFromRelationId")&&(s.push("UPSAuthCut"),s.push("UPSAuthCopy"),s.push("UPSAuthPaste"));if(t&&t.length>1){let i=t.some(e=>o.isRawMaterial(e.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(e.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value"))),a=t.some(e=>e.options.grid.madeFromRelationId&&null!=e.options.grid.madeFromRelationId),n=t.some(e=>o.isFormulatedProduct(e.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value")));a&&(s.push("UPSAuthCut"),s.push("UPSAuthCopy"),s.push("UPSAuthPaste")),i&&s.push("UPSAuthPaste"),n&&s.push("UPSAuthReplaceByRevision"),(0,f.getMultiActionMenu)(e,s)}else if(t&&(0===t.length||1===t.length)){const i=null!=t[0].getAttributeValue("madeFromRelationId"),a="expandState"===t[0]._expandState,n="collapseState"===t[0]._expandState,r=n&&(null===t[0].getAllDescendants()||t[0].getAllDescendants().length<2),d=n&&t[0].getAllDescendants().length>=2&&t[0].getAllDescendants().some(e=>null!=e.getAttributeValue("physicalId")&&null!=e.getAttributeValue("madeFromRelationId"));t[0].options.grid.madeFromRelationId&&null!=t[0].options.grid.madeFromRelationId&&(s.push("UPSAuthReplaceByRevision"),s.push("UPSAuthCut"),s.push("UPSAuthCopy"),s.push("UPSAuthPaste")),(a||i||r||d)&&s.push("UPSAuthReorderProduct");let l=t[0].getAttributeValue("ds6w:type");o.isFormulatedProduct(t[0].getAttributeValue("ds6w:type_value"))&&(s.push("UPSAuthReplaceByRevision"),s.push("UPSAuthReorderProduct"),s.push("UPSAuthPaste")),o.isRawMaterial(l)&&(s.push("UPSAuthReorderProduct"),s.push("UPSAuthPaste")),(0,f.getActionMenu)(e,s)}})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-toolbar-switch-view-bom"},e=>i.evt_GridToolbarSwitchViewBOM(e))),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-item-toolbar-mutiactions-list-bom"},function(e){e&&(e.nodeModel=i.bomGrid.getTreeDocument()),e.gridInstance=i.bomGrid;let t=widget.getValue(m.PERSISTENCY_BOM_VIEW);null==t&&(t=!0);var a=i.bomGrid.getTreeDocument().getSelectedNodes();let r=i.containsReleasedOrObsolete(a);const s="expandState"===i.selectedGridNodes[0]._expandState;var d=["Information_Widget","Alternates"];if(t&&(d.push("UPSAuthCut"),d.push("UPSAuthCopy"),d.push("UPSAuthPaste"),d.push("UPSAuthReorderProduct")),t||(d.push("UPSAuthUnparent"),d.push("DeleteItem")),r&&d.push("UPSAuthPaste"),!s)for(var l=0;l<a.length;l++)a[l].getNumberOfDescendants()>0&&a[l].getAllDescendants().some(e=>null!=e.getAttributeValue("physicalId")&&null!=e.getAttributeValue("madeFromRelationId"))&&(d.push("UPSAuthCut"),d.push("UPSAuthCopy"),d.push("UPSAuthPaste"));if(1==n&&(d.push("UPSAuthCut"),d.push("UPSAuthCopy"),d.push("UPSAuthPaste")),a&&(0===a.length||1===a.length)){const e=null!=a[0].getAttributeValue("madeFromRelationId"),t="expandState"===a[0]._expandState,i="collapseState"===a[0]._expandState,n=i&&(null===a[0].getAllDescendants()||a[0].getAllDescendants().length<2),r=i&&a[0].getAllDescendants().length>=2&&a[0].getAllDescendants().some(e=>null!=e.getAttributeValue("physicalId")&&null!=e.getAttributeValue("madeFromRelationId"));a[0].options.grid.madeFromRelationId&&null!=a[0].options.grid.madeFromRelationId&&(d.push("UPSAuthReplaceByRevision"),d.push("UPSAuthCut"),d.push("UPSAuthCopy"),d.push("UPSAuthPaste"),d.push("UPSAuthReorderProduct"));let s=a[0].getAttributeValue("ds6w:type");o.isFormulatedProduct(a[0].getAttributeValue("ds6w:type_value"))&&(d.push("UPSAuthReplaceByRevision"),d.push("UPSAuthReorderProduct"),d.push("UPSAuthPaste")),o.isRawMaterial(s)&&(d.push("UPSAuthReorderProduct"),d.push("UPSAuthPaste")),(t||e||n||r)&&d.push("UPSAuthReorderProduct")}if(a&&a.length>1){let e=a.some(e=>o.isRawMaterial(e.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(e.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value"))),t=a.some(e=>o.isFormulatedProduct(e.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(e.getAttributeValue("ds6w:type_value")));a.some(e=>e.options.grid.madeFromRelationId&&null!=e.options.grid.madeFromRelationId)&&(d.push("UPSAuthCut"),d.push("UPSAuthCopy"),d.push("UPSAuthPaste")),e&&d.push("UPSAuthPaste"),t&&d.push("UPSAuthReplaceByRevision")}(0,f.getToolbarActionMenu)(e,d)})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-list-remove-node-successful-bom"},function(e){i._removeNodes(e,!1)})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-list-unparent-node-successful-bom"},function(e){Array.isArray(e);var t=i.bomGrid.getTreeDocument().getSelectedNodes().filter(t=>e.includes(t.getInstanceId()));i._removeNodes(t,!1)})),this.platFormSubscrpition=a.subscribe(m.EVENT_PASTE_ENABLE+"-bom",function(){i.bomGrid.toolbar.enableCommands(["AuthPaste"])}),this.platFormSubscrpition=a.subscribe(m.EVENT_PASTE_DISABLE+"-bom",function(){i.bomGrid.toolbar.disableCommands(["AuthPaste"])}),this.platFormSubscrpition=a.subscribe(m.REMOVE_CUT_INSTANCES+"-bom",function(e){Array.isArray(e);var t=i.bomGrid.getTreeDocument().getAllDescendants().filter(t=>"function"==typeof t.getInstanceId&&e.includes(t.getInstanceId()));i._removeNodes(t,!0)}),this.platFormSubscrpition=a.subscribe(m.PASTE_ROOT_NODES+"-bom",function(e){i.pasteRootNodes(e)}),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-list-addInst-node-successful-bom"},function(e){i._processAndUpdateItems(e,!0)})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"replaced-eng-item"},function(e){let t={};t.bomContext=i,t.appCore=i.appCore,t.bomGrid=i.bomGrid,t.modelEvents=i.modelEvents,t.currentTabKey=i.currentTabKey,t.container=i.container,t.specModel=i.specModel,i.updateFetchMode(),new F(t).postReplaceByAction(e)})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-cell-value-update-bom"},e=>i.evt_GridCellValueUpdateBOM(e))),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"grid-toolbar-action-click-bom"},e=>i.evt_GridToolbarActionClickBOM(e))),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"add-CQ-node-BOM-success"},e=>i.evt_AddCQNodeBOMSuccess(e))),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"post-filter-search-bom"},e=>{e.forEach(e=>{e.showChildNodes&&e.showChildNodes()})})),this._bomSubscriptionList.push(this.modelEvents.subscribe({event:"add_MBMF_nodes"},e=>{var t=i.bomGrid.getTreeDocument().getSelectedNodes();if(t.length>0){i.updateFetchMode(),"noExpandState"===t[0]._expandState&&t[0].setState({state:"expanded"}),null===t[0].getChildren()&&"collapseState"===t[0]._expandState&&(t[0].collapse(),t[0].expand()),"expandState"!==t[0]._expandState&&null!=t[0].getChildren()&&i.expand_nodes(t),null!==t[0].getChildren()&&t[0].expand();for(var a=e.resp.length,n=0;n<a;n++){var r=e.resp[n].ReferenceName;r&&t[0].setreferenceArrayList(r)}}else i.evt_addMBMFNodes(e)}))},_launchRMCreateScreen:function(){var e={};e.appCore=this.appCore;var t=this.bomGrid.getTreeDocument().getSelectedNodes();let i=widget.getValue(m.PERSISTENCY_BOM_VIEW);if(this.isReferenceView=null==i||!0===i,t&&1===t.length){if(t[0].getMBMFChild())return void N.getMsgAddNodeOnMBMFParent();this.isReferenceView&&!this.isTileView?e.parentId=t[0].getPhysicalId():!this.isTileView&&this.isReferenceView||(this.isTileView&&this.bomGrid.tileManager&&this.bomGrid.tileManager.grid.unselectAll(),this.bomGrid.getTreeDocument().unselectAll(),g.displayNotification({eventID:"info",msg:B.Info_AddItemTileUsageView}))}else{if(t&&t.length>1)return void g.displayNotification({eventID:"error",msg:B.Error_Add_BOMChildren});{let e=this.bomGrid.model.getRoots();if(e.length>0)for(var a=0;a<e.length;a++)if(e[a].getMadeFrom())return void N.getMsgAddNodeOnMBMF()}}var n={};n.appCore=this.appCore,n.modelEvents=this.modelEvents,n.specModel=this.specModel,n.bomGrid=this.bomGrid,new S(n).createRawM()},_canNodeBeAdded:function(){var e=null,t={isValid:!1,parentNode:this.specModel},i=this.bomGrid.getTreeDocument().getSelectedNodes(),a=!0;if(i&&i.length>1&&(a=this._multipleSelectionCheck()),!a)return g.displayNotification({eventID:"error",msg:B.Error_Add_BOMChildren}),t;if(e=i&&i.length>0?i[0]:this.specModel,o.isRawMaterial(e.getTypeActualName()))return N.getMsgAddNodeOnRM(),t;if(e.getMadeFrom&&e.getMadeFrom())return N.getMsgAddNodeOnMBMF(),t;let n=e.getMBMFChild&&e.getMBMFChild(),r=this.bomGrid.model.getRoots()[0].getMadeFrom();return n||r?(N.getMsgAddNodeOnMBMFParent(),t):void 0},_multipleSelectionCheck:function(){var e=that.bomGrid.getTreeDocument().getSelectedNodes();if(that.isCollapsedView())return!1;{let t=!0;for(let i=1;i<e.length;i++)if(e[0].getID()!==e[i].getID()){t=!1;break}return t}},syncNodePostUpdate:function(e,t){e.nodeModel.setInstanceCount(t),this.bomGrid.unselectAll(),e.nodeModel.select(),widget.getValue(m.PERSISTENCY_BOM_VIEW)&&e.nodeModel.sync(),e.nodeModel.acceptChanges()},addNGFilterEvent:function(e){this.filterProxy.addEvent(m.EVENT_NG_FILTER,this.onApplyNGFilter.bind(this))},clearNGFilter:function(e,t){this.specModel.detachPersistedFilter();var i=this.appCore.specRouteManager.model,a=this.appCore.specRouteManager.model.getOriginalGridRoots();s.maskLoader(this.container,B.Loaderloading),i&&a.length>0&&(i.empty(),i.acceptChanges()),s.unmaskLoader(this.container),this.modelEvents.publish({event:m.EVENT_UPDATE_IDCARD_RENDERING,data:""}),this.appliedNGFilter=!1,null!=t?this.drawGridBasedOnMode(t):this.drawGridBasedOnMode(!0)},onApplyNGFilter:function(t){if("index"===widget.getValue("fetchmode")){var i=t||null;delete(i=e.is(i,"string")?JSON.parse(i):i).CVQuery3D;var a=widget.getValue(m.PERSISTENCY_BOM_VIEW);t&&t.empty?(widget.setValue(m.XSR_FILTER_PREF,void 0),this.clearNGFilter(t,a)):this.initializeNGFilter(i),this.ngFilterData=i}else g.displayNotification({eventID:"error",msg:B.Error_AdvanceFilter})},_processAndUpdateItems:function(e,i){var a=this,n=[],r=[],o=[],l=[],c=(s.maskLoader(a.container,B.InsertingLoader),a.bomGrid.getTreeDocument().getSelectedNodes()),u=function(){if(a.updateParentforChangeInfo(),a.bomGrid.getGridNodeCount()>0){let e=a.bomGrid.getGridNodes();a.service.updateAlternateInfo(e),a.bomGrid.unGroupRoots()}a.bomGrid.updateGroupByIfAny(),s.unmaskLoader(a.container)};0==a.bomGrid.getGridNodes().length&&a.bomGrid.removeGroupingTable();var p=function(e){if(e&&e.length>0&&e[0].error)for(var t=0;t<e.length;t++){var i=e[t].error;i&&g.displayNotification({eventID:"error",msg:i})}else e&&e.length>0&&e[0].success&&g.displayNotification({eventID:"success",msg:B.BOM_Insert_Success})};let h=widget.getValue(m.PERSISTENCY_BOM_VIEW);null==h||!0===h?(h=!0,this.isReferenceView=!0):this.isReferenceView=!1;for(var f=0;f<e.length;f++){var b=e[f];if(b.id===a.itemId){var M=B.replace(B.get("Insert_cyclic_failure"),{title:a.itemTitle});g.displayNotification({eventID:"error",msg:M}),s.unmaskLoader(a.container)}else{let e=a.bomGrid.gridTreeDocument.getNodeFromModelMapping(b.id);var I=!1;if(e&&c.length>0)for(f=0;f<c.length;f++)c[f].getID()===e.getParentId()&&(I=!0);else e&&0===c.length&&(I=!0,e=a.bomGrid.getGridNodes().find(e=>e.getID()===b.id));if(e&&h&&I){if(i&&a.isReferenceView&&!a.isTileView){e.addInstanceIds(b.instanceId),e.updateOtherDetails();let t=(new d).updateItemModelMapping(a.bomGrid.gridTreeDocument.itemModelMapping,e);a.bomGrid.gridTreeDocument.itemModelMapping=t}else if(!I){var y={parentId:e.getParentId(),instanceIDs:e.getParentInstanceIds(),itemId:e.getID(),quantity:1};r.push(a.createInstances(y,e))}}else if(i&&!h){let e=[b.fromId,b.instanceId,b.id];o.push(a.service.authoringExpand(e))}else{let e={};e.childId=b.id,e.instanceId=b.instanceId,l.push(e);var v=a.createNodeFromId(b.id);n.push(v)}}}t.all(r).then(function(e){p(e),e.length>0&&u()}).catch(function(e){console.error(e),u()}),t.all(o).then(function(e){for(var t=0;t<e.length;t++)a._manageNodes(e[t][0],!0),e[t][0].setParentId(a.itemId),e[t][0].addInstanceIds(e[t][0].getInstanceId()),e[t][0].select();e.length>0&&u()}).catch(function(e){console.error(e),u()}),t.all(n).then(function(e){var n=[],r=[];let o=!1;if("object"==typeof e&&e.length>0){for(let t=0;t<e.length;t++)r.push(e[t][0]);a.getBOMAndCoreMatDetails(r,null,!1)}var s=a.getGroupNodesOnQuantity(r);e=[];var c=0;Object.values(s).forEach(function(t){var i=[];i[0]=t,e[c]=i,c++});for(let t=0;t<e.length;t++){var u=e[t];if(i){var p=a.bomGrid.getTreeDocument().getSelectedNodes();p&&0===p.length&&(a.isReferenceView||a.isTileView)?(a._manageNodes(u[0],!0),u[0].setAttribute("level",1),u[0].setParentId(a.itemId),u[0].setCurrentPath(u[0]),a.isRootAdded=!0):a.isRootAdded&&p&&p.length>0&&(a.isReferenceView||a.isTileView)?(a._manageNodes(u[0],!0),u[0].setParentId(a.itemId),u[0].setCurrentPath(u[0])):p&&p.length>0&&!a.isRootAdded&&a.isReferenceView&&!a.isTileView&&(o=(p[0]._expandState,!0),u[0].setParentId(p[0]),u[0].setCurrentPath(u[0])),l.forEach(function(e){e.childId==u[0].getID()&&(u[0].addInstanceIds(e.instanceId),u[0].setInstanceId(e.instanceId))})}else{if((new d).getModelById(u[0].getID(),a.bomGrid)&&!h)var m=a._getItemInstanceIds(u[0]);else m=u[0].getParentInstanceIds();var g={parentId:a.itemId,instanceIDs:m,itemId:u[0].getID(),quantity:1};n.push(a.createInstances(g,u[0],!0))}}return t.all(n)}).then(function(e){p(e),n.length>0&&u()}).catch(function(e){console.error(e),u()}),0==r.length&&0==n.length&&0==o.length&&u(),a.updateFetchMode()},_getItemInstanceIds:function(e){let t=this.bomGrid.getGridNodes(),i=[];return t.forEach(function(t){t.getID()==e.getID()&&i.push(t.getInstanceId())}),i},_removeNodes:function(e,t){var i=this;if(this.updateFetchMode(),!Array.isArray(e)){if(0===i.bomGrid.getTreeDocument().getSelectedNodes().filter(t=>t.getID()===e.getID()).length)return}if(Array.isArray(e)||(e=[e]),t){let t=e.reduce((e,t)=>(e.add(t.getAttributeValue("instanceId")),e),new Set),a=i.bomGrid.getTreeDocument().getAllDescendants().filter(e=>t.has(e.getAttributeValue("instanceId")));e=a}else{let t=e.reduce((e,t)=>(t.parentNodeModel&&t.parentNodeModel.getAttributeValue("physicalId")&&(e[t.getAttributeValue("physicalId")]={nodeId:t._id,parentId:t.parentNodeModel.getAttributeValue("physicalId")}),e),{}),a=i.bomGrid.getTreeDocument().getAllDescendants().filter(e=>{let i=e.getAttributeValue("physicalId");return!!t[i]&&(t[i].parentId===e.parentNodeModel.getAttributeValue("physicalId")&&e._id!==t[i].nodeId)});e.push(...a)}!t&&this&&this.appCore&&this.appCore.localStorage&&this.appCore.localStorage.xSpecData&&this.appCore.localStorage.xSpecData.clipboard&&this.appCore.localStorage.xSpecData.clipboard.length>0&&e.forEach(e=>{let t;if(-1!==(t=this.appCore.localStorage.xSpecData.clipboard.indexOf(e.getAttributeValue("instanceId")))){let e=this.appCore.localStorage.xSpecData.clipboard.lastIndexOf(",",t),i=this.appCore.localStorage.xSpecData.clipboard.indexOf(",",t);-1===i&&(i=this.appCore.localStorage.xSpecData.clipboard.length);let n=this.appCore.localStorage.xSpecData.clipboard.substring(0,e+1)+this.appCore.localStorage.xSpecData.clipboard.substring(i+1);n.length<4?(this.appCore.localStorage.removeItem("clipboard"),a.publish(m.EVENT_PASTE_DISABLE+"-bom")):(","===n.charAt(n.length-1)&&(n=n.substring(0,n.length-1)),this.appCore.localStorage.setItem("clipboard",n))}}),(new v).checkMaterialMismatch(i.itemId).then(e=>{i.modelEvents.publish({event:"item-view-manager-material-icon-update",data:e.result})}),this.bomGrid.removeRootNodes(e),this.updateParentforChangeInfo(),this.bomGrid.removeItemsOnTagger(e),0==this.bomGrid.getGridNodeCount()&&(this.specModel.setBOMAdded(!1),this.specModel.setBOMConnection(!1),this.disableMBMFCmd=!1,this.toggleMBMFCommand(!0,!1))},_addNewNode:function(e,t,i,a,n){if("MBMF"!==a||!t||this.isSingleLevel&&this.isTileView)if(!t||1!==t.length||this.isSingleLevel&&this.isTileView||a){if(e.parentNodeModel=this.specModel,a&&"MBMF"===a||(this.specModel.setBOMAdded(!0),this.specModel.setBOMConnection(!0),e.setCurrentPath(e)),e.setAttribute("level",1),this.bomGrid.addRootNodes(e,i),this.appCore.MBMFAtRootLevel={},this.appCore.MBMFAtRootLevel.NodeAtRootLevel=!0,n){let e=this.bomGrid.getGridNodes();this.appCore.MBMFAtRootLevel.NodesToBeUpdated=e}}else;else if(1===t.length)e.setAttribute("level",t[0].getAttributeValue("level")+1),t[0].addChild(e),e.parentNodeModel=t[0],t[0].setMBMFChild(e),t[0].isExpanded()||t[0].expand();else if(0===t.length){if(this.bomGrid.addRootNodes(e),this.appCore.MBMFAtRootLevel={},this.appCore.MBMFAtRootLevel.NodeAtRootLevel=!0,this.appCore.MBMFAtRootLevel.MBMFModel=e,n){let e=this.bomGrid.getGridNodes();this.appCore.MBMFAtRootLevel.NodesToBeUpdated=[];for(let t=0;t<e.length;t++)this.appCore.MBMFAtRootLevel.MBMFModel&&e[t].getID()===this.appCore.MBMFAtRootLevel.MBMFModel.getID()&&this.appCore.MBMFAtRootLevel.NodesToBeUpdated.push(e[t])}}else t.addChild(e),e.parentNodeModel=t,t.setMBMFChild(e),t.isExpanded()||t.expand();this.bomGrid.getTreeDocument().acceptChanges(),this.updateParentforChangeInfo(),this.bomGrid.updateGroupByIfAny(),this.bomGrid.updateItemsOnTagger(e),e&&e.getInstanceId()&&(this.disableMBMFCmd=!0,this.toggleMBMFCommand(!0,!1))},createNodeFromId:function(e){var t=this.bomGrid.getTreeDocument().getSelectedNodes();if(e)return this.service.getEngItemNode([e],t)},syncMBMFNodeBasedOnID:function(e){var t=this,i=t.bomGrid.getTreeDocument().getSelectedNodes();i&&i.length>0&&i[0].getChildren().forEach(function(i){i.getID()===e&&t.service.fetchItemInfo([e]).then(function(e){i.set(e),t.syncInstanceModels(i)}).catch(function(e){console.error(e)})})},syncNodeBasedOnID:function(e){var t=this,i=t.bomGrid.getTreeDocument().getSelectedNodes();if(0==i.length)i=t.bomGrid.getTreeDocument().getAllDescendants();else{let a=t.bomGrid.getTreeDocument().getAllDescendants().filter(t=>t.getAttributeValue("physicalId")===e&&!t.isSelected());a&&a.length>0&&i.push(...a)}i.forEach(function(i){if("function"==typeof i.getID&&i.getID()===e){var a=new P({id:"getAttributeDetails"}),n={lIds:[e],relIDs:[],busIDs:[],plmparameters:"false",attributes:"true",navigateToMain:"false",readonly:"true",debug_properties:""};a.getDetails(n).then(function(e){if(null!=e){var a=e.results[0].data;a&&i.options.grid&&(a.forEach(e=>{if(e.value)for(let a in i.options.grid)t.currentTabKey+e.path===a&&(e.type&&"boolean"===e.type?i.options.grid[a]=e.value[0].toString():i.options.grid[a]=e.value);else i.options.grid[t.currentTabKey+e.path]=""}),t.syncInstanceModels(i))}}).catch(function(e){console.error(e)}),t.service.fetchItemInfo([e]).then(function(e){widget.getValue(m.PERSISTENCY_BOM_VIEW)?i.set(e):(i.set(e,!1),t.updateSameNodesInBom(i))}).catch(function(e){console.error(e)})}})},syncRemoveCustomDataNode:function(e){var t=this,i=t.bomGrid.getTreeDocument().getSelectedNodes();0==i.length&&(i=t.bomGrid.getTreeDocument().getAllDescendants()),i.forEach(function(i){if("function"==typeof i.getID&&i.getID()===e&&i.options.grid){for(let e in i.options.grid)e.startsWith(t.currentTabKey)&&(i.options.grid[e]=void 0);i.acceptChanges(),t.syncInstanceModels(i)}})},render:function(){var t=this;this._bomContainer=e.createElement("div",{class:"multigrid-bom-container"}).inject(this.container),this.appCore.dndManager.enableDragAndDropOnIDCard(),this.dnd=new I({modelEvents:this.modelEvents}),this.dnd.makeDroppable(this._bomContainer,"insert"),s.maskLoader(t.container,B.Loaderloading);var i=new P({id:"getCustomAttributes"});let a=widget.getValue(m.PERSISTENCY_BOM_VIEW);i.getAttributes().then(async function(e){var i=await r.getCustomAttributes(e,t.currentTabKey,a);s.unmaskLoader(t.container),t.initializeSingleGrid(i)}).catch(function(e){s.unmaskLoader(t.container),console.error(e),t.initializeSingleGrid(void 0)})},initializeSingleGrid:async function(e){var t={itemId:this.itemId,container:this._bomContainer,appCore:this.appCore,currentTabKey:this.currentTabKey,enableCrossWidgetFeature:!0,isColorized:!0,parentModel:this.specModel},i={statusBarIcons:["info"],statusBarTooltip:[B.label_Information],statusBarPointerDownEventId:[m.INFORMATION_CMD]};t.statusIconForTileView=i,t.enableInteractiveRightPanel=!0;var a=JSON.parse(O),r=JSON.parse(V),o=this.getNLSLabels(a.actions);this.gridColumns=this.getNLSLabels(r.columns),e&&void 0!==e&&(this.gridColumns=this.gridColumns.concat(e)),this.gridColumns=new E(this.gridColumns);let s=widget.getValue(m.PERSISTENCY_BOM_VIEW);this.bomGrid=new n(t),this.bomGrid.setColumns(this.gridColumns.getColumns()),this.bomGrid.render(),null==s||!0===s?(this.isReferenceView=!0,widget.setValue(m.PERSISTENCY_BOM_VIEW,this.isReferenceView)):this.isReferenceView=!1,m.BIG_TILE===this.bomGrid.preferredView?(this.isTileView=!0,this.toggleMBMFCommand(!1,!1)):m.GRID_VIEW===this.bomGrid.preferredView&&(this.isTileView=!1,this.toggleMBMFCommand(!0,!1)),null!=s?this.drawGridBasedOnMode(s):this.drawGridBasedOnMode(!0),this.bomGrid.setToolBarActions({actions:o}),this.setCustomTooltipOnTile(),c.setBOMTabOptions({appCore:this.appCore,maskContainer:this.container,gridView:this.bomGrid}),this.toggleMBMFCommand(!0,!1)},getColumnDef:function(e){var t={},i=JSON.parse(V),a=this.getNLSLabels(i.columns);if(a)t=function(e){for(let t=0;t<a.length;t++)if(a[t].dataIndex==e)return a[t]};return t(e)},getInstanceTitleColDef:function(){return{dataIndex:"instanceTitle",text:B.label_InstanceTitle,typeRepresentation:"string",icon:"object-instance",width:150,editableFlag:!0,forbiddenCheck:!1,allowUnsafeHTMLContent:!1,autoRowHeightFlag:!1,exportFlag:!0,visibleFlag:!0}},drawGridBasedOnMode:function(e){var t=widget.getValue(m.XSR_FILTER_PREF),i=this;if(this.appCore.localStorage.setItem(m.VALUE_QUANTITY_VIEW,e),e){var a=[],n=r.getInstanceCustomAttributesData();n&&n.forEach(e=>a.push(this.currentTabKey+e)),a.push(m.COLUMN_INSTANCETITLE),this.bomGrid.removeColumns(a),this.isTileView||this.toggleMBMFCommand(!0,!1)}else{this.bomGrid.addColumn(this.getInstanceTitleColDef(),11);var o=r.getInstanceAttributes();if(o&&void 0!==o)this.gridColumns.colsObj=this.gridColumns.colsObj.concat(o),o.forEach(e=>this.bomGrid.addColumn(e,void 0));else new P({id:"getCustomAttributes"}).getAttributes().then(async function(t){await r.getCustomAttributes(t,i.currentTabKey,e),(o=r.getInstanceAttributes())&&(i.gridColumns.colsObj=i.gridColumns.colsObj.concat(o),o.forEach(e=>i.bomGrid.addColumn(e,void 0)))}).catch(function(e){console.error(e)})}this.appliedNGFilter&&this.ngFilterData?this.initializeNGFilter(this.ngFilterData):t&&t.filterRootIds[0]===this.itemId?this.initializeNGFilter(t):this.getBOM(e)},getMBMFNodes:async function(e,t,i,a,n,r){var o=this;N.getMBMFDetails(e,a,o.appCore,t,r).then(async function(e){let a=t?t[0]:o.specModel,s=a.getID(),d=a.getReferenceNameList();0==d.length&&(d=await N.getReferenceList(s));let l={MBMFInfo:e,VPMInstanceNodes:r,selNodes:t,isSelected:i,invokedFromSearch:n,referenceNames:d};o.postGetMBMFDetails(l)}).catch(function(e){g.displayNotification({eventID:"error",msg:e?e.result.message:B.Error_Get_MBMF}),s.unmaskLoader(o.container)})},postGetMBMFDetails:function(e){let t=this,i=e.MBMFInfo,a=e.VPMInstanceNodes,n=e.selNodes,r=e.isSelected,s=e.invokedFromSearch,d=e.referenceNames||[],l=[];if(i&&i.length>0){for(var c=!1,u=0;u<i.length;u++){var p;u===i.length-1&&(c=!0),p=o.isFormulatedProduct(i[u].madeFromProductType.dbName)?{shouldDisplayChildren:!1}:o.isPhyProd(i[u].madeFromProductType.dbName)?{shouldDisplayChildren:!0}:{shouldDisplayChildren:!1};var m=new M(p).set(i[u]);m.currentTabKey=t.currentTabKey,m.appCore=t.appCore,m.setReferenceNameList(d),t._addNewNode(m,n,r,"MBMF",c),l.push(m)}t.checkAndApplyGrouping(),t.bomGrid.getTreeDocument().acceptChanges(),t.updateReferenceList(),t.appCore.MBMFDialog&&t.appCore.MBMFDialog.closeDialog(),s&&t.modelEvents.publish({event:"bom-to-MBMFFacet-commute-add-node-success",data:{mbmfInfo:i}})}else a&&0===a.length&&t.bomGrid.displayEmptyObjectView();t.setMatInfoOnNodes(a,l),l&&l.length>0&&t.specModel.setMBMFChildren(!0)},updateReferenceList:function(){let e=this.bomGrid.getTreeDocument().getAllDescendants().filter(e=>{let t="function"==typeof e.getMadeFrom&&e.getMadeFrom(),i="function"==typeof e.IsComputed&&!e.IsComputed();return t&&i;//!!isQuantityMode &&
}).reduce((e,t)=>(null!=t.getAttributeValue("referenceName")&&""!==t.getAttributeValue("referenceName")&&e.add(t.getAttributeValue("referenceName")),e),new Set);this.gridColumns.setReferenceNameList([...e])},setMatInfoOnNodes:function(e,t){var i=this,a=[],n=[];if(e&&e.length>0)for(var r=0;r<e.length;r++)n.push(e[r]),a.push(e[r].getID());if(t&&t.length>0)for(var o=0;o<t.length;o++)n.push(t[o]),a.push(t[o].getID()),t[o].setAddMatInfoParent(!0);if(a&&a.length>0){var s={};s.references=a,s.with_partials=!0,(new v).fetchCoreMatDetails(s).then(function(e){if(e&&e.keys()){for(var t=0;t<n.length;t++)for(const[i,s]of e.entries())if(i===n[t].getID()){var a=s.physicalid,r=(s.V_Name?s.V_Name:"")+" "+(s.revision?s.revision:"-");if(n[t].setCoreMat(r),n[t].setCoreMatId(a),n[t].updateOptions(n[t].options),n[t].getAddMatInfoParent()){var o=n[t].parentNodeModel;o&&void 0!==o.setCoreMat&&void 0!==o.setCoreMatId&&(o.setCoreMat(r),o.setCoreMatId(a),o.updateOptions(o.options))}}i.bomGrid.getTreeDocument().acceptChanges()}}).catch(function(e){g.displayNotification({eventID:"error",msg:e?e.message:B.Error_GetMatInfo})})}},setUOMUnitMap:function(e){var t=this;N.getCellSemanticsForUOM(e.getID()).then(function(t){e.setUOMUnitsDBNLSMap(t)}).catch(function(e){g.displayNotification({eventID:"error",msg:e?e.message:B.Error_Get_MBMF}),s.unmaskLoader(t.container)})},getNLSLabels:function(e){var t=e;if(t){var i=function(e){for(var t=0;t<e.length;t++)e[t].text=e[t].text&&B[e[t].text]?B[e[t].text]:e[t].text,e[t].subMenu&&i(e[t].subMenu)};i(t)}return t},setCustomTooltipOnTile:function(){this.bomGrid.tileManager.grid.getCustomTooltip=function(e){if(e._canBeGrouped()){let i=widget.getValue(m.PERSISTENCY_BOM_VIEW);null==i&&(i=!0);var t=B.label_Title+": "+e.getLabel()+"\n"+B.label_PartNumber+": "+e.getPartNumber()+"\n"+B.label_Type+": "+e.getType()+"\n"+B.label_Revision+": "+e.getRevision()+"\n";if(i){let i=e.getQuantity()+" "+e.getUnitNLS();"null "!=i&&"null EA (each)"!=i&&"undefined EA (each)"!=i||(i="-"),t=t+(B.Quantity+": ")+i+"\n"}else t=t+(B.label_InstanceTitle+": ")+e.getInstanceTitle()+"\n";let a=e.getAlternate&&"Yes"==e.getAlternate()?e.getDisplayAlternate():B.label_no;return t=t+B.label_Alternate+": "+a+"\n"+B.label_LastModified+": "+e.getModifedDate()}return e.getLabel()}},getGroupNodesOnQuantityV2:function(e){let t={},i=this;return e.forEach(function(e){let a=e.getParentId(),n=e.getID(),r=e.getParentInstanceIds();if(o.isRawMaterial(e.getTypeActualName())||o.isFormulatedProduct(e.getTypeActualName()))t[n+"/"+e.getInstanceId()]=e;else if(t[n]&&a===t[n].getParentId()){let e=t[n].getInstanceCount(),i=e?e+1:1;t[n].setInstanceCount(i),r&&t[n].addInstanceIds(r[0])}else if(e.setInstanceCount(1),t[n]=e,t[n].getChildren()){let e=i.getGroupNodesOnQuantityV2(t[n].getChildren());t[n].removeChildren();for(let i in e)t[n].addChild(e[i])}}),t},getGroupNodesOnQuantity:function(e){var t={};return e.forEach(function(e){var i=e.getParentId(),a=e.getID(),n=e.getParentInstanceIds();if(o.isRawMaterial(e.getTypeActualName())||o.isFormulatedProduct(e.getTypeActualName()))t[a+"/"+e.getInstanceId()]=e;else if(t[a]&&i===t[a].getParentId()){var r=t[a].getInstanceCount(),s=r?r+1:1;t[a].setInstanceCount(s),n&&t[a].addInstanceIds(n[0])}else e.setInstanceCount(1),t[a]=e}),t},getBOM:function(){this._bomExpandTreeV3(!1,0)},getBOMAndCoreMatDetails:function(e,t,i){for(var a=this,n=[],r=0;r<e.length;r++)n.push(e[r].getID());if(n&&n.length>0){var o={};o.references=n,o.with_partials=!0,(new v).fetchCoreMatDetails(o,e).then(function(n){if(n)for(var r=0;r<e.length;r++)for(const[t,i]of n.entries())if(t===e[r].getID()){var o=i.physicalid,s=(i.V_Name?i.V_Name:"")+" "+(i.revision?i.revision:"-");e[r].setCoreMat(s),e[r].setCoreMatId(o),e[r].updateOptions(e[r].options)}i&&a.getBOMPostAction(e,t)}).catch(function(n){g.displayNotification({eventID:"error",msg:n?n.message:B.Error_GetMatInfo}),s.unmaskLoader(a.bomContainer),i&&a.getBOMPostAction(e,t)})}},updateBOMToolBarCmds:function(){let e=[],t=[];if(widget.getValue(m.PERSISTENCY_BOM_VIEW))e.push("add","removeitem","deleteItem"),t.push("reorder","AuthPaste");else{t.push("add","removeitem","deleteItem");let i=this.bomGrid.gridView,a=!1;if(i){let e=i._customViewsManager._customViews[0];e&&e.groupingOptions&&e.groupingOptions.dataIndexesToGroup&&e.groupingOptions.dataIndexesToGroup.length>0&&(a=!0)}a?t.push("reorder"):e.push("reorder"),this.appCore.localStorage.xSpecData.hasOwnProperty("clipboard")&&!this.specModel.hasMBMFConnection()?e.push("AuthPaste"):t.push("AuthPaste")}this.specModel.hasMBMFConnection()&&t.push("reorder","AuthPaste"),this.specModel.has3DPart()&&t.push("add","AuthPaste"),"Released"!=this.specModel.getMaturity()&&"Obsolete"!=this.specModel.getMaturity()||t.push("add","removeitem","deleteItem"),this.bomGrid.toolbar.enableCommands(e),this.bomGrid.toolbar.disableCommands(t)},getBOMPostAction:function(t,i){var a=new Map;if(this.bomGrid.getTreeDocument()&&(this.bomGrid.removeGroupingTable(),this.bomGrid.getGridNodeCount()>0)){let t=this.bomGrid.getGridNodes();e.is(t,"array")&&this.bomGrid.removeRootNodes(t)}if(this.specModel.hasMBMFConnection()&&this.bomGrid.toolbar.disableCommands(["reorder","AuthPaste"]),i?(this.bomGrid.toolbar.enableCommands(["add","removeitem","deleteItem"]),this.bomGrid.toolbar.disableCommands(["reorder","AuthPaste"])):(this.bomGrid.toolbar.disableCommands(["add","removeitem","deleteItem"]),this.bomGrid.toolbar.enableCommands(["reorder"]),this.appCore.localStorage.xSpecData.hasOwnProperty("clipboard")&&!this.specModel.hasMBMFConnection()?this.bomGrid.toolbar.enableCommands(["AuthPaste"]):this.bomGrid.toolbar.disableCommands(["AuthPaste"])),this.specModel.has3DPart()&&this.bomGrid.toolbar.disableCommands(["add","AuthPaste"]),"Released"!=this.specModel.getMaturity()&&"Obsolete"!=this.specModel.getMaturity()||this.bomGrid.toolbar.disableCommands(["add","removeitem","deleteItem"]),t&&t.length>0){if(this.specModel.setBOMAdded(!0),this.specModel.setBOMConnection(!0),i){this.isSingleLevel=!1;var n=this.getGroupNodesOnQuantity(t);for(var r in n){var d=n[r];d.setAttribute("level",1),d.setCurrentPath(d),this.bomGrid.addRootNodes(d,!1),(o.isRawMaterial(d.getTypeActualName())||o.isFormulatedProduct(d.getTypeActualName()))&&a.set(d.getInstanceId(),d)}}else this.isSingleLevel=!0,this.bomGrid.addRootNodes(t,!1),t.forEach(e=>{e.setAttribute("level",1),e.setCurrentPath(e),(o.isRawMaterial(e.getTypeActualName())||o.isFormulatedProduct(e.getTypeActualName()))&&a.set(e.getInstanceId(),e)});this.checkAndApplyGrouping(i),this.bomGrid.addTagger(),this.toggleMBMFCommand(!1,!1)}s.unmaskLoader(this.container),this.getMBMFNodes(this.itemId,null,!1,null,!1,t),this.getContinousQuantityData(a)},checkAndApplyGrouping:function(e){let t=this,i=t.bomGrid.getGroupByColumns(),a=[];if(i)if(e){if(Array.isArray(i)){i.indexOf(m.COLUMN_INSTANCETITLE)>-1&&a.push(m.COLUMN_INSTANCETITLE)}}else if(Array.isArray(i)){i.indexOf(m.COLUMN_QUANTITY)>-1&&a.push(m.COLUMN_QUANTITY),i.indexOf(m.COLUMN_UNIT)>-1&&a.push(m.COLUMN_UNIT)}Array.isArray(a)&&0==a.length?t.bomGrid.checkAndUpdatePersistency(i):t.bomGrid.setGroupByColumns(void 0)},updateFetchMode:function(){this.modelEvents.publish({event:"xsr-toolbar-switch-fetch-mode-to-author"})},createInstances:function(e,i,a){var n=this;return new t(function(t,r){n.service.addInstances(e).then(function(r){n.updateFetchMode();for(var o=0;o<r.length;o++){var s=r[o];if("success"===s.status){var d=s.instance;i.addInstanceIds(d),i.setInstanceTitle(s.instanceName),i.setInstanceId(d),i.updateOptions(i.options)}}n._manageNodes(i,a),i.setParentId(e.parentId),t({success:i.getTitle()})}).catch(function(e){var a;i.getID()?a=e&&e.message?e.message:B.replace(B.get("Failure_Insert"),{title:i.getTitle()}):a=B.Failure_mass_insert;t({error:a})})})},deleteInstances:function(e,i){var a=this,n=e.instances;return new t(function(t,r){a.service.deleteInstances(e).then(function(e){i.removeInstanceIds(n),a.bomGrid.unselectAll(),i.updateOtherDetails(),i.select(),a.bomGrid.highlightCell(i._rowID,"quantity"),t(),i.sync()}).catch(function(e){var t;t=i.getID(),r(t)})})},_manageNodes:function(e,t){t?(this.specModel.setBOMAdded(!0),this.specModel.setBOMConnection(!0),this.bomGrid.addRootNodes(e),this.bomGrid.updateItemsOnTagger(e)):(e.updateOtherDetails(),e.select(),this.bomGrid.highlightCell(e._rowID,"quantity")),e.sync()},_exportGrid:function(){let e=this;s.maskLoader(e.container,B.Exporting),e.updateVisibleNodes(e.bomGrid.getTreeDocument().getAllDescendants()).then(()=>{var t=e.itemTitle+"_"+e.itemMaturity+"_"+B.tab_BOM;e.bomGrid.exportGrid(t),s.unmaskLoader(e.container)}).catch(t=>{s.unmaskLoader(e.container),g.displayNotification({eventID:"error",msg:B.Export_Failed})})},_personalize:function(){this.bomGrid.personalize()},updateParentforChangeInfo:function(){this.appCore.WorkUnderContext&&this.modelEvents.publish({event:"xsr-update-change-on-idcard"})},initializeNGFilter:function(e){if(e.appId===m.XSR_APP_ID){var t=this.filterProxy._biFilter;e.filterPId&&t.retrieveFilters({filterObjects:[{envId:l.getPlatformId(),serviceId:m.SERVICE_3DSPACE_NAME,contextId:"",objectId:e.filterPId,objectType:"ENOStrRefinementSpecification",displayName:e.filterName}],callback:function(e){return e&&Array.isArray(e.success)&&e.success.length>0?resolve(e.success):e&&Array.isArray(e.errors)&&e.errors.length>0?reject(new Error("unable to retrieve Filters")):void 0}}),this._buildFilteredContent(e)}},buildSession:function(e){var i=this;return new t(function(t,a){i.specModel.nextGenFilterMultiExpand(e).then(function(e){t(e)}).catch(function(e){console.error(e),a()})})},buildSessionV2:function(e){this.progressiveExpand(void 0,e.CVQueryV2.filter)},_buildFilteredContent:function(e){if(!e||!Array.isArray(e.filterRootIds)||e.filterRootIds.indexOf(this.specModel.id)<0)return null;this.buildNGFilterSession(e)},buildFilteredData:function(e,t){if(t.filterPId){var i=widget.getValue(m.XSR_FILTER_PREF);i&&i.filterRootIds[0]===t.filterRootIds[0]&&widget.setValue(m.XSR_FILTER_PREF,void 0),this.itemId===t.filterRootIds[0]&&widget.setValue(m.XSR_FILTER_PREF,t)}var a=this.appCore.specRouteManager.model,n=a.getOriginalGridRoots();n&&n.length>0&&(a.empty(),a.acceptChanges());var r=widget.getValue(m.PERSISTENCY_BOM_VIEW);if(r||void 0===r){var o=this.getGroupNodesOnQuantity(e);for(var d in o){var l=o[d];this.bomGrid.addRootNodes(l,!1)}}else this.bomGrid.addRootNodes(e,!1);var c=t.filterName?t.filterName:"";this.modelEvents.publish({event:m.EVENT_UPDATE_IDCARD_RENDERING,data:c}),this.appliedNGFilter=!0,this.checkAndApplyGrouping(r),s.unmaskLoader(this.container)},buildNGFilterSession:function(e){null!=e&&(this.appliedNGFilter=!0,this.buildSessionV2(e))},instanceViewRowSelectionAction:function(e){let t=[];e.currentModel.forEach(e=>{e.isRoot()||(e.getRoot().unselectAll(),e.getRoot().select(),t.push(e.getRoot().getID()))}),this.bomGrid.model.getRoots().forEach(e=>{t.includes(e.getID())&&!e.isSelected()&&e.select()})},isCollapsedView:function(){return!1!==widget.getValue(m.PERSISTENCY_BOM_VIEW)},getContinousQuantityData:function(e){var t=this;if(0==e.size)return;let i=[];e.forEach((e,t)=>i.push(t)),(new C).getContQtyInstances(i).then(function(i){if(i.result){let a=i.result,n=[];a.forEach(t=>{let i=e.get(t.instanceId),a=null,r=null,o=null,s=null,d=null,l=!1;t.quantityType&&t.quantityType.dbName?(a=t.quantityType.nlsLabel,r=t.quantityType.dbName,i.setDimensionType(r)):n.push(i.getInstanceId()),t.quantity&&(d=t.quantity),i.setQuantity(d),t.quantityUOM&&t.quantityUOM.nlsLabel&&t.quantityUOM.dbName?(o=t.quantityUOM.nlsLabel,s=t.quantityUOM.dbName,i.setUnit(s),i.setUnitNLS(o)):i.setUnit(""),t.asRequired&&(l=t.asRequired),i.setAsRequired(l),i.setCQInstance(!0),i.updateOptions(i.options)}),t.bomGrid.getTreeDocument().acceptChanges(),n.length>0&&t.setDataForPendingIds(n,e)}}).catch(function(e){g.displayNotification({eventID:"error",msg:e.message}),s.unmaskLoader(t.container)})},setDataForPendingIds:function(e,i){var a=this;s.maskLoader(a.container,B.Loaderloading);let n=[];e.forEach(e=>{var a=new t((t,a)=>{let n=i.get(e).getID();(new D).getUOMTypes(n).then(function(i){var a={};a[e]=i.result.applicableUOMTypes[0].dimension.dbName,t(a)})});n.push(a)}),t.all(n).then(function(e){e.forEach(e=>{let t=i.get(Object.keys(e)[0]);t.setDimensionType(Object.values(e)[0]),t.updateOptions(t.options)}),a.bomGrid.getTreeDocument().acceptChanges(),s.unmaskLoader(a.container)}).catch(function(e){s.unmaskLoader(a.container)})},toggleMBMFCommand:function(e,t){var i=t?e:e&&!this.disableMBMFCmd;this.modelEvents.publish({event:"xsr-hide-toolbar-makeFrom-command-"+this.currentTabKey,data:{disableMBMFCmd:!i}})},reorderTree:function(e){this.bomGrid.model.setUseChangeTransactionMode(!1),this.isReorderTriggered=!0,p.launchUPSAuthReorderProduct({data:e})},pasteItems:function(e){p.launchUPSAuthPaste({data:e})},pasteRootNodes:async function(e){let t=this,i=new Map,a=[];for(let n=0;n<e.length;n++){let r=e[n].relationid,s=e[n].instanceName,d=(await t.createNodeFromId(e[n].resourceid))[0];d.setInstanceTitle(s),d.setInstanceName(s),d.setInstanceId(r),d.setParentId(t.itemId),d.options.grid.instanceIds=[r],d.options.grid.instanceCount=1,(o.isRawMaterial(d.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(d.getAttributeValue("ds6w:type"))||o.isFormulatedProduct(d.getAttributeValue("ds6w:type_value")))&&i.set(d.getAttributeValue("instanceId"),d),d.options.relationid=d.options.grid.relationid=r,d.setCurrentPath(d),d.setAttribute("level",1),a.push(d),t.bomGrid.addRootNodes(d)}t.getContinousQuantityData(i),t.getBOMAndCoreMatDetails(a,null,!1),t.updateAltInfoForPastedNodes(a)},updateAltInfoForPastedNodes:function(e){let t=[];for(var i=0;i<e.length;i++)t.push(e[i].getID());this.service.fetchAlternateInfo(t,e).then(function(t){"success"==t.status&&Object.keys(t.AlternateItemInfo).length>0&&e.forEach(e=>{t.AlternateItemInfo.hasOwnProperty(e.getID())&&(e.setAlternate("Yes"),e.setDisplayAlternate(B.label_yes),e.updateOptions(e.options))})})},containsReleasedOrObsolete:function(e){return e.some(e=>{let t=e.getAttributeValue("ds6w:status");return"Released"===t||"Obsolete"===t})},destroy:function(){this.dnd.cleanDroppable(this._bomContainer),this.appCore.dndManager.enableDragAndDropOnSpecViewer(),this._bomContainer.destroy(),this.bomGrid.destroy(),this.platFormSubscrpition&&a.unsubscribe(this.platFormSubscrpition),this.platFormXENSubscrpition&&a.unsubscribe(this.platFormXENSubscrpition),this._bomSubscriptionList&&this.modelEvents.unsubscribeList(this._bomSubscriptionList),this.platformXENAlternateSubscription&&a.unsubscribe(this.platformXENAlternateSubscription)}})});