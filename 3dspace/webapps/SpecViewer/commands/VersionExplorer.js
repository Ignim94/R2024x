define("DS/SpecViewer/commands/VersionExplorer",["DS/SpecViewer/commands/CommandBase","UWA/Promise","DS/UIKIT/Modal","DS/XSRCommonComponents/utils/Utils","DS/SpecViewer/model/SpecTreeModel","DS/ENOXVersionExplorerController/VersionExplorerController","DS/ENOXVersionExplorerUtils/VersionExplorerEnums","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/service/XSpecsActionsFactory","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/Notification","i18n!DS/SpecViewer/assets/nls/SpecViewer"],function(e,t,o,i,n,s,r,p,c,l,a,d){"use strict";var E;return e.extend({specNodeMap:{},init:function(e){e=UWA.extend(e,{isAsynchronous:!1}),this._parent(e)},_buildModal:function(){this.modal=new o({title:"manage_versions",className:"xsr-version-container",withFooter:!1})},execute:function(){this.specModel=arguments[0]._selectedItems[0],this.appCore=this.specModel.appCore,this.contextObjectId=this.appCore.specRouteManager?this.appCore.specRouteManager.getCurrentSpecViewerId():this.specModel.getID(),this.itemType=this.specModel.getTypeActualName(),this.basicModelEvents=this.specModel.appCore.basicModelEvents?this.specModel.appCore.basicModelEvents:this.options.modelEvents,this.specViewerModelEvents=this.specModel.appCore.specViewerModelEvents?this.specModel.appCore.specViewerModelEvents:this.options.modelEvents;var e=this.specModel.container||widget.body;E=UWA.createElement("div").inject(e);var t=new s({versionGraphContainer:E,selectionMode:r.SELECTION_MODES.WITH_COMMANDS,widget:widget}),o=function(e){return!0};this.basicOptions={appCore:this.appCore,itemPid:this.specModel.itemPid};var n=this.specModel.getID();t.showDialog({clientX:50,clientY:50},E,!0);var c=p.getSecurityContext().replace("ctx::",""),l={id:n,context:this,type:this.specModel.getTypeActualName(),displayName:this.specModel.getTitle(),tenantId:p.getPlatformId(),securityContext:c,dataModelType:r.DATA_MODEL_TYPES.MODEL_REVISION,onComplete:function(){t.publishEvent("ENOXVersionExplorerSetActiveVersion",{id:n})}};t.publishEvent("ENOXVersionExplorerLoadVersionModel",l),t.setCheckVersionExternalFunction("ENOXVersionExplorerOpenVersion",o),t.setCheckVersionExternalFunction("ENOXVersionExplorerCreateNewRevision",o),t.setCheckVersionExternalFunction("ENOXVersionExplorerDeleteVersion",o),t.setCheckVersionExternalFunction("ENOXVersionExplorerShowMaturity",o),t.hideMenuItem("ENOXVersionExplorerDisplayProperties"),i.isValidItemOnOpen(this.itemType)||t.hideMenuItem("ENOXVersionExplorerOpenVersion"),this.itemType&&i.isPerformanceSpec(this.itemType)&&(t.hideMenuItem("ENOXVersionExplorerDuplicate"),t.hideMenuItem("ENOXVersionExplorerDeleteVersion")),this&&this.specModel&&this.specModel.getAttributeValue("isMEI")&&(t.hideMenuItem("ENOXVersionExplorerCreateNewRevision"),t.hideMenuItem("ENOXVersionExplorerDuplicate"),t.hideMenuItem("ENOXVersionExplorerOpenVersion")),this.subscribeToEvents(t,l)},subscribeToEvents:function(e,o){var i=this;e.subscribeEvent("ENOXVersionExplorerOpenVersion",function(t){e.hideDialog();var o=t.options.grid.id,n={};n.itemPid=o,n.typeActual=t.options.grid.type,i.basicModelEvents.publish({event:l.OPEN_SPECIFICATION_VIEW,data:n})});var s=function(e){let t=i.appCore.specRouteManager.model.currentTabKey;var o=e&&e.options.ancestors&&e.options.ancestors[0]?e.options.ancestors[0].id:void 0;o&&i.specViewerModelEvents&&(i.context.contextId===o?i.specViewerModelEvents.publish({event:l.EVENT_MODEL_UPDATED,data:o}):i.specViewerModelEvents.publish({event:"grid-sync-node-data",data:o}),i.specViewerModelEvents.publish({event:t+"-grid-fetch-mode-update"}))};e.subscribeEvent("ENOXVersionExplorerNewVersionCreated",function(e){s(e)});e.subscribeEvent("preENOXVersionExplorerDeleteVersion",function(r){var p=r;(function(e,o){return new t(function(t,i){var s=new n({id:e,type:o});s.syncModel({onComplete:function(){t(s)},onFailure:function(e,t){i(t)}})})})(p.options.id,p.options.type||p.options.grid.type).then(function(t){i.currentSpecViewer=p.options.id===i.contextObjectId,function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}(t,i.basicOptions),t.container=document.querySelector(".version-explorer-modal"),t.appCore=i.appCore,t.currentTabKey=i.specModel.currentTabKey,t.fireDeleteCallback=function(){s(p),function(){if(i.currentSpecViewer)return e.hideDialog(),void(i.specViewerModelEvents&&i.specViewerModelEvents.publish({event:l.EVENT_IDCARD_CUSTOM_SHOW_LANDING_PAGE,data:""}));console.log("Version Explorer refreshed"),e.publishEvent("ENOXVersionExplorerRefresh",o)}()},c.setOptions({modelEvents:i.basicModelEvents}),c.deleteItem({data:t})})})}})});