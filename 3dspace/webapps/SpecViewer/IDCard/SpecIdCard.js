define("DS/SpecViewer/IDCard/SpecIdCard",["UWA/Class/Model","DS/XSRCommonComponents/utils/Constants","UWA/Core","DS/Controls/TooltipModel","UWA/Class/View","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/utils/TypeUtils","DS/ENOXIDCardContainer/js/ENOXIDCardContainer","DS/XSRCommonComponents/service/XSpecsMenuBuilder","DS/PlatformAPI/PlatformAPI","DS/XSRCommonComponents/service/XSpecsActionsFactory","DS/SpecViewer/IDCard/FreezeZoneContentChangeActionView","DS/XSRCommonComponents/utils/RequestUtil","i18n!DS/SpecViewer/assets/nls/SpecViewer","css!DS/SpecViewer/IDCard/SpecIdCard.css"],function(e,t,i,s,n,a,o,r,l,d,c,p,u,h){"use strict";var m,b,C;return n.extend({setup:function(e){this.appCore=e.appCore,this.specModel=e.specViewerModel,this.itemPid=e.itemPid,this.modelEvents=this.appCore.specViewerModelEvents,this.propertiesPanel=this.appCore.specRightContainer,this.basicModelEvents=this.appCore.basicModelEvents,this.container=this.appCore.specMainContainer,this.triptychManager=this.appCore.triptychManager,this._subscriptions=[]},build:function(){var n=this,u=(n.specModel,n.specModel.getTypeActualName());this.isPhysicalProduct=o.isPhysicalProduct(u),this.isTechnicalSpecification=o.isTechnicalSpecification(u),n.isSmallDevice=widget.body.getSize().width<420;var m=i.createElement("div",{class:"xsr-idcard-changeInformation"});this.changeZone=new p({target:m,specModel:n.specModel,appCore:n.appCore}),this.changeZone.render();var C,v=n.specModel.getDescription()||h.placeholder_NoDescription;(b=i.createElement("div",{class:"xsr-idcard-description xsr-id-card-placeholder",text:v})).tooltipInfos=new s({shortHelp:v,allowUnsafeHTMLShortHelp:!1,mouseRelativePosition:!1,position:"bottom"}),C=void 0!==n.specModel.getThumbnail()&&n.specModel.getThumbnail().startsWith("http")?n.specModel.getThumbnail():"";var E=n.getIDCardAttributesForType(u),M={thumbnail:C,modelEvents:n.modelEvents,withHomeButton:!1,withExpandCollapseButton:!1,withActionsButton:!0,withInformationButton:!0,withToggleMinifiedButton:!0,showBackButton:n.appCore.specRouteManager.hasItemInStackToShow(),freezones:[b,m],attributes:E,customEvents:{informationIconClick:{event:t.EVENT_IDCARD_CUSTOM_INFORMATION_ICON},actionsMenuClick:{event:t.EVENT_IDCARD_CUSTOM_OPEN_ACTIONS_MENU},homeIconClick:{event:t.EVENT_IDCARD_CUSTOM_SHOW_LANDING_PAGE},versionLabelClick:{event:t.EVENT_CUSTOM_LAUNCH_VERSION_EXPLORER},backIconClick:{event:t.EVENT_IDCARD_CUSTOM_GO_BACK},configurationLabelClick:{event:t.EVENT_CUSTOM_LAUNCH_NGFILTER_PANEL}}};if(M.name=n.specModel.getTitle(),M.label=n.specModel.getTitle(),M.version=n.specModel.getRevision(),M.configuration=n.specModel.getNGFilterName()?"["+n.specModel.getNGFilterName()+"]":"",n.isPhysicalProduct){var _=n.specModel.getPartNumber();M.name=M.label=_?_+" - "+n.specModel.getTitle():n.specModel.getTitle()}n.idCardModel=new e(M);this.xIDCard=new r,this.xIDCard.init({withtransition:!0},n.idCardModel);var f=n.specModel;f.itemPid=n.itemPid,f.appCore=n.appCore;var g={data:f};this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_IDCARD_CUSTOM_OPEN_ACTIONS_MENU},function(){var e=document.querySelector(".xapp-id-card-container .fonticon-open-down"),t=event&&event.pageX?{x:event.pageX,y:event.pageY}:e.getBoundingClientRect();l.getIdCardMenu(g,t)}));var I=l.getIdCardMenu(g);if(a.isOriginatedInGLS(this.specModel)){var D=document.getElementsByClassName("xsr-page-top-bar-icons");D&&D.length>0&&D[0].childNodes.forEach(e=>e.remove())}else n.drawTopBarIcons(I);this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_IDCARD_CUSTOM_SHOW_LANDING_PAGE},function(){n.basicModelEvents.publish({event:t.LAUNCH_XSR_HOME_PAGE})})),this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_IDCARD_CUSTOM_GO_BACK},function(){n.appCore.specRouteManager.popItem(n.itemPid)})),this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_IDCARD_ATTRIBUTES_CLICKED},function(e){4===e.index?n.idCardModel.get("attributes")[4].editable&&c.showMaturityGraph(g):2===e.index?n.idCardModel.get("attributes")[2].editable&&c.launchChangeOwnership(g):5===e.index&&n.isPhysicalProduct&&c.setPartNumber(g)})),this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_CUSTOM_LAUNCH_VERSION_EXPLORER},function(){c.launchVersionExplorer(g)})),this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_CUSTOM_LAUNCH_NGFILTER_PANEL},function(){var e={};e.appCore=n.appCore,e.physicalid=n.itemId,e.commandId="DefineFilter",c.launchAdvancedFilter(e)})),this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_IDCARD_CUSTOM_INFORMATION_ICON},function(){n._enableOrDisableLaunchIDIcon(),c.information(g)})),this._subscriptions.push(n.modelEvents.subscribe({event:"xsr-update-change-on-idcard"},function(){var e=n.appCore.WorkUnderContext,t=e&&e.getChange()&&e.getChange().change.id;n.specModel.getChangeActionId();!!t&&n._updateIdCardModel()})),this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_UPDATE_IDCARD_RENDERING},function(e){var t="";t=n.specModel.getNGFilterName()?"["+n.specModel.getNGFilterName()+"]":e?"["+e+"]":"",n.idCardModel.set("configuration",t)})),this._platformSubscribe=d.subscribe("DS/PADUtils/PADCommandProxy/refresh",function(e){var s=!1;if(e.data.authored&&e.data.authored.modified&&(e.data.authored.modified.forEach(function(e){var t;i.is(e,"object")?t=e.physicalid:i.is(e,"string")&&(t=e),n.specModel.getID()!==t&&n.specModel.getChangeActionId()!==t||(s=!0)}),s)){n._updateIdCardModel(function(){n.modelEvents.publish({event:"refresh-current-grid-content"}),n.basicModelEvents.publish({event:t.EVENT_INFORMATION_PANEL_REFRESH})})}}),this._platformXENSubscribe=d.subscribe("XEN/PUBLIC_EVENT/ENGINEERING_ITEM/PART_NUMBER_UPDATED",function(e){if(e&&Array.isArray(e.references)){for(var t=e.references,i=[],s=!1,a=0;a<t.length;a++){var o=t[a].physicalid;i.push(o),o===n.itemPid&&(s=!0)}if(s){n._updateIdCardModel(function(){n.modelEvents.publish({event:"refresh-current-grid-content"})})}}}),this._subscriptions.push(n.modelEvents.subscribe({event:t.EVENT_MODEL_UPDATED},function(e){n._updateIdCardModel()})),n.basicEvents=[],n.handleIconsBasedOnWidth()},_renderInformationPanel:function(){this._enableOrDisableLaunchIDIcon();let e={data:this.specModel,cmdLaunchAt:t.IDCARD};c.information(e)},_enableOrDisableLaunchIDIcon:function(){let e=this.appCore.triptychManager;e.isRightPanelVisible&&(e.commandId!==t.INFORMATION_CMD||e.getCurrentTabKey())?e.setLaunchFromIcon(!1):e.setLaunchFromIcon(!0),e.setCurrentTabKey("")},_updateIdCardModel:function(e){var t=this;m=t.specModel.getMaturity(),C=t.specModel.getTitle();var i=function(i){t._syncModelCallBack(i),e&&e()};t.specModel.syncModel({onComplete:i.bind(t),onFailure:i.bind(t)})},_syncModelCallBack:function(e){if("succesful"!=e)throw new Error(e);this._applyUpdateFromSpecification(this.specModel)},_applyUpdateFromSpecification:function(e){if(this.newMaturityValue=this.specModel.getMaturity(),this.newTitleValue=this.specModel.getTitle(),i.is(m)&&this.newMaturityValue!=m&&(this.modelEvents.publish({event:t.EVENT_RELOAD_REPORT_PREVIEW,data:{}}),"Released"!==this.newMaturityValue&&"Obsolete"!=this.newMaturityValue||this.modelEvents.publish({event:"grid-toolbar-commands-update"})),i.is(C)&&this.newTitleValue!=C&&widget.setTitle(u.setWidgetTitle(this.newTitleValue)),this._updateTopIcons(e),this.idCardModel.set("name",e.getTitle()),this.idCardModel.set("label",e.getTitle()),this.idCardModel.set("version",e.getRevision()),this.idCardModel.set("thumbnail",e.getThumbnail()),this.isPhysicalProduct){var n,a=e.getPartNumber();n=a?a+" - "+e.getTitle():e.getTitle(),this.idCardModel.set("name",n)}var o=this.getIDCardAttributesForType();this.idCardModel.set("attributes",o);var r=e.getDescription()||h.placeholder_NoDescription;b.setText(r),b.tooltipInfos=new s({shortHelp:r,allowUnsafeHTMLShortHelp:!1,mouseRelativePosition:!1,position:"bottom"}),this.changeZone.update(e)},drawTopBarIcons:function(e,t){var n=this,a=function(e){var a=e.title,o=e.cmdID,r=!(!e.state||"disabled"!==e.state),l=e.action.callback,d=e.action.this,c=e.fIcon;if(!t){var p=i.createElement("div",{class:"xsr-page-top-bar-icon wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-"+c});return o&&"Information"==o?p.addEventListener("click",n._renderInformationPanel.bind(n)):p.addEventListener("click",l.bind(d)),p.tooltipInfos=new s({shortHelp:a,allowUnsafeHTMLShortHelp:!1,mouseRelativePosition:!1,position:"bottom"}),r&&(p.addClassName("disabled"),p.removeClassName("enabled")),p}var u=document.getElementsByClassName("xsr-page-top-bar-icon wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-"+c)[0];u&&r?(u.addClassName("disabled"),u.removeClassName("enabled")):u&&(u.addClassName("enabled"),u.removeClassName("disabled"))},o=function(e,s){for(var n=0;n<e.length;n++){var r=e[n],l=r.submenu;if(l)o(l,s),t||i.createElement("div",{class:"xsr-group-icon-seperator"}).inject(s);else{var d=a(r);d&&d.inject(s)}}};e.then(function(e){if(e)if(e=function(e){var t=[],i=[],s=[],n=[],a=function(e){for(var t=0;t<e.length;t++){var o=e[t],r=o.submenu;if(r)a(r);else switch(o.cmdID){case"Information":i.push(o);break;case"DuplicateItem":s.push(o);break;case"MaturityGraph":case"VersionExplorer":i.push(o);break;case"ActionBar_ChangeOwner":n.push(o);break;case"DeleteItem":case"CompareWith":s.push(o);break;case"RelatedObjects":case"MultiOwnership":case"Close":n.push(o)}}};return a(e),t.push({submenu:i}),t.push({submenu:s}),t.push({submenu:n}),t}(e),t&&n.iconDiv)o(e,n.iconDiv);else{n.iconDiv=i.createElement("div",{class:"xsr-page-top-id-card-icons"}),n.isSmallDevice&&n.handleIconsBasedOnWidth(),o(e,n.iconDiv);var a=i.createElement("div",{class:"xsr-page-top-bar-icon wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-expand-up"});a.inject(n.iconDiv),a.tooltipInfos=new s({shortHelp:h.label_Collapse,allowUnsafeHTMLShortHelp:!1,mouseRelativePosition:!1,position:"bottom"}),function(e){e.addEventListener("click",function(){var t=e.hasClassName("wux-ui-3ds-expand-up");n.modelEvents.publish({event:"idcard-toggle-minified-view"}),t?(e.removeClassName("wux-ui-3ds-expand-up"),e.addClassName("wux-ui-3ds-expand-down"),n.isExpanded=!1,e.tooltipInfos=new s({shortHelp:h.label_Expand,allowUnsafeHTMLShortHelp:!1,mouseRelativePosition:!1,position:"bottom"})):(e.removeClassName("wux-ui-3ds-expand-down"),e.addClassName("wux-ui-3ds-expand-up"),n.isExpanded=!0,e.tooltipInfos=new s({shortHelp:h.label_Collapse,allowUnsafeHTMLShortHelp:!1,mouseRelativePosition:!1,position:"bottom"}))}.bind(this))}(a),n.basicModelEvents.publish({event:"xsr-page-top-bar-set-icons",data:{container:n.iconDiv,enableResizer:!0,resizerCallback:n._resizer.bind(n)}})}})},getIDCardAttributesForType:function(){var e=[{name:h.label_Type,value:this.specModel.getType(),displayWhenMinified:!0,type:"type-text"},{name:h.label_CreationDate,value:a.formatDate(this.specModel.getOriginatedDate(),!0),type:"type-text"},{name:h.label_Owner,value:this.specModel.getOwner(),editable:!a.isOriginatedInGLS(this.specModel),type:a.isOriginatedInGLS(this.specModel)?"type-text":"type-hyperlink"},{name:h.label_LastModified,value:a.formatDate(this.specModel.getModifedDate(),!0),type:"type-text"},{name:h.label_Maturity,value:this.specModel.getMaturity(),displayWhenMinified:!0,editable:!a.isOriginatedInGLS(this.specModel),type:a.isOriginatedInGLS(this.specModel)?"type-text":"type-hyperlink"}];return this.isTechnicalSpecification?e.push({name:h.ColumnLockedBy,value:this.specModel.getFileLocker()?this.specModel.getFileLocker():"-",displayWhenMinified:!0,type:"type-hyperlink"}):this.isPhysicalProduct&&e.push({name:h.label_PartNumber,value:this.specModel.getPartNumber()?this.specModel.getPartNumber():h.None,displayWhenMinified:!1,editable:!0,type:"type-hyperlink"}),e},_resizer:function(e){e.offsetWidth<460?(this.isSmallDevice=!0,this.handleIconsBasedOnWidth()):(this.isSmallDevice=!1,this.handleIconsBasedOnWidth())},handleIconsBasedOnWidth:function(){var e=this.container.getElementsByClassName("title-section-buttons");this.isSmallDevice?(this.iconDiv&&this.iconDiv.setStyle("display","none"),e[0]&&(e[0].style.display="block")):(this.iconDiv&&this.iconDiv.setStyle("display","flex"),e[0]&&(e[0].style.display="none"))},_updateTopIcons:function(e){var t=e;t.appCore=this.appCore;var i={data:t},s=l.getIdCardMenu(i);this.drawTopBarIcons(s,!0)},destroy:function(){this.iconDiv&&this.iconDiv.destroy(),this._platformSubscribe&&d.unsubscribe(this._platformSubscribe),this._platformXENSubscribe&&d.unsubscribe(this._platformXENSubscribe),this._subscriptions&&this.modelEvents.unsubscribeList(this._subscriptions),this.basicEvents&&this.basicModelEvents.unsubscribeList(this.basicEvents)}})});