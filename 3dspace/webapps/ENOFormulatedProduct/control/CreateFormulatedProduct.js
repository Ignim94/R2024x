define("DS/ENOFormulatedProduct/control/CreateFormulatedProduct",["UWA/Core","UWA/Controls/Abstract","DS/Controls/TooltipModel","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/createform/view/NewForm","DS/ENOFormulatedProduct/service/FormulatedProductServiceProvider","DS/XSRCommonComponents/utils/XInfraRequestUtil","DS/XSRCommonComponents/utils/Notification","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XSRSearch","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/createform/util/FormJson","DS/XSRCommonComponents/utils/TypeUtils","DS/XSRCommonComponents/utils/Utils","i18n!DS/ENOFormulatedProduct/assets/nls/FormulatedProduct"],function(e,t,i,n,s,o,a,l,r,d,u,c,m,h,p,f,F,g){"use strict";return t.extend({newForm:null,templateList:null,formFields:null,target:null,options:null,dialog:null,CADInsertables:null,CAD_ORIGIN_TYPE_V6:"V6",CAD_ORIGIN_TYPE_V5:"V5",onlyFormulated:!1,searchKeyMappings:{coreMaterials:{resourceid:"physicalid","ds6w:what/ds6w:status":"CURRENT","ds6w:label":"LABEL","ds6w:identifier":"name","ds6w:what/ds6w:type":"type","ds6w:who/ds6w:responsible":"owner"}},init:function(e){this._parent(e),this.basicModelEvents=e.appCore.basicModelEvents,this.target=e.appCore.specMainContainer,this.createCloseAction=e.onCreateSuccess,this.createAction=e.createAction,this.parentId=e.parentId,this.parentTitle=e.parentTitle,this.advanceUi=e.advanceUi||!1,this.dimensionData=[]},execute:function(){this.container=widget.body,c.maskLoader(this.container);let e=(new p).getFormulaJSON();this.initDetailedView(e)},initDetailedView:function(e){var t=e;this.formulaAttributes=[];var i=n.workUnderContext?n.workUnderContext.getChange():void 0;i&&i.change&&i.change.id&&(t.showWorkUnderIndicator=!0,t.workUnderTitle=i.change.title),this.newForm=new o(t).render(),this.formFields=this.newForm.formfieldControls;var a=this,l=this.options;l.Title=g.Title,a.parentTitle&&(l.Title+=" | "+a.parentTitle),l.Content=this.newForm.container,l.width=500,l.renderTo=this.target,c.unmaskLoader(this.container),this.dialog=new s(l),this.dialog.destroyPrevDialog(),this.dialog.render(),this.newForm.listenTo(this.newForm,"EVENT_SEARCH_GLOBAL",e=>a.evt_SearchGlobal(e)),this.newForm.listenTo(this.newForm,"SELECT_CHANGE_EVENT",e=>a.evt_SelectChange(e)),this.newForm.listenTo(this.newForm,"SELECT_CHANGE_EMPTY_EVENT",e=>a.evt_SelectChangeEmpty(e)),this.newForm.listenTo(this.newForm,"CONTAINS_DIRTY_FIELD",function(e){a.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",e)}),this.newForm._fields.type&&this.loadType(),this.newForm._fields.formuladimension&&this.loadDimensions(),this.newForm._fields.batchdimension&&this.loadBatchDimensions(),this.newForm._fields.batchuomquantity&&this.loadBatchUnitOfMeasurements(),this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_OK",function(){a.validateFields()&&(a.enableOrDisableDialogButtons(!1),a.dialog.closeDialog(),a.showCreateLoader(),a.createFP().then(a.createFormulaCB.bind(a),a.onError.bind(a)))}),this.dialog.listenTo(this.dialog,"EVENT_CLICK_SPEC_APPLY",function(){var e=a.validateFields();if(e){a.enableOrDisableDialogButtons(e);var t=g.replace(g.get("CreatingFormulatedLoader"),{title:a.getInput("Title")});a.dialog.maskOrUnMaskDialog(t),a.createFP().then(a.createFormulaApplyCB.bind(a)).catch(a.onError.bind(a))}})},loadDimensions:function(){var e=this,t=f.getDimensions(),i=[];Object.keys(t).forEach(function(n){i.push({labelItem:e.newForm.isNonNlsLabel(t[n])?n:t[n],valueItem:n})}),e.newForm.updateField(i,"FormulaDimension",!1)},loadType:function(){var e=[],t=[],i=-1,n=[];(n=F.getFormulatedDMSTypes())&&(n.forEach(function(t,n){e.push({labelItem:t.labelItem,valueItem:t.valueItem}),"Formulated_Product"===t.valueItem&&(i=n)}),t.push(e[i]),e.splice(i,1),t=t.concat(e),this.newForm.updateField(t,"Type",!1),1===t.length&&(this.formFields.Type.inputfield.value=t[0].labelItem,this.formFields.Type.inputfield.disabled=!0,this.onlyFormulated=!0))},loadBatchDimensions:function(){var e=this,t=f.getDimensions(),i=[];Object.keys(t).forEach(function(n){i.push({labelItem:e.newForm.isNonNlsLabel(t[n])?n:t[n],valueItem:n})}),e.newForm.updateField(i,"BatchDimension",!1)},dimensionChangeEvent:function(e){var t=this,i=f.getUOMUnits(e),n=[];Object.keys(i).forEach(function(e){n.push({labelItem:t.newForm.isNonNlsLabel(i[e])?e:i[e],valueItem:e})}),n.sort(function(e,t){let i=e.labelItem.toLowerCase(),n=t.labelItem.toLowerCase();return i>n?1:i<n?-1:0}),t.newForm.updateField(n,"BatchUOMQuantity",!1),this.formFields.BatchUOMQuantity.inputfield.placeholder=g.ChooseUnit},loadBatchUnitOfMeasurements:function(){var e=this,t=new d;t.prepareUpdate();var i=f.getDimensions();Object.entries(i).forEach(([i,n])=>{let s=e.createNode(n,i);t.addRoot(s);var o=f.getUOMUnits(i),a=Object.fromEntries(Object.entries(o).sort(([,e],[,t])=>e.localeCompare(t)));Object.keys(a).forEach(function(t){var n=e.createNode(e.newForm.isNonNlsLabel(a[t])?t:a[t],t+":"+i);s.addChild(n)})}),t.expandAll(),t.pushUpdate(),e.newForm.updateField(t,"BatchUOMQuantity",!0),this.formFields.BatchUOMQuantity.inputfield.placeholder=g.SelectUnitMeasure},loadTemplate:function(e){if(this.formFields.Template){var t=new l({id:"getSpecTemplates"});this.templateList=t.invoke({data:{specType:e}}).then(e=>{this.templateList=e,this.templateList&&this.templateList.response.length>0?(this.newForm.updateField(this.templateList.response,"Template",!1),this.formFields.Template.inputfield.placeholder=g.SelectTemplate):(this.newForm.updateField(this.templateList.response,"Template",!1),this.formFields.Template.inputfield.elementsList="",this.formFields.Template.inputfield.placeholder=g.NoResults)}).catch(e=>{console.log(e),this.formFields.Template.inputfield.elementsList="",this.formFields.Template.inputfield.placeholder=g.NoResults})}},createFP:function(){var e={};e.title=this.getInput("Title");var t=this.getInput("Type");e.type=t,this.parentId&&(e.parentId=this.parentId),e.description=this.getInput("Description")||"",e.dimension=this.getInput("FormulaDimension")||"";var i=this.getInput("BatchUOMQuantity")||"";e.attributes=this.fetchformulaAttributes();var n={};n.dimension=i.split(":")[1]?i.split(":")[1]:"";var s=this.getInput("TargetQuantity")||"",o=[],l=i.split(":")[0]?i.split(":")[0]:"";return o.push(s+" "+l),n.refQuantity=o,e.delfMiRefQuantity=n,new a({isChangeControlled:!0}).createFormulatedProduct({data:e})},evt_SearchGlobal:function(e){var t=this;let i,n=t.formFields[e].inputfield[0];i=n.selectedItems?n.selectedItems._options.label:n.value;let s=t.getAllowedTypesToSearch(e);var o;new m(o={allowedTypes:s,role:"",subType:"",criteria:i,precondition:"",in_apps_callback:function(i){t.newForm.setValueInAutocomplete(i[0]["ds6w:label"],i[0].id,e),t.newForm.checkDirtyFields.call(t)},excludeList:[]}).launchSearch(o)},evt_SelectChange:function(e){if("batchdimension"===e.toLowerCase()){let e=this.getInput("BatchDimension");this.formFields.BatchUOMQuantity.inputfield.value="",this.dimensionChangeEvent(e)}if("batchuomquantity"===e.toLowerCase()){let e=this.getInput("BatchUOMQuantity");e&&("Area"!==e&&"Mass"!==e&&"Length"!==e&&"Volume"!==e||(this.formFields.BatchUOMQuantity.inputfield.value=null))}if("type"===e.toLowerCase()&&this.newForm._fields.template){var t=this.getInput("Type");this.formFields.Template.inputfield.value="",this.loadTemplate(t)}},createFormulaApplyCB:function(e){if(e&&e.success){r.displayNotification({eventID:"success",msg:g.get("FormulatedProductSucess")});var t=e.result,i=this.getInput("Template");this.createSpecReport(t.physicalId,i),this.createAction&&this.createAction(t.physicalId),this.resetFields(),this.dialog.maskOrUnMaskDialog(),this.enableOrDisableDialogButtons(!1)}else this.onError()},showCreateLoader:function(){var e=this.getInput("Title"),t=g.replace(g.get("CreatingFormulatedLoader"),{title:e});c.maskLoader(this.container,t)},stopLoader:function(){c.unmaskLoader(this.container)},createFormulaCB:function(e){var t=this;if(!e||e.success){if(null!=e){var i=e.result;t.createCloseAction&&(t.createCloseAction(i.physicalId,i.type),function(){if(t.stopLoader(),r.displayNotification({eventID:"success",msg:g.get("FormulatedProductSucess")}),!t.parentId){var n={};n.itemPid=e.result.physicalId,n.typeActual=g.FormulatedProduct_Type}var s=t.getInput("Template");t.createSpecReport(i.physicalId,s)}())}}else{c.unmaskLoader(t.container);var n=e&&e.message?e.message:g.PhysicalPrdCreateFailure;r.displayNotification({eventID:"error",msg:n||g.PhysicalPrdCreateFailure})}},enableOrDisableDialogButtons:function(e){e?this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!1}):this.dialog.dispatchEvent("CONTAINS_DIRTY_FIELD",{hasDirtyField:!0})},onError:function(e){var t;this.enableOrDisableDialogButtons(this.validateFields()),this.stopLoader(),this.dialog.maskOrUnMaskDialog(),c.unmaskLoader(this.container),t=e&&e.result.message?e.result.message:e&&e.message?e.message:g.PhysicalPrdCreateFailure,r.displayNotification({eventID:"error",msg:t})},resetToolTip:function(){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:""})},setToolTip:function(e){this.formFields.Template.inputfield.tooltipInfos=new i({shortHelp:e.description})},validateFields:function(){var t,i,n=!0,s=!1;for(t in this.formFields)if(this.formFields.hasOwnProperty(t)){var o=this.formFields[t];if(o.inputfield&&o.inputfield.fieldoptions){var a=!!e.is(o.parentfield)&&o.parentfield.isHidden(),l=!!e.is(o.inputfield.fieldoptions)&&o.inputfield.fieldoptions.mandatory,d=e.is(o.inputfield.fieldoptions)?o.inputfield.fieldoptions.label:"";if(!a&&l)if(!this.hasValue(o.inputfield.value))o.inputfield._giveFocus(),s=!0,i=void 0!==i?i+","+d:d,n=!1}}return s&&r.displayNotification({eventID:"error",msg:g.RequiredFields+i}),n},resetFields:function(){this.newForm.resetFields(this.advanceUi)},hasValue:function(e){return null!=e&&""!==e},fetchformulaAttributes:function(){var e=this,t={};let i=e.formulaAttributes;return Object.keys(i).forEach(function(n){let s=i[n],o=e.getInput(s.split(".")[1].toLowerCase());t[s]=o}),t[g.RevisonComment]=e.getInput("RevisionComment"),t},fetchInstanceAttributes:function(e){return{dimension:this.getInput("Dimensions"),childId:e}},getAllowedTypesToSearch:function(e){let t;switch(e.toLowerCase()){case"material":t=["dsc_matref_ref_Core"];break;default:t=[]}return t},setKeyMappings:function(e){this._keyMappings=e},getKeyMappings:function(){return this._keyMappings},evt_SelectChangeEmpty:function(e){"type"===e.toLowerCase()?this.formFields.Template&&this.newForm.updateField(null,"Template",!1):"formuladimension"===e.toLowerCase()?this.loadDimensions():"batchdimension"===e.toLowerCase()&&this.loadBatchDimensions()},createSpecReport:function(e,t,i){if(this.hasValue(t)){var n={data:{itemPid:e,template:t}};new l({id:"SpecificationReport"}).create(n).then(function(e){var t=e.specPid;i&&i(t)}.bind(this)).catch(this.onError.bind(this))}else i&&"function"==typeof i&&i()},createNode:function(e,t){return new u({label:e,value:t})},getInput:function(e){if(this.formFields[e]||"V_DimensionType".toLowerCase()===e)return"V_DimensionType".toLowerCase()===e?this.formFields.Dimensions.inputfield.value:this.formFields[e].inputfield.value}})});