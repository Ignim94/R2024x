define("DS/SpecGridView/controller/GridCollectionToolBar",["UWA/Core","UWA/Class","DS/Menu/Menu","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XspecEvents","DS/XSRCommonComponents/utils/TypeUtils","DS/XSRCommonComponents/utils/Constants","DS/ENOXCollectionToolBar/js/ENOXCollectionToolBar","DS/XSRCommonComponents/utils/Notification","i18n!DS/SpecGridView/assets/nls/SpecGridView"],function(e,t,n,i,o,a,r,s,d,l){"use strict";return t.extend({init:function(e){this.indexSwitcherTimeout=null,this.appCore=e.appCore,this.modelEvents=e.appCore.specViewerModelEvents,this.currentTabKey=e.currentTabKey,this.target=e.target,this.preferredView=e.preferredView,this.container=e.container,this.toolBarEvents=new o,this.hiddenCmds=[],this.currentViewType,this._subscribeEvents(),this.parentModel=e.parentModel},draw:function(e){e&&(this.target=e);var t={modelEvents:this.toolBarEvents,withmultisel:!0,showItemCount:!0,actions:this.actionCommands,multiselActions:null,multiselActionCallback:this.getMultipleActions.bind(this),filter:{multiselect:!1,enableCache:!1},sort:[],currentView:this.preferredView?this.preferredView:r.GRID_VIEW,views:this.currentTabKey===r.FACET_MBMF||this.currentTabKey===r.FORMULABOM_TAB||"bom"===this.currentTabKey?[]:[{id:r.BIG_TILE,text:l.bigTile,fonticon:"view-big-tile"},{id:r.GRID_VIEW,text:l.DataGridView,fonticon:"tree-table"}],currentNbitems:0,currentNbSelections:0};if(this.collectionToolbar=new s(t),this.collectionToolbar.inject(e),this.hideCommand("ResetChanges"),this.hideCommand("Unwraptext"),"bom"===this.currentTabKey||this.currentTabKey===r.FORMULABOM_TAB)if("index"===widget.getValue("fetchmode"))parseInt(widget.getValue("intervalswitchpreference"))>0?this.hideCommand("authormode"):this.hideCommand("indexmode");else if(parseInt(widget.getValue("intervalswitchpreference"))>0){parseInt(widget.getValue("previousindexed"))+parseInt(widget.getValue("intervalswitchpreference"))<Math.floor(Date.now()/1e3)?(this.hideCommand("authormode"),widget.setValue("fetchmode","index")):(this.hideCommand("indexmode"),this.initiateTimer())}else this.hideCommand("indexmode")},initiateTimer(){let e=this;e.indexSwitcherTimeout&&clearTimeout(e.indexSwitcherTimeout);var t=parseInt(widget.getValue("intervalswitchpreference"))||.02;e.indexSwitcherTimeout=setTimeout(function(){e.indexSwitcherTimeout=null,e.hideCommand("authormode"),e.showCommand("indexmode"),parseInt(widget.getValue("intervalswitchpreference"))>0&&d.displayNotification({eventID:"info",msg:l.INDEX_MODE_ACTIVE}),widget.setValue("fetchmode","index"),e.launchCommand("authormode")},1e3*t)},_subscribeEvents:function(e){var t=this;this.subscriptionList=[],this.modelEvents&&(this.subscriptionList.push(this.modelEvents.subscribe({event:r.UPDATE_ITEMVIEW_TOOLBOOR_COUNT},function(e){var n=t.currentModel?t.currentModel.getSelectedNodes().length:0;n>0?t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_CHECKBOX_CHECK_FLAG,data:{}}):t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_CHECKBOX_UNCHECK_FLAG,data:{}}),t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_SELECTIONS_COUNT_UPDATE,data:n}),t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_EVENT_UPDATE_COUNT,data:n})})),this.subscriptionList.push(t.modelEvents.subscribe({event:"xsr-toolbar-switch-fetch-mode-to-author"},function(){t.switchToAuthorMode()})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-show-toolbar-reset-command-"+t.currentTabKey:"xsr-show-toolbar-reset-command"},function(){t.showCommand("ResetChanges")})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-hide-toolbar-reset-command-"+t.currentTabKey:"xsr-show-toolbar-reset-command"},function(){t.hideCommand("ResetChanges")})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-hide-toolbar-makeFrom-command-"+t.currentTabKey:null},function(e){e&&(t.hideMBMFCommand=e.disableMBMFCmd,t.hideMBMFFPCommand=e.disableMBMFCmd)})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-hide-toolbar-add-corematerial-command-"+t.currentTabKey:null},function(e){e&&(t.disableAddCoreMatCmd=e.disableAddCoreMatCmd)}))),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_EVENT_ALL_SELECTED},function(e){t.currentModel.gridLayout.collectionView.selectAll(!0)}),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_EVENT_ALL_UNSELECTED},function(e){t.currentModel.unselectAll()}),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_EVENT_VIEW_ACTIVATED},function(e){e!==t.currentViewType&&(t.currentViewType=e,t.launchResetModelChanges(),t.switchView(e))}),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_SEARCH},function(e){var n=t.currentModel;n.prepareUpdate();var i=n.getChildren();if(t.showAllNodes(i),t.parentModel.getAllDescendants().forEach(e=>{e._isHidden=!1}),!e.searchValue[0]||0===e.searchValue.length)return t.baseModel?void t.baseModel.pushUpdate():void n.pushUpdate();var o=[],a=[],s=[];n.search({match:function(n){var i,d=n.nodeModel;if(!d._canBeGrouped())return!1;if(!d.getTitle)return!0;if(d.currentTabKey===r.MEI_TAB||void 0!==d.getMEIInterface&&d.getMEIInterface()===r.MEI_INTERFACE)i=d.getTitle()+" "+d.getMaturity()+" "+d.getType()+" "+d.getName()+" "+d.getRevision()+" "+d.getOriginatedDate()+" "+d.getModifedDate()+" "+d.getDescription()+" "+d.getMftPartNo()+" "+d.getManufacturer()+" "+d.getPartSource()+" "+d.getPartSourceURL()+" "+d.getOwner()+" "+d.getEqQualIsPreferred();else{let e=widget.getValue(r.PERSISTENCY_BOM_VIEW);var l=d.getPartNumber?d.getPartNumber():"",c=d.getAsRequired?d.getAsRequired():"",u=d.getInstanceCount?d.getInstanceCount():"",h=d.getUnit?d.getUnit():"",m=d.getMBMFReferenceName?d.getMBMFReferenceName():"",p=d.getCoreMat?d.getCoreMat():"",g=d.getAllAttributeValue?d.getAllAttributeValue():"";i=l+" "+c+" "+u+" "+h+" "+(d.getTitle?d.getTitle():"")+" "+(d.getMaturity?d.getMaturity():"")+" "+(d.getType?d.getType():"")+" "+(d.getName?d.getName():"")+" "+(d.getRevision?d.getRevision():"")+" "+(d.getModifedDate?d.getModifedDate():"")+" "+(d.getOriginatedDate?d.getOriginatedDate():"")+" "+(d.getDescription?d.getDescription():"")+" "+(d.getOwner?d.getOwner():"")+" "+m+" "+p+" "+g,!e&&d.getInstanceTitle&&(i+=d.getInstanceTitle())}if(e.searchValue[0]&&-1!==i.toUpperCase().indexOf(e.searchValue[0].toUpperCase())){if(d.setSearchFilterState&&d.setSearchFilterState(!0),"bom"===t.currentTabKey||"formulatedbom"===t.currentTabKey){let e=d.getParent();for(o.push(d.getID()),a.push(d),d.getInstanceId&&d.getInstanceId()&&s.push(d.getInstanceId());null!=e&&(e.getID&&(o.push(e.getID()),e.getInstanceId&&e.getInstanceId()&&s.push(e.getInstanceId())),null!==(e=e.getParent())););d.getRoot()&&d.getRoot().getID()&&(o.push(d.getRoot().getID()),d.getRoot().getInstanceId&&d.getRoot().getInstanceId()&&s.push(d.getRoot().getInstanceId()))}return!1}return d.setSearchFilterState&&d.setSearchFilterState(!1),!0}}).forEach(function(e,t){e._canBeGrouped()&&e.getTitle&&(e.getID&&o.includes(e.getID())&&(!e.getInstanceId||e.getInstanceId&&!e.getInstanceId()||e.getInstanceId&&s.includes(e.getInstanceId()))||(e.unmatchSearch(),e.setSearchFilterState&&e.setSearchFilterState(!1),e.applyFilters&&e.applyFilters()))}),n.pushUpdate();let d="post-filter-search";t.currentTabKey&&(d+="-"+t.currentTabKey),n.xsrModelEvents.publish({event:d,data:a})})},showAllNodes:function(e){var t=this;e&&Array.isArray(e)&&e.forEach(function(e,n){if(e._canBeGrouped()){if(e.setSearchFilterState&&e.setSearchFilterState(!0),e._options.children&&e._options.children.length>0){e._options.children.forEach(e=>{e.setSearchFilterState&&e.setSearchFilterState(!0),e._isHidden=!1})}e.applyFilters&&e.applyFilters()}else t.showAllNodes(e.getChildren())})},switchView:function(e){var t=this.currentTabKey?"grid-toolbar-switch-view-"+this.currentTabKey:"grid-toolbar-switch-view";this.modelEvents&&this.modelEvents.publish({event:t,data:e})},getMultipleActions:function(e){var t=this.currentTabKey?r.UPDATE_MULTI_TOOLBAR_MENU+"-"+this.currentTabKey:r.UPDATE_MULTI_TOOLBAR_MENU;this.modelEvents&&this.modelEvents.publish({event:t,data:{target:e}})},setActions:function(e){this.actionCommands=this.drawMenus(e)},setCurrentModel:function(e){this.currentModel=e,this.baseModel=e},setTooltip:function(e,t,n,i){if("bomViews"===e.id&&n&&e.tooltip){let n=widget.getValue(t);var o;o=void 0!==n?n?l.label_QuantityMode:l.label_InstanceMode:i?l.label_QuantityMode:l.label_InstanceMode,e.tooltip.getBody().setText(o)}},setDefaultTooltip:function(e,t,n,i){if("bomViews"===e&&i){let e=widget.getValue(n);return void 0!==e?e?l.label_QuantityMode:l.label_InstanceMode:t}},setCommandFontIcon:function(e,t,n,i){if("bomViews"===e.id&&n&&e.fonticon){let n,o,a=widget.getValue(t),r="fonticon fonticon-";void 0!==a?(n=a?"object-reference":"object-instance",o=a?r+"object-reference":r+"object-instance"):(n=i?"object-reference":"object-instance",o=i?r+"object-reference":r+"object-instance"),e.fonticon=n,e.elements.icon.className=o}},getCommandIcon:function(e,t,n){if("bomViews"===e){let e=widget.getValue(t);return void 0!==e?e?"object-reference":"object-instance":n}},drawMenus:function(e){var t=[],n=this;if(e.forEach(function(e){var i={};i.id=e.key;var o=e.persistencyKey,a=e.isSelectable;if(i.text=e.text,i.title=e.text,i.fonticon=e.fonticon,i.disabled=e.disabled,o&&a){let t=n.setDefaultTooltip(e.key,e.text,o,a);i.title=i.text=t;let r=n.getCommandIcon(e.key,o,i.fonticon);i.fonticon=r}var r=e.subMenu;i.handler=r?function(e){var t=e.target.getBoundingClientRect();n.drawSubMenu(t,r,this,o,a)}:n.launchCommand.bind(n,e.key),t.push(i)}),this.currentTabKey!==r.FACET_MBMF&&"test-method-facet"!==this.currentTabKey){var i={id:"Export"};i.text=l.ExportCSV,i.title=l.ExportCSV,i.fonticon="export",i.handler=n.launchCommand.bind(n,"Export"),t.push(i)}if("bom"===this.currentTabKey||this.currentTabKey===r.FORMULABOM_TAB){var o={id:"authormode"};o.text=l.AuthorMode,o.title=l.AuthorMode,o.fonticon="database-hourglass infoIconActive",o.handler=function(){n.hideCommand("authormode"),n.showCommand("indexmode"),parseInt(widget.getValue("intervalswitchpreference"))>0&&d.displayNotification({eventID:"info",msg:l.INDEX_MODE_ACTIVE}),n.indexSwitcherTimeout&&clearTimeout(n.indexSwitcherTimeout),widget.setValue("fetchmode","index"),n.launchCommand(o.id)},t.push(o);var a={id:"indexmode"};a.text=l.IndexMode,a.title=l.IndexMode,a.fonticon="database-refresh",a.handler=function(){n.switchToAuthorMode()},t.push(a)}if("test-method-facet"!==this.currentTabKey){var s={id:"personalize"};s.text=l.PersonalizeView,s.title=l.PersonalizeView,s.fonticon="cog",s.handler=n.launchCommand.bind(n,"personalize"),t.push(s)}var c={id:"Wraptext"};c.text=l.Wrap,c.title=l.Wrap,c.fonticon="text-wrapping-ok",c.handler=n.launchWrapText.bind(n),t.push(c);var u={id:"Unwraptext"};u.text=l.Unwrap,u.title=l.Unwrap,u.fonticon="text-wrapping-off",u.handler=n.launchUnWrapText.bind(n),t.push(u);var h={id:"ResetChanges"};return h.text=l.ResetChanges,h.title=l.ResetChanges,h.fonticon="reset",h.handler=n.launchResetModelChanges.bind(n),t.push(h),t},switchToAuthorMode:function(){this.hideCommand("indexmode"),this.showCommand("authormode"),this.launchCommand("indexmode"),parseInt(widget.getValue("intervalswitchpreference"))>0>0?"index"===widget.getValue("fetchmode")&&(d.displayNotification({eventID:"info",msg:l.AUTHOR_MODE_ACTIVE}),widget.setValue("fetchmode","author"),widget.setValue("previousindexed",Math.floor(Date.now()/1e3)),this.initiateTimer()):(widget.setValue("fetchmode","author"),widget.setValue("previousindexed",Math.floor(Date.now()/1e3)))},launchResetModelChanges:function(){this.currentModel&&(this.currentModel.cancelChanges(),this.hideCommand("ResetChanges"))},launchWrapText:function(){i.maskLoader(this.container,l.WrapLoader);try{this.currentModel.gridLayout.collectionView.prepareUpdateView();for(var e=this.currentModel.gridLayout.columns,t=0;t<e.length;t++){var n=e[t];if("FormulaQunatityPercent"===n.dataIndex||"FormulaQuantityRange"===n.dataIndex)for(let e=0;e<n.children.length;e++)this.coreWrapOperation(n.children[e]);else this.coreWrapOperation(n)}this.currentModel.gridLayout.collectionView.pushUpdateView({updateCellContent:!0,updateCellLayout:!0,updateCellAttributes:!0},!0),this.hideCommand("Wraptext"),this.showCommand("Unwraptext"),i.unmaskLoader(this.container)}catch(e){console.error("Wraping failed!! "+e),i.unmaskLoader(this.container)}},coreWrapOperation:function(e){var t=e.dataIndex;"tree"!==e.typeRepresentation&&"string"!==e.typeRepresentation||(e._defaulttypeRepresentation=e.typeRepresentation,this.currentModel.gridLayout.setColumnTypeRepresentation(t,"textBlock")),this.currentModel.gridLayout.setColumnAutoRowHeightFlag(t,!0)},launchUnWrapText:function(){i.maskLoader(this.container,l.UnwrapLoader);try{this.currentModel.gridLayout.collectionView.prepareUpdateView();for(var e=this.currentModel.gridLayout.columns,t=0;t<e.length;t++){var n=e[t];if("FormulaQunatityPercent"===n.dataIndex||"FormulaQuantityRange"===n.dataIndex)for(let e=0;e<n.children.length;e++)this.coreUnwrapOperation(n.children[e]);else this.coreUnwrapOperation(n)}this.currentModel.gridLayout.collectionView.pushUpdateView({updateCellContent:!0,updateCellLayout:!0,updateCellAttributes:!0},!0),this.hideCommand("Unwraptext"),this.showCommand("Wraptext"),i.unmaskLoader(this.container)}catch(e){console.error("Unwraping failed!! "+e),i.unmaskLoader(this.container)}},coreUnwrapOperation:function(e){var t=e.dataIndex;"textBlock"===e.typeRepresentation&&(e.typeRepresentation=e._defaulttypeRepresentation),this.currentModel.gridLayout.setColumnAutoRowHeightFlag(t,!1)},hideCommand:function(e){var t=this.target?this.target.getElementsByTagName("li")[e]:void 0;t&&(t.setStyle("display","none"),-1===this.hiddenCmds.indexOf(e)&&this.hiddenCmds.push(e))},showCommand:function(e){var t=this.target?this.target.getElementsByTagName("li")[e]:void 0;t&&(t.setStyle("display","inline-block"),this.hiddenCmds.splice(this.hiddenCmds.indexOf(e),1))},drawSubMenu:function(e,t,i,o,s){var d=this;if(d.currentTabKey===r.BOM_TAB&&d.currentModel&&1===d.currentModel.getSelectedNodes().length){let e=d.currentModel.getSelectedNodes()[0].getTypeActualName();e&&a.isRawMaterial(e)&&(d.hideMBMFCommand=!0,d.hideMBMFFPCommand=!0),e&&a.isFormulatedProduct(e)&&(d.hideMBMFFPCommand=!0)}if(t){var l=function(e){var t=[];return e.forEach(function(e){var n={};if(n.title=e.text,"CheckItem"==e.type?n.type=e.type:n.type=e.type&&"separator"===e.type?"TitleItem":"PushItem",!d.hideMBMFCommand||"addMBMFItem"!==e.key&&"addMBMFRawMat"!==e.key||(n.state="disabled"),d.hideMBMFFPCommand&&"addMBMFFP"===e.key&&(n.state="disabled"),d.disableAddCoreMatCmd&&"addMaterial"===e.key&&(n.state="disabled"),o){let t=widget.getValue(o);null!=t?e.isDefault?n.state=t?"selected":"unselected":n.state=t?"unselected":"selected":(e.isDefault,n.state=e.isDefault?"selected":"unselected")}if(e.subMenu){e.fonticon&&(n.fonticon={family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-"+e.fonticon}),n.action={this:this,callback:function(t){d.launchCommand(e.key)}};var a=l(e.subMenu);n.submenu=a}else"PushItem"!==n.type&&"CheckItem"!==n.type||(e.fonticon&&(n.fonticon={family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-"+e.fonticon}),n.action={this:this,callback:function(t){!e.isDefault&&s?widget.setValue(o,!1):e.isDefault&&s&&widget.setValue(o,!0),d.setTooltip(i,o,s,e.isDefault),d.setCommandFontIcon(i,o,s,e.isDefault),d.launchCommand(e.key),["expandall","expandNLevel","collapseall"].includes(e.key)&&d.changeTooltipFontIcon(i,e)}});t.push(n)}),t};d.subMenus=l(t),n.show(d.subMenus,{position:{x:e.left,y:e.bottom}})}},disableCommands:function(e){for(var t=0;t<e.length;t++){var n=e[t];this.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_COMMAND_DISABLE,data:n}),this.hiddenCmds.indexOf(n)>=0&&this.hideCommand(n)}},enableCommands:function(e){for(var t=0;t<e.length;t++){var n=e[t];this.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_COMMAND_ENABLE,data:n}),this.hiddenCmds.indexOf(n)>=0&&this.hideCommand(n)}},launchCommand:function(e){var t=this.currentTabKey?"grid-toolbar-action-click-"+this.currentTabKey:"grid-toolbar-action-click";this.modelEvents&&this.modelEvents.publish({event:t,data:e})},changeTooltipFontIcon:function(e,t){e.tooltip.getBody().setText(t.text),e.fonticon="fonticon fonticon-"+t.fonticon,e.elements.icon.className="fonticon fonticon-"+t.fonticon},destroy:function(){this.subscriptionList&&this.modelEvents&&this.modelEvents.unsubscribeList(this.subscriptionList),this.indexSwitcherTimeout&&clearTimeout(this.indexSwitcherTimeout),this.toolBarEvents.unsubscribeAll()}})});