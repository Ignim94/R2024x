define("DS/CATRgrReportStatusBPS/ReportStatusLogics",["require","exports","DS/CATRgnWidgetCommons/restClient/ReportServices","DS/CATRgnWidgetCommons/restClient/CommonServices","DS/CATRgnWidgetCommons/utils/RGNConstants","DS/CATRgnWidgetCommons/utils/RGNConstants","DS/CATRgnWidgetCommons/utils/AsyncExecutor"],function(t,e,s,o,n,i,r){"use strict";function a(t){var e;return i.getReportStatus(null===(e=null==t?void 0:t.generation)||void 0===e?void 0:e.status)}function u(t){return void 0!==t&&void 0!==t.name}Object.defineProperty(e,"__esModule",{value:!0}),e.StatusProcessing=e.StatusApiImpl=e.isGetStatusReportResponse=e.isReportGenerationStatus=e.getReportStatusEnum=void 0,e.getReportStatusEnum=a,e.isReportGenerationStatus=u,e.isGetStatusReportResponse=function(t){return t&&t.hasOwnProperty("uptodate")};function c(t){const{error:e,message:s,response:o}=t,n=e instanceof Error?e:void 0;return{error:n,message:"string"==typeof s?s:null==n?void 0:n.message,response:o}}e.StatusApiImpl=class{constructor(t,e){this.service=t,this.securityContext=e}generationStatus(t){const e=(new o.HeadersBuilder).addSecurityContext(this.securityContext).build();return s.generationStatus(this.service,e,t)}upToDateStatus(t){const e=(new o.HeadersBuilder).addSecurityContext(this.securityContext).build();return s.getStatus(this.service,e,t)}};e.StatusProcessing=class{constructor(t,e){this.statusApi=t,this.statusUI=e,this.reports={},this.upToDateStatus={},this.nextLoadIds=new Set,this.displayedIds=[],this.threeDSpaceQueue=new r.AsyncExecutor(10),this.generationStatusQueue=new r.AsyncExecutor(5,this.threeDSpaceQueue),this.upToDateStatusQueue=new r.AsyncExecutor(5,this.threeDSpaceQueue)}setDisplayedIds(t){const e=t.filter(t=>!this.reports[t]&&!this.displayedIds.includes(t));this.displayedIds=t,this.addReportIdsToLoad(e),this.delayedUpdateGenerationStatus(300)}refresh(){this.displayGenerationStatus();for(const[t,e]of Object.entries(this.upToDateStatus))this.displayedIds.includes(t)&&this.statusUI.displayUpToDateStatus(t,e)}addReportIdsToLoad(t){for(const e of t)this.nextLoadIds.add(e)}delayedUpdateGenerationStatus(t){!this.inGenerationTimeout&&this.nextLoadIds.size>0&&(this.inGenerationTimeout=setTimeout(async()=>{this.inGenerationTimeout=void 0;let t=Array.from(this.nextLoadIds);this.nextLoadIds=new Set,this.updateGenerationStatusBatches(t,10)},t))}updateGenerationStatusBatches(t,e){for(let s=0;s<t.length;s+=e)this.updateGenerationStatus(t.slice(s,s+e))}storeGenerationStatus(t,e,s){var n,i,r,a;if(e&&o.isPartialSuccessStatus(e.status))for(const o of e.status.details){const e=t[o.referenceIndex];e?this.reports[e]={id:e,errorMessage:null!==(i=null!==(n=o.message)&&void 0!==n?n:s)&&void 0!==i?i:"Failed to get status"}:console.warn("Reference index not corresponding to requested ids",o,t)}if(null==e?void 0:e.reports)for(const t of e.reports)this.reports[t.id]=t;for(const e of t)null!==(r=(a=this.reports)[e])&&void 0!==r||(a[e]={id:e,errorMessage:null!=s?s:"Failed to get statuses"})}displayGenerationStatus(){const t=Object.values(this.reports).filter(t=>this.displayedIds.includes(t.id));for(const e of t)this.statusUI.printReportStatus(e);const e=t.filter(t=>u(t)&&[n.ReportStatus.Created,n.ReportStatus.Submitted,n.ReportStatus.Running].includes(a(t))).map(t=>t.id);this.addReportIdsToLoad(e),this.delayedUpdateGenerationStatus(1e4)}async updateGenerationStatus(t){var e,s,o;if(t.length>0)try{const i=await this.generationStatusQueue.submit(()=>this.statusApi.generationStatus(t));this.storeGenerationStatus(t,i),this.displayGenerationStatus();for(const t of i.reports)a(t)==n.ReportStatus.Succeeded&&(null===(s=null===(e=t.targetDocument)||void 0===e?void 0:e.reportFile)||void 0===s?void 0:s.id)&&this.updateUpToDateStatus(t.id)}catch(e){let{error:s,message:n,response:i}=c(e);switch(null===(o=null==i?void 0:i.status)||void 0===o?void 0:o.code){case 429:console.warn("Too many requests for generation status",t,s),this.addReportIdsToLoad(t),this.generationStatusQueue.pause(3e4),this.delayedUpdateGenerationStatus(3e4);case 401:case 403:default:console.error("Unexpected error for generation status",t,n,i,s),this.storeGenerationStatus(t,void 0,n),this.displayGenerationStatus()}}}async updateUpToDateStatus(t){var e,s,o,n,i,r,a;try{const u=await this.upToDateStatusQueue.submit(()=>this.statusApi.upToDateStatus(t));this.upToDateStatusQueue.pause(1e3),this.upToDateStatus[t]=u,this.statusUI.displayUpToDateStatus(t,u)}catch(u){let{error:d,message:l,response:p}=c(u);if(429===(null===(e=null==p?void 0:p.status)||void 0===e?void 0:e.code))console.warn("Too many requests for up to date status",t,d),this.upToDateStatusQueue.pause(3e4),this.updateUpToDateStatus(t);else{console.error("Unexpected error for up to date status",t,l,p,d);const e=null!==(a=null!==(r=null!==(n=null===(o=null===(s=null==p?void 0:p.status)||void 0===s?void 0:s.details[0])||void 0===o?void 0:o.message)&&void 0!==n?n:null===(i=null==p?void 0:p.status)||void 0===i?void 0:i.message)&&void 0!==r?r:l)&&void 0!==a?a:"Failed to get status";let u={id:t,errorMessage:e};this.upToDateStatus[t]=u,this.statusUI.displayUpToDateStatus(t,u)}}}}}),define("DS/CATRgrReportStatusBPS/ReportStatus",["require","exports","UWA/Element","DS/CATRgrReportPostEditingBPS/PostEditing","DS/CATRgnWidgetCommons/interfaces/Facade","DS/CATRgnWidgetCommons/restClient/CommonServices","DS/CATRgrReportStatusBPS/ReportStatusLogics","DS/CATRgrReportStatusBPS/ReportStatusLogics","i18n!DS/CATRgrReportStatusBPS/assets/nls/CATRgrReportStatusBPS","DS/CATRgnWidgetCommons/utils/RGNConstants"],function(t,e,s,o,n,i,r,a,u,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.waitForResult=void 0;const d={"margin-top":"5px","margin-bottom":"5px","margin-right":"5px","margin-left":"5px"};function l(t){return t.querySelector("img.report-status-icon")}function p(t){return t.querySelector("div.generation-status")}function g(t,e){l(t).src=e}function m(t,e,o){const n=function(t){return t.querySelector("a.report-status-link")}(t),i=function(t){return t.querySelector("span.report-status-text")}(t),r=l(t);o?(n.innerHTML="",r.inject(n),i.hidden=!0,n.hidden=!1,n.href=o,s.create("span",{html:e}).inject(n)):(i.innerHTML="",n.hidden=!0,i.hidden=!1,s.create("span",{html:e}).inject(i))}function S(t,e,s,o){const n=function(t){return t.querySelector("a.generation-status-link")}(t),i=function(t){return t.querySelector("span.generation-status-text")}(t);o?(e&&((function(t){return t.querySelector("img.generation-status-link-icon")}(t)).src=e),i.hidden=!0,n.hidden=!1,n.href=o,(function(t){return t.querySelector("span.generation-status-link-span")}(t)).innerHTML=s):(e&&((function(t){return t.querySelector("img.generation-status-text-icon")}(t)).src=e),n.hidden=!0,i.hidden=!1,(function(t){return t.querySelector("span.generation-status-text-span")}(t)).innerHTML=s)}function v(t,e){t.querySelector("em.tooltip-label").innerHTML=e}function h(t,e){var o;const n=r.isReportGenerationStatus(t)?t.generation:void 0,i=document.querySelector("div#tooltip_"+t.id+" > div.tooltip-content");i.innerHTML="";const a=e||(null==n?void 0:n.message);a&&"Completed"!==a&&(s.create("span",{html:u.get(a)}).inject(i),s.create("hr",{styles:{margin:"0px"}}).inject(i));const c=r.isReportGenerationStatus(t)?t.targetDocument:void 0;(null==c?void 0:c.id)&&s.create("h5",{styles:d,html:u.get("target_document_display").replace("{0}",c.title+" | "+c.type+" | "+c.revision+" | "+c.name)}).inject(i),(null===(o=null==c?void 0:c.reportFile)||void 0===o?void 0:o.id)&&s.create("h5",{styles:d,html:u.get("target_file_display").replace("{0}",c.reportFile.fileName+" | "+c.reportFile.fileVersion+" | generic")}).inject(i)}function f(t){m(t,u.get("report_never_generated"))}function y(t,e){e?m(t,e.title,"emxTree.jsp?objectId="+e.id):f(t)}function R(t,e){var s,o,n;const i=r.getReportStatusEnum(e)===c.ReportStatus.Failed,a=null===(s=e.targetDocument)||void 0===s?void 0:s.reportFile,u=i?"../common/images/iconStatusError.gif":"../common/images/iconActionDownload.gif",d='javascript:callCheckout("'+(null===(o=e.targetDocument)||void 0===o?void 0:o.id)+'", "download","'+(null==a?void 0:a.fileName.replace('"','\\"'))+'","generic",null,null,null,null,"null",'+(null==a?void 0:a.fileVersion)+',null,null,null,null,null,null,null,null,null,"'+(null==a?void 0:a.id)+'")';y(t,e.targetDocument),S(t,u,null!==(n=null==a?void 0:a.fileName)&&void 0!==n?n:"",d),h(e)}function T(t,e){var s,o,n;r.isReportGenerationStatus(e)?(y(t,e.targetDocument),S(t,"../common/images/iconStatusError.gif",null!==(o=null===(s=e.generation)||void 0===s?void 0:s.message)&&void 0!==o?o:""),h(e,null===(n=e.generation)||void 0===n?void 0:n.message)):(f(t),S(t,"../common/images/iconStatusError.gif",e.errorMessage),h(e,e.errorMessage))}function D(t,e,s){var n;y(t,e.targetDocument),function(t,e,s){p(t).style.display="none";const n=function(t){return t.querySelector("div.post-editing-open")}(t);n.parentElement.style.display="flex",n.onclick=(async()=>{const t=await i.service3DSpace(s);o.openPostEditingView(e.id,t,s.getSecurityContext())})}(t,e,s),h(e,"status_"+(null===(n=e.generation)||void 0===n?void 0:n.status))}function x(t,e){var s;const o=e.generation,n=function(t){switch(c.ReportStatus[t]){case c.ReportStatus.Created:case c.ReportStatus.Submitted:return"../common/images/iconStatusLoading.gif";case c.ReportStatus.Running:return"../common/images/iconResponsibilityManufacturing.gif";case c.ReportStatus.Succeeded:return"../common/images/iconStatusComplete.gif";case c.ReportStatus.Failed:case c.ReportStatus.Aborted:return"../common/images/iconStatusError.gif";case c.ReportStatus.NeedPostEdition:case c.ReportStatus.NeedPostEditionAndWithChanges:return"../common/images/iconStatusChanged.gif";default:return""}}(null!==(s=null==o?void 0:o.status)&&void 0!==s?s:"");y(t,e.targetDocument),S(t,n,u.get((null==o?void 0:o.message)||u.get("status_"+(null==o?void 0:o.status))),'javascript:showNonModalDialog("../common/emxTable.jsp?table=AEFBackgroundJobList&program=emxJob:getMyBackgroundJobs&toolbar=AEFJobRequestToolbar&header=emxFramework.Label.MyBackgroundProcess&HelpMarker=emxhelpbackgroundjobs&suiteKey=Framework&StringResourceFileId=emxFrameworkStringResource&SuiteDirectory=common&targetLocation=slidein")'),h(e)}function C(t,e){y(t,e.targetDocument),p(t).style.display="none",h(e)}class b{constructor(t){this.webClient=t}printReportErrorStatus(t){T(document.querySelector("div#ID_"+t.id+"> div"),t)}printReportStatus(t){var e,s,o,n,i;const a=t.targetDocument,d=document.querySelector("div#ID_"+t.id+"> div");switch(r.getReportStatusEnum(t)){case c.ReportStatus.None:C(d,t),g(d,"../common/images/iconStatusResequenced.gif"),v(d,u.get("report_is_not_up_to_date"));break;case c.ReportStatus.Succeeded:(null===(e=null==a?void 0:a.reportFile)||void 0===e?void 0:e.id)?R(d,t):(S(d,"../common/images/iconStatusResequenced.gif",u.get("report_never_generated")),(l=d,l.querySelector("div.report-status")).style.display="none");break;case c.ReportStatus.Failed:case c.ReportStatus.Aborted:T(d,t),(null===(s=null==a?void 0:a.reportFile)||void 0===s?void 0:s.id)?R(d,t):(null===(o=t.generation)||void 0===o?void 0:o.message)||C(d,t),g(d,"../common/images/iconStatusError.gif"),v(d,null!==(i=null===(n=t.generation)||void 0===n?void 0:n.message)&&void 0!==i?i:"An error occurred");break;case c.ReportStatus.NeedPostEdition:case c.ReportStatus.NeedPostEditionAndWithChanges:t.targetDocument?D(d,t,this.webClient):C(d,t),g(d,"../common/images/iconStatusResequenced.gif"),v(d,u.get("report_is_not_up_to_date"));break;case c.ReportStatus.Created:case c.ReportStatus.Submitted:case c.ReportStatus.Running:x(d,t);break;default:T(d,t)}var l}displayUpToDateStatus(t,e){!function(t,e){var s;r.isGetStatusReportResponse(e)?(g(t,e.uptodate?"../common/images/iconStatusComplete.gif":"../common/images/iconStatusResequenced.gif"),v(t,e.uptodate?u.get("report_is_up_to_date"):u.get("report_is_not_up_to_date"))):(g(t,"../common/images/iconStatusError.gif"),v(t,null!==(s=null==e?void 0:e.errorMessage)&&void 0!==s?s:"An error occurred"))}(document.querySelector("div#ID_"+t+"> div"),e)}}function _(t){let e=function(){const t=document.getElementById("mx_divTableBody"),e=document.querySelector("table#bodyTable tbody"),s=[];if(t&&e){const o=t.clientHeight,n=t.scrollTop,i=n+o;e.childNodes.forEach(t=>{if("TR"===t.nodeName){const e=t,o=e.getAttribute("o");if(o){const t=e.offsetTop;t+e.offsetHeight>n&&t<i&&s.push(o)}}})}else document.getElementById("leftSlideIn")||console.error("Failed to detect report table");return s}();e.forEach(t=>{const e=document.querySelector("div#ID_"+t+"> div");if(!e.querySelector("div.report-status")){const t=s.create("div",{class:"report-status",styles:{display:"flex"}}),o=s.create("img",{class:"report-status-icon",styles:{"padding-right":"5px"},src:"../common/images/loading.gif"}),n=s.create("a",{class:"report-status-link",html:""}),i=s.create("span",{class:"report-status-text",html:""}),r=s.create("div",{class:"generation-status",styles:{display:"flex","padding-top":"5px"}}),a=s.create("img",{class:"generation-status-link-icon",styles:{"padding-right":"5px"},src:"../common/images/loading.gif"}),c=s.create("img",{class:"generation-status-text-icon",styles:{"padding-right":"5px"}}),d=s.create("span",{class:"generation-status-link-span",html:""}),l=s.create("span",{class:"generation-status-text-span",html:""}),p=s.create("a",{class:"generation-status-link",html:""}),g=s.create("span",{class:"generation-status-text",html:""}),m=s.create("div",{class:"post-editing",styles:{display:"none","padding-top":"5px",cursor:"pointer"},html:""}),S=s.create("div",{class:"post-editing-open",html:""}),v=s.create("a"),h=s.create("img",{styles:{"padding-right":"5px",cursor:"pointer"},src:"../common/images/iconStatusChanged.gif"}),f=s.create("span",{html:u.get("open_post_editing")});o.inject(t),n.inject(t),i.inject(t),t.inject(e),p.inject(r),a.inject(p),d.inject(p),g.inject(r),c.inject(g),l.inject(g),r.inject(e),h.inject(v),f.inject(v),v.inject(S),S.inject(m),m.inject(e)}!function(t){const e=t.querySelector("div.reportStatusLoading");e&&!e.hidden&&(e.hidden=!0)}(e)}),function(t){t.forEach(t=>{if(!document.getElementById("tooltip_"+t)){const e=document.querySelector("div#ID_"+t+"> div"),o=s.create("div",{class:"tooltip-container",onmouseover:'this.getElementsByClassName("popover")[0].classList.remove("hidden")',onmouseleave:'this.getElementsByClassName("popover")[0].classList.add("hidden")'}),n=s.create("div",{id:"tooltip_"+t,class:"popover left in hidden",styles:{float:"","overflow-wrap":"anywhere","margin-left":"10px"}});s.create("em",{class:"tooltip-label",styles:d}).inject(n),s.create("hr",{styles:{margin:"0px"}}).inject(n),s.create("div",{class:"tooltip-content"}).inject(n),n.inject(o),o.inject(e)}})}(e),t.setDisplayedIds(e),t.refresh()}e.waitForResult=async function(t,e){var s;const o=document;if(o.rgnStatusProgressing){const t=o.rgnStatusProgressing;o.rgnRefreshTimeout&&clearTimeout(o.rgnRefreshTimeout),o.rgnRefreshTimeout=setTimeout(()=>_(t),300)}else{const r=new n.WebClientFactory(t,e),u=new a.StatusProcessing(new a.StatusApiImpl(await i.service3DSpace(r),t),new b(r));o.rgnStatusProgressing=u,_(u),null===(s=document.querySelector("div#mx_divTableBody"))||void 0===s||s.addEventListener("scroll",()=>_(u)),window.addEventListener("resize",()=>_(u))}}});