define("DS/ENOCharacteristicsWebApp/utils/DnDUtil",["UWA/Core","UWA/Class","DS/ENOCharacteristicsWebApp/models/CharacteristicsModel","DS/ENOCharacteristicsWebApp/models/CharacteristicsCategoryModel","DS/ENOCharacteristicsWebApp/utils/AlertManager","DS/ENOCharacteristicsWebApp/utils/UIUtil","DS/ENOCharacteristicsWebApp/utils/Constants","i18n!DS/ENOCharacteristicsWebApp/assets/nls/ENOCharacteristicsWebAppNLS"],function(e,r,t,o,i,a,d,n){"use strict";return r.singleton({init:function(){return this},authorizeDrop:function(e,r,t){for(var o,a=!0,l=!1,s=t.nodeModel.options.grid,C=s.modelType,A=0;A<r.length;A++){if((o=r[A].grid).modelType!==C){o.modelType===d.CHARACTERISTICS_MODEL_TYPE&&C===d.CHARACTERISTICS_CATEGORY_MODEL_TYPE?i.displayAlert(e.mAlert,n.DropNotAuthorized+" : "+n.CannotDrop+" "+n.Characteristics+" "+n.Over+" "+n.CharacteristicsCategory+".",1):o.modelType===d.CHARACTERISTICS_CATEGORY_MODEL_TYPE&&C===d.CHARACTERISTICS_MODEL_TYPE?i.displayAlert(e.mAlert,n.DropNotAuthorized+" : "+n.CannotDrop+" "+n.CharacteristicsCategory+" "+n.Over+" "+n.Characteristics+".",1):i.displayAlert(e.mAlert,n.DropNotAuthorized,1),a=!1;break}if(o.itemId!==s.itemId){i.displayAlert(e.mAlert,n.ReorderBetweenDifferentParentItemsNotAllowed,1),a=!1;break}if(d.CHARACTERISTICS_MODEL_TYPE===C){if(o.id===s.id){a=!1;break}if(o.categoryName!==s.categoryName&&(l=!0),l){if(o.overwriteAllowedOnChildFromMaster,"ParameterUsage"===o.relationship){i.displayAlert(e.mAlert,n.DnDNotAllowedAcrossCategoriesOAOCIsFalse+" [ "+o.Title+" ].",1),a=!1;break}if("Yes"===o.isDerivedCharacteristic){i.displayAlert(e.mAlert,n.DnDNotAllowedAcrossCategoryForDerivedChar+" [ "+o.Title+" ] "+n.OrMore,1),a=!1;break}}}else if(d.CHARACTERISTICS_CATEGORY_MODEL_TYPE===C){if(o.title===s.title){a=!1;break}}else if(d.COMPOSITE_ITEM_MODEL_TYPE===C){i.displayAlert(e.mAlert,n.DropNotAuthorizedOnItems,1),a=!1;break}}return{authorizeDrop:a,reOrderAcrossCategory:l}},validateDrop:function(e,r){return e.itemId===r.itemId&&e.categoryName===r.categoryName||(i.displayAlert(n.DropNotAuthorized,1),!1)},createCharModelForDnD:function(e,r){var o=new t({Category:e});return o.copyDataFromNodeModel(r),o},createCharCategoryModelForDnD:function(e,r){var t=this,i={iCharCategory:r.grid.title,iOwnerItem:e},a=new o(i);return a.copyDataFromNodeModel(r),r.children.forEach(function(e){var r=t.createCharModelForDnD(a,e);a.mTreeNodeModel.addChild(r.mTreeNodeModel)}),a},authorizeDrag:function(e,r){var t=r.isInstantiatedIn3DD?null:r.elements.container.getElement("input#searchText");return a.isNotNullAndNotUndefined(t)&&""!==t.value?(i.displayAlert(r.mAlert,n.ClearFilterBeforeDnD,1),!1):e.nodeModel.options.grid.modelType===d.CHARACTERISTICS_MODEL_TYPE||e.nodeModel.options.grid.modelType===d.CHARACTERISTICS_CATEGORY_MODEL_TYPE?!!r.mAccess.Modify||(i.displayAlert(r.mAlert,n.NoModifyAccessToDoDnD,1),!1):e.nodeModel.options.grid.modelType===d.COMPOSITE_ITEM_MODEL_TYPE&&(i.displayAlert(r.mAlert,n.DragNotAuthorizedOnItems,1),!1)},processDropEffect:function(e){var r,t=this,o=e.dndInfos.nodeModel,i=e.droppedNodes,a=e.dndInfos,n=e.dndInfos.nodeModel.getParent().options.grid;i.forEach(function(i,l){if(i.grid.modelType===d.CHARACTERISTICS_MODEL_TYPE?r=t.createCharModelForDnD(n.ownerModel,i).mTreeNodeModel:i.grid.modelType===d.CHARACTERISTICS_CATEGORY_MODEL_TYPE&&(r=t.createCharCategoryModelForDnD(n.ownerModel,i).mTreeNodeModel),a.cellView){if(a.manager.getDocument().options.shouldAcceptDrop({parentTreeNodeModel:o,draggedTreeNodeModel:r,dropPosition:a.dropPosition})){if(a.manager.getDocument().prepareUpdate(),a.manager.getDocument().getXSO().get().forEach(function(r){if(r.options.grid.modelType===e.draggedObjModelType)switch(r.options.grid.modelType){case d.CHARACTERISTICS_MODEL_TYPE:r.options.grid.ownerModel.removeCharacteristic();break;case d.CHARACTERISTICS_CATEGORY_MODEL_TYPE:r.options.grid.ownerModel.removeCategory()}}),a.manager.getDocument().pushUpdate(),-1!==a.virtualRowID){switch(a.dropPosition){case"top":o.getParent().insertBefore(r,o);break;default:case"middle":case"bottom":o.getParent().addChild(r,o.getParent().getChildren().indexOf(o)+1)}return a.dropPosition&&d.CHARACTERISTICS_CATEGORY_MODEL_TYPE===o.options.grid.modelType&&n.ownerModel.mCharCategoryList.push(r.options.grid.ownerModel),!1}return!0}return!1}}),null!=o&&(e.draggedObjModelType===d.CHARACTERISTICS_MODEL_TYPE?(e.rootNode=o.getParent().getParent(),e.targetCategoryNode=o.getParent()):e.draggedObjModelType===d.CHARACTERISTICS_CATEGORY_MODEL_TYPE&&(e.rootNode=o.getParent(),e.targetCategoryNode=null),e.charControl.updateSequenceOrder(e))}})});