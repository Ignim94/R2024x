define("DS/SPY3DPlay/Upload3DDAndShareExt",["DS/WebSystem/Environment","DS/3DPlay/3DPlay","UWA/Class","DS/Notifications/NotificationsManagerUXMessages","i18n!DS/3DPlay/assets/nls/3DPlay","i18n!DS/SPY3DPlay/assets/nls/Publish","i18n!DS/SPY3DPlay/assets/nls/PublishFeedbacks"],function(e,t,i,n,s,o,r){"use strict";const a=e.get("PSR.Allow_3dsim2drive");return i.extend({_isFolderAccessible:function(){return new Promise((e,t)=>{if(this._driveUtils)return this._driveUtils.getFolderDataInTenantFromID(driveFolderID,tenantInfo).then(function(i){"edit"!==i.accessright&&"edit_share"!==i.accessright?t():e()});t()})},_upload:function(e){if(this._driveUtils){let t="";""!==t?this._driveUtils.updateFileIn3DDriveAtGivenTenant(e.fileName,e.file,t,e.tenantInfo).then(function(t){e.onComplete(t.id)}):this._driveUtils.saveFileTo3DDriveAtGivenTenant(e.fileName,e.file,e.driveFolderID,e.tenantInfo).then(function(t){e.onComplete(t.id)})}else e.onFailure&&e.onError()},_getModal:function(){return!this._modal&&this._modalConstruct&&(this._modal=new this._modalConstruct({closable:!0,className:"shareExternalLinkPanel_3DPlay"}),this._modal.inject(document.body),this._modal.show()),this._modal},_close:function(){this._publishTypeForm&&(this._publishTypeForm.destroy(),this._publishTypeForm=void 0),this._shareForm&&(this._shareForm.destroy(),this._shareForm=void 0),this._modal&&(this._modal.destroy(),this._modal=void 0)},_closeWithSuccess:function(e){var t={level:"success",title:r.publishSucceeded,subtitle:""};e&&e.containerType&&(t.message=r[e.containerType+"MediaProcessing"]),n.addNotif(t),this._close()},_closeWithError:function(e){var t={level:"error",title:r.publishFailed,subtitle:r.unknownError};if(e&&(console.warn(" 3DPlay could not publish - error:",e),e.response&&e.response.errorcode))switch(e.response.errorcode){case"ERROR_FILE_SIZE_EXCEEDED":t.subtitle=r.sizeExceededSubtitle,t.message=r.sizeExceededMsg}n.addNotif(t),this._close()},init:function(e,i){if(this._ctx=e.ctx,this._experience=t.getExperience(e.ctx),this._experience){var n=this._experience.args.input.tenantID||this._experience.args.input.asset.tenant;n&&(this._platformId=n),require(["DS/UIKIT/Modal","DS/W3DDriveShare/views/ShareWithExternalView","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CAT3DWInfra/CAT3DW3DDriveUtils"],function(e,t,i,n,s){this._wafData=i,this._modalConstruct=e,this._shareWithExternalViewConstruct=t,this._plaformServices=n,this._driveUtils=s,this._experience.getScreenShot&&this._experience.getExperienceMedia&&this._experience.getExperienceMediaMeta&&this.uploadAndShare()}.bind(this),function(e){if("scripterror"===e.requireType){var i=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",i)}else console.error(e);t.sendEvent(this._ctx,eventType.notif,notification.error,{msg:s.ScripNotFoundError})}.bind(this))}},prepareUpload:function(e){this._stage="Prepare",this._experience.getExperienceMediaMeta(function(t){require(["DS/SPY3DPlay/PrepareAndUploadTo3DDriveView","DS/WebappsUtils/WebappsUtils","i18n!DS/SPY3DPlay/assets/nls/PrepareAndUploadTo3DDriveView"],function(t,i,n){this._prepareAndUploadForm=new t({onNext:e.onNext,onReady:function(){let e=this._getModal();e&&(e.setHeader("<h4>"+n.generatingSimulationMedia+"</h4>"),e.setBody(this._prepareAndUploadForm.render("publish_to_sywm_wrapper_id")))}.bind(this)}),this._experience.getExperienceMedia({spaceURL:!1,onComplete:function(e){this._prepareAndUploadForm.hideSpinner(),this._prepareAndUploadForm.displayMediaSize(e.size),this._prepareAndUploadForm.enableNextButton(),this._mediaToUpload=e}.bind(this),onFailed:function(e){this._close(e)}.bind(this),onProgress:function(e){}.bind(this)})}.bind(this))}.bind(this))},upload:function(e){if(this._prepareAndUploadForm){this._stage="Upload";let t=this._getModal();t&&t.setHeader("<h4>Upload in progress [NO NLS!]</h4>"),this._prepareAndUploadForm.disableNextButton(),this._prepareAndUploadForm.hideMediaSize(),this._prepareAndUploadForm.displaySpinner(),this._upload({tenantInfo:e.tenantInfo,fileName:e.fileName,file:e.file,driveFolderID:e.driveFolderID,onComplete:()=>{this._prepareAndUploadForm.enableNextButton(),this._prepareAndUploadForm.hideSpinner(),e.onComplete()},onError:()=>{console.error(" SPY - upload to 3DDrive failed "),e.onError&&e.onError()}})}},shareExternal:function(e){this._stage="Share";let t=function(){let t=this._getModal();if(t){t.setHeader("<h4>Share as external link [NO NLS!]</h4>"),this._shareForm=new this._shareWithExternalViewConstruct({platformId:this.platformId,inodeId:e.driveNodeId,contextAppId:e.contextAppId,automaticLinkActivation:!0});let i="",s=setInterval(function(){if(this._shareForm){document.getElementById("share-with-external__dedicated-container")&&(clearInterval(s),shareWithExternalView.linkData&&"string"==typeof this._shareForm.linkData.url&&(i=this._shareForm.linkData.url))}},100);this._shareForm.addEvent("onCancel",()=>{options.onCancel()}),this._shareForm.addEvent("onLinkCopied",()=>{n.addNotif({level:"success",title:"link copied [NO NLS]",subtitle:""})}),this._shareForm.addEvent("onShared",()=>{n.addNotif({level:"success",title:"shared [NO NLS]",subtitle:""}),t.hide(),this._closeWithSuccess()}),
//!!render arg to change!!
t.setBody(this._shareForm.render("publish_to_sywm_wrapper_id"))}}.bind(this);this._experience.getPublishingInfo&&this._experience.getPublishingInfo({onComplete:function(e){t()}})},uploadAndShare:function(){this._plaformServices&&this._plaformServices.getPlatformServices({onComplete:e=>{let t=e.find(e=>e.platformId===this._platformId),i={platformId:this._platformId,url:t["3DDrive"]};this.prepareUpload({onNext:()=>{this.upload({tenantInfo:i,fileName:"simulationShared.3dsim",file:this._mediaToUpload,driveFolderID:a,onComplete:e=>{this.shareExternal({platformId:this._platformId,driveNodeId:e,contextAppId:"SIMWPSR_AP"})}})}})},onFailure:()=>{}})}})}),define("DS/SPY3DPlay/Publish",["DS/3DPlay/3DPlay","UWA/Class","DS/WebSystem/Environment","DS/Notifications/NotificationsManagerUXMessages","i18n!DS/3DPlay/assets/nls/3DPlay","i18n!DS/SPY3DPlay/assets/nls/Publish","i18n!DS/SPY3DPlay/assets/nls/PublishFeedbacks"],function(e,t,i,n,s,o,r){"use strict";return t.extend({_getServerToken:function(e){var t=this._urlSwym+"/api/index/tk",i={method:"GET",type:"json",onComplete:function(t){t&&t.result&&t.result.ServerToken?e.onComplete(t.result.ServerToken):e.onFailed&&e.onFailed()},onFailure:e.onFailed};this._wafData.authenticatedRequest(t,i)},_upload:function(e){var t=this._urlSwym+"/api/media/add",i=new FormData;i.append("userFile",e.file,e.filename),i.append("published",1),i.append("title",e.name),i.append("community_id",this._communityId),i.append("is_illustration",this._publishForm._media_is_illustration);var n={method:"POST",type:"json",headers:{"X-DS-SWYM-CSRFTOKEN":e.serverToken},data:i,onComplete:function(t){t.errorcode&&e.onFailed&&e.onFailed(t),this._mediaId=t.result.id,this._publishForm.addEvent("ContentCreated",function(t){var i=JSON.parse(t);i&&i.success?e.onComplete(i):e.onFailed(i)},!1);var i=this._publishForm.getControl("descriptionInput").getValue();this._publishForm.setContentDescription(i),this._publishForm.createContent(this._mediaId)}.bind(this),onFailure:function(t,i,n){if(e.onFailed){var s={error:t,response:i,headers:n};e.onFailed(s)}}};this._wafData.authenticatedRequest(t,n)},_getModal:function(){return!this._modal&&this._modalConstruct&&(this._modal=new this._modalConstruct({closable:!0,className:"publishSwymPanel_3DPlay"}),this._modal.inject(document.body),this._modal.show()),this._modal},_close:function(){this._publishTypeForm&&(this._publishTypeForm.destroy(),this._publishTypeForm=void 0),this._publishForm&&(this._publishForm.destroy(),this._publishForm=void 0),this._modal&&(this._modal.destroy(),this._modal=void 0)},_closeWithSuccess:function(e){var t={level:"success",title:r.publishSucceeded,subtitle:""};e&&e.containerType&&(t.message=r[e.containerType+"MediaProcessing"]),n.addNotif(t),this._close()},_closeWithError:function(e){var t={level:"error",title:r.publishFailed,subtitle:r.unknownError};if(e&&(console.warn(" 3DPlay could not publish - error:",e),e.response&&e.response.errorcode))switch(e.response.errorcode){case"ERROR_FILE_SIZE_EXCEEDED":t.subtitle=r.sizeExceededSubtitle,t.message=r.sizeExceededMsg}n.addNotif(t),this._close()},init:function(t,i){if(this._ctx=t.ctx,this._experience=e.getExperience(t.ctx),this._experience){var n=this._experience.args.input.tenantID||this._experience.args.input.asset.tenant;n&&(this._idSwym=n);require(["DS/UIKIT/Modal","DS/SwymPublishForm/script/publish-form-view","DS/WAFData/WAFData","css!DS/3DPlayUtils/PublishToSwym"],function(e,t,i){this._wafData=i,this._modalConstruct=e,this._publishFormViewConstruct=t,this._experience.getScreenShot&&(this._experience.getExperienceMedia&&this._experience.getExperienceMediaMeta?this.preparePublishTypeSelection({onCancel:function(){this._close()}.bind(this),onNext:function(e){if(e)switch(e){case"screenshot":this._close(),this.publishScreenshot();break;case"simulationMedia":this._close(),this.publishMedia();break;default:this._close()}}.bind(this)}):this.publishScreenshot())}.bind(this),function(t){if("scripterror"===t.requireType){var i=t.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",i)}else console.error(t);e.sendEvent(this._ctx,eventType.notif,notification.error,{msg:s.ScripNotFoundError})}.bind(this))}},publishScreenshot:function(){this._experience&&this._experience.getScreenShot({onSuccess:function(e){if(i.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:i.get("ODT_3DPlay_PanelManager")})});else{var t=function(t){var i={title:t.title,description:t.description,mode:"base64",base64image:e,onCancel:this._close.bind(this),onContentCreated:this._close.bind(this)};this._idSwym&&(i.platformId=this._idSwym),this._publishForm=new this._publishFormViewConstruct(i),this._publishForm.setContentTitle(t.title),this._publishForm.setContentDescription(t.description);var n=this._getModal();n&&(n.setHeader("<h4>"+s.ShareSwymTitle+"</h4>"),n.setBody(this._publishForm.render("publish_to_sywm_wrapper_id")))}.bind(this);this._experience.getPublishingInfo?this._experience.getPublishingInfo({onComplete:function(e){t(e)}}):t({title:"title",description:"description"})}}.bind(this),onFail:function(){NLS.nls("3DPlay/3DPlay","UnableToCreateScreenshot",function(t){e.sendEvent(this._ctx,eventType.notif,notification.error,{msg:t})})}})},prepareMediaPublish:function(e){var t=function(t){this._publishForm=new this._publishFormViewConstruct({mode:"jsevent"}),this._publishForm.setContentTitle(t.title),this._publishForm.setContentDescription(t.description);var i=this._getModal();i&&(i.setHeader("<h4>Publish "+e.mediaData.typeName+"</h4>"),i.setBody(this._publishForm.render("publish_to_sywm_wrapper_id"))),this._publishForm.addEvent("CancelShare",function(){e.onCancel()},!1),this._publishForm.addEvent("StartUpload",function(t){var i=JSON.parse(t);this._communityId=i.community_id,this._urlSwym=i.platform_instance,e.onPublish()}.bind(this),!1),this._publishForm.render()}.bind(this);this._experience.getPublishingInfo?this._experience.getPublishingInfo({onComplete:function(e){t(e)}}):t({title:"title",description:"description"})},publishMedia:function(){this._experience.getExperienceMediaMeta(function(e){this.prepareMediaPublish({mediaData:e,titlePrefix:o.publishMediaTitlePrefix,onPublish:function(){this._experience.getExperienceMedia({onComplete:function(t){this._getServerToken({onComplete:function(i){this._upload({serverToken:i,file:t,filename:e.name+"."+e.format,name:e.name,onComplete:function(e){this._closeWithSuccess(e)}.bind(this),onFailed:function(e){this._closeWithError(e)}.bind(this)})}.bind(this),onFailed:function(e){this._closeWithError(e)}.bind(this)})}.bind(this),onFailed:function(e){this._close(e)}.bind(this),onProgress:function(){}})}.bind(this),onCancel:function(){this._close()}.bind(this)})}.bind(this))},preparePublishTypeSelection:function(e){e&&e.onNext&&e.onCancel&&require(["DS/SPY3DPlay/PublishTypeFormView","DS/WebappsUtils/WebappsUtils","i18n!DS/SPY3DPlay/assets/nls/PublishTypeFormView"],function(t,i,n){this._publishTypeForm=new t({types:{media3d:{id:"simulationMedia",nls:n.simulationMedia,icon:i.getWebappsBaseUrl()+"SPY3DPlay/assets/icons/I_PublishSimulationMedia.svg"},screenshot:{id:"screenshot",nls:n.screenshot,icon:i.getWebappsBaseUrl()+"SPY3DPlay/assets/icons/I_PublishScreenshot.svg"}},onNext:e.onNext,onCancel:e.onCancel,onReady:function(){var e=this._getModal();e&&(e.setHeader("<h4>"+n.publishModalTitle+"</h4>"),e.setBody(this._publishTypeForm.render("publish_to_sywm_wrapper_id")))}.bind(this)})}.bind(this))}})}),define("DS/SPY3DPlay/PublishTypeFormView",["UWA/Class"],function(e){"use strict";return e.extend({destroy:function(){this._internalForm&&this._internalForm.destroy()},render:function(e){return this._internalForm?this._internalForm.render(e):null},init:function(e){require(["DS/SwymUICore/script/lib/view/generic/swym-view","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","i18n!DS/SPY3DPlay/assets/nls/PublishTypeFormView","css!SwymPublishForm/SwymPublishForm","css!DS/SPY3DPlay/PublishTypeFormView"],function(t,i,n,s){var o=t.extend({name:"publish-type-form-view",_createSelector:function(e){e&&(e.media3d&&(this._media3dButton=this.addControl("media3d",new n({className:"btn-image",value:""})),this._media3dButton.elements.content.style.backgroundImage="url("+e.media3d.icon+")",this._media3dButton.addEvent("onClick",this._onMedia3dButtonClick.bind(this)),this._media3dToggle=this.addControl("media3dToggle",new i({name:"publishType",value:e.media3d.id,className:"primary checked",label:e.media3d.nls,checked:!0})),this._media3dToggle.addEvent("onChange",this._onMedia3dToggleChange.bind(this)),this._selectedTypeId=e.media3d.id),e.screenshot&&(this._screenshotButton=this.addControl("screenshot",new n({className:"btn-image",value:""})),this._screenshotButton.elements.content.style.backgroundImage="url("+e.screenshot.icon+")",this._screenshotButton.addEvent("onClick",this._onScreenshotButtonClick.bind(this)),this._screenshotToggle=this.addControl("screenshotToggle",new i({name:"publishType",value:e.screenshot.id,className:"primary",label:e.screenshot.nls})),this._screenshotToggle.addEvent("onChange",this._onScreenshotToggleChange.bind(this))))},_onScreenshotButtonClick:function(){this._screenshotToggle.setCheck(!0),this._screenshotToggle.dispatchOnChange()},_onMedia3dButtonClick:function(){this._media3dToggle.setCheck(!0),this._media3dToggle.dispatchOnChange()},_onScreenshotToggleChange:function(){this._screenshotToggle.isChecked()&&(this._screenshotToggle.elements.container.classList.add("checked"),this._media3dToggle.elements.container.classList.remove("checked"),this._selectedTypeId=this._config.types.screenshot.id)},_onMedia3dToggleChange:function(){this._media3dToggle.isChecked()&&(this._media3dToggle.elements.container.classList.add("checked"),this._screenshotToggle.elements.container.classList.remove("checked"),this._selectedTypeId=this._config.types.media3d.id)},_createContent:function(){var e=this;return{class:"publish-form",html:[{class:"publish-form-body",html:[{class:"thread-selector-cnt",html:[{class:"image-toggle-cnt",html:[e.getControl("media3d"),e.getControl("media3dToggle")]},{class:"image-toggle-cnt",html:[e.getControl("screenshot"),e.getControl("screenshotToggle")]}]}]},{class:"footer-cnt",html:[{class:"button-cnt",html:[e.addControl("cancelButton",new n({className:"cancel-share-button default",value:s.cancel,events:{onClick:function(){e._config.onCancel?e._config.onCancel():e.hide()}}}))]},{class:"button-cnt",html:[e.addControl("nextButton",new n({className:"next-share-button primary",value:s.next,events:{onClick:function(){e._config.onNext&&e._config.onNext(e._selectedTypeId)}}}))]}]}]}},setup:function(e){return this._config=e,this._parent.apply(this,arguments),this._createSelector(e.types),this}});this._internalForm=new o(e),e&&e.onReady&&e.onReady()}.bind(this))}})}),define("DS/SPY3DPlay/PrepareAndUploadTo3DDriveView",["UWA/Class","UWA/Core","i18n!DS/SPY3DPlay/assets/nls/PrepareAndUploadTo3DDriveView"],function(e,t,i){"use strict";return e.extend({destroy:function(){this._internalForm&&this._internalForm.destroy()},render:function(e){return this._internalForm?this._internalForm.render(e):null},init:function(e){require(["DS/SwymUICore/script/lib/view/generic/swym-view","DS/UIKIT/Input/Button","DS/UIKIT/Spinner","css!SwymPublishForm/SwymPublishForm","css!DS/SPY3DPlay/PrepareAndUploadTo3DDriveView"],function(n,s,o){let r=n.extend({name:"publish-type-form-view",_createProgress:function(){this._progress=this.addControl("progressSpinner",new o({className:"progress-spinner",value:"",visible:!0,spin:!0}))},_createMediaSize:function(){this._mediaSizeLabel=this.addControl("mediaSizeLabel",t.createElement("div",{className:"mediasize-label"})),this._mediaSizeLabel.hide()},_createContent:function(){let e=this,t={class:"publish-form",html:[{class:"publish-form-body",html:[{class:"progress-cnt",html:[e.getControl("progressSpinner")]},{class:"mediasize-cnt",html:[e.getControl("mediaSizeLabel")]}]},{class:"footer-cnt",html:[{class:"button-cnt",html:[e.addControl("cancelButton",new s({className:"cancel-share-button default",value:i.cancel,events:{onClick:function(){e._config.onCancel?e._config.onCancel():e.hide()}}}))]},{class:"button-cnt",html:[e.addControl("nextButton",new s({className:"next-share-button primary",value:i.next,events:{onClick:function(){e._config.onNext&&e._config.onNext()}}}))]}]}]};return this.getControl("nextButton").disable(),t},setup:function(e){return this._config=e,this._parent.apply(this,arguments),this._createProgress(),this._createMediaSize(),this}});this._internalForm=new r(e),e&&e.onReady&&e.onReady()}.bind(this))},displayMediaSize:function(e){let t=this._internalForm.getControl("mediaSizeLabel");if(t){let n=e/1048576,s=i.mediaSizeLabel+"<b>"+n.toFixed(2)+" MB</b>",o=i.accessCreditLabel+"<b>"+Math.ceil(n).toString()+"</b>",r=i.continuePrompt;t.setHTML("<p>"+s+"</p><p>"+o+"</p><p>"+r+"</p>"),t.show()}},hideMediaSize:function(){this._internalForm.getControl("mediaSizeLabel").hide()},displaySpinner:function(e){this._internalForm.getControl("progressSpinner").spin=!0,this._internalForm.getControl("progressSpinner").show()},hideSpinner:function(e){this._internalForm.getControl("progressSpinner").spin=!1,this._internalForm.getControl("progressSpinner").hide()},enableNextButton:function(){this._internalForm.getControl("nextButton").enable()},disableNextButton:function(){this._internalForm.getControl("nextButton").disable()}})}),define("DS/SPY3DPlay/CmdPublish",["DS/WebSystem/Environment","DS/3DPlayCommands/CmdShareBase","DS/SPY3DPlay/Publish"],function(e,t,i){"use strict";return t.extend({shareWithPanelManager:function(){new i({ctx:this._ctx})}})}),define("DS/SPY3DPlay/CmdShareExternal",["DS/WebSystem/Environment","DS/3DPlayCommands/CmdShareBase","DS/SPY3DPlay/Upload3DDAndShareExt"],function(e,t,i){"use strict";return t.extend({shareWithPanelManager:function(){if(e.isSet("PSR.Allow_3dsim2drive"))new i({ctx:this._ctx})}})});