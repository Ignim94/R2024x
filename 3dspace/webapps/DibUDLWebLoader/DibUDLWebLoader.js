define("DS/DibUDLWebLoader/TraceUDLWebLoader",[],function(){"use strict";return{consolePrint:function(e){console.log(e)}}}),define("DS/DibUDLWebLoader/CGR_UDLWebLoader",["DS/ZipJS/zip-fs","DS/Visualization/Node3D","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS"],function(e,t,n,i){"use strict";return{loadCGRs:function(t){return function(t){var o=t.CGRNode,a=t.cgrName;a||t.onFailure();var r=t.zipUDL.find(a);r||t.onFailure();var s=new e.BlobWriter,u=new i.Matrix4;u.setPosition(new i.Vector3(0,0,0));u.setRotation([1,0,0,0,1,0,0,0,1]),o.setMatrix(u);var c=new n;c.setFileType("cgr"),c.set2DAccuracy(t.Accuracy2D),c.set3DAccuracy(t.Accuracy3D),1==t.DrawOrderMode&&c.setSceneGraphOrderMode(1),c.setOnLoadedCallback(function(){t.onSuccess(o)}),r.getData(s,function(e){var t=new FileReader;t.onload=function(){c.loadModelFromBuffer(this.result,o)},t.readAsArrayBuffer(e)});var l=t.cgrNameText;if(void 0!==l&&""!==l){var f=t.zipUDL.find(l),d=new e.BlobWriter;f.getData(d,function(e){var t=new FileReader;t.onload=function(){c.loadModelFromBuffer(this.result,o)},t.readAsArrayBuffer(e)})}}(t)}}}),define("DS/DibUDLWebLoader/DifSupplementalGeometryUDLWebLoader",["DS/Visualization/Node3D"],function(e){"use strict";var t=function(t){var n="get_SupGeoRef_ObjectInternal",i=t.iRef;i||t.onFailure(n+" no iRef");var o=t.ioMap_ID_Node;o||t.onFailure(n+" no ioMap_ID_Node");var a=t.ioMap_ID_Obj;a||t.onFailure(n+" no ioMap_ID_Obj");var r=a.get(i.iD);r&&t.onSuccess(r);var s=o.get(i.Dif3DShapeInst.Dif3DShapeRepRef.iD);s||t.onFailure(n+" no ShapeNode");var u=o.get(i.Dif3DShapeInst.iD);u||(u=new e,o.set(i.Dif3DShapeInst.iD,u),u.addChild(s));var c=o.get(i.iD);c||(c=new e,o.set(i.iD,c),c.addChild(u));(r={}).iD=i.iD,r.Name=i.Name,r.Type="SupplementalGeometry";var l={};l.node3D=c,r.visuinfo=l,a.set(r.iD,r),t.onSuccess(r)},n=function(n){var i="get_SupGeoInstance_ObjectInternal",o=n.iInstance;o||n.onFailure(i+" no iInstance");var a=n.ioMap_ID_Node;a||n.onFailure(i+" no ioMap_ID_Node");var r=n.ioMap_ID_Obj;r||n.onFailure(i+" no ioMap_ID_Obj");var s=r.get(o.iD);s&&n.onSuccess(s);var u=a.get(o.iD);u||(u=new e,a.set(o.iD,u));(s={}).iD=o.iD,s.Name=o.Name,s.Type="SupplementalGeometryInstance",s.Childs=[];var c={};c.node3D=u,s.visuinfo=c;var l={iRef:o.SupGeoRef,ioMap_ID_Node:a,ioMap_ID_Obj:r,onSuccess:function(e){s.Name||(s.Name=e.Name),s.Childs.push(e),s.visuinfo.node3D?s.visuinfo.node3D.addChild(e.visuinfo.node3D):n.onFailure(i+" no node3D")},onFailure:function(e){console.log(e),n.onFailure(i)}};t(l),r.set(s.iD,s),n.onSuccess(s)};return{get_SupGeoRef_Object:function(e){return t(e)},get_SupGeoInstance_Object:function(e){return n(e)},Manage_SupGeo_Object:function(e){return function(e){var t="Manage_SupGeo_ObjectInternal",i=e.iFather;i||e.onFailure(t+" no iFather");var o=e.ioMap_ID_Node;o||e.onFailure(t+" no ioMap_ID_Node");var a=e.ioMap_ID_Obj;a||e.onFailure(t+" no ioMap_ID_Obj");var r=e.iObj_Father;r||e.onFailure(t+" no iObj_Father"),i.SupGeos&&i.SupGeos.forEach(function(i){n({iInstance:i,ioMap_ID_Node:o,ioMap_ID_Obj:a,onSuccess:function(n){r.Childs.push(n),r.visuinfo.node3D?r.visuinfo.node3D.addChild(n.visuinfo.node3D):e.onFailure(t+" no node3D")},onFailure:function(n){console.log(n),e.onFailure(t)}})}),e.onSuccess()}(e)}}}),define("DS/DibUDLWebLoader/Annotation_UDLWebLoader",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/PADServices/utils/GlobalUtils","DS/DibUDLWebLoader/TraceUDLWebLoader"],function(e,t,n,i,o){"use strict";var a=function(e){var t=i.getLang(),n=new Date(e);if(!isNaN(n.getTime()))return n=n.toLocaleDateString(t);var o=e.replace("@"," ").replace(":GMT"," GMT");return n=new Date(o),isNaN(n.getTime())?(console.error("Invalid date format:",e),null):n=n.toLocaleDateString(t)};return{manageAnnWithLink:function(e){return function(e){var t="manageAnnWithLinkInternal",n=e.textWithLink;n||e.onFailure(t+" no textWithLink");var i=e.ioTextsSrIds;i||e.onFailure(t+" no ioTextsSrIds");var o=e.ioTextsPointedIds;o||e.onFailure(t+" no ioTextsPointedIds");var a=e.ioMapAttName;a||e.onFailure(t+" no ioMapAttName");var r=e.ioMapResultString;if(r||e.onFailure(t+"no ioMapResultString"),"AnnWithLink"==n.Type){var s=a.get(n.AttributeName);s||(s=n.AttributeName);var u=n.ResultString;if(n.PLM_ref_ID){var c=n.PLM_ref_ID,l="FALSE";"ContextualLink"===c?l="TRUE":"ContextualLinkEA"===c&&(l="TRUE",u=" ");var f=o.includes(c);f||o.push(c);var d=r.get(c);d?d&&((f=d.AttributeName.includes(s))||(d.AttributeName.push(s),d.ResultString.push(u),d.Modified.push(l),d.IndexInTable.push(n.IndexInTable))):((D={AttributeName:[],ResultString:[],Modified:[],IndexInTable:[]}).AttributeName.push(s),D.ResultString.push(u),D.Modified.push(l),D.IndexInTable.push(n.IndexInTable),d=D,r.set(c,d))}else if(n.Relation_ID){var D;i.push(n.Relation_ID),(D={AttributeName:[],ResultString:[],Modified:[],IndexInTable:[]}).AttributeName.push(s),D.ResultString.push(n.ResultString),D.Modified.push("FALSE"),D.IndexInTable.push(n.IndexInTable),r.set(n.Relation_ID,D)}}e.onSuccess()}(e)},loadAnnWithLink:function(i){return function(i){var o="loadAnnWithLinkInternal",a=i.textWithLink;a||i.onFailure(o+" no textWithLink");var r=i.ioMapDifObjStreamToLoadedNode;r||i.onFailure(o+" no ioMapDifObjStreamToLoadedNode");var s=i.ioMapAttName;s||i.onFailure(o+" no ioMapAttName");var u=i.ioMapResultString;u||i.onFailure(o+"no ioMapResultString");var c=i.ioAllSymbolInfos;if(c||i.onFailure(o+"no ioAllSymbolInfos"),"AnnWithLink"==a.Type){var l=s.get(a.AttributeName);l||(l=a.AttributeName);var f,d,D=new e;if(a.PLM_ref_ID){if(p=u.get(a.PLM_ref_ID)){var h=p.AttributeName;for(let e=0;e<h.length;e++)if(l===h[e]){f=p.ResultString[e],d=p.Modified[e];break}}}else if(a.Relation_ID){var p;(p=u.get(a.Relation_ID))&&(f=p.ResultString[0],d=p.Modified[0])}if("TRUE"===d){var v={text:f,hotspot:{x:0,y:0},font:a.FontName,color:(new t.Color).setRGB(a.Red/255,a.Green/255,a.Blue/255),fontSize:a.FontSize,bold:a.bold},g=n.createTextNode(v);D.addChild(g),r.set(a.ID,D)}else c.push([a,D])}i.onSuccess()}(i)},ExtractEAInfos:function(e){return function(e){var t="ExtractEAInfosInternal",n=e.queryPhysicalID;n||e.onFailure(t+" no queryPhysicalID");var i=e.data;i||e.onFailure(t+" no data");var o=e.ioPointedObj;if(o.resourceid=n,o.mapPhysicalID="ContextualLinkEA",o.ea_createdby=i.ea_createdby,i.ea_releaseddate){var r=a(i.ea_releaseddate);r&&(o.ea_releaseddate=r)}if(i.ea_released){var s=0;i.ea_released.forEach(function(e){if(e){o["ea_releasedby."+ ++s]=e.ea_releasedby;var t="ea_releaseddate."+s,n=a(i.ea_releaseddate);n&&(o[t]=n),o["ea_releasedtask."+s]=e.ea_releasedtask}})}if(i.ea_changesstatusdate){var u=a(i.ea_changesstatusdate);u&&(o.ea_changesstatusdate=u)}if(i.ea_changesstatusaction&&(o.ea_changesstatusaction=i.ea_changesstatusaction),i.ea_changesstatus){var c=0;i.ea_changesstatus.forEach(function(e){if(e){o["ea_changesstatusby."+ ++c]=e.ea_changesstatusby;var t="ea_changesstatusdate."+c,n=a(i.ea_changesstatusdate);n&&(o[t]=n),o["ea_changesstatustask."+c]=e.ea_changesstatustask}})}e.onSuccess()}(e)},ExtractInfos:function(e){return function(e){var t="ExtractInfosInternal",n=e.queryPhysicalID;n||e.onFailure(t+" no queryPhysicalID");var i=e.mapPhysicalID;i||e.onFailure(t+" no mapPhysicalID");var o=e.data;o||e.onFailure(t+" no data");var a=e.ioPointedObj;o.results&&o.results.forEach(function(e){var t=e.resourceid;if(t&&t===n)for(var i in e)a[i]=e[i]}),a.mapPhysicalID=i,e.onSuccess()}(e)},parseDate:function(e){return a(e)}}}),define("DS/DibUDLWebLoader/LinkUDLWebLoader",["DS/Visualization/Node3D","DS/DibUDLWebLoader/TraceUDLWebLoader"],function(e,t){"use strict";return{create_Link_FromJson:function(e){return function(e){var t="create_Link_FromJson_Internal",n=e.iJson;n||e.onFailure(t+" no iJson"),e.iomap_ID_Node||e.onFailure(t+" no iomap_ID_Node"),e.iomap_ID_Obj||e.onFailure(t+" no iomap_ID_Obj");var i=e.iObj_Father;i||e.onFailure(t+" no iObj_Father");var o=n.Type;"Link"!==o&&e.onFailure(t+"object not of good type");var a;(a={}).type=o,i.links||(i.links=[]);i.links.push(a),a.father=i,n.Link_ID&&(a.Link_ID=n.Link_ID),n.RepInst_ID&&(a.repInst_ID=n.RepInst_ID),n.POFI_ID&&(a.pofi=[],n.POFI_ID.forEach(function(e){a.pofi.push(e)}));n.Target&&(a.target={},n.Target.CGM_ID&&(a.target.cgmid=n.Target.CGM_ID),n.Target.Target_ID&&(a.target.targetid=n.Target.Target_ID),n.Target.Diezele&&(a.target.diezele=n.Target.Diezele));e.onSuccess()}(e)}}}),define("DS/DibUDLWebLoader/DifCaptureUDLWebLoader",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphUtils","DS/Visualization/PathElement","DS/DibUDLWebLoader/DifSupplementalGeometryUDLWebLoader","DS/DibUDLWebLoader/TraceUDLWebLoader"],function(e,t,n,i,o,a){"use strict";var r=function(n){var i="get_CaptureRef_ObjectInternal",r=n.iRef;r||n.onFailure(i+" no iRef");var s=n.ioMap_ID_Node;s||n.onFailure(i+" no ioMap_ID_Node");var u=n.ioMap_ID_Obj;u||n.onFailure(i+" no ioMap_ID_Obj");var c=u.get(r.iD);c&&n.onSuccess(c);var l=r.viewStreamInstance.viewStream,f=s.get(r.iD);if(!f){var d=new e;f=d,s.set(r.iD,f)}var D=s.get(l.iD);D&&f.addChild(D);(c={}).ID=r.iD,c.Name=r.Name,c.Type="Capture",c.Childs=[];var h={};h.node3D=f,c.visuinfo=h;var p=r.Matrix,v=new t.Vector3(p[3],p[4],p[5]),g=new t.Vector3(p[6],p[7],p[8]),I=new t.Vector3(p[9],p[10],p[11]);h.plane=new t.Plane,h.plane.setFromNormalAndCoplanarPoint(g,I),h.up=v,r.presentedAnnotations?r.presentedAnnotations.forEach(function(e){var t={};(t=e.PlaneID?s.get(e.PlaneID):s.get(e.iD))&&f.addChild(t)}):r.MBDViews&&r.MBDViews.forEach(function(e){var t=s.get(e.view.viewStreamInstance.viewStream.iD);t&&f.addChild(t)});var S={iFather:r,iObj_Father:c,ioMap_ID_Node:s,ioMap_ID_Obj:u,onSuccess:function(){a.consolePrint("Manage_SupGeo_Object Ok")},onFailure:function(e){a.consolePrint(e),n.onFailure(i)}};o.Manage_SupGeo_Object(S),u.set(c.ID,c),n.onSuccess(c)},s=function(t){var n="get_CaptureInstance_ObjectInternal",i=t.iInstance;i||t.onFailure(n+" no iInstance");var o=t.ioMap_ID_Node;o||t.onFailure(n+" no ioMap_ID_Node");var s=t.ioMap_ID_Obj;s||t.onFailure(n+" no ioMap_ID_Obj");var u=s.get(i.iD);u&&t.onSuccess(u);var c=o.get(i.iD);c||(c=new e,o.set(i.iD,c));(u={}).ID=i.iD,u.Name=i.Name,u.Type="CaptureInstance",u.Childs=[];var l={};l.node3D=c,u.visuinfo=l;var f={iRef:i.capture,ioMap_ID_Node:o,ioMap_ID_Obj:s,onSuccess:function(e){u.Name||(u.Name=e.Name),u.Childs.push(e),u.visuinfo.node3D?u.visuinfo.node3D.addChild(e.visuinfo.node3D):t.onFailure(n+" no node3D")},onFailure:function(e){a.consolePrint(e),t.onFailure(n)}};r(f),s.set(u.ID,u),t.onSuccess(u)};return{get_CaptureRef_Object:function(e){return r(e)},get_CaptureInstance_Object:function(e){return s(e)},Manage_Capture_Object:function(e){return function(e){var t="Manage_Capture_ObjectInternal",n=e.iFather;n||e.onFailure(t+" no iFather");var i=e.ioMap_ID_Node;i||e.onFailure(t+" no ioMap_ID_Node");var o=e.ioMap_ID_Obj;o||e.onFailure(t+" no ioMap_ID_Obj");var r=e.iObj_Father;r||e.onFailure(t+" no iObj_Father"),n.Captures&&n.Captures.forEach(function(n){s({iInstance:n,ioMap_ID_Node:i,ioMap_ID_Obj:o,onSuccess:function(n){r.Childs.push(n),r.visuinfo.node3D?r.visuinfo.node3D.addChild(n.visuinfo.node3D):e.onFailure(t+" no node3D")},onFailure:function(n){a.consolePrint(n),e.onFailure(t)}})}),e.onSuccess()}(e)}}}),define("DS/DibUDLWebLoader/MBDViewUDLWebLoader",["DS/Visualization/Node3D","DS/DibUDLWebLoader/DifSupplementalGeometryUDLWebLoader"],function(e,t){"use strict";var n=function(n){var i="get_MBDViewRef_ObjectInternal",o=n.iRef;o||n.onFailure(i+" no iRef");var a=n.ioMap_ID_Node;a||n.onFailure(i+" no ioMap_ID_Node");var r=n.ioMap_ID_Obj;r||n.onFailure(i+" no ioMap_ID_Obj");var s=r.get(o.iD);s&&n.onSuccess(s);o.viewStreamInstance.viewStream;var u=a.get(o.iD);if(!u){var c=new e;u=c,a.set(o.iD,u)}(s={}).ID=o.iD,s.Name=o.Name,s.Type="MBDView",s.Childs=[];var l={};l.node3D=u,s.visuinfo=l,o.tpsTexts&&o.tpsTexts.forEach(function(t){var n=a.get(t.iD);if(n){var i=a.get(t.plane);if(!i){i=new e;var o=t.plane;a.set(o,i),a.set(o+"A",i),u.addChild(i)}i.addChild(n)}});var f={iFather:o,iObj_Father:s,ioMap_ID_Node:a,ioMap_ID_Obj:r,onSuccess:function(){console.log("Manage_SupGeo_Object Ok")},onFailure:function(e){console.log(e),n.onFailure(i)}};t.Manage_SupGeo_Object(f),r.set(s.ID,s),n.onSuccess(s)},i=function(t){var i="get_MBDViewInstance_ObjectInternal",o=t.iInstance;o||t.onFailure(i+" no iInstance");var a=t.ioMap_ID_Node;a||t.onFailure(i+" no ioMap_ID_Node");var r=t.ioMap_ID_Obj;r||t.onFailure(i+" no ioMap_ID_Obj");var s=r.get(o.iD);s&&t.onSuccess(s);var u=a.get(o.iD);u||(u=new e,a.set(o.iD,u));(s={}).ID=o.iD,s.Name=o.Name,s.Type="MBDViewInstance",s.Childs=[];var c={};c.node3D=u,s.visuinfo=c;var l={iRef:o.view,ioMap_ID_Node:a,ioMap_ID_Obj:r,onSuccess:function(e){s.Name||(s.Name=e.Name),s.Childs.push(e),s.visuinfo.node3D?s.visuinfo.node3D.addChild(e.visuinfo.node3D):t.onFailure(i+" no node3D")},onFailure:function(e){console.log(e),t.onFailure(i)}};n(l),r.set(s.ID,s),t.onSuccess(s)};return{get_MBDViewRef_Object:function(e){return n(e)},get_MBDViewInstance_Object:function(e){return i(e)},Manage_MBDView_Object:function(e){return function(e){var t="Manage_MBDView_ObjectInternal",n=e.iFather;n||e.onFailure(t+" no iFather");var o=e.ioMap_ID_Node;o||e.onFailure(t+" no ioMap_ID_Node");var a=e.ioMap_ID_Obj;a||e.onFailure(t+" no ioMap_ID_Obj");var r=e.iObj_Father;r||e.onFailure(t+" no iObj_Father"),n.MBDViews&&n.MBDViews.forEach(function(n){i({iInstance:n,ioMap_ID_Node:o,ioMap_ID_Obj:a,onSuccess:function(n){r.Childs.push(n),r.visuinfo.node3D?r.visuinfo.node3D.addChild(n.visuinfo.node3D):e.onFailure(t+" no node3D")},onFailure:function(n){console.log(n),e.onFailure(t)}})}),e.onSuccess()}(e)}}}),define("DS/DibUDLWebLoader/DifUDLWebLoader",["UWA/Core","UWA/Class","DS/ZipJS/zip-fs","DS/Visualization/Node3D","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/DibWebUtils/DibQueryToolbox","DS/Visualization/RenderStyle","DS/Visualization/PathElement","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/Visualization/SceneGraphFactory","DS/DibUDLWebLoader/Annotation_UDLWebLoader"],function(e,t,n,i,o,a,r,s,u,c,l,f){"use strict";let d=()=>require("DS/PADUtils/PADUtilsServices").getPlatformId(),D=()=>require("DS/PADServices/utils/GlobalUtils").getLang();return t.extend({init:function(){var t,c,h,p,v,g=[],I=new Map,S=new Map,b=new Map,w=new Map,m=new Map,L=[],y=0,F=0,_=0,M={},A=0,C=[],T=[],x=[],P=50,V=new Map,N=new Map,R=new Map,O=new Map;O.set("current","ds6w:status"),O.set("policy","ds6w:policy"),O.set("project","ds6w:project"),O.set("responsible","ds6w:responsible"),O.set("reservedby","ds6w:reservedby"),O.set("reserved","ds6w:reserved"),O.set("revision","ds6wg:majorrevision"),O.set("V_Name","bo.PLMEntity.V_Name"),O.set("PLM_ExternalID","bo.PLMEntity.PLM_ExternalID");var U=function(e){return"DIFLayout"===e},E=function(e){console.log(e)},j=function(e,t,n){e.ObjectList&&e.ObjectList.forEach(function(e){var n=new a.Matrix4;n.setPosition(new a.Vector3(e.SymbolCompToViewMatrix[4],e.SymbolCompToViewMatrix[5],0));var i=e.SymbolCompToViewMatrix[0],o=e.SymbolCompToViewMatrix[1],r=e.SymbolCompToViewMatrix[2],s=e.SymbolCompToViewMatrix[3];0===i&&0===r&&0===o&&0===s&&(i=1,s=1);var u=[i,r,0,o,s,0,0,0,1];n.setRotation(u);var c=w.get(e.ID);c&&(c.setMatrix(n),t.addChild(c)),e.ObjectList&&e.ObjectList.forEach(function(e){var n=new a.Matrix4;n.setPosition(new a.Vector3(e.SymbolCompToViewMatrix[4],e.SymbolCompToViewMatrix[5],0));var i=[e.SymbolCompToViewMatrix[0],e.SymbolCompToViewMatrix[2],0,e.SymbolCompToViewMatrix[1],e.SymbolCompToViewMatrix[3],0,0,0,1];n.setRotation(i);var o=w.get(e.ID);o.setMatrix(n),t.addChild(o)})}),n()},W=function(e,t,n){return new Promise(i=>{var r=t.cgr,s=e.find(r),u=new zip.BlobWriter,c=new a.Matrix4;c.setPosition(new a.Vector3(0,0,0));c.setRotation([1,0,0,0,1,0,0,0,1]),n.setMatrix(c);var l=new o;l.setFileType("cgr"),l.set2DAccuracy(y),l.set3DAccuracy(F),1===_&&l.setSceneGraphOrderMode(1),l.setOnLoadedCallback(function(){i()}),s.getData(u,function(e){var t=new FileReader;t.onload=function(){l.loadModelFromBuffer(this.result,n)},t.readAsArrayBuffer(e)});var f=t.cgr_texts;if(""!==f&&void 0!==f){var d=e.find(f),D=new zip.BlobWriter;d.getData(D,function(e){var t=new FileReader;t.onload=function(){l.loadModelFromBuffer(this.result,n)},t.readAsArrayBuffer(e)})}})},k=async function(e,t,n){for(let i of t)await W(e,i[0],i[1]).then(()=>{i[2]?(w.set(i[0].ID,i[2]),i[2].addChild(i[1])):w.set(i[0].ID,i[1]),n()})},B=function(e,t,n){let i=Math.ceil(t.length/10);for(let a=0;a<10;a++){var o=t.slice(i*a,i*(a+1));k(e,o,n)}},G=function(e,n,o,a,s,u,l){!function(e,n,i,o){var a="getSymbolRealPlmId: ";e||(E(a+"Please provide view stream ID"),o()),n||(E(a+"Please provide symbols relation ID"),o());var s={difViewStreamId:e,symbolsInViewRelIds:n,serverUrl:t,securityContext:c,onComplete:function(e,t){i(e,t)},onFailure:function(){E(a+"Failed getRepObjPlmIdAssociatedToSymbol"),o()}};r.getRepObjPlmIdAssociatedToSymbol(s)}(o,s,function(t,o){N.clear(),R.clear(),t&&t.forEach(function(e){N.set(e.matches[0].sr_id,e.physicalid)}),o&&o.forEach(function(e){R.set(e.matches[0].sr_id,e.to.physicalid)});!function(e,t,n){if(t.ObjectList){let r=[];t.ObjectList.forEach(function(e){if("Symbol"===e.Type){var t=new i,n=N.get(e.Relation_ID);if(t._dibInfo={id:n,type:e.PLM_Type},t.getDibInfo=function(){return this._dibInfo},e.PLM_ref_ID&&e.PLM_ref_Type){var o=new i,a=R.get(e.Relation_ID);o._dibInfo={id:a,type:e.PLM_ref_Type},o.getDibInfo=function(){return this._dibInfo},r.push([e,o,t])}else r.push([e,t])}if("Route"===e.Type){var s=new i,u=N.get(e.Relation_ID);if(s._dibInfo={id:u,type:e.PLM_Type},s.getDibInfo=function(){return this._dibInfo},e.PLM_ref_ID&&e.PLM_ref_Type){var c=new i,l=R.get(e.Relation_ID);c._dibInfo={id:l,type:e.PLM_ref_Type},c.getDibInfo=function(){return this._dibInfo},r.push([e,c,s])}else r.push([e,s])}e.ObjectList&&e.ObjectList.forEach(function(e){var t=new i,n=N.get(e.Relation_ID);if(t._dibInfo={id:n,type:e.PLM_Type},t.getDibInfo=function(){return this._dibInfo},e.PLM_ref_ID&&e.PLM_ref_Type){var o=new i,a=R.get(e.Relation_ID);o._dibInfo={id:a,type:e.PLM_ref_Type},o.getDibInfo=function(){return this._dibInfo},r.push([e,o,t])}else r.push([e,t])})});var o=0;if(r){var a=r.length;B(e,r,function(){a===++o&&n()})}}}(e,n,function(){0,u()})},function(){E("loadViewSymbols:  Failed getSymbolRealPlmId"),l()})},z=function(e,t,n,i){var o={},a={queryPhysicalID:t,mapPhysicalID:n,data:e,ioPointedObj:o,onSuccess:function(){E("ExtractInfosFromQuery ExtractInfos Ok"),i(o)},onFailure:function(e){E(e+"ExtractInfosFromQueryFailed to ExtractInfos")}};f.ExtractEAInfos(a)},q=function(e,t){var n="ExtractInfosFromQueryEA",i={},o={queryPhysicalID:M.ID,data:e,ioPointedObj:i,onSuccess:function(){E(n+" ExtractEAInfos Ok"),t(i)},onFailure:function(e){E(e+n+"Failed to ExtractEAInfos")}};f.ExtractEAInfos(o)},J=function(e,n,i,o,a){n.length>0&&e?function(e,n,i,o){var a="queryTextToDisplayWithSRId: ";e||(E(a+" Please provide view stream ID"),o()),n||(E(a+" Please provide text relation ID"),o());var s=n.length;let u=[];for(var l=0;s--;){var f=n[s];if("undefined"!=f){var d=m.get(f);if(d){var D={difViewStreamId:e,textsSRId:f,textsAttr:d.AttributeName[0],serverUrl:t,securityContext:c,onComplete:function(e){u.push(e),u.length+l===n.length&&i(u)},onFailure:function(e){E(e+a+"Failed to retrieve query from SR ID"),l++,u.length+l===n.length&&i(u)}};r.getPointedObjects(D)}}else l++,u.length+l===n.length&&i(u)}}(e,n,function(e){o(e)},function(){E("manageTextToDisplay  Failed to retrieve query with SR ID"),a()}):i.length>0&&function(e,n,i){var o="queryTextToDisplayWithPointedID: ";e||(E(o+"Please provide text relation ID"),i());var a=e.length,s=0;let u=[];for(;a--;){var l=e[a],f=0,d=l;if("ContextualLink"===l?l=M.ID:"ContextualLinkEA"===l&&(l=M.ID,f=1),void 0!==l){var D=m.get(d);if(D||(D=m.get(l)),D&&0===f){var h={objectPhysicalid:l,textsAttr:D.AttributeName,serverUrl:t,mappingPLMRefId:d,securityContext:c,onComplete:function(t,i,o){z(t,i,o,function(e){u.push(e)}),u.length+s===e.length&&n(u)},onFailure:function(t){E(t+o+" Failed to retrieve query with pointed ID"),s++,u.length+s===e.length&&n(u)}};r.expandPointedObject(h)}else D&&1===f?(h={objectPhysicalid:l,serverUrl:t,securityContext:c,onComplete:function(t){q(t,function(e){u.push(e)}),u.length+s===e.length&&n(u)},onFailure:function(t){E(t+o+" Failed to retrieve query with pointed ID"),s++,u.length+s===e.length&&(s=0,n(u))}},r.getExtendedAttributes(h)):(E(o+"no tabResult"),s++,u.length+s===e.length&&(s=0,n(u)))}else s++,u.length+s===e.length&&(s=0,n(u))}}(i,function(e){o(e)},function(){E("manageTextToDisplay  Failed to retrieve query with pointed ID"),a()})},Q=function(e,t,n){var i=0;e||(E("exploitTextToDisplay No data to exploit"),n()),e.forEach(function(n){var o,a,r=n.resourceid,s=n.mapPhysicalID;if(n.matches&&(s=n.matches[0].sr_id),r){var u=m.get(s);if(u||(u=m.get("ContextualLink")),u){var c=u.AttributeName,l=u.ResultString;if(l){var h={};for(let e=0;e<l.length;e++){var p=c[e];n[p]&&(h[p]=[],h[p].push(n[p]))}(o=h,a={},new Promise(function(e){require(["DS/FedDictionaryAccess/FedDictionaryAccessAPI"],function(t){t.getNlsOfPropertiesValues(JSON.stringify(o),{tenantId:d(),lang:D(),onComplete:function(t){e(a=t)},onFailure:function(){e(a)}})})})).then(function(n){if(n&&0!==n.length){var o=0;for(let e=0;e<l.length;e++){var a=c[e],r=l[e],d=h[a];if(d){var D=n[a][d];if(r!==D)if(u.Modified[e]="TRUE",o=1,"modified"===p||"originated"===p){var v=f.parseDate(D);u.ResultString[e]=v}else u.ResultString[e]=D}}1===o&&m.set(s,u),++i===e.length&&t()}})}}}else i++})},H=function(e,t,n,o,r,s,u,c){var f=0;J(n,r,s,function(n){Q(n,function(){!function(e,t,n){let o=[];t.ObjectList&&t.ObjectList.forEach(function(e){if("AnnWithLink"===e.Type){var t=O.get(e.AttributeName);t||(t=e.AttributeName);var r,s,u=new i;if(e.Relation_ID)r=(c=m.get(e.Relation_ID)).ResultString[0],s=c.Modified[0];else if(e.PLM_ref_ID){var c,f=(c=m.get(e.PLM_ref_ID)).AttributeName;for(let e=0;e<f.length;e++)if(t===f[e]){r=c.ResultString[e],s=c.Modified[e];break}}if("TRUE"===s){var d={text:r,hotspot:{x:0,y:0},font:e.FontName,color:(new a.Color).setRGB(e.Red/255,e.Green/255,e.Blue/255),fontSize:e.FontSize,bold:e.bold},D=l.createTextNode(d);u.addChild(D),w.set(e.ID,u),n()}else o.push([e,u])}}),B(e,o,n)}(e,t,function(){o===++f&&u()})},function(){E("loadViewTexts Failed exploitTextToDisplay"),c()})},function(){E("loadViewTexts Failed manageTextToDisplay"),c()})},X=function(e,t,n,o,a){var r=new i,s=V.get(n);if(s)o(s);else{V.set(n,r);var u=0,c=[],l=0,f=[],d=[];t.ObjectList&&(u=t.ObjectList.length,m.clear(),t.ObjectList.forEach(function(e){if("AnnWithLink"===e.Type){var t=O.get(e.AttributeName);t||(t=e.AttributeName);var n=e.ResultString;if(e.Relation_ID){f.push(e.Relation_ID);var i={AttributeName:[],AttributeNameEA:[],ResultString:[],Modified:[]};i.AttributeName.push(t),i.ResultString.push(n),i.Modified.push("FALSE"),m.set(e.Relation_ID,i)}else if(e.PLM_ref_ID){var o=e.PLM_ref_ID,a="FALSE";"ContextualLink"===o?a="TRUE":"ContextualLinkEA"===o&&(a="TRUE",n=" ");var r=m.get(o);if(r)r&&(r.AttributeName.push(t),r.ResultString.push(n),r.Modified.push(a));else{d.push(o);var s={AttributeName:[],ResultString:[],Modified:[]};s.AttributeName.push(t),s.ResultString.push(n),s.Modified.push(a),r=s,m.set(o,r)}}l++,u--}else c.push(e.Relation_ID),e.ObjectList&&e.ObjectList.forEach(function(e){-1===c.indexOf(e.Relation_ID)&&(c.push(e.Relation_ID),u++)})})),l>0?H(e,t,n,l,f,d,function(){u>0?G(e,t,n,0,c,function(){j(t,r,function(){W(e,t,r).then(()=>{o(r)})})},function(){E("loadViewCGRs Failed loadViewSymbols"),a()}):j(t,r,function(){W(e,t,r).then(()=>{o(r)})})},function(){E("loadViewCGRs Failed loadViewTexts"),a()}):u>0?G(e,t,n,0,c,function(){j(t,r,function(){W(e,t,r).then(()=>{o(r)})})},function(){E("loadViewCGRs Failed loadViewSymbols"),a()}):W(e,t,r).then(()=>{o(r)})}},Y=function(o,l,f,d){var D="getSheet3DNodeFromIDInternal : ";o||(E(D+"Please provide sheet ID"),d());var h=S.get(o);if(h)return l(h),void f();var p=I.get(o);p||(E(D+"Sheet not found"),d());var v=[];p.BackgroundViewInstance&&p.BackgroundViewInstance.viewStream&&v.push(p.BackgroundViewInstance.viewStream.ID),p.views.forEach(function(e){e.view&&e.view.viewStreamInstance.viewStream&&v.push(e.view.viewStreamInstance.viewStream.ID)});var g=new i,b=g.createOverrideSetManager(),m=b.createSceneGraphOverrideSet();b.pushSceneGraphOverrideSet(m);var L=m.createOverride(new u([g])),y=new s({combineRenderMode:"IGNORE"});y.setFaceMode("MATERIAL"),L.setRenderStyle(y,!0),l(g),S.size===A&&S.clear(),S.set(o,g);var F={objectPhysicalid:v,serverUrl:t,securityContext:c,onComplete:function(t){t.results||(E(D+"getUDLData : No data retrieved"),d());var i=t.results.length,o=0,r=!1;t.results.forEach(function(t){var s;e.is(t.attributes,"array")&&(t.attributes.forEach(function(e){if("resourceid"===e.name&&(s=e.value),"udl"===e.name){r=!0;var t=new n.fs.FS,u={provider:"FILE",filename:e.value,serverurl:"",proxyurl:"none",requiredAuth:null};t.importHttpContent(u,!1,function(){var e=t.find("DrwStructure.json");null==e&&(E(D+"failed zipEntries"),d()),e.getText(function(e){var n=JSON.parse(e.target.result);_=n.DrawOrderMode,X(t,n.View,s,function(e){w.set(s,e),i!==++o||function(e,t,n){var i=w.get(e.BackgroundViewInstance.viewStream.ID);t.addChild(i),e.views.forEach(function(e){var n,i=e.Angle;n="OnReference"===e.view.ScaleStatus?e.view.Scale:e.Scale;var o=new a.Matrix4;o.setPosition(new a.Vector3(e.X,e.Y,0));var r=[Math.cos(i)*n,Math.sin(i)*n,0,-Math.sin(i)*n,Math.cos(i)*n,0,0,0,1];o.setRotation(r);var s=w.get(e.view.viewStreamInstance.viewStream.ID);s.setMatrix(o),t.addChild(s)}),n()}(p,g,function(){f(),w.clear()})},function(){E(D+"failed loadViewCGRs"),d()})})},function(){E(D+"failed importHttpContent"),d()})}}),r||(E(D+"UDL - No UDL for input model"),d()))})},onFailure:function(){E(D+"Failed getUDLData query"),d()}};r.getUDLData(F)},Z=function(i,o,s,u){var l="setDisplaySheetInternal : ";i||(E(l+"Please provide sheet ID"),u());var f=I.get(i);f||(E(l+"Sheet not found"),u());var d=[];f.BackgroundViewInstance&&f.BackgroundViewInstance.viewStream&&d.push(f.BackgroundViewInstance.viewStream.ID),f.views.forEach(function(e){e.view&&e.view.viewStreamInstance.viewStream&&d.push(e.view.viewStreamInstance.viewStream.ID)}),f.views.length+1>P-V.size&&V.clear();var D={objectPhysicalid:d,serverUrl:t,securityContext:c,onComplete:function(t){t.results||(E(l+"no results in data"),u());var i=t.results.length,r=0,c=!1;t.results.forEach(function(t){var d;e.is(t.attributes,"array")&&(t.attributes.forEach(function(e){if("resourceid"===e.name&&(d=e.value),"udl"===e.name){c=!0;var t=new n.fs.FS,D={provider:"FILE",filename:e.value,serverurl:"",proxyurl:"none",requiredAuth:null};t.importHttpContent(D,!1,function(){var e=t.find("DrwStructure.json");null==e&&(E(l+"failed zipEntries"),u()),e.getText(function(e){var n=JSON.parse(e.target.result);X(t,n.View,d,function(e){w.set(d,e),i!==++r||function(e,t){h&&C.length>0&&h.getController().lockNodes({ids:C}),v&&p&&p.removeChild(v),x.forEach(function(e){e.removeChildren()}),x.splice(0,x.length);var n,i=w.get(e.BackgroundViewInstance.viewStream.ID);v=i,h&&(n=h.getController().getNode({id:e.ID})),n&&(p=n,n.addChild(i),S.set(e.ID,n)),e.views.forEach(function(e){var t,n=e.Angle;t="OnReference"===e.view.ScaleStatus?e.view.Scale:e.Scale;var i=new a.Matrix4;i.setPosition(new a.Vector3(e.X,e.Y,0));var o=[Math.cos(n)*t,Math.sin(n)*t,0,-Math.sin(n)*t,Math.cos(n)*t,0,0,0,1];i.setRotation(o);var r,s=w.get(e.view.viewStreamInstance.viewStream.ID);h&&(r=h.getController().getNode({id:e.view.ID})),r&&(x.push(r),r.addChild(s)),s.setMatrix(i)}),t(n)}(f,function(e){o(e),s(),w.clear()})},function(){E(l+"failed loadViewCGRs"),u()})})},function(){E(l+"failed importHttpContent"),u()})}}),c||(E(l+"UDL - No UDL for input model"),u()))})},onFailure:function(){E(l+"Failed getUDLData query"),u()}};r.getUDLData(D)};this.getNumberOfSheets=function(){return g.length},this.getSheetName=function(e){return function(e){return I.get(e).Name}(e)},this.getLoadedSheetsId=function(){return L},this.getSheetBackgroundColor=function(e){return(new a.Color).setRGB(1,1,1)},this.getSheet3DNode=function(e){Y(e.sheetID,e.onSheetNodeCreated,e.onSheetLoaded,e.onFailure)},this.setDisplaySheet=function(e){Z(e.sheetID,e.onSheetNodeCreated,e.onSheetLoaded,e.onFailure)},this.getSheetSize=function(e){return{height:I.get(e).Height,width:I.get(e).Width}},this.setMaxSheetInCache=function(e){A=e},this.isDetailSheet=function(e){return!1},this.is3DObject=function(){return!1},this.getSheetThumbnail=function(e){e.onFailure()},this.setSheetPickingByView=function(e){var t=S.get(e.sheetID);null!=t&&t.children.forEach(function(t){t.userData&&"DIFViewInstance"===t.userData.type?x.forEach(function(t){t.children.forEach(function(t){t.children.forEach(function(t){"CGR"===t.name&&t.setPickParent(e.pickingByView),t.children.forEach(function(t){"CGR"===t.name&&t.setPickParent(e.pickingByView),t.children.forEach(function(t){"CGR"===t.name&&t.setPickParent(e.pickingByView)})})})})}):t.children.forEach(function(t){"CGR"===t.name&&t.setPickParent(e.pickingByView),t.children.forEach(function(t){"CGR"===t.name&&t.setPickParent(e.pickingByView),t.children.forEach(function(t){"CGR"===t.name&&t.setPickParent(e.pickingByView)})})})})},this.set2DAccuracy=function(e){y=e},this.set3DAccuracy=function(e){F=e},this.clearLoader=function(){g&&(g=null),I&&(I=null),S&&(S=null),b&&(b=null),w&&(w=null),L&&(L=null),t&&(t=null),c&&(c=null),y&&(y=null),F&&(F=null),_&&(_=null),M&&(M=null),A&&(A=null),h&&(h=null),C&&(C=null),T&&(T=null),p&&(p=null),v&&(v=null),x&&(x=null),P&&(P=null),V&&(V=null),N&&(N=null),R&&(R=null)},this.loadModel=function(e){if(e||(E("DifUDLWebLoader: Bad parameters"),e.onFailure()),e.serverUrl)if(e.securityContext){e.data||(E("DifUDLWebLoader: Bad parameters"),e.onFailure()),e.data.physicalid||(E("DifUDLWebLoader: Bad parameters"),e.onFailure()),e.data.dataType||(E("DifUDLWebLoader: Bad parameters"),e.onFailure()),t=e.serverUrl,c=e.securityContext,h=e.contextViewer;var n={objectPhysicalid:e.data.physicalid,serverUrl:t,securityContext:c,onComplete:function(t){if(M.ID=e.data.physicalid,M.Type=e.data.dataType,function(e){var t,n;e.results.forEach(function(e){if("resourceid"in e){var i={};for(var o in e)i[o]=e[o];i.resourceid&&b.set(i.resourceid,i)}else if(e.Path){var a,r,s;e.Path.forEach(function(e){var i=e.toString(),o=b.get(i);if("ds6w:type"in o){if("DIFSheetInstance"===o["ds6w:type"]&&(!n||n.ID!==o.resourceid)){var u={};u.ID=o.resourceid,n=u,T.push(n)}if(function(e){return"DIFSheet"===e}(o["ds6w:type"])&&(!t||t.ID!==o.resourceid)){var c={views:[]};c.ID=o.resourceid,c.Name=o["bo.PLMEntity.V_Name"],c.Height=parseFloat(o["bo.DIFAbstractSheet.V_DIFFormatHeight"]),c.Width=parseFloat(o["bo.DIFAbstractSheet.V_DIFFormatWidth"]),t=c,g.push(t),n&&(n.sheetID=c.ID)}if(function(e){return"DIFViewInstance"===e}(o["ds6w:type"])){var l={};l.ID=o.resourceid,l.Scale=parseFloat(o["ro.DIFAbstractViewInstance.V_DIFScale"]),l.X=parseFloat(o["ro.DIFAbstractViewInstance.V_DIFPosX"]),l.Y=parseFloat(o["ro.DIFAbstractViewInstance.V_DIFPosY"]),l.Angle=parseFloat(o["ro.DIFAbstractViewInstance.V_DIFAngle"]),a=l,t.views.push(a)}if(function(e){return"DIFView"===e}(o["ds6w:type"])){var f={};f.ID=o.resourceid,f.Scale=parseFloat(o["bo.DIFAbstractView.V_DIFScale"]),f.ScaleStatus=o["bo.DIFAbstractView.V_DIFScaleStatus"],r=f,a.view=r}if(function(e){return"DIFViewStreamInstance"===e||"DIFBackgroundViewRepInstance"===e}(o["ds6w:type"])){var d={};d.ID=o.resourceid,s=d,r?r.viewStreamInstance=d:t.BackgroundViewInstance=d}if(function(e){return"DIFViewStream"===e||"DIFBackgroundViewRep"===e}(o["ds6w:type"])){var D={};D.ID=o.resourceid,s.viewStream=D}}}),a=null,r=null,s=null}})}(t),L=[],g.forEach(function(e){var t=e.ID;I.set(t,e),L.push(t)}),h){var n={max:[-1,-1,-1],min:[1,1,1]},i={resourceid:M.ID,"ds6w:type":M.Type,"ds6w:globaltype":"ds6w:Part",boundingbox:n},o={encoding:"UTF-8",kind:"InstRef",version:"1.1"},a={infos:o,results:[i,{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:3}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:3}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},r=[];r.push(i),U(M.Type)&&g.forEach(function(e){var t={resourceid:e.ID,"ds6w:type":"DIFSheet","ds6w:globaltype":"ds6w:Part",boundingbox:n};r.push(t)}),g.forEach(function(e){e.views&&e.views.forEach(function(e){if(e.view){var t={resourceid:e.view.ID,"ds6w:type":"DIFView","ds6w:globaltype":"ds6w:Part",boundingbox:n};r.push(t),C.push(e.view.ID)}})}),U(M.Type)&&T.forEach(function(e){var t={resourceid:e.ID,"ds6w:type":"DIFSheetInstance",from:M.ID,to:e.sheetID};r.push(t)}),g.forEach(function(e){e.views&&e.views.forEach(function(t){if(t.view){var n={resourceid:t.ID,"ds6w:type":"DIFViewInstance",from:e.ID,to:t.view.ID};r.push(n)}})});var s={rootStats:a,infos:o,results:r};h.loadJSON({data:[{rootID:M.ID,validForServerCall:!0,structure:s}]})}var u={sheetIDList:L};L.length>0&&(u.currentSheetID=L[0]),e.onComplete(u)},onFailure:function(){E("DifUDLWebLoader: Failed expandDifComponent"),e.onFailure()}};r.expandDifComponent(n)}else E("DifUDLWebLoader: Bad argurment");else E("DifUDLWebLoader: Bad argurment")}}})}),define("DS/DibUDLWebLoader/DraftingUDLWebLoader",["UWA/Core","UWA/Class","DS/ZipJS/zip-fs","DS/Visualization/Node3D","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/DibWebUtils/DibQueryToolbox","DS/Visualization/RenderStyle","DS/Visualization/PathElement","DS/Visualization/SceneGraphFactory","DS/DibUDLWebLoader/TraceUDLWebLoader","DS/DibUDLWebLoader/Annotation_UDLWebLoader"],function(e,t,n,i,o,a,r,s,u,c,l,f){"use strict";let d=()=>require("DS/PADUtils/PADUtilsServices").getPlatformId(),D=()=>require("DS/PADServices/utils/GlobalUtils").getLang();return t.extend({init:function(){var e,t,c,h,p,v,g=new Map,I=new Map,S=[],b=[],w=0,m=-1,L=0,y=0,F=0,_=new Map,M=new Map,A=new Map,C=new Map,T="toto",x=new Map,P=new Map;A.set("current","ds6w:status"),A.set("policy","ds6w:policy"),A.set("project","ds6w:project"),A.set("responsible","ds6w:responsible"),A.set("reservedby","ds6w:reservedby"),A.set("reserved","ds6w:reserved"),A.set("revision","ds6wg:majorrevision"),A.set("V_Name","bo.PLMEntity.V_Name"),A.set("PLM_ExternalID","bo.PLMEntity.PLM_ExternalID");var V=function(e,t,n){var i="manageAnnotation";t.Views.forEach(function(o){var a=C.get(o.ID).viewNode,r=0,s=[],u=[],c=T,d={AnnToLoad:[],TextLoaded:[],TableLoaded:[]};o.ObjectList&&(r=0,o.ObjectList.forEach(function(e){if("AnnWithLink"===e.Type){r++,d.AnnToLoad.push(e.ID);var t={textWithLink:e,ioTextsSrIds:s,ioTextsPointedIds:u,ioMapAttName:A,ioMapResultString:M,onSuccess:function(){l.consolePrint(i+" ManageAnnWithLink Ok")},onFailure:function(e){l.consolePrint(e),onFailure()}};f.manageAnnWithLink(t)}else"AnnTableWithLink"===e.Type&&(r++,d.AnnToLoad.push(e.ID),e.ObjectList.forEach(function(t){if("AnnWithLink"===t.Type){r++,d.AnnToLoad.push(e.ID);var n={textWithLink:t,ioTextsSrIds:s,ioTextsPointedIds:u,ioMapAttName:A,ioMapResultString:M,onSuccess:function(){l.consolePrint(i+" ManageAnnWithLink Ok")},onFailure:function(e){l.consolePrint(e),onFailure()}};f.manageAnnWithLink(n)}}))})),d.AnnToLoad.length&&P.set(o.ID,d),r>0?B(e,o,c,r,s,u,function(){R(o,a,function(){z(e,o,a).then(()=>{l.consolePrint(i+"loadViewTexts OK");var e=x.get(t.ID),a=C.get(o.ID);0===a.isLoaded&&(a.isLoaded=1,e.viewLoaded.push(o.ID)),n()})})},function(){z(e,o,a).then(()=>{l.consolePrint(i+" failed loadViewTexts ");var e=x.get(t.ID),a=C.get(o.ID);0===a.isLoaded&&(a.isLoaded=1,e.viewLoaded.push(o.ID)),n()})}):z(e,o,a).then(()=>{l.consolePrint(i+"loadViewTexts OK");var e=x.get(t.ID),a=C.get(o.ID);0===a.isLoaded&&(a.isLoaded=1,e.viewLoaded.push(o.ID)),n()})})},N=function(n,o,r,s){let u=[];_.clear(),C.clear(),x.clear(),P.clear(),M.clear();var c={viewToLoad:[],viewLoaded:[]},l=t[n];l.Views.forEach(function(e){var t=new i;u.push([e,t]);var n={viewNode:t,isLoaded:0};C.set(e.ID,n),c.viewToLoad.push(e.ID)}),c.viewToLoad.length&&x.set(l.ID,c);var f=0;G(e,u,function(){++f>=u.length&&V(e,l,function(){l.Views.forEach(function(e){var t=e.ViewToSheetMatrix,n=new a.Matrix4;n.setPosition(new a.Vector3(t[4],t[5],0));var i=[t[0],t[2],0,t[1],t[3],0,0,0,1];n.setRotation(i);var r=C.get(e.ID).viewNode;r.setMatrix(n),o.addChild(r)});var e=x.get(l.ID);e.viewToLoad.length===e.viewLoaded.length&&r()})})},R=function(e,t,n){e.ObjectList&&e.ObjectList.forEach(function(e){var n=new a.Matrix4;n.setPosition(new a.Vector3(e.SymbolCompToViewMatrix[4],e.SymbolCompToViewMatrix[5],0));var i=e.SymbolCompToViewMatrix[0],o=e.SymbolCompToViewMatrix[1],r=e.SymbolCompToViewMatrix[2],s=e.SymbolCompToViewMatrix[3];0===i&&0===r&&0===o&&0===s&&(i=1,s=1);var u=[i,r,0,o,s,0,0,0,1];n.setRotation(u);var c=_.get(e.ID);c&&(c.setMatrix(n),t.addChild(c))}),n()},O=async function(e,t,n){for(let i of t){await z(e,i[0],i[1]);return i[2]?(_.set(i[0].ID,i[2]),i[2].addChild(i[1])):_.set(i[0].ID,i[1]),void n()}},U=function(e,t,n){let i=Math.ceil(t.length/10);for(let a=0;a<10;a++){var o=t.slice(i*a,i*(a+1));O(e,o,n)}},E=function(e,t,n){var i=0;e||(console.log("No data to exploit"),n()),e.forEach(function(n){var o,a,r=n.resourceid,s=n.mapPhysicalID;if(n.matches&&(s=n.matches[0].sr_id),r){var u=M.get(s);if(u||(u=M.get("ContextualLink")),u){var c=u.AttributeName,l=u.ResultString;if(l){var h={};for(let e=0;e<l.length;e++){var p=c[e];n[p]&&(h[p]=[],h[p].push(n[p]))}(o=h,a={},new Promise(function(e){require(["DS/FedDictionaryAccess/FedDictionaryAccessAPI"],function(t){t.getNlsOfPropertiesValues(JSON.stringify(o),{tenantId:d(),lang:D(),onComplete:function(t){e(a=t)},onFailure:function(){e(a)}})})})).then(function(n){if(n&&0!=n.length){var o=0;for(let e=0;e<l.length;e++){var a=c[e],r=l[e],d=h[a];if(d){var D=n[a][d];if(r!=D)if(o=1,u.Modified[e]="TRUE","modified"===a||"originated"===a){var p=f.parseDate(D);u.ResultString[e]=p}else u.ResultString[e]=D}}1===o&&M.set(s,u),++i===e.length&&t()}})}}else i++}else i++}),i===e.length&&t()},j=function(e,t,n,i){var o={},a={queryPhysicalID:t,mapPhysicalID:n,data:e,ioPointedObj:o,onSuccess:function(){l.consolePrint("ExtractInfosFromQuery ExtractInfos Ok"),i(o)},onFailure:function(e){l.consolePrint(e+"ExtractInfosFromQueryFailed to ExtractInfos")}};f.ExtractInfos(a)},W=function(e,t){var n={},i={queryPhysicalID:T,data:e,ioPointedObj:n,onSuccess:function(){l.consolePrint("ExtractInfosFromQueryEA ExtractEAInfos Ok"),t(n)},onFailure:function(e){l.consolePrint(e)}};f.ExtractEAInfos(i)},k=function(e,t,n,i,o){t.length>0&&e?function(e,t,n,i){var o="QueryTextToDisplayWithSRId";e||(console.log(o+" Please provide view stream ID"),i()),t||(console.log(o+" Please provide text relation ID"),i());var a=t.length;let s=[];for(var u=0;a--;){var c=t[a];if("undefined"!=c){var l=M.get(c);if(l){var f={difViewStreamId:e,textsSRId:c,textsAttr:l.AttributeName[0],serverUrl:p,securityContext:v,onComplete:function(e){s.push(e),s.length+u===t.length&&n(s)},onFailure:function(e){console.log(e+o+"Failed to retrieve query from SR ID"),u++,s.length+u===t.length&&n(s)}};r.getPointedObjects(f)}}else u++,s.length+u===t.length&&n(s)}}(e,t,function(e){i(e)},function(){console.log("manageTextToDisplay Failed to retrieve query with SR ID"),o()}):n.length>0&&function(e,t,n){var i="QueryTextToDisplayWithPointedID";e||(console.log(i+"Please provide text relation ID"),n());var o=e.length,a=0;let s=[];for(;o--;){var u=e[o],c=0,l=u;if("ContextualLink"===l?l=T:"ContextualLinkEA"===l&&(l=T,c=1),void 0!==l){var f=M.get(u);if(f||(f=M.get(l)),f&&0===c){var d={objectPhysicalid:l,textsAttr:f.AttributeName,serverUrl:p,mappingPLMRefId:u,securityContext:v,onComplete:function(n,i,o){j(n,i,o,function(e){s.push(e)}),s.length+a===e.length&&(a=0,t(s))},onFailure:function(n){console.log(n+i+" Failed to retrieve query with pointed ID"),a++,s.length+a===e.length&&(a=0,t(s))}};r.expandPointedObject(d)}else f&&1===c?(d={objectPhysicalid:l,serverUrl:p,securityContext:v,onComplete:function(n){W(n,function(e){s.push(e)}),s.length+a===e.length&&(a=0,t(s))},onFailure:function(n){consolePrint(n+i+" Failed to retrieve query with pointed ID"),a++,s.length+a===e.length&&(a=0,t(s))}},r.getExtendedAttributes(d)):(console.log(i+"no tabResult"),a++,s.length+a===e.length&&t(s))}else a++,s.length+a===e.length&&t(s)}}(n,function(e){i(e)},function(){console.log("manageTextToDisplay Failed to retrieve query with pointed ID"),o()})},B=function(e,t,n,o,r,s,u,c){var d=0;k(n,r,s,function(n){E(n,function(){!function(e,t,n){let o=[];t.ObjectList&&t.ObjectList.forEach(function(e){if("AnnWithLink"===e.Type){var n={textWithLink:e,ioMapDifObjStreamToLoadedNode:_,ioMapAttName:A,ioMapResultString:M,ioAllSymbolInfos:o,onSuccess:function(){var n=P.get(t.ID);n&&n.TextLoaded.push(e.ID),l.consolePrint("loadTextToDisplay loadAnnWithLink Ok")},onFailure:function(e){l.consolePrint(e)}};f.loadAnnWithLink(n)}else if("AnnTableWithLink"===e.Type){e.ObjectList.forEach(function(n){if("AnnWithLink"===n.Type){var i={textWithLink:n,ioMapDifObjStreamToLoadedNode:_,ioMapAttName:A,ioMapResultString:M,ioAllSymbolInfos:o,onSuccess:function(){var n=P.get(t.ID);n&&n.TextLoaded.push(e.ID),l.consolePrint("loadTextToDisplay loadAnnWithLink Ok")},onFailure:function(e){l.consolePrint(e)}};f.loadAnnWithLink(i)}});var a=new i;o.push([e,a]);var r=P.get(t.ID);r&&r.TableLoaded.push(e.ID)}}),0===o.length&&n(),U(e,o,n)}(e,t,function(){var e=P.get(t.ID),n=0;e&&(n=e.TableLoaded.length,d=e.TextLoaded.length+n),n?o===d?function(e,t,n){t.ObjectList&&(t.ObjectList.forEach(function(e){if("AnnTableWithLink"===e.Type){var t=_.get(e.ID);t&&(e.ObjectList.forEach(function(e){var n=_.get(e.ID);if(n){var i=new a.Matrix4;i.setPosition(new a.Vector3(e.XposInTable,e.YposInTable,0)),n.setMatrix(i),t.addChild(n)}}),n())}}),0===P.get(t.ID).TableLoaded.length&&n())}(0,t,u):o<d&&u():o<=d&&u()})},function e(){console.log("loadViewTexts Failed in exploitTextToDisplay"),e()})},function(){console.log("loadViewTexts Failed in manageTextToDisplay"),c()})},G=async function(e,t,n){for(let i of t){await z(e,i[0],i[1]);n()}},z=function(e,t,n){return new Promise(i=>{if(!t.cgr)return i();var r=t.cgr,s=e.find(r),u=new zip.BlobWriter,c=new a.Matrix4;c.setPosition(new a.Vector3(0,0,0));c.setRotation([1,0,0,0,1,0,0,0,1]),n.setMatrix(c);var l=new o;l.setFileType("cgr"),l.setUDLMode(!0),l.set2DAccuracy(y),l.set3DAccuracy(F),1==w&&l.setSceneGraphOrderMode(1),1==m&&l.setLineTypes(h),l.setOnLoadedCallback(function(){i()}),s.getData(u,function(e){var t=new FileReader;t.onload=function(){let e={mode2D:!0};l.loadModelFromBuffer(this.result,n,e)},t.readAsArrayBuffer(e)});var f=t.cgr_texts;if(""!==f&&void 0!==f){var d=e.find(f),D=new zip.BlobWriter;d.getData(D,function(e){var t=new FileReader;t.onload=function(){let e={mode2D:!0};l.loadModelFromBuffer(this.result,n,e)},t.readAsArrayBuffer(e)})}})};this.getNumberOfSheets=function(){return t.length},this.getSheetName=function(e){return n=g.get(e),t[n].Name;var n},this.getLoadedSheetsId=function(){return S},this.getSheetBackgroundColor=function(e){return n=g.get(e),t[n].IsDetail?(i=c.SheetColorDetail[0],o=c.SheetColorDetail[1],r=c.SheetColorDetail[2]):(i=c.SheetColorView[0],o=c.SheetColorView[1],r=c.SheetColorView[2]),(new a.Color).setRGB(i/255,o/255,r/255);var n,i,o,r},this.loadSheetInViewer=function(e){!function(e,n,o,a){if(null===c)return console.log("No drawing loaded"),void a();if(e<0||e>=t.length)return console.log("Sheet number out of range"),void a();var r=I.get(e);if(r)return n.addNode(r),void o();var l=new i,f=l.createOverrideSetManager(),d=f.createSceneGraphOverrideSet();f.pushSceneGraphOverrideSet(d);var D=d.createOverride(new u([l])),h=new s({combineRenderMode:"IGNORE"});h.setFaceMode("MATERIAL"),D.setRenderStyle(h,!0),n.addNode(l),N(e,l,function(){o()}),I.size>=L&&(I.delete(b[0]),b.splice(0,1)),b.push(e),I.set(e,l),o()}(g.get(e.sheetID),e.viewer,e.onComplete,e.onFailure)},this.getSheet3DNode=function(e){!function(e,n,o,a){if(null===c)return console.log("No drawing loaded"),void a();if(e<0||e>=t.length)return console.log("Sheet number out of range"),void a();var r=I.get(e);if(r)return n(r),void o();var l=t[e].Views.length,f=new i,d=f.createOverrideSetManager(),D=d.createSceneGraphOverrideSet();d.pushSceneGraphOverrideSet(D);var h=D.createOverride(new u([f])),p=new s({combineRenderMode:"IGNORE"});p.setFaceMode("MATERIAL"),h.setRenderStyle(p,!0),n(f);var v=!1;N(e,f,function(){var n=x.get(t[e].ID);l!==n.viewLoaded.length||v||(v=!0,o())}),I.size>=L&&(I.delete(b[0]),b.splice(0,1)),b.push(e),I.set(e,f)}(g.get(e.sheetID),e.onSheetNodeCreated,e.onSheetLoaded,e.onFailure)},this.getSheetSize=function(e){return{height:t[g.get(e)].Height,width:t[g.get(e)].Width}},this.setMaxSheetInCache=function(e){L=e},this.isDetailSheet=function(e){return t[g.get(e)].IsDetail},this.is3DObject=function(){return!1},this.getSheetThumbnail=function(n){return function(n,i,o){if(null===c)return console.log("No drawing loaded"),void o();if(n<0||n>=t.length)return console.log("Sheet number out of range"),void o();if(!t[n].Thumbnail)return console.log("No sheet thumbnail available"),void o();var a=t[n].Thumbnail;if(a){var r=e.find(a);r?r.getBlob("image/PNG",function(e){var t=window.URL.createObjectURL(e);i(t)}):o()}else o()}(g.get(n.sheetID),n.onComplete,n.onFailure)},this.setSheetPickingByView=function(e){var t=I.get(g.get(e.sheetID));null!==t&&t.children.forEach(function(t){t.traverse(function(n){t!=n&&n.setPickParent(e.pickingByView)},{},!1)})},this.set2DAccuracy=function(e){y=e},this.set3DAccuracy=function(e){F=e},this.clearLoader=function(){e&&(e.closeZipReader(),e=null),null,t=null,g=null,I=null,S=null,b=null,null,c=null,w=null,h=null,m=null,L=null,y=null,F=null,p=null,v=null},this.loadModel=function(i){p=i.serverUrl,v=i.securityContext,T=i.objectPhysicalid,(e=new n.fs.FS).importHttpContent(i.UDLObjURL,!1,function(){var n=e.find("DrwStructure.json");null!==n?n.getText(function(n){var o=JSON.parse(n.target.result);o.Drawing&&o.Drawing.Sheets&&o.Drawing.Sheets.forEach(function(e){if(e.Views){const t=[];for(const n of e.Views){let e=n.ID,i=!1;for(const n of t)if(n==e){i=!0;break}i&&(n.ID=n.cgr.substring(0,n.cgr.length-4)+"_"+n.Name),t.push(n.ID)}}}),w=o.DrawOrderMode,c=o.Drawing,function(t,n){if(-1==m){var i=c.LineTypeFile;if(i){var o=e.find(i);o?o.getText(function(e){h=JSON.parse(e.target.result),m=1,t()}):(m=0,t())}else m=0,t()}}(function(){t=c.Sheets,S=[],g.clear(),I.clear(),function(){var e=[],n=[],i=0;return t.forEach(function(t){t.IsDetail?n.push(i):e.push(i),i++}),n.forEach(function(t){e.push(t)}),e}().forEach(function(e){var n=t[e].ID;g.set(n,e),S.push(n)});var e={currentSheetID:t[c.CurrentSheetIndex-1].ID,sheetIDList:S};i.onComplete(e)})}):i.onFailure()},function(){console.log("UDL - ZIP open fails"),i.onFailure()})}}})}),define("DS/DibUDLWebLoader/Filter2DLUDLWebLoader",["DS/Visualization/Node3D","DS/DibUDLWebLoader/LinkUDLWebLoader","DS/DibUDLWebLoader/TraceUDLWebLoader"],function(e,t,n){"use strict";return{create_Filter2DL_FromJson:function(e){return function(e){var i="create_Filter2DL_FromJson_Internal",o=e.iJson;o||e.onFailure(i+" no iJson");var a=e.iomap_ID_Node;a||e.onFailure(i+" no iomap_ID_Node");var r=e.iomap_ID_Obj;r||e.onFailure(i+" no iomap_ID_Obj");var s=e.iObj_Father;s||e.onFailure(i+" no iObj_Father");var u=o.Type;"Filter2DL"!==u&&e.onFailure(i+"object not of good type");var c=o.PLM_ID,l=r.get(c);l&&e.onFailure(i+"object already created "+c);var f;(l={}).iD=c,l.type=u,r.set(c,l),n.consolePrint(i+"created "+c),s.filter2DLs||(s.filter2DLs=[]);s.filter2DLs.push(l),l.father=s,l.filterMode=o.FilterMode,o.LINKS?f=o.LINKS:o.Links&&(f=o.Links);var d=o.FilterInfos;d&&(l.infos=[],d.forEach(function(e){var t={};t.activateModeColor=e.ActivateModeColor,t.red=e.Red,t.green=e.Green,t.blue=e.Blue,t.visible=e.Visible,t.pick=e.Pick,t.normalintensity=e.Normal_Intensity,t.activateModeTransparency=e.ActivateModeTransparency,t.transparency=e.Transparency,l.infos.push(t)})),f&&f.forEach(function(o){var s={iJson:o,iObj_Father:l,iomap_ID_Node:a,iomap_ID_Obj:r,onSuccess:function(){n.consolePrint(i+" Ok")},onFailure:function(t){n.consolePrint(t),e.onFailure()}};t.create_Link_FromJson(s)}),e.onSuccess()}(e)}}}),define("DS/DibUDLWebLoader/DifAnnotationSetUDLWebLoader",["UWA/Core","UWA/Class","DS/ZipJS/zip-fs","DS/Visualization/Node3D","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/DibWebUtils/DibQueryToolbox","DS/DibUDLWebLoader/DifCaptureUDLWebLoader","DS/DibUDLWebLoader/MBDViewUDLWebLoader","DS/DibUDLWebLoader/Filter2DLUDLWebLoader","DS/DibUDLWebLoader/TraceUDLWebLoader","DS/DibUDLWebLoader/CGR_UDLWebLoader"],function(e,t,n,i,o,a,r,s,u,c,l,f){"use strict";return t.extend({init:function(){var t,d,D,h,p,v,g=[],I=new Map,S=new Map,b=new Map,w=new Map,m=new Map,L=new Map,y=[],F=0,_=0,M=0,A=[],C=[],T=0,x=function(t,n,r){t.results||r();var s=t.results.length,u=0,c=!1;t.results.forEach(function(t){if(e.is(t.attributes,"array")){var r,l=!1;if(t.attributes.forEach(function(e){if("resourceid"===e.name&&(r=e.value),"cgr"===e.name){c=!0,l=!0;var t={Type:"SG"};t.iD=r;var f=new i;t.Node=f,function(e,t,n){var i=new a.Matrix4;i.setPosition(new a.Vector3(0,0,0));i.setRotation([1,0,0,0,1,0,0,0,1]),t.setMatrix(i);var r=new o;r.setFileType("cgr"),r.set2DAccuracy(F),r.set3DAccuracy(_),1===M&&r.setSceneGraphOrderMode(1),r.setOnLoadedCallback(function(){n(t)});var s={provider:"FILE",filename:e,serverurl:"",proxyurl:"none",requiredAuth:null};r.loadModel(s,t)}(e.value,f,function(e){b.set(t.iD,f),++u===s&&n()})}}),!l){var f={Type:"SG"};f.iD=r;var d=new i;f.Node=d,b.set(f.iD,d)}}}),c||(n(),r())},P=function(e,n,i){e||i();var o=I.get(e);o||i();var a=[];o.SupGeos.forEach(function(e){if(e.SupGeoRef&&e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef){var t=e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef.iD;a.includes(t)||0!==e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef.other||a.push(t)}}),o.MBDViews.forEach(function(e){e.view.SupGeos.forEach(function(e){if(e.SupGeoRef&&e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef){var t=e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef.iD;a.includes(t)||0!==e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef.other||a.push(t)}})}),o.Captures.forEach(function(e){e.capture.SupGeos.forEach(function(e){if(e.SupGeoRef&&e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef){var t=e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef.iD;a.includes(t)||0!==e.SupGeoRef.Dif3DShapeInst.Dif3DShapeRepRef.other||a.push(t)}})}),a.length>0?function(e,n,i){var o={objectPhysicalid:e,serverUrl:t,securityContext:d,onComplete:n,onFailure:i};r.getSupplementalGeometryData(o)}(a,function(e){x(e,function(){n()},function(){i()})},function(){i()}):n()},V=function(e,t,n){e||n();var i=w.get(e);(i||n(),i.viewStream)&&function(e,t,n){e||n();var i=w.get(e);if(i||n(),0===i.udl){var o=i.iD;t.includes(o)||t.push(o)}}(i.viewStream.iD,t,n)},N=function(e,t,n){e||n();var i=w.get(e);(i||n(),i.view)&&function(e,t,n){e||n();var i=w.get(e);if(i||n(),i.viewStreamInstance){var o=i.viewStreamInstance.iD;V(o,t,n)}}(i.view.iD,t,n)},R=function(e,t,n){e||n();var i=w.get(e);(i||n(),i.capture)&&function(e,t,n){e||n();var i=w.get(e);if(i||n(),i.viewStreamInstance){var o=i.viewStreamInstance.iD;V(o,t,n)}}(i.capture.iD,t,n)},O=function(e,t,n){e||n(),I.get(e)||n();var i=[];!function(e,t,n){e||n();var i=w.get(e);i||n(),i.MBDViews&&i.MBDViews.forEach(function(e){var i=e.iD;N(i,t,n)}),i.Captures&&i.Captures.forEach(function(e){var i=e.iD;R(i,t,n)})}(e,i,n),t(i)},U=function(i,o,a){i||a(),O(i,function(i){!function(e,n,i){var o={objectPhysicalid:e,serverUrl:t,securityContext:d,onComplete:n,onFailure:i};r.getUDLData(o)}(i,function(t){!function(t,i,o){t.results||o();var a=t.results.length,r=0,s=!1;t.results.forEach(function(t){var u;e.is(t.attributes,"array")&&(t.attributes.forEach(function(e){if("resourceid"===e.name&&(u=e.value),"udl"===e.name){s=!0;var t=new n.fs.FS,c={provider:"FILE",filename:e.value,serverurl:"",proxyurl:"none",requiredAuth:null};t.importHttpContent(c,!1,function(){var e=t.find("DrwStructure.json");null!==e?e.getText(function(e){var n=JSON.parse(e.target.result);M=n.DrawOrderMode;var o=w.get(u);if(o){o.udl=1;var s=o.father.father;s.flagjson=1,s.udljson=n.View,s.udlzip=t}a===++r&&i()}):o()},function(){o()})}}),s||o())})}(t,function(){o()},function(){a()})},function(){a()})},function(){a()})},E=function(e,t,n){e||n();var i=w.get(e);(i||n(),i.view)&&function(e,t,n){e||n();var i=w.get(e);if(i||n(),1===i.flagjson){var o=i.iD;t.includes(o)||t.push(o)}}(i.view.iD,t,n)},j=function(e,t,n){e||n();var i=w.get(e);(i||n(),i.capture)&&function(e,t,n){e||n();var i=w.get(e);if(i||n(),1===i.flagjson){var o=i.iD;t.includes(o)||t.push(o)}}(i.capture.iD,t,n)},W=function(e,t,n){e||n(),I.get(e)||n();var i=[];!function(e,t,n){e||n();var i=w.get(e);i||n(),i.MBDViews&&i.MBDViews.forEach(function(e){var i=e.iD;E(i,t,n)}),i.Captures&&i.Captures.forEach(function(e){var i=e.iD;j(i,t,n)})}(e,i,n),t(i)},k=function(e,t,n,i){if(e||i(),t||i(),n||i(),e.cgr){var o={flagcgr:0};o.udlzip=n,t.infocgr=o,t.infocgr.cgr=e.cgr,e.cgr_texts&&(t.infocgr.cgr_texts=e.cgr_texts),e.cgr_textsGP&&(t.infocgr.cgr_textsGP=e.cgr_textsGP)}},B=function(e,t,n){var i=" createObjectFromJson : ";t||n();var o=e.Type;if("SupportPlane"===o)!function(e,t,n){t||n();var i=e.Type;"SupportPlane"!==i&&n();var o=e.PLM_ID,a=w.get(o);a&&n();(a={}).iD=o,a.type=i,w.set(o,a),t.supportPlanes||(t.supportPlanes=[]);t.supportPlanes.push(a),e.Plane&&(a.plane=e.Plane)}(e,t,n);else if("TPSTest"===o||"TPS"===o)!function(e,t,n){t||n();var i=e.Type;"TPSTest"!==i&&"TPS"!==i&&n();var o=e.ID,a=w.get(o);a&&n();(a={}).iD=o,a.type=i,a.father=t,w.set(o,a),t.tpsTexts||(t.tpsTexts=[]);t.tpsTexts.push(a),e.Plane&&(a.plane=e.Plane),k(e,a,t.udlzip,n)}(e,t,n);else if("PresentedAnnotations"===o)!function(e,t,n){t||n();var i,o=e.Type;"PresentedAnnotations"!==o&&n(),i=e.Plane?e.PLM_ID:e.PLM_ID+"A";var a=w.get(i);a&&n();(a={}).iD=i,a.type=o,w.set(i,a),t.presentedAnnotations||(t.presentedAnnotations=[]);t.presentedAnnotations.push(a),e.Plane?a.PlaneID=e.Plane:a.PlaneID=e.ID}(e,t,n);else if("Filter2DL"===o){var a={iJson:e,iObj_Father:t,iomap_ID_Node:b,iomap_ID_Obj:w,onSuccess:function(){l.consolePrint(i+" 2DLFilters Ok")},onFailure:function(e){l.consolePrint(e),n()}};c.create_Filter2DL_FromJson(a)}},G=function(e,t,n){e.forEach(function(e){!function(e,t,n){var i=w.get(e);if(i||n(),1===i.flagjson){var o=i.udljson;o.ObjectList&&o.ObjectList.forEach(function(e){B(e,i,n)}),i.flagjson=2,i.viewStreamInstance&&i.viewStreamInstance.viewStream&&k(o,i.viewStreamInstance.viewStream,i.udlzip,n)}t()}(e,function(){0},function(){0,n()})}),t()},z=function(e,t,n){e||n();var i=w.get(e);if(i||n(),i.viewStreamInstance||n(),i.viewStreamInstance.viewStream||n(),i.viewStreamInstance.viewStream.infocgr&&i.viewStreamInstance.viewStream.infocgr.flagcgr&&0===i.viewStreamInstance.viewStream.infocgr.flagcgr){var o=i.viewStreamInstance.viewStream.iD;t.includes(o)||t.push(o)}i.tpsTexts&&i.tpsTexts.forEach(function(e){!function(e,t,n){e||n();var i=w.get(e);if(i||n(),0===i.infocgr.flagcgr){var o=i.iD;t.includes(o)||t.push(o)}}(e.iD,t,n)})},q=function(e,t,n){e||n();var i=w.get(e);(i||n(),i.capture)&&function(e,t,n){e||n();var i=w.get(e);if(i||n(),i.viewStreamInstance||n(),i.viewStreamInstance.viewStream||n(),i.viewStreamInstance.viewStream.infocgr&&i.viewStreamInstance.viewStream.infocgr.flagcgr&&0===i.viewStreamInstance.viewStream.infocgr.flagcgr){var o=i.viewStreamInstance.viewStream.iD;t.includes(o)||t.push(o)}}(i.capture.iD,t,n)},J=function(e,t,n){e||n();var i=w.get(e);i||n(),i.MBDViews&&i.MBDViews.forEach(function(e){!function(e,t,n){e||n();var i=w.get(e);if(i||n(),i.view){var o=i.view.iD;z(o,t,n)}}(e.iD,t,n)}),i.Captures&&i.Captures.forEach(function(e){var i=e.iD;q(i,t,n)})},Q=function(e,t){return new Promise(n=>{e||t(),0!==e.flagcgr&&t();var o=new i;e.cgrNode=o;var a={zipUDL:e.udlzip,cgrName:e.cgr,cgrNameText:e.cgr_texts,CGRNode:o,Accuracy2D:F,Accuracy3D:_,DrawOrderMode:M,onSuccess:n,onFailure:t};f.loadCGRs(a)})},H=async function(e,t,n){for(let i of e)await Q(i.infocgr,n).then(()=>{var e=i.iD,n=i.infocgr.cgrNode;b.set(e,n),i.infocgr.flagcgr=1,t()})},X=function(e,t,n){e||n();var i=e.length,o=0;0===i&&t();var a=[];e.forEach(function(e){var t=w.get(e);t||n(),a.push(t)}),function(e,t,n){let i=Math.ceil(e.length/10);for(let a=0;a<10;a++){var o=e.slice(i*a,i*(a+1));H(o,t,n)}}(a,function(){++o===i&&t()},function(){n()})},Y=function(e,t,n){e||n(),w.get(e)||n(),function(e,t,n){e||n(),w.get(e)||n();var i=[];J(e,i,n),t(i)}(e,function(e){X(e,function(){t()},function(){n()})},function(){n()})},Z=function(e,n,i){e||i();var o=I.get(e);o||i();var a=[];o.Captures.forEach(function(e){var t=e.capture;t&&t.filter2DLs&&t.filter2DLs.forEach(function(e){e&&e.links&&e.links.forEach(function(e){if(e.Link_ID){var n={};n.father=t,n.fatherID=t.viewStreamInstance.viewStream.iD,n.sR_ID=e.Link_ID,n.link=e,a.push(n)}})})});var s=a.length,u=0;s>0?a.forEach(function(e){!function(e,n,i){e||i();var o=e.father;o||i();var a=e.fatherID;a||i();var s=e.sR_ID;s||i();var u=o.resolvefilter2DLs;u||(o.resolvefilter2DLs=[],u=o.resolvefilter2DLs);var c={fatherID:a,role:"271",sR_ID:s,serverUrl:t,securityContext:d,onComplete:function(t){var i={};i.path=t,i.info=e.link,u.push(i),n()},onFailure:function(){i()}};r.getPointedObjectsFromLink(c)}(e,function(){++u===s&&n()},function(){i()})}):n()},K=function(e,t,n,o){e||o();var a=S.get(e);if(a)return t(a),void n();var r=I.get(e);r||o(),t(D=new i),S.size>=T&&S.delete(e),S.set(e,D),U(e,function(){!function(e,t,n){e||n(),W(e,function(e){G(e,function(){t()},function(){n()})},function(){n()})}(e,function(){Y(e,function(){P(e,function(){Z(e,function(){!function(e,t,n,i){var o=new Map,a={};a.iD=e.iD,a.Name=e.Name,a.Type="AnnotationSet",a.Childs=[];var r={};r.node3D=t,a.visuinfo=r;var c={iFather:e,iObj_Father:a,ioMap_ID_Node:b,ioMap_ID_Obj:o,onSuccess:function(){},onFailure:function(e){i()}};u.Manage_MBDView_Object(c);var l={iFather:e,iObj_Father:a,ioMap_ID_Node:b,ioMap_ID_Obj:o,onSuccess:function(){},onFailure:function(e){i()}};s.Manage_Capture_Object(l),a.Childs.forEach(function(e){"CaptureInstance"===e.Type?C.push(e):"MBDViewInstance"===e.Type&&A.push(e)}),n()}(r,D,n,o)},function(){o()})},function(){o()})},function(){o()})},function(){o()})},function(){o()})};this.getNumberOfSheets=function(){return g.length},this.getSheetName=function(e){return function(e){return I.get(e).Name}(e)},this.getLoadedSheetsId=function(){return y},this.getSheetBackgroundColor=function(e){return(new a.Color).setRGB(1,1,1)},this.getSheet3DNode=function(e){K(e.sheetID,e.onSheetNodeCreated,e.onSheetLoaded,e.onFailure)},this.getSheetSize=function(e){return{height:100,width:100}},this.setMaxSheetInCache=function(e){T=e},this.isDetailSheet=function(e){return!1},this.is3DObject=function(){return!0},this.getSheetThumbnail=function(e){e.onFailure()},this.setSheetPickingByView=function(e){var t=S.get(e.sheetID);null!==t&&t.children.forEach(function(t){t.traverse(function(n){t!=n&&n.setPickParent(e.pickingByView)},{},!1)})},this.set2DAccuracy=function(e){F=e},this.set3DAccuracy=function(e){_=e},this.loadModel=function(e){if(e||e.onFailure(),e.serverUrl&&e.securityContext){e.data||e.onFailure(),e.data.physicalid||e.onFailure(),e.data.dataType||e.onFailure(),t=e.serverUrl,d=e.securityContext;var n={objectPhysicalid:e.data.physicalid,serverUrl:t,securityContext:d,onComplete:function(t){!function(e){var t,n=new Map,i=new Map;e.results.forEach(function(e){if("resourceid"in e){var o={};for(var a in e)"bo.DIFAbstractView.V_DIF3DMatrix"===a&&"string"==typeof e[a]?o[a]=e[a].split(",").map(Number):o[a]=e[a];i.set(e.resourceid,o)}else if(e.Path){var r,s,u,c,l,f,d,D,I;e.Path.forEach(function(e){var o=e.toString(),a=i.get(o);if(a){var S=a["ds6w:type"],b=n.get(o);if("DIFAnnotationSet"===S){if(!b){var y={MBDViews:[],Captures:[],SupGeos:[]};y.Name=a["bo.PLMEntity.V_Name"],(b=y).iD=a.resourceid,b.sID=o,b.type=S,n.set(o,b),w.set(b.iD,b),g.push(b)}t=b}if(function(e){return"DIFCaptureInstance"===e}(S)){if(!b){var F={};F.Scale=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFScale"]),F.X=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFPosX"]),F.Y=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFPosY"]),F.Angle=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFAngle"]),(b=F).iD=a.resourceid,b.sID=o,b.type=S,n.set(o,b),w.set(b.iD,b)}c=b,L.get(o)||(t.Captures.push(b),L.set(o,b))}if(function(e){return"DIFCapture"===e}(S)){if(!b){var _={MBDViews:[],SupGeos:[]};_.Name=a["bo.PLMEntity.V_Name"],_.Scale=parseFloat(a["bo.DIFAbstractView.V_DIFScale"]),_.ScaleStatus=a["bo.DIFAbstractView.V_DIFScaleStatus"],_.viewtype=a["bo.DIFCapture.V_ViewType"];var M=a["bo.DIFAbstractView.V_DIF3DMatrix"],A=[];12===M.length&&M.forEach(function(e){A.push(parseFloat(e))}),_.Matrix=A,(b=_).iD=a.resourceid,b.sID=o,b.type=S,b.flagjson=0,n.set(o,b),w.set(b.iD,b)}l=b,c.capture=l}if(function(e){return"MBDViewInstance"===e}(S)){if(!b){var C={};C.Scale=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFScale"]),C.X=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFPosX"]),C.Y=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFPosY"]),C.Angle=parseFloat(a["ro.DIFAbstractViewInstance.V_DIFAngle"]),(b=C).iD=a.resourceid,b.sID=o,b.type=S,n.set(o,b),w.set(b.iD,b)}r=b,l?l.MBDViews.push(b):m.get(o)||(t.MBDViews.push(b),m.set(o,b))}if(function(e){return"MBDView"===e}(S)){if(!b){var T={SupGeos:[]};T.Name=a["bo.PLMEntity.V_Name"],T.Scale=parseFloat(a["bo.DIFAbstractView.V_DIFScale"]),T.ScaleStatus=a["bo.DIFAbstractView.V_DIFScaleStatus"],(b=T).iD=a.resourceid,b.sID=o,b.type=S,b.flagjson=0,n.set(o,b),w.set(b.iD,b)}s=b,r.view=s}if(function(e){return"DIFViewStreamInstance"===e}(S)&&(b||((b={}).iD=a.resourceid,b.sID=o,b.type=S,n.set(o,b),w.set(b.iD,b)),u=b,s?(b.father=s,s.viewStreamInstance=b):l&&(b.father=l,l.viewStreamInstance=b)),function(e){return"DIFViewStream"===e}(S)&&(b||((b={}).iD=a.resourceid,b.sID=o,b.type=S,b.udl=0,n.set(o,b),w.set(b.iD,b)),b.father=u,u.viewStream=b),function(e){return"DIFSupplementalGeometryInstance"===e}(S)&&(b||((b={}).iD=a.resourceid,b.sID=o,b.type=S,n.set(o,b),w.set(b.iD,b)),f=b,l?l.SupGeos.push(b):s?s.SupGeos.push(b):t.SupGeos.push(b)),function(e){return"DIFSupplementalGeometry"===e}(S)){if(!b){var x={};x.Name=a["bo.PLMEntity.V_Name"],(b=x).iD=a.resourceid,b.sID=o,b.type=S,n.set(o,b),w.set(b.iD,b)}d=b,f&&(f.SupGeoRef=d)}if(function(e){return"DIF3DShapeInstance"===e}(S)&&(b||((b={}).iD=a.resourceid,b.sID=o,b.type=S,n.set(o,b),w.set(b.iD,b)),D=b,d&&(b.father=d,d.Dif3DShapeInst=D)),function(e){return"DIF3DShape"===e}(S)&&(b||((b={}).iD=a.resourceid,b.sID=o,b.type=S,b.other=0,n.set(o,b),w.set(b.iD,b)),I=b,D&&(b.father=D,D.Dif3DShapeRepRef=I)),function(e){return"DIFStandardRep"===e}(S)&&(h||(h={}),h.iD=a.resourceid,p&&(p.Ref=h)),function(e){return"DIFStandardRepInstance"===e}(S)&&(p||(p={}),p.iD=a.resourceid),function(e){return"DIFAnnotatedProduct"===e}(S)){var P={};P.iD=a.resourceid,v=P}}}),r=null,s=null,c=null,l=null,u=null,f=null,d=null,D=null,I=null}})}(t),y=[],g.forEach(function(e){var t=e.iD;I.set(t,e),y.push(t)});var n={sheetIDList:y};y.length>0&&(n.currentSheetID=y[0]),e.onComplete(n)},onFailure:function(){e.onFailure()}};r.expandDifComponent(n)}},this.getAnnotationSetMBDCaptures=function(e){var t;t=C,e.onSuccess(t)},this.getAnnotationSetMBDViews=function(e){var t;t=A,e.onSuccess(t)},this.getAnnotationSet3DNode=function(e){D?e.onSuccess(D):e.onFailure()},this.clearLoader=function(){g&&(g=null),I&&(I=null),S&&(S=null),w&&(w=null),m&&(m=null),L&&(L=null),y&&(y=null),t&&(t=null),d&&(d=null),F&&(F=null),M&&(M=null),_&&(_=null),A&&(A=null),C&&(C=null),D&&(D=null),h&&(h=null),p&&(p=null),v&&(v=null),T&&(T=null)}}})}),define("DS/DibUDLWebLoader/CATDibUDLWebLoaderForAnnotationSet",["UWA/Class","DS/DibUDLWebLoader/DifAnnotationSetUDLWebLoader","DS/DibWebUtils/DibQueryToolbox"],function(e,t,n){"use strict";return e.extend({init:function(){var e;this.getAnnotationSetIDAssociatedToProductIDInternal=function(e){if(e)if(e.serverUrl)if(e.securityContext)if(e.physicalid){var t=[],i={objectPhysicalid:e.physicalid,serverUrl:e.serverUrl,securityContext:e.securityContext,onComplete:function(n){Array.isArray(n)?n.forEach(function(e){t.push(e.physicalid)}):n?t.push(n.physicalid):console.log("CATDibUDLWebLoaderForAnnotationSet: No AnnotationSet"),e.onComplete(t)},onFailure:function(){e.onFailure()}};n.getDIFAnnotatedProduct(i)}else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing physicalid argument");else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing securityContext argument");else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing serverUrl argument");else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing argument")},this.getProductIDAssociatedToAnnotationSetInternal=function(e){if(e)if(e.serverUrl)if(e.securityContext)if(e.physicalid){var t={objectPhysicalid:e.physicalid,serverUrl:e.serverUrl,securityContext:e.securityContext,onComplete:function(t){var n;if(Array.isArray(t)){var i=t[0];i?n=i.physicalid:console.log("CATDibUDLWebLoaderForAnnotationSet: No Product")}else t?n=t.physicalid:console.log("CATDibUDLWebLoaderForAnnotationSet: No Product");e.onComplete(n)},onFailure:function(){e.onFailure()}};n.getProductFromDifAnnotationSet(t)}else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing physicalid argument");else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing securityContext argument");else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing serverUrl argument");else console.log("CATDibUDLWebLoaderForAnnotationSet: Missing argument")},this.loadModelInternal=function(n){if(n)if(n.serverUrl)if(n.securityContext)if(n.data)if(n.data.physicalid)if(n.data.dataType){if("DIFAnnotationSet"===n.data.dataType){e=new t;var i={data:n.data,serverUrl:n.serverUrl,securityContext:n.securityContext,onComplete:function(t){var i={sheetID:t.currentSheetID,onSheetNodeCreated:function(e){e||(console.log("No sheet node"),n.onFailure())},onSheetLoaded:function(){n.onComplete(t)},onFailure:function(){console.log("Failed getting All AnnotationSet nodes")}};e.getSheet3DNode(i)},onFailure:function(){console.log("CATDibUDLWebLoaderForAnnotationSet: load Failed"),n.onFailure()}};e.loadModel(i)}e||(console.log("CATDibUDLWebLoaderForAnnotationSet: Input Data type not supported"),n.onFailure())}else console.log("CATDibUDLWebLoaderForAnnotationSet: Bad argurment");else console.log("CATDibUDLWebLoaderForAnnotationSet: Bad argurment");else console.log("CATDibUDLWebLoaderForAnnotationSet: Bad argurment");else console.log("CATDibUDLWebLoaderForAnnotationSet: Bad argurment");else console.log("CATDibUDLWebLoaderForAnnotationSet: Bad argurment");else console.log("CATDibUDLWebLoaderForAnnotationSet: Bad argurment")},this.getAnnotationSetIDAssociatedToProductID=function(e){this.getAnnotationSetIDAssociatedToProductIDInternal(e)},this.getProductIDAssociatedToAnnotationSet=function(e){this.getProductIDAssociatedToAnnotationSetInternal(e)},this.getAnnotationSet3DNode=function(t){e?e.getAnnotationSet3DNode(t):t.onFailure()},this.getAnnotationSetMBDCaptures=function(t){e?e.getAnnotationSetMBDCaptures(t):t.onFailure()},this.getAnnotationSetMBDViews=function(t){e?e.getAnnotationSetMBDViews(t):t.onFailure()},this.loadModel=function(e){this.loadModelInternal(e)}}})}),define("DS/DibUDLWebLoader/CATDibUDLWebLoader",["UWA/Core","UWA/Class","DS/DibUDLWebLoader/DraftingUDLWebLoader","DS/DibUDLWebLoader/DifUDLWebLoader","DS/DibUDLWebLoader/DifAnnotationSetUDLWebLoader","DS/DibWebUtils/DibQueryToolbox"],function(e,t,n,i,o,a){"use strict";return t.extend({init:function(){var e,t=1,r=0,s=0;this.loadDrawingModel=function(t){e&&(e.clearLoader(),e=null),(e=new n).set2DAccuracy(r),e.set3DAccuracy(s);var i={objectPhysicalid:[t.data.physicalid],serverUrl:t.serverUrl,securityContext:t.securityContext,onComplete:function(n){var i;n.results[0].attributes.forEach(function(e){"udl"===e.name&&(i=e.value)});var o={UDLObjURL:{provider:"FILE",filename:i,serverurl:"",proxyurl:"none",requiredAuth:null},serverUrl:t.serverUrl,securityContext:t.securityContext,objectPhysicalid:t.data.physicalid,onComplete:t.onComplete,onFailure:t.onFailure};e.loadModel(o)},onFailure:function(){console.log("CATDibUDLWebLoader: Failed to fetch UDL"),t.onFailure()}};a.getUDLData(i)},this.loadDifSheetModel=function(t){e&&(e.clearLoader(),e=null),(e=new i).set2DAccuracy(r),e.set3DAccuracy(s);var n={data:t.data,serverUrl:t.serverUrl,contextViewer:t.contextViewer,securityContext:t.securityContext,onComplete:t.onComplete,onFailure:t.onFailure};e.loadModel(n)},this.loadDifAnnotationSetModel=function(t){e&&(e.clearLoader(),e=null),(e=new o).set2DAccuracy(r),e.set3DAccuracy(s);var n={data:t.data,serverUrl:t.serverUrl,securityContext:t.securityContext,onComplete:function(n){var i={sheetID:n.currentSheetID,onSheetNodeCreated:function(e){e||(console.log("Fail onSheetNodeCreated"),t.onFailure())},onSheetLoaded:function(){t.onComplete(n)},onFailure:function(){console.log("Failed getting All AnnotationSet nodes")}};e.getSheet3DNode(i)},onFailure:function(){console.log("CATDibUDLWebLoader: loadDifAnnotationSetModel"),t.onFailure()}};e.loadModel(n)},this.loadDifAnnotationSetModelFromProduct=function(e){var t={objectPhysicalid:e.data.physicalid,serverUrl:e.serverUrl,securityContext:e.securityContext,onComplete:function(t){var n="DIFAnnotationSet",i=t[0].physicalid;e.data.dataType=n,i&&(e.data.physicalid=i),loadDifAnnotationSetModel(e)},onFailure:function(){console.log("CATDibUDLWebLoader: loadDifAnnotationSetModelFromProduct"),e.onFailure}};a.getDIFAnnotatedProduct(t)},this.getNumberOfSheets=function(){return e.getNumberOfSheets()},this.getSheetName=function(t){return e.getSheetName(t)},this.getLoadedSheetsId=function(){return e.getLoadedSheetsId()},this.getSheetBackgroundColor=function(t){return e.getSheetBackgroundColor(t)},this.getSheet3DNode=function(t){e.getSheet3DNode(t)},this.setDisplaySheet=function(t){e.setDisplaySheet(t)},this.getSheetSize=function(t){return e.getSheetSize(t)},this.setMaxSheetInCache=function(n){t=n,e&&e.setMaxSheetInCache(n)},this.isDetailSheet=function(t){return e.isDetailSheet(t)},this.getSheetThumbnail=function(t){return e.getSheetThumbnail(t)},this.setSheetPickingByView=function(t){return e.setSheetPickingByView(t)},this.set2DAccuracy=function(e){r=e},this.get2DAccuracy=function(){return r},this.set3DAccuracy=function(e){s=e},this.get3DAccuracy=function(){return s},this.getAnnotationSetMBDViews=function(t){e?e.getAnnotationSetMBDViews(t):t.onFailure()},this.getAnnotationSetMBDCaptures=function(t){e?e.getAnnotationSetMBDCaptures(t):t.onFailure()},this.loadModel=function(n){n&&n.serverUrl&&n.securityContext&&n.data&&n.data.physicalid&&n.data.dataType?(console.log("Please provide symbols relation ID"),"Drawing"===n.data.dataType?this.loadDrawingModel(n):"DIFSheet"===n.data.dataType||"DIFLayout"===n.data.dataType||"DIFView"===n.data.dataType?this.loadDifSheetModel(n):"DIFAnnotationSet"===n.data.dataType||"DIFMBDView"===n.data.dataType?this.loadDifAnnotationSetModel(n):"VPMReference"===n.data.dataType&&this.loadDifAnnotationSetModelFromProduct(n),e||(console.log("CATDibUDLWebLoader: Input Data type not supported"),n.onFailure()),e.setMaxSheetInCache(t)):console.log("CATDibUDLWebLoader: Bad argurment")},this.is3DObject=function(){return e.is3DObject()},this.clearLoader=function(){t=null,e&&(e.clearLoader(),e=null),r=null,s=null}}})});