define("DS/ENOSpecManagementApp/control/XSpecsControl",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/PlatformAPI/PlatformAPI","DS/ENOSpecManagementApp/view/WrapperView","DS/ENOSpecManagementApp/control/XSpecsBase","DS/CreateSpecification/control/CreateSpec","DS/CreateSpecification/control/XSRNewProductCmdController","DS/XSRCommonComponents/utils/Constants","DS/SpecViewer/commands/OpenSpecificationView","DS/XSRCommonComponents/utils/XSRMask","DS/Windows/ImmersiveFrame","DS/XSRCommonComponents/utils/Utils","DS/XSRCommonComponents/service/SpecSearchService","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/RequestUtil","DS/ENOSpecManagementApp/control/ViewerNavigation","DS/SpecRawMaterial/control/NewRawMaterial","DS/ENOFormulatedProduct/control/NewFormulatedProduct","i18n!DS/ENOSpecManagementApp/assets/nls/ENOSpecManagementApp"],function(e,t,r,n,i,a,o,s,c,p,l,d,E,u,h,C,S,g,f,v){"use strict";return r.extend({init:function(e){this.appCore={},this.viewWrapper={},this.appCore.basicModelEvents=this.xsrModelEvents=e.modelEvents,this.appCore.specWidgetPreferences=e.specWidgetPreferences,E.isOOTBSubtypeEnabled()?widget.hasPreference("CADAuthoring")||e.specWidgetPreferences.addCADAuthoringPreference():e.specWidgetPreferences.removePreference("CADAuthoring"),this.drawHtml();var t=this,r=(this.appCore.specMainContainer=document.querySelector("#"+c.XSPECS_CONTAINER),this.appCore.specLeftContainer=document.querySelector("#"+c.ID_SpecsPanel),this.appCore.specRightContainer=document.querySelector("#"+c.ID_SPECS_PROPERTIES)),n=this.appCore.specViewerContainer=document.querySelector("#"+c.ID_SpecsContainer),d=this.appCore.specContainer=document.querySelector("#"+c.ID_SpecViewContainer),h=this.appCore.specMiddleContainer=document.querySelector("#"+c.ID_SpecsMiddlePanel);new a(this).initialize.call(this),this.appCore.currentView=null;var N=new S(this);N.drawLayout(),this.appCore.viewerNav.pageToolbar=this.pageToolbar,n.inject(this.appCore.viewerNav.getLeft()),d.inject(this.appCore.viewerNav.getRight()),N.drawNextPreviousExpand();var R=new u({appCore:this.appCore});function m(e){var n=function(){t.appCore.specRouteManager.setActiveSpecItem(null),e.id!==c.WELCOMEPANEL_ID_CREATESPEC&&e.id!==c.WELCOMEPANEL_ID_CREATEENG&&"appInfo"!==e.id&&widget.setTitle(C.setWidgetTitle(""));var r,n={appCore:t.appCore};if(e.id===c.WELCOMEPANEL_ID_INWORK)t.pageToolbar.resetContent(),t.pageToolbar.setTitle(v.InProcessItems),R.nextStart=0,t.currentPanel=e.id,n.currentPanel=e.id,t.filter="NOT current:RELEASED AND NOT current:OBSOLETE",n.filter="NOT current:RELEASED AND NOT current:OBSOLETE",n.globalSearchQuery=e.searchString,l.maskLoader(h,v.Loading),r=R.getSpecifications(n);else if(e.id===c.WELCOMEPANEL_ID_RELEASED)t.pageToolbar.resetContent(),t.pageToolbar.setTitle(v.ReleasedItems),R.nextStart=0,t.currentPanel=e.id,n.currentPanel=e.id,t.filter="current:RELEASED",n.filter="current:RELEASED",n.globalSearchQuery=e.searchString,l.maskLoader(h,v.Loading),r=R.getSpecifications(n);else if(e.id===c.WELCOMEPANEL_ID_OBSOLETE)t.pageToolbar.resetContent(),t.pageToolbar.setTitle(v.ObsoleteItems),R.nextStart=0,t.currentPanel=e.id,n.currentPanel=e.id,t.filter="current:OBSOLETE",n.filter="current:OBSOLETE",n.globalSearchQuery=e.searchString,l.maskLoader(h,v.Loading),r=R.getSpecifications(n);else if(e.id===c.WELCOMEPANEL_ID_CREATESPEC){var a={appCore:t.appCore,createCloseAction:function(e,r){t.createSpec&&(t.appCore.specRouteManager.resetStack(),t.viewWrapper.treeDocument.unselectAll(),t._addRootNodeFromRecents(e,!0),t.xsrModelEvents.publish({event:c.SPEC_VIEW_REMOVE_PENDINGACTIONS}),t.xsrModelEvents.publish({event:c.OPEN_SPECIFICATION_VIEW,data:{itemPid:e,typeActual:r}}))},createAction:function(e){t._addRootNodeFromRecents(e,!0)}};t.createSpec=new o(a),t.createSpec.loadFields()}else if(e.id===c.WELCOMEPANEL_ID_CREATEENG){var p={appCore:t.appCore,onCreateSuccess:function(e,r){t.createEng&&(t.appCore.specRouteManager.resetStack(),t.viewWrapper.treeDocument.unselectAll(),widget.setValue("fetchmode","author"),widget.setValue("previousindexed",Math.floor(Date.now()/1e3)),t._addRootNodeFromRecents(e,!0),t.xsrModelEvents.publish({event:c.SPEC_VIEW_REMOVE_PENDINGACTIONS}),t.xsrModelEvents.publish({event:c.OPEN_SPECIFICATION_VIEW,data:{itemPid:e,typeActual:r}}))}};t.createEng=new s(p),t.createEng.execute()}else if(e.id===c.WELCOMEPANEL_ID_CREATERAWM){a={appCore:t.appCore,onCreateSuccess:function(e,r){t.createRawM&&(t.appCore.specRouteManager.resetStack(),t.viewWrapper.treeDocument.unselectAll(),t._addRootNodeFromRecents(e,!0),t.xsrModelEvents.publish({event:c.SPEC_VIEW_REMOVE_PENDINGACTIONS}),t.xsrModelEvents.publish({event:c.OPEN_SPECIFICATION_VIEW,data:{itemPid:e,typeActual:r}}))}};t.createRawM=new g(a),t.createRawM.execute()}else if(e.id===c.WELCOMEPANEL_ID_CREATEFRMLA){a={appCore:t.appCore,onCreateSuccess:function(e,r){t.appCore.specRouteManager.resetStack(),t.viewWrapper.treeDocument.unselectAll(),t._addRootNodeFromRecents(e,!0),t.xsrModelEvents.publish({event:c.SPEC_VIEW_REMOVE_PENDINGACTIONS}),t.xsrModelEvents.publish({event:c.OPEN_SPECIFICATION_VIEW,data:{itemPid:e,typeActual:r}})}};t.createForm=new f(a),t.createForm.execute()}r&&r.then(function(e){let r=e.filter(function(e){if(!e.isMEI)return e});e=r,n.data=e,l.unmaskLoader(h),t.viewWrapper?t.appCore.specRouteManager.resetStack():t.createSpec&&t.createSpec.specViewController&&null!==t.createSpec.specViewController&&(t.appCore.specRouteManager.resetStack(),t.xsrModelEvents.publish({event:c.SPEC_VIEW_REMOVE_PENDINGACTIONS}),t.createSpec.specViewController=null),"function"==typeof t.viewWrapper.destroy&&t.viewWrapper.destroy(),t.viewWrapper=new i(n),void 0!==t.pendingId&&t.viewWrapper.selectSpecification(t.pendingId,t.pendingType,t.isMEI),0==e.length&&0==t.appCore.specWidgetPreferences.userDataCount&&t.viewWrapper.renderWelcomeNote(),e.length>t.appCore.specWidgetPreferences.userDataCount&&(t.appCore.specWidgetPreferences.userDataCount+=e.length)}).catch(function(e){console.log(e),l.unmaskLoader(h),t.displayErrorNotification()})};r.hasClassName(c.PROPERTIES_FIELD_DIRTY)?t.xsrModelEvents.publish({event:c.XSR_EVENT_CHECK_RIGHT_BEFORE_CLOSE,data:{okCallBack:n}}):(r.empty(),t.triptychManager.hideRightPanel(),n())}this._reCheckPreferences(),this.xsrModelEvents.subscribe({event:c.OPEN_SPECIFICATION_VIEW},function(e){!function(e){t.appCore&&t.appCore.triptychManager&&t.appCore.triptychManager.isRightPanelVisible&&t.appCore.triptychManager.hideRightPanel();t.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_UNSELECT_ACTION}),t.viewWrapper.treeDocument&&1===t.viewWrapper.treeDocument.getSelectedNodes().length&&(t.appCore.viewerNav.currentNode=t.viewWrapper.treeDocument.getSelectedNodes());t.appCore.viewerNav.currentNodeId&&t.appCore.viewerNav.currentNodeId===e.itemPid||(t.appCore.viewerNav.currentNodeId=e.itemPid);N.render();var r={};r.openViewer=e.openViewer,r.itemPid=e.itemPid,r.typeActual=e.typeActual,r.typeName=e.typeName,r.kindOf=e.kindOf,r.appCore=t.appCore,r.isMEI=e.isMEI,new p(r).loadViewer(r)}(e)}),this.xsrModelEvents.subscribe({event:c.WELCOMEPANEL_EVENT_ActionSelected},function(e){widget.body.getSize().width<550&&t.triptychManager.hideLeftPanel(),m(e)}),this.xsrModelEvents.subscribe({event:c.WELCOME_NOTE_ICON_EVENT},function(e){m(e)}),this.xsrModelEvents.subscribe({event:c.LAUNCH_XSR_HOME_PAGE},function(e){t.pendingId=void 0,t.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_SELECT_ACTION,data:{id:c.WELCOMEPANEL_ID_INWORK}}),t.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_ActionSelected,data:{id:c.WELCOMEPANEL_ID_INWORK}}),t.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_EXPAND}),t.triptychManager.hideRightPanel()}),this.xsrModelEvents.subscribe({event:c.EVENT_REFRESH_GRIDORSPECVIEWER},function(){t.onRefreshWorkUnderView()}),this.xsrModelEvents.subscribe({event:c.WELCOMEPANEL_EVENT_EXPAND},function(){t.appCore&&t.appCore.viewerNav&&(t.appCore.viewerNav.currentNodeId=null)}),this.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_EXPAND}),this._subscribePlatformAPIEvents(),void 0!==e&&e.itemPid&&(N.render(),t.pendingId=e.itemPid,t.pendingType=e.typeActual,t.isMEI=e.isMEI),this.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_ActionSelected,data:{id:c.WELCOMEPANEL_ID_INWORK}})},drawHtml:function(){widget.body.empty();var t=e.createElement("div",{id:"spec-main-div",styles:{height:"100%"}}),r=e.createElement("div",{id:c.XSPECS_CONTAINER,styles:{height:"100%"}}).inject(t),n=new d({identifier:"XSRImmersiveFrame"});n.getContent().appendChild(t),widget.body.appendChild(n.getContent()),this.appCore.immersiveFrame=n,e.createElement("div",{id:c.ID_SpecsPanel,styles:{height:"100%"}}).inject(r),e.createElement("div",{id:c.ID_SpecsMiddlePanel,styles:{height:"100%",width:"100%",float:"right"}}).inject(r);e.createElement("div",{id:c.ID_SpecsContainer,styles:{height:"calc(100% - 40px)",width:"100%",float:"right"}}).inject(r);e.createElement("div",{id:c.ID_SpecViewContainer}).inject(r),e.createElement("div",{id:c.ID_SPECS_PROPERTIES,styles:{height:"100%"}}).inject(r)},_subscribePlatformAPIEvents:function(){this.platformSubs=[];var e=this,t=new u({appCore:this.appCore}),r=n.subscribe("DS/PADUtils/PADCommandProxy/refresh",function(r){if((!e.viewWrapper||e.viewWrapper.currentView)&&r.data.authored&&r.data.authored.modified)try{t.getRecentSpecsData().then(function(r){var n=t.processSearchResult(r);widget.setValue("fetchmode","author"),widget.setValue("previousindexed",Math.floor(Date.now()/1e3));var i=e.viewWrapper.treeDocument.getRoots();n.forEach(function(r){for(var n=0;n<i.length;n++){var a=i[n];r.physicalid===a.getID()&&(a.updateRecentContent(r),t.isNodeStatebelongsToPanel(r.CURRENT,e.currentPanel)||e.specRouteManager.getCurrentSpecViewerId()||e.viewWrapper.treeDocument.removeRoot(a),n=i.length+1)}})}),e.appCore.basicModelEvents.publish({event:c.EVENT_INFORMATION_PANEL_REFRESH})}catch(e){console.log(e)}});this.platformSubs.push(r);var i=n.subscribe("XEN/PUBLIC_EVENT/ENGINEERING_ITEM/PART_NUMBER_UPDATED",function(r){if(!e.viewWrapper||e.viewWrapper.currentView){r.references;var n=e.viewWrapper.treeDocument;try{n.getRoots();t.getRecentSpecsData().then(function(r){var n=t.processSearchResult(r),i=e.viewWrapper.treeDocument.getRoots();n.forEach(function(e){for(var t=0;t<i.length;t++){var r=i[t];e.physicalid===r.getID()&&(r.updateRecentContent(e),t=i.length+1)}})}).catch(function(e){console.log(e)})}catch(e){console.log(e)}}});this.platformSubs.push(i);var a=n.subscribe("Lifecycle.Modification",function(t){if(t&&"string"==typeof t&&(t=JSON.parse(t)),("ENOSPEC_AP"===t.AppID||!e.viewWrapper||e.viewWrapper.currentView)&&t.Refresh)if(t.Refresh.created){var r=t.Refresh.created;if(Array.isArray(r))for(var n=0;n<r.length;n++){var i=r[n];i.physicalid&&"Duplicate"===i.operation?e._addRootNodeFromRecents(i.physicalid,!1):i.physicalid&&"Revise"===i.operation&&e._addRootNodeFromRecents(i.physicalid,!1)}}else t.Refresh.deleted?console.log("Deleted from lifecycle"):t.Refresh.modified&&console.log("modified from lifecycle")});this.platformSubs.push(a);var o=n.subscribe("toggleActiveCA"+widget.id+"/AuthKey",function(){e.appCore.wucCtxCapSet=!1,e.onRefreshWorkUnderView()});this.platformSubs.push(o);var s=n.subscribe("toggleDeActiveCA"+widget.id+"/AuthKey",function(){e.appCore.wucCtxCapSet=!1,e.onRefreshWorkUnderView()});this.platformSubs.push(s);var p=n.subscribe("removeAuthCtxEvent"+widget.id+"/AuthKey",function(){e.appCore.wucCtxCapSet=!1,e.onRefreshWorkUnderView()});this.platformSubs.push(p)},_addRootNodeFromRecents:function(e,t){var r=this,n=new u({appCore:this.appCore});n.getRecentSpecsData().then(function(i){for(var a=n.processSearchResult(i),o=0;o<a.length;o++)if(a[o].physicalid===e){n.isNodeStatebelongsToPanel(a[o].CURRENT,r.currentPanel)&&r.viewWrapper.addSpecRootNodes(a[o],0,t);break}}).catch(function(e){console.log(e)})},displayErrorNotification:function(e){console.log(e),h.displayNotification({eventID:"error",msg:e?e.message:"Failed to load."})},onSearch:function(e){this.appCore.triptychManager.getResetSearch()&&this.specRouteManager&&null==this.specRouteManager.getCurrentSpecViewerId()&&(this.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_ActionSelected,data:{id:this.currentPanel,searchString:e}}),widget.setCounter(4,"search"))},onResetSearch:function(){this.xsrModelEvents.publish({event:c.WELCOMEPANEL_EVENT_ActionSelected,data:{id:this.currentPanel,searchString:""}})},onRefresh:function(){if(this.specRouteManager&&this.specRouteManager.getCurrentSpecViewerId())this.specRouteManager.refeshCurrentSpecViewer();else this.viewWrapper.refreshCurrentView&&this.viewWrapper.refreshCurrentView();this._reCheckPreferences()},onRefreshWorkUnderView:function(){let e=this;var t=e.appCore.triptychManager;if(t.isRightPanelVisible&&t.getCommandId()==c.TOOLBAR_CMD_MULTIGRID&&e.xsrModelEvents.publish({event:c.RELOAD_MULTIGRID_VIEW,data:{}}),this.specRouteManager&&this.specRouteManager.getCurrentSpecViewerId())this.specRouteManager.refeshCurrentSpecViewer()},_reCheckPreferences:function(){this.appCore.workUnderController&&(widget.getValue("WorkUnderChange")?this.appCore.workUnderController.show():this.appCore.workUnderController.hide()),this.checkUserHasData(this,null)},destroy:function(){this.specRouteManager&&this.specRouteManager.destroy(),this.triptychManager&&this.triptychManager.destroy(),this.platformSubs&&this.platformSubs.length>0&&this.platformSubs.forEach(function(e){n.unsubscribe(e)}),this.xsrModelEvents.unsubscribeAll()},checkUserHasData:function(e,t){if(null==t)t=new u({appCore:e.appCore});t.nextStart=0,t.allUserData().then(function(t){!(0==t.length&&e.appCore.specWidgetPreferences.userDataCount>0)&&t.length>e.appCore.specWidgetPreferences.userDataCount&&(e.appCore.specWidgetPreferences.userDataCount=t.length),console.log("Data count: "+e.appCore.specWidgetPreferences.userDataCount+" | "+t.length)}).catch(function(t){console.log(t),e.appCore.specWidgetPreferences.userDataCount=0})}})});