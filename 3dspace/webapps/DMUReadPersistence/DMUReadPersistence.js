define("DS/DMUReadPersistence/DMUReadPersistence",[],function(){}),define("DS/DMUReadPersistence/DMUReadServices",["require","exports","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUContextManager"],function(e,t,n,o){"use strict";return class{static importModel(e){if(e&&"object"==typeof e&&e.dataJson&&"object"==typeof e.dataJson&&e.dataJson.Model&&"object"==typeof e.dataJson.Model){let t=o.getReviewContext({viewer:e.viewer}),a=new n({viewer:e.viewer,experience:t,appType:e.appType,markupRepRef:e.mkpRepRef});a.importDataModel(e.dataJson,function(t){a.postImport(),e.onImportCompleted&&e.onImportCompleted(t)})}else e.onImportFailed&&e.onImportFailed()}}}),define("DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting",["UWA/Core","UWA/Class","UWA/Class/Options","DS/Logger/Logger","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices"],function(e,t,n,o,a,i,r,s){"use strict";var l=t.singleton(n,{init:function(){var t=o.getLogger(l);t.log("init"),this.setOptions({navigate_opts:{timeout:2e4}});var n=this,d=!1;function c(e){if(null===e&&void 0===e)return"";var t="";if(Array.isArray(e))for(var n=e.length/2,o=0;o<n;o++)t+=0===o?"?":"&",t+=e[2*o]+"="+e[2*o+1];return encodeURI(t)}this.sendWebServiceCall=function(o){if(o){if(!d)return s=function(){n.sendWebServiceCall(o)},l=o.onFailure,t.log("app_initialization"),void a.getPlatformServices({onComplete:function(e){n.setOption("platform_services",e),d=!0,s()},onFailure:function(){t.warn("Cannot retrieve the Platform Services"),d=!0,l()}});var s,l;if(Array.isArray(n.getOption("platform_services"))){var u=e.clone(o.config,!1);u.onComplete=o.onSuccess,u.onFailure=o.onFailure,u.onTimeout=o.onFailure,u.method=u.verb,u.headers={Accept:"application/json","Content-Type":"application/json","Accept-Language":o.platform?o.platform.getLang():r.getSetting("lang"),SecurityContext:o.platform?o.platform.getSecurityContext():r.getSetting("pad_security_ctx")},"object"==typeof u.data&&(u.data=JSON.stringify(u.data));var p=[];p.push("securityContext"),p.push(o.platform?o.platform.getSecurityContext():r.getSetting("pad_security_ctx")),p.push("tenant"),p.push(o.platform?o.platform.getPlatformId():n.getOption("platform_services")[function(){var t,o=n.getOption("platform_services"),a=n.getTenant();if(e.is(a)){var i=a.value?a.value:a;if(Array.isArray(n.getOption("platform_services")))for(var r=0;r<o.length&&!e.is(t);r++)o[r].platformId===i&&(t=r)}return e.is(t)||(window.console.warn("Tenant not found => Tenant idx by default is 0"),t=0),t}()].platformId),i.authenticatedRequest(o.platform?o.platform.get3DSpaceUrl()+"/"+o.url+c(p):n.get3DSpaceUrl()+"/"+o.url+c(p),u)}else o.onFailure&&o.onFailure()}},this.getServerContext=function(e){if(!e||"function"!=typeof e.onComplete||"function"!=typeof e.onFailure)return;let t=r.getSetting("pad_security_ctx");t?e.onComplete(t):e.onFailure()},this.get3DSpaceUrl=function(){return s.get3DSpaceUrl()},this.getTenant=function(){return r.getSetting("x3dPlatformId")}},doInitialize:function(){}});return l.doInitialize(),l}),define("DS/DMUReadPersistence/DMUPasswordDialog",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Utilities/TouchUtils","DS/Controls/LineEditor","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,i,r){"use strict";return t.extend({init:function(t){this._parent(t);var s,l,d,c=(t||{}).ctxViewer;this.build=function(t,u){if(!s){var p=e.createElement("div",{id:"DMUPasswordDialogContent"});e.createElement("p",{id:"DMUPasswordDialogDescription",text:r.documentPasswordMessage}).inject(p);var f=e.createElement("div",{styles:{display:"flex","justify-content":"space-evenly","align-items":"center"}}).inject(p);l=new i({placeholder:r.documentPassword,selectAllOnFocus:!0,displayStyle:"password"}).inject(f);var m=new o({label:"Display Password",showLabelFlag:!1,icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"},type:"check",displayStyle:"icon"}).inject(f);m.getContent().setStyle("margin-left","10px"),d=e.createElement("p",{styles:{color:"#EA4F37",margin:"5px"}}).inject(p),m.getContent().addEventListener("change",function(){m.checkFlag?(m.setProperties({icon:{iconName:"eye-off",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="text"):(m.setProperties({icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="password")});var g={Ok:new o({emphasize:"primary",label:"OK",onClick:function(){l.value?(l.disabled=!0,d.innerText="",g.Ok.disabled=!0,t(l.value)):d.innerText=r.documentPasswordRequired}}),Cancel:new o({label:"Cancel",onClick:u})};l.addEventListener("uncommittedChange",function(){d&&d.innerText&&(d.innerText="")}),s=new n({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:r.documentPasswordRequired,content:p,closeButtonFlag:!1,position:a.getTouchMode()?{my:"center bottom"}:void 0,immersiveFrame:c.getFrameWindow().getImmersiveFrame(),buttons:g})}},this.onIncorrectPassword=function(){s&&l&&(l.disabled=!1,s.buttons.Ok.disabled=!1,d.innerText=r.documentIncorrectPassword)},this.getValue=function(){return l?l.value:""},this.close=function(){c&&(s&&s.close(),c=s=null,l=null,d=null)}}})}),define("DS/DMUReadPersistence/DMUXCADSupport",["UWA/Core","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/Logger/Logger","DS/WAFData/WAFData","DS/WebSystem/Environment","DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/ConvertV1","DS/SPAContentOptimizer/COConvertOption","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,i,r,s,l,d){"use strict";var c={},u={},p=o.getLogger("DS/DMUReadPersistence/DMUXCADSupport");p.log("init");var f=0;return{returnSpaConvertUri:function(t){var n=e.Utils.parseUrl(t);return n.authority+n.directoryPath},execConvertCmd:function(t,n){var o=t.asset;!function(){var a,i=new s(n);i.onResultFile=function(n,a){if(p.log("launchConvert.onResultFile",n),"Success"!==n||!a)return!0;var i=new Blob([a]),r=e.clone(o);t.onConvertSuccess(e.extend(r,{provider:"FILE",filename:window.URL.createObjectURL(i),proxyurl:"none",requiredAuth:null,serverurl:"",originalType:o.type,mimetype:o.dataFormat||o.mimetype,format:o.dataFormat||o.mimetype,type:o.dataFormat||o.mimetype}))},i.onErrors=function(e){if(p.error("Conversion error"),e&&e[0]&&e[0].split("\n")){var n=e[0].split("\n");"Please check the documentation for supported file versions and resave the file in one of supported versions if possible"===n[2]?(p.error(e),this.onErrorsVisited=!0):"InterOp Diagnostic: The input Parasolid file is Bare binary file which is an unsupported format."===n[1]?(p.error(e),this.onErrorsVisited=!0):"Error : The input file is saved in Civil3D. Output might be incomplete."===n[0]&&p.warn(e)}t.onConvertError(d.contentOptimizerNotSupport)},i.onMissingFiles=function(e){p.error("Missing Files domain"),p.error(e),t.onConvertError&&t.onConvertError()},i.onProgress=function(e){p.log("launchConvert.onProgress",e)},t.ConversionOpts&&(a=new l,Object.keys(t.ConversionOpts).forEach(function(e){void 0!==t.ConversionOpts[e]&&a["Set"+e](t.ConversionOpts[e])}));var r=o.url,c=o.filename;p.log("_execConvertCmd.convertUrl",c,r,o.dataFormat,a),i.convertUrl(c,r,o.dataFormat,a)}()},startConvert:function(e){var o=this,a=e.asset,i="Not initialized";new Promise(function(n){t.getServiceUrl({serviceName:"SPAContentOptimizer",logger:p,platformId:a.tenant,onSuccess:function(e){c[a.tenant]=o.returnSpaConvertUri(e.url),n()},onError:function(t){p.error("Ooops, missing Service : ",t.serviceName,"Reason : ",t.error),e.onConvertError("Missing Service")}})}).then(function(){var t=!1,s={onHypervisorDisconnect:function(){p.log("XCADSpatialSupport._startConvert: CSIServer Hypervisor Disconnected"),t?t=!1:(p.error("Unable to connect"),e.onConvertError(e.asset))},onHypervisorConnect:function(){t=!0,p.log("CSIServer Connected")},onDisconnect:function(){p.log("CSIServer Node Disconnected")},authentication:function(e,t,o){var a=encodeURIComponent(i).replace(/'/g,"%27").replace(/"/g,"%22");n.authenticatedRequest(e.passportURL+"/login?service="+a,{method:"GET",headers:{Accept:"application/json"},onComplete:function(e){try{var n=JSON.parse(e).access_token;t(i,n)}catch(e){o("Failed to parse ticket")}},onFailure:function(e,t){o("Failed to retrieve ticket"),p.log("CSIServer authentication onFailure"),p.error("Failed to retrieve ticket: "+t+e)}})}},l=c[a.tenant];""!==l&&void 0!==l&&(s.hypervisorUrl=l,s.ssl=!0,i="https://"+s.hypervisorUrl);var d=r.getPool("application.webWidget").createNode(s),u=d.select("ContentOptimizer");o.execConvertCmd(e,d,u)})},startLocate:function(t,n){var o=this,r=t.asset;this.located=!1,p.log("XCADSpatialSupport._startLocate");var s=t.asset.originalAsset.contextid?t.asset.originalAsset.contextid:"preferred";i.get("PreferredCredentials")&&(s=i.get("PreferredCredentials"));var l="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==t.asset.originalAsset.provider.toUpperCase()&&"3DSPACE"!==t.asset.originalAsset.provider.toUpperCase()||(l+="&SecurityContext="+encodeURIComponent(s)),"asm"===r.dataFormat&&(r.dataFormat="3dxml");var d=u[r.tenant]+l,c={specificationFilter:[{format:r.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===t.asset.originalAsset.provider.toUpperCase()?"3DSpace":t.computedInfos.provider,id:t.asset.originalAsset.physicalid,type:t.asset.originalAsset.type}]};!0===n&&(c.specificationFilter[0].notifyIfMissing=!0),a.authenticatedRequest(d,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:s},type:"json",data:JSON.stringify(c),onComplete:function(n){if(console.log("onComplete locate"),n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){f=0;var i=u[r.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+n.derivedOutputs[0].id+"/DerivedOutputFiles/"+n.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";a.authenticatedRequest(i,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(n){console.log("onComplete download ticket");var o=n.data[0].dataelements,a=o.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(o.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",i=e.clone(r);t.onConvertSuccess(e.extend(i,{provider:"FILE",filename:a,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:r.type,mimetype:r.dataFormat||r.mimetype,format:r.dataFormat||r.mimetype,type:r.dataFormat||r.mimetype})),console.log("Loading from DFA : "+a)},onFailure:function(e){console.log("onFailure download ticket"+e)}})}else if(f<=10){var s=f++<5?1e3:3e3;console.log(" restart locate in "+s+" ms"),setTimeout(o.startLocate.bind(o,t,!1),s)}else console.log("locate service is not available")},onFailure:function(e){console.log("onFailure locate"+e)}})},convertDFA:function(e){var n=this,o=e.asset;t.getServiceUrl({serviceName:"derivedformataccess",logger:p,platformId:o.tenant,onSuccess:function(t){u[o.tenant]||(u[o.tenant]=t.url),t.platformId!==o.tenant&&p.warn("DerivedFileAccess desired Tenant:",o.tenant,"got ",t.platformId),p.log("DerivedFileAccess : URL found > ",u[o.tenant]),n.startLocate(e,!0),n=null},onError:function(t){p.error("Ooops, missing Service : ",t.serviceName,"Reason : ",t.error),e.onConvertError("Missing Service"),n=null}})}}}),define("DS/DMUReadPersistence/DMUReviewPersistenceServices",["UWA/Class","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPUtils","DS/PlatformAPI/PlatformAPI","DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DocumentManagement/DocumentManagement","DS/VisuDataAccess/Ox4StreamLoader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/PADUtils/PADSettingsMgt","UWA/Utils"],function(e,t,n,o,a,i,r,s,l,d,c){"use strict";return e.extend({init:function(){let e=!0;var u=new a;this.updateReviewAndJSONFile=function(e,t,n){i.getServerContext({onComplete:function(o){var a=e.markupName,s=e.markupType,l=(new Date).getTime(),d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(l+16*Math.random())%16|0;return l=Math.floor(l/16),("x"===e?t:3&t|8).toString(16)}),c=new Blob([JSON.stringify(e.json)],{type:"application/json"}),u=null;c&&((u=c).name=d,u.fileName=d);var p={fileInfo:{file:u,title:d,newFile:e.newFile,fileName:d},id:e.reviewPhysicalId},f={onComplete:function(e){t&&t({reviewId:e.data[0].id,reviewName:a,reviewType:s})},onFailure:function(){n&&n({reviewName:a,reviewType:s})},securityContext:o,tenant:i.getTenant(),tenantUrl:i.get3DSpaceUrl()};r.modifyDocument(p,f)},onFailure:n})},this.updateMarkupStream=function(e,t,n){var o,a=e.markupName,r=e.markupType,s=new Blob([e.json],{type:"application/json"}),l=c.getUUID().toString();(o="DMUMarkupRepReference",new Promise(function(e,t){i.sendWebServiceCall({url:"resources/markup/service/getCheckinTicket",config:{verb:"POST",data:JSON.stringify({sObjectType:o})},onSuccess:function(t){e(t?JSON.parse(t):{})},onFailure:function(e){t(e)}})})).then(function(o){var d,c=o.checkinTicket,u=o.actionURL;c&&u&&(d={file:s,ticket:c,URL:u,correlationId:l,fileName:"WebReviewContent.json"},new Promise(function(e,t){var n=new FormData;n.append("__fcs__jobTicket",d.ticket),n.append("file_0",d.file,d.fileName);var o=new XMLHttpRequest;o.open("POST",d.URL,!0),o.onload=function(){200===o.status&&e(o.responseText)},o.onerror=(()=>t(new Error("Network Error"))),o.send(n)})).then(function(o){var s=o;s&&function(e){return new Promise(function(t){i.sendWebServiceCall({url:"resources/markup/service/checkinStreamInfo",config:{verb:"POST",data:JSON.stringify({sObjectId:e.ObjectId,sReceipt:e.receipt,sJsonStream:e.stream,sFileName:e.fileName,sPersistencyType:e.persistencyType,sPersistencyName:e.persistencyName})},onFailure:function(e){t({error:e})},onSuccess:function(e){t(e?JSON.parse(e):{})}})})}({ObjectId:e.reviewPhysicalId,receipt:s,stream:e.json,fileName:"WebReviewContent.json",persistencyName:"WebReviewContent",persistencyType:"json"}).then(function(o){o&&!o.error?t&&t({reviewId:e.reviewPhysicalId,reviewName:a,reviewType:r}):n()})}).catch(n)}).catch(n)},this.getDnDReviewAndJSONFile=function(e,a,s){e.serverurl||(e.serverurl=i.get3DSpaceUrl()),e.tenant||(e.tenant=i.getTenant()),i.getServerContext({onComplete:function(i){var l={onComplete:function(i){!function(e,a,i){var r=e?e.MarkupReservedby:null;if(null!==r&&u){var s=e.MarkupID,l=e.MarkupType,d=e.MarkupName?e.MarkupName:e.MarkupTitle,c=e.MarkupDescription,p=e.MarkupState,f={onComplete:function(e){var u={url:e[0].downloadUrl,responseType:"json",onComplete:function(e){var t={reviewPid:s,reviewType:l,reviewName:d,reviewDescription:c,reviewState:p,jsonObj:JSON.parse(n.cleanJSONString(e)),modifiable:!r||""===r||r===o.getUser().login};a(t),window.widget&&window.widget.dispatchEvent("onDMUMarkupLoaded",s)},onFailure:i};t.request(u.url,{responseType:u.responseType,method:"GET",onComplete:u.onComplete,onFailure:u.onFailure,timeout:0})},onFailure:i};u.downloadDocuments([e.MarkupID],f)}else i()}({MarkupID:e.markupId,MarkupType:e.markupType,MarkupJsonFileID:i&&i.data&&i.data.length&&i.data[0].relateddata&&i.data[0].relateddata.files&&i.data[0].relateddata.files.length?i.data[0].relateddata.files[0].id:void 0,MarkupReservedby:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.reservedby:null,MarkupName:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.title:null,MarkupDescription:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.description:null,MarkupState:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.state:null},a,s)},onFailure:s,securityContext:i,additionalURLParams:"$include=parents",tenantUrl:e.serverurl,tenant:e.tenant,relInfo:{parentRelName:"Markup",parentDirection:"from"}};r.getDocuments([e.markupId],l)},onFailure:s})},this.getProductByMarkerId=function(e,t,n){e&&e.physicalid&&(e.serverurl||(e.serverurl=i.get3DSpaceUrl()),e.tenant||(e.tenant=i.getTenant()),i.getServerContext({onComplete:function(o){var a={onComplete:function(e){if(0===e.data.length)n(e);else{var o={MarkupContext:{}};e.data[0].relateddata.parents&&e.data[0].relateddata.parents.length?o.MarkupContext.contexts=e.data[0].relateddata.parents:e.data[0].dataelements&&e.data[0].dataelements.parentId&&(o.MarkupContext.contexts=[],o.MarkupContext.contexts.push({id:e.data[0].dataelements.parentId})),t(o)}},onFailure:n,securityContext:o,tenantUrl:e.serverurl,tenant:e.tenant,additionalURLParams:"$include=parents",relInfo:{parentRelName:"Markup",parentDirection:"from"}};r.getDocuments([e.physicalid],a)},onFailure:n}))},this.getMarkupInfos=function(t,n,o){t&&t.physicalid&&i.sendWebServiceCall({url:"resources/markup/service/getMarkup",config:{verb:"POST",data:JSON.stringify({sMarkupId:t.physicalid})},onSuccess:function(t){if(t){let o=JSON.parse(t);if(n(o),o.reservedby||"false"===o.modifyAccess){let t=o.modifyAccess;e=!t||"false"!==t}else e=!0}else n({})},onFailure:o})},this.getMarkupStream=function(t,a,r){var c={IRPC:!0,serverUrl:i.get3DSpaceUrl(),physicalid:t.markupId,boType:"DMUMarkupRepReference",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(o){window.console.log("getMarkupJson::success:"+o.byteLength),a({jsonObj:JSON.parse(n.cleanJSONString(o)),reviewPid:t.markupId,reviewType:t.markupType,reviewName:t.markupTitle,owner:t.markupOwner,modifiable:e})},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),r(e="NOSTREAM")}},u=o.getUser().login;l.useUWAProxy({proxymode:"passport",login:u,contextid:d.getSetting("pad_security_ctx")}),s.Load(c)}}})}),define("DS/DMUReadPersistence/DMUWebServicesUtils",["UWA/Class","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting"],function(e,t){"use strict";return e.singleton({init:function(){},getParentTypes:function(e){return new Promise((n,o)=>{t.sendWebServiceCall({url:"resources/markup/service/getParentTypes",config:{verb:"POST",data:JSON.stringify({sType:e})},onSuccess:function(e){let t=JSON.parse(e);n(t.parentTypes)},onFailure:function(e){o(e)}})})}})}),define("DS/DMUReadPersistence/DMULoadingContextController",["UWA/Class","UWA/Utils","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DocumentManagement/DocumentManagement","DS/DMUControls/EXPNotify","DS/DMUControls/panels/DMUDocumentPanel","DS/PADUtils/views/PADProgressBar","DS/DMUReadPersistence/DMUPasswordDialog","DS/DMUBaseExperience/EXPManagerSet","DS/CoreEvents/ModelEvents","DS/CATWebUXComponents/DMUCommandsManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPToolsContext","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,i,r,s,l,d,c,u,p,f,m,g,v,D,S){"use strict";let I={isr:"DS/PIMwebViewController/PIMwebItfCtrl",difAnnotSet:"DS/CAT3DAnnotControllerForReview/CATDIFAnnotSetLoader",msr:"DS/SMAMpw3DMarkupImpl/SMAMpwMSRLoadCtrl"},h=e.extend({init:function(e){this._parent(e);let h,C,y,b,x,M,w,R,P,k,F,U=this,T=(e||{}).ctxViewer,O=null,L=null,A={},j={},N=new c,E=null,V=null,_=!0,W=n.getEventsController({viewer:T.getViewer()}),q=null,B={icon:null,title:null},J=null,K=!0,X=null,G=[],H={},z=["doc","docx","docm","dot","dotm","dotx","rtf","ppt","pptx","pot","potm","potx","pps","ppsm","ppsx","pptm"],$=!1;var Q={};function Y(e,t,n){C&&C.destroy(),C=new i({body:T.getFrameWindow().getUIFrame(),type:e,message:t}),"successful"===n&&U.publish("on2DDocumentLoadSuccess")}function Z(e){let t;w&&(w.close(),w=null),T.removeRoots({pids:[y]}),e&&"InvalidPDFException"===e.name&&(t=S.documentNotSupported),T.displayNotification({msg:t||S.documentLoadKO,eventID:"error"}),y=null;let n=s._counter;for(let e=0;e<n;e++)s.off();U.publish("onDocumentLoadFailure")}function ee(){let e=s._counter;for(let t=0;t<e;t++)s.off();Y("info","Document"===(o.getNodeType(T.getRootBagPath().getChildrenPathes()[0])?o.getNodeType(T.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)):null)||"Document"===X?S.documentLoadCancel:S.requirementLoadCancel);let t=u.getCommand("CleanAll",T.getCommandContext());t&&t.begin()}function te(e,t){return new Promise(n=>{P&&P[e]?n(P[e]):g.authenticatedRequest(t,{proxy:"none",type:"blob",timeout:18e4,onComplete:function(t){let o=new FileReader;o.onload=function(){P||(P={}),P[e]=o.result,n(P[e])},o.readAsDataURL(t)},onFailure:function(){n(t)},onTimeout:function(){n(t)}})})}function ne(){let e=n.giveEventsController({viewer:T.getViewer()});e&&e.fireEvent("onLoadedReviewContext",{rootType:E})}""!==window.location.search&&(UWA.extend(Q,t.parseQuery(window.location.search)),Q.widgetDomain&&UWA.extend(Q,t.parseQuery(Q.widgetDomain))),"testMbom"in Q&&($=!0);const oe=function(e){let t=document.createElement("textarea");return t.innerText=e,t.innerHTML};async function ae(e){let t="Requirement Specification"===e.parentElement.type?[]:[e.parentElement],n=[],o=[],a=function(e){let t="";for(let o=1;o<=e&&n[o];o++)1!==o&&(t+="."),t+=n[o];return t};const i={0:e.parentElement.pathId};for(let r=1;r<e.dataObj.length;r++){const s=e.dataObj[r];v.getParentType(s)||v.setParentType(s.type,s["type.kindof"]);const l=parseInt(s.level),d="/";i[l]=`${i[l-1]}${d}${s["physicalid[connection]"]}${d}${s.physicalid}`;let c={pathId:i[l],typeIconUrl:await te(s["type.kindof"],s.type_icon_url),level:l};if(o.length-1>c.level&&(o=o.slice(0,c.level+1)),o[s.level]?o[s.level]++:o[s.level]=1,"Chapter"===s["type.kindof"])n[s.level]?n[s.level]++:n[s.level]=1,n.length-1>c.level&&(n=n.slice(0,c.level+1)),c.content=s["attribute[Title]"],c.title=s["attribute[Title]"],c.type=s["type.kindof"],c.chapterLevelTag=a(c.level),c.fontSize=34-2*c.level;else if("Comment"===s["type.kindof"]||"Requirement"===s["type.kindof"]){c.content=s.content,c.title=s["attribute[Title]"],c.type=s["type.kindof"],"1"===s.level?c.chapterLevelTag="0":c.chapterLevelTag=a(c.level-1)||"0";let e="",t=Math.max(0,n.length-1>=c.level?c.level-1:n.length-1);for(let n=t+1;n<=c.level;n++)n!==t+1&&(e+="."),o[n]||(o[n]=1),e+=o[n];c.subLevelTag=e}t.push(c)}P=null;let r=d.getManager({name:"DMU2DSheetManager",context:T.getFrameWindow()});r&&r.loadDocumentStream({documentID:y,type:"Requirement",elementsToLoad:t,fatherNode:T.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:function(){let e=D.giveReqCompareController({context:T});e&&e.isLoading()||(h&&h(),Y("info",S.documentLoadOK,"successful")),M&&M();let t=s._counter;for(let e=0;e<t;e++)s.off();ne()},onFailure:Z})}function ie(e){g.authenticatedRequest(p.get3DSpaceUrl()+"/resources/trm/streaming/structure/"+e.parentElement.pathId,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e.securityData},timeout:6e4,onComplete:function(t){let n=JSON.parse(t);e.onComplete(n)},onFailure:Z,onTimeout:Z})}function re(e){let t=f.getSetting("pad_security_ctx");var n,o;s.on(),(n=e.phyID,o=t,new Promise(function(e,t){let a=encodeURI(`${p.get3DSpaceUrl()}/resources/trm/dictionary/info?pid=${n}&select=type,attribute[Content Data],attribute[Title]`);g.authenticatedRequest(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:o},timeout:6e4,onComplete:function(t){let o=JSON.parse(t);o&&"success"===o.status&&o.results[0]?e({phyId:n,content:oe(o.results[0]["attribute[Content Data]"]||""),title:o.results[0]["attribute[Title]"],type:o.results[0].type.value}):e({phyId:n})},onFailure:function(){t(new Error("Requirement content Request Failed"))},onTimeout:function(){t(new Error("Requirement content Request Timeout"))}})})).then(function(n){let o={pathId:n.phyId,content:n.content,title:n.title,type:v.getParentType(n.type)?v.getParentType(n.type):n.type};"Requirement"===o.type?T.getController().getAttributes({ids:[e.phyID],attributes:["type_icon_url"],callbacks:{onComplete:function(n){o.level=0,o.chapterLevelTag=0,o.subLevelTag=0,te(o.type,n[e.phyID].type_icon_url).then(e=>{o.typeIconUrl=e,ie({parentElement:o,securityData:t,onComplete:function(e){F=[o.pathId],ae({parentElement:o,dataObj:e})}})})},onFailure:Z}}):ie({parentElement:o,securityData:t,onComplete:function(e){F=[o.pathId],e.length>0&&e.forEach(e=>{F.push(e.physicalid)}),ae({parentElement:o,dataObj:e})}})})}function se(e){let t,i;e.path&&(t=o.getNodeID(e.path.getLastElement(!0)),i=o.getNodeType(e.path.getLastElement(!0))),"Document"===i||"Specification Report"===i?function(e){let t,o,i=function(e,n){let a=d.getManager({name:"DMU2DSheetManager",context:T.getFrameWindow()});a||(a=new m({ctxViewer:T}),d.addManager({name:"DMU2DSheetManager",context:T.getFrameWindow(),manager:a})),a&&a.loadDocumentStream({documentID:y,dataBuffer:e,type:"Document",password:n,fatherNode:T.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:async function(){h&&h(),M&&await M();let e=s._counter;for(let t=0;t<e;t++)s.off();Y("info",S.documentLoadOK,"successful"),ne()},onPasswordOk:function(){w&&(w.close(),w=null)},onIncorrectPassword:function(){w?w.onIncorrectPassword():(w=new l({ctxViewer:T})).build(function(t){i(e,t)},function(){if(x&&t&&o){w&&(w.close(),w=null);let e=s._counter;for(let t=0;t<e;t++)s.off();x.build(t,o,ee)}else ee()})},onFailure:Z})},c={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){i(e)},onFailure:Z,onTimeout:Z};o=function(t,o){s.on(),b={fileId:t,versions:o},a.downloadDocuments([o[0]],{onComplete:function(t){const a=t[0].fileName.split(".").pop().toLowerCase();if("pdf"===t[0].fileName.split(".").pop().toLowerCase())E="PDF",g.authenticatedRequest(t[0].downloadUrl,c);else if("dxf"===a||"dwg"===a){E=t[0].fileName.split(".").pop().toUpperCase();let a={dataFormat:"udl",dtype:"Document",filename:t[0].fileName,format:t[0].fileName.split(".").pop().toLowerCase(),mimetype:t[0].fileName.split(".").pop().toLowerCase(),provider:"FILE",requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},tenant:f.getSetting("x3dPlatformId"),type:t[0].fileName.split(".").pop().toLowerCase(),url:t[0].downloadUrl};require(["DS/DMUReadPersistence/DMUXCADSupport"],function(t){t.startConvert({asset:a,onConvertError:function(e){if("Missing Service"===e){Y("warning",S.documentTypeNotSupported);for(let e=0;e<s._counter;e++)s.off()}else Y(e)},onConvertSuccess:function(t){require(["DS/DibUDLWebLoader/DraftingUDLWebLoader"],function(a){if(a){let i=new a;if(i.set3DAccuracy(.001),i.set2DAccuracy(.001),t){let a={provider:"FILE",serverurl:"",proxyurl:"none",requiredAuth:null};a.filename=t.filename;let r={serverUrl:p.get3DSpaceUrl(),securityContext:f.getSetting("pad_security_ctx"),UDLObjURL:a,onComplete:function(t){k=t;let a=T.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),r=d.getManager({name:"DMU2DSheetManager",context:T.getFrameWindow()});r||(r=new m({ctxViewer:T}),d.addManager({name:"DMU2DSheetManager",context:T.getFrameWindow(),manager:r}));let l=[];for(let n=0;n<t.sheetIDList.length;n++)l.push({modelID:t.sheetIDList[n],sheetID:"Drw."+e.phyID+"_"+t.sheetIDList[n],label:i.getSheetName(t.sheetIDList[n])});r.load2DDocument({loadedSheetInformations:t,phyID:o[0],dataType:"DXF/DWG",sheetNodes:l,parentNode:a,getSheet3DNode:function(e){let t=i.getSheetBackgroundColor(e.modelID);i.getSheet3DNode({sheetID:e.modelID,onSheetNodeCreated:function(n){a.addChild(n),T.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.sheetID)&&e.noUdlWarningMessage(),i.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),T.getViewer().render(),T.getViewpoint().reframe(),e.end();for(let e=0;e<s._counter;e++)s.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){for(let e=0;e<s._counter;e++)s.off();h&&h();let e=n.giveEventsController({viewer:T.getViewer()});e&&e.fireEvent("onDXFLoadSuccess"),M&&M(),ne()},onFailure:function(){T.removeRoots({pids:[a]}),T.displayNotification({msg:S.fileWithNoSVG,eventID:"error"}),U.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};i&&i.loadModel(r)}}})}})})}else if(z.includes(a.toLowerCase())){E=t[0].fileName.split(".").pop().toUpperCase();let e={ConversionOpts:{},dataFormat:"pdf",dtype:"Document",filename:t[0].fileName,format:t[0].fileName.split(".").pop().toLowerCase(),mimetype:t[0].fileName.split(".").pop().toLowerCase(),provider:"FILE",requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},originalAsset:{contextid:f.getSetting("pad_security_ctx"),displayname:t[0].fileName,dtype:"Document",physicalid:y,provider:"EV6",requiredAuth:"passport",serverurl:p.get3DSpaceUrl(),serviceId:"3DSpace",tenant:f.getSetting("x3dPlatformId"),type:"Document"},tenant:f.getSetting("x3dPlatformId"),type:t[0].fileName.split(".").pop().toLowerCase(),url:t[0].downloadUrl};require(["DS/DMUReadPersistence/DMUXCADSupport"],function(t){t.convertDFA({asset:e,onConvertError:function(e){if("Missing Service"===e){Y("warning",S.documentTypeNotSupported);for(let e=0;e<s._counter;e++)s.off()}else Y(e)},onConvertSuccess:function(e){let t={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){i(e)},onFailure:Z,onTimeout:Z};g.authenticatedRequest(e.filename,t)}})})}else Y("error",S.documentNotSupported)}})};let v={onComplete:function(e){if(e&&e.data&&e.data[0]&&e.data[0].relateddata.files){B.icon=e.data[0].dataelements.typeicon?e.data[0].dataelements.typeicon:null,B.title=U.getSubContextInformations(e.data[0].id)?U.getSubContextInformations(e.data[0].id).label:e.data[0].dataelements.title?e.data[0].dataelements.title:null;let a=n.giveEventsController({viewer:T.getViewer()});a&&a.fireEvent("onGetDocumentsCompleted");let i=["pdf","dxf","dwg"].concat(z);if(O){let n,a,l,d,c={},u=[];if(O&&(n=0),e.data[0].relateddata.files.forEach(function(e){-1!==i.indexOf(e.dataelements.title.split(".").pop().toLowerCase())&&e.dataelements.title.split(".").pop().toUpperCase()===V&&(c.versions=[],c.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach(function(e){c.versions.push(e.id)}),c.fileId=e.relId,O&&O===e.relId&&(n++,a=e.dataelements.title.split(".").pop().toLowerCase(),l=e.dataelements.title,d=c.versions),c.title=e.dataelements.title,c.creationDate=new Date(e.dataelements.originated),c.modifiedDate=new Date(e.dataelements.modified),u.push(c),c={})}),!n&&e.data[0].relateddata.files.length>0)if("X3DPLAW_AP"===L)Y("error",S.documentDeleted);else{R="delete";let e=s._counter;for(let t=0;t<e;t++)s.off();t={title:S.documentPanel.deleteFile,data:u,mode:"delete"},x||(x=new r({immersiveFrame:T.getFrameWindow().getImmersiveFrame()})),x.build(t,o,ee)}else e.data[0].relateddata.files.length?n&&z.includes(a)&&e.data[0].relateddata.files.length>1?(T.displayNotification({msg:`${S.markupDocmultioffice} ${l}`,eventID:"error"}),ee()):(R="normal",o(O,d)):(T.displayNotification({msg:S.documentNofile,eventID:"warning"}),ee())}else if(1===e.data[0].relateddata.files.length)if(-1===i.indexOf(e.data[0].relateddata.files[0].dataelements.title.split(".").pop().toLowerCase())){Y("warning",S.documentTypeNotSupported);let e=u.getCommand("CleanAll",T.getCommandContext());e&&e.begin()}else{let t,n=[];e.data[0].relateddata.files[0].relateddata.versions.length?(t=e.data[0].relateddata.files[0].relId,n.push(e.data[0].relateddata.files[0].id),e.data[0].relateddata.files[0].relateddata.versions.forEach(function(e){n.push(e.id)})):(t=e.data[0].relateddata.files[0].relId,n.push(e.data[0].relateddata.files[0].id)),o(t,n)}else{let n={},a=[],i=0,s=0;e.data[0].relateddata.files.forEach(function(e){-1!==["pdf","dxf","dwg"].indexOf(e.dataelements.title.split(".").pop().toLowerCase())?(i++,n.versions=[],n.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach(function(e){n.versions.push(e.id)}),n.fileId=e.relId,n.title=e.dataelements.title,n.creationDate=new Date(e.dataelements.originated),n.modifiedDate=new Date(e.dataelements.modified),a.push(n),n={}):z.includes(e.dataelements.title.split(".").pop().toLowerCase())&&(s++,i++)}),!i&&e.data[0].relateddata.files.length>0?Y("warning",S.documentTypeNotSupported):e.data[0].relateddata.files.length?s===i?Y("warning",S.documentMultiOfficeNotSupported):(t={title:S.documentPanel.selectFile,data:a,mode:"select"},x||(x=new r({immersiveFrame:T.getFrameWindow().getImmersiveFrame()})),x.build(t,o,ee)):Y("warning",S.documentNofile)}}else Z()},onFailure:Z,securityContext:f.getSetting("pad_security_ctx"),tenantUrl:p.get3DSpaceUrl(),tenant:f.getSetting("x3dPlatformId"),getVersions:!0};a.getDocuments([e.phyID],v)}({phyID:t}):"Requirement"!==i&&"Requirement Specification"!==i||(re({phyID:t}),E=i)}function le(e){let t=T.getRootBagPath().getChildrenPathes();if(1===t.length&&h)h();else{if(_){let e=T.subscribe({event:"onRootRemoved"},()=>{T.unsubscribe(e),function(e){q&&e&&e.id===q.objectId?q=null:h&&h()}()})}t.forEach(function(t){o.getNodeID(t.getLastElement(!0))!==e&&T.removeRoots({pids:[o.getNodeID(t.getLastElement(!0))]})})}}function de(e){let t=e.data.objectType,o=e.data.objectParentType,a=e.data.loadMode,i=e.data.objectId,r=e.data.objectName,l=e.data.serviceId;function c(){T.setAutomaticReframePolicy(!1);let e=f.getSetting("enopad3dviewer_lightNodeModel")?[{rootID:i,validForServerCall:!0,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:i,"ds6w:type":o,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part","ds6w:label":r,boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:i,"ds6w:type":o,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]},refreshDelegationCB:function(){return new Promise(function(e){e()})}}]:[{rootID:i,validForServerCall:!0,structure:{rootId:o,results:[{attributes:[{name:"did",value:i},{name:"physicalid",value:i},{name:"ds6w:type",value:o}]},{path:[i]}]}}];T.loadJSON({data:e})}v.getParentType(t)||v.setParentType(t,o);const u=$?["Document","Requirement","Requirement Specification","Specification Report","DELLmiWorkPlanSystemReference"]:["Document","Requirement","Requirement Specification","Specification Report"];if("PLMPIMMetricReference"===o||"SIMItfSimulation"===o)require([I.isr],function(t){let r=t.getLoaderForMarkup({context:T});function s(){if(T.getApplicativeData().getLoadedItfData&&T.getApplicativeData().getLoadedItfData().data.length){let e=T.getApplicativeData().getLoadedItfData();e.data[0].prd&&le(e.data[0].prd[0])}e.data.cbOK&&e.data.cbOK()}let l=r.subscribe("onDMUCtxtAlreadyLoaded",function(){r.unsubscribe(l),s()}),d=r.subscribe("onDMUCtxtLoadingSuccess",function(){l&&r.unsubscribe(l),r.unsubscribe(d),s(),ne()}),c=n.getReviewContext({context:T});c&&c.getCurrentSessionMarkup()&&"X3DPLAW_AP"!==e.data.appInfo?"SIMItfSimulation"===o?(i===y?E="ITF":q&&q.objectId===i&&(q.type="ITF"),T.getApplicativeData().getLoadedItfData&&T.getApplicativeData().getLoadedItfData().data.length?i===T.getApplicativeData().getLoadedItfData().data[0].isrID?r.load({data:{isrID:[i],loadMode:a}}):(c.getCurrentSessionMarkup().setActiveFlag(!1),r.remove({data:{objectType:"SIMItfSimulation",objectId:T.getApplicativeData().getLoadedItfData().data[0].isrID}}),r.load({data:{isrID:[i],loadMode:a}})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),r.load({data:{isrID:[i],loadMode:a}}))):(i===y?E="ISR":q&&q.objectId===i&&(q.type="ISR"),r.getIsrPointingToMetric([i]).then(function(e){let t=e[i][0];T.getApplicativeData().getLoadedItfData&&T.getApplicativeData().getLoadedItfData().data.length?t===T.getApplicativeData().getLoadedItfData().data[0].isrID?r.load({data:{metricID:[i]},loadMode:a}):(c.getCurrentSessionMarkup().setActiveFlag(!1),r.remove(T.getApplicativeData().getLoadedItfData().data[0].isrID),r.load({data:{metricID:[i]},loadMode:a})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),r.load({data:{metricID:[i],loadMode:a}}))})):"SIMItfSimulation"===o?(i===y?E="ITF":q&&q.objectId===i&&(q.type="ITF"),r.load({data:{isrID:[i],loadMode:a}})):(i===y?E="ISR":q&&q.objectId===i&&(q.type="ISR"),r.load({data:{metricID:[i]},loadMode:a}))});else if("DIFLayout"===o||"DIFSheet"===o)require(["DS/DibUDLWebLoader/CATDibUDLWebLoader"],function(n){if(n){let o=new n,a={data:{physicalid:i,dataType:t},contextViewer:T,serverUrl:p.get3DSpaceUrl(),securityContext:f.getSetting("pad_security_ctx"),onComplete:function(n){k=n;let a=d.getManager({name:"DMU2DSheetManager",context:T.getFrameWindow()});a||(a=new m({ctxViewer:T}),d.addManager({name:"DMU2DSheetManager",context:T.getFrameWindow(),manager:a}));let r=[];for(let e=0;e<n.sheetIDList.length;e++)r.push({modelID:n.sheetIDList[e],sheetID:"Drw."+i+"_"+n.sheetIDList[e],label:o.getSheetName(n.sheetIDList[e])});a.load2DDocument({loadedSheetInformations:n,phyID:i,dataType:t,sheetNodes:r,getSheet3DNode:function(e){let t=o.getSheetBackgroundColor(e.modelID);o.setDisplaySheet({sheetID:e.modelID,onSheetNodeCreated:function(){T.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.modelID)&&e.noUdlWarningMessage(),q&&i===q.objectId||o.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),T.getViewer().render(),q||T.getViewpoint().reframe(),e.end();for(let e=0;e<s._counter;e++)s.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){ne();for(let e=0;e<s._counter;e++)s.off();h&&h(),e.data.cbOK&&e.data.cbOK()},onFailure:function(){T.displayNotification({msg:S.fileWithNoSVG,eventID:"error"}),U.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};o&&o.loadModel(a)}}),E="FLDiagram",q||le(i);else if("DIFAnnotationSet"===o)require([I.difAnnotSet],function(t){new t({context:T}).load({id:i}).then(()=>{e.data.cbOK&&e.data.cbOK()})});else if("DesignSight"===o)require([I.msr],e=>{T.getFrameWindow().options={},T._context="Default",T.getFrameWindow().options.context="Default";let t=e.getLoaderForMarkup({context:T});t&&K&&(E="MSR",i!==J?(t.load({data:{msrID:i},onComplete:()=>{K=!0,J=i,h&&h();let e=T.subscribe({event:"onRootRemoved"},()=>{T.unsubscribe(e),J&&(J=null)})},onFailure:()=>{K=!0}}),K=!1):T.displayNotification({msg:S.msrAlreayLoaded,eventID:"info"}))}),_=!1,le(i);else if(u.includes(o)){let t=D.giveReqCompareController({context:T});if(t&&t.isLoading()||!T.getRootBagPath().getChildrenPathes().length)e.data.subContext&&e.data.subContext.id&&U.setSubContextInformations({mainContextId:e.data.objectId,subContext:e.data.subContext}),c();else{let e=T.subscribe({event:"onEndRootRemoved"},function(t){T.unsubscribe(e),e=-1,t&&t.ids&&t.ids.includes(y)||c()})}_=!1,(!t||t&&!t.isRequirementCompareActive())&&le(i)}else"R2V_FeatureState"===o&&(E="R2V_FeatureState",function(e){return new Promise((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(p.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/v1/modeler/featurestate/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":f.getSetting("lang")},data:JSON.stringify({ids:[e.objectId]}),timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})}(g={serviceId:l,objectId:i}).then(e=>{G.push({id:g.objectId,info:e.result})}));var g;let C=n.giveEventsController({viewer:T.getViewer()});C&&C.fireEvent("onLoadedReviewContext",{rootType:o})}this.getLoadedID=function(){return y},this.setLoadedID=function(e){y=e},this.getIsrContext=function(e){return new Promise(function(t){require([I.isr],function(n){n.getLoaderForMarkup({context:T}).getIsrContext(e).then(t)})})},this.load=function(e){L=e.data.appInfo,y=e.data.objectId instanceof Array?e.data.objectId[0]:e.data.objectId,M=e.data.cbOK,O=e.data.fileId;const t=e.data.serviceId;let n;e.data.documentType&&(V=e.data.documentType),X=e.data.objectType,h=e.data.loadMarkup?e.data.loadMarkup:null,n=e.data&&e.data.subContext?e.data.subContext.label:e.data.displayName,de({data:{appInfo:L,objectId:y,objectType:e.data.objectType,objectParentType:e.data.objectParentType?e.data.objectParentType:e.data.objectType,objectName:n,loadMode:e.data.loadMode,cbOK:M,fileId:O,documentType:V,loadMarkup:h,serviceId:t,subContext:e.data.subContext}})},this.clean=function(e){T&&(w&&(w.close(),w=null),x&&x.destroy(),L=E=x=P=k=F=null,_=!0,e&&(y=null,A.onRootAdded&&T.unsubscribe(A.onRootAdded),A.onRootAdded=null,A.widgetReresh&&T.unsubscribe(A.widgetReresh),A.widgetReresh=null),j={},B={},T.getViewer().render())};this.getLoadMarkupDocumentMode=function(){return R},this.getLoadMarkupCtxType=function(){return E},this.getLoadedSheetInformations=(()=>k),this.getTempObjectInformations=(()=>B),this.getLoadedR2VInformations=(()=>G),this.setLoadedR2VInformations=(e=>{G=e}),this.updateLoadedR2VInformations=((e,t)=>{"remove"===t&&(G=G.filter(t=>t.id!==e))}),this.getSubContextInformations=(e=>H[e]),this.setSubContextInformations=(e=>{e&&e.mainContextId&&(H[e.mainContextId]=e.subContext)}),this.removeSubContextInformations=(e=>{e&&H[e]&&(H[e]=void 0)}),this.getDocumentVersionInfos=function(){return b},this.subscribe=function(e,t){if(e&&t&&N)return N.subscribe({event:e},t)},this.unsubscribe=function(e){N&&e&&N.unsubscribe(e)},this.publish=function(e,t){N&&N.publish({event:e,data:t})},j.on2DDocumentLoadRequired=W.addEvent("on2DDocumentLoadRequired",e=>{e&&de({data:q={objectType:e.documentType,objectId:e.rootID,objectParentType:e.documentType,objectName:e.objectName}})}),A.onRootAdded=T.subscribe({event:"onRootAdded"},function(e){se({path:e.path})}),A.widgetReresh=T.subscribe({event:"widgetReresh"},e=>{"DesignSight"!==e.objectType&&"DIFLayout"!==e.objectType&&"DIFSheet"!==e.objectType||(e.objectParentType=e.objectParentType?e.objectParentType:e.objectType,de({data:e}))}),j.onGetLoadedSheetInformations=W.addEvent("onGetLoadedSheetInformations",e=>{e.cb&&e.cb(k)}),j.onGetLoadedReqSpecInformations=W.addEvent("onGetLoadedReqSpecInformations",e=>{e.cb&&e.cb(F)})}}),C=[];return e.singleton({init:function(){},giveLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<C.length;t++)if(C[t].context===e.context)return C[t].controller},getLoadingContextController:function(e){let t;if(e&&e.context&&!(t=this.giveLoadingContextController(e))){let n=new h({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},getLoadedID:function(){if(n)return n.getLoadedID()},setLoadedID:function(e){if(n)return n.setLoadedID(e)},getDocumentVersionInfos:function(){if(n)return n.getDocumentVersionInfos()},getIsrContext:function(e){if(n)return n.getIsrContext(e)},clean:function(e){if(n)return n.clean(e)},getLoadMarkupDocumentMode:function(){if(n)return n.getLoadMarkupDocumentMode()},getLoadMarkupCtxType:function(){if(n)return n.getLoadMarkupCtxType()},getLoadedSheetInformations:function(){if(n)return n.getLoadedSheetInformations()},getTempObjectInformations:function(){if(n)return n.getTempObjectInformations()},setLoadedR2VInformations:function(e){if(n)return n.setLoadedR2VInformations(e)},getLoadedR2VInformations:function(){if(n)return n.getLoadedR2VInformations()},setSubContextInformations:function(e){if(n)return n.setSubContextInformations(e)},getSubContextInformations:function(e){if(n)return n.getSubContextInformations(e)},removeSubContextInformations:function(e){if(n)return n.removeSubContextInformations(e)},updateLoadedR2VInformations:function(e,t){if(n)return n.updateLoadedR2VInformations(e,t)}}),C.push({context:e.context,controller:t})}return t},unreferenceLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<C.length;t++)C[t].context===e.context&&(C[t].controller.clean(!0),C.splice(t,1))}})}),define("DS/DMUReadPersistence/DMUValidationReadServices",["UWA/Class","DS/DMUBaseExperience/EXPUtils","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/VisuDataAccess/Ox4StreamLoader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADSettingsMgt"],function(e,t,n,o,a,i,r){"use strict";return e.extend({init:function(){this.getProductByValidationId=function(e,t,o){n.sendWebServiceCall({url:"resources/validation/service/getPrdIdByValidationId",config:{verb:"POST",data:{sValidationId:e}},onSuccess:function(e){var n=JSON.parse(e);t(n)},onFailure:function(){o()}})},this.getAllElementsByValidationId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getAll",config:{verb:"POST",data:{sValidationId:e.validationId}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})},this.getMarkupJson=function(e,s,l,d){var c={IRPC:!0,serverUrl:n.get3DSpaceUrl(),physicalid:e.markupId,boType:"VALReview",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(n){window.console.log("getMarkupJson::success:"+n.byteLength),s({jsonObj:JSON.parse(t.cleanJSONString(n)),reviewPid:e.markupId,reviewName:e.markupName,modifiable:!0},d)},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),l(e="NOSTREAM")}};window.console.log("Loading streams");var u=i.getUser().login;a.useUWAProxy({proxymode:"passport",login:u,contextid:r.getSetting("pad_security_ctx")}),o.Load(c)},this.getValidationFromHighlightId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationFromHighlightId",config:{verb:"POST",data:{sHighlightId:e.highlightId}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})},this.getValidationsFromObjectsIds=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationsFromObjectsIds",config:{verb:"POST",data:{listHighlights:e.highlightIds,listChecks:e.checkIds,listValidations:e.validationIds}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})}}})}),define("DS/DMUReadPersistence/DMULoadMarkupServices",["UWA/Class","UWA/Utils","DS/DMUControls/EXPNotify","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUReadPersistence/DMUValidationReadServices","DS/DMUBaseWebValidation/EXPValImporter","DS/DMUBaseUI/DMUToolsUsers","DS/DMUReadPersistence/DMUReadServices","DS/CATWebUXComponents/DMUCommandsManager","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUReadPersistence/DMULoadingContextController","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUReadPersistence/DMUWebServicesUtils","DS/DMUBaseExperience/EXPToolsContext","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,i,r,s,l,d,c,u,p,f,m,g,v,D,S,I,h,C){"use strict";var y=e.extend({init:function(y){var b,x,M,w,R,P,k,F=this,U=!0,T=new u,O=y.ctxViewer,L=[],A=[],j=0,N=new a,E=new i;let V=!1;var _={};function W(){var e=f.getReviewContext({context:O});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().setReadOnly(!0);var t=d.getCommand("DMUMarkupHdr",O.getCommandContext());t&&t.enable();var n=d.getCommand("CleanAll",O.getCommandContext());n&&n.enable()}function q(e,t){T&&T.publish({event:e,data:t,context:F})}function B(e){if(O&&e!==U){U=e;var t=f.getReviewContext({context:O});U?(O&&(L&&(L.forEach(function(e){var t=d.getCommand(e._id,O.getCommandContext());t&&(e._isEnabled?t.enable():t.disable())}),L=[]),A&&(A.forEach(function(e){var t=d.getCommandCheckHeader(e._id,O.getCommandContext());e&&(e._isEnabled?t.enable():t.disable())}),A=[])),t&&t.getNode()&&t.getNode().setPickable(c.PICKABLE)):(!function(){if(O){var e,t,n=d.getCommands(O.getCommandContext());for(e in n)n.hasOwnProperty(e)&&(t=n[e],L.push({_id:t._id,_isEnabled:t._isEnabled}));var o=d.getCommandCheckHeaders(O.getCommandContext());for(e in o)o.hasOwnProperty(e)&&(t=o[e],A.push({_id:t._id,_isEnabled:t._isEnabled}));d.disableAll(O.getCommandContext())}}(),t&&t.getNode()&&t.getNode().setPickable(c.PICKTHROUGH)),O.getViewer().render()}}function J(e,t){b&&(b.destroy(),b=null),b=new n({body:O.getFrameWindow().getUIFrame(),type:e,message:t})}function K(e){O&&(j>0&&(v.off(),j--),B(!0),e&&J("error",e),O.getWidget().dispatchEvent("onDMUMarkupLoadFailed"),q("onDMUMarkupLoadFailed"))}function X(e){if(O){j>0&&(v.off(),j--);var t=f.getReviewContext({context:O});K("Cancel"!==e?"NoMarkup"===e?C.loadNoMarkup:C.loadError:void 0),t&&t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().isReadOnly()&&W()}}async function G(e){B(!0),j>0&&(v.off(),j--),f.removeReviewContext({context:O}),await o.createReviewContext({context:O}),l.importModel({dataJson:e.jsonObj,appType:e.ID,viewer:O.getViewer(),onImportCompleted:function(t){if(!O)return;var n=k?k.getLoadMarkupCtxType():x;let o,a=k?k.getSubContextInformations(e.contextId):void 0;o=a?{title:a.label}:k?k.getTempObjectInformations():void 0;var i=f.getReviewContext({context:O});const r=e.jsonObj&&e.jsonObj.ApplicativeContext?e.jsonObj.ApplicativeContext:null;t[0]&&t[0].setApplicativeContext&&t[0].setApplicativeContext(r);const l=t[0].getMarkupContent?t[0].getMarkupContent():t[0];l&&l.setMaturityState(e.reviewState),i.setCurrentSessionMarkup(l),i.setReviewCtxInformation({contextId:e.contextId,contextType:n,subContextId:e.subContextId,subContext:e.subContext,reviewId:e.reviewPid,reviewName:e.reviewName,reviewDescription:e.reviewDescription,reviewType:e.reviewType,owner:e.owner,modifiable:e.modifiable,tempObjectInfo:o}),"R2V_FeatureState"===n&&O.getSoIUsability()&&O.toggleSOITimelinesUsability(!1),m.setSlidePreferences({context:O.getFrameWindow(),preferences:{panelTitle:e.reviewName}}),f.getContextViewer({viewer:O.getFrameWindow().getViewer()}).getController().getAttributes({ids:[e.reviewPid],attributes:["ds6w:reservedBy"],callbacks:{onComplete:function(t){if(t){const o=s.getUserLogin();var n=t[e.reviewPid]["ds6w:reservedBy"];n&&o?s.getUserName(o,function(e){e!==n&&J("info",C.ReviewReserved+" "+n)}):e.modifiable?J("info",C.loadOK):J("info",C.ReviewNotModifiable)}},onFailure:function(){return null}}}),e.modifiable||W(),q("onDMUMarkupLoadSucceeded",{id:e.reviewPid})},onImportFailed:X})}function H(e,t){I.getParentTypes(e).then(function(n){t([e].concat(n))}).catch(function(){t([e])})}function z(e,t,n){return O?new Promise(function(n){"SIMItfSimulation"===t?(k||(k=g.getLoadingContextController({context:O})),k.getIsrContext(e).then(function(e){n({contextID:e&&e.length?e[0]:null})})):n({contextID:e})}).then(function(e){var t,o,a,i=O.getRootBagPath().getChildrenPathes();if(0===i.length)n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;else for(let r=0;r<i.length;r++){if(a=p.getNodeID(i[r].getLastElement(!0)),O.getController().isFiltered(a).filterId?t=O.getController().isFiltered(a).filterId:o=a,o&&o===e.contextID){n.loadMarkupAllowed=!0;break}if(t&&a===e.contextID){n.removeFilterAllowed=!0,n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;break}}return Promise.resolve({conditions:n,sessionFilterId:t,sessionProductId:o,sessionRootId:a})}):Promise.resolve()}function $(e,t,n,o,a,i,r){var s=e.conditions,l=e.sessionRootId,d=null,c=null,u={};H(a,function(e){if(e&&e.length)if(-1!==e.indexOf("DesignSight")||-1!==e.indexOf("SIMItfSimulation")||-1!==e.indexOf("Document")||-1!==e.indexOf("Requirement Specification")||-1!==e.indexOf("Requirement")||-1!==e.indexOf("Specification Report"))if(s.loadMarkupAllowed||-1!==e.indexOf("SIMItfSimulation")){let o;k||(k=g.getLoadingContextController({context:O})),(o="Markup"===t.objectType?N.getDnDReviewAndJSONFile:N.getMarkupStream)({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner},function(o){if(o&&(o.reviewState=o.reviewState||t.currentState),o.jsonObj.Contexts){let t;-1!==e.indexOf("Document")?t="Document":-1!==e.indexOf("Specification Report")&&(t="Specification Report"),t?(o.jsonObj.Contexts[0].documentVersionInfos&&(M=o.jsonObj.Contexts[0].documentVersionInfos),u.objectId=n,u.objectType=a,u.objectParentType=t,u.displayName=r,u.fileId=M.fileId,u.versionId=M.versions[0],u.versions=M.versions,u.documentType=o.jsonObj.Contexts[0].documentType,i&&i.id&&(u.subContext=i),u.loadMarkup=function(){k.getDocumentVersionInfos().versions[0]!==M.versions[0]&&("normal"===k.getLoadMarkupDocumentMode()?J("info",C.loadMarkupWithNewVersionFile):"delete"===k.getLoadMarkupDocumentMode()&&J("info",C.loadMarkupWithNewFile)),o.contextId=n,i&&i.id&&(o.subContext=i),G(o)},s.loadProductAllowed?k.load({data:u}):s.loadMarkupAllowed&&u.loadMarkup()):-1!==e.indexOf("SIMItfSimulation")&&(d=o.jsonObj.Contexts[0].listData,c=o.jsonObj.Contexts[0].loadingInfos,d&&0!==d.length?(u.objectId=d,u.objectType="PLMPIMMetricReference",u.loadMode=c,u.loadMarkup=function(){o.contextId=n,G(o)},k.load({data:u})):(u.objectId=n,u.objectType=a,u.objectParentType="SIMItfSimulation",u.loadMode=c,u.loadMarkup=function(){o.contextId=n,G(o)},k.load({data:u})))}else-1!==e.indexOf("Requirement")||-1!==e.indexOf("Requirement Specification")?(u.objectId=n,u.objectType=a,u.displayName=r,u.objectParentType=-1!==e.indexOf("Requirement")?"Requirement":"Requirement Specification",u.loadMarkup=function(){o.contextId=n,G(o)},k.load({data:u})):-1!==e.indexOf("DesignSight")?(u.objectId=n,u.objectType=a,u.objectParentType="DesignSight",u.loadMode=c,u.loadMarkup=function(){o.contextId=n,G(o)},s.loadProductAllowed?k.load({data:u}):s.loadMarkupAllowed&&u.loadMarkup()):-1!==e.indexOf("DELLmiWorkPlanSystemReference")&&V&&(u.objectId=n,u.objectType=a,u.objectParentType="DELLmiWorkPlanSystemReference",u.loadMode=c,u.loadMarkup=function(){o.contextId=n,G(o)},s.loadProductAllowed?k.load({data:u}):s.loadMarkupAllowed&&u.loadMarkup())},X)}else K(C.DragAndDropError);else{if((s.removeFilterAllowed||s.removeProductAllowed)&&O.getController().removeRoots({pids:[l]}),s.loadFilterAllowed&&O.addFilter([{objectId:o}]),s.loadProductAllowed){var p=O.getAutomaticReframePolicy();O.setAutomaticReframePolicy(!1),-1!==e.indexOf("DIFLayout")||-1!==e.indexOf("DIFSheet")?(k||(k=g.getLoadingContextController({context:O})),u.objectId=n,u.objectType=a,u.objectParentType=-1!==e.indexOf("DIFLayout")?"DIFLayout":"DIFSheet",k.load({data:u})):-1!==e.indexOf("DELLmiWorkPlanSystemReference")&&V?(k||(k=g.getLoadingContextController({context:O})),u.objectId=n,u.objectType=a,u.objectParentType="DELLmiWorkPlanSystemReference",k.load({data:u})):"R2V_FeatureState"===a?(P=O.subscribe({event:"onR2VLoaded"},function(e){O.getSoIUsability()&&O.toggleSOITimelinesUsability(!1),O.unsubscribe(P),P=null}),O.addR2Vs({objects:[{displayName:"r2vName",objectId:n,objectType:"R2V_FeatureState",path:[{resourceid:n,type:"R2V_FeatureState"}],serviceId:"r2vsurvey"}],reframe:!1,displayNotif:!0,dispatch:!0})):O.addRoots({objects:[{path:[n]}]}),O.setAutomaticReframePolicy(p)}let i=()=>{let e;(e="Markup"===t.objectType?N.getDnDReviewAndJSONFile:N.getMarkupStream)({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner},function(e){e&&(e.reviewState=t.currentState),e.contextId="ENOStrRefinementSpecification"===a?o:n,G(e)},X)};if(s.loadMarkupAllowed)if("Drawing"===a){let e=setInterval(function(){O.getViewer().get2DMode()&&(i(),clearInterval(e),e=null)},100)}else i();else K(C.DragAndDropError)}})}function Q(t){return new e.Promise(function(e){function n(){e({status:"KO",msg:C.loadError})}if(!t||!t.objectId||!t.objectType)return void n();let o;(o="Markup"===t.objectType?N.getProductByMarkerId:N.getMarkupInfos)({physicalid:t.objectId},function(t){if(O){var n,o,a,i,r,s,l,d,c,u={loadProductAllowed:!1,removeProductAllowed:!1,loadFilterAllowed:!1,removeFilterAllowed:!1,loadMarkupAllowed:!1};if(t&&t.MarkupContext&&t.MarkupContext.contexts&&t.MarkupContext.contexts.length){if(1===t.MarkupContext.contexts.length)n=t.MarkupContext.contexts[0].type,x=n;else if(t.MarkupContext.contexts.length>1)for(var f=0;f<t.MarkupContext.contexts.length;f++)"Specification Report"===t.MarkupContext.contexts[f].type?(c=t.MarkupContext.contexts[f].id,n=t.MarkupContext.contexts[f].type,x=n):d={id:t.MarkupContext.contexts[f].id,type:t.MarkupContext.contexts[f].type,label:t.MarkupContext.contexts[f].name}}else"r2vsurvey"===t.MarkupContext.serviceID?n=x="R2V_FeatureState":e({status:"NoContextFound"});if(t&&t.name&&(s=t.name),t&&t.currentState&&(l=t.currentState),n&&"ENOStrRefinementSpecification"===n){var m=[a=t.MarkupContext.contexts[0].id];O.getController().getPrdIdFromFilterId(m).then(function(t){r=function(e,t,n){if(O){var o,a,i,r=O.getRootBagPath().getChildrenPathes();if(0===r.length)n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;else for(let s=0;s<r.length;s++){if(i=p.getNodeID(r[s].getLastElement(!0)),O.getController().isFiltered(i).filterId?o=O.getController().isFiltered(i).filterId:a=i,o&&o===e){n.loadMarkupAllowed=!0;break}if(o&&o!==e&&i===t){n.removeFilterAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}if(a&&t===a){n.removeProductAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}}return{conditions:n,sessionFilterId:o,sessionProductId:a,sessionRootId:i}}}(a,o=t,u),e({status:"OK",mkpMaturityState:l,valMarkup:r,mkpName:s,relatedRootId:o,relatedFilterId:a,relatedObjectType:n})}).catch(function(t){window.console.log(t),e({status:"KO",msg:C.loadError})})}else"R2V_FeatureState"===n?z(o=t.MarkupContext.contextIds&&t.MarkupContext.contextIds.length>0?t.MarkupContext.contextIds[0]:t.MarkupContext.contextId,n,u).then(function(t){e({status:"OK",mkpMaturityState:l,valMarkup:t,mkpName:s,relatedRootId:o,relatedFilterId:a,relatedObjectType:n})}):(o=c||t.MarkupContext.contexts[0].id,i=t.MarkupContext.contexts[0].name,z(o,n,u).then(function(r){e({status:"OK",mkpMaturityState:l,valMarkup:r,mkpName:s,relatedRootId:o,relatedFilterId:a,relatedObjectType:n,relatedSubContext:d,relatedObjectTitle:i,mkpOwner:t.owner})}))}},n)})}function Y(e){E.getMarkupJson({markupId:e.markup.getPlmID(),markupName:e.markup.getName()},e.onLoadingCompleted,e.onLoadingFailed,e.markup)}function Z(e){l.importModel({dataJson:e.asset.jsonObj,appType:e.asset.ID,mkpRepRef:e.asset.markupCtx,viewer:O.getViewer(),onImportFailed:e.onImportFailed,onImportCompleted:e.onImportCompleted})}""!==window.location.search&&(UWA.extend(_,t.parseQuery(window.location.search)),_.widgetDomain&&UWA.extend(_,t.parseQuery(_.widgetDomain))),"testMbom"in _&&(V=!0),this.subscribe=function(e,t){if(T&&e&&t)return T.subscribe({event:e},t)},this.unsubscribe=function(e){T&&e&&T.unsubscribe(e)},this.load=function(e){e.objectId&&O&&(v.on(C.LoadingPanel,null),j++,Q(e).then(function(t){"KO"===t.status?K(C.loadError):"NoContextFound"===t.status?K(C.loadMarkupNoContext):(e.displayName=t.mkpName,e.owner=t.mkpOwner,e.currentState=t.mkpMaturityState,$(t.valMarkup,e,t.relatedRootId,t.relatedFilterId,t.relatedObjectType,t.relatedSubContext,t.relatedObjectTitle))}))},this.loadIfContextLoaded=function(e){if(O)return new Promise(function(t){Q(e).then(function(n){if(O){var o=n.valMarkup.conditions;"OK"!==n.status||o.removeFilterAllowed||o.removeProductAllowed||o.loadFilterAllowed||o.loadProductAllowed||!o.loadMarkupAllowed?t(!1):(e.currentState=n.mkpMaturityState,$(n.valMarkup,e,n.relatedRootId,n.relatedFilterId,n.relatedObjectType,n.relatedObjectTitle),t(!0))}})})},this.getMarkupContextType=function(){return x},this.getDocumentVersionInfos=function(){return M},this.loadValidation=function(e){let t,n,a,i,s,l,d=0,c=["Requirement Specification","Requirement","DIFLayout","DIFSheet","Document","Specification Report","SIMItfSimulation","PLMPIMMetricReference","DesignSight"];if(k||(k=g.getLoadingContextController({context:O})),O){var u,v=f.getReviewContext({context:O});if(v&&(u=v.getValidation()),e.reviewId){var I=f.giveEventsController({viewer:O.getViewer()}),y=null,b=function(e){return new Promise(function(o){if(e){var r=e.getRepRef();r?I.fireEvent("onGetMarkupJsonEvt",{markup:r,onLoadingCompleted:function(e,r){let s=()=>{e.markupCtx=r,I.fireEvent("onImportModelEvt",{asset:e,onImportCompleted:function(e){if(e&&e[0]){var t=e[0].getMarkupContent?e[0].getMarkupContent():e[0];t&&(r.getMarkupContent()||r.setMarkupContent(t),t.getMarkupOwner()||t.setMarkupOwner(r),y&&t.setReadOnly(y.isReadOnly()||r.isReadOnly()))}o("OK")}})},u=i||n;if(-1!==c.indexOf(u))if(0!==d||O.getRoots().length)O.getRoots().length&&I.fireEvent("onLoadedReviewContext",{rootType:u}),s();else{let o=O.subscribe({event:"onRootAdded"},function(){O.unsubscribe(o),s()});d++;let i={};if(e.jsonObj.Contexts){if("Document"===u||"Specification Report"===u){if(e.jsonObj.Contexts[0].documentVersionInfos&&(M=e.jsonObj.Contexts[0].documentVersionInfos),i.objectId=t,i.objectType=n,i.objectParentType=u,i.fileId=M.fileId,i.versionId=M.versions[0],i.versions=M.versions,i.documentType=e.jsonObj.Contexts[0].documentType,i.displayName=a,l&&(i.subContext=l),k.load({data:i}),I)var p=I.addEvent("onGetDocumentsCompleted",function(){I.removeEvent(p);let e=f.getReviewContext({context:O});if(e){let t,n=e.getReviewCtxInformation();t=l?{title:l.label}:k?k.getTempObjectInformations():void 0,n.tempObjectInfo=t,e.setReviewCtxInformation(n)}})}else if("SIMItfSimulation"===u){let o=e.jsonObj.Contexts[0].listData,a=e.jsonObj.Contexts[0].loadingInfos;o&&0!==o.length?(i.objectId=o,i.objectType="PLMPIMMetricReference",i.loadMode=a,k.load({data:i})):(i.objectId=t,i.objectType=n,i.objectParentType="SIMItfSimulation",i.loadMode=a,k.load({data:i}))}}else i.objectId=t,i.objectType=n,i.objectParentType=u,l&&l.id&&(i.subContext=l),k.load({data:i})}else s()},onLoadingFailed:function(){o("KO")}}):o("KO")}else o("KO")})},x=function(d){var v,x,M,P;new Promise(e=>{if(d&&d.children){k||(k=g.getLoadingContextController({context:O}));let t=0;d.children.forEach(n=>{if(n&&"DMUValidationContext"===n.type)if("r2vsurvey"===n.serviceID)(function(e){return new Promise((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(D.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/v1/modeler/featurestate/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":S.getSetting("lang")},data:JSON.stringify({ids:[e.objectId]}),timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})})({serviceId:n.serviceID,objectId:n.contextIds[0]}).then(t=>{P=t.result[0]["ds6w:label"],n.contexts=[{id:n.contextIds[0],name:t.result[0]["ds6w:label"],type:t.result[0].type,loadedR2VInfo:[{id:n.contextIds[0],info:t.result}]}],v=n.contexts,M=n.serviceID,d.children.forEach(e=>{e&&"DMUValidationValidated"===e.type&&(sessionStorage.getItem(e.id)||sessionStorage.setItem(e.id,"true"),"true"===sessionStorage.getItem(e.id)&&(e.validatedObjects=[{PathElements:[n.contextIds[0]],referenceName:P,instanceName:P}]))}),e()});else{if(v=n.contexts,n.contexts&&2===n.contexts.length){let e=n.contexts.findIndex(e=>!("Specification Report"===e.type));n.contexts[e].subContext=!0}e()}else++t===d.children.length&&e()})}}).then(async()=>{let g,D;if(O.getApplicativeData().getLoadedItfData&&O.getApplicativeData().getLoadedItfData().data.length?g=O.getApplicativeData().getLoadedItfData().data[0].isrID:O.getRootBagPath().getChildrenPathes().length>0&&(g=p.getNodeID(O.getRootBagPath().getChildrenPathes()[0].getLastElement(!0))),v)if(1===v.length)t=v[0].id,n=v[0].type,a=v[0].name;else if(2===v.length){let e=v.find(e=>"Specification Report"===e.type);e?(t=e.id,n=e.type,a=e.name):s=!0}if(O.getController().isFiltered(g).filterId&&(D=O.getController().isFiltered(g).filterId),g&&g!==t&&D!==t)J("error",C.valDragAndDropError),e.cbFailed();else{g&&u&&(f.removeReviewContext({context:O}),I&&I.fireEvent("onDMURemoveSessionReview")),(y=await o.createReviewContext({context:O,typeObject:"Review"})).setReadOnly(e.readOnly);var S=new r({viewer:O,DMUExperience:y}),F=null;w||R||(w=I.addEvent("onGetMarkupJsonEvt",Y),R=I.addEvent("onImportModelEvt",Z));var U=async function(){var r=(F=S.importValidationFromJSON(d,e.editionMode)).getContext()&&F.getContext().getMainContextID()?F.getContext().getMainContextID():void 0;F.getContext()&&F.getContext().getSubContextID()&&(l={id:F.getContext().getSubContextID(),label:F.getContext().getSubContextName(),type:F.getContext().getSubContextType()}),(await o.createReviewContext({context:O})).setReviewCtxInformation({reviewId:F.getPlmID(),highlightId:e.type&&"DMUValidationExposedPresentation"===e.type?e.reviewId:void 0,reviewName:e.displayName?e.displayName:F.getName(),reviewType:e.type?e.type:F.getType(),contextId:r,modifiable:!(e.readOnly?e.readOnly:F.isReadOnly()),owner:F.getOwner()}),m.setSlidePreferences({context:O.getFrameWindow(),preferences:{panelTitle:d.name}});var s=null;if(s=O.subscribe({event:"onRootAdded"},function(){e.cbRootAdded(),O.unsubscribe(s)}),t&&g!==t&&"refreshMode"!==e.loadMode){var u=F.getContext().getJsonContextIDs();if(-1===c.indexOf(i))if("R2V_FeatureState"===i){var D=O.subscribe({event:"onR2VLoaded"},function(e){O.getSoIUsability()&&O.toggleSOITimelinesUsability(!1),O.unsubscribe(D),D=null});O.addR2Vs({objects:[{displayName:P,objectId:r,objectType:"R2V_FeatureState",path:[{resourceid:r,type:"R2V_FeatureState"}],serviceId:M}],reframe:!1,displayNotif:!0,dispatch:!0})}else O.addRoots({objects:[{path:u}]})}var h=[],y=[],x=function(e,t){e.getReplies().forEach(function(e){t.push(e),x(e,t)})};F.getMarkups().forEach(function(e){x(e,y),e.hasStream()&&h.push(b(e))}),y.forEach(function(e){e.hasStream()&&h.push(b(e))});var w=function(t){var n=F.getLoadedRepRefs();if(n.length>0){if(F.setCurrentMarkup(n[0]),F.refreshNode(),O.getViewer().render(),t?J("warning",C.loadValSomeMkup):J("success",C.loadValSuccess),!v){let e=f.getReviewContext({context:O}).getValidation().getMarkups();I.fireEvent("reviewNoContextModeOn",{markups:e});let t=O.subscribe({event:"onRootAdded"},function(e){let n=p.getNodeType(e.path.getLastElement(!0));I.fireEvent("reviewNoContextModeOff",{rootType:n}),O.unsubscribe(t)})}I.fireEvent("OnReviewMarkupLoaded",{commentId:e.commentId?e.commentId:null}),e.cbOK()}else e.cbFailed()};if(h.length>0)Promise.all(h).then(function(){w()},function(){w(!0)});else{if(!v){let e=f.getReviewContext({context:O}).getValidation().getMarkups();I.fireEvent("reviewNoContextModeOn",{markups:e});let t=O.subscribe({event:"onRootAdded"},function(e){let n=p.getNodeType(e.path.getLastElement(!0));I.fireEvent("reviewNoContextModeOff",{rootType:n}),O.unsubscribe(t)})}let e={};e.objectId=t,e.objectType=n,e.displayName=a,e.objectParentType=i||n,k.load({data:e}),J("warning",C.loadValNoMarkup)}};n&&t&&!s?H(n,function(t){const o=["VPMReference","Document","Requirement","Requirement Specification","Drawing","SIMItfSimulation","Specification Report","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_FeatureState"];let a=!1;if(t)for(x=0;x<t.length;x++){if(o.includes(t[x])&&(a=!0,i=t[x],h.setParentType(n,i)),"PPRContext"===t[x]){a=!1;break}if("Requirement"===t[x]||"Drawing"===t[x]||"DIFSheet"===t[x]||"DIFLayout"===t[x]){if(a=!0,d.children)for(let e=0;e<d.children.length;e++)if("Markup"===d.children[e].type&&d.children[e].children){for(let t=0;t<d.children[e].children.length;t++)if("false"===d.children[e].children[t].webMarkup){a=!1;break}if(!1===a)break}if(!1===a)break}}if(a)U();else if(t&&-1!==t.indexOf("ENOStrRefinementSpecification")){if(d&&d.children)for(x=0;x<d.children.length;x++)if(d.children[x]&&"DMUValidationContext"===d.children[x].type){v=d.children[x].contexts;break}O.getController().getPrdIdFromFilterId([v[0].id]).then(function(){"refreshMode"!==e.loadMode&&O.addFilter([{objectId:v[0].id}]),function(e){var t=e.valImporter.importValidationFromJSON(e.jsonNode,e.editionMode);m.setSlidePreferences({context:O.getFrameWindow(),preferences:{panelTitle:e.jsonNode.name}});var n=[],o=[],a=function(e,t){e.getReplies().forEach(function(e){t.push(e),a(e,t)})};t.getMarkups().forEach(function(t){a(t,o),n.push(e.loadMarkup(t))}),o.forEach(function(t){n.push(e.loadMarkup(t))});var i=function(n){var o=t.getLoadedRepRefs();o.length>0?(t.setCurrentMarkup(o[0]),t.refreshNode(),O.getViewer().render(),n?J("warning",C.loadValSomeMkup):J("success",C.loadValSuccess),e.cbOK(),f.giveEventsController({viewer:O.getViewer()}).fireEvent("OnReviewMarkupLoaded")):e.cbFailed()};n.length>0?Promise.all(n).then(function(){i()},function(){i(!0)}):J("warning",C.loadValNoMarkup)}({jsonNode:d,editionMode:e.editionMode,valImporter:S,loadMarkup:b,cbOK:e.cbOK})})}else e.cbFailed(),J("error",C.loadValContextError)}):g||v?(J("error",C.valMultiContextDragAndDropError),e.cbFailed()):U()}})},P=function(){J("error",C.loadValError),e.cbFailed()};"DMUValidationValidation"===e.type&&E.getAllElementsByValidationId({validationId:e.reviewId,onSuccess:x,onFailure:P}),"DMUValidationExposedPresentation"===e.type&&E.getValidationFromHighlightId({highlightId:e.reviewId,onSuccess:function(t){t&&u&&u.getPlmID()===t.id?e.cbOK({sameReview:!0}):x(t)},onFailure:P})}else J("error",C.valDragAndDropError)}},this.clearController=function(){if(b&&b.destroy(),w&&R){var e=f.giveEventsController({viewer:O.getViewer()});e.removeEvent(w),e.removeEvent(R),w=R=null}O=b=T=N=x=null}}}),b=[];return e.singleton({init:function(){},giveLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<b.length;t++)if(b[t].context===e.context)return b[t].controller},getLoadMarkupServices:function(e){var t;if(e&&e.context&&!(t=this.giveLoadMarkupServices(e))){var n=new y({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},loadValidation:function(e,t,o){if(n)return n.loadValidation(e,t,o)},loadIfContextLoaded:function(e){if(n)return n.loadIfContextLoaded(e)},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},getMarkupContextType:function(){if(n)return n.getMarkupContextType()},clearController:function(){n&&(n.clearController(),n=null)},getDocumentVersionInfos:function(){if(n)return n.getMarkupContextType()}}),b.push({context:e.context,controller:t})}return t},unreferenceLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<b.length;t++)if(b[t].context===e.context){b[t].controller.clearController(),b.splice(t,1);break}}})});