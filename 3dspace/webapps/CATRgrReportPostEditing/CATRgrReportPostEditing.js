define("DS/CATRgrReportPostEditing/ScrollHighlight",["require","exports","UWA/Core"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.install=void 0,t.install=function(e){!function(e){const t=e.postEditingView,o=e.minHighlightHeight?e.minHighlightHeight:5,n=t.querySelector(e.mainSelector),s=t.querySelector(e.radarSelector),r=e=>{const t=e.target.dataset.scrollTop;if(!t)throw console.log("scrollTop undefined",e),new Error("scrollTop undefined");n.scrollTop=parseInt(t)},l=n.querySelectorAll(e.highlightSelector);let a={mainW:-1,mainH:-1,radarH:-1};const d=()=>{s.innerHTML="",a={mainW:n.offsetWidth,mainH:n.offsetHeight,radarH:s.offsetHeight};const e=n.scrollHeight,t=l.length;for(let a=0;a<t;a++){const t=l[a],d=i.createElement("div",{class:"scroll-highlight"});let c=0;for(let e=t;null!==e&&e!==n;e=e.offsetParent)c+=e.offsetTop;let g=Math.max(t.offsetHeight*s.offsetHeight/e,o),u=c*s.offsetHeight/e;u=u+g<s.offsetHeight?u:s.offsetHeight-g,d.dataset.scrollTop=String(c),d.onclick=r,d.style.position="absolute",d.style.top=u+"px",d.style.height=g+"px",d.style.left="0px",d.style.width="100%",d.inject(s)}};window.setInterval(()=>{n.offsetWidth===a.mainW&&n.offsetHeight===a.mainH&&s.offsetHeight===a.radarH||d()},500);for(let e=0;e<l.length;e++)l[e].addEventListener("input",d)}(e)}}),define("DS/CATRgrReportPostEditing/PostEditing",["require","exports","UWA/Element","DS/Controls/Button","DS/Windows/ImmersiveFrame","DS/Windows/Dialog","DS/CATRgrReportPostEditing/ScrollHighlight","DS/CATRgnWidgetCommons/restClient/ReportServices","DS/CATRgnWidgetCommons/restClient/PostEditionServices","DS/CATRgnWidgetCommons/restClient/PeopleServices","DS/CATRgnWidgetCommons/restClient/CommonServices","DS/CATRgnWidgetCommons/restClient/DocumentServices","DS/RGNServices/WAFDataUtil","DS/RGNServices/Alert","DS/CATRgnWidgetCommons/utils/RGNConstants","DS/CATRgnWidgetCommons/utils/RGNConstants","i18n!DS/CATRgrReportPostEditing/assets/nls/CATRgrReportPostEditing"],function(e,t,i,o,n,s,r,l,a,d,c,g,u,p,v,m,f){"use strict";async function C(e,t){var i,o;try{const n=(new c.HeadersBuilder).addSecurityContext(e.securityContext).add3DSpaceCsrfToken(await c.getCSRFToken(e.service.url)).addLanguage().build(),s=await l.generationStatus(e.service,n,[e.id]),r=v.getReportStatus(null===(o=null===(i=s.reports[0])||void 0===i?void 0:i.generation)||void 0===o?void 0:o.status)===m.ReportStatus.NeedPostEditionAndWithChanges;await l.generateReports(e.service,n,r,!1,[e.id]),t&&t({id:e.id,uptodate:!0})}catch(e){p.error(e),console.log(e)}}async function h(e,t,i,o){const n={};for(const e of t){const t=e.id,i=e.innerText||e.textContent;n[t]=i}await a.save(e.service,e.id,n,i),o&&await g.unreserveDocument(e.service,o,i)}Object.defineProperty(t,"__esModule",{value:!0}),t.produceFinalReport=t.openPostEditingView=void 0,t.openPostEditingView=async function(e,t,v){return new Promise(async(m,S)=>{var w,y,b,R,D,T,A,E,H;const x=(new c.HeadersBuilder).addSecurityContext(t.securityContext).add3DSpaceCsrfToken(await c.getCSRFToken(t.service.url)).build(),k=await l.generationStatus(t.service,x,[t.id]),P=null===(y=null===(w=k.reports[0])||void 0===w?void 0:w.targetDocument)||void 0===y?void 0:y.id;if(P)try{const l=await d.getCurrentUser(t.service,x),c=null===(R=null===(b=(await g.getDocument(t.service,P,x)).data)||void 0===b?void 0:b[0])||void 0===R?void 0:R.dataelements.reservedby;if(c&&c!==l.name)throw new Error(f.get("message_ReportDocumentReservedBy").replace("{0}",c));{const l=await g.getDocumentFilesInfo(t.service,P,x);let d=null===(D=k.reports[0])||void 0===D?void 0:D.title.replace(/[\s/\\"#$@%*,?<>[\]|:'&;()=+^`{~}!\u00B0\u00A4\u00B5\u00A7]/g,"_");d+=".post";const c=l.data.findIndex(e=>e.dataelements.title===d),p=await g.getDocumentTicket(t.service,P,null!==(E=null===(A=null===(T=l.data)||void 0===T?void 0:T[c])||void 0===A?void 0:A.id)&&void 0!==E?E:"",x);if(null===(H=p.data[0])||void 0===H||!H.dataelements)throw new Error("no data elements");{const l=await u.authenticatedRequest("GET",p.data[0].dataelements.ticketURL,"text",{}),d=await a.postEditing(t.service,t.id,x),c=i.create("div",{id:"postEditingContainer",html:l});Object.keys(d.editableTexts).forEach(e=>{const t=c.querySelector("#"+CSS.escape(e));t&&(t.innerText=d.editableTexts[e])});const w=new n({}),y=e=>{w.destroy(),m(e)},b=new s({identifier:"postEditingDialog",immersiveFrame:w,closeButtonFlag:!1,title:f.get("title_PostEditing"),content:c,buttons:{Apply:new o({label:f.get("button_SavePostEditing"),onClick:async e=>{const i=e.dsModel.dialog;i.buttons.Ok.disabled=!0,i.buttons.Apply.disabled=!0,i.buttons.Close.disabled=!0;try{await h(t,c.querySelectorAll("span[contenteditable=true]"),x,P),y({action:"save"})}catch(e){console.log(e),S(e)}}}),Ok:new o({label:f.get("button_ProduceFinalReport"),onClick:async e=>{const i=e.dsModel.dialog;i.buttons.Ok.disabled=!0,i.buttons.Apply.disabled=!0,i.buttons.Close.disabled=!0;try{await h(t,c.querySelectorAll("span[contenteditable=true]"),x,P),await C(t,v),y({action:"produceReport"})}catch(e){console.log(e),S(e)}}}),Close:new o({onClick:e=>{const i=e.dsModel.dialog;i.buttons.Ok.disabled=!0,i.buttons.Apply.disabled=!0;const n=new s({identifier:"postEditingCloseConfirmDialog",immersiveFrame:w,title:f.get("title_ReallyQuit"),content:f.get("message_ReallyQuit"),closeButtonFlag:!1,modalFlag:!0,buttons:{Yes:new o({onClick:async()=>{try{await g.unreserveDocument(t.service,P,x),y({action:"close"})}catch(e){console.log(e),S(e)}}}),No:new o({onClick:()=>{i.buttons.Ok.disabled=!1,i.buttons.Apply.disabled=!1,n.close()}})}})}})}});r.install({postEditingView:c,mainSelector:"div.postedition-preview",radarSelector:"div.postedition-radar",highlightSelector:'span[contenteditable="true"]'}),w.inject(e),e.style.zIndex="10000",b.maximizedFlag=!0}}}catch(e){try{await g.unreserveDocument(t.service,P,x),console.log(e)}catch(e){console.log(e)}}else p.error(f.targetDocumentError)})},t.produceFinalReport=function(e){return C(e,()=>{})}});